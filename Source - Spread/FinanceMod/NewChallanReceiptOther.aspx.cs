using System;
using System.Collections;
using System.Collections.Generic;
using System.Data;
using System.Drawing;
using System.IO;
using System.Text;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using Gios.Pdf;
using System.Net;
using System.Text.RegularExpressions;
using System.Web.Services;
using System.Data.SqlClient;

//Last Modified by Idhris 09-01-2017 Class file separated for Receipt Format 2,11,12,13
//Last Modified by Idhris 07-01-2017 Class file separated for Challans and Receipt
//Last modified by Idhris 06-01-2017 loading image
public partial class NewChallanReceiptOther : System.Web.UI.Page
{

    string usercode = string.Empty;
    string collegecode1 = string.Empty;
    string collegecode = string.Empty;
    string singleuser = string.Empty;
    string group_user = string.Empty;
    string linkvalue = string.Empty;
    static string collegecodestat = string.Empty;
    static string usercodestat = string.Empty;

    string userCollegeCode = string.Empty;
    string selectQuery = "";
    string accidRecpt = string.Empty;
    string lastRecptNo = string.Empty;
    static ArrayList ItemList = new ArrayList();
    static ArrayList Itemindex = new ArrayList();
    static int chosedmode = 0;
    static int personmode = 0;
    static byte BalanceType = 0;
    static int ledgerorheader = 0;
    static int grpHdrLdr = 0;
    static string vencontcode = "-1";
    static int isHeaderwise = 0;
    // static string smartCno = string.Empty;
    DAccess2 d2 = new DAccess2();
    static DAccess2 d22 = new DAccess2();
    ReuasableMethods reUse = new ReuasableMethods();
    DataSet ds = new DataSet();
    DataSet ds1 = new DataSet();
    DateTime dt;
    int row = 0;
    int i = 0;

    double excessAmt = 0;
    bool excessOk = false;
    bool checkFromPopper = false;
    bool fromScript = true;
    string linkName = string.Empty;
    string schemeadmission = string.Empty;
    //**********************************************//
    //   Code Started by Idhris from 12/10/2015     //
    //**********************************************//


    protected void Page_Load(object sender, EventArgs e)
    {
        try
        {

            usercode = Session["usercode"].ToString();
            collegecode1 = Session["collegecode"].ToString();
            singleuser = Session["single_user"].ToString();
            group_user = Session["group_code"].ToString();

            if (!IsPostBack)
            {
                string StreamShift = string.Empty;
                try
                {
                    StreamShift = Convert.ToString(Session["streamcode"]);
                    if (StreamShift.Trim() == "")
                    {
                        StreamShift = "Stream";
                    }
                }
                catch { StreamShift = "Stream"; }
                lbl_stream.Text = StreamShift;

                personmode = 0;
                chosedmode = 0;
                LoadFromSettings();

                loadScholarship("-1");

                txt_date.Text = DateTime.Now.ToString("dd/MM/yyyy");
                txt_date1.Text = DateTime.Now.ToString("dd/MM/yyyy");
                txt_date.Attributes.Add("readonly", "readonly");
                txt_date1.Attributes.Add("readonly", "readonly");
                txt_totamt.Attributes.Add("readonly", "readonly");
                txt_paidamt.Attributes.Add("readonly", "readonly");
                txt_balamt.Attributes.Add("readonly", "readonly");
                txt_return.Attributes.Add("readonly", "readonly");
                txt_totnoofstudents.Attributes.Add("readonly", "readonly");
                txt_tostudentsrcpt.Attributes.Add("readonly", "readonly");
                txtMultTotal.Attributes.Add("readonly", "readonly");
                txt_datemd.Text = DateTime.Now.ToString("dd/MM/yyyy");
                txt_datemd.Attributes.Add("readonly", "readonly");
                // imgAlert.Attributes.Add("Style", " display:none;");
                bindclg();

                bindType();
                collegebank();
                bank();
                cardType();
                loadGridStudent();
                cb_selectHeadAll.Visible = false;
                // txt_rcptno.Text = generateReceiptNo();
                img_stud.ImageUrl = "";
                img_stud.Visible = false;
                studentSelect.Visible = true;
                rbl_rollno.SelectedIndex = 0;
                //txt_rollno.TextMode = TextBoxMode.SingleLine;

                btn_print.Visible = false;
                btn_save.Visible = true;
                checCashDD.Visible = true;
                cb_selcthd.Checked = true;
                cb_selcthd_CheckedChanged(sender, e);

                try
                {
                    string HeaderwiseQ = "select LinkValue from New_InsSettings where LinkName='HeaderWiseChallanorReceipt' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "' ";
                    isHeaderwise = Convert.ToInt32(d2.GetFunction(HeaderwiseQ).Trim());
                }
                catch { isHeaderwise = 0; }

                if (isHeaderwise > 0)
                {
                    try
                    {
                        string finYearid = d2.getCurrentFinanceYear(usercode, collegecode1);
                        DataSet dsHdrsChk = new DataSet();

                        dsHdrsChk = d2.select_method_wo_parameter("select HeaderFk from FM_HeaderFinCodeSettingsDet hs,FM_HeaderFinCodeSettings s where s.HeaderSettingPK=hs.HeaderSettingFK and CollegeCode=" + collegecode1 + " and FinyearFK=" + finYearid + "  select Headerpk from FM_HeaderMaster H,FS_HeaderPrivilage P  where H.HeaderPK = P.HeaderFK AND P.CollegeCode = H.CollegeCode AND P. UserCode = " + usercode + " and h.CollegeCode=" + collegecode1 + "", "");

                        if (dsHdrsChk.Tables.Count > 1)
                        {
                            string uHdr = string.Empty;

                            for (int uhdr = 0; uhdr < dsHdrsChk.Tables[1].Rows.Count; uhdr++)
                            {
                                if (uHdr == string.Empty)
                                {
                                    uHdr = Convert.ToString(dsHdrsChk.Tables[1].Rows[uhdr][0]);
                                }
                                else
                                {
                                    uHdr += "," + Convert.ToString(dsHdrsChk.Tables[1].Rows[uhdr][0]);
                                }
                            }
                            dsHdrsChk.Tables[0].DefaultView.RowFilter = " headerfk in (" + uHdr + ")";
                            DataView dv = dsHdrsChk.Tables[0].DefaultView;
                            if (dv.Count != dsHdrsChk.Tables[1].Rows.Count)
                            {
                                lbl_alert.Text = "Receipt No Not Set For All Headers";
                                imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                                //btn_alertclose_Click(sender, e);

                            }
                        }
                        else
                        {
                            lbl_alert.Text = "Receipt No Not Set For All Headers";
                            imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                            // btn_alertclose_Click(sender, e);
                        }
                    }
                    catch (Exception ex) { }
                }
                imgAlert.Attributes.Add("Style", "display:none;");
                createLogo(collegecode1);
                string featdegCode = string.Empty;
                //  LoadYearSemester(featdegCode);
                headerbind();
                ledgerbind();
                setLabelText();
                bindcollegeScheme();
                if (ddlcollegeScheme.Items.Count > 0)
                {
                    collegecode1Scheme = Convert.ToString(ddlcollegeScheme.SelectedItem.Value);
                    clgcodeScheme = Convert.ToString(ddlcollegeScheme.SelectedItem.Value);
                }
                radApplNo.Checked = true;
                radAdmNo.Checked = false;
                lblappnoScheme.Text = "Application No";
                tdsemadd.Visible = true;
                txt_schmdate.Attributes.Add("readonly", "readonly");
                txt_schmdate.Text = DateTime.Now.ToString("dd/MM/yyyy");
                getCollectionamount();
                if (rdo_receipt.Checked)
                    getEditableReceipt();
                loadfinanceyear();
            }
            collegecode1 = Convert.ToString(ddl_college.SelectedValue);
            txt_rcptno.Text = generateReceiptNo();

            //collegecode1 = Convert.ToString(ddl_college.SelectedValue);
            collegecodestat = Convert.ToString(ddl_college.SelectedValue);
            usercodestat = usercode;
            if (ddl_ledgeSearch.SelectedIndex == 0)
            {
                ledgerorheader = 0;
            }
            else
            {
                ledgerorheader = 1;
            }
            if (rdo_receipt.Checked)
            {
                UPpanel_sem.Visible = true;
                ddl_sem.Visible = false;
            }
            fromScript = true;
            if (rbl_rollnoNew.SelectedIndex == 0)
            {
                //this.Form.DefaultButton = "btnSearch";
            }
            else if (rbl_rollnoNew.SelectedIndex == 1)
            {
                //this.Form.DefaultButton = "btnGO_staff";
            }
            else if (rbl_rollnoNew.SelectedIndex == 3)
            {
                //this.Form.DefaultButton = "btnGO_other";
            }
            else if (rbl_rollnoNew.SelectedIndex == 2 && txtroll_vendor.Text.Trim() != "")
            {
                //this.Form.DefaultButton = "btnGO_vendor";
                try
                {
                    vencontcode = txtroll_vendor.Text.Trim().Split('-')[2];
                }
                catch { vencontcode = "-1"; }
            }
            else
            {
                vencontcode = "-1";
            }
            lbl_CurPay.Text = "";
            //string pwd = txt_Smartno.Text;
            //txt_Smartno.Attributes.Add("value", pwd);
            if (ddl_bkname.Items.Count > 0 && ddl_bkname.SelectedItem.Text.ToUpper().Trim() == "OTHERS")
            {
                txt_other.Style.Add("display", "block");
            }
            else
            {
                txt_other.Style.Add("display", "none");
            }
            //if (hideGridTotAmt())
            //{
            //    txt_totamt.Visible = true;
            //    lbl_totamt.Visible = true;
            //    //txt_totamt.Style.Add("display", "block");
            //    //lbl_totamt.Style.Add("display", "block");
            //}
            //else
            //{
            //    //txt_totamt.Style.Add("display", "none");
            //    //lbl_totamt.Style.Add("display", "none");
            //    txt_totamt.Visible = false;
            //    lbl_totamt.Visible = false;
            //}
            //if (hideGridPaidAmt())
            //{
            //    txt_paidamt.Visible = true;
            //    lbl_paidamt.Visible = true;
            //}
            //else
            //{
            //    txt_paidamt.Visible = false;
            //    lbl_paidamt.Visible = false;
            //}

            //Scheme Settings Show or hide
            showSchemeSettings(collegecode1, usercode);
            if (ddlcollegeScheme.Items.Count > 0)
            {
                collegecode1Scheme = Convert.ToString(ddlcollegeScheme.SelectedItem.Value);
                clgcodeScheme = Convert.ToString(ddlcollegeScheme.SelectedItem.Value);
            }
            maintainPaymedeState();
            divSchemeSettings.Attributes.Add("Style", "display:none;");
            divRecptRpt.Attributes.Add("Style", "display:none;");
        }
        catch { }
    }
    protected void ddl_college_OnSelectedIndexchange(object sender, EventArgs e)
    {
        try
        {
            LoadFromSettings();

            //int val = Convert.ToInt32(d2.GetFunction("select LinkValue from New_InsSettings where LinkName='ChallanReceiptDefaultPriority' and user_code ='" + usercode + "' and college_code ='" + ddl_college.SelectedItem.Value + "'"));
            //if (val == 1)
            //{
            //    rdo_receipt.Checked = false;
            //    rdo_challan.Checked = true;
            //    rdo_challan_CheckedChanged(sender, e);
            //    btn_save.Visible = false;
            //}
        }
        catch (Exception ex) { }
        bindType();
        collegebank();
        bank();
        cardType();
        headerSlecetionChanged();
        createLogo(ddl_college.SelectedValue);
        string featdegCode = string.Empty;
        LoadYearSemester(featdegCode);
    }
    public void LoadFromSettings()
    {
        try
        {
            string useCOdeSet = "select LinkValue from New_InsSettings where LinkName='MultipleCollegeUserRights' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "' ";
            string colleges = Convert.ToString(d2.GetFunction(useCOdeSet)).Trim();
            if (colleges == "" || colleges == "0")
            {
                colleges = collegecode1;
            }


            int smartDisp = Convert.ToInt32(d2.GetFunction("select LinkValue from New_InsSettings where LinkName='DisplayNumberForSmartCd' and user_code ='" + usercode + "' --and college_code in (" + collegecode1 + ")").Trim());

            ListItem lst1 = new ListItem("Roll No", "0");
            ListItem lst2 = new ListItem("Reg No", "1");
            ListItem lst3 = new ListItem("Admission No", "2");
            ListItem lst4 = new ListItem("App No", "3");
            ListItem lst5 = new ListItem("Smartcard No", "4");

            //Roll Number or Reg Number or Admission No or Application Number
            rbl_rollno.Items.Clear();
            string insqry1 = "select LinkValue from New_InsSettings where LinkName='ChallanReceiptRollNo' and user_code ='" + usercode + "' --and college_code in(" + collegecode1 + ")";

            int save1 = Convert.ToInt32(d2.GetFunction(insqry1));

            if (save1 == 1)
            {
                //Roll No
                rbl_rollno.Items.Add(lst1);
            }


            insqry1 = "select LinkValue from New_InsSettings where LinkName='ChallanReceiptRegNo' and user_code ='" + usercode + "' --and college_code in(" + collegecode1 + ")";
            save1 = Convert.ToInt32(d2.GetFunction(insqry1));
            if (save1 == 1)
            {
                //RegNo
                rbl_rollno.Items.Add(lst2);
            }

            insqry1 = "select LinkValue from New_InsSettings where LinkName='ChallanReceiptRollAdmit' and user_code ='" + usercode + "' --and college_code in(" + collegecode1 + ")";
            save1 = Convert.ToInt32(d2.GetFunction(insqry1));
            if (save1 == 1)
            {
                //Admission No - Roll Admit
                rbl_rollno.Items.Add(lst3);
            }

            insqry1 = "select LinkValue from New_InsSettings where LinkName='ChallanReceiptAppFormNo' and user_code ='" + usercode + "' --and college_code in(" + collegecode1 + ") ";
            save1 = Convert.ToInt32(d2.GetFunction(insqry1));

            if (save1 == 1)
            {
                //App Form Number - Application Number
                rbl_rollno.Items.Add(lst4);

            }

            insqry1 = "select LinkValue from New_InsSettings where LinkName='ChallanReceiptSmartNo' and user_code ='" + usercode + "' --and college_code in(" + collegecode1 + ") ";
            save1 = Convert.ToInt32(d2.GetFunction(insqry1));

            if (save1 == 1)
            {
                //Smartcard No - smart_serial_no
                rbl_rollno.Items.Add(lst5);
            }

            if (rbl_rollno.Items.Count == 0)
            {
                rbl_rollno.Items.Add(lst1);
            }
            switch (Convert.ToUInt32(rbl_rollno.SelectedItem.Value))
            {
                case 0:
                case1:
                    txt_rollno.Attributes.Add("placeholder", "Roll No");
                    lbl_rollno3.Text = "Roll No";
                    chosedmode = 0;
                    break;
                case 1:
                case2:
                    txt_rollno.Attributes.Add("placeholder", "Reg No");
                    lbl_rollno3.Text = "Reg No";
                    chosedmode = 1;
                    break;
                case 2:
                case3:
                    txt_rollno.Attributes.Add("placeholder", "Admin No");
                    lbl_rollno3.Text = "Admin No";
                    chosedmode = 2;
                    break;
                case 3:
                case4:
                    txt_rollno.Attributes.Add("placeholder", "App No");
                    lbl_rollno3.Text = "App No";
                    chosedmode = 3;
                    break;
                case 4:
                    txt_rollno.Attributes.Add("placeholder", "Smartcard No");
                    lbl_rollno3.Text = "SmartCard No";
                    chosedmode = 4;
                    switch (smartDisp)
                    {
                        case 0:
                            goto case1;
                        case 1:
                            goto case2;
                        case 2:
                            goto case3;
                        case 3:
                            goto case4;
                    }
                    break;
            }

            insqry1 = "select LinkValue from New_InsSettings where LinkName='ShowBalanceType' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "' ";
            save1 = Convert.ToInt32(d2.GetFunction(insqry1));

            if (save1 == 1)
            {
                BalanceType = 1;

            }
            else
            {
                BalanceType = 0;
            }

            //Receipt or Challan or Both
            save1 = 0;
            insqry1 = "select LinkValue from New_InsSettings where LinkName='ChallanOrReceiptOrBoth' and user_code ='" + usercode + "' and college_code in(" + collegecode1 + ") ";
            save1 = Convert.ToInt32(d2.GetFunction(insqry1));
            rdo_receipt.Enabled = false;
            //rdo_challan.Enabled = false;
            if (save1 == 1)
            {
                //Receipt
                rdo_receipt.Enabled = true;
            }
            if (save1 == 2)
            {
                //Challan
                //  rdo_challan.Enabled = true;

            }
            if (save1 == 3)
            {
                //Receipt and Challan
                rdo_receipt.Enabled = true;
                // rdo_challan.Enabled = true;
            }

            //Headerwise or Group Header wise or Ledger wise
            save1 = 0;
            insqry1 = "select LinkValue from New_InsSettings where LinkName='GroupHeaderOrHeaderOrLedger' and user_code ='" + usercode + "' and college_code in(" + collegecode1 + ")";
            save1 = Convert.ToInt32(d2.GetFunction(insqry1));

            rbl_headerselect.Items[0].Enabled = false;
            rbl_headerselect.Items[1].Enabled = false;
            rbl_headerselect.Items[2].Enabled = false;
            if (save1 == 1)
            {
                //Group Header
                rbl_headerselect.Items[0].Enabled = true;
            }
            if (save1 == 2)
            {
                //Header
                rbl_headerselect.Items[1].Enabled = true;
            }
            if (save1 == 3)
            {
                //Ledger
                rbl_headerselect.Items[2].Enabled = true;

            }
            if (save1 == 4)
            {
                //All

                rbl_headerselect.Items[0].Enabled = true;
                rbl_headerselect.Items[1].Enabled = true;
                rbl_headerselect.Items[2].Enabled = true;
            }
            if (save1 == 5)
            {
                //GH and Ledger
                rbl_headerselect.Items[0].Enabled = true;
                rbl_headerselect.Items[2].Enabled = true;
            }
            if (save1 == 6)
            {
                //Ledger and Header                        
                rbl_headerselect.Items[1].Enabled = true;
                rbl_headerselect.Items[2].Enabled = true;
            }
            if (save1 == 7)
            {
                //GHeader and Ledger
                rbl_headerselect.Items[0].Enabled = true;
                rbl_headerselect.Items[2].Enabled = true;
            }
            cb_selcthd.Enabled = false;
            rbl_headerselect.SelectedIndex = -1;
            if (save1 == 5 || save1 == 1 || save1 == 7 || save1 == 4)
            {
                rbl_headerselect.SelectedIndex = 0;
                cb_selcthd.Enabled = true;
            }
            else if (save1 == 2 || save1 == 6)
            {
                rbl_headerselect.SelectedIndex = 1;
            }
            else if (save1 == 3)
            {
                rbl_headerselect.SelectedIndex = 2;
            }

            //Headerwise or Group Header wise or Ledger wise
            save1 = 0;
            insqry1 = "select LinkValue from New_InsSettings where LinkName='Edit Receipt Date' and user_code ='" + usercode + "' --and college_code in(" + collegecode1 + ")";
            save1 = Convert.ToInt32(d2.GetFunction(insqry1));
            if (save1 == 1)
            {
                txt_date.Enabled = true;
            }
            else
            {
                txt_date.Enabled = false;
                txt_date.Text = DateTime.Now.ToString("dd/MM/yyyy");
            }

            //Is Challan or Receipt Header wise ?

            //string insqry1 = "select LinkValue from New_InsSettings where LinkName='HeaderWiseChallanorReceipt' and user_code ='" + usercode + "' and college_code in(" + colleges + ") ";
            //int save1 = Convert.ToInt32(d2.GetFunction(insqry1));
        }
        catch (Exception ex) { }
    }
    private bool hideGridFeeAmt()
    {
        bool hide = true;
        string insqry1 = "select LinkValue from New_InsSettings where LinkName='HideGridFeeAmount' and user_code ='" + usercode + "' -- and college_code ='" + collegecode1 + "'";
        int save1 = Convert.ToInt32(d2.GetFunction(insqry1));
        if (save1 == 1)
        {
            hide = false;
        }
        return hide;
    }
    private bool hideGridTotAmt()
    {
        bool hide = true;
        string insqry1 = "select LinkValue from New_InsSettings where LinkName='HideGridTotAmount' and user_code ='" + usercode + "' -- and college_code ='" + collegecode1 + "'";
        int save1 = Convert.ToInt32(d2.GetFunction(insqry1));
        if (save1 == 1)
        {
            hide = false;
        }
        return hide;
    }
    private bool hideGridPaidAmt()
    {
        bool hide = true;
        string insqry1 = "select LinkValue from New_InsSettings where LinkName='HideGridPaidAmount' and user_code ='" + usercode + "' -- and college_code ='" + collegecode1 + "'";
        int save1 = Convert.ToInt32(d2.GetFunction(insqry1));
        if (save1 == 1)
        {
            hide = false;
        }
        return hide;
    }
    private bool hideGridDedAmt()
    {
        bool hide = true;
        string insqry1 = "select LinkValue from New_InsSettings where LinkName='HideGridDedAmount' and user_code ='" + usercode + "' -- and college_code ='" + collegecode1 + "'";
        int save1 = Convert.ToInt32(d2.GetFunction(insqry1));
        if (save1 == 1)
        {
            hide = false;
        }
        return hide;
    }
    private bool ShowBalOnly()
    {
        bool hide = false;
        string insqry1 = "select LinkValue from New_InsSettings where LinkName='ShowBalanceOnlyGrid' and user_code ='" + usercode + "' -- and college_code ='" + collegecode1 + "'";
        int save1 = Convert.ToInt32(d2.GetFunction(insqry1));
        if (save1 == 1)
        {
            hide = true;
        }
        return hide;
    }
    protected void lb2_Click(object sender, EventArgs e)
    {
        try
        {
            Session.Abandon();
            Session.Clear();
            Session.RemoveAll();
            System.Web.Security.FormsAuthentication.SignOut();
            Response.Redirect("default.aspx", false);
        }
        catch (Exception ex) { }
    }
    protected void imagebtnpopclose_Click(object sender, EventArgs e)
    {
        popwindow.Visible = false;
        rdo_receipt.Checked = true;
    }
    protected void btn_select_Click(object sender, EventArgs e)
    {
        popwindow.Visible = true;
    }
    [System.Web.Services.WebMethod]
    [System.Web.Script.Services.ScriptMethod()]
    public static List<string> Getrno(string prefixText)
    {
        List<string> name = new List<string>();
        try
        {
            string query = "";
            WebService ws = new WebService();
            if (personmode == 0)
            {
                //student query
                if (chosedmode == 0)
                {
                    query = "select top 100 Roll_No from Registration where CC=0 and DelFlag =0 and Exam_Flag <>'DEBAR' and Roll_No like '" + prefixText + "%' and college_code=" + collegecodestat + " order by Roll_No asc";
                }
                else if (chosedmode == 1)
                {
                    query = "select  top 100 Reg_No from Registration where CC=0 and DelFlag =0 and Exam_Flag <>'DEBAR' and Reg_No like '" + prefixText + "%' and college_code=" + collegecodestat + "  order by Reg_No asc";
                }
                else if (chosedmode == 2)
                {
                    query = "select  top 100 Roll_admit from Registration where CC=0 and DelFlag =0 and Exam_Flag <>'DEBAR' and Roll_admit like '" + prefixText + "%' and college_code=" + collegecodestat + "  order by Roll_admit asc";
                }
                else if (chosedmode == 4)
                {
                    query = "select  top 100 smart_serial_no from Registration where CC=0 and DelFlag =0 and Exam_Flag <>'DEBAR' and smart_serial_no like '" + prefixText + "%' and college_code=" + collegecodestat + "  order by smart_serial_no asc";
                }
                else
                {
                    byte studAppSHrtAdm = statStudentAppliedShorlistAdmit();
                    string admStudFilter = "";
                    switch (studAppSHrtAdm)
                    {
                        case 0:
                            admStudFilter = " and isconfirm=1 ";
                            break;
                        case 1:
                            admStudFilter = " and isconfirm=1 and selection_status=1 ";
                            break;
                        case 2:
                            admStudFilter = " and isconfirm=1 and selection_status=1 and admission_status=1 ";
                            break;
                    }
                    query = "  select  top 100 app_formno from applyn where  app_formno like '" + prefixText + "%' and college_code=" + collegecodestat + " " + admStudFilter + "  order by app_formno asc";
                }
            }
            else if (personmode == 1)
            {
                //staff query
            }
            else if (personmode == 2)
            {
                //Vendor query
            }
            else
            {
                //Others query
            }

            name = ws.Getname(query);
            return name;
        }
        catch { return name; }
    }
    [System.Web.Services.WebMethod]
    [System.Web.Script.Services.ScriptMethod()]
    public static List<string> GetName(string prefixText)
    {
        WebService ws = new WebService();
        List<string> name = new List<string>();

        string query = "select  top 100 a.stud_name+'-'+ISNULL(  a.parent_name,'')+'-'+c.Course_Name+'-'+dt.Dept_Name+'-'+r.roll_admit,r.roll_admit from applyn a,Registration r ,Degree d,course c,Department dt  where a.app_no=r.app_no and r.degree_code=d.Degree_Code and d.Course_Id=c.Course_Id and d.Dept_Code=dt.Dept_Code  and r.CC=0 and r.DelFlag =0 and r.Exam_Flag <>'DEBAR' and a.stud_name like '" + prefixText + "%' and r.college_code=" + collegecodestat + " order by r.roll_admit";

        Hashtable studhash = ws.Getnamevalue(query);
        if (studhash.Count > 0)
        {
            foreach (DictionaryEntry p in studhash)
            {
                string studname = Convert.ToString(p.Key);
                name.Add(studname);
            }
        }
        return name;
    }

    [System.Web.Services.WebMethod]
    [System.Web.Script.Services.ScriptMethod()]
    public static List<string> GetMblno(string prefixText)
    {
        WebService ws = new WebService();
        List<string> name = new List<string>();

        string query = "select (parentF_Mobile+'-'+r.roll_admit) as mblno from applyn a,registration r where r.app_no=a.app_no and r.college_code=" + collegecodestat + " order by r.roll_admit";
        name = ws.Getname(query);
        return name;
    }

    //select (parentF_Mobile+'-'+r.roll_admit) as mblno from applyn a,registration r where r.app_no=a.app_no and r.college_code='25'
    protected void getCurrentSemester(string appNo, string collegecode, string curSem)
    {
        try
        {
            cbl_sem.Items.Clear();
            DataSet dsset = new DataSet();
            string SelectQ = string.Empty;
            string CurSem = d2.GetFunction(" select current_semester from registration where app_no='" + appNo + "' and college_code='" + collegecode1 + "'");
            if (CurSem != "0")
            {
                string linkValue = d2.GetFunction("select LinkValue from New_InsSettings where linkname = 'SemesterandYear' and user_code ='" + usercode + "' and college_code ='" + collegecode + "'");
                if (!string.IsNullOrEmpty(linkValue) && linkValue != "0")
                {
                    SelectQ = "select textval,textcode from textvaltable where TextCriteria = 'FEECA'and (textval like '%" + curSem + " Semester' or textval like '%" + curSem + " Year') and textval not like '-1%' and college_code ='" + collegecode + "' order by len(textval),textval asc";
                    dsset.Clear();
                    dsset = d2.select_method_wo_parameter(SelectQ, "Text");
                    if (dsset.Tables.Count > 0 && dsset.Tables[0].Rows.Count > 0)
                    {
                        cbl_sem.DataSource = dsset;
                        cbl_sem.DataTextField = "textval";
                        cbl_sem.DataValueField = "textcode";
                        cbl_sem.DataBind();
                    }
                }
                else
                {
                    linkValue = d2.GetFunction("select LinkValue from New_InsSettings where linkname = 'Fee Yearwise' and user_code ='" + usercode + "' and college_code ='" + collegecode + "'");
                    if (!string.IsNullOrEmpty(linkValue) && linkValue == "0")
                    {
                        SelectQ = "select * from textvaltable where TextCriteria = 'FEECA'and textval like '%" + curSem + " Semester' and textval not like '-1%' and college_code ='" + collegecode + "' order by len(textval),textval asc";
                        dsset.Clear();
                        dsset = d2.select_method_wo_parameter(SelectQ, "Text");
                        if (dsset.Tables.Count > 0 && dsset.Tables[0].Rows.Count > 0)
                        {
                            cbl_sem.DataSource = dsset;
                            cbl_sem.DataTextField = "textval";
                            cbl_sem.DataValueField = "textcode";
                            cbl_sem.DataBind();
                        }
                    }
                    else if (!string.IsNullOrEmpty(linkValue) && linkValue == "1")
                    {
                        switch (curSem)
                        {
                            case "1":
                            case "2":
                                curSem = "1";
                                break;
                            case "3":
                            case "4":
                                curSem = "2";
                                break;
                            case "5":
                            case "6":
                                curSem = "3";
                                break;
                            case "7":
                            case "8":
                                curSem = "4";
                                break;
                            case "9":
                            case "10":
                                curSem = "5";
                                break;
                            default:
                                curSem = "1";
                                break;
                        }
                        SelectQ = "select * from textvaltable where TextCriteria = 'FEECA'and textval like '%" + curSem + " Year' and textval not like '-1%' and college_code ='" + collegecode + "' order by len(textval),textval asc";
                        dsset.Clear();
                        dsset = d2.select_method_wo_parameter(SelectQ, "Text");
                        if (dsset.Tables.Count > 0 && dsset.Tables[0].Rows.Count > 0)
                        {
                            cbl_sem.DataSource = dsset;
                            cbl_sem.DataTextField = "textval";
                            cbl_sem.DataValueField = "textcode";
                            cbl_sem.DataBind();
                        }
                    }
                    else if (!string.IsNullOrEmpty(linkValue) && linkValue == "2")
                    {
                        SelectQ = "select distinct textval,TextCode,len(textval) from textvaltable t,Fee_degree_match f where t.textcode=f.feecategory and t.college_code=f.college_code and  TextCriteria = 'FEECA' and textval like '%Term%' and textval not like '-1%' and t.college_code ='" + collegecode + "' ";
                        dsset.Clear();
                        dsset = d2.select_method_wo_parameter(SelectQ, "Text");
                        if (dsset.Tables.Count > 0 && dsset.Tables[0].Rows.Count > 0)
                        {
                            cbl_sem.DataSource = dsset;
                            cbl_sem.DataTextField = "textval";
                            cbl_sem.DataValueField = "textcode";
                            cbl_sem.DataBind();
                        }
                    }
                }
                if (cbl_sem.Items.Count > 0)
                {
                    for (int sem = 0; sem < cbl_sem.Items.Count; sem++)
                    {
                        cbl_sem.Items[sem].Selected = true;
                    }
                }
            }
        }
        catch { }
    }

    protected void getmicelTerm(string appNo, string collegecode1)
    {
        cbl_sem.Items.Clear();
        string selQ = "  select distinct r.college_code,textcode,textval,r.degree_code,isnull(monthcode,'0')as monthcode ,MonthYear from Fee_degree_match fd,registration r,textvaltable t  where fd.college_code=r.college_code  and r.degree_code=fd.degree_code and t.textcriteria='FEECA' and t.college_code=r.college_code  and fd.feecategory=t.textcode  and r.college_code='" + collegecode1 + "' and r.App_No ='" + appNo + "' and( t.textval like 'Term 1%' or t.textval like 'Term 2%' or t.textval like 'Term 3%' or t.textval like 'Term 4%')";
        //and isnull(monthyear,'0')<>'0'
        // string selQ = "   select distinct r.college_code,f.feecategory,textval,r.degree_code,isnull(monthcode,'0')as monthcode ,MonthYear from Fee_degree_match fd,registration r,ft_feeallot f,textvaltable t  where fd.college_code=r.college_code and f.app_no=r.app_no and f.feecategory=fd.feecategory and r.degree_code=fd.degree_code and t.textcriteria='FEECA' and t.college_code=r.college_code and t.textcode=f.feecategory and fd.feecategory=t.textcode and r.college_code='" + collegecode1 + "' and r.App_No ='" + appNo + "'";
        DataSet dsval = d2.select_method_wo_parameter(selQ, "Text");
        if (dsval.Tables.Count > 0 && dsval.Tables[0].Rows.Count > 0)
        {
            int curMonth = 0;
            int curYear = 0;
            int.TryParse(Convert.ToString(DateTime.Now.Month), out curMonth);
            int.TryParse(Convert.ToString(DateTime.Now.Year), out curYear);

            string degree_code = Convert.ToString(dsval.Tables[0].Rows[0]["degree_code"]);
            string type = d2.GetFunction(" select distinct type from degree d,course c,department dt where d.course_id=c.course_id and d.dept_code=dt.dept_code and d.college_code='" + collegecode1 + "' and degree_code='" + degree_code + "'");
            string monthcode = Convert.ToString(getTermMonthCode(curMonth, type));
            dsval.Tables[0].DefaultView.RowFilter = "monthcode='" + monthcode + "'";
            DataView dvpaid = dsval.Tables[0].DefaultView;
            for (int row = 0; row < dvpaid.Count; row++)
            {
                int month = 0;
                int year = 0;
                int.TryParse(Convert.ToString(dvpaid[row]["monthcode"]), out month);
                int.TryParse(Convert.ToString(dvpaid[row]["MonthYear"]), out year);
                cbl_sem.Items.Add(new ListItem(Convert.ToString(dvpaid[row]["textval"]), Convert.ToString(dvpaid[row]["textcode"])));

                //if (curMonth >= month)
                //{
                //    cbl_sem.Items.Add(new ListItem(Convert.ToString(dsval.Tables[0].Rows[row]["textval"]), Convert.ToString(dsval.Tables[0].Rows[row]["feecategory"])));
                //}
            }
            if (cbl_sem.Items.Count > 0)
            {
                for (int i = 0; i < cbl_sem.Items.Count; i++)
                {
                    cbl_sem.Items[i].Selected = true;
                }
            }
        }

    }
    protected int getTermMonthCode(int curMonth, string type)
    {
        int MonthCode = 0;
        if (type.Trim().ToLower() == "matric" || type.Trim().ToUpper() == "MATRIC")
        {
            switch (curMonth)
            {
                case 6:
                case 7:
                case 8:
                case 9:
                    MonthCode = 6;
                    break;
                case 10:
                case 11:
                case 12:
                case 1:
                    MonthCode = 10;
                    break;
                case 2:
                case 3:
                case 4:
                case 5:
                    MonthCode = 2;
                    break;
                default:
                    MonthCode = 6;
                    break;
                //case 6:
                //case 7:
                //case 8:
                //    MonthCode = 6;
                //    break;
                //case 9:
                //case 10:
                //case 11:
                //    MonthCode = 9;
                //    break;
                //case 12:
                //case 1:
                //case 2:
                //    MonthCode = 12;
                //    break;
                //case 3:
                //case 4:
                //case 5:
                //    MonthCode = 3;
                //    break;
                ////default:
                ////    MonthCode = 6;
                ////    break;
            }
        }
        else
        {
            switch (curMonth)
            {
                case 4:
                case 5:
                case 6:
                    MonthCode = 4;
                    break;
                case 7:
                case 8:
                case 9:
                    MonthCode = 7;
                    break;
                case 10:
                case 11:
                case 12:
                    MonthCode = 10;
                    break;
                case 1:
                case 2:
                case 3:
                    MonthCode = 1;
                    break;
                default:
                    MonthCode = 4;
                    break;
                //case 6:
                //case 7:
                //case 8:
                //case 9:
                //    MonthCode = 6;
                //    break;
                //case 10:
                //case 11:
                //case 12:
                //case 1:
                //    MonthCode = 10;
                //    break;
                //case 2:
                //case 3:
                //case 4:
                //case 5:
                //    MonthCode = 2;
                //    break;
                //default:
                //    MonthCode = 6;
                //    break;
            }
        }
        return MonthCode;
    }

    protected void rbl_rollnoNew_OnSelectedIndexChanged(object sender, EventArgs e)
    {
        try
        {
            studentSelect.Visible = false;
            txt_rollno.Text = "";
            txt_rollno_Changed(sender, e);
            txtroll_staff.Text = "";
            txtroll_vendor_Changed(sender, e);
            txtroll_vendor.Text = "";
            txtname_vendor.Text = "";
            txtroll_vendor_Changed(sender, e);
            txtroll_other.Text = "";
            txtname_other.Text = "";
            txtAdd1_Other.Text = "";
            txtAdd2_Other.Text = "";
            txt_otherMobile.Text = "";
            txtroll_other_Changed(sender, e);
            txt_sem.Enabled = false;
            imgAlert.Attributes.Add("Style", "display:none;");

            rcptsngle.Visible = false;
            rcptSngleStaff.Visible = false;
            rcptSngleVendor.Visible = false;
            rcptSngleOthers.Visible = false;
            getCollectionamount();
            //financial year filter
            lblfyear.Visible = false;
            tdfyear.Visible = false;
            divgrid.Visible = false;
            if (rbl_rollnoNew.SelectedIndex == 0)
            {
                txt_rollno.Attributes.Add("placeholder", "Roll No");
                txt_sem.Enabled = true;
                studentSelect.Visible = true;
                personmode = 0;
                rcptsngle.Visible = true;
                tdsemadd.Visible = true;
                btnSearch.Visible = true;
                lnkOpenSchemeSettings.Visible = false;
                tdstudsem.Visible = true;
                //  divgrid.Visible = true;
                //financial year filter
                lblfyear.Visible = false;
                tdfyear.Visible = false;
            }
            else if (rbl_rollnoNew.SelectedIndex == 1)
            {
                txt_rollno.Attributes.Add("placeholder", "Staff ID");
                personmode = 1;
                rcptSngleStaff.Visible = true;
                tdsemadd.Visible = false;
                btnSearch.Visible = false;
                lnkOpenSchemeSettings.Visible = false;
                tdstudsem.Visible = false;
                //  divgrid.Visible = false;
                txtroll_staff.Text = string.Empty;
                txtname_staff.Text = string.Empty;
                txtDept_staff.Text = string.Empty;
            }
            else if (rbl_rollnoNew.SelectedIndex == 2)
            {
                txt_rollno.Attributes.Add("placeholder", "Vendor ID");
                personmode = 2;
                rcptSngleVendor.Visible = true;
                tdsemadd.Visible = false;
                btnSearch.Visible = false;
                lnkOpenSchemeSettings.Visible = false;
                tdstudsem.Visible = false;
                // divgrid.Visible = false;
            }
            else
            {
                txt_rollno.Attributes.Add("placeholder", "Others");
                personmode = 3;
                rcptSngleOthers.Visible = true;
                tdsemadd.Visible = false;
                btnSearch.Visible = false;
                lnkOpenSchemeSettings.Visible = false;
                tdstudsem.Visible = false;
                // divgrid.Visible = false;
            }

        }
        catch (Exception ex) { }
    }
    protected void rbl_rollno_OnSelectedIndexChanged(object sender, EventArgs e)
    {
        txt_Smartno.Visible = false;
        txt_rollno.Visible = true;
        lblstaticrollno.Text = "";
        txt_rollno.Text = "";
        txt_Smartno.Text = "";
        Txt_amt.Text = "";
        txt_dept.Text = "";
        txtsec.Text = "";
        txt_SeatType.Text = "";
        txt_FatherName.Text = "";
        txt_name.Text = "";
        txt_sem.Text = "";
        bank();
        cardType();
        accidRecpt = string.Empty;
        lastRecptNo = string.Empty;
        txt_rcptno.Text = generateReceiptNo();
        loadGridStudent();
        //grid_Details.Visible = false;
        txt_return.Text = "";
        imgAlert.Attributes.Add("Style", "display:none;");
        img_stud.ImageUrl = "";
        img_stud.Visible = false;
        //txt_rollno.TextMode = TextBoxMode.SingleLine;
        string useCOdeSet = "select LinkValue from New_InsSettings where LinkName='MultipleCollegeUserRights' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "' ";
        string colleges = Convert.ToString(d2.GetFunction(useCOdeSet)).Trim();
        if (colleges == "" || colleges == "0")
        {
            colleges = collegecode1;
        }
        int smartDisp = Convert.ToInt32(d2.GetFunction("select LinkValue from New_InsSettings where LinkName='DisplayNumberForSmartCd' and user_code ='" + usercode + "' and college_code in(" + collegecode1 + ")").Trim());

        switch (Convert.ToUInt32(rbl_rollno.SelectedItem.Value))
        {
            case 0:
            case1:
                txt_rollno.Attributes.Add("placeholder", "Roll No");
                lbl_rollno3.Text = "Roll No";
                chosedmode = 0;
                break;
            case 1:
            case2:
                txt_rollno.Attributes.Add("placeholder", "Reg No");
                lbl_rollno3.Text = "Reg No";
                chosedmode = 1;
                break;
            case 2:
            case3:
                txt_rollno.Attributes.Add("placeholder", "Admin No");
                lbl_rollno3.Text = "Admin No";
                chosedmode = 2;
                break;
            case 3:
            case4:
                txt_rollno.Attributes.Add("placeholder", "App No");
                lbl_rollno3.Text = "App No";
                chosedmode = 3;
                break;
            case 4:
                txt_rollno.Attributes.Add("placeholder", "Smartcard No");
                lbl_rollno3.Text = "SmartCard No";
                chosedmode = 4;
                //txt_rollno.TextMode = TextBoxMode.Password;
                txt_Smartno.Visible = true;
                //txt_rollno.Visible = false;
                switch (smartDisp)
                {
                    case 0:
                        goto case1;
                    case 1:
                        goto case2;
                    case 2:
                        goto case3;
                    case 3:
                        goto case4;
                }
                break;
        }
    }
    protected void txt_rollno_Changed(object sender, EventArgs e)
    {
        textRoll();
    }
    private void textRoll()
    {
        string appNo = "-1";
        try
        {
            div_HeaderLed.Attributes.Add("Style", "display:none;");
            divRecptRpt.Attributes.Add("Style", " display:none;");
            divSchemeSettings.Attributes.Add("Style", "display:none;");
            string name = "";
            string degree = "";
            string stType = "";
            string fname = "";
            lbltype.Text = "";

            string query = "";
            string degree_code = string.Empty;
            btn_print.Visible = false;
            string roll_no = Convert.ToString(txt_rollno.Text.Trim());
            img_stud.ImageUrl = "";
            img_stud.Visible = false;
            string cursemvalue = "1";
            string fMblno = string.Empty;
            string sections = string.Empty;
            chkGridSelectAll.Checked = false;
            if (roll_no != "")
            {
                //smartCno = txt_rollno.Text.Trim();
                if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) != 3)
                {
                    query = "select r.Roll_No,r.Roll_Admit,r.app_no,Stud_Name,isnull(IsSchemeAdmission,'0') as IsSchemeAdmission,d.Degree_Code ,c.Course_Name +'-'+dt.Dept_Name as Degree,(select TextVal from TextValTable where TextCode=(select seattype from Applyn where app_no=r.app_no) and TextCriteria='seat' ) as StType,(select parent_name from applyn where app_no=r.app_no) as fname, ISNULL( type,'') as type,R.Current_Semester,isnull(r.sections,'') as sections  from Registration r,Degree d,Department dt,Course c where r.degree_code =d.Degree_Code and d.Dept_Code =dt.Dept_Code and d.Course_Id =c.Course_Id  and r.college_code='" + collegecode1 + "'  ";
                    if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 0)
                        query += " and r.Roll_No like '" + roll_no + "'";
                    else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 1)
                        query += " and r.Reg_No like '" + roll_no + "'";
                    else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 2)
                        query += " and r.Roll_Admit like '" + roll_no + "'";
                    else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 4)
                        query += " and r.smart_serial_no like '" + txt_Smartno.Text.Trim() + "'";
                }
                else
                {
                    byte studAppSHrtAdm = StudentAppliedShorlistAdmit();
                    string admStudFilter = "";
                    switch (studAppSHrtAdm)
                    {
                        case 0:
                            admStudFilter = " and a.isconfirm=1 ";
                            break;
                        case 1:
                            admStudFilter = " and a.isconfirm=1 and a.selection_status=1 ";
                            break;
                        case 2:
                            admStudFilter = " and a.isconfirm=1 and a.selection_status=1 and a.admission_status=1 ";
                            break;
                    }
                    query = "select a.degree_code,stud_name,''IsSchemeAdmission,c.Course_Name+' - '+ dt.Dept_Name as degree,(select TextVal from TextValTable where TextCode=seattype and TextCriteria='seat' ) as StType,parent_name as fname ,ISNULL( type,'') as type,a.app_no,''sections  from applyn a,Degree d,Department dt,Course c where a.degree_code =d.Degree_Code and dt.Dept_Code=d.Dept_Code and c.Course_Id =d.Course_Id and a.college_code='" + collegecode1 + "'  and app_formno = '" + roll_no + "' " + admStudFilter;
                }
                ds.Clear();
                ds = d2.select_method_wo_parameter(query, "Text");
                if (ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
                {
                    for (int i = 0; i < ds.Tables[0].Rows.Count; i++)
                    {
                        name = Convert.ToString(ds.Tables[0].Rows[i]["Stud_Name"]);
                        degree = Convert.ToString(ds.Tables[0].Rows[i]["Degree"]);
                        degree_code = Convert.ToString(ds.Tables[0].Rows[i]["Degree_code"]);
                        stType = Convert.ToString(ds.Tables[0].Rows[i]["stType"]);
                        fname = Convert.ToString(ds.Tables[0].Rows[i]["fname"]);
                        lbltype.Text = Convert.ToString(ds.Tables[0].Rows[i]["type"]);
                        appNo = Convert.ToString(ds.Tables[0].Rows[i]["app_no"]);
                        if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) != 3)
                            cursemvalue = Convert.ToString(ds.Tables[0].Rows[i]["Current_Semester"]);
                        schemeadmission = Convert.ToString(ds.Tables[0].Rows[i]["IsSchemeAdmission"]);
                        sections = Convert.ToString(ds.Tables[0].Rows[i]["sections"]);
                    }
                    fMblno = getFatherMblNo(appNo, collegecode1);
                    //if (checkSchoolSetting() == 0)
                    //    getmicelTerm(appNo, collegecode1);
                    //else
                    getCurrentSemester(appNo, collegecode1, cursemvalue);
                }
                lblstaticrollno.Text = "";
                txt_name.Text = name;
                txt_dept.Text = degree;
                txtsec.Text = sections;
                txt_SeatType.Text = stType;
                txt_FatherName.Text = fname;
                txt_mblno.Text = fMblno;
                img_stud.ImageUrl = "~/Handler/Handler4.ashx?rollno=" + roll_no;
                img_stud.Visible = true;

                // LoadYearSemester(degree_code);

                string useCOdeSet = "select LinkValue from New_InsSettings where LinkName='MultipleCollegeUserRights' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "' ";
                string colleges = Convert.ToString(d2.GetFunction(useCOdeSet)).Trim();
                if (colleges == "" || colleges == "0")
                    colleges = collegecode1;

                linkvalue = d2.GetFunction("select LinkValue from New_InsSettings where linkname = 'Fee Yearwise' and user_code ='" + usercode + "' and college_code in (" + collegecode1 + ")");

                if (linkvalue != "")
                {
                    if (linkvalue == "0")
                    {
                        //Semester
                    }
                    else
                    {
                        //Year
                        cursemvalue = returnYearforSem(cursemvalue);
                    }
                    if (ddl_sem.Items.Count > 0)
                    {
                        for (int isem = 0; isem < ddl_sem.Items.Count; isem++)
                        {
                            if (ddl_sem.Items[isem].Text.Split(' ')[0] == cursemvalue)
                                ddl_sem.SelectedIndex = isem;
                        }
                    }
                }
                studHistroy();
                btn_History.Visible = true;
                //loadAmount(appNo);
                headerbind();
                ledgerbind();
                grid_HeaderLedger.DataSource = null;
                grid_HeaderLedger.DataBind();
                loadGridStudent();
                // ScriptManager.RegisterStartupScript(this, GetType(), "InvokeButton", " SelLedgers();", true);
                divSchemeSettings.Attributes.Add("Style", "display:none;");

                btn_ledgersave.Visible = false;
                btn_ledgerExit.Visible = false;
                // chkGridSelectAll.Checked = true;
                //chkGridSelectAll_Changed(sender, e);
                // gridpaidamount();
            }
            else
            {
                txt_totamt.Text = "0";
                txt_paidamt.Text = "0";
                txt_balamt.Text = "0";
                Txt_amt.Text = "";
                img_stud.Visible = false;
                lblstaticrollno.Text = "";
                btn_History.Visible = false;
                gridHist.DataSource = null;
                gridHist.DataBind();
                txt_name.Text = "";
                txt_dept.Text = "";
                txtsec.Text = "";
                txt_SeatType.Text = "";
                txt_FatherName.Text = "";
                txt_mblno.Text = "";
                grid_Details.DataSource = null;
                grid_Details.DataBind();
                cb_sem.Checked = false;
                cbl_sem.Items.Clear();
                txt_sem.Text = "";
                img_stud.Visible = false;
                imgAlert.Attributes.Add("Style", " display:none;");
                div_HeaderLed.Attributes.Add("Style", "display:none;");
            }
            Txt_amt.Focus();
        }
        catch (Exception ex) { }

    }
    public string Scheme
    {
        get { return schemeadmission; }
        set { value = schemeadmission; }
    }
    protected string getFatherMblNo(string appNo, string collegecode1)
    {
        string mblNo = string.Empty;
        mblNo = d2.GetFunction(" select (parentF_Mobile) as mblno from applyn a,registration r where r.app_no=a.app_no and r.college_code='" + collegecode1 + "' and r.app_no='" + appNo + "' order by r.roll_admit");
        return mblNo;
    }

    //mobile search
    protected void txt_mblno_Changed(object sender, EventArgs e)
    {
        string mblno = Convert.ToString(txt_mblno.Text);
        if (!string.IsNullOrEmpty(mblno) && mblno.Contains("-"))
        {
            txt_rollno.Text = Convert.ToString(mblno.Split('-')[1]);
            txt_mblno.Text = Convert.ToString(mblno.Split('-')[0]);
            textRoll();
        }
        else
            txt_mblno.Text = string.Empty;
    }

    protected void txt_Smartno_Changed(object sender, EventArgs e)
    {

        if (txt_Smartno.Text.Trim() != "")
        {
            string Q = string.Empty;
            string useCOdeSet = "select LinkValue from New_InsSettings where LinkName='MultipleCollegeUserRights' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "' ";
            string colleges = Convert.ToString(d2.GetFunction(useCOdeSet)).Trim();
            if (colleges == "" || colleges == "0")
            {
                colleges = collegecode1;
            }
            int smartDisp = Convert.ToInt32(d2.GetFunction("select LinkValue from New_InsSettings where LinkName='DisplayNumberForSmartCd' and user_code ='" + usercode + "' and college_code in (" + collegecode1 + ")").Trim());
            switch (smartDisp)
            {
                case 0:
                    Q = "select Roll_no from Registration where smart_serial_no ='" + txt_Smartno.Text.Trim() + "'  and r.college_code='" + collegecode1 + "' ";
                    break;
                case 1:
                    Q = "select Reg_no from Registration where smart_serial_no ='" + txt_Smartno.Text.Trim() + "'  and r.college_code='" + collegecode1 + "' ";
                    break;
                case 2:
                    Q = "select Roll_admit from Registration where smart_serial_no ='" + txt_Smartno.Text.Trim() + "'  and r.college_code='" + collegecode1 + "' ";
                    break;
                case 3:
                    Q = "select app_formno from applyn a,Registration r where a.app_no=r.App_No and r.smart_serial_no='" + txt_Smartno.Text.Trim() + "'  and r.college_code='" + collegecode1 + "' ";
                    break;
            }
            string nu = d2.GetFunction(Q).Trim();
            if (nu == "0")
                txt_rollno.Text = string.Empty;
            else
                txt_rollno.Text = nu;
            textRoll();
        }
        else
        {
            txt_rollno.Text = string.Empty;

            txt_totamt.Text = "0";
            txt_paidamt.Text = "0";
            txt_balamt.Text = "0";
            img_stud.Visible = false;
            lblstaticrollno.Text = "";


            txt_name.Text = "";
            txt_dept.Text = "";
            txtsec.Text = "";
            txt_SeatType.Text = "";
            txt_FatherName.Text = "";
            grid_Details.DataSource = null;
            grid_Details.DataBind();
            cb_sem.Checked = false;
            cbl_sem.Items.Clear();
            //ddl_sem.Items.Clear();
            //ddl_semMultiple.Items.Clear();
            txt_sem.Text = "";
            img_stud.Visible = false;
        }

    }
    protected void txt_name_Changed(object sender, EventArgs e)
    {
        try
        {
            string roll_no = Convert.ToString(txt_name.Text);
            if (roll_no != "")
            {
                if (rbl_rollnoNew.SelectedIndex == 0)
                {
                    try
                    {
                        string rollno = roll_no.Split('-')[4];
                        roll_no = rollno;
                    }
                    catch { roll_no = ""; }

                }
            }
            txt_rollno.Text = roll_no;
            rbl_rollno.SelectedIndex = 0;
            txt_rollno_Changed(sender, e);
        }
        catch (Exception ex) { }
    }
    public void LoadYearSemester(string degcode)
    {
        try
        {
            cbl_sem.Items.Clear();
            cb_sem.Checked = false;
            ddl_sem.Items.Clear();
            ddl_semMultiple.Items.Clear();
            ddlSem_other.Items.Clear();
            cblSem_other.Items.Clear();
            ddlfinefee.Items.Clear();
            cbSem_other.Checked = false;
            DataSet dsSemYear = new DataSet();
            d2.featDegreeCode = degcode;
            dsSemYear = d2.loadFeecategory(Convert.ToString(collegecode1), usercode, ref linkName);
            if (dsSemYear.Tables.Count > 0)
            {
                if (dsSemYear.Tables[0].Rows.Count > 0)
                {
                    string txtName = Convert.ToString(dsSemYear.Tables[0].Rows[0]["Textval"]);
                    string txtcode = Convert.ToString(dsSemYear.Tables[0].Rows[0]["textcode"]);

                    cbl_sem.Items.Add(new ListItem(txtName, txtcode));
                    cbl_sem.DataSource = dsSemYear;
                    cbl_sem.DataTextField = "TextVal";
                    cbl_sem.DataValueField = "TextCode";
                    cbl_sem.DataBind();

                    ddl_sem.DataSource = dsSemYear;
                    ddl_sem.DataTextField = "TextVal";
                    ddl_sem.DataValueField = "TextCode";
                    ddl_sem.DataBind();

                    ddlfinefee.DataSource = dsSemYear;
                    ddlfinefee.DataTextField = "TextVal";
                    ddlfinefee.DataValueField = "TextCode";
                    ddlfinefee.DataBind();

                    ddl_semMultiple.DataSource = dsSemYear;
                    ddl_semMultiple.DataTextField = "TextVal";
                    ddl_semMultiple.DataValueField = "TextCode";
                    ddl_semMultiple.DataBind();

                    ddl_semrcpt.DataSource = dsSemYear;
                    ddl_semrcpt.DataTextField = "TextVal";
                    ddl_semrcpt.DataValueField = "TextCode";
                    ddl_semrcpt.DataBind();

                    for (int i = 0; i < cbl_sem.Items.Count; i++)
                    {
                        cbl_sem.Items[i].Selected = true;
                    }
                    txt_sem.Text = "" + linkName + "(" + cbl_sem.Items.Count + ")";
                    cb_sem.Checked = true;


                    //For Staff
                    cblSem_staff.Items.Clear();
                    cblSem_staff.DataSource = dsSemYear;
                    cblSem_staff.DataTextField = "TextVal";
                    cblSem_staff.DataValueField = "TextCode";
                    cblSem_staff.DataBind();

                    for (int i = 0; i < cblSem_staff.Items.Count; i++)
                    {
                        cblSem_staff.Items[i].Selected = true;
                    }
                    txtSem_staff.Text = "" + linkName + "(" + cblSem_staff.Items.Count + ")";
                    cbSem_staff.Checked = true;

                    ddlSem_staff.Items.Clear();
                    ddlSem_staff.DataSource = dsSemYear;
                    ddlSem_staff.DataTextField = "TextVal";
                    ddlSem_staff.DataValueField = "TextCode";
                    ddlSem_staff.DataBind();

                    //For Vendor
                    cblSem_vendor.Items.Clear();
                    cblSem_vendor.DataSource = dsSemYear;
                    cblSem_vendor.DataTextField = "TextVal";
                    cblSem_vendor.DataValueField = "TextCode";
                    cblSem_vendor.DataBind();

                    for (int i = 0; i < cblSem_vendor.Items.Count; i++)
                    {
                        cblSem_vendor.Items[i].Selected = true;
                    }
                    txtSem_vendor.Text = "" + linkName + "(" + cblSem_vendor.Items.Count + ")";
                    cbSem_vendor.Checked = true;

                    ddlSem_vendor.Items.Clear();
                    ddlSem_vendor.DataSource = dsSemYear;
                    ddlSem_vendor.DataTextField = "TextVal";
                    ddlSem_vendor.DataValueField = "TextCode";
                    ddlSem_staff.DataBind();

                    //For Others


                    cblSem_other.DataSource = dsSemYear;
                    cblSem_other.DataTextField = "TextVal";
                    cblSem_other.DataValueField = "TextCode";
                    cblSem_other.DataBind();

                    for (int i = 0; i < cblSem_other.Items.Count; i++)
                    {
                        cblSem_other.Items[i].Selected = true;
                    }
                    txtSem_other.Text = "" + linkName + "(" + cblSem_other.Items.Count + ")";
                    cbSem_other.Checked = true;

                    ddlSem_other.Items.Clear();
                    ddlSem_other.DataSource = dsSemYear;
                    ddlSem_other.DataTextField = "TextVal";
                    ddlSem_other.DataValueField = "TextCode";
                    ddlSem_other.DataBind();
                    ViewState["name"] = linkName;


                    cblsemadd.DataSource = dsSemYear;
                    cblsemadd.DataTextField = "TextVal";
                    cblsemadd.DataValueField = "TextCode";
                    cblsemadd.DataBind();

                    for (int i = 0; i < cblsemadd.Items.Count; i++)
                    {
                        // cblsemadd.Items[i].Selected = true;
                    }
                    //txtsemadd.Text = "" + linkName + "(" + cblsemadd.Items.Count + ")";
                    //cbsemadd.Checked = true;
                    txtsemadd.Text = "--Select--";
                    cbsemadd.Checked = false;

                }
            }

        }
        catch (Exception ex)
        {
            d2.sendErrorMail(ex, collegecode1, "ChallanReceipt");
        }
    }

    public void loadGridStudent()
    {
        divSchemeSettings.Attributes.Add("Style", "display:none;");
        div_HeaderLed.Attributes.Add("Style", "display:none;");
        imgAlert.Attributes.Add("Style", "display:none;");
        fromScript = false;
        try
        {
            string strScheme = "";
            if (Scheme != "" && Convert.ToBoolean(Scheme) == true)
                strScheme = "Scheme Student";
            Dictionary<string, string> dtfeecat = new Dictionary<string, string>();
            lblstaticrollno.Text = "";
            txt_totamt.Text = "0";
            txt_paidamt.Text = "0";
            txt_balamt.Text = "0";

            txt_rcptno.Text = generateReceiptNo();
            string roll_no = string.Empty;
            string semyear = "";
            string appnoNew = string.Empty;
            string degcode = string.Empty;
            string batchYear = string.Empty;
            roll_no = txt_rollno.Text.Trim();
            string finYearFk = string.Empty;
            if (chklsfyear.Items.Count > 0)
                finYearFk = Convert.ToString(getCblSelectedValue(chklsfyear));
            string finYearid = d2.getCurrentFinanceYear(usercode, collegecode1);
            string finyearText = Convert.ToString(d2.GetFunction(" select (convert(varchar(10),datepart(year,finyearstart))+'-'+convert(varchar(10),datepart(year,finyearend))) as finyearfk from fm_finyearmaster where collegecode='" + collegecode1 + "' and finyearpk='" + finYearid + "'"));
            semyear = GetSelectedItemsValueAsString(cbl_sem);
            string semyeartxt = getCblSelectedText(cbl_sem);
            #region Table Structure and Query
            DataTable tbl_Student = new DataTable();
            tbl_Student.Columns.Add("Roll_No");
            tbl_Student.Columns.Add("Reg_No");
            tbl_Student.Columns.Add("Stud_Name");
            tbl_Student.Columns.Add("Degree");
            tbl_Student.Columns.Add("TextVal");
            tbl_Student.Columns.Add("TextCode");
            tbl_Student.Columns.Add("Header_ID");
            tbl_Student.Columns.Add("Header_Name");
            tbl_Student.Columns.Add("Fee_Code");
            tbl_Student.Columns.Add("Fee_Type");
            tbl_Student.Columns.Add("Fee_Amount");
            tbl_Student.Columns.Add("Deduct");
            tbl_Student.Columns.Add("Total");
            tbl_Student.Columns.Add("PaidAmt");
            tbl_Student.Columns.Add("BalAmt");
            tbl_Student.Columns.Add("ToBePaid");
            tbl_Student.Columns.Add("Monthly");
            tbl_Student.Columns.Add("ChlTaken");
            tbl_Student.Columns.Add("Scholar");
            tbl_Student.Columns.Add("CautionDep");
            tbl_Student.Columns.Add("MonwiseMon");
            tbl_Student.Columns.Add("MonwiseYear");
            tbl_Student.Columns.Add("FeeallotPk");
            tbl_Student.Columns.Add("finyearfk");
            tbl_Student.Columns.Add("finyear");
            string selectQuery = "";

            string queryRollApp = "SELECT A.app_no,Roll_No,Reg_No,R.Stud_Name,Course_Name+'-'+Dept_Name Degree,R.Current_Semester,R.Roll_admit,G.degree_code,R.batch_year  FROM applyn A,Registration R,Degree G,Course C,Department D WHERE A.app_no = R.App_No AND R.degree_code = G.Degree_Code AND G.Course_Id = C.Course_Id AND G.college_code = C.college_code AND G.Dept_Code = D.Dept_Code AND G.college_code = D.college_code  and r.college_code='" + collegecode1 + "'  and  ";
            //CC=0 and DelFlag =0 and Exam_Flag <>'Debar'  and
            if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 0)
                queryRollApp += "  Roll_No = '" + roll_no + "' ";
            else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 1)
                queryRollApp += "   Reg_No = '" + roll_no + "' ";
            else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 2)
                queryRollApp += "  R.Roll_admit = '" + roll_no + "' ";
            else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 4)
                queryRollApp += "  r.smart_serial_no = '" + txt_Smartno.Text.Trim() + "'";
            else
            {
                queryRollApp = " SELECT a.app_formno,A.app_no,A.Stud_Name,Course_Name+'-'+Dept_Name Degree,A.Current_Semester,G.degree_code,A.batch_year  FROM applyn A,Degree G,Course C,Department D WHERE  A.degree_code = G.Degree_Code AND G.Course_Id = C.Course_Id AND G.college_code = C.college_code AND G.Dept_Code = D.Dept_Code AND G.college_code = D.college_code  and a.college_code='" + collegecode1 + "'  and   app_formno  = '" + roll_no + "' ";
            }
            DataSet dsRollApp = new DataSet();
            dsRollApp = d2.select_method_wo_parameter(queryRollApp, "Text");
            if (dsRollApp.Tables.Count > 0 && dsRollApp.Tables[0].Rows.Count > 0)
            {
                if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) != 3)
                    roll_no = Convert.ToString(dsRollApp.Tables[0].Rows[0]["Roll_Admit"]);
                else
                    roll_no = Convert.ToString(dsRollApp.Tables[0].Rows[0]["app_formno"]);
                appnoNew = Convert.ToString(dsRollApp.Tables[0].Rows[0]["app_no"]);
                degcode = Convert.ToString(dsRollApp.Tables[0].Rows[0]["degree_code"]);
                // app_formno = Convert.ToString(dsRollApp.Tables[0].Rows[0]["app_formno"]);
                batchYear = Convert.ToString(dsRollApp.Tables[0].Rows[0]["batch_year"]);
                lblstaticrollno.Text = roll_no;
                img_stud.ImageUrl = "~/Handler/Handler4.ashx?rollno=" + roll_no;
                img_stud.Visible = true;
            }
            else
            {
                roll_no = "";
                appnoNew = "";
                lblstaticrollno.Text = "";
                img_stud.Visible = false;
            }
            string headercode = getCblSelectedValue(cbl_grpheader);
            selectQuery = "  select headername,headerpk,ledgername,ledgerpk,priority,isnull(FeeAmount,0) as FeeAmount,isnull(DeductAmout,0)  as DeductAmount,isnull(TotalAmount,0) as TotalAmount,isnull(ChlTaken,0) as ChlTakAmt,isnull(PaidAmount,0) as PaidAmount,isnull(TotalAmount,0)-isnull(PaidAmount,0)  as BalAmount,(select textval from textvaltable t where t.textcode=f.feecategory) as TextVal,feecategory as TextCode,isnull(FromGovtAmt,0) as Govt,feeallotpk,( select (convert(varchar(10),datepart(year,finyearstart))+'-'+convert(varchar(10),datepart(year,finyearend))) as finyearfk from fm_finyearmaster fm where f.finyearfk=fm.finyearpk )as finyear,f.finyearfk    from (fm_ledgermaster  inner join (fm_headermaster h inner join FS_HeaderPrivilage hp on h.headerpk=hp.headerfk and hp.usercode='" + usercode + "') on h.headerpk=fm_ledgermaster.headerfk";
            if (rbl_headerselect.SelectedIndex == 1)
                selectQuery += "  and h.headerpk in('" + headercode + "')";
            else if (rbl_headerselect.SelectedIndex == 2)
                selectQuery += "   and  fm_ledgermaster.LedgerpK  in ('" + headercode + "')";

            selectQuery += "   ) left join ft_feeallot f   on fm_ledgermaster.ledgerpk=f.ledgerfk  and h.headerpk=f.headerfk and fm_ledgermaster.ledgermode='0' and MemType=1  and fm_ledgermaster.headerfk=hp.headerfk and hp.headerfk=f.headerfk   and h.collegecode='" + collegecode1 + "' ";
            if (rbl_headerselect.SelectedIndex == 1)
                selectQuery += "  and f.headerfk in('" + headercode + "')";
            else if (rbl_headerselect.SelectedIndex == 2)
                selectQuery += "   and f.LedgerFK  in ('" + headercode + "')";

            selectQuery += "   AND f.App_No = " + appnoNew + " and f.finyearfk in('" + finYearid + "') and f.feecategory in('" + semyear + "') and isnull(BalAmount,0)>0";

            string chlnTakenQ = " select Count(distinct(ChallanNo)) from FT_ChallanDet where App_No=" + appnoNew + " and FeeCategory in ('" + semyear + "')";
            if (cb_selcthd.Checked)
            {
                #region old

                if (rbl_headerselect.SelectedIndex == 0)
                {
                    headercode = GetSelectedItemsText(cbl_grpheader);
                    //Group Header
                    selectQuery = " SELECT A.HeaderFK,HeaderName,A.LedgerFK,LedgerName,priority,isnull(FeeAmount,0) as FeeAmount,isnull(DeductAmout,0)   as DeductAmount ,isnull(TotalAmount,0) as TotalAmount,isnull(ChlTaken,0) as ChlTakAmt,isnull(PaidAmount,0) as PaidAmount,isnull(TotalAmount,0)-isnull(PaidAmount,0)  as BalAmount,TextVal,TextCode,ChlGroupHeader,isnull(FromGovtAmt,0) as Govt,feeallotpk  FROM FT_FeeAllot A,FM_HeaderMaster H,FS_ChlGroupHeaderSettings S, FM_LedgerMaster L,TextValTable T WHERE A.HeaderFK = H.HeaderPK and a.headerfk = s.headerfk and l.headerfk = s.headerfk  AND A.LedgerFK = L.LedgerPK AND H.HeaderPK = L.HeaderFK AND A.FeeCategory = T.TextCode and h.headerpk = s.headerfk  and l.LedgerMode=0 and MemType=1   and ChlGroupHeader in('" + headercode + "') and T.TextCode in('" + semyear + "') ";
                    if (rdo_receipt.Checked)
                        selectQuery += " AND A.App_No = " + appnoNew + " ";
                    if (lbltype.Text != "")
                        selectQuery += "  and Stream ='" + lbltype.Text.Trim() + "' ";
                }
                else if (rbl_headerselect.SelectedIndex == 1)
                {
                    //Header
                    //selectQuery += "  and A.HeaderFK in (" + headercode + ") ";
                    // chlnTakenQ += " and headerfk in (" + headercode + ") ";
                }
                else
                {
                    //Ledger
                    //selectQuery += "  and f.LedgerFK  in ('" + headercode + "')  ";
                    //chlnTakenQ += "  and LedgerFK in (" + headercode + ")";
                }
                #endregion
            }
            if (ShowBalOnly())
            {
                //selectQuery += " and isnull(BalAmount,0)>0 ";
            }

            selectQuery += "   order by case when priority is null then 1 else 0 end, priority,TotalAmount desc";
            #endregion
            double chltakamount = 0;
            DataSet ds_stud = new DataSet();
            ds_stud.Clear();
            try
            {
                ds_stud = d2.select_method_wo_parameter(selectQuery, "Text");
            }
            catch { }
            if (ds_stud.Tables.Count > 0 && ds_stud.Tables[0].Rows.Count > 0)
            {
                #region Fine Type for College -- Common - 0; everyledger - 1
                int fineFeesType = 0;
                int.TryParse(d2.GetFunction("select LinkValue from New_InsSettings where LinkName='FineFeesType' and college_code=" + collegecode1 + ""), out fineFeesType);
                bool fineAdded = false;
                bool ReaddfineAdded = false;
                #endregion

                #region FinYear Id ,Excess Amount, Scholarship and Caution Deposit
                // string finYearid = d2.getCurrentFinanceYear(usercode, collegecode1);

                string excessamtQ = d2.GetFunction("select sum(isnull(ExcessAmt,0)-isnull(AdjAmt,0)) as BalanceAmt from FT_ExcessDet WHERE  App_No=" + appnoNew + " ");

                double excessamtValue = 0;
                double.TryParse(excessamtQ, out excessamtValue);

                double cautionRefvalue = getRefundAmount(appnoNew);

                string useCOdeSet = "select LinkValue from New_InsSettings where LinkName='MultipleCollegeUserRights' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "' ";
                string colleges = Convert.ToString(d2.GetFunction(useCOdeSet)).Trim();
                if (colleges == "" || colleges == "0")
                {
                    colleges = collegecode1;
                }
                string excessTypeQ = "select LinkValue from New_InsSettings where LinkName='ExcessFeesType' and user_code ='" + usercode + "' and college_code in (" + collegecode1 + ") ";
                byte excessTypeValue = 0;
                byte.TryParse(Convert.ToString(d2.GetFunction(excessTypeQ)), out excessTypeValue);


                string ScholarTypeQ = "select LinkValue from New_InsSettings where LinkName='ScholarshipType' and user_code ='" + usercode + "' and college_code in(" + collegecode1 + ") ";
                byte ScholarTypeValue = 0;
                byte.TryParse(Convert.ToString(d2.GetFunction(ScholarTypeQ)), out ScholarTypeValue);
                #endregion
                double fineAmount = 0;
                double readfineamount = 0;
                string fineFeecat = string.Empty;
                ArrayList arFeecatNEw = new ArrayList();
                ArrayList arFeecatReAd = new ArrayList();
                // ArrayList arFeecat = new ArrayList();
                Dictionary<string, double> dtfintFeecat = new Dictionary<string, double>();
                Dictionary<string, double> dtrefintFeecat = new Dictionary<string, double>();
                for (int sem = 0; sem < cbl_sem.Items.Count; sem++)
                {
                    if (cbl_sem.Items[sem].Selected)
                    {
                        for (i = 0; i < ds_stud.Tables[0].Rows.Count; i++)
                        {
                            #region
                            semyeartxt = Convert.ToString(cbl_sem.Items[sem].Text);
                            semyear = Convert.ToString(cbl_sem.Items[sem].Value);
                            DataRow dr_Student = tbl_Student.NewRow();

                            Int64 feeallopk = 0;
                            Int64.TryParse(Convert.ToString(ds_stud.Tables[0].Rows[i]["feeallotpk"]), out feeallopk);
                            // string feecat = Convert.ToString(ds_stud.Tables[0].Rows[i]["TextCode"]);
                            string feecat = semyear;
                            string ldgerId = Convert.ToString(ds_stud.Tables[0].Rows[i]["LedgerpK"]);
                            string hdrId = Convert.ToString(ds_stud.Tables[0].Rows[i]["HeaderpK"]);
                            string finyearfk = Convert.ToString(ds_stud.Tables[0].Rows[i]["finyearfk"]);
                            finyearfk = finyearfk == "" ? finYearid : finyearfk;
                            string finyear = Convert.ToString(ds_stud.Tables[0].Rows[i]["finyear"]);
                            dr_Student["TextVal"] = semyeartxt;
                            dr_Student["TextCode"] = semyear;
                            dr_Student["Header_ID"] = hdrId;
                            dr_Student["Header_Name"] = Convert.ToString(ds_stud.Tables[0].Rows[i]["HeaderName"]);
                            dr_Student["Fee_Code"] = ldgerId;
                            dr_Student["feeallotpk"] = feeallopk;
                            dr_Student["Fee_Type"] = Convert.ToString(ds_stud.Tables[0].Rows[i]["LedgerName"]) + retQuantity(appnoNew, ldgerId, "1", feecat);
                            dr_Student["ChlTaken"] = Convert.ToString(ds_stud.Tables[0].Rows[i]["ChlTakAmt"]);
                            string chlamount = Convert.ToString(ds_stud.Tables[0].Rows[i]["ChlTakAmt"]);
                            if (chlamount.Trim() != "")
                            {
                                chltakamount = chltakamount + Convert.ToDouble(chlamount);
                            }
                            //appnoNew = Convert.ToString(ds_stud.Tables[0].Rows[i]["App_No"]);
                            double feeamt = Convert.ToDouble(ds_stud.Tables[0].Rows[i]["FeeAmount"]);
                            double deductamt = Convert.ToDouble(ds_stud.Tables[0].Rows[i]["DeductAmount"]);
                            double totamt = Convert.ToDouble(ds_stud.Tables[0].Rows[i]["TotalAmount"]);
                            double paid = Convert.ToDouble(ds_stud.Tables[0].Rows[i]["PaidAmount"]);
                            double balamt = Convert.ToDouble(ds_stud.Tables[0].Rows[i]["BalAmount"]);
                            double curExcess = 0;
                            double scholarAmt = 0;
                            double curCautAmt = 0;

                            //  string feevalue = Convert.ToString(ds_stud.Tables[0].Rows[i]["TextVal"]);
                            string feevalue = semyeartxt;
                            if (balamt > 0 && !dtfeecat.ContainsKey(feecat))
                            {
                                dtfeecat.Add(feecat, feevalue);
                            }

                            dr_Student["ToBePaid"] = "0";
                            dr_Student["Fee_Amount"] = feeamt;
                            dr_Student["Deduct"] = deductamt;
                            dr_Student["Total"] = totamt;
                            dr_Student["PaidAmt"] = paid;
                            dr_Student["BalAmt"] = balamt;
                            dr_Student["finyearfk"] = finyearfk;
                            dr_Student["finyear"] = finyearText;
                            if (feeallopk > 0)
                            {
                                string monthWiseQ = " select isnull(AllotAmount,0) as AllotAmt,isnull(PaidAmount,0) as PaidAmount,isnull(AllotAmount,0)-isnull(PaidAmount,0) as BalAmount,AllotMonth,AllotYear,( select (convert(varchar(10),datepart(year,finyearstart))+'-'+convert(varchar(10),datepart(year,finyearend))) as finyearfk from fm_finyearmaster fm where a.finyearfk=fm.finyearpk )as finyear,a.finyearfk  from FT_FeeallotMonthly a where FeeAllotPK=" + feeallopk + "";
                                DataSet dsMonWiseDet = d2.select_method_wo_parameter(monthWiseQ, "Text");
                                if (dsMonWiseDet.Tables.Count > 0 && dsMonWiseDet.Tables[0].Rows.Count > 0)
                                {
                                    //unused
                                    #region
                                    double curMonExcess = curExcess;
                                    double scholarMonAmt = scholarAmt;
                                    double curCautMonAMt = curCautAmt;
                                    for (int mon = 0; mon < dsMonWiseDet.Tables[0].Rows.Count; mon++)
                                    {
                                        DataRow dr_StudentMonth = tbl_Student.NewRow();

                                        //Added on 04-06-2016
                                        double totamtMon = 0;
                                        double paidMon = 0;
                                        double balamtMon = 0;

                                        double.TryParse(Convert.ToString(dsMonWiseDet.Tables[0].Rows[mon]["AllotAmt"]), out totamtMon);
                                        double.TryParse(Convert.ToString(dsMonWiseDet.Tables[0].Rows[mon]["PaidAmount"]), out paidMon);
                                        balamtMon = totamtMon - paidMon;

                                        //Excess Adjust
                                        double curExcessM = 0;
                                        if (totamtMon >= paidMon + curMonExcess)
                                        {
                                            curExcessM = curMonExcess;
                                            balamtMon = balamtMon - (curExcessM);
                                            curMonExcess = 0;
                                            dr_StudentMonth["Monthly"] = curExcessM;
                                        }
                                        else
                                        {
                                            curExcessM = totamtMon - paidMon;
                                            curMonExcess -= curExcessM;
                                            balamtMon = balamtMon - (curExcessM);
                                            dr_StudentMonth["Monthly"] = curExcessM;
                                        }

                                        //Scholarship adjust
                                        double scholarAmtM = 0;

                                        if (totamtMon >= (paidMon + curExcessM + scholarMonAmt))
                                        {
                                            scholarAmtM = scholarMonAmt;
                                            balamtMon = balamtMon - (scholarAmtM);
                                            scholarMonAmt = 0;
                                            dr_Student["Scholar"] = scholarAmtM;
                                        }
                                        else
                                        {
                                            scholarAmtM = totamtMon - (paidMon + curExcessM);
                                            scholarMonAmt -= scholarAmtM;
                                            balamtMon = balamtMon - (scholarAmtM);
                                            dr_Student["Scholar"] = scholarAmtM;
                                        }

                                        //Caution Deposit Adjust
                                        double curCautAmtM = 0;

                                        if (totamtMon >= (paidMon + curExcessM + scholarAmtM + curCautMonAMt))
                                        {
                                            curCautAmtM = curCautMonAMt;
                                            balamtMon = balamtMon - (curCautAmtM);
                                            curCautMonAMt = 0;
                                            dr_Student["CautionDep"] = curCautAmtM;
                                        }
                                        else
                                        {
                                            curCautAmtM = totamtMon - (paidMon + curExcessM + scholarAmtM);
                                            curCautMonAMt -= curCautAmtM;
                                            balamtMon = balamtMon - (curCautAmtM);
                                            dr_Student["CautionDep"] = curCautAmtM;
                                        }

                                        dr_StudentMonth["BalAmt"] = balamtMon;
                                        //Ended on 04-06-2016

                                        dr_StudentMonth["TextVal"] = Convert.ToString(ds_stud.Tables[0].Rows[i]["TextVal"]);
                                        dr_StudentMonth["TextCode"] = feecat;
                                        dr_StudentMonth["Header_ID"] = hdrId;
                                        dr_StudentMonth["Header_Name"] = Convert.ToString(ds_stud.Tables[0].Rows[i]["HeaderName"]);
                                        dr_StudentMonth["Fee_Code"] = ldgerId;
                                        dr_StudentMonth["Fee_Type"] = Convert.ToString(ds_stud.Tables[0].Rows[i]["LedgerName"]) + "-" + reUse.returnMonthName(Convert.ToInt32(Convert.ToString(dsMonWiseDet.Tables[0].Rows[mon]["AllotMonth"]))) + "-" + Convert.ToString(dsMonWiseDet.Tables[0].Rows[mon]["AllotYear"]);
                                        dr_StudentMonth["MonwiseMon"] = Convert.ToString(dsMonWiseDet.Tables[0].Rows[mon]["AllotMonth"]);
                                        dr_StudentMonth["MonwiseYear"] = Convert.ToString(dsMonWiseDet.Tables[0].Rows[mon]["AllotYear"]);
                                        dr_StudentMonth["Feeallotpk"] = feeallopk;

                                        dr_StudentMonth["Fee_Amount"] = Convert.ToString(dsMonWiseDet.Tables[0].Rows[mon]["AllotAmt"]);
                                        dr_StudentMonth["Total"] = Convert.ToString(dsMonWiseDet.Tables[0].Rows[mon]["AllotAmt"]);
                                        dr_StudentMonth["PaidAmt"] = Convert.ToString(dsMonWiseDet.Tables[0].Rows[mon]["PaidAmount"]);
                                        //dr_StudentMonth["BalAmt"] = Convert.ToString(dsMonWiseDet.Tables[0].Rows[mon]["BalAmount"]);
                                        finyearfk = Convert.ToString(dsMonWiseDet.Tables[0].Rows[mon]["finyearfk"]);
                                        finyear = Convert.ToString(dsMonWiseDet.Tables[0].Rows[mon]["finyear"]);
                                        dr_StudentMonth["finyearfk"] = finyearfk;
                                        dr_StudentMonth["finyear"] = finyear;
                                        dr_StudentMonth["ToBePaid"] = "0";
                                        dr_StudentMonth["Deduct"] = deductamt;
                                        tbl_Student.Rows.Add(dr_StudentMonth);
                                    }
                                    #endregion
                                }
                                else
                                    tbl_Student.Rows.Add(dr_Student);
                            }
                            else
                                tbl_Student.Rows.Add(dr_Student);

                            if (!fineAdded && !arFeecatNEw.Contains(feecat))
                            {
                                #region Fine Calculation
                                if (balamt > 0)
                                {
                                    string fineQ = "select FineMasterPK, FineType, FromDay, ToDay, isnull(FineAmount,0) as FineAmt, DueDate, F.HeaderFk, Ledgerfk, Feecatgory, Degreecode, F.collegecode, LedgerName, HeaderName,( select (convert(varchar(10),finyearstart,103)+'-'+convert(varchar(10),finyearend,103)) as finyearfk from fm_finyearmaster fm where f.finyearfk=fm.finyearpk)as finyear,f.finyearfk from Fm_FInemaster F,FM_LedgerMaster L,FM_HeaderMaster H where f.CollegeCode=L.CollegeCode and F.CollegeCode=h.CollegeCode and f.HeaderFK=h.HeaderPK and f.HeaderFK=l.HeaderFK and f.LedgerFK=l.LedgerPK and Duedate<GETDATE() and F.CollegeCode=" + collegecode1 + " and DegreeCode='" + degcode + "' and H.Headerpk ='" + hdrId + "' and L.LedgerPK='" + ldgerId + "' and FeeCatgory in ('" + feecat + "') and isnull(FineSettingType,0)='0' and BatchYear='" + batchYear + "' and f.finyearfk in('" + finyearfk + "')  select distinct holiday_date from holidaystudents where degree_code=" + degcode + "";

                                    DataSet dsFine = new DataSet();
                                    dsFine = d2.select_method_wo_parameter(fineQ, "Text");
                                    if (dsFine.Tables.Count > 0)
                                    {
                                        if (dsFine.Tables[0].Rows.Count > 0)
                                        {
                                            for (int fn = 0; fn < dsFine.Tables[0].Rows.Count; fn++)
                                            {
                                                string fineType = Convert.ToString(dsFine.Tables[0].Rows[fn]["FineType"]);
                                                DateTime due = Convert.ToDateTime(dsFine.Tables[0].Rows[fn]["DueDate"]);
                                                // DateTime curDate = DateTime.Now.Date;
                                                string recptDt = txt_date.Text.Split('/')[1] + "/" + txt_date.Text.Split('/')[0] + "/" + txt_date.Text.Split('/')[2];
                                                DateTime curDate = Convert.ToDateTime(recptDt);
                                                #region Check for Due Extension
                                                DateTime dueExt = due;
                                                string dueDtstring = "select  max(ExtDueDate) as DueDate from FeesDueExt where App_No='" + appnoNew + "' and  FeeCategory='" + feecat + "' and HeaderFK='" + hdrId + "' and LedgerFK='" + ldgerId + "'";
                                                try
                                                {
                                                    dueExt = Convert.ToDateTime(d2.GetFunction(dueDtstring).Trim());
                                                }
                                                catch { dueExt = due; }
                                                // DateTime.TryParse(d2.GetFunction(dueDtstring).Trim(), out dueExt);
                                                due = dueExt;
                                                #endregion

                                                if (fineType == "1")
                                                {
                                                    //common - No holiday
                                                    if (due < curDate)
                                                    {
                                                        fineAmount += Convert.ToDouble(dsFine.Tables[0].Rows[fn]["FineAmt"]);
                                                    }
                                                }
                                                else if (fineType == "2")
                                                {
                                                    //Per day - 
                                                    for (; due < curDate; due = due.AddDays(1))
                                                    {
                                                        bool addFine = true;
                                                        if (dsFine.Tables.Count > 1 && dsFine.Tables[1].Rows.Count > 0)
                                                        {
                                                            dsFine.Tables[1].DefaultView.RowFilter = " holiday_date ='" + due + "'";
                                                            DataView dvFinDt = dsFine.Tables[1].DefaultView;
                                                            if (dvFinDt.Count > 0)
                                                                addFine = false;
                                                        }
                                                        if (addFine)
                                                            fineAmount += Convert.ToDouble(dsFine.Tables[0].Rows[fn]["FineAmt"]);
                                                    }
                                                }
                                                else if (fineType == "3")
                                                {
                                                    //Per week
                                                    TimeSpan td = curDate - due;
                                                    int difference = td.Days;
                                                    int fromday = Convert.ToInt32(dsFine.Tables[0].Rows[fn]["FromDay"]);
                                                    int to_day = Convert.ToInt32(dsFine.Tables[0].Rows[fn]["ToDay"]);

                                                    if (difference <= to_day && difference >= fromday)
                                                    {
                                                        fineAmount += Convert.ToDouble(dsFine.Tables[0].Rows[fn]["FineAmt"]);
                                                    }
                                                }

                                            }
                                        }

                                    }
                                    if (fineAmount > 0 && fineFeesType == 0)
                                    {
                                        if (!dtfintFeecat.ContainsKey(feecat))
                                            dtfintFeecat.Add(feecat, fineAmount);
                                        else
                                            dtfintFeecat[feecat] += fineAmount;
                                        //fineAdded = true;
                                        fineAmount = 0;
                                        if (!arFeecatNEw.Contains(feecat))
                                            arFeecatNEw.Add(feecat);
                                    }
                                }
                                #endregion
                            }
                            //Re-admission fees settings
                            if (!ReaddfineAdded && !arFeecatReAd.Contains(feecat))
                            {
                                #region Fine Calculation
                                if (balamt > 0)
                                {
                                    string fineQ = "select FineMasterPK, FineType, FromDay, ToDay, isnull(FineAmount,0) as FineAmt, DueDate, F.HeaderFk, Ledgerfk, Feecatgory, Degreecode, F.collegecode, LedgerName, HeaderName,( select (convert(varchar(10),finyearstart,103)+'-'+convert(varchar(10),finyearend,103)) as finyearfk from fm_finyearmaster fm where f.finyearfk=fm.finyearpk)as finyear,f.finyearfk from Fm_FInemaster F,FM_LedgerMaster L,FM_HeaderMaster H where f.CollegeCode=L.CollegeCode and F.CollegeCode=h.CollegeCode and f.HeaderFK=h.HeaderPK and f.HeaderFK=l.HeaderFK and f.LedgerFK=l.LedgerPK and Duedate<GETDATE() and F.CollegeCode=" + collegecode1 + " and DegreeCode='" + degcode + "' and H.Headerpk ='" + hdrId + "' and L.LedgerPK='" + ldgerId + "' and FeeCatgory in ('" + feecat + "') and isnull(FineSettingType,0)='1' and BatchYear='" + batchYear + "' and f.finyearfk in('" + finyearfk + "')  select distinct holiday_date from holidaystudents where degree_code=" + degcode + "";

                                    DataSet dsFine = new DataSet();
                                    dsFine = d2.select_method_wo_parameter(fineQ, "Text");
                                    if (dsFine.Tables.Count > 0)
                                    {
                                        if (dsFine.Tables[0].Rows.Count > 0)
                                        {
                                            for (int fn = 0; fn < dsFine.Tables[0].Rows.Count; fn++)
                                            {
                                                string fineType = Convert.ToString(dsFine.Tables[0].Rows[fn]["FineType"]);
                                                DateTime due = Convert.ToDateTime(dsFine.Tables[0].Rows[fn]["DueDate"]);
                                                // DateTime curDate = DateTime.Now.Date;
                                                string recptDt = txt_date.Text.Split('/')[1] + "/" + txt_date.Text.Split('/')[0] + "/" + txt_date.Text.Split('/')[2];
                                                DateTime curDate = Convert.ToDateTime(recptDt);
                                                #region Check for Due Extension
                                                DateTime dueExt = due;
                                                string dueDtstring = "select  max(ExtDueDate) as DueDate from FeesDueExt where App_No='" + appnoNew + "' and  FeeCategory='" + feecat + "' and HeaderFK='" + hdrId + "' and LedgerFK='" + ldgerId + "'";
                                                try
                                                {
                                                    dueExt = Convert.ToDateTime(d2.GetFunction(dueDtstring).Trim());
                                                }
                                                catch { dueExt = due; }
                                                // DateTime.TryParse(d2.GetFunction(dueDtstring).Trim(), out dueExt);
                                                due = dueExt;
                                                #endregion

                                                if (fineType == "1")
                                                {
                                                    //common - No holiday
                                                    if (due < curDate)
                                                    {
                                                        readfineamount += Convert.ToDouble(dsFine.Tables[0].Rows[fn]["FineAmt"]);
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    if (readfineamount > 0 && fineFeesType == 0)
                                    {
                                        ReaddfineAdded = true;
                                        if (!dtrefintFeecat.ContainsKey(feecat))
                                            dtrefintFeecat.Add(feecat, fineAmount);
                                        else
                                            dtrefintFeecat[feecat] += fineAmount;

                                        if (!arFeecatReAd.Contains(feecat))
                                            arFeecatReAd.Add(feecat);
                                    }
                                }
                                #endregion
                            }
                            #endregion
                        }
                    }
                }

                #region Fine Adjustment
                double ovrAllBalAmt = 0;
                try
                {
                    for (int bal = 0; bal < tbl_Student.Rows.Count; bal++)
                    {
                        string balAmti = Convert.ToString(tbl_Student.Rows[bal]["BalAmt"]).Trim();
                        if (balAmti != "")
                        {
                            ovrAllBalAmt += Convert.ToDouble(balAmti);
                        }
                    }
                }
                catch { ovrAllBalAmt = 0; }

                if (ovrAllBalAmt > 0)
                {
                    string fineLegHedQ = d2.GetFunction(" select Linkvalue from New_InsSettings where LinkName='FineLedgerValue' and user_code ='" + usercode + "' and college_code  in (" + collegecode1 + ")");
                    if (fineLegHedQ != "0" && dtfintFeecat.Count > 0)
                    {
                        string fineHdrId = fineLegHedQ.Split(',')[0];
                        string fineLgrId = fineLegHedQ.Split(',')[1];
                        string fineHdrName = d2.GetFunction(" select headername from fm_headermaster where headerpk=" + fineHdrId + " and CollegeCode=" + collegecode1 + "");
                        string fineLgrName = d2.GetFunction("  select ledgername from fm_ledgermaster where ledgerpk=" + fineLgrId + " and HeaderFK=" + fineHdrId + " and CollegeCode=" + collegecode1 + "");
                        fineAmount = 0;
                        foreach (KeyValuePair<string, double> fine in dtfintFeecat)
                        {
                            string sbfine = string.Empty;
                            string feestr = string.Empty;
                            sbfine = Convert.ToString(fine.Key + "$" + fine.Value);
                            fineAmount = fine.Value;
                            if (dtfeecat.ContainsKey(fine.Key))
                                feestr = Convert.ToString(dtfeecat[fine.Key]);
                            //}
                            //if (sbfine.Length > 0)
                            //    sbfine.Remove(sbfine.Length - 1, 1);

                            DataRow drFine = tbl_Student.NewRow();
                            drFine["Header_ID"] = fineHdrId;
                            drFine["Header_Name"] = fineHdrName;
                            drFine["Fee_Code"] = fineLgrId;
                            drFine["Fee_Type"] = fineLgrName;
                            drFine["ChlTaken"] = "0";
                            drFine["TextVal"] = "FINE" + "-" + feestr;
                            drFine["TextCode"] = Convert.ToString(sbfine);
                            drFine["Fee_Amount"] = fineAmount;
                            drFine["Deduct"] = "0";
                            drFine["Total"] = fineAmount;
                            drFine["PaidAmt"] = "0";
                            drFine["BalAmt"] = fineAmount;
                            drFine["ToBePaid"] = "0";
                            drFine["Monthly"] = "0";
                            drFine["Scholar"] = "0";
                            drFine["CautionDep"] = "0";
                            //tbl_Student.Rows.Add(drFine);
                            drFine["finyearfk"] = "0";
                            drFine["finyear"] = "0";
                            tbl_Student.Rows.InsertAt(drFine, 0);
                        }
                    }
                }
                #endregion

                //Re-Admission fees settings
                #region Fine Adjustment
                double ovrAllBalAmtread = 0;
                try
                {
                    for (int bal = 0; bal < tbl_Student.Rows.Count; bal++)
                    {
                        string balAmti = Convert.ToString(tbl_Student.Rows[bal]["BalAmt"]).Trim();
                        if (balAmti != "")
                        {
                            ovrAllBalAmtread += Convert.ToDouble(balAmti);
                        }
                    }
                }
                catch { ovrAllBalAmtread = 0; }

                if (ovrAllBalAmtread > 0)
                {
                    string fineLegHedQ = d2.GetFunction(" select Linkvalue from New_InsSettings where LinkName='ReAdmissionFessSettings' and user_code ='" + usercode + "' and college_code  in (" + collegecode1 + ")");
                    if (fineLegHedQ != "0" && dtrefintFeecat.Count > 0)
                    {
                        string fineHdrId = fineLegHedQ.Split(',')[0];
                        string fineLgrId = fineLegHedQ.Split(',')[1];
                        string fineHdrName = d2.GetFunction(" select headername from fm_headermaster where headerpk=" + fineHdrId + " and CollegeCode=" + collegecode1 + "");
                        string fineLgrName = d2.GetFunction("  select ledgername from fm_ledgermaster where ledgerpk=" + fineLgrId + " and HeaderFK=" + fineHdrId + " and CollegeCode=" + collegecode1 + "");
                        foreach (KeyValuePair<string, double> fine in dtrefintFeecat)
                        {
                            string sbfine = string.Empty;
                            string feestr = string.Empty;
                            sbfine = Convert.ToString(fine.Key + "$" + fine.Value);
                            readfineamount = fine.Value;
                            if (dtrefintFeecat.ContainsKey(fine.Key))
                                feestr = Convert.ToString(dtrefintFeecat[fine.Key]);
                            //}
                            //if (sbfine.Length > 0)
                            //    sbfine.Remove(sbfine.Length - 1, 1);
                            DataRow drFine = tbl_Student.NewRow();
                            drFine["Header_ID"] = fineHdrId;
                            drFine["Header_Name"] = fineHdrName;
                            drFine["Fee_Code"] = fineLgrId;
                            drFine["Fee_Type"] = fineLgrName;
                            drFine["ChlTaken"] = "0";
                            drFine["TextVal"] = "FINE" + "-" + feestr;
                            drFine["TextCode"] = Convert.ToString(sbfine);
                            drFine["Fee_Amount"] = readfineamount;
                            drFine["Deduct"] = "0";
                            drFine["Total"] = readfineamount;
                            drFine["PaidAmt"] = "0";
                            drFine["BalAmt"] = readfineamount;
                            drFine["ToBePaid"] = "0";
                            drFine["Monthly"] = "0";
                            drFine["Scholar"] = "0";
                            drFine["CautionDep"] = "0";
                            //tbl_Student.Rows.Add(drFine);
                            tbl_Student.Rows.InsertAt(drFine, 0);
                        }
                    }
                }
                #endregion


                #region Fine Adjustment old
                //double ovrAllBalAmts = 0;
                //try
                //{
                //    for (int bal = 0; bal < tbl_Student.Rows.Count; bal++)
                //    {
                //        string balAmti = Convert.ToString(tbl_Student.Rows[bal]["BalAmt"]).Trim();
                //        if (balAmti != "")
                //            ovrAllBalAmts += Convert.ToDouble(balAmti);
                //    }
                //}
                //catch { ovrAllBalAmts = 0; }
                //double FineAmount = 0;
                //double.TryParse(Convert.ToString(txtfine.Text), out FineAmount);
                //if (ovrAllBalAmts > 0 && cbfine.Checked && FineAmount != 0)
                //{
                //    string fineLegHedQ = d2.GetFunction(" select Linkvalue from New_InsSettings where LinkName='FineLedgerValue' and user_code ='" + usercode + "' and college_code  in (" + collegecode1 + ")");
                //    if (fineLegHedQ != "0" && FineAmount > 0)
                //    {
                //        string fineHdrId = fineLegHedQ.Split(',')[0];
                //        string fineLgrId = fineLegHedQ.Split(',')[1];
                //        string fineHdrName = d2.GetFunction(" select headername from fm_headermaster where headerpk=" + fineHdrId + " and CollegeCode=" + collegecode1 + "");
                //        string fineLgrName = d2.GetFunction("  select ledgername from fm_ledgermaster where ledgerpk=" + fineLgrId + " and HeaderFK=" + fineHdrId + " and CollegeCode=" + collegecode1 + "");
                //        string strFine = Convert.ToString(ddlfinefee.SelectedItem.Value) + "$" + Convert.ToString(FineAmount);
                //        DataRow drFine = tbl_Student.NewRow();
                //        drFine["Header_ID"] = fineHdrId;
                //        drFine["Header_Name"] = fineHdrName;
                //        drFine["Fee_Code"] = fineLgrId;
                //        drFine["Fee_Type"] = fineLgrName;
                //        drFine["ChlTaken"] = "0";
                //        drFine["TextVal"] = "FINE";
                //        drFine["TextCode"] = strFine;
                //        drFine["Fee_Amount"] = Convert.ToString(FineAmount);
                //        drFine["Deduct"] = "0";
                //        drFine["Total"] = Convert.ToString(FineAmount);
                //        drFine["PaidAmt"] = "0";
                //        drFine["BalAmt"] = Convert.ToString(FineAmount);
                //        drFine["ToBePaid"] = "0";
                //        drFine["Monthly"] = "0";
                //        drFine["Scholar"] = "0";
                //        drFine["CautionDep"] = "0";
                //        //tbl_Student.Rows.Add(drFine);
                //        tbl_Student.Rows.InsertAt(drFine, 0);
                //    }
                //}
                //if (cbfine.Checked)
                //{
                //    ddlfinefee.Attributes.Add("Style", "display:block;float: left;");
                //    txtfine.Attributes.Add("Style", "display:block;float: left;");
                //}
                #endregion

                if (tbl_Student.Rows.Count > 0 && txt_rollno.Text.Trim() != "")
                {
                    grid_Details.DataSource = tbl_Student;
                    grid_Details.DataBind();
                    grid_Details.Visible = true;
                    divgrid.Visible = true;
                    if (rdo_receipt.Checked)
                        btn_print.Visible = false;
                    imgAlert.Attributes.Add("Style", "display:none;");
                    //  loadfeecategory(dtfeecat);
                    headerandsemload();
                    divSchemeSettings.Attributes.Add("Style", "display:none;");
                    ScriptManager.RegisterStartupScript(this, GetType(), "InvokeButton", " checkfeeamount();", true);
                }
                else
                {
                    grid_Details.DataSource = null;
                    grid_Details.DataBind();
                    grid_Details.Visible = false;
                    divSchemeSettings.Attributes.Add("Style", "display:none;");
                    imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                    if (strScheme != "")
                        lbl_alert.Text = strScheme + " Please Add Fees";
                    else
                        lbl_alert.Text = "Please Add Fees";

                    btn_print.Visible = false;
                    divgrid.Visible = false;
                }
            }
            else
            {
                try
                {
                    grid_Details.DataSource = null;
                    grid_Details.DataBind();
                    grid_Details.Visible = false;
                    divgrid.Visible = false;
                }
                catch { }
                divSchemeSettings.Attributes.Add("Style", "display:none;");
                imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                if (strScheme != "")
                    lbl_alert.Text = strScheme + " Please Add Fees";
                else
                    lbl_alert.Text = "Please Add Fees";
                btn_print.Visible = false;
                divgrid.Visible = false;
            }
            Session["appNo"] = appnoNew;
        }
        catch (Exception ex)
        {
            // d2.sendErrorMail(ex, collegecode1, "ChallanReceipt");
            grid_Details.DataSource = null;
            grid_Details.DataBind();
            grid_Details.Visible = false;
            // imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
            // lbl_alert.Text = "No Records Found";
            btn_print.Visible = false;
            Session["appNo"] = "";
            divgrid.Visible = false;
        }
    }

    protected void loadAmount(string appnoNew)
    {
        try
        {
            #region
            Dictionary<string, string> dtfeecat = new Dictionary<string, string>();
            string semyear = GetSelectedItemsValueAsString(cbl_sem);
            selectQuery = " SELECT A.HeaderFK,HeaderName,A.LedgerFK,LedgerName,priority,isnull(FeeAmount,0) as FeeAmount,isnull(DeductAmout,0)  as DeductAmount,isnull(TotalAmount,0) as TotalAmount,isnull(ChlTaken,0) as ChlTakAmt,isnull(PaidAmount,0) as PaidAmount,isnull(TotalAmount,0)-isnull(PaidAmount,0)  as BalAmount,TextVal,TextCode,isnull(FromGovtAmt,0) as Govt,feeallotpk  FROM FT_FeeAllot A,FM_HeaderMaster H,FM_LedgerMaster L,TextValTable T,FS_HeaderPrivilage P  WHERE A.HeaderFK = H.HeaderPK AND A.LedgerFK = L.LedgerPK  and P.HeaderFK = H.HeaderPK and P.HeaderFK = L.HeaderFK and a.HeaderFK=p.HeaderFK  AND H.HeaderPK = L.HeaderFK AND A.FeeCategory = T.TextCode and l.LedgerMode=0 and MemType=1  and T.TextCode in('" + semyear + "') AND A.App_No = " + appnoNew + "  and p.UserCode='" + usercode + "'";

            string chlnTakenQ = " select Count(distinct(ChallanNo)) from FT_ChallanDet where App_No=" + appnoNew + " and FeeCategory in ('" + semyear + "')";
            if (cb_selcthd.Checked)
            {
                string headercode = GetSelectedItemsValue(cbl_grpheader);
                if (rbl_headerselect.SelectedIndex == 0)
                {
                    headercode = GetSelectedItemsText(cbl_grpheader);
                    //Group Header
                    selectQuery = " SELECT A.HeaderFK,HeaderName,A.LedgerFK,LedgerName,priority,isnull(FeeAmount,0) as FeeAmount,isnull(DeductAmout,0)   as DeductAmount ,isnull(TotalAmount,0) as TotalAmount,isnull(ChlTaken,0) as ChlTakAmt,isnull(PaidAmount,0) as PaidAmount,isnull(TotalAmount,0)-isnull(PaidAmount,0)  as BalAmount,TextVal,TextCode,ChlGroupHeader,isnull(FromGovtAmt,0) as Govt,feeallotpk  FROM FT_FeeAllot A,FM_HeaderMaster H,FS_ChlGroupHeaderSettings S, FM_LedgerMaster L,TextValTable T WHERE A.HeaderFK = H.HeaderPK and a.headerfk = s.headerfk and l.headerfk = s.headerfk  AND A.LedgerFK = L.LedgerPK AND H.HeaderPK = L.HeaderFK AND A.FeeCategory = T.TextCode and h.headerpk = s.headerfk  and l.LedgerMode=0 and MemType=1   and ChlGroupHeader in('" + headercode + "') and T.TextCode in('" + semyear + "') ";
                    if (rdo_receipt.Checked)
                        selectQuery += " AND A.App_No = " + appnoNew + " ";
                    if (lbltype.Text != "")
                        selectQuery += "  and Stream ='" + lbltype.Text.Trim() + "' ";
                }
                else if (rbl_headerselect.SelectedIndex == 1)
                    selectQuery += "  and A.HeaderFK in (" + headercode + ") ";
                else
                    selectQuery += "  and A.LedgerFK  in (" + headercode + ")  ";
            }
            if (ShowBalOnly())
                selectQuery += " and isnull(BalAmount,0)>0 ";
            selectQuery += "   order by case when priority is null then 1 else 0 end, priority";
            #endregion
            DataSet ds_stud = new DataSet();
            ds_stud.Clear();
            ds_stud = d2.select_method_wo_parameter(selectQuery, "Text");
            if (ds_stud.Tables.Count > 0)
            {
                if (ds_stud.Tables[0].Rows.Count > 0)
                {
                    double feeamt = 0;
                    double deductamt = 0;
                    double totamt = 0;
                    double paid = 0;
                    double balamt = 0;
                    double totTotamt = 0;
                    double totPaid = 0;
                    double totBalamt = 0;
                    for (i = 0; i < ds_stud.Tables[0].Rows.Count; i++)
                    {
                        double.TryParse(Convert.ToString(ds_stud.Tables[0].Rows[i]["FeeAmount"]), out feeamt);
                        double.TryParse(Convert.ToString(ds_stud.Tables[0].Rows[i]["DeductAmount"]), out deductamt);
                        double.TryParse(Convert.ToString(ds_stud.Tables[0].Rows[i]["TotalAmount"]), out totamt);
                        double.TryParse(Convert.ToString(ds_stud.Tables[0].Rows[i]["PaidAmount"]), out paid);
                        double.TryParse(Convert.ToString(ds_stud.Tables[0].Rows[i]["BalAmount"]), out balamt);
                        string feetext = Convert.ToString(ds_stud.Tables[0].Rows[i]["TextVal"]);
                        string feevalue = Convert.ToString(ds_stud.Tables[0].Rows[i]["Textcode"]);
                        if (balamt > 0 && !dtfeecat.ContainsKey(feevalue))
                        {
                            dtfeecat.Add(feevalue, feetext);
                        }
                        totTotamt += totamt;
                        totPaid += paid;
                        totBalamt += balamt;
                    }
                    txt_totamt.Text = Convert.ToString(totTotamt);
                    txt_paidamt.Text = Convert.ToString(totPaid);
                    txt_balamt.Text = Convert.ToString(totBalamt);
                    imgAlert.Attributes.Add("Style", " display:none;");
                    div_HeaderLed.Attributes.Add("Style", "display:none;");
                    loadfeecategory(dtfeecat);
                }
                else
                {
                    txt_totamt.Text = "0";
                    txt_paidamt.Text = "0";
                    txt_balamt.Text = "0";
                    Txt_amt.Text = "";
                    divgrid.Visible = false;
                    div_HeaderLed.Attributes.Add("Style", "display:none;");
                    imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                    lbl_alert.Text = "Please Add Fees";
                }
            }
            else
            {
                txt_totamt.Text = "0";
                txt_paidamt.Text = "0";
                txt_balamt.Text = "0";
                Txt_amt.Text = "";
                divgrid.Visible = false;
                div_HeaderLed.Attributes.Add("Style", "display:none;");
                imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                lbl_alert.Text = "Please Add Fees";
            }
        }
        catch { }
    }

    protected void getloadfeecat(string appnoNew)
    {
        try
        {
            #region
            Dictionary<string, string> dtfeecat = new Dictionary<string, string>();
            selectQuery = " SELECT A.HeaderFK,HeaderName,A.LedgerFK,LedgerName,priority,isnull(FeeAmount,0) as FeeAmount,isnull(DeductAmout,0)  as DeductAmount,isnull(TotalAmount,0) as TotalAmount,isnull(ChlTaken,0) as ChlTakAmt,isnull(PaidAmount,0) as PaidAmount,isnull(TotalAmount,0)-isnull(PaidAmount,0)  as BalAmount,TextVal,TextCode,isnull(FromGovtAmt,0) as Govt,feeallotpk  FROM FT_FeeAllot A,FM_HeaderMaster H,FM_LedgerMaster L,TextValTable T,FS_HeaderPrivilage P  WHERE A.HeaderFK = H.HeaderPK AND A.LedgerFK = L.LedgerPK  and P.HeaderFK = H.HeaderPK and P.HeaderFK = L.HeaderFK and a.HeaderFK=p.HeaderFK  AND H.HeaderPK = L.HeaderFK AND A.FeeCategory = T.TextCode and l.LedgerMode=0 and MemType=1  AND A.App_No = " + appnoNew + "  and p.UserCode='" + usercode + "'";
            if (cb_selcthd.Checked)
            {
                string headercode = GetSelectedItemsValue(cbl_grpheader);
                if (rbl_headerselect.SelectedIndex == 0)
                {
                    headercode = GetSelectedItemsText(cbl_grpheader);
                    //Group Header
                    selectQuery = " SELECT A.HeaderFK,HeaderName,A.LedgerFK,LedgerName,priority,isnull(FeeAmount,0) as FeeAmount,isnull(DeductAmout,0)   as DeductAmount ,isnull(TotalAmount,0) as TotalAmount,isnull(ChlTaken,0) as ChlTakAmt,isnull(PaidAmount,0) as PaidAmount,isnull(TotalAmount,0)-isnull(PaidAmount,0)  as BalAmount,TextVal,TextCode,ChlGroupHeader,isnull(FromGovtAmt,0) as Govt,feeallotpk  FROM FT_FeeAllot A,FM_HeaderMaster H,FS_ChlGroupHeaderSettings S, FM_LedgerMaster L,TextValTable T WHERE A.HeaderFK = H.HeaderPK and a.headerfk = s.headerfk and l.headerfk = s.headerfk  AND A.LedgerFK = L.LedgerPK AND H.HeaderPK = L.HeaderFK AND A.FeeCategory = T.TextCode and h.headerpk = s.headerfk  and l.LedgerMode=0 and MemType=1   and ChlGroupHeader in('" + headercode + "') ";
                    if (rdo_receipt.Checked)
                        selectQuery += " AND A.App_No = " + appnoNew + " ";
                    if (lbltype.Text != "")
                        selectQuery += "  and Stream ='" + lbltype.Text.Trim() + "' ";
                }
                else if (rbl_headerselect.SelectedIndex == 1)
                    selectQuery += "  and A.HeaderFK in (" + headercode + ") ";
                else
                    selectQuery += "  and A.LedgerFK  in (" + headercode + ")  ";
            }
            if (ShowBalOnly())
                selectQuery += " and isnull(BalAmount,0)>0 ";
            selectQuery += "   order by case when priority is null then 1 else 0 end, priority";
            #endregion
            DataSet ds_stud = new DataSet();
            ds_stud.Clear();
            ds_stud = d2.select_method_wo_parameter(selectQuery, "Text");
            if (ds_stud.Tables.Count > 0)
            {
                if (ds_stud.Tables[0].Rows.Count > 0)
                {
                    double feeamt = 0;
                    double deductamt = 0;
                    double totamt = 0;
                    double paid = 0;
                    double balamt = 0;
                    double totTotamt = 0;
                    double totPaid = 0;
                    double totBalamt = 0;
                    for (i = 0; i < ds_stud.Tables[0].Rows.Count; i++)
                    {
                        //double.TryParse(Convert.ToString(ds_stud.Tables[0].Rows[i]["FeeAmount"]), out feeamt);
                        //double.TryParse(Convert.ToString(ds_stud.Tables[0].Rows[i]["DeductAmount"]), out deductamt);
                        //double.TryParse(Convert.ToString(ds_stud.Tables[0].Rows[i]["TotalAmount"]), out totamt);
                        //double.TryParse(Convert.ToString(ds_stud.Tables[0].Rows[i]["PaidAmount"]), out paid);
                        double.TryParse(Convert.ToString(ds_stud.Tables[0].Rows[i]["BalAmount"]), out balamt);
                        string feetext = Convert.ToString(ds_stud.Tables[0].Rows[i]["TextVal"]);
                        string feevalue = Convert.ToString(ds_stud.Tables[0].Rows[i]["Textcode"]);
                        if (balamt > 0 && !dtfeecat.ContainsKey(feevalue))
                        {
                            dtfeecat.Add(feevalue, feetext);
                        }
                        //totTotamt += totamt;
                        //totPaid += paid;
                        //totBalamt += balamt;
                    }
                    //txt_totamt.Text = Convert.ToString(totTotamt);
                    //txt_paidamt.Text = Convert.ToString(totPaid);
                    //txt_balamt.Text = Convert.ToString(totBalamt);
                    //imgAlert.Attributes.Add("Style", " display:none;");
                    loadfeecategory(dtfeecat);
                }
                else
                {
                    //txt_totamt.Text = "0";
                    //txt_paidamt.Text = "0";
                    //txt_balamt.Text = "0";
                    //Txt_amt.Text = "";
                    //divgrid.Visible = false;
                    //div_HeaderLed.Attributes.Add("Style", "display:none;");
                    //imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                    //lbl_alert.Text = "Please Add Fees";
                }
            }
            else
            {
                //txt_totamt.Text = "0";
                //txt_paidamt.Text = "0";
                //txt_balamt.Text = "0";
                //Txt_amt.Text = "";
                //divgrid.Visible = false;
                //div_HeaderLed.Attributes.Add("Style", "display:none;");
                //imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                //lbl_alert.Text = "Please Add Fees";
            }
        }
        catch { }
    }

    protected void loadfeecategory(Dictionary<string, string> dtfeecat)
    {
        if (dtfeecat.Count > 0)
        {
            cb_sem.Checked = false;
            cbl_sem.Items.Clear();
            ddlfinefee.Items.Clear();
            foreach (KeyValuePair<string, string> fee in dtfeecat)
            {
                string val = fee.Key;
                string txt = fee.Value;
                cbl_sem.Items.Add(new ListItem(txt, val));
                ddlfinefee.Items.Add(new ListItem(txt, val));
            }
            for (int i = 0; i < cbl_sem.Items.Count; i++)
            {
                cbl_sem.Items[i].Selected = true;
            }
            txt_sem.Text = "Term(" + Convert.ToString(cbl_sem.Items.Count) + ")";
            cb_sem.Checked = true;
        }
    }
    protected void headerandsemload()
    {
        string text = "";
        if (rbl_headerselect.SelectedIndex == 0)
            text = "Group Header";
        else if (rbl_headerselect.SelectedIndex == 1)
            text = " Header";
        else
            text = " Ledger";
        int cnt = 0;
        for (int i = 0; i < cbl_grpheader.Items.Count; i++)
        {
            if (cbl_grpheader.Items[i].Selected)
            {
                cbl_grpheader.Items[i].Selected = true;
                cnt++;
            }
        }
        txt_grpheader.Text = text + "(" + Convert.ToString(cnt) + ")";
        if (cnt == cbl_grpheader.Items.Count)
            cb_selectHeadAll.Checked = true;
        else
            cb_selectHeadAll.Checked = false;
        cnt = 0;
        for (int i = 0; i < cbl_sem.Items.Count; i++)
        {
            if (cbl_sem.Items[i].Selected)
            {
                cbl_sem.Items[i].Selected = true;
                cnt++;
            }
        }
        txt_sem.Text = "Term" + "(" + Convert.ToString(cnt) + ")";
        if (cnt == cbl_sem.Items.Count)
            cb_sem.Checked = true;
        else
            cb_sem.Checked = false;
    }
    public string retQuantity(string appNo, string ledgerId, string memtype, string feecat)
    {
        string Qty = string.Empty;
        string Q = "select sum (isnull(Quantity,0)-isnull(IssuedQUantity,0)) from Indivitual_student_ItemIssue where app_no='" + appNo + "' and ledgerfk='" + ledgerId + "' and memtype='" + memtype + "' and feecategory='" + feecat + "'";
        Qty = d2.GetFunction(Q).Trim();
        Qty = string.IsNullOrEmpty(Qty) ? "0" : Qty;
        Qty = Qty == "0" ? string.Empty : " - Quantity (" + Qty + ")";
        return Qty;
    }
    protected void rdo_receipt_CheckedChanged(object sender, EventArgs e)
    {
        balRow.Visible = true;
        lbltxtamt.Visible = true;
        Txt_amt.Visible = true;
        chk_rcptMulmode.Enabled = true;
        rcptsngle.Visible = true;
        divMulReceipt.Visible = false;
        div_rcpt.Visible = true;
        chk_rcptMulmode.Checked = false;
        chl_MulRcpt.Checked = false;
        txt_totamt.Text = "0";
        txt_paidamt.Text = "0";
        txt_balamt.Text = "0";
        div_formultich.Visible = true;
        checCashDD.Visible = true;

        rb_cash.Visible = true;
        rb_cheque.Visible = true;
        rb_dd.Visible = true;
        rb_card.Visible = true;
        div_multich.Visible = false;
        div_ch1.Visible = true;
        //visible COllege ROw

        btnAddFee.Visible = false;
        btn_History.Visible = true;
        // btnExc.Visible = true;
        lbl_remark.Visible = true;
        txt_remark.Visible = true;

        bank();
        cardType();
        accidRecpt = string.Empty;
        lastRecptNo = string.Empty;
        txt_rcptno.Text = generateReceiptNo();
        grid_Details.Visible = false;
        btn_print.Visible = false;
        //loadGridStudent();      
        txt_return.Text = "";
        txt_dept.Text = "";
        txtsec.Text = "";
        txt_SeatType.Text = "";
        txt_FatherName.Text = "";
        txt_name.Text = "";
        txt_rollno.Text = "";
        Txt_amt.Text = "";
        imgAlert.Attributes.Add("Style", "display:none;");
        img_stud.ImageUrl = "";
        img_stud.Visible = false;
        btn_print.Visible = false;
        btn_save.Visible = true;
        txtDept_staff.Text = "";
        txtname_staff.Text = "";

        rcptsngle.Visible = false;
        rcptSngleStaff.Visible = false;
        rcptSngleVendor.Visible = false;
        rcptSngleOthers.Visible = false;
        if (rbl_rollnoNew.SelectedIndex == 0)
        {
            rcptsngle.Visible = true;
        }
        else if (rbl_rollnoNew.SelectedIndex == 1)
        {
            rcptSngleStaff.Visible = true;
        }
        else if (rbl_rollnoNew.SelectedIndex == 2)
        {
            rcptSngleVendor.Visible = true;
        }
        else
        {
            rcptSngleOthers.Visible = true;
        }
    }
    protected void rdo_challan_CheckedChanged(object sender, EventArgs e)
    {



        balRow.Visible = true;
        lbltxtamt.Visible = true;
        Txt_amt.Visible = true;
        rcptsngle.Visible = true;
        divMulReceipt.Visible = false;
        div_rcpt.Visible = false;
        chk_rcptMulmode.Checked = false;
        chl_MulRcpt.Checked = false;
        txt_totnoofstudents.Text = "";
        txt_totamt.Text = "0";
        txt_paidamt.Text = "0";
        txt_balamt.Text = "0";
        Txt_amt.Text = "";
        txt_rollno.Text = "";
        div_formultich.Visible = true;
        // checCashDD.Visible = false;
        rb_cash.Visible = false;
        rb_cheque.Visible = false;
        rb_dd.Visible = false;
        rb_card.Visible = false;
        //div_singlech.Visible = true;
        div_multich.Visible = false;
        div_ch1.Visible = false;
        //invisible COllege ROw

        btnAddFee.Visible = false;
        btn_History.Visible = false;
        // btnExc.Visible = false;
        lbl_remark.Visible = false;
        txt_remark.Visible = false;
        string featdegCode = string.Empty;
        LoadYearSemester(featdegCode);

        bank();
        cardType();
        accidRecpt = string.Empty;
        lastRecptNo = string.Empty;
        //txt_rcptno.Text = generateReceiptNo();
        txt_rcptno.Text = generateChallanNo();
        grid_Details.Visible = false;
        btn_print.Visible = false;
        //txt_rollno_Changed(sender, e);       
        txt_return.Text = "";
        imgAlert.Attributes.Add("Style", "display:none;");
        img_stud.ImageUrl = "";
        txt_dept.Text = "";
        txtsec.Text = "";
        txt_SeatType.Text = "";
        txt_FatherName.Text = "";
        txt_name.Text = "";
        img_stud.Visible = false;
        //btn_print.Visible = true;
        btn_save.Visible = false;
        imgAlert.Attributes.Add("Style", "display:none;");
        txtDept_staff.Text = "";
        txtname_staff.Text = "";

        rcptsngle.Visible = false;
        rcptSngleStaff.Visible = false;
        rcptSngleVendor.Visible = false;
        rcptSngleOthers.Visible = false;
        if (rbl_rollnoNew.SelectedIndex == 0)
        {
            rcptsngle.Visible = true;

        }
        else if (rbl_rollnoNew.SelectedIndex == 1)
        {
            rcptSngleStaff.Visible = true;
        }
        else if (rbl_rollnoNew.SelectedIndex == 2)
        {
            rcptSngleVendor.Visible = true;
        }
        else
        {
            rcptSngleOthers.Visible = true;
        }

    }
    protected void rdo_sngle_CheckedChanged(object sender, EventArgs e)
    {
        div_rcpt.Visible = false;
        chk_rcptMulmode.Checked = false;
        chl_MulRcpt.Checked = false;
        txt_totamt.Text = "0";
        txt_paidamt.Text = "0";
        txt_balamt.Text = "0";
        div_formultich.Visible = true;
        //  div_singlech.Visible = true;
        div_multich.Visible = false;
        grid_Details.Visible = false;
        txt_rcptno.Text = generateChallanNo();
        btn_print.Visible = false;
        img_stud.ImageUrl = "";
        txt_rollno.Text = "";
        //txt_rollno_Changed(sender, e);
        img_stud.Visible = false;
        imgAlert.Attributes.Add("Style", "display:none;");
        txt_dept.Text = "";
        txtsec.Text = "";
        txt_SeatType.Text = "";
        txt_FatherName.Text = "";
        txt_name.Text = "";
        string featdegCode = string.Empty;
        LoadYearSemester(featdegCode);
    }
    protected void rdo_multi_CheckedChanged(object sender, EventArgs e)
    {
        div_rcpt.Visible = false;
        chk_rcptMulmode.Checked = false;
        chl_MulRcpt.Checked = false;
        txt_totnoofstudents.Text = "";
        txt_totamt.Text = "0";
        txt_paidamt.Text = "0";
        txt_balamt.Text = "0";

        div_formultich.Visible = false;
        //div_singlech.Visible = false;
        div_multich.Visible = true;
        grid_Details.Visible = false;
        btn_print.Visible = false;
        txt_rollno.Text = "";
        img_stud.ImageUrl = "";
        img_stud.Visible = false;
        txt_rcptno.Text = generateChallanNo();
        //txt_rollno_Changed(sender, e);
        imgAlert.Attributes.Add("Style", "display:none;");
        txt_dept.Text = "";
        txtsec.Text = "";
        txt_SeatType.Text = "";
        txt_FatherName.Text = "";
        txt_name.Text = "";
        string featdegCode = string.Empty;
        LoadYearSemester(featdegCode);
    }
    protected void chl_MulRcpt_OnCheckedChanged(object sender, EventArgs e)
    {
        txt_tostudentsrcpt.Text = "";
        txtMultTotal.Text = "0.00";
        if (chl_MulRcpt.Checked)
        {
            rcptsngle.Visible = false;
            div_rcpt.Visible = true;
            chk_rcptMulmode.Checked = false;
            chk_rcptMulmode.Enabled = false;

            txt_totamt.Text = "0";
            txt_paidamt.Text = "0";
            txt_balamt.Text = "0";


            divMulReceipt.Visible = true;
            grid_Details.Visible = false;

            txt_rollno.Text = "";
            img_stud.ImageUrl = "";
            img_stud.Visible = false;
            txt_rcptno.Text = generateReceiptNo();

            imgAlert.Attributes.Add("Style", "display:none;");
            txt_dept.Text = "";
            txtsec.Text = "";
            txt_SeatType.Text = "";
            txt_FatherName.Text = "";
            txt_name.Text = "";
            string featdegCode = string.Empty;
            LoadYearSemester(featdegCode);
            balRow.Visible = false;
            lbltxtamt.Visible = false;
            Txt_amt.Visible = false;
            cb_selcthd.Checked = true;
            cb_selcthd.Enabled = false;


            btnAddFee.Enabled = false;
            btn_History.Enabled = false;

        }
        else
        {
            cb_selcthd.Checked = true;
            cb_selcthd.Enabled = true;
            rcptsngle.Visible = true;
            divMulReceipt.Visible = false;
            chk_rcptMulmode.Enabled = true;
            rdo_receipt_CheckedChanged(sender, e);

            btnAddFee.Enabled = true;
            btn_History.Enabled = true;
        }
        //Select Headers
        try
        {

            // cbl_grpheader.Items.Clear();
            if (cb_selcthd.Checked)
            {
                div_fs.Visible = true;
                div_grphdr.Visible = true;
                //rbl_headerselect.SelectedIndex = 0;
                //cb_selectHeadAll.Visible = true;
                //cb_selectHeadAll.Checked = true;
                //headerSlecetionChanged();

            }
            else
            {
                //cb_selectHeadAll.Visible = false;
                //cb_selectHeadAll.Checked = false;
                div_grphdr.Visible = false;
                div_fs.Visible = false;
            }


            imgAlert.Attributes.Add("Style", "display:none;");
        }
        catch (Exception ex) { }
    }
    protected void cb_selcthd_CheckedChanged(object sender, EventArgs e)
    {
        loadOnOverallCheck();
    }
    private void loadOnOverallCheck()
    {
        try
        {
            cbl_grpheader.Items.Clear();
            if (cb_selcthd.Checked)
            {
                div_fs.Visible = true;
                div_grphdr.Visible = true;
                //rbl_headerselect.SelectedIndex = 0;
                cb_selectHeadAll.Visible = true;
                //cb_selectHeadAll.Checked = true;
                headerSlecetionChanged();

            }
            else
            {
                cb_selectHeadAll.Visible = false;
                cb_selectHeadAll.Checked = false;
                div_grphdr.Visible = false;
                div_fs.Visible = false;
            }
            if (rbl_rollnoNew.SelectedIndex == 0)
            {
                loadGridStudent();
                lookupAmount();
            }
            else if (rbl_rollnoNew.SelectedIndex == 1)
            {
                loadGridStaff();
            }
            else if (rbl_rollnoNew.SelectedIndex == 2)
            {
                loadGridVendor();
            }
            else if (rbl_rollnoNew.SelectedIndex == 3)
            {
                loadGridOthers();
            }


            //if (rdo_challan.Checked && rdo_multi.Checked && txt_totnoofstudents.Text != "")
            //{
            //    btn_print.Visible = true;
            //}
            imgAlert.Attributes.Add("Style", "display:none;");
            //else
            //{
            //txt_totnoofstudents.Text = "";
            //}
        }
        catch (Exception ex) { }
    }
    private void selectLedgers()
    {
        #region Select All
        try
        {
            double tottobepaidval = 0.00;
            double totbalamt = 0.00;
            double totamtOv = 0;
            double paiOv = 0;
            double totAmtToPay = 0;

            for (int i = 0; i < grid_Details.Rows.Count; i++)
            {

                CheckBox cbl = (CheckBox)grid_Details.Rows[i].Cells[1].FindControl("cb_selectLedger");
                txt_totamt.Text = "0";
                txt_paidamt.Text = "0";
                txt_balamt.Text = "0";
                //txt_examt.Text = "0.00";               
                if (chkGridSelectAll.Checked)
                {
                    cbl.Checked = true;
                }
                else
                {
                    cbl.Checked = false;
                }
                TextBox txt = (TextBox)grid_Details.Rows[i].Cells[1].FindControl("txt_tobepaid_amt");
                TextBox txtbal = (TextBox)grid_Details.Rows[i].Cells[1].FindControl("txt_bal_amt");
                TextBox txttotal = (TextBox)grid_Details.Rows[i].Cells[1].FindControl("txt_tot_amt");
                TextBox txtpaid = (TextBox)grid_Details.Rows[i].Cells[1].FindControl("txt_paid_amt");
                TextBox txtexgridamt = (TextBox)grid_Details.Rows[i].Cells[1].FindControl("txt_gridexcess_amt");
                TextBox txtgridschlamt = (TextBox)grid_Details.Rows[i].Cells[1].FindControl("txt_scholar_amt");
                TextBox txtgridCautamt = (TextBox)grid_Details.Rows[i].Cells[1].FindControl("txt_deposit_amt");
                txt.Text = "0.00";
                totamtOv += Convert.ToDouble(txttotal.Text);
                paiOv += Convert.ToDouble(txtpaid.Text);

                double curExcess = 0.00;
                double scholamt = 0.00;
                double curCautAmt = 0.00;
                //if (rdo_challan.Checked == false)
                //{
                //    if (cb_exfees.Checked == true)
                //    {
                //        double.TryParse(txtexgridamt.Text.Trim(), out curExcess);
                //    }
                //    if (cb_govt.Checked == true)
                //    {
                //        double.TryParse(txtgridschlamt.Text.Trim(), out scholamt);
                //    }
                //    if (cb_CautionDep.Checked == true)
                //    {
                //        double.TryParse(txtgridCautamt.Text.Trim(), out curCautAmt);
                //    }
                //}

                if (txt != null && txtbal != null && txttotal != null && txtpaid != null)
                {

                    if (cbl.Checked == false)
                    {
                        txt.Text = "0.00";
                    }
                    else
                    {
                        //if (txt.Text == "0" || txt.Text == "0.00" || txt.Text == "")
                        //{
                        //    txt.Text = (Convert.ToDouble(txttotal.Text) - (Convert.ToDouble(txtpaid.Text) + curExcess + scholamt)).ToString();
                        //}
                    }

                    if ((Convert.ToDouble(txt.Text) <= (Convert.ToDouble(txttotal.Text) - (Convert.ToDouble(txtpaid.Text) + curExcess + scholamt + curCautAmt))))
                    {

                        tottobepaidval = tottobepaidval + Convert.ToDouble(txt.Text);
                        totbalamt += (Convert.ToDouble(txttotal.Text) - (Convert.ToDouble(txtpaid.Text) + curExcess + scholamt + curCautAmt)) - Convert.ToDouble(txt.Text);
                        Txt_amt.Text = tottobepaidval.ToString();
                        txt_balamt.Text = totbalamt.ToString();
                        txtbal.Text = ((Convert.ToDouble(txttotal.Text) - (Convert.ToDouble(txtpaid.Text) + curExcess + scholamt + curCautAmt)) - Convert.ToDouble(txt.Text)).ToString();
                    }
                    else
                    {

                        totbalamt += (Convert.ToDouble(txttotal.Text) - (Convert.ToDouble(txtpaid.Text) + curExcess + scholamt + curCautAmt));
                        Txt_amt.Text = tottobepaidval.ToString();
                        txt_balamt.Text = totbalamt.ToString();
                        txt.Text = "0.00";
                    }
                }
                //if (rdo_challan.Checked && cbl.Checked)
                //{
                //    totAmtToPay += Convert.ToDouble(txt.Text) + curExcess + scholamt + curCautAmt;
                //}
                if (rdo_receipt.Checked)
                {
                    totAmtToPay += Convert.ToDouble(txt.Text) + curExcess + scholamt + curCautAmt;
                }

                if (rdo_receipt.Checked)
                {
                    if ((Convert.ToDouble(txt.Text) + curExcess + scholamt + curCautAmt) > 0)
                    {
                        cbl.Checked = true;
                    }
                    else
                    {
                        cbl.Checked = false;
                    }
                }
            }
            txt_totamt.Text = totamtOv.ToString();
            txt_paidamt.Text = paiOv.ToString();
            lbl_CurPay.Text = "Total Amount To Be Paid : Rs." + totAmtToPay + " /-";
        }
        catch (Exception ex) { }
        #endregion
    }
    private void selectLedgerAmount()
    {
        #region Select All
        try
        {

            if (chkGridSelectAll.Checked)
            {
                // double 
                for (int i = 0; i < grid_Details.Rows.Count; i++)
                {
                    CheckBox cbl = (CheckBox)grid_Details.Rows[i].Cells[1].FindControl("cb_selectLedger");
                    cbl.Checked = true;
                    TextBox txt = (TextBox)grid_Details.Rows[i].Cells[1].FindControl("txt_tobepaid_amt");
                    TextBox txtbal = (TextBox)grid_Details.Rows[i].Cells[1].FindControl("txt_bal_amt");
                    TextBox txttotal = (TextBox)grid_Details.Rows[i].Cells[1].FindControl("txt_tot_amt");
                    TextBox txtpaid = (TextBox)grid_Details.Rows[i].Cells[1].FindControl("txt_paid_amt");
                    double tobepaid = 0;
                    double paidAmt = 0;
                    double balAmt = 0;
                    double totalAmt = 0;
                    double.TryParse(Convert.ToString(txttotal.Text), out totalAmt);
                    double.TryParse(Convert.ToString(txtpaid.Text), out paidAmt);
                    double.TryParse(Convert.ToString(txtbal.Text), out balAmt);
                    // balAmt = totalAmt - paidAmt;
                    //
                }
            }





            double tottobepaidval = 0.00;
            double totbalamt = 0.00;
            double totamtOv = 0;
            double paiOv = 0;
            double totAmtToPay = 0;

            for (int i = 0; i < grid_Details.Rows.Count; i++)
            {

                CheckBox cbl = (CheckBox)grid_Details.Rows[i].Cells[1].FindControl("cb_selectLedger");
                txt_totamt.Text = "0";
                txt_paidamt.Text = "0";
                txt_balamt.Text = "0";
                //txt_examt.Text = "0.00";               
                if (chkGridSelectAll.Checked)
                {
                    cbl.Checked = true;
                }
                else
                {
                    cbl.Checked = false;
                }
                TextBox txt = (TextBox)grid_Details.Rows[i].Cells[1].FindControl("txt_tobepaid_amt");
                TextBox txtbal = (TextBox)grid_Details.Rows[i].Cells[1].FindControl("txt_bal_amt");
                TextBox txttotal = (TextBox)grid_Details.Rows[i].Cells[1].FindControl("txt_tot_amt");
                TextBox txtpaid = (TextBox)grid_Details.Rows[i].Cells[1].FindControl("txt_paid_amt");
                TextBox txtexgridamt = (TextBox)grid_Details.Rows[i].Cells[1].FindControl("txt_gridexcess_amt");
                TextBox txtgridschlamt = (TextBox)grid_Details.Rows[i].Cells[1].FindControl("txt_scholar_amt");
                TextBox txtgridCautamt = (TextBox)grid_Details.Rows[i].Cells[1].FindControl("txt_deposit_amt");
                txt.Text = "0.00";
                totamtOv += Convert.ToDouble(txttotal.Text);
                paiOv += Convert.ToDouble(txtpaid.Text);

                double curExcess = 0.00;
                double scholamt = 0.00;
                double curCautAmt = 0.00;
                //if (rdo_challan.Checked == false)
                //{
                //    if (cb_exfees.Checked == true)
                //    {
                //        double.TryParse(txtexgridamt.Text.Trim(), out curExcess);
                //    }
                //    if (cb_govt.Checked == true)
                //    {
                //        double.TryParse(txtgridschlamt.Text.Trim(), out scholamt);
                //    }
                //    if (cb_CautionDep.Checked == true)
                //    {
                //        double.TryParse(txtgridCautamt.Text.Trim(), out curCautAmt);
                //    }
                //}

                if (txt != null && txtbal != null && txttotal != null && txtpaid != null)
                {

                    if (cbl.Checked == false)
                    {
                        txt.Text = "0.00";
                    }
                    else
                    {
                        //if (txt.Text == "0" || txt.Text == "0.00" || txt.Text == "")
                        //{
                        //    txt.Text = (Convert.ToDouble(txttotal.Text) - (Convert.ToDouble(txtpaid.Text) + curExcess + scholamt)).ToString();
                        //}
                    }

                    if ((Convert.ToDouble(txt.Text) <= (Convert.ToDouble(txttotal.Text) - (Convert.ToDouble(txtpaid.Text) + curExcess + scholamt + curCautAmt))))
                    {

                        tottobepaidval = tottobepaidval + Convert.ToDouble(txt.Text);
                        totbalamt += (Convert.ToDouble(txttotal.Text) - (Convert.ToDouble(txtpaid.Text) + curExcess + scholamt + curCautAmt)) - Convert.ToDouble(txt.Text);
                        Txt_amt.Text = tottobepaidval.ToString();
                        txt_balamt.Text = totbalamt.ToString();
                        txtbal.Text = ((Convert.ToDouble(txttotal.Text) - (Convert.ToDouble(txtpaid.Text) + curExcess + scholamt + curCautAmt)) - Convert.ToDouble(txt.Text)).ToString();
                    }
                    else
                    {

                        totbalamt += (Convert.ToDouble(txttotal.Text) - (Convert.ToDouble(txtpaid.Text) + curExcess + scholamt + curCautAmt));
                        Txt_amt.Text = tottobepaidval.ToString();
                        txt_balamt.Text = totbalamt.ToString();
                        txt.Text = "0.00";
                    }
                }
                //if (rdo_challan.Checked && cbl.Checked)
                //{
                //    totAmtToPay += Convert.ToDouble(txt.Text) + curExcess + scholamt + curCautAmt;
                //}
                if (rdo_receipt.Checked)
                {
                    totAmtToPay += Convert.ToDouble(txt.Text) + curExcess + scholamt + curCautAmt;
                }

                if (rdo_receipt.Checked)
                {
                    if ((Convert.ToDouble(txt.Text) + curExcess + scholamt + curCautAmt) > 0)
                    {
                        cbl.Checked = true;
                    }
                    else
                    {
                        cbl.Checked = false;
                    }
                }
            }
            txt_totamt.Text = totamtOv.ToString();
            txt_paidamt.Text = paiOv.ToString();
            lbl_CurPay.Text = "Total Amount To Be Paid : Rs." + totAmtToPay + " /-";
        }
        catch (Exception ex) { }
        #endregion
    }
    private void selectLedgersChallan()
    {
        #region Select All
        try
        {
            double tottobepaidval = 0.00;
            double totbalamt = 0.00;
            double totamtOv = 0;
            double paiOv = 0;
            for (int i = 0; i < grid_Details.Rows.Count; i++)
            {

                CheckBox cbl = (CheckBox)grid_Details.Rows[i].Cells[1].FindControl("cb_selectLedger");
                txt_totamt.Text = "0";
                txt_paidamt.Text = "0";
                txt_balamt.Text = "0";
                //  txt_examt.Text = "0.00";               
                if (chkGridSelectAll.Checked)
                {
                    cbl.Checked = true;
                }
                else
                {
                    cbl.Checked = false;
                }
                TextBox txt = (TextBox)grid_Details.Rows[i].Cells[1].FindControl("txt_tobepaid_amt");
                TextBox txtbal = (TextBox)grid_Details.Rows[i].Cells[1].FindControl("txt_bal_amt");
                TextBox txttotal = (TextBox)grid_Details.Rows[i].Cells[1].FindControl("txt_tot_amt");
                TextBox txtpaid = (TextBox)grid_Details.Rows[i].Cells[1].FindControl("txt_paid_amt");
                TextBox txtexgridamt = (TextBox)grid_Details.Rows[i].Cells[1].FindControl("txt_gridexcess_amt");
                TextBox txtgridschlamt = (TextBox)grid_Details.Rows[i].Cells[1].FindControl("txt_scholar_amt");
                TextBox txtgridCautamt = (TextBox)grid_Details.Rows[i].Cells[1].FindControl("txt_deposit_amt");
                Label lblchltkn = (Label)grid_Details.Rows[i].Cells[1].FindControl("lbl_chltkn");
                txt.Text = "0.00";
                totamtOv += Convert.ToDouble(txttotal.Text);
                paiOv += Convert.ToDouble(txtpaid.Text);

                double curExcess = 0.00;
                double scholamt = 0.00;
                double curCautAmt = 0.00;
                //if (rdo_challan.Checked == false)
                //{
                //    if (cb_exfees.Checked == true)
                //    {
                //        double.TryParse(txtexgridamt.Text.Trim(), out curExcess);
                //    }
                //    if (cb_govt.Checked == true)
                //    {
                //        double.TryParse(txtgridschlamt.Text.Trim(), out scholamt);
                //    }
                //    if (cb_CautionDep.Checked == true)
                //    {
                //        double.TryParse(txtgridCautamt.Text.Trim(), out curCautAmt);
                //    }
                //}

                if (txt != null && txtbal != null && txttotal != null && txtpaid != null)
                {

                    if (cbl.Checked == false)
                    {
                        txt.Text = "0.00";
                    }
                    else
                    {
                        if (txt.Text == "0" || txt.Text == "0.00" || txt.Text == "")
                        {
                            if ((Convert.ToDouble(txttotal.Text) - (Convert.ToDouble(lblchltkn.Text.Trim()) + Convert.ToDouble(txtpaid.Text) + curExcess + scholamt + curCautAmt)) > 0)
                            {
                                txt.Text = (Convert.ToDouble(txttotal.Text) - (Convert.ToDouble(lblchltkn.Text.Trim()) + Convert.ToDouble(txtpaid.Text) + curExcess + scholamt + curCautAmt)).ToString();
                            }
                        }
                    }

                    if ((Convert.ToDouble(txt.Text) <= (Convert.ToDouble(txttotal.Text) - (Convert.ToDouble(lblchltkn.Text.Trim()) + Convert.ToDouble(txtpaid.Text) + curExcess + scholamt + curCautAmt))))
                    {

                        tottobepaidval = tottobepaidval + Convert.ToDouble(txt.Text);
                        totbalamt += (Convert.ToDouble(txttotal.Text) - (Convert.ToDouble(lblchltkn.Text.Trim()) + Convert.ToDouble(txtpaid.Text) + curExcess + scholamt + curCautAmt)) - Convert.ToDouble(txt.Text);
                        Txt_amt.Text = tottobepaidval.ToString();
                        txt_balamt.Text = totbalamt.ToString();
                        txtbal.Text = ((Convert.ToDouble(txttotal.Text) - (Convert.ToDouble(lblchltkn.Text.Trim()) + Convert.ToDouble(txtpaid.Text) + curExcess + scholamt + curCautAmt)) - Convert.ToDouble(txt.Text)).ToString();
                    }
                    else
                    {
                        if ((Convert.ToDouble(txttotal.Text) - (Convert.ToDouble(lblchltkn.Text.Trim()) + Convert.ToDouble(txtpaid.Text) + curExcess + scholamt + curCautAmt)) > 0)
                        {
                            totbalamt += (Convert.ToDouble(txttotal.Text) - (Convert.ToDouble(lblchltkn.Text.Trim()) + Convert.ToDouble(txtpaid.Text) + curExcess + scholamt + curCautAmt));
                        }
                        Txt_amt.Text = tottobepaidval.ToString();
                        txt_balamt.Text = totbalamt.ToString();
                        txt.Text = "0.00";
                    }
                }
            }
            txt_totamt.Text = totamtOv.ToString();
            txt_paidamt.Text = paiOv.ToString();
        }
        catch (Exception ex) { }
        #endregion
    }
    //Group Header, Header, Ledger
    protected void cb_selectHeadAll_OnCheckedChanged(object sender, EventArgs e)
    {
        try
        {
            if (rbl_rollnoNew.SelectedIndex == 0)
            {
                loadGridStudent();
            }
            else if (rbl_rollnoNew.SelectedIndex == 1)
            {
                loadGridStaff();
            }
            else if (rbl_rollnoNew.SelectedIndex == 2)
            {
                loadGridVendor();
            }
            else if (rbl_rollnoNew.SelectedIndex == 3)
            {
                loadGridOthers();
            }
            imgAlert.Attributes.Add("Style", "display:none;");

            chkGridSelectAll.Checked = true;
            int cnt = 0;
            if (cb_selectHeadAll.Checked)
            {
                cnt = cbl_grpheader.Items.Count;
            }
            string headerstr = "Group Header";
            if (rbl_headerselect.SelectedIndex == 1)
            {
                headerstr = "Header";
            }
            else if (rbl_headerselect.SelectedIndex == 2)
            {
                headerstr = "Ledger";
            }
            txt_grpheader.Text = headerstr + "(" + cnt + ")";
            // selectLedgers();
            lookupAmount();
        }
        catch (Exception ex) { }
    }
    protected void cbl_grpheader_SelectedIndexChanged(object sender, EventArgs e)
    {
        headersSelected();
    }
    private void headersSelected()
    {
        chkGridSelectAll.Checked = true;
        if (rbl_rollnoNew.SelectedIndex == 0)
        {
            loadGridStudent();
        }
        else if (rbl_rollnoNew.SelectedIndex == 1)
        {
            loadGridStaff();
        }
        else if (rbl_rollnoNew.SelectedIndex == 2)
        {
            loadGridVendor();
        }
        else if (rbl_rollnoNew.SelectedIndex == 3)
        {
            loadGridOthers();
        }
        imgAlert.Attributes.Add("Style", "display:none;");

        int cnt = 0;
        for (int i = 0; i < cbl_grpheader.Items.Count; i++)
        {
            if (cbl_grpheader.Items[i].Selected)
            {
                cnt++;
            }
        }
        if (cnt == cbl_grpheader.Items.Count)
        {
            cb_selectHeadAll.Checked = true;
        }
        else
        {
            cb_selectHeadAll.Checked = false;
        }
        string headerstr = "Group Header";
        if (rbl_headerselect.SelectedIndex == 1)
        {
            headerstr = "Header";
        }
        else if (rbl_headerselect.SelectedIndex == 2)
        {
            headerstr = "Ledger";
        }
        txt_grpheader.Text = headerstr + "(" + cnt + ")";
        lookupAmount();
    }
    protected void txt_grpHdrSrch_TextChanged(object sender, EventArgs e)
    {
        callHeadersSearch();
    }
    private void callHeadersSearch()
    {
        try
        {
            string searchkey = txt_grpHdrSrch.Text.Trim();
            cb_selectHeadAll.Checked = false;
            int cnt = 0;
            for (int key = 0; key < cbl_grpheader.Items.Count; key++)
            {
                if (searchkey == cbl_grpheader.Items[key].Text)
                {
                    cbl_grpheader.Items[key].Selected = true;
                    cnt++;
                }
                else
                {
                    cbl_grpheader.Items[key].Selected = false;
                }
            }
            string headerstr = "Group Header";
            if (rbl_headerselect.SelectedIndex == 1)
            {
                headerstr = "Header";
            }
            else if (rbl_headerselect.SelectedIndex == 2)
            {
                headerstr = "Ledger";
            }
            txt_grpheader.Text = headerstr + "(" + cnt + ")";
            headersSelected();
        }
        catch (Exception ex) { }
    }

    protected void rbl_headerselect_OnSelectedIndexChanged(object sender, EventArgs e)
    {

        //  textRoll();
        divgrid.Visible = false;
        headerSlecetionChanged();
    }

    private void headerSlecetionChanged()
    {
        try
        {
            txt_grpHdrSrch.Text = string.Empty;
            cb_selectHeadAll.Checked = false;
            cbl_grpheader.Items.Clear();
            DataSet dsHeader = new DataSet();
            string query = "";
            if (rbl_headerselect.SelectedIndex == 0)
            {
                query = " SELECT distinct G.ChlGroupHeader FROM FS_ChlGroupHeaderSettings G,FS_HeaderPrivilage P WHERE G.HeaderFK = P.HeaderFK AND P. UserCode = '" + usercode + "'  AND P.CollegeCode = " + collegecode1 + " ";

                dsHeader = d2.select_method_wo_parameter(query, "Text");
                if (dsHeader.Tables[0].Rows.Count > 0)
                {
                    cbl_grpheader.DataSource = dsHeader;
                    cbl_grpheader.DataTextField = "ChlGroupHeader";
                    cbl_grpheader.DataValueField = "ChlGroupHeader";
                    cbl_grpheader.DataBind();
                    for (int i = 0; i < cbl_grpheader.Items.Count; i++)
                    {
                        cbl_grpheader.Items[i].Selected = true;
                    }
                }
                grpHdrLdr = 0;
            }
            else if (rbl_headerselect.SelectedIndex == 1)
            {
                query = " SELECT distinct HeaderPK,HeaderName FROM FM_HeaderMaster H,FS_HeaderPrivilage P WHERE H.HeaderPK = P.HeaderFK AND P.CollegeCode = H.CollegeCode AND P. UserCode = " + usercode + " AND H.CollegeCode = " + collegecode1 + " and hd_Miscellaneous='1'  ";

                dsHeader = d2.select_method_wo_parameter(query, "Text");
                if (dsHeader.Tables[0].Rows.Count > 0)
                {
                    cbl_grpheader.DataSource = dsHeader;
                    cbl_grpheader.DataTextField = "HeaderName";
                    cbl_grpheader.DataValueField = "HeaderPK";
                    cbl_grpheader.DataBind();
                    for (int i = 0; i < cbl_grpheader.Items.Count; i++)
                    {
                        cbl_grpheader.Items[i].Selected = true;
                    }
                }
                grpHdrLdr = 1;
            }
            else if (rbl_headerselect.SelectedIndex == 2)
            {
                // query = " SELECT  LedgerPK,LedgerName,L.Priority FROM FM_LedgerMaster L,FS_LedgerPrivilage P WHERE L.LedgerPK = P.LedgerFK   AND P.CollegeCode = L.CollegeCode  and l.LedgerMode=0   AND P. UserCode = " + usercode + " AND L.CollegeCode = " + collegecode1 + " order by case when priority is null then 1 else 0 end, priority";
                query = " SELECT  LedgerPK,LedgerName,L.Priority FROM FM_HeaderMaster h, FM_LedgerMaster L,FS_LedgerPrivilage P WHERE L.LedgerPK = P.LedgerFK and h.headerpk=l.headerfk and h.collegecode=l.collegecode and h.collegecode=p.collegecode and h.headerpk=p.headerfk  AND P.CollegeCode = L.CollegeCode  and l.LedgerMode=0   AND P. UserCode = " + usercode + " AND L.CollegeCode = " + collegecode1 + " and h.hd_Miscellaneous='1' order by case when priority is null then 1 else 0 end, priority";

                dsHeader = d2.select_method_wo_parameter(query, "Text");
                if (dsHeader.Tables[0].Rows.Count > 0)
                {
                    cbl_grpheader.DataSource = dsHeader;
                    cbl_grpheader.DataTextField = "LedgerName";
                    cbl_grpheader.DataValueField = "LedgerPK";
                    cbl_grpheader.DataBind();
                    for (int i = 0; i < cbl_grpheader.Items.Count; i++)
                    {
                        cbl_grpheader.Items[i].Selected = true;
                    }
                }
                grpHdrLdr = 2;
            }
            if (cbl_grpheader.Items.Count > 0)
            {
                cb_selectHeadAll.Checked = true;
            }
            if (cbl_grpheader.Items.Count > 10)
            {
                panel_dept.Height = 300;
            }
            else
            {
                panel_dept.Height = 250;
            }
            string headerstr = "Group Header";
            if (rbl_headerselect.SelectedIndex == 1)
            {
                headerstr = "Header";
            }
            else if (rbl_headerselect.SelectedIndex == 2)
            {
                headerstr = "Ledger";
            }
            txt_grpheader.Text = headerstr + "(" + cbl_grpheader.Items.Count + ")";
            // loadGridStudent();
            imgAlert.Attributes.Add("Style", "display:none;");
            textRoll();
        }
        catch (Exception ex) { }

    }
    [System.Web.Services.WebMethod]
    [System.Web.Script.Services.ScriptMethod()]
    public static List<string> GetGrpHeader(string prefixText)
    {
        List<string> name = new List<string>();
        try
        {
            string query = "";
            WebService ws = new WebService();
            if (grpHdrLdr == 0)
            {
                query = " SELECT distinct G.ChlGroupHeader FROM FS_ChlGroupHeaderSettings G,FS_HeaderPrivilage P WHERE G.HeaderFK = P.HeaderFK AND P. UserCode = '" + usercodestat + "'  AND P.CollegeCode = " + collegecodestat + " and G.ChlGroupHeader like '" + prefixText + "%'";
            }
            else if (grpHdrLdr == 1)
            {
                query = " SELECT distinct HeaderName,HeaderPK FROM FM_HeaderMaster H,FS_HeaderPrivilage P WHERE H.HeaderPK = P.HeaderFK AND P.CollegeCode = H.CollegeCode AND P. UserCode = " + usercodestat + " AND H.CollegeCode = " + collegecodestat + " and HeaderName like '" + prefixText + "%'";
            }
            else if (grpHdrLdr == 2)
            {
                query = " SELECT  LedgerName,LedgerPK,L.Priority FROM FM_LedgerMaster L,FS_LedgerPrivilage P WHERE L.LedgerPK = P.LedgerFK   AND P.CollegeCode = L.CollegeCode  and l.LedgerMode=0   AND P. UserCode = " + usercodestat + " AND L.CollegeCode = " + collegecodestat + " and LedgerName like '" + prefixText + "%' order by case when priority is null then 1 else 0 end, priority";
            }
            name = ws.Getname(query);
            return name;
        }
        catch { return name; }
    }
    public void maintainPaymedeState()
    {
        div_cheque.Attributes.Add("style", "display:none");
        div_card.Attributes.Add("style", "display:none");
        btnAddFee.Attributes.Add("style", "display:block;float:left");
        btn_History.Attributes.Add("style", "display:block;float:left");

        if (rb_cash.Checked)
        {
            div_cheque.Attributes.Add("style", "display:none");
            div_card.Attributes.Add("style", "display:none");


        }
        else if (rb_cheque.Checked)
        {
            div_cheque.Attributes.Add("style", "display:block");
            lbl_chqno.Attributes.Add("style", "display:block");
            txt_chqno.Attributes.Add("style", "display:block");

            div_card.Attributes.Add("style", "display:none");
            lbl_ddno.Attributes.Add("style", "display:none");
            txt_ddno.Attributes.Add("style", "display:none");

            txt_ddnar.Attributes.Add("style", "display:none");
        }
        else if (rb_dd.Checked)
        {
            div_cheque.Attributes.Add("style", "display:block");
            lbl_ddno.Attributes.Add("style", "display:block");
            txt_ddno.Attributes.Add("style", "display:block");
            txt_ddnar.Attributes.Add("style", "display:block");

            div_card.Attributes.Add("style", "display:none");
            lbl_chqno.Attributes.Add("style", "display:none");
            txt_chqno.Attributes.Add("style", "display:none");

        }
        else if (rb_card.Checked)
        {
            div_cheque.Attributes.Add("style", "display:none");
            div_card.Attributes.Add("style", "display:block");
        }
    }
    protected void rb_cheque_CheckedChanged(object sender, EventArgs e)
    {
        div_cheque.Visible = true;
        //div_cash.Visible = false;       
        div_card.Visible = false;

        lbl_chqno.Visible = true;
        lbl_ddno.Visible = false;
        txt_chqno.Visible = true;
        txt_ddno.Visible = false;
        txt_ddnar.Visible = false;
        lookupAmount();
    }
    protected void rb_dd_CheckedChanged(object sender, EventArgs e)
    {
        div_cheque.Visible = true;
        //div_cash.Visible = false;   
        div_card.Visible = false;

        lbl_chqno.Visible = false;
        lbl_ddno.Visible = true;
        txt_chqno.Visible = false;
        txt_ddno.Visible = true;
        txt_ddnar.Visible = true;
        lookupAmount();

    }
    protected void rb_cash_CheckedChanged(object sender, EventArgs e)
    {
        div_cheque.Visible = false;
        div_card.Visible = false;
        //div_cash.Visible = false;       
        lookupAmount();
    }
    protected void rb_card_CheckedChanged(object sender, EventArgs e)
    {
        div_cheque.Visible = false;
        div_card.Visible = true;
        lookupAmount();
    }
    protected void cb_exfees_OnCheckedChanged(object sender, EventArgs e)
    {
    }
    protected void ddl_bkname_OnSelectedIndexChanged(object sender, EventArgs e)
    {
        if (ddl_bkname.Items.Count > 0)
        {
            if (ddl_bkname.SelectedItem.Text.ToUpper() == "OTHERS")
            {
                txt_other.Attributes.Add("style", "display:block");
            }
            else
            {
                txt_other.Attributes.Add("style", "display:none");
            }
        }
    }
    protected void gridCash_OnDataBound(object sender, EventArgs e)
    {
        for (int row = 0; row < grid_Cash.Rows.Count; row++)
        {
            if (row == grid_Cash.Rows.Count - 1)
            {
                (grid_Cash.Rows[row].FindControl("txtRs") as TextBox).Enabled = false;
            }
        }
    }
    protected void cb_sem_CheckedChanged(object sender, EventArgs e)
    {
        string name = Convert.ToString(ViewState["name"]);
        CallCheckBoxChangedEvent(cbl_sem, cb_sem, txt_sem, name);
        //loadFineFeecategory();
    }
    protected void cbl_sem_SelectedIndexChanged(object sender, EventArgs e)
    {
        string name = Convert.ToString(ViewState["name"]);
        CallCheckBoxListChangedEvent(cbl_sem, cb_sem, txt_sem, name);
        //loadFineFeecategory();
    }

    protected void ddl_sem_OnSelectedIndexChanged(object sender, EventArgs e)
    {
        loadGridStudent();
    }
    protected void txt_date1_OnTextChanged(object sender, EventArgs e)
    {
        try
        {
            string dateTime = txt_date1.Text.Split('/')[1] + "/" + txt_date1.Text.Split('/')[0] + "/" + txt_date1.Text.Split('/')[2];
            DateTime dt = DateTime.Now;
            DateTime dt2 = Convert.ToDateTime(dateTime);


            if (dt2 > dt)
            {
                txt_date1.Text = DateTime.Now.ToString("dd/MM/yyyy");

            }
        }
        catch { }
    }
    protected void btn_search_Click(object sender, EventArgs e)
    {
        try
        {
            getCollectionamount();
            div_HeaderLed.Attributes.Add("Style", "display:none;");
            divSchemeSettings.Attributes.Add("Style", "display:none;");
            if (rdo_receipt.Checked)
            {
                double partamt = 0;
                double fine = 0;
                if (Txt_amt.Text.Trim() != "")
                {
                    if (txtfine.Text.Trim() != "" && txtfine.Text.Trim() != "0")
                    {
                        fine = Convert.ToDouble(txtfine.Text.Trim());
                    }
                    partamt = Convert.ToDouble(Txt_amt.Text.Trim() + fine);
                    excessAmt = Convert.ToDouble(Txt_amt.Text.Trim() + fine);
                }
                loadGridStudent();
                headerbind();
                ledgerbind();
                grid_HeaderLedger.DataSource = null;
                grid_HeaderLedger.DataBind();
                btn_ledgersave.Visible = false;
                btn_ledgerExit.Visible = false;
            }
        }
        catch (Exception ex) { d2.sendErrorMail(ex, collegecode1, "ChallanReceipt"); }
    }
    protected void gridCash_OnRowDataBound(object sender, GridViewRowEventArgs e)
    {
        if (e.Row.RowType == DataControlRowType.DataRow)
        {
            TextBox txtsum = (TextBox)e.Row.Cells[1].FindControl("txtSum");
            txtsum.Attributes.Add("readonly", "readonly");
        }
    }


    protected void gridpaidamount()
    {
        try
        {
            double fnltolamt = 0;
            double balAmt = 0;
            foreach (GridViewRow row in grid_Details.Rows)
            {
                double tobeamt = 0;
                TextBox txttobe = (TextBox)row.Cells[1].FindControl("txt_tobepaid_amt");
                TextBox txtfee = (TextBox)row.Cells[1].FindControl("txt_fee_amt");
                TextBox txtbalamt = (TextBox)row.Cells[1].FindControl("txt_bal_amt");
                TextBox txttotamt = (TextBox)row.Cells[1].FindControl("txt_tot_amt");
                TextBox txtpaiamt = (TextBox)row.Cells[1].FindControl("txt_paid_amt");
                TextBox txtdeductamt = (TextBox)row.Cells[1].FindControl("txt_deduct_amt");
                CheckBox cbl = (CheckBox)row.Cells[1].FindControl("cb_selectLedger");
                cbl.Checked = true;
                double.TryParse(Convert.ToString(txtbalamt.Text), out tobeamt);
                txttobe.Text = Convert.ToString(tobeamt);
                txtbalamt.Text = "0";
                fnltolamt += tobeamt;
            }
            Txt_amt.Text = Convert.ToString(fnltolamt);
            double.TryParse(Convert.ToString(txt_balamt.Text), out balAmt);
            txt_balamt.Text = Convert.ToString(balAmt - fnltolamt);
        }
        catch { }
    }

    public void collegebank()
    {
        //try
        //{
        //    string queru = "SELECT DISTINCT BankName+'-'+AccNo+'-'+City as BankName,BankPk FROM FM_FinBankMaster  where CollegeCode=" + collegecode1 + "";
        //    DataSet dsBank = d2.select_method_wo_parameter(queru, "Text");
        //    ddl_collegebank.Items.Clear();

        //    if (dsBank.Tables[0].Rows.Count > 0)
        //    {
        //        ddl_collegebank.DataSource = dsBank;
        //        ddl_collegebank.DataTextField = "BankName";
        //        ddl_collegebank.DataValueField = "BankPk";
        //        ddl_collegebank.DataBind();
        //    }
        //}
        //catch (Exception ex) { }
    }
    public void bank()
    {
        try
        {
            ddl_bkname.Items.Clear();
            string queru = "select TextCode,TextVal  from textvaltable where TextCriteria = 'BName' and college_code='" + collegecode1 + "'";
            DataSet dsBank = d2.select_method_wo_parameter(queru, "Text");

            if (dsBank.Tables.Count > 0 && dsBank.Tables[0].Rows.Count > 0)
            {
                ddl_bkname.DataSource = dsBank;
                ddl_bkname.DataTextField = "TextVal";
                ddl_bkname.DataValueField = "TextCode";
                ddl_bkname.DataBind();
            }
            ddl_bkname.Items.Insert(0, "Select");
            ddl_bkname.Items.Insert(ddl_bkname.Items.Count, "Others");
        }
        catch (Exception ex) { }
    }
    public void cardType()
    {
        try
        {
            ddlCardType.Items.Clear();
            string queru = "select TextCode,TextVal  from textvaltable where TextCriteria = 'CardT'";
            DataSet dsCard = d2.select_method_wo_parameter(queru, "Text");

            if (dsCard.Tables.Count > 0 && dsCard.Tables[0].Rows.Count > 0)
            {
                ddlCardType.DataSource = dsCard;
                ddlCardType.DataTextField = "TextVal";
                ddlCardType.DataValueField = "TextCode";
                ddlCardType.DataBind();
            }
            ddlCardType.Items.Insert(0, "Select");
            ddlCardType.Items.Insert(ddlCardType.Items.Count, "Others");
        }
        catch (Exception ex) { }
    }
    public string subjectcode(string textcri, string subjename)
    {
        //for new bank
        string subjec_no = "";
        try
        {
            string select_subno = "select TextCode from textvaltable where TextCriteria='" + textcri + "' and college_code =" + collegecode1 + " and TextVal='" + subjename + "'";
            ds.Clear();
            ds = d2.select_method_wo_parameter(select_subno, "Text");
            if (ds.Tables[0].Rows.Count > 0)
            {
                subjec_no = Convert.ToString(ds.Tables[0].Rows[0]["TextCode"]);
            }
            else
            {
                string insertquery = "insert into textvaltable(TextCriteria,TextVal,college_code) values('" + textcri + "','" + subjename + "','" + collegecode1 + "')";
                int result = d2.update_method_wo_parameter(insertquery, "Text");
                if (result != 0)
                {
                    string select_subno1 = "select TextCode from textvaltable where TextCriteria='" + textcri + "' and college_code =" + collegecode1 + " and TextVal='" + subjename + "'";
                    ds.Clear();
                    ds = d2.select_method_wo_parameter(select_subno1, "Text");
                    if (ds.Tables[0].Rows.Count > 0)
                    {
                        subjec_no = Convert.ToString(ds.Tables[0].Rows[0]["TextCode"]);
                    }
                }
            }
        }
        catch (Exception ex) { }
        return subjec_no;
    }
    protected void btn_alertclose_Click(object sender, EventArgs e)
    {

        if (lbl_alert.Text == "Receipt No Not Set For All Headers")
        {
            Response.Redirect("~/FinanceMod/FinanceIndex.aspx");
        }
        imgAlert.Attributes.Add("Style", "display:none;");
    }
    //Lookup student
    protected void ddl_semrcpt_IndexChange(object sender, EventArgs e)
    {
        lookupAmount();
    }
    private void lookupAmount()
    {
        txtMultTotal.Text = "0.00";
        if (rdo_receipt.Checked && chl_MulRcpt.Checked)
        {
            try
            {
                double totRcptAmount = 0.00;
                StringBuilder sbAppNo = new StringBuilder();
                for (int i = 1; i < Fpspread1.Sheets[0].RowCount; i++)
                {
                    int checkval = Convert.ToInt32(Fpspread1.Sheets[0].Cells[i, 1].Value);
                    if (checkval == 1)
                    {
                        string appNo = Convert.ToString(Fpspread1.Sheets[0].Cells[i, 0].Tag);
                        if (sbAppNo.Length == 0)
                        {
                            sbAppNo.Append(appNo);
                        }
                        else
                        {
                            sbAppNo.Append("," + appNo);
                        }
                    }
                }
                string feecat = ddl_semrcpt.Items.Count > 0 ? ddl_semrcpt.SelectedValue : "0";
                if (sbAppNo.Length > 0)
                {
                    string selectedHdrs = GetSelectedItemsValue(cbl_grpheader);
                    string stream = "";
                    if (ddl_strm.Enabled && ddl_strm.Items.Count > 0)
                    {
                        stream = "  and s.stream in('" + ddl_strm.SelectedValue + "') ";
                    }
                    string selQ = " select SUM(isnull(TotalAmount,0)-(isnull(paidamount,0)+isnull(chltaken,0))) from FT_FeeAllot f,FS_ChlGroupHeaderSettings s  where  f.HeaderFK =s.HeaderFK and f.app_no in (" + sbAppNo.ToString() + ") and f.FeeCategory in (" + feecat + ") " + stream;
                    if (cb_selcthd.Checked)
                    {
                        if (rbl_headerselect.SelectedIndex == 0)
                        {
                            selectedHdrs = GetSelectedItemsText(cbl_grpheader);
                            selQ += "  and s.ChlGroupHeader in('" + selectedHdrs + "')";
                        }
                        else if (rbl_headerselect.SelectedIndex == 1)
                        {
                            selQ = "select SUM(isnull(TotalAmount,0)-(isnull(paidamount,0)+isnull(chltaken,0))) as Total from FT_FeeAllot f  where  App_No in (" + sbAppNo.ToString() + ") and FeeCategory in (" + feecat + ") and HeaderFK in (" + selectedHdrs + ") ";
                        }
                        else if (rbl_headerselect.SelectedIndex == 2)
                        {
                            selQ = "select SUM(isnull(TotalAmount,0)-(isnull(paidamount,0)+isnull(chltaken,0))) as Total from FT_FeeAllot f  where  App_No in (" + sbAppNo.ToString() + ") and FeeCategory in (" + feecat + ") and LedgerFK in (" + selectedHdrs + ")";
                        }
                    }
                    double.TryParse(d2.GetFunction(selQ), out totRcptAmount);
                }
                txtMultTotal.Text = totRcptAmount.ToString();
            }
            catch (Exception ex) { d2.sendErrorMail(ex, collegecode1, "ChallanReceipt"); }
        }
    }
    private double lookupAmountIndividual(string AppNo)//Not used
    {
        double totRcptAmount = 0.00;
        try
        {
            string feecat = ddl_semrcpt.Items.Count > 0 ? ddl_semrcpt.SelectedValue : "0";

            string selectedHdrs = GetSelectedItemsValue(cbl_grpheader);
            string stream = studentCollType(AppNo, false);
            if (stream != string.Empty)
            {
                stream += "  and s.stream in('" + stream + "') ";
            }
            string selQ = " select SUM(isnull(TotalAmount,0)-(isnull(paidamount,0)+isnull(chltaken,0))) from FT_FeeAllot f,FS_ChlGroupHeaderSettings s where  f.HeaderFK =s.HeaderFK and f.app_no in (" + AppNo + ") and f.FeeCategory in (" + feecat + ") " + stream;

            if (cb_selcthd.Checked)
            {
                if (rbl_headerselect.SelectedIndex == 0)
                {
                    selectedHdrs = GetSelectedItemsText(cbl_grpheader);
                    selQ += "  and s.ChlGroupHeader in('" + selectedHdrs + "')";
                }
                else if (rbl_headerselect.SelectedIndex == 1)
                {
                    selQ = "select SUM(isnull(TotalAmount,0)-(isnull(paidamount,0)+isnull(chltaken,0))) as Total from FT_FeeAllot f,Degree d,course c where a.degree_code=d.degree_code and c.course_id=d.course_id and App_No in (" + AppNo + ") and FeeCategory in (" + feecat + ") and HeaderFK in (" + selectedHdrs + ") ";
                }
                else if (rbl_headerselect.SelectedIndex == 2)
                {
                    selQ = "select SUM(isnull(TotalAmount,0)-(isnull(paidamount,0)+isnull(chltaken,0))) as Total from FT_FeeAllot f,Degree d,course c where a.degree_code=d.degree_code and c.course_id=d.course_id and App_No in (" + AppNo + ") and FeeCategory in (" + feecat + ") and LedgerFK in (" + selectedHdrs + ")";
                }
            }
            double.TryParse(d2.GetFunction(selQ), out totRcptAmount);
        }
        catch { totRcptAmount = 0.00; }
        return totRcptAmount;
    }
    protected void btn_roll_Click(object sender, EventArgs e)
    {
        trFuParNot.Visible = false;
        //if (rdo_challan.Checked && rdo_multi.Checked)
        //{
        //    trFuParNot.Visible = true;
        //}
        if (rdo_receipt.Checked && chl_MulRcpt.Checked)
        {
            trFuParNot.Visible = true;
        }
        cbPpaid.Checked = true;
        cbFpaid.Checked = true;
        cbNpaid.Checked = true;
        cbFirstGrad.Checked = false;
        popwindow.Visible = true;
        bindType();
        bindbatch1();
        binddegree2();
        bindbranch1();
        bindsec2();
        txt_rollno3.Text = "";
        //btn_go_Click(sender, e);
        btn_studOK.Visible = false;

        btn_exitstud.Visible = false;
        Fpspread1.Visible = false;
        lbl_errormsg.Visible = false;
    }
    //protected void btn_studOK_Click(object sender, EventArgs e)
    //{
    //}
    protected void btn_studOK_Click(object sender, EventArgs e)
    {
        try
        {
            txtMultTotal.Text = "0.00";
            btn_save.Visible = false;
            btn_print.Visible = false;
            string useCOdeSet = "select LinkValue from New_InsSettings where LinkName='MultipleCollegeUserRights' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "' ";
            string colleges = Convert.ToString(d2.GetFunction(useCOdeSet)).Trim();
            if (colleges == "" || colleges == "0")
            {
                colleges = collegecode1;
            }
            int smartDisp = Convert.ToInt32(d2.GetFunction("select LinkValue from New_InsSettings where LinkName='DisplayNumberForSmartCd' and user_code ='" + usercode + "' and college_code  in (" + collegecode1 + ")").Trim());
            if (Fpspread1.Sheets[0].RowCount > 0)
            {
                Fpspread1.SaveChanges();
                string rollno = "";
                string rolladmit = "";
                string degreename1 = "";
                string name1 = "";
                string degreecode1 = "";
                string regno1 = "";
                string smartno = string.Empty;

                string actrow = Fpspread1.Sheets[0].ActiveRow.ToString();
                string actcol = Fpspread1.Sheets[0].ActiveColumn.ToString();

                if ((rdo_receipt.Checked && chl_MulRcpt.Checked))
                {
                    int count = 0;
                    StringBuilder sbAppNo = new StringBuilder();
                    for (int i = 1; i < Fpspread1.Sheets[0].RowCount; i++)
                    {
                        int checkval = Convert.ToInt32(Fpspread1.Sheets[0].Cells[i, 1].Value);
                        if (checkval == 1)
                        {
                            count++;
                        }
                    }
                    if (rdo_receipt.Checked && chl_MulRcpt.Checked)
                    {
                        btn_save.Visible = true;
                        btn_print.Visible = false;
                        txt_tostudentsrcpt.Text = count.ToString();
                        lookupAmount();
                    }
                    else
                    {
                        btn_save.Visible = false;
                        btn_print.Visible = true;
                        txt_totnoofstudents.Text = count.ToString();
                    }
                    popwindow.Visible = false;
                    if (count == 0)
                    {
                        btn_save.Visible = false;
                        btn_print.Visible = false;
                    }
                }
                else
                {
                    if (actrow != "" && actcol != "" && actrow != "-1" && actcol != "-1")
                    {

                        btn_print.Visible = true;
                        btn_save.Visible = true;
                        rollno = Convert.ToString(Fpspread1.Sheets[0].Cells[Convert.ToInt32(actrow), 3].Text);
                        rolladmit = Convert.ToString(Fpspread1.Sheets[0].Cells[Convert.ToInt32(actrow), 2].Text);
                        degreename1 = Convert.ToString(Fpspread1.Sheets[0].Cells[Convert.ToInt32(actrow), 7].Text);
                        degreecode1 = Convert.ToString(Fpspread1.Sheets[0].Cells[Convert.ToInt32(actrow), 7].Tag);
                        name1 = Convert.ToString(Fpspread1.Sheets[0].Cells[Convert.ToInt32(actrow), 6].Text);
                        regno1 = Convert.ToString(Fpspread1.Sheets[0].Cells[Convert.ToInt32(actrow), 4].Text);
                        smartno = Convert.ToString(Fpspread1.Sheets[0].Cells[Convert.ToInt32(actrow), 5].Text);

                        if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 0)
                        {
                            //roll no
                            //  rollno = rollno;
                        }
                        else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 1)
                        {
                            //reg no
                            rollno = regno1;
                        }
                        else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 2)
                        {
                            //Admin no
                            rollno = rolladmit;
                        }
                        else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 4)
                        {
                            //Smartcard No

                            txt_Smartno.Text = smartno;
                            switch (smartDisp)
                            {
                                case 0:
                                    rollno = rollno;
                                    break;
                                case 1:
                                    rollno = regno1;
                                    break;
                                case 2:
                                case 3:
                                    rollno = rolladmit;
                                    break;
                            }
                        }
                        else
                        {
                            //App no
                            rollno = rolladmit;
                        }
                    }
                    Fpspread1.Sheets[0].ActiveRow = -1;
                    Fpspread1.Sheets[0].ActiveColumn = -1;
                    Fpspread1.SaveChanges();
                    if (!rdo_receipt.Checked)
                    {
                        //if (!rdo_sngle.Checked)
                        //{
                        //    for (int i = 1; i < Fpspread1.Sheets[0].RowCount; i++)
                        //    {
                        //        int checkval = Convert.ToInt32(Fpspread1.Sheets[0].Cells[i, 1].Value);
                        //        if (checkval == 1)
                        //        {
                        //            string roll_no = Convert.ToString(Fpspread1.Sheets[0].Cells[Convert.ToInt32(i), 3].Text);
                        //            string roll_admit = Convert.ToString(Fpspread1.Sheets[0].Cells[Convert.ToInt32(i), 2].Text);
                        //            string degreename = Convert.ToString(Fpspread1.Sheets[0].Cells[Convert.ToInt32(i), 7].Text);
                        //            string degreecode = Convert.ToString(Fpspread1.Sheets[0].Cells[Convert.ToInt32(i), 7].Tag);
                        //            string name = Convert.ToString(Fpspread1.Sheets[0].Cells[Convert.ToInt32(i), 6].Text);
                        //            string regno = Convert.ToString(Fpspread1.Sheets[0].Cells[Convert.ToInt32(actrow), 4].Text);

                        //            if (rollno == "")
                        //            {
                        //                rollno = Convert.ToString(roll_no);
                        //            }
                        //            else
                        //            {
                        //                rollno = rollno + "," + Convert.ToString(roll_no) + "";
                        //            }
                        //            if (rolladmit == "")
                        //            {
                        //                rolladmit = Convert.ToString(roll_admit);
                        //            }
                        //            else
                        //            {
                        //                rolladmit = rolladmit + "," + Convert.ToString(roll_admit) + "";
                        //            }
                        //            if (degreename1 == "")
                        //            {
                        //                degreename1 = Convert.ToString(degreename);
                        //            }
                        //            else
                        //            {
                        //                degreename1 = degreename1 + "," + Convert.ToString(degreename) + "";
                        //            }

                        //            if (name1 == "")
                        //            {
                        //                name1 = Convert.ToString(name);
                        //            }
                        //            else
                        //            {
                        //                name1 = name1 + "," + Convert.ToString(name) + "";
                        //            }
                        //            if (degreecode1 == "")
                        //            {
                        //                degreecode1 = Convert.ToString(degreecode);
                        //            }
                        //            else
                        //            {
                        //                degreecode1 = degreecode1 + "," + Convert.ToString(degreecode) + "";
                        //            }
                        //        }
                        //    }

                        //}
                    }


                    txt_rollno.Text = Convert.ToString(rollno);
                    if (rdo_receipt.Checked)
                    {
                        txt_rollno_Changed(sender, e);
                    }
                    else
                    {
                        //if (rdo_sngle.Checked)
                        //{
                        txt_rollno_Changed(sender, e);
                        // }
                    }
                    Session["degreecodenew"] = Convert.ToString(degreecode1);
                    popwindow.Visible = false;
                    //if (!rdo_sngle.Checked || rdo_challan.Checked)
                    //{
                    //    btn_save.Visible = false;
                    //}
                    //if (!rdo_challan.Checked || rdo_receipt.Checked)
                    //{
                    //    btn_print.Visible = false;
                    //}
                }
            }
        }
        catch (Exception ex) { d2.sendErrorMail(ex, collegecode1, "ChallanReceipt"); }
    }
    protected void btn_exitstud_Click(object sender, EventArgs e)
    {
        popwindow.Visible = false;
        rdo_receipt.Checked = true;
    }
    protected void Fpspread1_Command(object sender, FarPoint.Web.Spread.SpreadCommandEventArgs e)
    {
        try
        {
            string actrow = Fpspread1.Sheets[0].ActiveRow.ToString();
            string actcol = Fpspread1.Sheets[0].ActiveColumn.ToString();
            if (actrow.Trim() == "0" && actcol.Trim() == "1")
            {
                if (Fpspread1.Sheets[0].RowCount > 0)
                {
                    int checkval = Convert.ToInt32(Fpspread1.Sheets[0].Cells[0, 1].Value);
                    if (checkval == 0)
                    {
                        for (int i = 1; i < Fpspread1.Sheets[0].RowCount; i++)
                        {
                            Fpspread1.Sheets[0].Cells[i, 1].Value = 1;
                        }
                    }
                    if (checkval == 1)
                    {
                        for (int i = 1; i < Fpspread1.Sheets[0].RowCount; i++)
                        {
                            Fpspread1.Sheets[0].Cells[i, 1].Value = 0;
                        }
                    }
                }
            }
        }
        catch (Exception ex) { d2.sendErrorMail(ex, collegecode1, "ChallanReceipt"); }
    }
    protected void btn_gos_Click(object sender, EventArgs e)
    {
        try
        {
            string selectquery = "";
            Fpspread1.SaveChanges();
            string feecat = string.Empty;
            //if (rdo_challan.Checked && rdo_multi.Checked)
            //{
            //    if (ddl_semMultiple.Items.Count > 0)
            //    {
            //        feecat = ddl_semMultiple.SelectedItem.Value.ToString();
            //    }
            //}
            //else if (rdo_challan.Checked && !rdo_multi.Checked)
            //{
            //    if (ddl_sem.Items.Count > 0)
            //    {
            //        feecat = ddl_sem.SelectedItem.Value.ToString();
            //    }
            //}
            if (rdo_receipt.Checked && chl_MulRcpt.Checked)
            {
                if (ddl_semrcpt.Items.Count > 0)
                {
                    feecat = ddl_semrcpt.SelectedItem.Value.ToString();
                }
            }
            else if (rdo_receipt.Checked && !chl_MulRcpt.Checked)
            {
                feecat = GetSelectedItemsValueAsString(cbl_sem);
            }
            string itemheader = GetSelectedItemsValueAsString(cbl_branch1);

            string section = GetSelectedItemsValueAsString(cbl_sec2).Trim();

            string batch_year = Convert.ToString(ddl_batch1.SelectedItem.Text);

            string PaidFilter = string.Empty;
            string fgFilter = string.Empty;

            if (feecat != string.Empty)
            {
                if (cbFpaid.Checked == true)
                {
                    if (PaidFilter.Trim() == "")
                        PaidFilter = " select app_no from FT_FeeAllot where FeeCategory in ('" + feecat + "') group by App_No having sum(TotalAmount) > 0 and sum(BalAmount) =0 ";
                }
                if (cbPpaid.Checked == true)
                {
                    if (PaidFilter.Trim() == "")
                        PaidFilter = " select app_no from FT_FeeAllot where FeeCategory in ('" + feecat + "') group by App_No having sum(TotalAmount) <> sum(BalAmount) and sum(BalAmount) > 0 ";
                    else
                        PaidFilter += " union select app_no from FT_FeeAllot where FeeCategory in ('" + feecat + "') group by App_No having sum(TotalAmount) <> sum(BalAmount) and sum(BalAmount) > 0 ";
                }
                if (cbNpaid.Checked == true)
                {
                    if (PaidFilter.Trim() == "")
                        PaidFilter = "  select app_no from FT_FeeAllot where FeeCategory in ('" + feecat + "') group by App_No having sum(TotalAmount) = sum(BalAmount)  ";
                    else
                        PaidFilter += " union select app_no from FT_FeeAllot where FeeCategory in ('" + feecat + "') group by App_No having sum(TotalAmount) = sum(BalAmount)  ";
                }
                //if (cbNpaid.Checked && cbFpaid.Checked && cbPpaid.Checked)
                //{
                //}
                //else if (cbFpaid.Checked && cbNpaid.Checked)
                //{
                //    PaidFilter = " and r.App_No  in (select distinct App_No from FT_FeeAllot f where FeeCategory in (" + feecat + ") and (isnull(TotalAmount,0) =isnull(PaidAmount,0) or isnull(PaidAmount,0)=0 ) ) ";
                //}
                //else if (cbPpaid.Checked && cbNpaid.Checked)
                //{
                //    PaidFilter = " and r.App_No  in (select distinct App_No from FT_FeeAllot f where FeeCategory in (" + feecat + ") and ((isnull(TotalAmount,0) >isnull(PaidAmount,0) and isnull(TotalAmount,0)<>isnull(PaidAmount,0)) or isnull(PaidAmount,0)=0  )) ";
                //}
                //else if (cbPpaid.Checked && cbFpaid.Checked)
                //{
                //    PaidFilter = " and r.App_No  in (select distinct App_No from FT_FeeAllot f where FeeCategory in (" + feecat + ") and (isnull(TotalAmount,0) =isnull(PaidAmount,0) or (isnull(TotalAmount,0) >isnull(PaidAmount,0) and isnull(TotalAmount,0)<>isnull(PaidAmount,0)) ) ) ";
                //}
                //else if (cbNpaid.Checked)
                //{
                //    PaidFilter = " and r.App_No  in (select distinct App_No from FT_FeeAllot f where FeeCategory in (" + feecat + ") and isnull(PaidAmount,0)=0 ) ";
                //}
                //else if (cbFpaid.Checked)
                //{
                //    PaidFilter = " and r.App_No  in (select distinct App_No from FT_FeeAllot f where FeeCategory in (" + feecat + ") and isnull(TotalAmount,0) =isnull(PaidAmount,0) ) ";
                //}
                //else if (cbPpaid.Checked)
                //{
                //    PaidFilter = " and r.App_No  in (select distinct App_No from FT_FeeAllot f where FeeCategory in (" + feecat + ") and (isnull(TotalAmount,0) >isnull(PaidAmount,0) and isnull(TotalAmount,0)<>isnull(PaidAmount,0) )) ";
                //}

                if (cbFirstGrad.Checked)
                {
                    fgFilter = " and r.Appno in (SELECT distinct app_no FROM APPLYN WHERE isnull(FIRST_GRADUATE,0)=1 ) ";
                }
            }

            string strorderby = d2.GetFunction("select value from Master_Settings where settings='order_by'");
            if (strorderby == "")
            {
                strorderby = "";
            }
            else
            {
                if (strorderby == "0")
                {
                    strorderby = "ORDER BY len(r.Roll_No),r.Roll_No";
                }
                else if (strorderby == "1")
                {
                    strorderby = "ORDER BY len(r.Reg_No),r.Reg_No";
                }
                else if (strorderby == "2")
                {
                    strorderby = "ORDER BY r.Stud_Name";
                }
                else if (strorderby == "0,2")
                {
                    strorderby = "ORDER BY len(r.Roll_No),r.Roll_No,r.Stud_Name";
                }
                else
                {
                    strorderby = "";
                }
            }


            string useCOdeSet = "select LinkValue from New_InsSettings where LinkName='MultipleCollegeUserRights' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "' ";
            string colleges = Convert.ToString(d2.GetFunction(useCOdeSet)).Trim();
            if (colleges == "" || colleges == "0")
            {
                colleges = collegecode1;
            }
            int smartDisp = Convert.ToInt32(d2.GetFunction("select LinkValue from New_InsSettings where LinkName='DisplayNumberForSmartCd' and user_code ='" + usercode + "' and college_code  in (" + collegecode1 + ")").Trim());

            string app_no = "0";
            if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) != 3 || (smartDisp != 3 && Convert.ToUInt32(rbl_rollno.SelectedItem.Value) != 3))
            {

                if (txt_rollno3.Text.Trim() == "")
                {
                    string stream = "";
                    if (ddl_strm.Enabled && ddl_strm.Items.Count > 0)
                    {
                        stream = "  and c.type in('" + ddl_strm.SelectedValue + "') ";
                    }

                    selectquery = "select Roll_No,Roll_Admit,smart_serial_no,Stud_Name,d.Degree_Code,(C.Course_Name +' - '+ dt.Dept_Name) as Department,Reg_No,r.App_No,c.type   from Registration r,Degree d,Department dt,Course c where r.degree_code =d.Degree_Code and dt.Dept_Code =d.Dept_Code and c.Course_Id =d.Course_Id and CC=0 and DelFlag =0 and Exam_Flag <>'DEBAR' and Batch_Year =" + batch_year + " and r.degree_code in ('" + itemheader + "')  and isnull(r.Sections,'') in ('" + section.Trim() + "','') " + stream + "  and r.college_code='" + collegecode1 + "' ";
                    if (PaidFilter.Trim() != "")
                    {
                        selectquery += " and r.app_no in(" + PaidFilter + ")";
                    }
                    selectquery += fgFilter;
                    //selectquery += strorderby;
                }
                else
                {
                    selectquery = "select Roll_No,Roll_Admit,smart_serial_no,Stud_Name,d.Degree_Code,(C.Course_Name +' - '+ dt.Dept_Name) as Department,Reg_No,r.App_No,c.type   from Registration r,Degree d,Department dt,Course c where r.degree_code =d.Degree_Code and dt.Dept_Code =d.Dept_Code and c.Course_Id =d.Course_Id and CC=0 and DelFlag =0 and Exam_Flag <>'DEBAR'  and r.college_code='" + collegecode1 + "'  ";


                    if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 0)
                    {
                        //roll no
                        selectquery += "   and Roll_No ='" + txt_rollno3.Text.Trim() + "' ";
                        app_no = d2.GetFunction("select app_no from registration where roll_no='" + txt_rollno3.Text.Trim() + "'  and college_code='" + collegecode1 + "' ");
                    }
                    else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 1)
                    {
                        //reg no
                        selectquery += "  and Reg_No = '" + txt_rollno3.Text.Trim() + "' ";
                        app_no = d2.GetFunction("select app_no from registration where reg_no='" + txt_rollno3.Text.Trim() + "'  and college_code='" + collegecode1 + "' ");
                    }
                    else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 2)
                    {
                        //Admin no
                        selectquery += " and Roll_admit = '" + txt_rollno3.Text.Trim() + "' ";
                        app_no = d2.GetFunction("select app_no from registration where roll_admit='" + txt_rollno3.Text.Trim() + "'  and college_code='" + collegecode1 + "' ");
                    }
                    else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 4)
                    {
                        //Smart card no

                        switch (smartDisp)
                        {
                            case 0:
                                selectquery += "   and Roll_No ='" + txt_rollno3.Text.Trim() + "' ";
                                app_no = d2.GetFunction("select app_no from registration where roll_no='" + txt_rollno3.Text.Trim() + "'  and college_code='" + collegecode1 + "' ");
                                break;
                            case 1:
                                selectquery += "  and Reg_No = '" + txt_rollno3.Text.Trim() + "' ";
                                app_no = d2.GetFunction("select app_no from registration where reg_no='" + txt_rollno3.Text.Trim() + "'  and college_code='" + collegecode1 + "' ");
                                break;
                            case 2:
                                selectquery += " and Roll_admit = '" + txt_rollno3.Text.Trim() + "' ";
                                app_no = d2.GetFunction("select app_no from registration where roll_admit='" + txt_rollno3.Text.Trim() + "'  and college_code='" + collegecode1 + "' ");
                                break;
                        }
                        //  selectquery += " and smart_serial_no = '" + txt_rollno3.Text + "' ";
                    }
                    selectquery += strorderby;
                }
                if (txt_rollno3.Text.Trim() == "")
                {
                    string selQ = " select SUM(isnull(TotalAmount,0)-(isnull(paidamount,0)+isnull(chltaken,0))),r.App_No from FT_FeeAllot f, Registration r, FS_ChlGroupHeaderSettings s,FS_HeaderPrivilage P where f.HeaderFK =p.Headerfk and p.Headerfk=s.HeaderFK and f.HeaderFK =s.HeaderFK  and f.FeeCategory in ('" + feecat + "') and f.App_No =r.App_No and r.degree_code in ('" + itemheader + "') and r.Batch_Year  in (" + batch_year + ") and isnull(r.Sections,'') in ('" + section.Trim() + "','')  and r.college_code='" + collegecode1 + "' and p.usercode='" + usercode + "' ";

                    if (ddl_strm.Enabled && ddl_strm.Items.Count > 0)
                    {
                        selQ += "  and s.stream in('" + ddl_strm.SelectedValue + "') ";
                    }

                    if (cb_selcthd.Checked)
                    {
                        string selectedHdrs = GetSelectedItemsValue(cbl_grpheader);
                        if (rbl_headerselect.SelectedIndex == 0)
                        {
                            selectedHdrs = GetSelectedItemsText(cbl_grpheader);
                            selQ += "  and s.ChlGroupHeader in('" + selectedHdrs + "') ";
                        }
                        else if (rbl_headerselect.SelectedIndex == 1)
                        {
                            selQ = " select SUM(isnull(TotalAmount,0)-(isnull(paidamount,0)+isnull(chltaken,0))),r.App_No from FT_FeeAllot f, Registration r where f.FeeCategory in ('" + feecat + "') and f.App_No =r.App_No and r.degree_code in ('" + itemheader + "') and r.Batch_Year  in (" + batch_year + ") and isnull(r.Sections,'') in ('" + section.Trim() + "','')  and f.HeaderFK in (" + selectedHdrs + ")  and r.college_code='" + collegecode1 + "' ";
                        }
                        else if (rbl_headerselect.SelectedIndex == 2)
                        {
                            selQ = " select SUM(isnull(TotalAmount,0)-(isnull(paidamount,0)+isnull(chltaken,0))),r.App_No from FT_FeeAllot f, Registration r where f.FeeCategory in ('" + feecat + "') and f.App_No =r.App_No and r.degree_code in ('" + itemheader + "') and r.Batch_Year  in (" + batch_year + ") and isnull(r.Sections,'') in ('" + section.Trim() + "','')  and f.LedgerFK in (" + selectedHdrs + ")  and r.college_code='" + collegecode1 + "' ";
                        }
                    }
                    selQ += "  group by r.App_No ";
                    selectquery += selQ;
                }
                else
                {
                    string selQ = " select SUM(isnull(TotalAmount,0)-(isnull(paidamount,0)+isnull(chltaken,0))),r.App_No from FT_FeeAllot f, Registration r, FS_ChlGroupHeaderSettings s,FS_HeaderPrivilage P where p.HeaderFK =s.HeaderFK and f.HeaderFK =p.HeaderFK  and f.HeaderFK =s.HeaderFK  and f.FeeCategory in ('" + feecat + "') and f.App_No =r.App_No  and r.App_No ='" + app_no + "' and p.usercode='" + usercode + "' ";
                    string type = studentCollType(app_no, true);
                    if (type != string.Empty)
                    {
                        selQ += "  and s.stream in('" + type + "') ";
                    }

                    if (cb_selcthd.Checked)
                    {
                        string selectedHdrs = GetSelectedItemsValue(cbl_grpheader);
                        if (rbl_headerselect.SelectedIndex == 0)
                        {
                            selectedHdrs = GetSelectedItemsText(cbl_grpheader);
                            selQ += "  and s.ChlGroupHeader in('" + selectedHdrs + "') ";
                        }
                        else if (rbl_headerselect.SelectedIndex == 1)
                        {
                            selQ = " select SUM(isnull(TotalAmount,0)-(isnull(paidamount,0)+isnull(chltaken,0))),r.App_No from FT_FeeAllot f, Registration r where f.FeeCategory in ('" + feecat + "')  and f.HeaderFK in (" + selectedHdrs + ")  and f.App_No =r.App_No  and r.App_No ='" + app_no + "'  ";
                        }
                        else if (rbl_headerselect.SelectedIndex == 2)
                        {
                            selQ = " select SUM(isnull(TotalAmount,0)-(isnull(paidamount,0)+isnull(chltaken,0))),r.App_No from FT_FeeAllot f, Registration r where f.FeeCategory in ('" + feecat + "')  and f.LedgerFK in (" + selectedHdrs + ")  and f.App_No =r.App_No and r.App_No ='" + app_no + "' ";
                        }
                    }
                    selQ += "  group by r.App_No ";
                    selectquery += selQ;
                }

            }
            else
            {
                byte studAppSHrtAdm = StudentAppliedShorlistAdmit();
                string admStudFilter = "";
                string admStudFilTer = "";
                switch (studAppSHrtAdm)
                {
                    case 0:
                        admStudFilter = " and r.isconfirm=1  and isnull(r.selection_status,'0')='0' and isnull(r.admission_status,'0')='0'  and r.app_no not in (select app_no from registration where Degree_Code in('" + itemheader + "')  and batch_year in('" + batch_year + "'))";
                        admStudFilTer = " and r.isconfirm=1  and isnull(r.selection_status,'0')='0' and isnull(r.admission_status,'0')='0' ";
                        break;
                    case 1:
                        admStudFilter = " and r.isconfirm=1 and isnull(r.selection_status,'0')='1' and isnull(r.admission_status,'0')='0'  and r.app_no not in (select app_no from registration where Degree_Code in('" + itemheader + "')  and batch_year in('" + batch_year + "'))";
                        admStudFilTer = " and r.isconfirm=1 and isnull(r.selection_status,'0')='1' and isnull(r.admission_status,'0')='0' ";

                        break;
                    case 2:
                        admStudFilter = " and r.isconfirm=1 and isnull(r.selection_status,'0')='1' and isnull(r.admission_status,'0')='1' and r.app_no not in (select app_no from registration where Degree_Code in('" + itemheader + "')  and batch_year in('" + batch_year + "'))";
                        admStudFilTer = " and r.isconfirm=1 and isnull(r.selection_status,'0')='1' and isnull(r.admission_status,'0')='1' ";
                        break;
                }
                if (txt_rollno3.Text.Trim() == "")
                {
                    string stream = "";
                    if (ddl_strm.Enabled && ddl_strm.Items.Count > 0)
                    {
                        stream = "  and c.type in('" + ddl_strm.SelectedValue + "') ";
                    }

                    selectquery = "  select r.app_formno as  Roll_No,r.app_formno as smart_serial_no,r.app_formno as Roll_Admit,Stud_Name,d.Degree_Code ,(C.Course_Name +' - '+ dt.Dept_Name) as Department,r.app_formno as Reg_No ,r.app_formno,r.App_No,c.type   from applyn r,Degree d,Department dt,Course c where r.degree_code =d.Degree_Code and dt.Dept_Code =d.Dept_Code and c.Course_Id =d.Course_Id   and Batch_Year =" + batch_year + " and r.degree_code in ('" + itemheader + "' ) " + stream + " " + fgFilter + "  " + admStudFilter + "  and r.college_code='" + collegecode1 + "'";
                    if (PaidFilter.Trim() != "")
                    {
                        selectquery += " and r.app_no in(" + PaidFilter + ")";
                    }
                    selectquery = selectquery + " order by Roll_No,d.Degree_Code ";
                }
                else
                {
                    //App no
                    selectquery = "select r.app_formno as  Roll_No,r.app_formno as smart_serial_no,r.app_formno as Roll_Admit,Stud_Name,d.Degree_Code ,(C.Course_Name +' - '+ dt.Dept_Name) as Department,r.app_formno as Reg_No ,r.app_formno,r.App_No,c.type   from applyn r,Degree d,Department dt,Course c where r.degree_code =d.Degree_Code and dt.Dept_Code =d.Dept_Code and c.Course_Id =d.Course_Id   " + admStudFilter + "  and r.college_code='" + collegecode1 + "'  and r.app_formno ='" + txt_rollno3.Text + "'  ";
                    app_no = d2.GetFunction("select app_no from registration where roll_admit='" + txt_rollno3.Text.Trim() + "'  and college_code='" + collegecode1 + "' ");
                }
                if (txt_rollno3.Text.Trim() == "")
                {
                    string addChalAMt = "";
                    //if (rdo_challan.Checked)
                    //{
                    //    addChalAMt = "+isnull(chltaken,0)";
                    //}
                    string selQ = " select SUM(isnull(TotalAmount,0)-(isnull(paidamount,0)" + addChalAMt + ")),r.App_No from FT_FeeAllot f, applyn r, FS_ChlGroupHeaderSettings s,FS_HeaderPrivilage P where p.HeaderFK =s.HeaderFK and f.HeaderFK =p.HeaderFK    and f.HeaderFK =s.HeaderFK  and f.FeeCategory in ('" + feecat + "') and f.App_No =r.App_No   " + admStudFilTer + "  and r.degree_code in ('" + itemheader + "' ) and r.Batch_Year  in (" + batch_year + ") and p.usercode='" + usercode + "' ";//and isnull(r.Sections,'') in ('" + section.Trim() + "')

                    if (ddl_strm.Enabled && ddl_strm.Items.Count > 0)
                    {
                        selQ += "  and s.stream in('" + ddl_strm.SelectedValue + "') ";
                    }

                    if (cb_selcthd.Checked)
                    {
                        string selectedHdrs = GetSelectedItemsValue(cbl_grpheader);
                        if (rbl_headerselect.SelectedIndex == 0)
                        {
                            selectedHdrs = GetSelectedItemsText(cbl_grpheader);
                            selQ += "  and s.ChlGroupHeader in('" + selectedHdrs + "') ";
                        }
                        else if (rbl_headerselect.SelectedIndex == 1)
                        {
                            selQ = " select SUM(isnull(TotalAmount,0)-(isnull(paidamount,0)" + addChalAMt + ")),r.App_No from FT_FeeAllot f, applyn r where    f.FeeCategory in ('" + feecat + "') and f.App_No =r.App_No and r.degree_code in ('" + itemheader + "' ) and r.Batch_Year  in (" + batch_year + ")  and f.HeaderFK in (" + selectedHdrs + ")  " + admStudFilTer + " ";//and isnull(r.Sections,'') in ('" + section.Trim() + "') 
                        }
                        else if (rbl_headerselect.SelectedIndex == 2)
                        {
                            selQ = " select SUM(isnull(TotalAmount,0)-(isnull(paidamount,0)" + addChalAMt + ")),r.App_No from FT_FeeAllot f, applyn r where    f.FeeCategory in ('" + feecat + "') and f.App_No =r.App_No and r.degree_code in ('" + itemheader + "' ) and r.Batch_Year  in (" + batch_year + ")   and f.LedgerFK in (" + selectedHdrs + ")  " + admStudFilTer + " ";//and isnull(r.Sections,'') in ('" + section.Trim() + "')
                        }
                    }
                    selQ += "  group by r.App_No ";
                    selectquery += selQ;
                }
                else
                {
                    string addChalAMt = "";
                    //if (rdo_challan.Checked)
                    //{
                    //    addChalAMt = "+isnull(chltaken,0)";
                    //}
                    string selQ = " select SUM(isnull(TotalAmount,0)-(isnull(paidamount,0)" + addChalAMt + ")),r.App_No from FT_FeeAllot f, applyn r, FS_ChlGroupHeaderSettings s,FS_HeaderPrivilage P where f.HeaderFK =p.HeaderFK and p.HeaderFK =s.HeaderFK and  f.HeaderFK =s.HeaderFK  and f.FeeCategory in ('" + feecat + "') and f.App_No =r.App_No  and r.App_No ='" + app_no + "'  " + admStudFilTer + "  and p.userCode='" + usercode + "'  ";//and isnull(r.Sections,'') in ('" + section.Trim() + "')

                    string type = studentCollType(app_no, false);
                    if (type != string.Empty)
                    {
                        selQ += "  and s.stream in('" + type + "') ";
                    }
                    if (cb_selcthd.Checked)
                    {
                        string selectedHdrs = GetSelectedItemsValue(cbl_grpheader);
                        if (rbl_headerselect.SelectedIndex == 0)
                        {
                            selectedHdrs = GetSelectedItemsText(cbl_grpheader);
                            selQ += "  and s.ChlGroupHeader in('" + selectedHdrs + "') ";
                        }
                        else if (rbl_headerselect.SelectedIndex == 1)
                        {
                            selQ = " select SUM(isnull(TotalAmount,0)-(isnull(paidamount,0)" + addChalAMt + ")),r.App_No from FT_FeeAllot f, applyn r where    f.FeeCategory in ('" + feecat + "')   and f.HeaderFK in (" + selectedHdrs + ")   and f.App_No =r.App_No  and r.App_No ='" + app_no + "'    " + admStudFilTer + " ";//and isnull(r.Sections,'') in ('" + section.Trim() + "') 
                        }
                        else if (rbl_headerselect.SelectedIndex == 2)
                        {
                            selQ = " select SUM(isnull(TotalAmount,0)-(isnull(paidamount,0)" + addChalAMt + ")),r.App_No from FT_FeeAllot f, applyn r where    f.FeeCategory in ('" + feecat + "')   and f.LedgerFK in (" + selectedHdrs + ")  and f.App_No =r.App_No and r.App_No ='" + app_no + "'  " + admStudFilTer + " ";//and isnull(r.Sections,'') in ('" + section.Trim() + "')
                        }
                    }
                    selQ += "  group by r.App_No ";
                    selectquery += selQ;
                }
            }
            ds.Clear();
            ds = d2.select_method_wo_parameter(selectquery, "Text");
            if (ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
            {
                Fpspread1.Sheets[0].RowCount = 1;
                Fpspread1.Sheets[0].ColumnCount = 0;
                Fpspread1.Sheets[0].ColumnHeader.RowCount = 1;
                Fpspread1.CommandBar.Visible = false;
                Fpspread1.Sheets[0].ColumnCount = 9;

                Fpspread1.Sheets[0].RowHeader.Visible = false;
                Fpspread1.Sheets[0].AutoPostBack = false;


                FarPoint.Web.Spread.StyleInfo darkstyle = new FarPoint.Web.Spread.StyleInfo();
                darkstyle.BackColor = ColorTranslator.FromHtml("#0CA6CA");
                darkstyle.ForeColor = Color.White;
                Fpspread1.ActiveSheetView.ColumnHeader.DefaultStyle = darkstyle;

                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 0].Text = " S.No";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 0].Font.Bold = true;
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 0].Font.Name = "Book Antiqua";
                Fpspread1.Sheets[0].Columns[0].Locked = true;
                Fpspread1.Columns[0].Width = 50;

                FarPoint.Web.Spread.CheckBoxCellType chkall = new FarPoint.Web.Spread.CheckBoxCellType();
                chkall.AutoPostBack = true;

                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 1].Text = "Select";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 1].Font.Bold = true;
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 1].Font.Name = "Book Antiqua";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 1].HorizontalAlign = HorizontalAlign.Center;
                Fpspread1.Columns[1].Width = 80;
                Fpspread1.Sheets[0].Columns[1].Locked = false;
                if (rdo_receipt.Checked && chl_MulRcpt.Checked)
                {
                    Fpspread1.Sheets[0].Columns[1].Visible = true;
                }
                else if (rdo_receipt.Checked)
                {
                    Fpspread1.Sheets[0].Columns[1].Visible = false;
                }
                //else if ((rdo_multi.Checked && rdo_challan.Checked))
                //{
                //    Fpspread1.Sheets[0].Columns[1].Visible = true;
                //}

                Fpspread1.Sheets[0].Cells[0, 1].CellType = chkall;
                Fpspread1.Sheets[0].Cells[0, 1].HorizontalAlign = HorizontalAlign.Center;

                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 2].Text = "Admission No";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 2].HorizontalAlign = HorizontalAlign.Center;
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 2].Font.Bold = true;
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 2].Font.Name = "Book Antiqua";

                Fpspread1.Sheets[0].Columns[2].Locked = true;
                Fpspread1.Columns[2].Width = 130;

                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 3].Text = "Roll No";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 3].Font.Bold = true;
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 3].Font.Name = "Book Antiqua";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 3].HorizontalAlign = HorizontalAlign.Center;
                Fpspread1.Sheets[0].Columns[3].Locked = true;
                Fpspread1.Columns[3].Width = 100;

                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 4].Text = "Reg No";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 4].Font.Bold = true;
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 4].Font.Name = "Book Antiqua";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 4].HorizontalAlign = HorizontalAlign.Center;
                Fpspread1.Sheets[0].Columns[4].Locked = true;
                Fpspread1.Columns[4].Width = 100;

                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 5].Text = "Smartcard No";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 5].Font.Bold = true;
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 5].Font.Name = "Book Antiqua";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 5].HorizontalAlign = HorizontalAlign.Center;
                Fpspread1.Sheets[0].Columns[5].Locked = true;
                Fpspread1.Columns[5].Width = 100;

                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 6].Text = "Name";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 6].Font.Bold = true;
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 6].Font.Name = "Book Antiqua";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 6].HorizontalAlign = HorizontalAlign.Center;
                Fpspread1.Sheets[0].Columns[6].Locked = true;
                Fpspread1.Columns[6].Width = 200;

                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 7].Text = "Degree";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 7].Font.Bold = true;
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 7].Font.Name = "Book Antiqua";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 7].HorizontalAlign = HorizontalAlign.Center;
                Fpspread1.Sheets[0].Columns[7].Locked = true;
                Fpspread1.Sheets[0].Columns[7].VerticalAlign = VerticalAlign.Middle;
                Fpspread1.Sheets[0].SetColumnMerge(7, FarPoint.Web.Spread.Model.MergePolicy.Always);
                Fpspread1.Columns[7].Width = 270;

                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 8].Text = "Balance Rs";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 8].Font.Bold = true;
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 8].Font.Name = "Book Antiqua";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 8].HorizontalAlign = HorizontalAlign.Right;
                Fpspread1.Sheets[0].Columns[8].Locked = true;
                Fpspread1.Sheets[0].Columns[8].VerticalAlign = VerticalAlign.Middle;
                Fpspread1.Columns[8].Width = 100;

                FarPoint.Web.Spread.TextCellType txtRollno = new FarPoint.Web.Spread.TextCellType();
                FarPoint.Web.Spread.TextCellType txtRegno = new FarPoint.Web.Spread.TextCellType();
                FarPoint.Web.Spread.TextCellType txtRollAd = new FarPoint.Web.Spread.TextCellType();
                FarPoint.Web.Spread.TextCellType txtAppno = new FarPoint.Web.Spread.TextCellType();
                FarPoint.Web.Spread.TextCellType txtSmartno = new FarPoint.Web.Spread.TextCellType();

                if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 0)
                {
                    //roll no
                    Fpspread1.Sheets[0].Columns[3].Visible = true;
                    Fpspread1.Sheets[0].Columns[4].Visible = false;
                    Fpspread1.Sheets[0].Columns[2].Visible = false;
                    Fpspread1.Sheets[0].Columns[5].Visible = false;
                }
                else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 1)
                {
                    //reg no
                    Fpspread1.Sheets[0].Columns[4].Visible = true;
                    Fpspread1.Sheets[0].Columns[3].Visible = false;
                    Fpspread1.Sheets[0].Columns[2].Visible = false;
                    Fpspread1.Sheets[0].Columns[5].Visible = false;
                }
                else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 2)
                {
                    //Admin no
                    Fpspread1.Sheets[0].Columns[2].Visible = true;
                    Fpspread1.Sheets[0].Columns[4].Visible = false;
                    Fpspread1.Sheets[0].Columns[3].Visible = false;
                    Fpspread1.Sheets[0].Columns[5].Visible = false;
                }
                else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 4)
                {
                    //Smartcard no
                    Fpspread1.Sheets[0].Columns[5].Visible = false;
                    Fpspread1.Sheets[0].Columns[2].Visible = false;
                    Fpspread1.Sheets[0].Columns[4].Visible = false;
                    Fpspread1.Sheets[0].Columns[3].Visible = false;
                    if (smartDisp == 0)
                        Fpspread1.Sheets[0].Columns[3].Visible = true;
                    else if (smartDisp == 1)
                        Fpspread1.Sheets[0].Columns[4].Visible = true;
                    else if (smartDisp == 2 || smartDisp == 3)
                        Fpspread1.Sheets[0].Columns[2].Visible = true;
                }
                else
                {
                    //App no
                    Fpspread1.Sheets[0].ColumnHeader.Cells[0, 2].Text = "App No";
                    Fpspread1.Sheets[0].Columns[2].Visible = true;
                    Fpspread1.Sheets[0].Columns[4].Visible = false;
                    Fpspread1.Sheets[0].Columns[3].Visible = false;
                    Fpspread1.Sheets[0].Columns[5].Visible = false;
                }

                for (int row = 0; row < ds.Tables[0].Rows.Count; row++)
                {

                    Fpspread1.Sheets[0].RowCount++;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 0].Text = Convert.ToString(row + 1);
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 0].Tag = Convert.ToString(ds.Tables[0].Rows[row]["App_No"]);
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 0].HorizontalAlign = HorizontalAlign.Center;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 0].Font.Size = FontUnit.Medium;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 0].Font.Name = "Book Antiqua";
                    //
                    FarPoint.Web.Spread.CheckBoxCellType check = new FarPoint.Web.Spread.CheckBoxCellType();
                    check.AutoPostBack = false;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 1].CellType = check;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 1].HorizontalAlign = HorizontalAlign.Center;

                    //
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 2].CellType = txtRollAd;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 2].Text = Convert.ToString(ds.Tables[0].Rows[row]["Roll_Admit"]);
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 2].HorizontalAlign = HorizontalAlign.Left;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 2].Font.Size = FontUnit.Medium;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 2].Font.Name = "Book Antiqua";

                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 3].CellType = txtRollno;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 3].Text = Convert.ToString(ds.Tables[0].Rows[row]["Roll_No"]);
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 3].HorizontalAlign = HorizontalAlign.Left;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 3].Font.Size = FontUnit.Medium;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 3].Font.Name = "Book Antiqua";

                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 4].CellType = txtRegno;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 4].Text = Convert.ToString(ds.Tables[0].Rows[row]["Reg_No"]);
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 4].HorizontalAlign = HorizontalAlign.Left;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 4].Font.Size = FontUnit.Medium;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 4].Font.Name = "Book Antiqua";

                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 5].CellType = txtSmartno;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 5].Text = Convert.ToString(ds.Tables[0].Rows[row]["smart_serial_no"]);
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 5].HorizontalAlign = HorizontalAlign.Left;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 5].Font.Size = FontUnit.Medium;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 5].Font.Name = "Book Antiqua";

                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 6].Text = Convert.ToString(ds.Tables[0].Rows[row]["Stud_Name"]);
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 6].HorizontalAlign = HorizontalAlign.Left;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 6].Font.Size = FontUnit.Medium;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 6].Font.Name = "Book Antiqua";

                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 7].Tag = Convert.ToString(ds.Tables[0].Rows[row]["Degree_Code"]);
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 7].Text = Convert.ToString(ds.Tables[0].Rows[row]["Department"]);
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 7].HorizontalAlign = HorizontalAlign.Left;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 7].Font.Size = FontUnit.Medium;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 7].Font.Name = "Book Antiqua";

                    double amt = 0.00;
                    if (ds.Tables.Count > 1)
                    {
                        if (ds.Tables[1].Rows.Count > 0)
                        {
                            string appno = Convert.ToString(ds.Tables[0].Rows[row]["App_No"]);
                            ds.Tables[1].DefaultView.RowFilter = " app_no=" + appno;
                            DataView dvAmt = new DataView();
                            dvAmt = ds.Tables[1].DefaultView;
                            if (dvAmt.Count > 0)
                            {
                                double.TryParse(dvAmt[0][0].ToString(), out amt);
                            }
                        }
                    }

                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 8].Text = amt.ToString(); //lookupAmountIndividual().ToString();
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 8].HorizontalAlign = HorizontalAlign.Right;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 8].Font.Size = FontUnit.Medium;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 8].Font.Name = "Book Antiqua";
                }
                Fpspread1.Visible = true;
                Fpspread1.Sheets[0].PageSize = Fpspread1.Sheets[0].RowCount;
                Fpspread1.Sheets[0].SpanModel.Add(0, 2, 1, 4);
                Fpspread1.Sheets[0].FrozenRowCount = 1;

                Fpspread1.SaveChanges();

                btn_studOK.Visible = true;
                btn_exitstud.Visible = true;
            }
            else
            {
                Fpspread1.Visible = false;
                lbl_errormsg.Visible = true;
                lbl_errormsg.Text = "No Records Found";
                btn_studOK.Visible = false;
                btn_exitstud.Visible = false;
            }

        }
        catch (Exception ex) { d2.sendErrorMail(ex, collegecode1, "ChallanReceipt"); }
    }
    protected void btn_go_Click(object sender, EventArgs e)
    {
        try
        {
            string selectquery = "";
            Fpspread1.SaveChanges();
            string batch_year = Convert.ToString(ddl_batch1.SelectedItem.Text);
            string itemheader = GetSelectedItemsValueAsString(cbl_branch1);
            string section = GetSelectedItemsValueAsString(cbl_sec2).Trim();
            string stream = "";
            if (ddl_strm.Enabled && ddl_strm.Items.Count > 0)
            {
                stream = "  and c.type in('" + ddl_strm.SelectedValue + "') ";
            }
            string strorderby = d2.GetFunction("select value from Master_Settings where settings='order_by'");
            if (!string.IsNullOrEmpty(strorderby))
            {
                if (strorderby == "0")
                    strorderby = "ORDER BY len(r.Roll_No),r.Roll_No";
                else if (strorderby == "1")
                    strorderby = "ORDER BY len(r.Reg_No),r.Reg_No";
                else if (strorderby == "2")
                    strorderby = "ORDER BY r.Stud_Name";
                else if (strorderby == "0,2")
                    strorderby = "ORDER BY len(r.Roll_No),r.Roll_No,r.Stud_Name";
                else
                    strorderby = "";
            }

            string useCOdeSet = "select LinkValue from New_InsSettings where LinkName='MultipleCollegeUserRights' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "' ";
            string colleges = Convert.ToString(d2.GetFunction(useCOdeSet)).Trim();
            if (colleges == "" || colleges == "0")
            {
                colleges = collegecode1;
            }
            int smartDisp = Convert.ToInt32(d2.GetFunction("select LinkValue from New_InsSettings where LinkName='DisplayNumberForSmartCd' and user_code ='" + usercode + "' and college_code  in (" + collegecode1 + ")").Trim());

            string app_no = "0";
            if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) != 3 || (smartDisp != 3 && Convert.ToUInt32(rbl_rollno.SelectedItem.Value) != 3))
            {

                if (txt_rollno3.Text.Trim() == "")
                {

                    selectquery = "select Roll_No,Roll_Admit,smart_serial_no,Stud_Name,d.Degree_Code,(C.Course_Name +' - '+ dt.Dept_Name) as Department,Reg_No,r.App_No,c.type   from Registration r,Degree d,Department dt,Course c where r.degree_code =d.Degree_Code and dt.Dept_Code =d.Dept_Code and c.Course_Id =d.Course_Id and CC=0 and DelFlag =0 and Exam_Flag <>'DEBAR' and Batch_Year =" + batch_year + " and r.degree_code in ('" + itemheader + "') and isnull(r.sections,'') in('" + section + "','')" + stream + "  and r.college_code='" + collegecode1 + "' ";

                }
                else
                {
                    selectquery = "select Roll_No,Roll_Admit,smart_serial_no,Stud_Name,d.Degree_Code,(C.Course_Name +' - '+ dt.Dept_Name) as Department,Reg_No,r.App_No,c.type   from Registration r,Degree d,Department dt,Course c where r.degree_code =d.Degree_Code and dt.Dept_Code =d.Dept_Code and c.Course_Id =d.Course_Id and CC=0 and DelFlag =0 and Exam_Flag <>'DEBAR'  and r.college_code='" + collegecode1 + "'  ";

                    if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 0)
                    {
                        //roll no
                        selectquery += "   and Roll_No ='" + txt_rollno3.Text.Trim() + "' ";
                        app_no = d2.GetFunction("select app_no from registration where roll_no='" + txt_rollno3.Text.Trim() + "'  and college_code='" + collegecode1 + "' ");
                    }
                    else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 1)
                    {
                        //reg no
                        selectquery += "  and Reg_No = '" + txt_rollno3.Text.Trim() + "' ";
                        app_no = d2.GetFunction("select app_no from registration where reg_no='" + txt_rollno3.Text.Trim() + "'  and college_code='" + collegecode1 + "' ");
                    }
                    else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 2)
                    {
                        //Admin no
                        selectquery += " and Roll_admit = '" + txt_rollno3.Text.Trim() + "' ";
                        app_no = d2.GetFunction("select app_no from registration where roll_admit='" + txt_rollno3.Text.Trim() + "'  and college_code='" + collegecode1 + "' ");
                    }
                    else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 4)
                    {
                        //Smart card no

                        switch (smartDisp)
                        {
                            case 0:
                                selectquery += "   and Roll_No ='" + txt_rollno3.Text.Trim() + "' ";
                                app_no = d2.GetFunction("select app_no from registration where roll_no='" + txt_rollno3.Text.Trim() + "'  and college_code='" + collegecode1 + "' ");
                                break;
                            case 1:
                                selectquery += "  and Reg_No = '" + txt_rollno3.Text.Trim() + "' ";
                                app_no = d2.GetFunction("select app_no from registration where reg_no='" + txt_rollno3.Text.Trim() + "'  and college_code='" + collegecode1 + "' ");
                                break;
                            case 2:
                                selectquery += " and Roll_admit = '" + txt_rollno3.Text.Trim() + "' ";
                                app_no = d2.GetFunction("select app_no from registration where roll_admit='" + txt_rollno3.Text.Trim() + "'  and college_code='" + collegecode1 + "' ");
                                break;
                        }
                        //  selectquery += " and smart_serial_no = '" + txt_rollno3.Text + "' ";
                    }
                    selectquery += strorderby;
                }

            }
            else
            {
                byte studAppSHrtAdm = StudentAppliedShorlistAdmit();
                string admStudFilter = "";
                string admStudFilTer = "";
                switch (studAppSHrtAdm)
                {
                    case 0:
                        admStudFilter = " and r.isconfirm=1  and isnull(r.selection_status,'0')='0' and isnull(r.admission_status,'0')='0'  and r.app_no not in (select app_no from registration where Degree_Code in('" + itemheader + "')  and batch_year in('" + batch_year + "'))";
                        admStudFilTer = " and r.isconfirm=1  and isnull(r.selection_status,'0')='0' and isnull(r.admission_status,'0')='0' ";
                        break;
                    case 1:
                        admStudFilter = " and r.isconfirm=1 and isnull(r.selection_status,'0')='1' and isnull(r.admission_status,'0')='0'  and r.app_no not in (select app_no from registration where Degree_Code in('" + itemheader + "')  and batch_year in('" + batch_year + "'))";
                        admStudFilTer = " and r.isconfirm=1 and isnull(r.selection_status,'0')='1' and isnull(r.admission_status,'0')='0' ";

                        break;
                    case 2:
                        admStudFilter = " and r.isconfirm=1 and isnull(r.selection_status,'0')='1' and isnull(r.admission_status,'0')='1' and r.app_no not in (select app_no from registration where Degree_Code in('" + itemheader + "')  and batch_year in('" + batch_year + "'))";
                        admStudFilTer = " and r.isconfirm=1 and isnull(r.selection_status,'0')='1' and isnull(r.admission_status,'0')='1' ";
                        break;
                }
                if (txt_rollno3.Text.Trim() == "")
                {

                    selectquery = "  select r.app_formno as  Roll_No,r.app_formno as smart_serial_no,r.app_formno as Roll_Admit,Stud_Name,d.Degree_Code ,(C.Course_Name +' - '+ dt.Dept_Name) as Department,r.app_formno as Reg_No ,r.app_formno,r.App_No,c.type   from applyn r,Degree d,Department dt,Course c where r.degree_code =d.Degree_Code and dt.Dept_Code =d.Dept_Code and c.Course_Id =d.Course_Id   and Batch_Year =" + batch_year + " and r.degree_code in ('" + itemheader + "' ) " + stream + "   " + admStudFilter + "  and r.college_code='" + collegecode1 + "'";
                    selectquery = selectquery + " order by Roll_No,d.Degree_Code ";
                }
                else
                {
                    //App no
                    selectquery = "select r.app_formno as  Roll_No,r.app_formno as smart_serial_no,r.app_formno as Roll_Admit,Stud_Name,d.Degree_Code ,(C.Course_Name +' - '+ dt.Dept_Name) as Department,r.app_formno as Reg_No ,r.app_formno,r.App_No,c.type   from applyn r,Degree d,Department dt,Course c where r.degree_code =d.Degree_Code and dt.Dept_Code =d.Dept_Code and c.Course_Id =d.Course_Id   " + admStudFilter + "  and r.college_code='" + collegecode1 + "'  and r.app_formno ='" + txt_rollno3.Text + "'  ";
                    app_no = d2.GetFunction("select app_no from registration where roll_admit='" + txt_rollno3.Text.Trim() + "'  and college_code='" + collegecode1 + "' ");
                }
            }
            ds.Clear();
            ds = d2.select_method_wo_parameter(selectquery, "Text");
            if (ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
            {
                Fpspread1.Sheets[0].RowCount = 1;
                Fpspread1.Sheets[0].ColumnCount = 0;
                Fpspread1.Sheets[0].ColumnHeader.RowCount = 1;
                Fpspread1.CommandBar.Visible = false;
                Fpspread1.Sheets[0].ColumnCount = 8;

                Fpspread1.Sheets[0].RowHeader.Visible = false;
                Fpspread1.Sheets[0].AutoPostBack = false;


                FarPoint.Web.Spread.StyleInfo darkstyle = new FarPoint.Web.Spread.StyleInfo();
                darkstyle.BackColor = ColorTranslator.FromHtml("#0CA6CA");
                darkstyle.ForeColor = Color.White;
                Fpspread1.ActiveSheetView.ColumnHeader.DefaultStyle = darkstyle;

                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 0].Text = " S.No";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 0].Font.Bold = true;
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 0].Font.Name = "Book Antiqua";
                Fpspread1.Sheets[0].Columns[0].Locked = true;
                Fpspread1.Columns[0].Width = 50;

                FarPoint.Web.Spread.CheckBoxCellType chkall = new FarPoint.Web.Spread.CheckBoxCellType();
                chkall.AutoPostBack = true;

                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 1].Text = "Select";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 1].Font.Bold = true;
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 1].Font.Name = "Book Antiqua";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 1].HorizontalAlign = HorizontalAlign.Center;
                Fpspread1.Columns[1].Width = 80;
                Fpspread1.Sheets[0].Columns[1].Locked = false;
                if (rdo_receipt.Checked && chl_MulRcpt.Checked)
                {
                    Fpspread1.Sheets[0].Columns[1].Visible = true;
                }
                else if (rdo_receipt.Checked)
                {
                    Fpspread1.Sheets[0].Columns[1].Visible = false;
                }
                //else if ((rdo_multi.Checked && rdo_challan.Checked))
                //{
                //    Fpspread1.Sheets[0].Columns[1].Visible = true;
                //}

                Fpspread1.Sheets[0].Cells[0, 1].CellType = chkall;
                Fpspread1.Sheets[0].Cells[0, 1].HorizontalAlign = HorizontalAlign.Center;

                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 2].Text = "Admission No";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 2].HorizontalAlign = HorizontalAlign.Center;
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 2].Font.Bold = true;
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 2].Font.Name = "Book Antiqua";

                Fpspread1.Sheets[0].Columns[2].Locked = true;
                Fpspread1.Columns[2].Width = 130;

                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 3].Text = "Roll No";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 3].Font.Bold = true;
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 3].Font.Name = "Book Antiqua";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 3].HorizontalAlign = HorizontalAlign.Center;
                Fpspread1.Sheets[0].Columns[3].Locked = true;
                Fpspread1.Columns[3].Width = 100;

                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 4].Text = "Reg No";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 4].Font.Bold = true;
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 4].Font.Name = "Book Antiqua";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 4].HorizontalAlign = HorizontalAlign.Center;
                Fpspread1.Sheets[0].Columns[4].Locked = true;
                Fpspread1.Columns[4].Width = 100;

                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 5].Text = "Smartcard No";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 5].Font.Bold = true;
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 5].Font.Name = "Book Antiqua";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 5].HorizontalAlign = HorizontalAlign.Center;
                Fpspread1.Sheets[0].Columns[5].Locked = true;
                Fpspread1.Columns[5].Width = 100;

                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 6].Text = "Name";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 6].Font.Bold = true;
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 6].Font.Name = "Book Antiqua";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 6].HorizontalAlign = HorizontalAlign.Center;
                Fpspread1.Sheets[0].Columns[6].Locked = true;
                Fpspread1.Columns[6].Width = 200;

                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 7].Text = "Degree";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 7].Font.Bold = true;
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 7].Font.Name = "Book Antiqua";
                Fpspread1.Sheets[0].ColumnHeader.Cells[0, 7].HorizontalAlign = HorizontalAlign.Center;
                Fpspread1.Sheets[0].Columns[7].Locked = true;
                Fpspread1.Sheets[0].Columns[7].VerticalAlign = VerticalAlign.Middle;
                Fpspread1.Sheets[0].SetColumnMerge(7, FarPoint.Web.Spread.Model.MergePolicy.Always);
                Fpspread1.Columns[7].Width = 270;

                //Fpspread1.Sheets[0].ColumnHeader.Cells[0, 8].Text = "Balance Rs";
                //Fpspread1.Sheets[0].ColumnHeader.Cells[0, 8].Font.Bold = true;
                //Fpspread1.Sheets[0].ColumnHeader.Cells[0, 8].Font.Name = "Book Antiqua";
                //Fpspread1.Sheets[0].ColumnHeader.Cells[0, 8].HorizontalAlign = HorizontalAlign.Right;
                //Fpspread1.Sheets[0].Columns[8].Locked = true;
                //Fpspread1.Sheets[0].Columns[8].VerticalAlign = VerticalAlign.Middle;
                //Fpspread1.Columns[8].Width = 100;

                FarPoint.Web.Spread.TextCellType txtRollno = new FarPoint.Web.Spread.TextCellType();
                FarPoint.Web.Spread.TextCellType txtRegno = new FarPoint.Web.Spread.TextCellType();
                FarPoint.Web.Spread.TextCellType txtRollAd = new FarPoint.Web.Spread.TextCellType();
                FarPoint.Web.Spread.TextCellType txtAppno = new FarPoint.Web.Spread.TextCellType();
                FarPoint.Web.Spread.TextCellType txtSmartno = new FarPoint.Web.Spread.TextCellType();

                if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 0)
                {
                    //roll no
                    Fpspread1.Sheets[0].Columns[3].Visible = true;
                    Fpspread1.Sheets[0].Columns[4].Visible = false;
                    Fpspread1.Sheets[0].Columns[2].Visible = false;
                    Fpspread1.Sheets[0].Columns[5].Visible = false;
                }
                else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 1)
                {
                    //reg no
                    Fpspread1.Sheets[0].Columns[4].Visible = true;
                    Fpspread1.Sheets[0].Columns[3].Visible = false;
                    Fpspread1.Sheets[0].Columns[2].Visible = false;
                    Fpspread1.Sheets[0].Columns[5].Visible = false;
                }
                else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 2)
                {
                    //Admin no
                    Fpspread1.Sheets[0].Columns[2].Visible = true;
                    Fpspread1.Sheets[0].Columns[4].Visible = false;
                    Fpspread1.Sheets[0].Columns[3].Visible = false;
                    Fpspread1.Sheets[0].Columns[5].Visible = false;
                }
                else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 4)
                {
                    //Smartcard no
                    Fpspread1.Sheets[0].Columns[5].Visible = false;
                    Fpspread1.Sheets[0].Columns[2].Visible = false;
                    Fpspread1.Sheets[0].Columns[4].Visible = false;
                    Fpspread1.Sheets[0].Columns[3].Visible = false;
                    if (smartDisp == 0)
                        Fpspread1.Sheets[0].Columns[3].Visible = true;
                    else if (smartDisp == 1)
                        Fpspread1.Sheets[0].Columns[4].Visible = true;
                    else if (smartDisp == 2 || smartDisp == 3)
                        Fpspread1.Sheets[0].Columns[2].Visible = true;
                }
                else
                {
                    //App no
                    Fpspread1.Sheets[0].ColumnHeader.Cells[0, 2].Text = "App No";
                    Fpspread1.Sheets[0].Columns[2].Visible = true;
                    Fpspread1.Sheets[0].Columns[4].Visible = false;
                    Fpspread1.Sheets[0].Columns[3].Visible = false;
                    Fpspread1.Sheets[0].Columns[5].Visible = false;
                }

                for (int row = 0; row < ds.Tables[0].Rows.Count; row++)
                {

                    Fpspread1.Sheets[0].RowCount++;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 0].Text = Convert.ToString(row + 1);
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 0].Tag = Convert.ToString(ds.Tables[0].Rows[row]["App_No"]);
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 0].HorizontalAlign = HorizontalAlign.Center;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 0].Font.Size = FontUnit.Medium;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 0].Font.Name = "Book Antiqua";
                    //
                    FarPoint.Web.Spread.CheckBoxCellType check = new FarPoint.Web.Spread.CheckBoxCellType();
                    check.AutoPostBack = false;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 1].CellType = check;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 1].HorizontalAlign = HorizontalAlign.Center;

                    //
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 2].CellType = txtRollAd;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 2].Text = Convert.ToString(ds.Tables[0].Rows[row]["Roll_Admit"]);
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 2].HorizontalAlign = HorizontalAlign.Left;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 2].Font.Size = FontUnit.Medium;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 2].Font.Name = "Book Antiqua";

                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 3].CellType = txtRollno;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 3].Text = Convert.ToString(ds.Tables[0].Rows[row]["Roll_No"]);
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 3].HorizontalAlign = HorizontalAlign.Left;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 3].Font.Size = FontUnit.Medium;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 3].Font.Name = "Book Antiqua";

                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 4].CellType = txtRegno;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 4].Text = Convert.ToString(ds.Tables[0].Rows[row]["Reg_No"]);
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 4].HorizontalAlign = HorizontalAlign.Left;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 4].Font.Size = FontUnit.Medium;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 4].Font.Name = "Book Antiqua";

                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 5].CellType = txtSmartno;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 5].Text = Convert.ToString(ds.Tables[0].Rows[row]["smart_serial_no"]);
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 5].HorizontalAlign = HorizontalAlign.Left;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 5].Font.Size = FontUnit.Medium;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 5].Font.Name = "Book Antiqua";

                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 6].Text = Convert.ToString(ds.Tables[0].Rows[row]["Stud_Name"]);
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 6].HorizontalAlign = HorizontalAlign.Left;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 6].Font.Size = FontUnit.Medium;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 6].Font.Name = "Book Antiqua";

                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 7].Tag = Convert.ToString(ds.Tables[0].Rows[row]["Degree_Code"]);
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 7].Text = Convert.ToString(ds.Tables[0].Rows[row]["Department"]);
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 7].HorizontalAlign = HorizontalAlign.Left;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 7].Font.Size = FontUnit.Medium;
                    Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 7].Font.Name = "Book Antiqua";

                    //double amt = 0.00;
                    //if (ds.Tables.Count > 1)
                    //{
                    //    if (ds.Tables[1].Rows.Count > 0)
                    //    {
                    //        string appno = Convert.ToString(ds.Tables[0].Rows[row]["App_No"]);
                    //        ds.Tables[1].DefaultView.RowFilter = " app_no=" + appno;
                    //        DataView dvAmt = new DataView();
                    //        dvAmt = ds.Tables[1].DefaultView;
                    //        if (dvAmt.Count > 0)
                    //        {
                    //            double.TryParse(dvAmt[0][0].ToString(), out amt);
                    //        }
                    //    }
                    //}

                    //Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 8].Text = amt.ToString(); //lookupAmountIndividual().ToString();
                    //Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 8].HorizontalAlign = HorizontalAlign.Right;
                    //Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 8].Font.Size = FontUnit.Medium;
                    //Fpspread1.Sheets[0].Cells[Fpspread1.Sheets[0].RowCount - 1, 8].Font.Name = "Book Antiqua";
                }
                Fpspread1.Visible = true;
                Fpspread1.Sheets[0].PageSize = Fpspread1.Sheets[0].RowCount;
                Fpspread1.Sheets[0].SpanModel.Add(0, 2, 1, 4);
                Fpspread1.Sheets[0].FrozenRowCount = 1;

                Fpspread1.SaveChanges();

                btn_studOK.Visible = true;
                btn_exitstud.Visible = true;
            }
            else
            {
                Fpspread1.Visible = false;
                lbl_errormsg.Visible = true;
                lbl_errormsg.Text = "No Records Found";
                btn_studOK.Visible = false;
                btn_exitstud.Visible = false;
            }

        }
        catch (Exception ex) { d2.sendErrorMail(ex, collegecode1, "ChallanReceipt"); }
    }
    public void bindType()
    {
        try
        {
            //cbl_strm.Items.Clear();
            //cb_strm.Checked = false;
            //txt_strm.Text = "--Select--";
            ddl_strm.Items.Clear();
            string query = "select Distinct ISNULL( type,'') as type  from Registration r,Degree d,Department dt,Course c where r.degree_code =d.Degree_Code and d.Dept_Code =dt.Dept_Code and d.Course_Id =c.Course_Id  and type<>''  and r.college_code='" + collegecode1 + "'  order by type asc";
            ds.Clear();
            ds = d2.select_method_wo_parameter(query, "Text");
            if (ds.Tables[0].Rows.Count > 0)
            {
                ddl_strm.DataSource = ds;
                ddl_strm.DataTextField = "type";
                ddl_strm.DataValueField = "type";
                ddl_strm.DataBind();
                ddl_strm.Enabled = true;

                //cbl_strm.DataSource = ds;
                //cbl_strm.DataTextField = "type";
                //cbl_strm.DataValueField = "type";
                //cbl_strm.DataBind();
                //if (cbl_strm.Items.Count > 0)
                //{
                //    for (int i = 0; i < cbl_strm.Items.Count; i++)
                //    {
                //        cbl_strm.Items[i].Selected = true;
                //    }
                //    txt_strm.Text = "Stream(" + cbl_strm.Items.Count + ")";
                //    cb_strm.Checked = true;
                //}
                //txt_strm.Enabled = true;
            }
            else
            {
                //txt_strm.Enabled = false;
                ddl_strm.Enabled = false;
            }
        }
        catch (Exception ex) { }
    }
    protected void ddl_strm_OnIndexChange(object sender, EventArgs e)
    {
        binddegree2();
        bindbranch1();
        bindsec2();
    }
    protected void cb_strm_OnCheckedChanged(object sender, EventArgs e)
    {
        // CallCheckBoxChangedEvent(cbl_strm, cb_strm, txt_strm, lbl_stream.Text);
        binddegree2();
        bindbranch1();
        bindsec2();
    }
    protected void cbl_strm_OnSelectedIndexChanged(object sender, EventArgs e)
    {
        //CallCheckBoxListChangedEvent(cbl_strm, cb_strm, txt_strm, lbl_stream.Text);
        binddegree2();
        bindbranch1();
        bindsec2();
    }
    protected void cbl_branch1_SelectedIndexChanged(object sender, EventArgs e)
    {
        CallCheckBoxListChangedEvent(cbl_branch1, cb_branch1, txt_branch2, "Branch");
        bindsec2();
    }
    protected void cb_branch1_ChekedChange(object sender, EventArgs e)
    {
        CallCheckBoxChangedEvent(cbl_branch1, cb_branch1, txt_branch2, "Branch");
        bindsec2();
    }
    protected void cbl_degree2_SelectedIndexChanged(object sender, EventArgs e)
    {
        CallCheckBoxListChangedEvent(cbl_degree2, cb_degree2, txt_degree2, "Degree");
        bindbranch1();
        bindsec2();
    }
    protected void cb_degree2_ChekedChange(object sender, EventArgs e)
    {
        CallCheckBoxChangedEvent(cbl_degree2, cb_degree2, txt_degree2, "Degree");
        bindbranch1();
        bindsec2();
    }
    protected void cb_sec2_ChekedChange(object sender, EventArgs e)
    {
        CallCheckBoxChangedEvent(cbl_sec2, cb_sec2, txt_sec2, "Section");
    }
    protected void cbl_sec2_SelectedIndexChanged(object sender, EventArgs e)
    {
        CallCheckBoxListChangedEvent(cbl_sec2, cb_sec2, txt_sec2, "Section");
    }
    public void bindbatch1()
    {
        try
        {
            ddl_batch1.Items.Clear();
            string sqlyear = "select distinct batch_year from Registration where batch_year<>'-1' and batch_year<>'' and cc=0 and delflag=0 and exam_flag<>'debar' order by batch_year desc";
            ds = d2.select_method_wo_parameter(sqlyear, "Text");
            if (ds.Tables[0].Rows.Count > 0)
            {
                ddl_batch1.DataSource = ds;
                ddl_batch1.DataTextField = "batch_year";
                ddl_batch1.DataValueField = "batch_year";
                ddl_batch1.DataBind();
            }
        }
        catch (Exception ex) { }
    }
    public void binddegree2()
    {
        try
        {
            ds.Clear();
            cbl_degree2.Items.Clear();
            string stream = "";
            stream = ddl_strm.Items.Count > 0 ? ddl_strm.SelectedValue : "";
            //if (cbl_strm.Items.Count > 0)
            //{
            //    for (int i = 0; i < cbl_strm.Items.Count; i++)
            //    {
            //        if (cbl_strm.Items[i].Selected == true)
            //        {
            //            if (stream == "")
            //            {
            //                stream = Convert.ToString(cbl_strm.Items[i].Value);
            //            }
            //            else
            //            {
            //                stream = stream + "'" + "," + "'" + Convert.ToString(cbl_strm.Items[i].Value);
            //            }
            //        }
            //    }
            //}

            txt_degree2.Text = "--Select--";

            string useCOdeSet = "select LinkValue from New_InsSettings where LinkName='MultipleCollegeUserRights' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "' ";
            string colleges = Convert.ToString(d2.GetFunction(useCOdeSet)).Trim();
            if (colleges == "" || colleges == "0")
            {
                colleges = collegecode1;
            }
            //string query = "select distinct degree.course_id,course.course_name from degree,course,deptprivilages  where course.course_id=degree.course_id and course.college_code = degree.college_code  and degree.college_code in (" + collegecode1 + ") and deptprivilages.Degree_code=degree.Degree_code and   user_code=" + usercode + " ";
            string query = "select distinct degree.course_id,course.course_name from degree,course where course.course_id=degree.course_id and course.college_code = degree.college_code  and degree.college_code in (" + collegecode1 + ") ";
            if (ddl_strm.Enabled)//if (txt_strm.Enabled)
            {
                query += " and course.type in ('" + stream + "')";
            }
            ds = d2.select_method_wo_parameter(query, "Text");
            if (ds.Tables[0].Rows.Count > 0)
            {
                cbl_degree2.DataSource = ds;
                cbl_degree2.DataTextField = "course_name";
                cbl_degree2.DataValueField = "course_id";
                cbl_degree2.DataBind();
                if (cbl_degree2.Items.Count > 0)
                {
                    for (int i = 0; i < cbl_degree2.Items.Count; i++)
                    {
                        cbl_degree2.Items[i].Selected = true;
                    }
                    txt_degree2.Text = "Degree(" + cbl_degree2.Items.Count + ")";
                    cb_degree2.Checked = true;
                }
                else
                {
                    txt_degree2.Text = "--Select--";
                }
            }
            else
            {
                txt_degree2.Text = "--Select--";
            }

        }
        catch (Exception ex) { }
    }
    public void bindbranch1()
    {
        try
        {
            cbl_branch1.Items.Clear();

            string branch = "";
            for (int i = 0; i < cbl_degree2.Items.Count; i++)
            {
                if (cbl_degree2.Items[i].Selected == true)
                {
                    if (branch == "")
                    {
                        branch = "" + cbl_degree2.Items[i].Value.ToString() + "";
                    }
                    else
                    {
                        branch = branch + "'" + "," + "" + "'" + cbl_degree2.Items[i].Value.ToString() + "";
                    }
                }
            }
            string commname = "";
            if (branch != "")
            {
                //commname = "select distinct degree.degree_code,department.dept_name,degree.Acronym  from degree,department,course,deptprivilages where course.course_id=degree.course_id  and department.dept_code=degree.dept_code and course.college_code = degree.college_code and department.college_code = degree.college_code and degree.course_id in('" + branch + "') and deptprivilages.Degree_code=degree.Degree_code ";
                commname = "select distinct degree.degree_code,department.dept_name,degree.Acronym  from degree,department,course where course.course_id=degree.course_id  and department.dept_code=degree.dept_code and course.college_code = degree.college_code and department.college_code = degree.college_code and degree.course_id in('" + branch + "') ";
            }
            else
            {
                //commname = " select distinct degree.degree_code,department.dept_name,degree.Acronym  from degree,department,course,deptprivilages where course.course_id=degree.course_id  and department.dept_code=degree.dept_code and course.college_code = degree.college_code and department.college_code = degree.college_code and deptprivilages.Degree_code=degree.Degree_code";
                commname = " select distinct degree.degree_code,department.dept_name,degree.Acronym  from degree,department,course where course.course_id=degree.course_id  and department.dept_code=degree.dept_code and course.college_code = degree.college_code and department.college_code = degree.college_code ";
            }
            if (branch.Trim() != "")
            {
                ds = d2.select_method_wo_parameter(commname, "Text");
                if (ds.Tables[0].Rows.Count > 0)
                {
                    cbl_branch1.DataSource = ds;
                    cbl_branch1.DataTextField = "dept_name";
                    cbl_branch1.DataValueField = "degree_code";
                    cbl_branch1.DataBind();



                    if (cbl_branch1.Items.Count > 0)
                    {
                        for (int i = 0; i < cbl_branch1.Items.Count; i++)
                        {
                            cbl_branch1.Items[i].Selected = true;
                        }
                        txt_branch2.Text = "Branch(" + cbl_branch1.Items.Count + ")";
                        cb_branch1.Checked = true;
                    }
                }
                else
                {
                    txt_branch2.Text = "--Select--";
                }
            }
            else
            {
                txt_branch2.Text = "--Select--";
            }
        }
        catch (Exception ex) { }
    }
    public void bindsec2()
    {
        try
        {
            cbl_sec2.Items.Clear();
            txt_sec2.Text = "--Select--";
            ListItem item = new ListItem("Empty", " ");
            if (ddl_batch1.Items.Count > 0)
            {
                string strbatch = Convert.ToString(ddl_batch1.SelectedItem.Value);
                string branch = "";
                for (int i = 0; i < cbl_branch1.Items.Count; i++)
                {
                    if (cbl_branch1.Items[i].Selected == true)
                    {
                        if (branch == "")
                        {
                            branch = "" + cbl_branch1.Items[i].Value.ToString() + "";
                        }
                        else
                        {
                            branch = branch + "" + "," + "" + "" + cbl_branch1.Items[i].Value.ToString() + "";
                        }
                    }
                }
                if (branch != "")
                {
                    DataSet dsSec = d2.BindSectionDetail(strbatch, branch);
                    if (dsSec.Tables.Count > 0)
                    {
                        if (dsSec.Tables[0].Rows.Count > 0)
                        {
                            cbl_sec2.DataSource = dsSec;
                            cbl_sec2.DataTextField = "sections";
                            cbl_sec2.DataValueField = "sections";
                            cbl_sec2.DataBind();


                        }
                    }
                    cbl_sec2.Items.Insert(0, item);
                    for (int i = 0; i < cbl_sec2.Items.Count; i++)
                    {
                        cbl_sec2.Items[i].Selected = true;
                    }
                    cb_sec2.Checked = true;
                    txt_sec2.Text = "Section(" + cbl_sec2.Items.Count + ")";

                }
            }


        }
        catch (Exception ex) { }
    }
    public void bindclg()
    {
        try
        {
            ds.Clear();
            ddl_college.Items.Clear();
            selectQuery = "select cp.college_code,cf.collname from collegeprivilages cp,collinfo cf where user_code=" + Session["usercode"] + " and cp.college_code=cf.college_code";
            ds = d2.select_method_wo_parameter(selectQuery, "Text");
            if (ds.Tables[0].Rows.Count > 0)
            {
                ddl_college.DataSource = ds;
                ddl_college.DataTextField = "collname";
                ddl_college.DataValueField = "college_code";
                ddl_college.DataBind();
            }
        }
        catch (Exception ex) { }
    }
    //popup cash grid

    protected void imagebtnpopGridclose_Click(object sender, EventArgs e)
    {
        div_cash.Visible = false;
    }

    //Popup Ledger
    protected void rblCommInv_Indexchanged(object sender, EventArgs e)
    {
        try
        {
            if (rbl_rollnoNew.SelectedIndex == 0)
            {
                if (txt_rollno.Text.Trim() != "")
                {
                    div_HeaderLed.Attributes.Add("Style", "display:block;");
                    imgAlert.Attributes.Add("Style", " display:none;");
                    headerbind();
                    ledgerbind();
                    cbl_semAddFee.Items.Clear();
                    cb_semAddFee.Checked = false;
                    txt_Addfeesem.Text = "Semester/Year";


                    grid_HeaderLedger.DataSource = null;
                    grid_HeaderLedger.DataBind();
                    btn_ledgersave.Visible = false;
                    btn_ledgerExit.Visible = false;
                }
                else
                {
                    div_HeaderLed.Attributes.Add("Style", "display:none;");
                    imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                    lbl_alert.Text = "Please Enter " + rbl_rollno.SelectedItem.Text;
                }
            }
            else if (rbl_rollnoNew.SelectedIndex == 1)
            {
                if (txtroll_staff.Text.Trim() != "")
                {
                    div_HeaderLed.Attributes.Add("Style", "display:block;");
                    imgAlert.Attributes.Add("Style", " display:none;");
                    headerbind();
                    ledgerbind();
                    semesterbind();
                    grid_HeaderLedger.DataSource = null;
                    grid_HeaderLedger.DataBind();
                    btn_ledgersave.Visible = false;
                    btn_ledgerExit.Visible = false;
                }
                else
                {
                    div_HeaderLed.Attributes.Add("Style", "display:none;");
                    imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                    //this.Form.DefaultButton = "btn_alertclose";
                    lbl_alert.Text = "Please Enter StaffId";
                }
            }
            else if (rbl_rollnoNew.SelectedIndex == 2)
            {
                if (txtroll_vendor.Text.Trim() != "" && txtname_vendor.Text.Trim() != "")
                {
                    imgAlert.Attributes.Add("Style", " display:none;");
                    div_HeaderLed.Attributes.Add("Style", "display:block;");
                    headerbind();
                    ledgerbind();
                    semesterbind();
                    //UpdatePanel9.Visible = true;
                    grid_HeaderLedger.DataSource = null;
                    grid_HeaderLedger.DataBind();
                    btn_ledgersave.Visible = false;
                    btn_ledgerExit.Visible = false;
                }
                else
                {
                    div_HeaderLed.Attributes.Add("Style", "display:none;");
                    imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                    //this.Form.DefaultButton = "btn_alertclose";
                    lbl_alert.Text = "Please Enter Vendor And Contact Person";
                }
            }
            else if (rbl_rollnoNew.SelectedIndex == 3)
            {
                if (txtroll_other.Text.Trim() != "")//&& txt_otherMobile.Text.Trim() != ""
                {
                    div_HeaderLed.Attributes.Add("Style", "display:block;");
                    imgAlert.Attributes.Add("Style", " display:none;");
                    headerbind();
                    ledgerbind();
                    semesterbind();
                    grid_HeaderLedger.DataSource = null;
                    grid_HeaderLedger.DataBind();
                    btn_ledgersave.Visible = false;
                    btn_ledgerExit.Visible = false;
                }
                else
                {
                    div_HeaderLed.Attributes.Add("Style", "display:none;");
                    imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                    lbl_alert.Text = "Please Enter Name";
                }
            }

            if (rblCommInv.SelectedIndex == 0)
            {
                pnlCommonLedger.Visible = true;
                pnlInventLedger.Visible = false;
            }
            else
            {
                pnlCommonLedger.Visible = false;
                pnlInventLedger.Visible = true;

                txtInvSrchCode.Text = "";
                txtInvSrchName.Text = "";

                ledgerbindInv();
                itemStoreBindInv();
                // itemDeptBindInv();
                itemHeadBindInv();
                itemSHdrBindInv();
                itemCodeBindInv();
                itemNameBindInv();

                if (Session["viwGridInv"] != null)
                    Session.Remove("viwGridInv");

                gridInv.DataSource = null;
                gridInv.DataBind();
                btnInvSave.Visible = false;
                btnInvExit.Visible = false;
                btnInvDelete.Visible = false;
            }
        }
        catch (Exception ex) { }
    }
    //common Ledger fees
    protected void imagebtnpopLedgerclose_Click(object sender, EventArgs e)
    {
        div_HeaderLed.Visible = false;
        if (Session["viwGridInv"] != null)
            Session.Remove("viwGridInv");
    }
    protected void btnAddFee_Click(object sender, EventArgs e)
    {
        //UpdatePanel9.Visible = false;
        rblCommInv.SelectedIndex = 0;
        rblCommInv_Indexchanged(sender, e);
        //this.Form.DefaultButton = "btn_ledgesearch";
        if (Session["viwGridInv"] != null)
        {
            Session.Remove("viwGridInv");

        }
        setSearchHeaders();
    }
    protected void cb_HeaderPop_ChekedChange(object sender, EventArgs e)
    {
        CallCheckBoxChangedEvent(cbl_HeaderPop, cb_HeaderPop, txt_HeaderPop, "Header");
        ledgerbind();
        setSearchHeaders();
    }
    protected void cbl_HeaderPop_SelectedIndexChanged(object sender, EventArgs e)
    {
        CallCheckBoxListChangedEvent(cbl_HeaderPop, cb_HeaderPop, txt_HeaderPop, "Header");
        ledgerbind();
        setSearchHeaders();
    }
    public void headerbind()
    {
        try
        {
            txt_HeaderPop.Text = "Header";
            cb_HeaderPop.Checked = false;
            cbl_HeaderPop.Items.Clear();

            string query = "SELECT distinct HeaderPK,HeaderName FROM FM_HeaderMaster H,FS_HeaderPrivilage P WHERE H.HeaderPK = P.HeaderFK AND P.CollegeCode = H.CollegeCode AND P. UserCode = " + usercode + " AND H.CollegeCode = " + collegecode1 + "   ";
            ds = d2.select_method_wo_parameter(query, "Text");

            if (ds.Tables[0].Rows.Count > 0)
            {
                cbl_HeaderPop.DataSource = ds;
                cbl_HeaderPop.DataTextField = "HeaderName";
                cbl_HeaderPop.DataValueField = "HeaderPK";
                cbl_HeaderPop.DataBind();
                for (int i = 0; i < cbl_HeaderPop.Items.Count; i++)
                {
                    cbl_HeaderPop.Items[i].Selected = true;
                }
                txt_HeaderPop.Text = "Header(" + cbl_HeaderPop.Items.Count + ")";
                cb_HeaderPop.Checked = true;
            }

        }
        catch (Exception ex) { }
    }
    protected void cb_ledgerpop_ChekedChange(object sender, EventArgs e)
    {
        CallCheckBoxChangedEvent(cbl_ledgerpop, cb_ledgerpop, txt_Ledgerpop, "Ledger");
    }
    protected void cbl_ledgerpop_SelectedIndexChanged(object sender, EventArgs e)
    {
        CallCheckBoxListChangedEvent(cbl_ledgerpop, cb_ledgerpop, txt_Ledgerpop, "Ledger");
    }
    public void ledgerbind()
    {
        try
        {
            txt_Ledgerpop.Text = "Ledger";
            cb_ledgerpop.Checked = false;
            string itemheadercode = "";
            for (int i = 0; i < cbl_HeaderPop.Items.Count; i++)
            {
                if (cbl_HeaderPop.Items[i].Selected == true)
                {
                    if (itemheadercode == "")
                    {
                        itemheadercode = "" + cbl_HeaderPop.Items[i].Value.ToString() + "";
                    }
                    else
                    {
                        itemheadercode = itemheadercode + "" + "," + "" + cbl_HeaderPop.Items[i].Value.ToString() + "";
                    }
                }
            }

            cbl_ledgerpop.Items.Clear();

            //string query = "SELECT Fee_Code,Fee_Type FROM fee_info I,acctheader H WHERE I.header_id = H.header_id AND I.header_id IN ('" + itemheadercode + "') and  Fee_Type NOT IN ('Cash','Income & Expenditure','Misc','Excess Amount','Fine') AND Fee_Type NOT IN (SELECT BankName FROM Bank_Master1) ORDER BY Fee_Type";

            string query = "SELECT distinct LedgerPK,LedgerName FROM FM_LedgerMaster L,FS_LedgerPrivilage P WHERE L.LedgerPK = P.LedgerFK   AND P.CollegeCode = L.CollegeCode  and l.LedgerMode=0   AND P. UserCode = " + usercode + " AND L.CollegeCode = " + collegecode1 + " and L.HeaderFK in (" + itemheadercode + ")";

            ds = d2.select_method_wo_parameter(query, "Text");

            if (ds.Tables[0].Rows.Count > 0)
            {
                cbl_ledgerpop.DataSource = ds;
                cbl_ledgerpop.DataTextField = "LedgerName";
                cbl_ledgerpop.DataValueField = "LedgerPK";
                cbl_ledgerpop.DataBind();
                for (int i = 0; i < cbl_ledgerpop.Items.Count; i++)
                {
                    cbl_ledgerpop.Items[i].Selected = true;
                }
                txt_Ledgerpop.Text = "Ledger(" + cbl_ledgerpop.Items.Count + ")";
                cb_ledgerpop.Checked = true;
            }
        }
        catch (Exception ex) { }
    }
    public void semesterbind()
    {
        try
        {
            cbl_semAddFee.Items.Clear();
            cb_semAddFee.Checked = false;
            txt_Addfeesem.Text = "Semester/Year";

            linkvalue = d2.GetFunction("select LinkValue from New_InsSettings where linkname = 'Fee Yearwise' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "'");

            if (linkvalue != "")
            {
                DataSet dsSemYear = new DataSet();
                string query = "";
                if (linkvalue == "0")
                {
                    query = "selECT	* from textvaltable where TextCriteria ='FEECA' and textval like '% semester' and college_code=" + collegecode1 + " order by len(textval),textval asc";
                }
                else
                {
                    query = " selECT	* from textvaltable where TextCriteria ='FEECA' and textval like '% Year' and college_code=" + collegecode1 + " order by len(textval),textval asc";
                }
                dsSemYear = d2.select_method_wo_parameter(query, "Text");
                if (dsSemYear.Tables.Count > 0)
                {
                    if (dsSemYear.Tables[0].Rows.Count > 0)
                    {
                        //For Staff

                        cbl_semAddFee.DataSource = dsSemYear;
                        cbl_semAddFee.DataTextField = "TextVal";
                        cbl_semAddFee.DataValueField = "TextCode";
                        cbl_semAddFee.DataBind();

                        for (int i = 0; i < cbl_semAddFee.Items.Count; i++)
                        {
                            cbl_semAddFee.Items[i].Selected = true;
                        }
                        txt_Addfeesem.Text = "Semester/Year(" + cbl_semAddFee.Items.Count + ")";
                        cb_semAddFee.Checked = true;
                    }
                }
            }
        }
        catch (Exception ex) { }
    }

    protected void cb_semAddFee_CheckedChanged(object sender, EventArgs e)
    {
        CallCheckBoxChangedEvent(cbl_semAddFee, cb_semAddFee, txt_Addfeesem, "Semester/Year");
    }
    protected void cbl_semAddFee_SelectedIndexChanged(object sender, EventArgs e)
    {
        CallCheckBoxListChangedEvent(cbl_semAddFee, cb_semAddFee, txt_Addfeesem, "Semester/Year");
    }

    protected void cbsemadd_CheckedChanged(object sender, EventArgs e)
    {
        CallCheckBoxChangedEvent(cblsemadd, cbsemadd, txtsemadd, lbsem.Text);
    }
    protected void cblsemadd_SelectedIndexChanged(object sender, EventArgs e)
    {
        CallCheckBoxListChangedEvent(cblsemadd, cbsemadd, txtsemadd, lbsem.Text);
    }

    static string srchSelHead = string.Empty;
    public void setSearchHeaders()
    {
        StringBuilder sbSelHead = new StringBuilder();
        for (int i = 0; i < cbl_HeaderPop.Items.Count; i++)
        {
            if (cbl_HeaderPop.Items[i].Selected)
            {
                if (sbSelHead.Length == 0)
                {
                    sbSelHead.Append(cbl_HeaderPop.Items[i].Value);
                }
                else
                {
                    sbSelHead.Append("','" + cbl_HeaderPop.Items[i].Value);
                }
            }
        }
        srchSelHead = sbSelHead.ToString();
        div_HeaderLed.Attributes.Add("Style", "display:block;");
    }
    [System.Web.Services.WebMethod]
    [System.Web.Script.Services.ScriptMethod()]
    public static List<string> GetLegerName(string prefixText)
    {
        List<string> name = new List<string>();
        try
        {
            WebService ws = new WebService();
            string query = " ";

            if (ledgerorheader == 0)
            {
                query = "SELECT  top 100 HeaderName FROM FM_HeaderMaster H,FS_HeaderPrivilage P WHERE H.HeaderPK = P.HeaderFK AND P.CollegeCode = H.CollegeCode AND P. UserCode = " + usercodestat + " AND H.CollegeCode = " + collegecodestat + " and HeaderName Like '" + prefixText + "%' and H.HeaderPK in ('" + srchSelHead + "')   order by HeaderName asc ";

            }
            else
            {
                query = "SELECT  top 100 LedgerName,LedgerPK FROM FM_LedgerMaster L,FS_LedgerPrivilage P WHERE L.LedgerPK = P.LedgerFK  and l.LedgerMode=0     AND P.CollegeCode = L.CollegeCode AND P. UserCode = " + usercodestat + " AND L.CollegeCode = " + collegecodestat + "  and L.HeaderFK in ('" + srchSelHead + "')  and LedgerName like '" + prefixText + "%'   order by LedgerName asc";
            }


            name = ws.Getname(query);
            return name;
        }
        catch { return name; }
    }
    protected void btn_ledgesearch_Click(object sender, EventArgs e)
    {
        try
        {
            //this.Form.DefaultButton = "btn_ledgesearch";
            DataTable tbl_Ledger = new DataTable();
            tbl_Ledger.Columns.Add("HeaderName");
            tbl_Ledger.Columns.Add("HeaderPK");
            tbl_Ledger.Columns.Add("LedgerPK");
            tbl_Ledger.Columns.Add("LedgerName");

            string itemheadercode = GetSelectedItemsValue(cbl_HeaderPop);
            string feecode = GetSelectedItemsValue(cbl_ledgerpop);
            string query = " select  HeaderName,HeaderPK,LedgerPK,priority ,LedgerName from  FM_LedgerMaster L,FS_LedgerPrivilage P,FM_HeaderMaster H,FS_HeaderPrivilage Ph WHERE L.LedgerPK = P.LedgerFK and H.HeaderPK = Ph.HeaderFK and p.HeaderFK=H.HeaderPK  and l.LedgerMode=0 and ph.UserCode =p.UserCode  and p.UserCode =" + usercode + "  and h.CollegeCode=" + collegecode1 + " and L.LedgerPK in (" + feecode + ") and H.HeaderPK in (" + itemheadercode + ")  order by Headerpk,LedgerName asc --  order by case when priority is null then 1 else 0 end, priority";
            if (txt_ledgeSearch.Text.Trim() != "")
            {
                if (ddl_ledgeSearch.SelectedIndex == 0)
                {
                    query = " select  HeaderName,HeaderPK,LedgerPK,priority ,LedgerName from  FM_LedgerMaster L,FS_LedgerPrivilage P,FM_HeaderMaster H,FS_HeaderPrivilage Ph WHERE L.LedgerPK = P.LedgerFK and H.HeaderPK = Ph.HeaderFK and p.HeaderFK=H.HeaderPK  and l.LedgerMode=0  and ph.UserCode =p.UserCode  and p.UserCode =" + usercode + "   and h.CollegeCode=" + collegecode1 + " and  H.HeaderName in ('" + txt_ledgeSearch.Text + "')  order by Headerpk,LedgerName asc --  order by case when priority is null then 1 else 0 end, priority";
                }
                else
                {
                    query = " select  HeaderName,HeaderPK,LedgerPK,priority ,LedgerName from  FM_LedgerMaster L,FS_LedgerPrivilage P,FM_HeaderMaster H,FS_HeaderPrivilage Ph WHERE L.LedgerPK = P.LedgerFK and H.HeaderPK = Ph.HeaderFK and p.HeaderFK=H.HeaderPK  and l.LedgerMode=0  and ph.UserCode =p.UserCode  and p.UserCode =" + usercode + "   and h.CollegeCode=" + collegecode1 + " and L.LedgerName in ('" + txt_ledgeSearch.Text + "') order by Headerpk,LedgerName asc -- order by case when priority is null then 1 else 0 end, priority";
                }
            }

            ds.Clear();
            ds = d2.select_method_wo_parameter(query, "Text");
            if (ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
            {
                for (int i = 0; i < ds.Tables[0].Rows.Count; i++)
                {
                    DataRow drLedger = tbl_Ledger.NewRow();
                    drLedger["HeaderName"] = Convert.ToString(ds.Tables[0].Rows[i]["HeaderName"]);
                    drLedger["HeaderPK"] = Convert.ToString(ds.Tables[0].Rows[i]["HeaderPK"]);
                    drLedger["LedgerPK"] = Convert.ToString(ds.Tables[0].Rows[i]["LedgerPK"]);
                    drLedger["LedgerName"] = Convert.ToString(ds.Tables[0].Rows[i]["LedgerName"]);
                    tbl_Ledger.Rows.Add(drLedger);
                }

                grid_HeaderLedger.DataSource = tbl_Ledger;
                grid_HeaderLedger.DataBind();
                grid_HeaderLedger.Visible = true;
                btn_ledgersave.Visible = true;
                btn_ledgerExit.Visible = true;
                div_HeaderLed.Attributes.Add("Style", "display:block;");
                imgAlert.Attributes.Add("Style", "display:none;");
            }
            else
            {
                grid_HeaderLedger.DataSource = null;
                grid_HeaderLedger.DataBind();
                btn_ledgersave.Visible = false;
                btn_ledgerExit.Visible = false;
                imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                lbl_alert.Text = "No Records Found";
            }
        }
        catch (Exception ex)
        {
            d2.sendErrorMail(ex, collegecode1, "ChallanReceipt");

            grid_HeaderLedger.DataSource = null;
            grid_HeaderLedger.DataBind();
            btn_ledgersave.Visible = false;
            btn_ledgerExit.Visible = false;
        }
    }
    protected void grid_HeaderLedger_OnDataBound(object sender, EventArgs e)
    {
        string hdrOld = string.Empty;
        string hdrNew = string.Empty;
        List<Color> clrList = NewColors();
        int clrIndx = 0;
        foreach (GridViewRow gRow in grid_HeaderLedger.Rows)
        {
            Label lbl_headpop = (Label)gRow.FindControl("lbl_headpop");
            if (hdrOld == string.Empty)
            {
                hdrOld = lbl_headpop.Text.Trim();
                hdrNew = hdrOld;
                clrIndx = 0;
            }
            else
            {
                hdrNew = lbl_headpop.Text.Trim();
                if (hdrNew != hdrOld)
                {
                    hdrOld = hdrNew;
                    clrIndx++;
                    if (clrIndx > 15)
                        clrIndx = 0;
                }
            }
            gRow.BackColor = clrList[clrIndx];
        }
    }

    private List<Color> NewColors()
    {
        List<Color> clrList = new List<Color>();
        clrList.Add(Color.FromArgb(150, 206, 180));
        clrList.Add(Color.FromArgb(32, 178, 153));
        clrList.Add(Color.FromArgb(227, 224, 204));
        clrList.Add(Color.FromArgb(107, 139, 35));
        clrList.Add(Color.FromArgb(249, 204, 172));
        clrList.Add(Color.FromArgb(244, 166, 136));
        clrList.Add(Color.FromArgb(224, 99, 119));
        clrList.Add(Color.FromArgb(184, 169, 201));
        clrList.Add(Color.FromArgb(217, 236, 208));
        clrList.Add(Color.FromArgb(228, 209, 209));
        clrList.Add(Color.FromArgb(176, 170, 192));
        clrList.Add(Color.FromArgb(119, 168, 168));
        clrList.Add(Color.FromArgb(255, 204, 92));
        clrList.Add(Color.FromArgb(135, 189, 216));
        clrList.Add(Color.FromArgb(255, 165, 0));
        clrList.Add(Color.FromArgb(135, 206, 235));
        return clrList;
    }
    protected void btnpopLedgersave_Click(object sender, EventArgs e)
    {
        int insok = 0;
        bool insOK = false;
        bool isVal = false;
        imgAlert.Attributes.Add("Style", " display:none;");
        if (grid_HeaderLedger.Rows.Count > 0)
        {
            double payAMTVal = 0.00;
            string appno = string.Empty;
            if (rbl_rollnoNew.SelectedIndex == 0)
            {
                #region Add Ledgers For Student
                //Year or sem
                string linkvalue = string.Empty;
                string rollno = txt_rollno.Text.Trim();
                string finYeaid = d2.getCurrentFinanceYear(usercode, collegecode1);

                string feecat = Convert.ToString(GetSelectedItemsValue(cblsemadd));
                if (rollno != "")
                {
                    if (!string.IsNullOrEmpty(feecat))
                    {
                        string getSelFnlID = Convert.ToString(GetSelectedItemsValue(chklsfyear));
                        for (row = 0; row < grid_HeaderLedger.Rows.Count; row++)
                        {
                            Label lbl_headerId = (Label)grid_HeaderLedger.Rows[row].FindControl("lbl_headeridpop");
                            Label lbl_fee_code = (Label)grid_HeaderLedger.Rows[row].FindControl("lbl_ledgeridpop");
                            Label lbl_fee_cat = (Label)grid_HeaderLedger.Rows[row].FindControl("lbl_legerpop");
                            TextBox txtNewLedger = (TextBox)grid_HeaderLedger.Rows[row].FindControl("txt_NewLedger");

                            string hid = lbl_headerId.Text;
                            string lid = lbl_fee_code.Text;
                            string lname = lbl_fee_cat.Text;
                            string amt = txtNewLedger.Text;

                            string text_circode = string.Empty;
                            string seattype = string.Empty;
                            string cursem = string.Empty;
                            string batch_year = string.Empty;
                            if (amt != "" && Convert.ToDouble(amt) != null && Convert.ToDouble(amt) != 0)
                            {
                                string seattypeCurQuery = " select seattype,r.Current_Semester,r.Batch_Year,a.app_no  from applyn a,Registration r where a.app_no=r.App_No  and r.college_code=" + collegecode1 + " ";
                                if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 0)
                                    seattypeCurQuery += "  and r.Roll_No =  '" + rollno + "' ";
                                else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 1)
                                    seattypeCurQuery += " and  R.Reg_No = '" + rollno + "' ";
                                else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 2)
                                    seattypeCurQuery += " and  R.Roll_admit = '" + rollno + "' ";
                                else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 4)
                                    seattypeCurQuery += " and  R.smart_serial_no = '" + rollno + "' ";
                                else
                                    seattypeCurQuery = "select seattype,batch_year,app_no from applyn where  college_code=" + collegecode1 + " and app_formno ='" + rollno + "'";
                                cursem = "1";
                                DataSet dsSTYpe = new DataSet();
                                dsSTYpe = d2.select_method_wo_parameter(seattypeCurQuery, "Text");
                                if (dsSTYpe.Tables.Count > 0 && dsSTYpe.Tables[0].Rows.Count > 0)
                                {
                                    seattype = Convert.ToString(dsSTYpe.Tables[0].Rows[0]["seattype"]);
                                    batch_year = Convert.ToString(dsSTYpe.Tables[0].Rows[0]["batch_year"]);
                                    appno = Convert.ToString(dsSTYpe.Tables[0].Rows[0]["app_no"]);
                                    #region Add To Fee Allot
                                    if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) != 3)
                                        cursem = Convert.ToString(dsSTYpe.Tables[0].Rows[0]["Current_Semester"]);
                                    if (cursem != "" && batch_year != "")
                                    {
                                        //string settingquery = "select * from New_InsSettings where linkname = 'Fee Yearwise' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "'";
                                        //ds.Clear();
                                        //string linkName = string.Empty;
                                        //ds = d2.loadFeecategory(collegecode1, usercode, ref linkName);
                                        //if (ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
                                        //{
                                        //    if (linkName.ToLower().Trim() == "term")
                                        //        ds.Tables[0].DefaultView.RowFilter = " textval ='" + linkName + " " + cursem + "'";
                                        //    else
                                        //    {
                                        //        string clgOrSem = d2.GetFunction("select LinkValue from New_InsSettings where linkname = 'Fee Yearwise' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "'").Trim();
                                        //        if (clgOrSem == "1")
                                        //            cursem = returnYearforSem(cursem);
                                        //        ds.Tables[0].DefaultView.RowFilter = " textval ='" + cursem + " " + linkName + "'";
                                        //    }
                                        //    DataView dvTextCode = ds.Tables[0].DefaultView;
                                        //    if (dvTextCode.Count > 0)
                                        //        text_circode = dvTextCode[0]["TextCode"].ToString();
                                        //}
                                        //if (text_circode != "")
                                        //{
                                        for (int i = 0; i < cblsemadd.Items.Count; i++)
                                        {
                                            if (cblsemadd.Items[i].Selected)
                                            {
                                                string selectQuery = "";
                                                string updateQuery = "";
                                                string insertQuery = " INSERT INTO FT_FeeAllot(AllotDate,MemType,PayMode,App_No,LedgerFK,HeaderFK,FeeAmount,TotalAmount,FeeCategory,BalAmount,FinYearFK,FromGovtAmt, DeductReason) VALUES('" + DateTime.Now.ToString("MM/dd/yyyy") + "',1,1," + appno + "," + lid + "," + hid + "," + amt + "," + amt + "," + cblsemadd.Items[i].Value + "," + amt + "," + getSelFnlID + ",0,0) ";

                                                selectQuery = " select * from FT_FeeAllot where LedgerFK in('" + lid + "') and HeaderFK in('" + hid + "') and FeeCategory in('" + cblsemadd.Items[i].Value + "')  and App_No in('" + appno + "') and finyearfk='" + getSelFnlID + "'";

                                                updateQuery = "  update FT_FeeAllot set AllotDate='" + DateTime.Now.ToString("MM/dd/yyyy") + "', MemType=1,FeeAmount=isnull(FeeAmount,0)+" + amt + ",BalAmount=isnull(BalAmount,0)+" + amt + ",TotalAmount=isnull(TotalAmount,0)+" + amt + " where LedgerFK in('" + lid + "') and HeaderFK in('" + hid + "') and FeeCategory in('" + cblsemadd.Items[i].Value + "')  and App_No in('" + appno + "') and finyearfk='" + getSelFnlID + "'";

                                                string finalQuery = " if exists ( " + selectQuery + " ) " + updateQuery + " else " + insertQuery + " ";
                                                insok = d2.update_method_wo_parameter(finalQuery, "Text");
                                                insOK = true;
                                                double amtVal = Convert.ToDouble(amt);
                                                payAMTVal += amtVal;
                                            }
                                        }
                                        //}
                                    }
                                    #endregion
                                }
                            }
                        }
                    }
                    else
                        isVal = true;
                }
                #endregion
                if (!hideGridFeeAmt() || !hideGridDedAmt() || !hideGridTotAmt() || !hideGridPaidAmt())
                {
                    Txt_amt.Text = payAMTVal.ToString();
                }
                loadGridStudent();
                //getloadfeecat(appno);
            }
            else if (rbl_rollnoNew.SelectedIndex == 1)
            {
                #region Add Ledgers For Staff
                //Year or sem
                string rollno = txtroll_staff.Text.Trim();
                string finYeaid = d2.getCurrentFinanceYear(usercode, collegecode1);

                if (rollno != "")
                {
                    for (row = 0; row < grid_HeaderLedger.Rows.Count; row++)
                    {
                        Label lbl_headerId = (Label)grid_HeaderLedger.Rows[row].FindControl("lbl_headeridpop");
                        Label lbl_fee_code = (Label)grid_HeaderLedger.Rows[row].FindControl("lbl_ledgeridpop");
                        Label lbl_fee_cat = (Label)grid_HeaderLedger.Rows[row].FindControl("lbl_legerpop");
                        TextBox txtNewLedger = (TextBox)grid_HeaderLedger.Rows[row].FindControl("txt_NewLedger");

                        string hid = lbl_headerId.Text;
                        string lid = lbl_fee_code.Text;
                        string lname = lbl_fee_cat.Text;
                        string amt = txtNewLedger.Text;

                        string text_circode = string.Empty;
                        string cursem = "0";

                        if (amt != "" && Convert.ToDouble(amt) != null && Convert.ToDouble(amt) != 0)
                        {
                            appno = d2.GetFunction("select a.appl_id from staffmaster s,staff_appl_master a where s.appl_no=a.appl_no and s.staff_code='" + rollno + "' and s.college_code=" + collegecode1 + " ");

                            if (appno != "" && appno != "0")
                            {
                                text_circode = cursem;
                                string memtype = "1";
                                switch (rbl_rollnoNew.SelectedIndex)
                                {
                                    case 0:
                                        memtype = "1";
                                        break;
                                    case 1:
                                        memtype = "2";
                                        break;
                                    case 2:
                                        memtype = "3";
                                        break;
                                    case 3:
                                        memtype = "4"; ;
                                        break;
                                }

                                string selectQuery = "";
                                string updateQuery = "";

                                string insertQuery = " INSERT INTO FT_FeeAllot(AllotDate,MemType,PayMode,App_No,LedgerFK,HeaderFK,FeeAmount,TotalAmount,FeeCategory,BalAmount,FinYearFK,FromGovtAmt, DeductReason) VALUES('" + DateTime.Now.ToString("MM/dd/yyyy") + "'," + memtype + ",1," + appno + "," + lid + "," + hid + "," + amt + "," + amt + "," + text_circode + "," + amt + "," + finYeaid + ",0,0) ";

                                selectQuery = " select * from FT_FeeAllot where LedgerFK in('" + lid + "') and HeaderFK in('" + hid + "') and FeeCategory in('" + text_circode + "')  and App_No in('" + appno + "') ";

                                updateQuery = "  update FT_FeeAllot set AllotDate='" + DateTime.Now.ToString("MM/dd/yyyy") + "', MemType=" + memtype + ",FeeAmount=isnull(FeeAmount,0)+" + amt + ",BalAmount=isnull(BalAmount,0)+" + amt + ",TotalAmount=isnull(TotalAmount,0)+" + amt + " where LedgerFK in('" + lid + "') and HeaderFK in('" + hid + "') and FeeCategory in('" + text_circode + "')  and App_No in('" + appno + "') ";


                                string finalQuery = " if exists ( " + selectQuery + " ) " + updateQuery + " else " + insertQuery + " ";
                                insok = d2.update_method_wo_parameter(finalQuery, "Text");
                                insOK = true;

                                double amtVal = Convert.ToDouble(amt);
                                payAMTVal += amtVal;
                            }
                        }
                    }
                }
                #endregion
                if (!hideGridFeeAmt() || !hideGridDedAmt() || !hideGridTotAmt() || !hideGridPaidAmt())
                {
                    Txt_amt.Text = payAMTVal.ToString();
                }
                loadGridStaff();
            }
            else if (rbl_rollnoNew.SelectedIndex == 2)
            {
                #region Add Ledgers For Vendor
                //Year or sem
                string rollno = txtname_vendor.Text.Trim();
                try
                {
                    rollno = rollno.Split('-')[2];
                }
                catch { rollno = ""; }
                string finYeaid = d2.getCurrentFinanceYear(usercode, collegecode1);

                if (rollno != "")
                {
                    for (row = 0; row < grid_HeaderLedger.Rows.Count; row++)
                    {
                        Label lbl_headerId = (Label)grid_HeaderLedger.Rows[row].FindControl("lbl_headeridpop");
                        Label lbl_fee_code = (Label)grid_HeaderLedger.Rows[row].FindControl("lbl_ledgeridpop");
                        Label lbl_fee_cat = (Label)grid_HeaderLedger.Rows[row].FindControl("lbl_legerpop");
                        TextBox txtNewLedger = (TextBox)grid_HeaderLedger.Rows[row].FindControl("txt_NewLedger");

                        string hid = lbl_headerId.Text;
                        string lid = lbl_fee_code.Text;
                        string lname = lbl_fee_cat.Text;
                        string amt = txtNewLedger.Text;

                        string text_circode = string.Empty;
                        string cursem = "0";
                        if (amt != "" && Convert.ToDouble(amt) != null && Convert.ToDouble(amt) != 0)
                        {
                            appno = rollno;
                            if (appno != "" && appno != "0")
                            {
                                text_circode = cursem;
                                string memtype = "1";
                                switch (rbl_rollnoNew.SelectedIndex)
                                {
                                    case 0:
                                        memtype = "1";
                                        break;
                                    case 1:
                                        memtype = "2";
                                        break;
                                    case 2:
                                        memtype = "3";
                                        break;
                                    case 3:
                                        memtype = "4"; ;
                                        break;
                                }

                                string selectQuery = "";
                                string updateQuery = "";

                                string insertQuery = " INSERT INTO FT_FeeAllot(AllotDate,MemType,PayMode,App_No,LedgerFK,HeaderFK,FeeAmount,TotalAmount,FeeCategory,BalAmount,FinYearFK,FromGovtAmt, DeductReason) VALUES('" + DateTime.Now.ToString("MM/dd/yyyy") + "'," + memtype + ",1," + appno + "," + lid + "," + hid + "," + amt + "," + amt + "," + text_circode + "," + amt + "," + finYeaid + ",0,0) ";

                                selectQuery = " select * from FT_FeeAllot where LedgerFK in('" + lid + "') and HeaderFK in('" + hid + "') and FeeCategory in('" + text_circode + "')  and App_No in('" + appno + "') ";

                                updateQuery = "  update FT_FeeAllot set AllotDate='" + DateTime.Now.ToString("MM/dd/yyyy") + "', MemType=" + memtype + ",FeeAmount=isnull(FeeAmount,0)+" + amt + ",BalAmount=isnull(BalAmount,0)+" + amt + ",TotalAmount=isnull(TotalAmount,0)+" + amt + " where LedgerFK in('" + lid + "') and HeaderFK in('" + hid + "') and FeeCategory in('" + text_circode + "')  and App_No in('" + appno + "') ";


                                string finalQuery = " if exists ( " + selectQuery + " ) " + updateQuery + " else " + insertQuery + " ";
                                insok = d2.update_method_wo_parameter(finalQuery, "Text");
                                insOK = true;

                                double amtVal = Convert.ToDouble(amt);
                                payAMTVal += amtVal;
                            }


                        }
                    }
                }
                #endregion
                if (!hideGridFeeAmt() || !hideGridDedAmt() || !hideGridTotAmt() || !hideGridPaidAmt())
                {
                    Txt_amt.Text = payAMTVal.ToString();
                }
                loadGridVendor();
            }
            else if (rbl_rollnoNew.SelectedIndex == 3)
            {
                string newVenCode = generateVendorCode().Trim();
                string staffId = Convert.ToString(txtroll_other.Text.Trim());
                string staffMob = Convert.ToString(txt_otherMobile.Text.Trim());

                try
                {
                    d2.update_method_wo_parameter("if not exists (select VendorCode from co_vendormaster where vendorname='" + staffId + "' and VendorMobileNo='" + staffMob + "'  and VendorType=-5) insert into co_vendormaster  (VendorCode,vendorname,VendorMobileNo,VendorAddress,VendorCity,VendorCompName,VendorType) values ('" + newVenCode + "','" + staffId + "','" + staffMob + "','" + txtAdd1_Other.Text.Trim() + "','" + txtAdd2_Other.Text.Trim() + "','" + txtname_other.Text.Trim() + "',-5) else update co_vendormaster set VendorAddress='" + txtAdd1_Other.Text.Trim() + "',VendorCity='" + txtAdd2_Other.Text.Trim() + "',VendorCompName='" + txtname_other.Text.Trim() + "'  where vendorname='" + staffId + "' and VendorMobileNo='" + staffMob + "'  and VendorType=-5 ", "Text");
                }
                catch (Exception ex) { d2.sendErrorMail(ex, collegecode1, "ChallanReceipt"); }
                newVenCode = d2.GetFunction("select VendorCode from co_vendormaster where vendorname='" + staffId + "' and VendorMobileNo='" + staffMob + "'  and VendorType=-5").Trim();
                if (newVenCode != "" && newVenCode != "0")
                {
                    #region Add Ledgers For Others
                    //Year or sem

                    string finYeaid = d2.getCurrentFinanceYear(usercode, collegecode1);
                    string venPk = d2.GetFunction("select VendorPK from co_vendormaster where VendorCode='" + newVenCode + "'  and VendorType=-5").Trim();
                    if (venPk != "" && venPk != "0")
                    {
                        for (row = 0; row < grid_HeaderLedger.Rows.Count; row++)
                        {
                            Label lbl_headerId = (Label)grid_HeaderLedger.Rows[row].FindControl("lbl_headeridpop");
                            Label lbl_fee_code = (Label)grid_HeaderLedger.Rows[row].FindControl("lbl_ledgeridpop");
                            Label lbl_fee_cat = (Label)grid_HeaderLedger.Rows[row].FindControl("lbl_legerpop");
                            TextBox txtNewLedger = (TextBox)grid_HeaderLedger.Rows[row].FindControl("txt_NewLedger");

                            string hid = lbl_headerId.Text;
                            string lid = lbl_fee_code.Text;
                            string lname = lbl_fee_cat.Text;
                            string amt = txtNewLedger.Text;

                            string text_circode = string.Empty;
                            string cursem = "0";

                            if (amt != "" && Convert.ToDouble(amt) != null && Convert.ToDouble(amt) != 0)
                            {
                                appno = venPk;

                                if (appno != "" && appno != "0")
                                {
                                    text_circode = cursem;
                                    string memtype = "1";
                                    switch (rbl_rollnoNew.SelectedIndex)
                                    {
                                        case 0:
                                            memtype = "1";
                                            break;
                                        case 1:
                                            memtype = "2";
                                            break;
                                        case 2:
                                            memtype = "3";
                                            break;
                                        case 3:
                                            memtype = "4"; ;
                                            break;
                                    }

                                    string selectQuery = "";
                                    string updateQuery = "";

                                    string insertQuery = " INSERT INTO FT_FeeAllot(AllotDate,MemType,PayMode,App_No,LedgerFK,HeaderFK,FeeAmount,TotalAmount,FeeCategory,BalAmount,FinYearFK,FromGovtAmt, DeductReason) VALUES('" + DateTime.Now.ToString("MM/dd/yyyy") + "'," + memtype + ",1," + appno + "," + lid + "," + hid + "," + amt + "," + amt + "," + text_circode + "," + amt + "," + finYeaid + ",0,0) ";

                                    selectQuery = " select * from FT_FeeAllot where LedgerFK in('" + lid + "') and HeaderFK in('" + hid + "') and FeeCategory in('" + text_circode + "')  and App_No in('" + appno + "') ";

                                    updateQuery = "  update FT_FeeAllot set AllotDate='" + DateTime.Now.ToString("MM/dd/yyyy") + "', MemType=" + memtype + ",FeeAmount=isnull(FeeAmount,0)+" + amt + ",BalAmount=isnull(BalAmount,0)+" + amt + ",TotalAmount=isnull(TotalAmount,0)+" + amt + " where LedgerFK in('" + lid + "') and HeaderFK in('" + hid + "') and FeeCategory in('" + text_circode + "')  and App_No in('" + appno + "') ";


                                    string finalQuery = " if exists ( " + selectQuery + " ) " + updateQuery + " else " + insertQuery + " ";
                                    insok = d2.update_method_wo_parameter(finalQuery, "Text");
                                    insOK = true;

                                    double amtVal = Convert.ToDouble(amt);
                                    payAMTVal += amtVal;
                                }
                            }
                        }
                    }
                    #endregion
                    if (!hideGridFeeAmt() || !hideGridDedAmt() || !hideGridTotAmt() || !hideGridPaidAmt())
                    {
                        Txt_amt.Text = payAMTVal.ToString();
                    }
                    loadGridOthers();
                }
            }
        }
        imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
        if (insOK)
        {
            btn_ledgersave.Visible = false;
            btn_ledgerExit.Visible = false;
            lbl_alert.Text = "Saved Sucessfully";
            div_HeaderLed.Attributes.Add("Style", "display:none");
        }
        else
        {
            if (isVal)
                lbl_alert.Text = "Please Select Term!";
            else
                lbl_alert.Text = "Not Saved";
            div_HeaderLed.Attributes.Add("Style", "display:block;");
        }

    }
    //Inventory Ledger fees
    protected void ddlLedgerInv_Indexchange(object sender, EventArgs e)
    {
        try
        {
            lblInvTotAmount.Text = "";
        }
        catch { }
    }
    public void ledgerbindInv()
    {
        try
        {
            ddlLedgerInv.Items.Clear();

            string query = "SELECT distinct LedgerPK,LedgerName FROM FM_LedgerMaster L,FS_LedgerPrivilage P WHERE L.LedgerPK = P.LedgerFK   AND P.CollegeCode = L.CollegeCode  and l.LedgerMode=0   AND P. UserCode = " + usercode + " AND L.CollegeCode = " + collegecode1 + "";

            ds = d2.select_method_wo_parameter(query, "Text");

            if (ds.Tables[0].Rows.Count > 0)
            {
                ddlLedgerInv.DataSource = ds;
                ddlLedgerInv.DataTextField = "LedgerName";
                ddlLedgerInv.DataValueField = "LedgerPK";
                ddlLedgerInv.DataBind();
            }
        }
        catch (Exception ex) { }
    }
    protected void cbItemHcInv_ChekedChange(object sender, EventArgs e)
    {
        CallCheckBoxChangedEvent(cblItemHcInv, cbItemHcInv, txtItemHcInv, "Item Header");

        itemSHdrBindInv();
        itemCodeBindInv();
        itemNameBindInv();
    }
    protected void cblItemHcInv_SelectedIndexChanged(object sender, EventArgs e)
    {
        CallCheckBoxListChangedEvent(cblItemHcInv, cbItemHcInv, txtItemHcInv, "Item Header");


        itemSHdrBindInv();
        itemCodeBindInv();
        itemNameBindInv();
    }
    public void itemHeadBindInv()
    {
        try
        {
            txtItemHcInv.Text = "Item Header";
            cbItemHcInv.Checked = false;
            cblItemHcInv.Items.Clear();

            //ds = d2.BindItemHeaderWithRights();
            //string deptCode = GetSelectedItemsValue(cblDeptInv);
            string storeCode = ddlStoreInv.Items.Count > 0 ? ddlStoreInv.SelectedValue : "0";
            if (storeCode.Trim() != "")
            {
                string selQ = "select distinct ItemHeaderCode ,ItemHeaderName   from IM_ItemDeptMaster ID ,IM_ItemMaster I where I.ItemPK =ID.ItemFK and ID.ItemDeptFK in (" + storeCode + ")";
                ds = d2.select_method_wo_parameter(selQ, "Text");

                if (ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
                {
                    cblItemHcInv.DataSource = ds;
                    cblItemHcInv.DataTextField = "ItemHeaderName";
                    cblItemHcInv.DataValueField = "ItemHeaderCode";
                    cblItemHcInv.DataBind();
                    for (int i = 0; i < cblItemHcInv.Items.Count; i++)
                    {
                        cblItemHcInv.Items[i].Selected = true;
                    }
                    txtItemHcInv.Text = "Item Header(" + cblItemHcInv.Items.Count + ")";
                    cbItemHcInv.Checked = true;
                }
            }
        }
        catch (Exception ex) { }
    }
    protected void cbItemSHcInv_ChekedChange(object sender, EventArgs e)
    {
        CallCheckBoxChangedEvent(cblItemSHcInv, cbItemSHcInv, txtItemSHcInv, "Item Sub Header");

        itemCodeBindInv();
        itemNameBindInv();
    }
    protected void cblItemSHcInv_SelectedIndexChanged(object sender, EventArgs e)
    {
        CallCheckBoxListChangedEvent(cblItemSHcInv, cbItemSHcInv, txtItemSHcInv, "Item Sub Header");

        itemCodeBindInv();
        itemNameBindInv();
    }
    public void itemSHdrBindInv()
    {
        try
        {
            txtItemSHcInv.Text = "Item Sub Header";
            cbItemSHcInv.Checked = false;
            cblItemSHcInv.Items.Clear();

            //string deptCode = GetSelectedItemsValue(cblDeptInv);
            string storeCode = ddlStoreInv.Items.Count > 0 ? ddlStoreInv.SelectedValue : "0";
            string itemheader = GetSelectedItemsValueAsString(cblItemHcInv);

            if (storeCode.Trim() != "" && itemheader.Trim() != "")
            {
                string query = "";
                query = "select distinct subheader_code ,T.MasterValue    from IM_ItemDeptMaster ID ,IM_ItemMaster I,CO_MasterValues T where I.ItemPK =ID.ItemFK and T.MasterCode =subheader_code and ID.ItemDeptFK in (" + storeCode + ") and ItemHeaderCode in ('" + itemheader + "')";
                ds.Clear();
                ds = d2.select_method_wo_parameter(query, "Text");

                if (ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
                {
                    cblItemSHcInv.DataSource = ds;
                    cblItemSHcInv.DataTextField = "MasterValue";
                    cblItemSHcInv.DataValueField = "subheader_code";
                    cblItemSHcInv.DataBind();
                    for (int i = 0; i < cblItemSHcInv.Items.Count; i++)
                    {
                        cblItemSHcInv.Items[i].Selected = true;
                    }
                    txtItemSHcInv.Text = "Item Sub Header(" + cblItemSHcInv.Items.Count + ")";
                    cbItemSHcInv.Checked = true;
                }
            }
        }
        catch (Exception ex) { }
    }
    protected void cbItemNmInv_ChekedChange(object sender, EventArgs e)
    {
        CallCheckBoxChangedEvent(cblItemNmInv, cbItemNmInv, txtItemNmInv, "Item Name");
    }
    protected void cblItemNmInv_SelectedIndexChanged(object sender, EventArgs e)
    {
        CallCheckBoxListChangedEvent(cblItemNmInv, cbItemNmInv, txtItemNmInv, "Item Name");
    }
    public void itemNameBindInv()
    {
        try
        {
            txtItemNmInv.Text = "Item Name";
            cbItemNmInv.Checked = false;
            cblItemNmInv.Items.Clear();

            //string deptCode = GetSelectedItemsValue(cblDeptInv);
            string storeCode = ddlStoreInv.Items.Count > 0 ? ddlStoreInv.SelectedValue : "0";
            string itemheader = GetSelectedItemsValueAsString(cblItemHcInv);
            string subheader = GetSelectedItemsValueAsString(cblItemSHcInv);
            string itemcode = GetSelectedItemsValueAsString(cblItemCdInv);

            if (storeCode.Trim() != "" && itemheader.Trim() != "" && subheader.Trim() != "" && itemcode.Trim() != "")
            {
                ds.Clear();
                string query = "select distinct ItemPK,ItemName  from IM_ItemDeptMaster ID ,IM_ItemMaster I where I.ItemPK =ID.ItemFK and ID.ItemDeptFK in (" + storeCode + ") and ItemHeaderCode in ('" + itemheader + "') and subheader_code in ('" + subheader + "')  and ItemPk in ('" + itemcode + "')";
                ds = d2.select_method_wo_parameter(query, "Text");
                if (ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
                {
                    cblItemNmInv.DataSource = ds;
                    cblItemNmInv.DataTextField = "ItemName";
                    cblItemNmInv.DataValueField = "ItemPK";
                    cblItemNmInv.DataBind();
                    for (int i = 0; i < cblItemCdInv.Items.Count; i++)
                    {
                        cblItemNmInv.Items[i].Selected = true;
                    }
                    txtItemNmInv.Text = "Item Name(" + cblItemNmInv.Items.Count + ")";
                    cbItemNmInv.Checked = true;
                }
            }
        }
        catch (Exception ex) { }
    }
    protected void cbItemCdInv_ChekedChange(object sender, EventArgs e)
    {
        CallCheckBoxChangedEvent(cblItemCdInv, cbItemCdInv, txtItemCdInv, "Item Code");
        itemNameBindInv();
    }
    protected void cblItemCdInv_SelectedIndexChanged(object sender, EventArgs e)
    {
        CallCheckBoxListChangedEvent(cblItemCdInv, cbItemCdInv, txtItemCdInv, "Item Code");
        itemNameBindInv();
    }
    public void itemCodeBindInv()
    {
        try
        {
            txtItemCdInv.Text = "Item Code";
            cbItemCdInv.Checked = false;
            cblItemCdInv.Items.Clear();

            //string deptCode = GetSelectedItemsValue(cblDeptInv);
            string storeCode = ddlStoreInv.Items.Count > 0 ? ddlStoreInv.SelectedValue : "0";
            string itemheader = GetSelectedItemsValueAsString(cblItemHcInv);
            string subheader = GetSelectedItemsValueAsString(cblItemSHcInv);

            if (storeCode.Trim() != "" && itemheader.Trim() != "" && subheader.Trim() != "")
            {
                string query = "select distinct ItemCode,ItemPk  from IM_ItemDeptMaster ID ,IM_ItemMaster I where I.ItemPK =ID.ItemFK and ID.ItemDeptFK in (" + storeCode + ") and ItemHeaderCode in ('" + itemheader + "') and subheader_code in ('" + subheader + "')";
                ds = d2.select_method_wo_parameter(query, "Text");

                if (ds.Tables[0].Rows.Count > 0)
                {
                    cblItemCdInv.DataSource = ds;
                    cblItemCdInv.DataTextField = "ItemCode";
                    cblItemCdInv.DataValueField = "ItemPk";
                    cblItemCdInv.DataBind();
                    for (int i = 0; i < cblItemCdInv.Items.Count; i++)
                    {
                        cblItemCdInv.Items[i].Selected = true;
                    }
                    txtItemCdInv.Text = "Item Code(" + cblItemCdInv.Items.Count + ")";
                    cbItemCdInv.Checked = true;
                }
            }
        }
        catch (Exception ex) { }
    }
    protected void cbDeptInv_CheckedChanged(object sender, EventArgs e)
    {
        //CallCheckBoxChangedEvent(cblDeptInv, cbDeptInv, txtDeptInv, "Department");
        itemHeadBindInv();
        itemSHdrBindInv();
        itemCodeBindInv();
        itemNameBindInv();
    }
    protected void cblDeptInv_SelectedIndexChanged(object sender, EventArgs e)
    {
        //CallCheckBoxListChangedEvent(cblDeptInv, cbDeptInv, txtDeptInv, "Department");
        itemHeadBindInv();
        itemSHdrBindInv();
        itemCodeBindInv();
        itemNameBindInv();
    }
    public void itemDeptBindInv()
    {
        try
        {
            //txtDeptInv.Text = "Department";
            //cbDeptInv.Checked = false;
            //cblDeptInv.Items.Clear();

            //string query = "select distinct Dept_code,Dept_Name from department where college_code= " + collegecode1 + "";
            //ds = d2.select_method_wo_parameter(query, "Text");

            //if (ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
            //{
            //    cblDeptInv.DataSource = ds;
            //    cblDeptInv.DataTextField = "Dept_Name";
            //    cblDeptInv.DataValueField = "Dept_code";
            //    cblDeptInv.DataBind();
            //    for (int i = 0; i < cblDeptInv.Items.Count; i++)
            //    {
            //        cblDeptInv.Items[i].Selected = true;
            //    }
            //    txtDeptInv.Text = "Department(" + cblDeptInv.Items.Count + ")";
            //    cbDeptInv.Checked = true;
            //}
        }
        catch (Exception ex) { }
    }
    protected void ddlStoreInv_Indexchange(object sender, EventArgs e)
    {
        try
        {
            itemHeadBindInv();
            itemSHdrBindInv();
            itemCodeBindInv();
            itemNameBindInv();
        }
        catch (Exception ex) { }
    }
    public void itemStoreBindInv()
    {
        try
        {
            ddlStoreInv.Items.Clear();
            // select StorePK,StoreName from IM_StoreMaster  where collegecode=13
            string query = "select distinct Dept_code,Dept_Name from department where college_code= " + collegecode1 + "";
            ds = d2.select_method_wo_parameter(query, "Text");

            if (ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
            {
                ddlStoreInv.DataSource = ds;
                ddlStoreInv.DataTextField = "Dept_Name";
                ddlStoreInv.DataValueField = "Dept_code";
                ddlStoreInv.DataBind();
            }
        }
        catch (Exception ex) { }
    }
    protected void ddlInvSearchHdr_Indexchange(object sender, EventArgs e)
    {
        txtInvSrchCode.Text = "";
        txtInvSrchName.Text = "";
        txtInvSrchCode.Visible = false;
        txtInvSrchName.Visible = false;
        lblInvTotAmount.Text = "";
        if (ddlInvSearchHdr.SelectedIndex == 0)
        {
            txtInvSrchCode.Visible = true;
        }
        else
        {
            txtInvSrchName.Visible = true;
        }
    }
    protected void gridInv_DataBound(object sender, EventArgs e)
    {
        foreach (GridViewRow row in gridInv.Rows)
        {
            TextBox txtAmt = (TextBox)row.FindControl("txtamtInv");
            txtAmt.Attributes.Add("readonly", "readonly");
        }
    }
    [System.Web.Services.WebMethod]
    [System.Web.Script.Services.ScriptMethod()]
    public static List<string> GetItemCode(string prefixText)
    {
        List<string> name = new List<string>();
        try
        {
            string query = "";
            WebService ws = new WebService();
            query = " select distinct ItemCode,ItemPk  from IM_ItemDeptMaster ID ,IM_ItemMaster I where I.ItemPK =ID.ItemFK  order by ItemCode asc";

            name = ws.Getname(query);
            return name;
        }
        catch { return name; }
    }
    [System.Web.Services.WebMethod]
    [System.Web.Script.Services.ScriptMethod()]
    public static List<string> GetItemName(string prefixText)
    {
        List<string> name = new List<string>();
        try
        {
            string query = "";
            WebService ws = new WebService();

            query = "select distinct ItemName,ItemPK  from IM_ItemDeptMaster ID ,IM_ItemMaster I where I.ItemPK =ID.ItemFK  order by ItemName asc";

            name = ws.Getname(query);
            return name;
        }
        catch { return name; }
    }
    protected void btnItemInvSearch_Click(object sender, EventArgs e)
    {
        try
        {
            try
            {
                //this.Form.DefaultButton = "btnItemInvSearch";
                DataTable tbl_Inv = new DataTable();
                tbl_Inv.Columns.Add("DeptId");
                tbl_Inv.Columns.Add("Dept");
                tbl_Inv.Columns.Add("ledgeId");
                tbl_Inv.Columns.Add("ledge");
                tbl_Inv.Columns.Add("ItemName");
                tbl_Inv.Columns.Add("ItemPk");
                tbl_Inv.Columns.Add("ItemCode");
                tbl_Inv.Columns.Add("ItemhcId");
                tbl_Inv.Columns.Add("Itemhc");
                tbl_Inv.Columns.Add("IssuedRPU");
                tbl_Inv.Columns.Add("ItemSHc");
                tbl_Inv.Columns.Add("Available");
                tbl_Inv.Columns.Add("Measure");
                tbl_Inv.Columns.Add("Quanti");
                tbl_Inv.Columns.Add("Amount");

                #region loadPrevData
                if (gridInv.Rows.Count > 0)
                {
                    //    Session["viwGridInv"] = gridInv;
                    //}
                    //if (Session["viwGridInv"] != null)
                    //{
                    //GridView viwGridInv = (GridView)Session["viwGridInv"];
                    foreach (GridViewRow grow in gridInv.Rows) //viwGridInv.Rows)
                    {
                        Label lbldeptCode = (Label)grow.FindControl("lbl_itemdeptidInv");
                        Label lbldept = (Label)grow.FindControl("lbl_itemdeptInv");
                        Label lblledgeId = (Label)grow.FindControl("lbl_itemledgeidInv");
                        Label lblledge = (Label)grow.FindControl("lbl_itemledgeInv");
                        Label lblhdrCode = (Label)grow.FindControl("lbl_itemhcidInv");
                        Label lblhdr = (Label)grow.FindControl("lbl_itemhcInv");
                        Label lblitemname = (Label)grow.FindControl("lbl_itemnameinv");
                        Label lblsubhdrCode = (Label)grow.FindControl("lbl_itemShcInv");
                        Label lblItempk = (Label)grow.FindControl("lbl_itemnoidInv");
                        Label lblItemCode = (Label)grow.FindControl("lbl_itemnoInv");

                        Label lblAvail = (Label)grow.FindControl("lbl_AvlInv");
                        Label lblMeasure = (Label)grow.FindControl("lbl_Msrnv");

                        TextBox txtQty = (TextBox)grow.FindControl("txtQtyInv");
                        Label txtRPU = (Label)grow.FindControl("lbl_RPUInv");
                        TextBox txtAmt = (TextBox)grow.FindControl("txtamtInv");

                        DataRow drInv = tbl_Inv.NewRow();
                        drInv["DeptId"] = lbldeptCode.Text;
                        drInv["Dept"] = lbldept.Text;
                        drInv["ledgeId"] = lblledgeId.Text;
                        drInv["ledge"] = lblledge.Text;
                        drInv["ItemName"] = lblitemname.Text;
                        drInv["ItemCode"] = lblItemCode.Text;
                        drInv["ItemPk"] = lblItempk.Text;
                        drInv["ItemhcId"] = lblhdrCode.Text;
                        drInv["Itemhc"] = lblhdr.Text;
                        drInv["IssuedRPU"] = txtRPU.Text;
                        drInv["ItemSHc"] = lblsubhdrCode.Text;
                        drInv["Available"] = lblAvail.Text;
                        drInv["Measure"] = lblMeasure.Text;
                        drInv["Quanti"] = txtQty.Text;
                        drInv["Amount"] = txtAmt.Text;
                        tbl_Inv.Rows.Add(drInv);
                    }
                }
                #endregion

                string ledgercode = ddlLedgerInv.Items.Count > 0 ? ddlLedgerInv.SelectedValue : string.Empty;
                string ledgerName = ddlLedgerInv.Items.Count > 0 ? ddlLedgerInv.SelectedItem.Text : string.Empty;
                //string deptCode = GetSelectedItemsValue(cblDeptInv);
                string storeCode = ddlStoreInv.Items.Count > 0 ? ddlStoreInv.SelectedValue : "0";
                string itemheader = GetSelectedItemsValueAsString(cblItemHcInv);
                string subheader = GetSelectedItemsValueAsString(cblItemSHcInv);
                string itemcode = GetSelectedItemsValueAsString(cblItemCdInv);
                string itemNm = GetSelectedItemsText(cblItemNmInv);
                //double Qty = Convert.ToDouble(txtQtyinv.Text.Trim());
                //double amt = Convert.ToDouble(txtAmtInv.Text.Trim());

                string query = "";
                if (ddlInvSearchHdr.SelectedIndex == 0 && txtInvSrchCode.Text.Trim() != "")
                {
                    query = "select ItemDeptFk, ItemPk, ItemHeaderCode, ItemHeaderName, ItemAcr, ItemName, ItemCode, subheader_code, dt.Dept_Name,isnull(IssuedRPU,0) as IssuedRPU ,I.ItemUnit,(isnull(s.issuedQty,0)-isnull(s.UsedQty,0)) as Available    from IM_ItemDeptMaster ID , IM_ItemMaster  I,Department dt ,IT_StockDeptDetail s  where s.DeptFK =dt.Dept_Code and s.DeptFK =ID.ItemDeptFK and s.ItemFK =i.ItemPK and dt.Dept_Code =id.ItemDeptFK and I.ItemPK =ID.ItemFK  and ID.ItemDeptFK='" + storeCode + "'   and ItemCode in ('" + txtInvSrchCode.Text.Trim() + "')";
                }
                else if (ddlInvSearchHdr.SelectedIndex == 1 && txtInvSrchName.Text.Trim() != "")
                {
                    query = "select ItemDeptFk, ItemPk, ItemHeaderCode, ItemHeaderName, ItemAcr, ItemName, ItemCode, subheader_code, dt.Dept_Name,isnull(IssuedRPU,0) as IssuedRPU ,I.ItemUnit,(isnull(s.issuedQty,0)-isnull(s.UsedQty,0)) as Available    from IM_ItemDeptMaster ID , IM_ItemMaster  I,Department dt ,IT_StockDeptDetail s  where s.DeptFK =dt.Dept_Code and s.DeptFK =ID.ItemDeptFK and s.ItemFK =i.ItemPK and dt.Dept_Code =id.ItemDeptFK and I.ItemPK =ID.ItemFK and ID.ItemDeptFK='" + storeCode + "'  and ItemName in ('" + txtInvSrchName.Text.Trim() + "')";
                }
                else
                {
                    query = "select ItemDeptFk, ItemPk, ItemHeaderCode, ItemHeaderName, ItemAcr, ItemName, ItemCode, subheader_code, dt.Dept_Name,isnull(IssuedRPU,0) as IssuedRPU ,I.ItemUnit,(isnull(s.issuedQty,0)-isnull(s.UsedQty,0)) as Available    from IM_ItemDeptMaster ID , IM_ItemMaster  I,Department dt ,IT_StockDeptDetail s  where s.DeptFK =dt.Dept_Code and s.DeptFK =ID.ItemDeptFK and s.ItemFK =i.ItemPK and dt.Dept_Code =id.ItemDeptFK and I.ItemPK =ID.ItemFK and ID.ItemDeptFK in (" + storeCode + ") and ItemHeaderCode in ('" + itemheader + "') and subheader_code in ('" + subheader + "')  and ItemPk in ('" + itemcode + "') and ItemName in ('" + itemNm + "')";
                }

                ds.Clear();
                ds = d2.select_method_wo_parameter(query, "Text");
                if (string.IsNullOrEmpty(ledgercode.Trim()))
                    ds.Clear();

                if ((ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0) || tbl_Inv.Rows.Count > 0)
                {
                    DataTable tblOldTable = new DataTable();
                    tblOldTable = tbl_Inv.Copy();
                    for (int i = 0; i < ds.Tables[0].Rows.Count; i++)
                    {
                        tblOldTable.DefaultView.RowFilter = " DeptId='" + Convert.ToString(ds.Tables[0].Rows[i]["ItemDeptFk"]) + "' and ItemPk='" + Convert.ToString(ds.Tables[0].Rows[i]["ItemPk"]) + "' and ledgeId='" + ledgercode + "'";
                        DataView dvAlrAvaChk = tblOldTable.DefaultView;
                        if (dvAlrAvaChk.Count == 0)
                        {
                            DataRow drInv = tbl_Inv.NewRow();
                            drInv["DeptId"] = Convert.ToString(ds.Tables[0].Rows[i]["ItemDeptFk"]);
                            drInv["Dept"] = Convert.ToString(ds.Tables[0].Rows[i]["Dept_Name"]);
                            drInv["ledgeId"] = ledgercode;
                            drInv["ledge"] = ledgerName;
                            drInv["ItemName"] = Convert.ToString(ds.Tables[0].Rows[i]["ItemName"]);
                            drInv["ItemCode"] = Convert.ToString(ds.Tables[0].Rows[i]["ItemCode"]);
                            drInv["ItemPk"] = Convert.ToString(ds.Tables[0].Rows[i]["ItemPk"]);
                            drInv["ItemhcId"] = Convert.ToString(ds.Tables[0].Rows[i]["ItemHeaderCode"]);
                            drInv["Itemhc"] = Convert.ToString(ds.Tables[0].Rows[i]["ItemHeaderName"]);
                            drInv["IssuedRPU"] = Convert.ToString(ds.Tables[0].Rows[i]["IssuedRPU"]);
                            drInv["ItemSHc"] = Convert.ToString(ds.Tables[0].Rows[i]["subheader_code"]);
                            drInv["Available"] = Convert.ToString(ds.Tables[0].Rows[i]["Available"]);
                            drInv["Measure"] = Convert.ToString(ds.Tables[0].Rows[i]["ItemUnit"]);
                            drInv["Quanti"] = "0";
                            drInv["Amount"] = "0.00";
                            tbl_Inv.Rows.Add(drInv);
                        }
                    }

                    gridInv.DataSource = tbl_Inv;
                    gridInv.DataBind();
                    gridInv.Visible = true;
                    btnInvSave.Visible = true;
                    btnInvExit.Visible = true;
                    btnInvDelete.Visible = true;
                    imgAlert.Attributes.Add("Style", " display:none;");
                }
                else
                {
                    gridInv.DataSource = null;
                    gridInv.DataBind();
                    btnInvSave.Visible = false;
                    btnInvExit.Visible = false;
                    btnInvDelete.Visible = false;
                    imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                    lbl_alert.Text = "No Records Found";
                }
            }
            catch (Exception ex)
            {
                d2.sendErrorMail(ex, collegecode1, "ChallanReceipt");
                gridInv.DataSource = null;
                gridInv.DataBind();
                btnInvSave.Visible = false;
                btnInvExit.Visible = false;
                btnInvDelete.Visible = false;
            }
        }
        catch (Exception ex)
        {
            d2.sendErrorMail(ex, collegecode1, "ChallanReceipt");
            gridInv.DataSource = null;
            gridInv.DataBind();
            btnInvSave.Visible = false;
            btnInvExit.Visible = false;
            btnInvDelete.Visible = false;
        }
    }
    protected void btnInvDelete_Click(object sender, EventArgs e)
    {
        try
        {
            DataTable tbl_Inv = new DataTable();
            tbl_Inv.Columns.Add("DeptId");
            tbl_Inv.Columns.Add("Dept");
            tbl_Inv.Columns.Add("ledgeId");
            tbl_Inv.Columns.Add("ledge");
            tbl_Inv.Columns.Add("ItemName");
            tbl_Inv.Columns.Add("ItemPk");
            tbl_Inv.Columns.Add("ItemCode");
            tbl_Inv.Columns.Add("ItemhcId");
            tbl_Inv.Columns.Add("Itemhc");
            tbl_Inv.Columns.Add("IssuedRPU");
            tbl_Inv.Columns.Add("ItemSHc");
            tbl_Inv.Columns.Add("Available");
            tbl_Inv.Columns.Add("Measure");
            tbl_Inv.Columns.Add("Quanti");
            tbl_Inv.Columns.Add("Amount");

            foreach (GridViewRow grow in gridInv.Rows)
            {
                CheckBox cbSelchk = (CheckBox)grow.FindControl("chkSel");

                if (!cbSelchk.Checked)
                {
                    Label lbldeptCode = (Label)grow.FindControl("lbl_itemdeptidInv");
                    Label lbldept = (Label)grow.FindControl("lbl_itemdeptInv");
                    Label lblledgeId = (Label)grow.FindControl("lbl_itemledgeidInv");
                    Label lblledge = (Label)grow.FindControl("lbl_itemledgeInv");
                    Label lblhdrCode = (Label)grow.FindControl("lbl_itemhcidInv");
                    Label lblhdr = (Label)grow.FindControl("lbl_itemhcInv");
                    Label lblitemname = (Label)grow.FindControl("lbl_itemnameinv");
                    Label lblsubhdrCode = (Label)grow.FindControl("lbl_itemShcInv");
                    Label lblItempk = (Label)grow.FindControl("lbl_itemnoidInv");
                    Label lblItemCode = (Label)grow.FindControl("lbl_itemnoInv");

                    Label lblAvail = (Label)grow.FindControl("lbl_AvlInv");
                    Label lblMeasure = (Label)grow.FindControl("lbl_Msrnv");

                    TextBox txtQty = (TextBox)grow.FindControl("txtQtyInv");
                    Label txtRPU = (Label)grow.FindControl("lbl_RPUInv");
                    TextBox txtAmt = (TextBox)grow.FindControl("txtamtInv");

                    DataRow drInv = tbl_Inv.NewRow();
                    drInv["DeptId"] = lbldeptCode.Text;
                    drInv["Dept"] = lbldept.Text;
                    drInv["ledgeId"] = lblledgeId.Text;
                    drInv["ledge"] = lblledge.Text;
                    drInv["ItemName"] = lblitemname.Text;
                    drInv["ItemCode"] = lblItemCode.Text;
                    drInv["ItemPk"] = lblItempk.Text;
                    drInv["ItemhcId"] = lblhdrCode.Text;
                    drInv["Itemhc"] = lblhdr.Text;
                    drInv["IssuedRPU"] = txtRPU.Text;
                    drInv["ItemSHc"] = lblsubhdrCode.Text;
                    drInv["Available"] = lblAvail.Text;
                    drInv["Measure"] = lblMeasure.Text;
                    drInv["Quanti"] = txtQty.Text;
                    drInv["Amount"] = txtAmt.Text;

                    tbl_Inv.Rows.Add(drInv);
                }
            }
            if (tbl_Inv.Rows.Count > 0)
            {
                gridInv.DataSource = tbl_Inv;
                gridInv.DataBind();
                gridInv.Visible = true;
                btnInvSave.Visible = true;
                btnInvExit.Visible = true;
                btnInvDelete.Visible = true;
                imgAlert.Attributes.Add("Style", " display:none;");
            }
            else
            {
                gridInv.DataSource = null;
                gridInv.DataBind();
                btnInvSave.Visible = false;
                btnInvExit.Visible = false;
                btnInvDelete.Visible = false;
                imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                lbl_alert.Text = "No Records Found";
            }
        }
        catch (Exception ex) { d2.sendErrorMail(ex, collegecode1, "ChallanReceipt"); }
    }
    private string getHeaderFk(string ledgerfk)
    {
        string headerfk = d2.GetFunction("select headerfk from fm_ledgermaster where ledgerpk=" + ledgerfk + " ").Trim();
        return headerfk;
    }
    protected void btnInvSave_Click(object sender, EventArgs e)
    {
        divInvConfirm.Visible = true;
    }
    protected void btnSaveNoInv_Click(object sender, EventArgs e)
    {
        divInvConfirm.Visible = false;
    }
    protected void btnSaveInv_Click(object sender, EventArgs e)
    {
        divInvConfirm.Visible = false;
        try
        {
            int insok = 0;
            bool insOK = false;
            imgAlert.Attributes.Add("Style", " display:none;");
            if (gridInv.Rows.Count > 0 && ddlLedgerInv.Items.Count > 0)
            {
                if (rbl_rollnoNew.SelectedIndex == 0)
                {
                    #region Add Ledgers For Student
                    //Year or sem
                    string linkvalue = string.Empty;
                    string rollno = txt_rollno.Text.Trim();

                    string settingquery = "select * from New_InsSettings where linkname = 'Fee Yearwise' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "'";
                    ds.Clear();
                    ds = d2.select_method_wo_parameter(settingquery, "Text");
                    if (ds.Tables[0].Rows.Count > 0)
                    {
                        linkvalue = Convert.ToString(ds.Tables[0].Rows[0]["LinkValue"]);
                    }
                    string finYeaid = d2.getCurrentFinanceYear(usercode, collegecode1);



                    if (linkvalue != "" && rollno != "")
                    {
                        for (row = 0; row < gridInv.Rows.Count; row++)
                        {

                            Label lbldeptCode = (Label)gridInv.Rows[row].FindControl("lbl_itemdeptidInv");
                            Label lblledgeId = (Label)gridInv.Rows[row].FindControl("lbl_itemledgeidInv");
                            Label lblledge = (Label)gridInv.Rows[row].FindControl("lbl_itemledgeInv");
                            Label lblhdrCode = (Label)gridInv.Rows[row].FindControl("lbl_itemhcidInv");
                            Label lblitemname = (Label)gridInv.Rows[row].FindControl("lbl_itemnameinv");
                            Label lblsubhdrCode = (Label)gridInv.Rows[row].FindControl("lbl_itemShcInv");
                            Label lblItempk = (Label)gridInv.Rows[row].FindControl("lbl_itemnoidInv");
                            Label lblItemCode = (Label)gridInv.Rows[row].FindControl("lbl_itemnoInv");

                            TextBox txtQty = (TextBox)gridInv.Rows[row].FindControl("txtQtyInv");
                            Label txtRPU = (Label)gridInv.Rows[row].FindControl("lbl_RPUInv");
                            TextBox txtAmt = (TextBox)gridInv.Rows[row].FindControl("txtamtInv");

                            int Qty = 0;
                            double RPU = 0;
                            double amt = 0;

                            int.TryParse(txtQty.Text, out Qty);
                            double.TryParse(txtRPU.Text, out RPU);
                            double.TryParse(txtAmt.Text, out amt);


                            string lid = lblledgeId.Text;//ddlLedgerInv.SelectedValue;
                            string lname = lblledge.Text;//ddlLedgerInv.SelectedItem.Text;
                            string hid = getHeaderFk(lid);

                            string text_circode = string.Empty;
                            string appno = string.Empty;
                            string seattype = string.Empty;
                            string cursem = string.Empty;
                            string batch_year = string.Empty;

                            if (amt > 0)
                            {

                                string seattypeCurQuery = " select seattype,r.Current_Semester,r.Batch_Year,a.app_no  from applyn a,Registration r where a.app_no=r.App_No  and a.college_code=" + collegecode1 + " ";

                                if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 0)
                                {
                                    //roll no
                                    seattypeCurQuery += "  and r.Roll_No =  '" + rollno + "' ";
                                }
                                else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 1)
                                {
                                    //reg no
                                    seattypeCurQuery += " and  R.Reg_No = '" + rollno + "' ";
                                }
                                else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 2)
                                {
                                    //Admin no
                                    seattypeCurQuery += " and  R.Roll_admit = '" + rollno + "' ";
                                }
                                else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 4)
                                {
                                    //Smart no
                                    seattypeCurQuery += " and  R.smart_serial_no = '" + rollno + "' ";
                                }
                                else
                                {

                                    seattypeCurQuery = "select seattype,batch_year,app_no from applyn where  college_code=" + collegecode1 + " and app_formno ='" + rollno + "'";
                                    cursem = "1";
                                    //appno = rollno;
                                }

                                //rollno = lblstaticrollno.Text;

                                DataSet dsSTYpe = new DataSet();
                                dsSTYpe = d2.select_method_wo_parameter(seattypeCurQuery, "Text");
                                if (dsSTYpe.Tables.Count > 0)
                                {
                                    if (dsSTYpe.Tables[0].Rows.Count > 0)
                                    {
                                        seattype = Convert.ToString(dsSTYpe.Tables[0].Rows[0]["seattype"]);
                                        batch_year = Convert.ToString(dsSTYpe.Tables[0].Rows[0]["batch_year"]);
                                        appno = Convert.ToString(dsSTYpe.Tables[0].Rows[0]["app_no"]);
                                        #region Add To Fee Allot
                                        if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) != 3)
                                        {
                                            cursem = Convert.ToString(dsSTYpe.Tables[0].Rows[0]["Current_Semester"]);
                                        }

                                        if (cursem != "" && seattype != "" && batch_year != "")
                                        {
                                            if (linkvalue == "0")
                                            {

                                                string semesterquery = "select * from textvaltable where TextCriteria = 'FEECA'and textval = '" + cursem + " Semester' and college_code=" + collegecode1 + " and textval not like '-1%' order by len(textval),textval asc";
                                                ds.Clear();
                                                ds = d2.select_method_wo_parameter(semesterquery, "Text");
                                                if (ds.Tables[0].Rows.Count > 0)
                                                {
                                                    text_circode = Convert.ToString(ds.Tables[0].Rows[0]["TextCode"]);
                                                }
                                            }
                                            else
                                            {

                                                cursem = returnYearforSem(cursem);
                                                string semesterquery = "select * from textvaltable where TextCriteria = 'FEECA'and textval = '" + cursem + " Year' and college_code=" + collegecode1 + " and textval not like '-1%' order by len(textval),textval asc";
                                                ds.Clear();
                                                ds = d2.select_method_wo_parameter(semesterquery, "Text");
                                                if (ds.Tables[0].Rows.Count > 0)
                                                {
                                                    text_circode = Convert.ToString(ds.Tables[0].Rows[0]["TextCode"]);

                                                }
                                            }

                                            if (text_circode != "")
                                            {
                                                string selectQuery = "";
                                                string updateQuery = "";

                                                string insertQuery = " INSERT INTO FT_FeeAllot(AllotDate,MemType,PayMode,App_No,LedgerFK,HeaderFK,FeeAmount,TotalAmount,FeeCategory,BalAmount,FinYearFK,FromGovtAmt, DeductReason) VALUES('" + DateTime.Now.ToString("MM/dd/yyyy") + "',1,1," + appno + "," + lid + "," + hid + "," + amt + "," + amt + "," + text_circode + "," + amt + "," + finYeaid + ",0,0) ";

                                                selectQuery = " select * from FT_FeeAllot where LedgerFK in('" + lid + "') and HeaderFK in('" + hid + "') and FeeCategory in('" + text_circode + "') and  FinYearFK='" + finYeaid + "' and App_No in('" + appno + "') ";

                                                updateQuery = "  update FT_FeeAllot set AllotDate='" + DateTime.Now.ToString("MM/dd/yyyy") + "', MemType=1,FeeAmount=isnull(FeeAmount,0)+" + amt + ",BalAmount=isnull(BalAmount,0)+" + amt + ",TotalAmount=isnull(TotalAmount,0)+" + amt + " where LedgerFK in('" + lid + "') and HeaderFK in('" + hid + "') and FeeCategory in('" + text_circode + "') and  FinYearFK='" + finYeaid + "' and App_No in('" + appno + "') ";


                                                string finalQuery = " if exists ( " + selectQuery + " ) " + updateQuery + " else " + insertQuery + " ";
                                                insok = d2.update_method_wo_parameter(finalQuery, "Text");

                                                string insItem = "if exists (select App_No from Indivitual_student_ItemIssue  where MemType=1 and  App_no=" + appno + " and LedgerFK='" + lid + "' and  ItemFK='" + lblItempk.Text + "' and DeptFK='" + lbldeptCode.Text + "' and feecategory='" + text_circode + "' )  update Indivitual_student_ItemIssue set Quantity=Quantity+" + Qty + " ,Rpu=+" + RPU + " where MemType=1 and  App_no=" + appno + " and LedgerFK='" + lid + "' and  ItemFK='" + lblItempk.Text + "' and DeptFK='" + lbldeptCode.Text + "'  and feecategory='" + text_circode + "'  else insert into Indivitual_student_ItemIssue(AllotDate ,MemType ,App_no ,LedgerFK ,ItemFK ,DeptFK ,Quantity ,Rpu , feecategory) values('" + DateTime.Now.Date + "' ,1 ," + appno + " ,'" + lid + "','" + lblItempk.Text + "' ,'" + lbldeptCode.Text + "' ," + Qty + " ," + RPU + ",'" + text_circode + "')";
                                                insok = d2.update_method_wo_parameter(insItem, "Text");
                                                insOK = true;
                                            }

                                        }
                                        #endregion

                                    }
                                }

                            }
                        }
                    }
                    #endregion
                    loadGridStudent();
                }
                else if (rbl_rollnoNew.SelectedIndex == 1)
                {
                    #region Add Ledgers For Staff
                    //Year or sem
                    string rollno = txtroll_staff.Text.Trim();
                    string finYeaid = d2.getCurrentFinanceYear(usercode, collegecode1);

                    if (rollno != "")
                    {
                        for (row = 0; row < gridInv.Rows.Count; row++)
                        {
                            Label lbldeptCode = (Label)gridInv.Rows[row].FindControl("lbl_itemdeptidInv");
                            Label lblledgeId = (Label)gridInv.Rows[row].FindControl("lbl_itemledgeidInv");
                            Label lblledge = (Label)gridInv.Rows[row].FindControl("lbl_itemledgeInv");
                            Label lblhdrCode = (Label)gridInv.Rows[row].FindControl("lbl_itemhcidInv");
                            Label lblitemname = (Label)gridInv.Rows[row].FindControl("lbl_itemnameinv");
                            Label lblsubhdrCode = (Label)gridInv.Rows[row].FindControl("lbl_itemShcInv");
                            Label lblItempk = (Label)gridInv.Rows[row].FindControl("lbl_itemnoidInv");
                            Label lblItemCode = (Label)gridInv.Rows[row].FindControl("lbl_itemnoInv");

                            TextBox txtQty = (TextBox)gridInv.Rows[row].FindControl("txtQtyInv");
                            Label txtRPU = (Label)gridInv.Rows[row].FindControl("lbl_RPUInv");
                            TextBox txtAmt = (TextBox)gridInv.Rows[row].FindControl("txtamtInv");

                            int Qty = 0;
                            double RPU = 0;
                            double amt = 0;

                            int.TryParse(txtQty.Text, out Qty);
                            double.TryParse(txtRPU.Text, out RPU);
                            double.TryParse(txtAmt.Text, out amt);


                            string lid = lblledgeId.Text;//ddlLedgerInv.SelectedValue;
                            string lname = lblledge.Text;//ddlLedgerInv.SelectedItem.Text;
                            string hid = getHeaderFk(lid);

                            string text_circode = string.Empty;
                            string appno = string.Empty;
                            string cursem = "0";

                            if (amt > 0)
                            {
                                appno = d2.GetFunction("select a.appl_id from staffmaster s,staff_appl_master a where s.appl_no=a.appl_no and s.staff_code='" + rollno + "' and s.college_code=" + collegecode1 + " ");

                                if (appno != "" && appno != "0")
                                {
                                    text_circode = cursem;
                                    string memtype = "1";
                                    switch (rbl_rollnoNew.SelectedIndex)
                                    {
                                        case 0:
                                            memtype = "1";
                                            break;
                                        case 1:
                                            memtype = "2";
                                            break;
                                        case 2:
                                            memtype = "3";
                                            break;
                                        case 3:
                                            memtype = "4"; ;
                                            break;
                                    }

                                    string selectQuery = "";
                                    string updateQuery = "";

                                    string insertQuery = " INSERT INTO FT_FeeAllot(AllotDate,MemType,PayMode,App_No,LedgerFK,HeaderFK,FeeAmount,TotalAmount,FeeCategory,BalAmount,FinYearFK,FromGovtAmt, DeductReason) VALUES('" + DateTime.Now.ToString("MM/dd/yyyy") + "'," + memtype + ",1," + appno + "," + lid + "," + hid + "," + amt + "," + amt + "," + text_circode + "," + amt + "," + finYeaid + ",0,0) ";

                                    selectQuery = " select * from FT_FeeAllot where LedgerFK in('" + lid + "') and HeaderFK in('" + hid + "') and FeeCategory in('" + text_circode + "') and  FinYearFK='" + finYeaid + "' and App_No in('" + appno + "') ";

                                    updateQuery = "  update FT_FeeAllot set AllotDate='" + DateTime.Now.ToString("MM/dd/yyyy") + "', MemType=" + memtype + ",FeeAmount=isnull(FeeAmount,0)+" + amt + ",BalAmount=isnull(BalAmount,0)+" + amt + ",TotalAmount=isnull(TotalAmount,0)+" + amt + " where LedgerFK in('" + lid + "') and HeaderFK in('" + hid + "') and FeeCategory in('" + text_circode + "') and  FinYearFK='" + finYeaid + "' and App_No in('" + appno + "') ";


                                    string finalQuery = " if exists ( " + selectQuery + " ) " + updateQuery + " else " + insertQuery + " ";
                                    insok = d2.update_method_wo_parameter(finalQuery, "Text");

                                    string insItem = "if exists (select App_No from Indivitual_student_ItemIssue  where MemType=" + memtype + " and  App_no=" + appno + " and LedgerFK='" + lid + "' and  ItemFK='" + lblItempk.Text + "' and DeptFK='" + lbldeptCode.Text + "'  and feecategory='" + text_circode + "' )  update Indivitual_student_ItemIssue set Quantity=Quantity+" + Qty + " ,Rpu=+" + RPU + " where MemType=" + memtype + " and  App_no=" + appno + " and LedgerFK='" + lid + "' and  ItemFK='" + lblItempk.Text + "' and DeptFK='" + lbldeptCode.Text + "'  and feecategory='" + text_circode + "'  else insert into Indivitual_student_ItemIssue(AllotDate ,MemType ,App_no ,LedgerFK ,ItemFK ,DeptFK ,Quantity ,Rpu , feecategory) values('" + DateTime.Now.Date + "' ," + memtype + " ," + appno + " ,'" + lid + "','" + lblItempk.Text + "' ,'" + lbldeptCode.Text + "' ," + Qty + " ," + RPU + ",'" + text_circode + "')";
                                    insok = d2.update_method_wo_parameter(insItem, "Text");
                                    insOK = true;
                                }
                            }
                        }
                    }
                    #endregion
                    loadGridStaff();
                }
                else if (rbl_rollnoNew.SelectedIndex == 2)
                {
                    #region Add Ledgers For Vendor
                    //Year or sem
                    string rollno = txtname_vendor.Text.Trim();
                    try
                    {
                        rollno = rollno.Split('-')[2];
                    }
                    catch { rollno = ""; }
                    string finYeaid = d2.getCurrentFinanceYear(usercode, collegecode1);

                    if (rollno != "")
                    {
                        for (row = 0; row < gridInv.Rows.Count; row++)
                        {
                            Label lbldeptCode = (Label)gridInv.Rows[row].FindControl("lbl_itemdeptidInv");
                            Label lblledgeId = (Label)gridInv.Rows[row].FindControl("lbl_itemledgeidInv");
                            Label lblledge = (Label)gridInv.Rows[row].FindControl("lbl_itemledgeInv");
                            Label lblhdrCode = (Label)gridInv.Rows[row].FindControl("lbl_itemhcidInv");
                            Label lblitemname = (Label)gridInv.Rows[row].FindControl("lbl_itemnameinv");
                            Label lblsubhdrCode = (Label)gridInv.Rows[row].FindControl("lbl_itemShcInv");
                            Label lblItempk = (Label)gridInv.Rows[row].FindControl("lbl_itemnoidInv");
                            Label lblItemCode = (Label)gridInv.Rows[row].FindControl("lbl_itemnoInv");

                            TextBox txtQty = (TextBox)gridInv.Rows[row].FindControl("txtQtyInv");
                            Label txtRPU = (Label)gridInv.Rows[row].FindControl("lbl_RPUInv");
                            TextBox txtAmt = (TextBox)gridInv.Rows[row].FindControl("txtamtInv");

                            int Qty = 0;
                            double RPU = 0;
                            double amt = 0;

                            int.TryParse(txtQty.Text, out Qty);
                            double.TryParse(txtRPU.Text, out RPU);
                            double.TryParse(txtAmt.Text, out amt);

                            string lid = lblledgeId.Text;//ddlLedgerInv.SelectedValue;
                            string lname = lblledge.Text;// ddlLedgerInv.SelectedItem.Text;
                            string hid = getHeaderFk(lid);

                            string text_circode = string.Empty;
                            string appno = string.Empty;
                            string cursem = "0";


                            if (amt > 0)
                            {
                                appno = rollno;
                                if (appno != "" && appno != "0")
                                {
                                    text_circode = cursem;
                                    string memtype = "1";
                                    switch (rbl_rollnoNew.SelectedIndex)
                                    {
                                        case 0:
                                            memtype = "1";
                                            break;
                                        case 1:
                                            memtype = "2";
                                            break;
                                        case 2:
                                            memtype = "3";
                                            break;
                                        case 3:
                                            memtype = "4"; ;
                                            break;
                                    }

                                    string selectQuery = "";
                                    string updateQuery = "";

                                    string insertQuery = " INSERT INTO FT_FeeAllot(AllotDate,MemType,PayMode,App_No,LedgerFK,HeaderFK,FeeAmount,TotalAmount,FeeCategory,BalAmount,FinYearFK,FromGovtAmt, DeductReason) VALUES('" + DateTime.Now.ToString("MM/dd/yyyy") + "'," + memtype + ",1," + appno + "," + lid + "," + hid + "," + amt + "," + amt + "," + text_circode + "," + amt + "," + finYeaid + ",0,0) ";

                                    selectQuery = " select * from FT_FeeAllot where LedgerFK in('" + lid + "') and HeaderFK in('" + hid + "') and FeeCategory in('" + text_circode + "') and  FinYearFK='" + finYeaid + "' and App_No in('" + appno + "') ";

                                    updateQuery = "  update FT_FeeAllot set AllotDate='" + DateTime.Now.ToString("MM/dd/yyyy") + "', MemType=" + memtype + ",FeeAmount=isnull(FeeAmount,0)+" + amt + ",BalAmount=isnull(BalAmount,0)+" + amt + ",TotalAmount=isnull(TotalAmount,0)+" + amt + " where LedgerFK in('" + lid + "') and HeaderFK in('" + hid + "') and FeeCategory in('" + text_circode + "') and  FinYearFK='" + finYeaid + "' and App_No in('" + appno + "') ";


                                    string finalQuery = " if exists ( " + selectQuery + " ) " + updateQuery + " else " + insertQuery + " ";
                                    insok = d2.update_method_wo_parameter(finalQuery, "Text");

                                    string insItem = "if exists (select App_No from Indivitual_student_ItemIssue  where MemType=" + memtype + " and  App_no=" + appno + " and LedgerFK='" + lid + "' and  ItemFK='" + lblItempk.Text + "' and DeptFK='" + lbldeptCode.Text + "'  and feecategory='" + text_circode + "')  update Indivitual_student_ItemIssue set Quantity=Quantity+" + Qty + " ,Rpu=+" + RPU + " where MemType=" + memtype + " and  App_no=" + appno + " and LedgerFK='" + lid + "' and  ItemFK='" + lblItempk.Text + "' and DeptFK='" + lbldeptCode.Text + "' and feecategory='" + text_circode + "'  else insert into Indivitual_student_ItemIssue(AllotDate ,MemType ,App_no ,LedgerFK ,ItemFK ,DeptFK ,Quantity ,Rpu , feecategory) values('" + DateTime.Now.Date + "' ," + memtype + " ," + appno + " ,'" + lid + "','" + lblItempk.Text + "' ,'" + lbldeptCode.Text + "' ," + Qty + " ," + RPU + ",'" + text_circode + "')";
                                    insok = d2.update_method_wo_parameter(insItem, "Text");
                                    insOK = true;

                                }


                            }
                        }
                    }
                    #endregion
                    loadGridVendor();
                }
                else if (rbl_rollnoNew.SelectedIndex == 3)
                {
                    string newVenCode = generateVendorCode().Trim();
                    string staffId = Convert.ToString(txtroll_other.Text.Trim());
                    string staffMob = Convert.ToString(txt_otherMobile.Text.Trim());
                    try
                    {
                        d2.update_method_wo_parameter("if not exists (select VendorCode from co_vendormaster where vendorname='" + staffId + "' and VendorMobileNo='" + staffMob + "'  and VendorType=-5) insert into co_vendormaster  (VendorCode,vendorname,VendorMobileNo,VendorAddress,VendorCity,VendorCompName,VendorType) values ('" + newVenCode + "','" + staffId + "','" + staffMob + "','" + txtAdd1_Other.Text.Trim() + "','" + txtAdd2_Other.Text.Trim() + "','" + txtname_other.Text.Trim() + "',-5) else update co_vendormaster set VendorAddress='" + txtAdd1_Other.Text.Trim() + "',VendorCity='" + txtAdd2_Other.Text.Trim() + "',VendorCompName='" + txtname_other.Text.Trim() + "'  where vendorname='" + staffId + "' and VendorMobileNo='" + staffMob + "'  and VendorType=-5 ", "Text");
                    }
                    catch (Exception ex) { d2.sendErrorMail(ex, collegecode1, "ChallanReceipt"); }
                    newVenCode = d2.GetFunction("select VendorCode from co_vendormaster where vendorname='" + staffId + "' and VendorMobileNo='" + staffMob + "'  and VendorType=-5").Trim();
                    if (newVenCode != "" && newVenCode != "0")
                    {
                        #region Add Ledgers For Others
                        //Year or sem

                        string finYeaid = d2.getCurrentFinanceYear(usercode, collegecode1);
                        string venPk = d2.GetFunction("select VendorPK from co_vendormaster where VendorCode='" + newVenCode + "'  and VendorType=-5").Trim();
                        if (venPk != "" && venPk != "0")
                        {
                            for (row = 0; row < gridInv.Rows.Count; row++)
                            {
                                Label lbldeptCode = (Label)gridInv.Rows[row].FindControl("lbl_itemdeptidInv");
                                Label lblledgeId = (Label)gridInv.Rows[row].FindControl("lbl_itemledgeidInv");
                                Label lblledge = (Label)gridInv.Rows[row].FindControl("lbl_itemledgeInv");
                                Label lblhdrCode = (Label)gridInv.Rows[row].FindControl("lbl_itemhcidInv");
                                Label lblitemname = (Label)gridInv.Rows[row].FindControl("lbl_itemnameinv");
                                Label lblsubhdrCode = (Label)gridInv.Rows[row].FindControl("lbl_itemShcInv");
                                Label lblItempk = (Label)gridInv.Rows[row].FindControl("lbl_itemnoidInv");
                                Label lblItemCode = (Label)gridInv.Rows[row].FindControl("lbl_itemnoInv");

                                TextBox txtQty = (TextBox)gridInv.Rows[row].FindControl("txtQtyInv");
                                Label txtRPU = (Label)gridInv.Rows[row].FindControl("lbl_RPUInv");
                                TextBox txtAmt = (TextBox)gridInv.Rows[row].FindControl("txtamtInv");

                                int Qty = 0;
                                double RPU = 0;
                                double amt = 0;

                                int.TryParse(txtQty.Text, out Qty);
                                double.TryParse(txtRPU.Text, out RPU);
                                double.TryParse(txtAmt.Text, out amt);


                                string lid = lblledgeId.Text;//ddlLedgerInv.SelectedValue;
                                string lname = lblledge.Text;//ddlLedgerInv.SelectedItem.Text;
                                string hid = getHeaderFk(lid);

                                string text_circode = string.Empty;
                                string appno = string.Empty;
                                string cursem = "0";

                                if (amt > 0)
                                {
                                    appno = venPk;

                                    if (appno != "" && appno != "0")
                                    {
                                        text_circode = cursem;
                                        string memtype = "1";
                                        switch (rbl_rollnoNew.SelectedIndex)
                                        {
                                            case 0:
                                                memtype = "1";
                                                break;
                                            case 1:
                                                memtype = "2";
                                                break;
                                            case 2:
                                                memtype = "3";
                                                break;
                                            case 3:
                                                memtype = "4"; ;
                                                break;
                                        }

                                        string selectQuery = "";
                                        string updateQuery = "";

                                        string insertQuery = " INSERT INTO FT_FeeAllot(AllotDate,MemType,PayMode,App_No,LedgerFK,HeaderFK,FeeAmount,TotalAmount,FeeCategory,BalAmount,FinYearFK,FromGovtAmt, DeductReason) VALUES('" + DateTime.Now.ToString("MM/dd/yyyy") + "'," + memtype + ",1," + appno + "," + lid + "," + hid + "," + amt + "," + amt + "," + text_circode + "," + amt + "," + finYeaid + ",0,0) ";

                                        selectQuery = " select * from FT_FeeAllot where LedgerFK in('" + lid + "') and HeaderFK in('" + hid + "') and FeeCategory in('" + text_circode + "') and  FinYearFK='" + finYeaid + "' and App_No in('" + appno + "') ";

                                        updateQuery = "  update FT_FeeAllot set AllotDate='" + DateTime.Now.ToString("MM/dd/yyyy") + "', MemType=" + memtype + ",FeeAmount=isnull(FeeAmount,0)+" + amt + ",BalAmount=isnull(BalAmount,0)+" + amt + ",TotalAmount=isnull(TotalAmount,0)+" + amt + " where LedgerFK in('" + lid + "') and HeaderFK in('" + hid + "') and FeeCategory in('" + text_circode + "') and  FinYearFK='" + finYeaid + "' and App_No in('" + appno + "') ";


                                        string finalQuery = " if exists ( " + selectQuery + " ) " + updateQuery + " else " + insertQuery + " ";
                                        insok = d2.update_method_wo_parameter(finalQuery, "Text");

                                        string insItem = "if exists (select App_No from Indivitual_student_ItemIssue  where MemType=" + memtype + " and  App_no=" + appno + " and LedgerFK='" + lid + "' and  ItemFK='" + lblItempk.Text + "' and DeptFK='" + lbldeptCode.Text + "' and feecategory='" + text_circode + "' )  update Indivitual_student_ItemIssue set Quantity=Quantity+" + Qty + " ,Rpu=+" + RPU + " where MemType=" + memtype + " and  App_no=" + appno + " and LedgerFK='" + lid + "' and  ItemFK='" + lblItempk.Text + "' and DeptFK='" + lbldeptCode.Text + "' and feecategory='" + text_circode + "'  else insert into Indivitual_student_ItemIssue(AllotDate ,MemType ,App_no ,LedgerFK ,ItemFK ,DeptFK ,Quantity ,Rpu , feecategory) values('" + DateTime.Now.Date + "' ," + memtype + " ," + appno + " ,'" + lid + "','" + lblItempk.Text + "' ,'" + lbldeptCode.Text + "' ," + Qty + " ," + RPU + ",'" + text_circode + "')";
                                        insok = d2.update_method_wo_parameter(insItem, "Text");
                                        insOK = true;
                                    }
                                }
                            }
                        }
                        #endregion
                        loadGridOthers();
                    }
                }
            }

            imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
            if (insOK)
            {
                lbl_alert.Text = "Saved Sucessfully";
            }
            else
            {
                lbl_alert.Text = "Not Saved";
            }
            div_HeaderLed.Visible = false;
        }
        catch (Exception ex)
        {
            d2.sendErrorMail(ex, collegecode1, "ChallanReceipt");
        }
    }
    protected void btnhisgo_Click(object sender, EventArgs e)
    {
        try
        {
            studHistroy();
            if (gridHist.Rows.Count < 1)
            {
                gridHist.DataSource = null;
                gridHist.DataBind();
                //   div_History.Visible = false;
                imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                lbl_alert.Text = "No Records Found";
            }
            else
            {
                div_History.Attributes.Add("Style", "display:block");
                gridHist.Attributes.Add("Style", "display:block");
                imgAlert.Attributes.Add("Style", " display:none;");
            }
        }
        catch { }

    }

    protected void studHistroy()
    {
        try
        {
            //this.Form.DefaultButton = "btnhisgo";
            string appno = string.Empty;
            if (rbl_rollnoNew.SelectedIndex == 0)
            {
                string appQ = "select r.app_no from applyn a, Registration r where a.app_no=r.App_No  and r.college_code='" + collegecode1 + "'  ";
                if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 0)
                    appQ += " and  r.Roll_No='" + txt_rollno.Text.Trim() + "'";
                else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 1)
                    appQ += " and  r.Reg_No='" + txt_rollno.Text.Trim() + "'";
                else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 2)
                    appQ += " and  r.Roll_Admit='" + txt_rollno.Text.Trim() + "'";
                else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 4)
                    appQ += " and  r.smart_serial_no='" + txt_rollno.Text.Trim() + "'";
                else
                    appQ = "select app_no from applyn a where app_formno='" + txt_rollno.Text.Trim() + "'  and a.college_code='" + collegecode1 + "' ";

                appno = d2.GetFunction(appQ);
            }
            else if (rbl_rollnoNew.SelectedIndex == 1)
            {
                appno = d2.GetFunction("select a.appl_id from staffmaster s,staff_appl_master a where s.appl_no=a.appl_no and s.staff_code='" + txtroll_staff.Text.Trim() + "' and s.college_code=" + collegecode1 + " ");
            }
            else if (rbl_rollnoNew.SelectedIndex == 2)
            {
                try
                {
                    appno = txtroll_vendor.Text.Trim().Split('-')[2];
                }
                catch { appno = ""; }
            }
            else if (rbl_rollnoNew.SelectedIndex == 3)
            {
                try
                {
                    string staffId = Convert.ToString(txtroll_other.Text.Trim());
                    string staffMob = Convert.ToString(txt_otherMobile.Text.Trim());

                    appno = d2.GetFunction("select VendorPK from co_vendormaster where vendorname='" + staffId + "' and VendorMobileNo='" + staffMob + "'  and VendorType=-5").Trim();
                }
                catch { }
            }

            DataTable tbl_Ledger = new DataTable();
            tbl_Ledger.Columns.Add("S.No");
            tbl_Ledger.Columns.Add("Date");
            tbl_Ledger.Columns.Add("Receipt No");
            tbl_Ledger.Columns.Add("PaymentMode");
            tbl_Ledger.Columns.Add("Cheque/DD/ ChallanNo");
            tbl_Ledger.Columns.Add("HeaderName");
            tbl_Ledger.Columns.Add("LedgerName");
            tbl_Ledger.Columns.Add("Total");
            tbl_Ledger.Columns.Add("Paid");
            tbl_Ledger.Columns.Add("Balance");
            tbl_Ledger.Columns.Add("Year/Sem");
            if (appno != "" && appno != "0")
            {
                string query = " select headername,ledgername,sum(totalamount) allot,sum(BalAmount) bal,a.FeeCategory,a.HeaderFK,l.LedgerPK from FT_FeeAllot a, FM_HeaderMaster h, FM_LedgerMaster l where a.HeaderFK = h.HeaderPK  and a.LedgerFK = l.LedgerPK  and h.HeaderPK = l.HeaderFK  and l.LedgerMode=0 and h.hd_miscellaneous='1'  and a.App_No='" + appno + "' and h.collegecode='" + collegecode1 + "'  group by a.App_No,HeaderName,LedgerName,a.FeeCategory,a.HeaderFK,l.LedgerPK   ";
                //and a.HeaderFk in ('" + itemheadercode + "') and a.LedgerFK in (" + ledgercode + ")
                ds.Clear();
                ds = d2.select_method_wo_parameter(query, "Text");
                int sno = 1;
                if (ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
                {
                    for (int i = 0; i < ds.Tables[0].Rows.Count; i++)
                    {
                        string hid = Convert.ToString(ds.Tables[0].Rows[i]["HeaderFK"]);
                        string lid = Convert.ToString(ds.Tables[0].Rows[i]["LedgerPK"]);
                        string FeeCategory = Convert.ToString(ds.Tables[0].Rows[i]["FeeCategory"]);
                        query = " select Convert(varchar(10),TransDate,103) as TransDate,TransCode,case when D.PayMode = 1 THEN 'Cash' WHEN D.PayMode = 2 THEN 'Cheque' when D.PayMode = 3 then 'DD' when D.PayMode = 4 then 'Challan'  when D.PayMode = 5 then 'Online' when D.PayMode = 6 then 'Card' end paymode,SUM(debit) paid,DDNo from FT_FinDailyTransaction d,FM_HeaderMaster h,FM_LedgerMaster l where d.HeaderFK = h.HeaderPK and d.LedgerFK = l.LedgerPK and h.HeaderPK = L.HeaderFK   and l.LedgerMode=0 and  d.App_No='" + appno + "' and h.HeaderPK in (" + hid + ") and d.LedgerFK =" + lid + " and d.FeeCategory =" + FeeCategory + " and h.collegecode='" + collegecode1 + "' and isnull(iscanceled,'0')='0' and h.hd_miscellaneous='1' group by TransDate,TransCode,D.App_No,HeaderName,LedgerName,D.PayMode,DDNo ";
                        DataSet ds2 = new DataSet();
                        ds2 = d2.select_method_wo_parameter(query, "Text");
                        if (ds2.Tables.Count > 0 && ds2.Tables[0].Rows.Count > 0)
                        {

                            FeeCategory = d2.GetFunction("select textval from TextValTable where TextCode=" + FeeCategory + " and college_code=" + collegecode1 + "");

                            for (int mul = 0; mul < ds2.Tables[0].Rows.Count; mul++)
                            {
                                DataRow drLedger = tbl_Ledger.NewRow();
                                drLedger["S.No"] = sno;
                                drLedger["HeaderName"] = Convert.ToString(ds.Tables[0].Rows[i]["HeaderName"]);
                                drLedger["ledgername"] = Convert.ToString(ds.Tables[0].Rows[i]["ledgername"]);
                                drLedger["Year/Sem"] = FeeCategory;
                                drLedger["Total"] = Convert.ToString(ds.Tables[0].Rows[i]["allot"]);
                                drLedger["Date"] = Convert.ToString(ds2.Tables[0].Rows[0]["TransDate"]);
                                drLedger["Receipt No"] = Convert.ToString(ds2.Tables[0].Rows[mul]["TransCode"]);
                                drLedger["PaymentMode"] = Convert.ToString(ds2.Tables[0].Rows[mul]["paymode"]);
                                drLedger["Paid"] = Convert.ToString(ds2.Tables[0].Rows[mul]["paid"]);
                                drLedger["Balance"] = Convert.ToString(ds.Tables[0].Rows[i]["bal"]);
                                drLedger["Cheque/DD/ ChallanNo"] = Convert.ToString(ds2.Tables[0].Rows[mul]["ddno"]);
                                tbl_Ledger.Rows.Add(drLedger);
                                sno++;
                            }
                        }
                    }
                    gridHist.DataSource = tbl_Ledger;
                    gridHist.DataBind();
                }
                else
                {
                    gridHist.DataSource = null;
                    gridHist.DataBind();
                }
            }
            else
            {
                gridHist.DataSource = null;
                gridHist.DataBind();
            }
            imgAlert.Attributes.Add("Style", " display:none;");
        }
        catch (Exception ex)
        {
            d2.sendErrorMail(ex, collegecode1, "ChallanReceipt");
            gridHist.DataSource = null;
            gridHist.DataBind();
            //btnhisgo.Visible = false;
        }
    }
    protected void imagebtnpopHistclose_Click(object sender, EventArgs e)
    {
        //div_History.Visible = false;
        div_History.Attributes.Add("onClientClick", "hideDiv()");
    }
    //Excess Popup
    //protected void btnExc_Click(object sender, EventArgs e)
    //{
    //    try
    //    {
    //        divExcess.Visible = true;
    //        bindHeaderLedger();
    //    }
    //    catch
    //    {
    //        ScriptManager.RegisterStartupScript(this, typeof(Page), UniqueID, "alert('Excess Fees Not Applicable')", true);
    //    }
    //}




    //Excess Fees
    protected void btn_sureyes_Click(object sender, EventArgs e)
    {
        checkFromPopper = true;

        excessOk = true;
        btn_sureyesRcpt_Click(sender, e);
    }
    protected void btn_sureno_Click(object sender, EventArgs e)
    {
        checkFromPopper = true;
        // txt_examt.Text = "0.00";
        excessOk = false;
        btn_sureyesRcpt_Click(sender, e);
    }
    //Caution Deposit 
    protected void cb_CautionDep_OnCheckedChanged(object sender, EventArgs e)
    {
        // txt_examt.Text = "0";
    }
    private double getRefundAmount(string appNo)
    {
        double refund = 0;
        string refQ = "select isnull(sum(isnull(RefundAmount,0)-isnull(RefundAdjAmount,0)),0) as Refund from ft_feeallot where app_no='" + appNo + "'";
        double.TryParse(d2.GetFunction(refQ), out refund);
        return refund;
    }
    private void updateRefundAmount(string AppNo, double curAmount)
    {
        string selLedgeQ = "select Ledgerfk,HeaderFk,Feecategory,FinYearfk,isnull(RefundAmount,0) as RefundAmount,isnull(RefundAdjAmount,0) as RefundAdjAmount,(isnull(RefundAmount,0)-isnull(RefundAdjAmount,0)) as AvailAmount   from ft_feeallot where (isnull(RefundAmount,0)-isnull(RefundAdjAmount,0))>0 and app_no='" + AppNo + "'";
        DataSet dsRefLedger = new DataSet();
        dsRefLedger = d2.select_method_wo_parameter(selLedgeQ, "Text");
        if (dsRefLedger.Tables.Count > 0 && dsRefLedger.Tables[0].Rows.Count > 0)
        {
            for (int ledge = 0; ledge < dsRefLedger.Tables[0].Rows.Count; ledge++)
            {
                if (curAmount > 0)
                {
                    double refAvlAmt = 0;
                    double.TryParse(Convert.ToString(dsRefLedger.Tables[0].Rows[ledge]["AvailAmount"]), out refAvlAmt);

                    if (refAvlAmt > 0)
                    {
                        string ledgerID = Convert.ToString(dsRefLedger.Tables[0].Rows[ledge]["Ledgerfk"]).Trim();
                        string headerID = Convert.ToString(dsRefLedger.Tables[0].Rows[ledge]["HeaderFk"]).Trim();
                        string feeCat = Convert.ToString(dsRefLedger.Tables[0].Rows[ledge]["Feecategory"]).Trim();
                        string fineYearId = Convert.ToString(dsRefLedger.Tables[0].Rows[ledge]["FinYearfk"]).Trim();
                        double refTotAmt = 0;
                        double.TryParse(Convert.ToString(dsRefLedger.Tables[0].Rows[ledge]["RefundAmount"]), out refTotAmt);
                        double refAdjAmt = 0;
                        double.TryParse(Convert.ToString(dsRefLedger.Tables[0].Rows[ledge]["RefundAdjAmount"]), out refAdjAmt);
                        double curAdjAmt = 0;
                        if (refAvlAmt >= curAmount)
                        {
                            curAdjAmt = curAmount;
                            curAmount = 0;
                        }
                        else
                        {
                            curAdjAmt = refAvlAmt;
                            curAmount -= curAdjAmt;
                        }

                        if (curAdjAmt > 0)
                        {
                            string updateQ = "update ft_feeallot set RefundAdjAmount=(isnull(RefundAdjAmount,0)+" + curAdjAmt + ")  where app_no='" + AppNo + "' and Ledgerfk='" + ledgerID + "' and HeaderFk='" + headerID + "' and Feecategory='" + feeCat + "' and FinYearfk='" + fineYearId + "'";
                            d2.update_method_wo_parameter(updateQ, "Text");
                        }
                    }
                }
            }
        }
    }
    //Multiple Scholarship
    //protected void cb_govt_SelectedIndexChanged(object sender, EventArgs e)
    //{
    //    try
    //    {
    //        if (cb_govt.Checked)
    //        {
    //            txtSchlReason.Visible = true;
    //            pnlMulReason.Visible = true;

    //            for (int i = 0; i < cblSchlReason.Items.Count; i++)
    //            {
    //                cblSchlReason.Items[i].Selected = true;
    //            }
    //            txtSchlReason.Text = "Type (" + cblSchlReason.Items.Count + ")";
    //            cbSchlReason.Checked = true;
    //        }
    //        else
    //        {
    //            txtSchlReason.Visible = false;
    //            pnlMulReason.Visible = false;
    //        }
    //    }
    //    catch (Exception ex) { }
    //}
    private void loadMultipleScholarshp()
    {
        //try
        //{
        //    DataSet dsSchl = new DataSet();
        //    txtSchlReason.Text = "";
        //    cbSchlReason.Checked = false;
        //    cblSchlReason.Items.Clear();
        //    string query = " select Distinct MasterValue,MasterCode from CO_MasterValues where MasterCriteria ='SchlolarshipReason' and CollegeCode ='" + collegecode1 + "' order by MasterValue asc";
        //    dsSchl = d2.select_method_wo_parameter(query, "Text");

        //    if (dsSchl.Tables.Count > 0 && dsSchl.Tables[0].Rows.Count > 0)
        //    {
        //        cblSchlReason.DataSource = dsSchl;
        //        cblSchlReason.DataTextField = "MasterValue";
        //        cblSchlReason.DataValueField = "MasterCode";
        //        cblSchlReason.DataBind();

        //        for (int i = 0; i < cblSchlReason.Items.Count; i++)
        //        {
        //            cblSchlReason.Items[i].Selected = true;
        //        }
        //        txtSchlReason.Text = "Type (" + cblSchlReason.Items.Count + ")";
        //        cbSchlReason.Checked = true;
        //    }
        //}
        //catch (Exception ex) { }
    }
    private void loadScholarship(string appNo)
    {
        //try
        //{
        //    DataSet dsSchl = new DataSet();
        //    txtSchlReason.Text = "";
        //    cbSchlReason.Checked = false;
        //    cblSchlReason.Items.Clear();
        //    string query = " select distinct MasterValue,Mastercode from FT_FinScholarship s,CO_MasterValues m where MasterCode=ReasonCode and s.App_no=" + appNo + "  and isnull(s.TotalAmount,0)>0  and MasterCriteria ='SchlolarshipReason' and s.CollegeCode ='" + collegecode1 + "' order by MasterValue asc";
        //    dsSchl = d2.select_method_wo_parameter(query, "Text");

        //    if (dsSchl.Tables.Count > 0 && dsSchl.Tables[0].Rows.Count > 0)
        //    {
        //        cblSchlReason.DataSource = dsSchl;
        //        cblSchlReason.DataTextField = "MasterValue";
        //        cblSchlReason.DataValueField = "MasterCode";
        //        cblSchlReason.DataBind();

        //        for (int i = 0; i < cblSchlReason.Items.Count; i++)
        //        {
        //            cblSchlReason.Items[i].Selected = true;
        //        }
        //        txtSchlReason.Text = "Type (" + cblSchlReason.Items.Count + ")";
        //        cbSchlReason.Checked = true;
        //    }
        //}
        //catch (Exception ex) { }
    }
    protected void cbSchlReason_CheckedChanged(object sender, EventArgs e)
    {
        //  CallCheckBoxChangedEvent(cblSchlReason, cbSchlReason, txtSchlReason, "Type");
        //loadGridStudent();
    }
    protected void cblSchlReason_SelectedIndexChanged(object sender, EventArgs e)
    {
        //CallCheckBoxListChangedEvent(cblSchlReason, cbSchlReason, txtSchlReason, "Type");
        // loadGridStudent();
    }
    //private double getSelSchol(string appnoNew)
    //{
    //    //double schlAmt = 0;
    //    //try
    //    //{
    //    //    List<string> lsMulReason = GetSelectedItemsValueList(cblSchlReason);
    //    //    if (lsMulReason.Count > 0)
    //    //    {
    //    //        DataTable dtMulSchl = getFilteredScholarshipTable(appnoNew);
    //    //        if (dtMulSchl.Rows.Count > 0)
    //    //        {
    //    //            for (int filLst = 0; filLst < lsMulReason.Count; filLst++)
    //    //            {
    //    //                double curAmt = 0;
    //    //                string colName = "C" + lsMulReason[filLst];
    //    //                string Amt = Convert.ToString(dtMulSchl.Compute("Sum(" + colName + ")", ""));
    //    //                double.TryParse(Amt, out curAmt);
    //    //                schlAmt += curAmt;
    //    //            }
    //    //        }
    //    //    }
    //    //}
    //    //catch { schlAmt = 0; }
    //    //return schlAmt;
    //}
    //private DataTable getFilteredScholarshipTable(string appnoNew)
    //{
    //    DataTable dtMulSchl = new DataTable("tbldtMulti");
    //    try
    //    {
    //        DataSet dsMulSchl = new DataSet();
    //        dsMulSchl = d2.select_method_wo_parameter("select mulscholar,LedgerFk,HeaderFk,FeeCategory,FinyearFk from FT_FeeAllot WHERE  App_No=" + appnoNew + " and mulscholar is not null", "Text");
    //        if (dsMulSchl.Tables.Count > 0 && dsMulSchl.Tables[0].Rows.Count > 0)
    //        {
    //            dtMulSchl.Columns.Add("LedgerId");
    //            dtMulSchl.Columns.Add("HeaderId");
    //            dtMulSchl.Columns.Add("FeecatId");
    //            dtMulSchl.Columns.Add("FinyearId");

    //            List<string> lsMulReasonList = GetItemsValueList(cblSchlReason);
    //            for (int reasonIndx = 0; reasonIndx < lsMulReasonList.Count; reasonIndx++)
    //            {
    //                DataColumn dcReasValues = new DataColumn("C" + lsMulReasonList[reasonIndx], typeof(Double));
    //                dtMulSchl.Columns.Add(dcReasValues);
    //            }
    //            for (int ledIndx = 0; ledIndx < dsMulSchl.Tables[0].Rows.Count; ledIndx++)
    //            {
    //                string[] reasonsWtValue = Convert.ToString(dsMulSchl.Tables[0].Rows[ledIndx][0]).Split(',');
    //                if (reasonsWtValue.Length > 0)
    //                {
    //                    DataRow drReasValues = dtMulSchl.NewRow();
    //                    drReasValues["LedgerId"] = Convert.ToString(dsMulSchl.Tables[0].Rows[ledIndx][1]);
    //                    drReasValues["HeaderId"] = Convert.ToString(dsMulSchl.Tables[0].Rows[ledIndx][2]);
    //                    drReasValues["FeecatId"] = Convert.ToString(dsMulSchl.Tables[0].Rows[ledIndx][3]);
    //                    drReasValues["FinyearId"] = Convert.ToString(dsMulSchl.Tables[0].Rows[ledIndx][4]);

    //                    for (int reas = 0; reas < reasonsWtValue.Length; reas++)
    //                    {
    //                        string[] reasonAdValues = reasonsWtValue[reas].Split(':');
    //                        if (reasonAdValues.Length == 2)
    //                        {
    //                            drReasValues["C" + reasonAdValues[0]] = reasonAdValues[1];
    //                        }
    //                    }
    //                    dtMulSchl.Rows.Add(drReasValues);
    //                }
    //            }
    //        }
    //    }
    //    catch (Exception ex) { dtMulSchl.Clear(); }
    //    return dtMulSchl;
    //}
    //Multiple Mode Receipt
    protected void btnrcptRoll_Click(object sender, EventArgs e)
    {

    }
    protected void btnyesrcpt_Click(object sender, EventArgs e)
    {
        double mdAmtOvall = 0;
        foreach (GridViewRow row in gridMultimode.Rows)
        {
            TextBox txtmdAmt = (TextBox)row.FindControl("txt_mdAmtpop");
            if (txtmdAmt.Text != "")
            {
                if (Convert.ToDouble(txtmdAmt.Text) > 0)
                {
                    mdAmtOvall += Convert.ToDouble(txtmdAmt.Text);
                }
            }
        }
        if (Convert.ToDouble(Txt_amt.Text) == mdAmtOvall)
        {
            divRecptRpt.Attributes.Add("Style", "display:none;");
            imgAlert.Attributes.Add("Style", " display:none;");
            Div4.Visible = true;
        }
        else
        {
            imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
            lbl_alert.Text = "Please Provide Valid Amount";
        }
    }
    protected void btnnorcpt_Click(object sender, EventArgs e)
    {
        divRecptRpt.Visible = false;
    }
    protected void btnCLearrcpt_Click(object sender, EventArgs e)
    {
        gridMultimode.DataSource = null;
        gridMultimode.DataBind();
        divRecptRpt.Attributes.Add("Style", "height: 60em; z-index: 1000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top: 15%; left: 0px;display:block;");

    }
    protected void gridmdMode_onDatabound(object sender, GridViewRowEventArgs e)
    {
        if (e.Row.RowType == DataControlRowType.DataRow)
        {
            //if (e.Row.RowIndex != 0)
            //{
            string queru = "select TextCode,TextVal  from textvaltable where TextCriteria = 'BName'";
            DataSet dsBank = d2.select_method_wo_parameter(queru, "Text");
            DropDownList ddlmdBank = (DropDownList)e.Row.FindControl("ddlmdBank");
            if (dsBank.Tables.Count > 0)
            {
                if (dsBank.Tables[0].Rows.Count > 0)
                {
                    ddlmdBank.DataSource = dsBank;
                    ddlmdBank.DataTextField = "TextVal";
                    ddlmdBank.DataValueField = "TextCode";
                    ddlmdBank.DataBind();
                }
            }
            //}
            //else
            //{
            //    DropDownList ddlmdBank = (DropDownList)e.Row.FindControl("ddlmdBank");
            //    ddlmdBank.Visible = false;
            //    TextBox txt_mdbranchpop = (TextBox)e.Row.FindControl("txt_mdbranchpop");
            //    TextBox txt_mdchkddnopop = (TextBox)e.Row.FindControl("txt_mdchkddnopop");
            //    txt_mdbranchpop.Visible = false;
            //    txt_mdchkddnopop.Visible = false;
            //}

        }
    }
    protected void rblCashChkDd_OnSelectedIndexChanged(object sender, EventArgs e)
    {
        try
        {
            txt_mdAddAmtpop.Text = "";
            txt_mdBranchAdd.Text = "";
            txt_mdChequeNoAdd.Text = "";
            txtCardTypeMd.Text = "";
            txtLast4NoMd.Text = "";
            if (ddlmdBankAdd.Items.Count > 0)
            {
                ddlmdBankAdd.SelectedIndex = 0;
            }
            if (ddlCardTypeMd.Items.Count > 0)
            {
                ddlCardTypeMd.SelectedIndex = 0;
            }

            if (rblCashChkDd.SelectedIndex == 0)
            {
                //trBankDetailsmd.Visible = false;
                //trCardDetailsmd.Visible = false;
            }
            else if (rblCashChkDd.SelectedIndex == 1)
            {
                //trBankDetailsmd.Visible = true;
                //trCardDetailsmd.Visible = false;
            }
            else if (rblCashChkDd.SelectedIndex == 2)
            {
                //trBankDetailsmd.Visible = true;
                //trCardDetailsmd.Visible = false;
            }
            else if (rblCashChkDd.SelectedIndex == 3)
            {
                //trBankDetailsmd.Visible = false;
                //trCardDetailsmd.Visible = true;
            }
        }
        catch (Exception ex) { }
    }
    protected void btnplus1_OnClick(object sender, EventArgs e)
    {
        imgdiv3.Visible = true;
        panel_description.Visible = true;
    }
    protected void btnminus1_OnClick(object sender, EventArgs e)
    {
        try
        {
            imgAlert.Attributes.Add("Style", " display:none;");
            if (ddlmdBankAdd.Items.Count > 0)
            {
                string sql = "delete from textvaltable where TextVal ='" + Convert.ToString(ddlmdBankAdd.SelectedItem.Text) + "' and TextCode='" + Convert.ToString(ddlmdBankAdd.SelectedValue) + "' and TextCriteria = 'BName'  and college_code ='" + collegecode1 + "'";
                int insert = d2.update_method_wo_parameter(sql, "TEXT");
                imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                //this.Form.DefaultButton = "btn_alertclose";
                lbl_alert.Text = "Deleted Sucessfully";
            }
            else
            {
                imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                //this.Form.DefaultButton = "btn_alertclose";
                lbl_alert.Text = "No Items Found";
            }
        }
        catch (Exception ex)
        {

            imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
            //this.Form.DefaultButton = "btn_alertclose";
            lbl_alert.Text = "Not Deleted";
        }
        string queru = "select TextCode,TextVal  from textvaltable where TextCriteria = 'BName' and college_code='" + collegecode1 + "'";
        ddlmdBankAdd.Items.Clear();
        DataSet dsBank = d2.select_method_wo_parameter(queru, "Text");
        if (dsBank.Tables.Count > 0)
        {
            if (dsBank.Tables[0].Rows.Count > 0)
            {
                ddlmdBankAdd.DataSource = dsBank;
                ddlmdBankAdd.DataTextField = "TextVal";
                ddlmdBankAdd.DataValueField = "TextCode";
                ddlmdBankAdd.DataBind();
            }
        }
        //imgdiv3.Visible = true;
        //panel_description.Visible = true;
    }
    protected void btndescpopadd_Click(object sender, EventArgs e)
    {
        try
        {
            imgAlert.Attributes.Add("Style", " display:none;");
            if (txt_description11.Text != "")
            {
                string sql = "if exists (select TextCode,TextVal  from textvaltable where TextVal ='" + txt_description11.Text + "' and TextCriteria = 'BName' and college_code ='" + collegecode1 + "') update TextValTable set TextVal ='" + txt_description11.Text + "' where TextVal ='" + txt_description11.Text + "' and TextCriteria ='BName' and college_code ='" + collegecode1 + "' else insert into TextValTable (TextVal,TextCriteria,college_code) values ('" + txt_description11.Text.Trim() + "','BName','" + collegecode1 + "')";
                int insert = d2.update_method_wo_parameter(sql, "TEXT");
                if (insert != 0)
                {
                    imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                    //this.Form.DefaultButton = "btn_alertclose";
                    lbl_alert.Text = "Saved sucessfully";
                    txt_description11.Text = "";
                    imgdiv3.Visible = false;
                    panel_description.Visible = false;
                }
                else
                {
                    imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                    //this.Form.DefaultButton = "btn_alertclose";
                    lbl_alert.Text = "Not Added";
                }

            }
            else
            {
                imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                //this.Form.DefaultButton = "btn_alertclose";
                lbl_alert.Text = "Enter Bank Name";
            }
            ddlmdBankAdd.Items.Clear();
            string queru = "select TextCode,TextVal  from textvaltable where TextCriteria = 'BName' and college_code='" + collegecode1 + "'";
            DataSet dsBank = d2.select_method_wo_parameter(queru, "Text");
            if (dsBank.Tables.Count > 0)
            {
                if (dsBank.Tables[0].Rows.Count > 0)
                {

                    ddlmdBankAdd.DataSource = dsBank;
                    ddlmdBankAdd.DataTextField = "TextVal";
                    ddlmdBankAdd.DataValueField = "TextCode";
                    ddlmdBankAdd.DataBind();
                }
            }
        }
        catch (Exception ex) { d2.sendErrorMail(ex, collegecode1, "ChallanReceipt"); }
    }
    protected void btndescpopexit_Click(object sender, EventArgs e)
    {
        imgdiv3.Visible = false;
        panel_description.Visible = false;
    }
    protected void btnAddNewRow_onClick(object sender, EventArgs e)
    {
        try
        {
            if (txt_mdAddAmtpop.Text != "0" && txt_mdAddAmtpop.Text.Trim() != "" && txt_mdAddAmtpop.Text.Trim() != "0.00")
            {
                double amt = Convert.ToDouble(txt_mdAddAmtpop.Text);
                if (amt > 0)
                {
                    DataTable dtMultimode = new DataTable();
                    dtMultimode.Columns.Add("modevalue");
                    dtMultimode.Columns.Add("mode");
                    dtMultimode.Columns.Add("bank");
                    dtMultimode.Columns.Add("bankid");
                    dtMultimode.Columns.Add("DDDate");
                    dtMultimode.Columns.Add("branch");
                    dtMultimode.Columns.Add("chkddno");
                    dtMultimode.Columns.Add("Amount");

                    foreach (GridViewRow grow in gridMultimode.Rows)
                    {
                        Label lblmdId = (Label)grow.FindControl("lbl_modetypeid");
                        Label lblmdType = (Label)grow.FindControl("lbl_modetype");
                        Label lblmdBnkId = (Label)grow.FindControl("lbl_mdbankid");
                        TextBox txtmdBnk = (TextBox)grow.FindControl("txt_mdBank");
                        TextBox txtmdBr = (TextBox)grow.FindControl("txt_mdbranchpop");
                        TextBox txtmdChkno = (TextBox)grow.FindControl("txt_mdchkddnopop");
                        TextBox txtmdAmt = (TextBox)grow.FindControl("txt_mdAmtpop");
                        Label lbl_mddate = (Label)grow.FindControl("lbl_mddate");

                        DataRow dr0 = dtMultimode.NewRow();
                        dr0["modevalue"] = lblmdId.Text;
                        dr0["mode"] = lblmdType.Text;
                        dr0["bankid"] = lblmdBnkId.Text;
                        dr0["bank"] = txtmdBnk.Text;
                        dr0["branch"] = txtmdBr.Text;
                        dr0["chkddno"] = txtmdChkno.Text;
                        dr0["Amount"] = txtmdAmt.Text;
                        dr0["DDDate"] = lbl_mddate.Text;// txt_datemd.Text.Split('/')[1] + "/" + txt_datemd.Text.Split('/')[0] + "/" + txt_datemd.Text.Split('/')[2] + "/";
                        dtMultimode.Rows.Add(dr0);

                    }

                    DataRow dr = dtMultimode.NewRow();
                    if (rblCashChkDd.SelectedIndex == 0)
                    {
                        dr["modevalue"] = "1";
                        dr["mode"] = "Cash";
                        dr["bankid"] = "-1";
                        dr["bank"] = "";
                        dr["branch"] = "";
                        dr["chkddno"] = "";
                        dr["Amount"] = txt_mdAddAmtpop.Text;
                        dr["DDDate"] = txt_datemd.Text;
                        dtMultimode.Rows.Add(dr);
                        trBankDetailsmd.Attributes.Add("Style", "display:none;");
                        trCardDetailsmd.Attributes.Add("Style", "display:none;");
                        imgAlert.Attributes.Add("Style", " display:none;");
                        divRecptRpt.Attributes.Add("Style", "height: 60em; z-index: 1000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top: 15%; left: 0px;display:block;");
                    }
                    else if (rblCashChkDd.SelectedIndex == 1 || rblCashChkDd.SelectedIndex == 2)
                    {
                        if (ddlmdBankAdd.Items.Count > 0 && txt_mdBranchAdd.Text.Trim() != "" && txt_mdChequeNoAdd.Text.Trim() != "")
                        {
                            if (rblCashChkDd.SelectedIndex == 1)
                            {
                                dr["modevalue"] = "2";
                                dr["mode"] = "Cheque";
                            }
                            else
                            {
                                dr["modevalue"] = "3";
                                dr["mode"] = "DD";
                            }
                            dr["bankid"] = Convert.ToString(ddlmdBankAdd.SelectedItem.Value);
                            dr["bank"] = Convert.ToString(ddlmdBankAdd.SelectedItem.Text);
                            dr["branch"] = Convert.ToString(txt_mdBranchAdd.Text);
                            dr["chkddno"] = Convert.ToString(txt_mdChequeNoAdd.Text);
                            dr["Amount"] = txt_mdAddAmtpop.Text;
                            dr["DDDate"] = txt_datemd.Text;
                            dtMultimode.Rows.Add(dr);
                            trBankDetailsmd.Attributes.Add("Style", "display:block;");
                            trCardDetailsmd.Attributes.Add("Style", "display:none;");
                            imgAlert.Attributes.Add("Style", " display:none;");
                            divRecptRpt.Attributes.Add("Style", "height: 60em; z-index: 1000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top: 15%; left: 0px;display:block;");
                        }
                        else
                        {
                            imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                            lbl_alert.Text = "Please Provide All Details";
                        }
                    }
                    else if (rblCashChkDd.SelectedIndex == 3)
                    {
                        string newbankname = string.Empty, newbankcode = string.Empty;
                        if (ddlCardTypeMd.SelectedItem.Text.ToUpper() == "OTHERS")
                        {
                            newbankname = txtCardTypeMd.Text.Trim();
                            newbankcode = subjectcode("CardT", newbankname);

                            string queru = "select TextCode,TextVal  from textvaltable where TextCriteria = 'cardT' and college_code='" + collegecode1 + "'";
                            ddlCardTypeMd.Items.Clear();
                            DataSet dsBank = d2.select_method_wo_parameter(queru, "Text");
                            if (dsBank.Tables.Count > 0)
                            {
                                if (dsBank.Tables[0].Rows.Count > 0)
                                {
                                    ddlCardTypeMd.DataSource = dsBank.Tables[0];
                                    ddlCardTypeMd.DataTextField = "TextVal";
                                    ddlCardTypeMd.DataValueField = "TextCode";
                                    ddlCardTypeMd.DataBind();
                                }
                            }
                            ddlCardTypeMd.Items.Insert(0, "Select");
                            ddlCardTypeMd.Items.Add("Others");
                        }
                        else
                        {
                            if (ddlCardTypeMd.SelectedIndex != 0)
                            {
                                newbankname = ddlCardTypeMd.SelectedItem.Text;
                                newbankcode = ddlCardTypeMd.SelectedItem.Value;
                            }
                        }
                        if (newbankname != "" && newbankcode.Trim() != "" && txtLast4NoMd.Text.Trim() != "")
                        {
                            dr["modevalue"] = "6";
                            dr["mode"] = "Card";
                            dr["bankid"] = newbankcode;
                            dr["bank"] = "";
                            dr["branch"] = newbankname;
                            dr["chkddno"] = txtLast4NoMd.Text;
                            dr["Amount"] = txt_mdAddAmtpop.Text;
                            dr["DDDate"] = txt_datemd.Text;
                            dtMultimode.Rows.Add(dr);
                            trBankDetailsmd.Attributes.Add("Style", "display:none;");
                            trCardDetailsmd.Attributes.Add("Style", "display:block;");
                            imgAlert.Attributes.Add("Style", " display:none;");
                            divRecptRpt.Attributes.Add("Style", "height: 60em; z-index: 1000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top: 15%; left: 0px;display:block;");
                        }
                        else
                        {
                            imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                            //this.Form.DefaultButton = "btn_alertclose";
                            lbl_alert.Text = "Please Provide All Details";
                        }
                    }
                    if (dtMultimode.Rows.Count > 0)
                    {
                        DataView view = dtMultimode.DefaultView;
                        view.Sort = "modevalue ASC";
                        DataTable sortedTable = view.ToTable();

                        gridMultimode.DataSource = sortedTable;
                        gridMultimode.DataBind();

                        txt_mdAddAmtpop.Text = "";
                        txt_mdBranchAdd.Text = "";
                        txt_mdChequeNoAdd.Text = "";
                        if (ddlmdBankAdd.Items.Count > 0)
                        {
                            ddlmdBankAdd.SelectedIndex = 0;
                        }
                        txtLast4NoMd.Text = "";
                        txtCardTypeMd.Text = "";
                        btnyesrcpt.Visible = true;
                        btnCLearrcpt.Visible = true;
                        imgAlert.Attributes.Add("Style", " display:none;");
                    }
                }
                else
                {
                    btnyesrcpt.Visible = false;
                    btnCLearrcpt.Visible = false;
                    imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                    lbl_alert.Text = "Please Provide Amount";
                }
            }
            else
            {
                btnyesrcpt.Visible = false;
                btnCLearrcpt.Visible = false;
                imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                lbl_alert.Text = "Please Provide Amount";
            }
        }
        catch (Exception ex) { }
    }
    //Receipt and Challan -- Save and Print
    protected string isCollectedForDD()
    {
        string value = "0";
        string ddCollected = "select LinkValue from New_InsSettings where linkname = 'AutomaticallyClearDD' and user_code ='" + usercode + "' --and college_code ='" + collegecode1 + "'";
        value = d2.GetFunction(ddCollected).Trim();
        return value;
    }
    protected string AutoClearCheck()
    {
        string value = "0";
        string chqCleared = "select LinkValue from New_InsSettings where linkname = 'AutomaticallyClearCheque' and user_code ='" + usercode + "' --and college_code ='" + collegecode1 + "'";
        value = d2.GetFunction(chqCleared).Trim();
        return value;
    }
    protected void btn_print_Click(object sender, EventArgs e)
    {
        try
        {
            imgAlert.Attributes.Add("Style", " display:none;");
            string insqry1 = "select LinkValue from New_InsSettings where LinkName='ChallanPrintFormat' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "'";
            int save1 = Convert.ToInt32(d2.GetFunction(insqry1));
            if (save1 == 0)
            {
                imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                //this.Form.DefaultButton = "btn_alertclose";
                lbl_alert.Text = "Please Add Challan Format Setting";
            }
            else if (save1 == 1)
            {
                //For Mcc and Others
                challanPrint();
            }
            else if (save1 == 2)
            {
                //For NEC
                challanPrintNew();
            }
            else if (save1 == 3)
            {
                //For UIT
                challanPrintUIT();
            }
            else if (save1 == 4)
            {
                //For New College
                challanPrintNewCollege();
            }
        }
        catch (Exception ex) { }
    }
    private double excessRemaining(string appnoNew)
    {
        string excessamtQ = d2.GetFunction("select sum(isnull(ExcessAmt,0)-isnull(AdjAmt,0)) as BalanceAmt from FT_ExcessDet WHERE  App_No=" + appnoNew + " ");

        double excessamtValue = 0;
        double.TryParse(excessamtQ, out excessamtValue);
        return excessamtValue;
    }
    private bool isHeaderReceipNoOk(out string hspk)
    {
        bool headerOK = false;
        hspk = string.Empty;
        try
        {
            string isheaderFk = GetSelectedItemsValue(cbl_grpheader);

            string finYearid = d2.getCurrentFinanceYear(usercode, collegecode1);

            DataSet dsFinHedDet = d2.select_method_wo_parameter("select distinct HeaderSettingFk from FM_HeaderFinCodeSettingsDet hs,FM_HeaderFinCodeSettings s where s.HeaderSettingPK=hs.HeaderSettingFK and HeaderFK in (" + isheaderFk + ") and CollegeCode=" + collegecode1 + " and FinyearFK=" + finYearid + "", "Text");

            if (dsFinHedDet.Tables.Count > 0 && dsFinHedDet.Tables[0].Rows.Count == 1 && rbl_headerselect.SelectedIndex == 1)
            {
                hspk = Convert.ToString(dsFinHedDet.Tables[0].Rows[0][0]).Trim();
                headerOK = true;
            }
        }
        catch (Exception ex) { headerOK = false; }
        return headerOK;
    }
    //Receipt Save

    protected bool saveMiscellaneous()
    {
        bool boolCheck = false;
        try
        {
            string rollno = string.Empty;
            string finYeaid = d2.getCurrentFinanceYear(usercode, collegecode1);
            if (rbl_rollnoNew.SelectedIndex == 0 && !cbAdvance.Checked)
            {
                #region student

                rollno = txt_rollno.Text.Trim();
                string feecat = Convert.ToString(GetSelectedItemsValue(cbl_sem));
                if (!string.IsNullOrEmpty(rollno) && !string.IsNullOrEmpty(finYeaid) && !string.IsNullOrEmpty(feecat))
                {
                    string appNo = string.Empty;
                    string selappNo = " select r.app_no from Registration r where r.college_code=" + collegecode1 + "";
                    if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 0)
                        selappNo += "  and r.Roll_No =  '" + rollno + "' ";
                    else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 1)
                        selappNo += " and  R.Reg_No = '" + rollno + "' ";
                    else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 2)
                        selappNo += " and  R.Roll_admit = '" + rollno + "' ";
                    else if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 4)
                        selappNo += " and  R.smart_serial_no = '" + rollno + "' ";
                    else
                        selappNo = "select app_no from applyn where  college_code=" + collegecode1 + " and app_formno ='" + rollno + "'";
                    appNo = d2.GetFunction(selappNo);
                    if (!string.IsNullOrEmpty(appNo) && appNo != "0")
                    {
                        foreach (GridViewRow gdrow in grid_Details.Rows)
                        {
                            CheckBox cbsel = (CheckBox)gdrow.FindControl("cb_selectLedger");
                            if (!cbsel.Checked)
                                continue;

                            Label lblhdfk = (Label)gdrow.FindControl("lbl_hdrid");
                            Label lblldfk = (Label)gdrow.FindControl("lbl_feecode");
                            Label lblfeecat = (Label)gdrow.FindControl("lbl_textCode");
                            TextBox lblfeeAmt = (TextBox)gdrow.FindControl("txt_fee_amt");
                            TextBox lbldeductAmt = (TextBox)gdrow.FindControl("txt_deduct_amt");
                            TextBox lbltotAmt = (TextBox)gdrow.FindControl("txt_tot_amt");
                            TextBox lblpaidAmt = (TextBox)gdrow.FindControl("txt_paid_amt");
                            TextBox lblbalAmt = (TextBox)gdrow.FindControl("txt_bal_amt");
                            TextBox lbltobeAmt = (TextBox)gdrow.FindControl("txt_tobepaid_amt");
                            Label lblfinFk = (Label)gdrow.FindControl("lblfinfk");

                            double feeAmt = 0;
                            double deductAmt = 0;
                            double totAmt = 0;
                            double paidAmt = 0;
                            double balaAmt = 0;
                            double tobepaid = 0;

                            double.TryParse(Convert.ToString(lblfeeAmt.Text), out feeAmt);
                            double.TryParse(Convert.ToString(lbldeductAmt.Text), out deductAmt);
                            double.TryParse(Convert.ToString(lbltotAmt.Text), out totAmt);
                            double.TryParse(Convert.ToString(lblpaidAmt.Text), out paidAmt);
                            double.TryParse(Convert.ToString(lblbalAmt.Text), out balaAmt);
                            double.TryParse(Convert.ToString(lbltobeAmt.Text), out tobepaid);
                            double balAmt = totAmt - paidAmt;

                            if (feeAmt == 0.0) //Aruna
                                continue;
                            if (totAmt != 0 && tobepaid != 0)
                            {
                                string insertQuery = " INSERT INTO FT_FeeAllot(AllotDate,MemType,PayMode,App_No,LedgerFK,HeaderFK,FeeAmount,TotalAmount,FeeCategory,BalAmount,FinYearFK,FromGovtAmt,deductamout) VALUES('" + DateTime.Now.ToString("MM/dd/yyyy") + "',1,1," + appNo + "," + lblldfk.Text + "," + lblhdfk.Text + "," + feeAmt + "," + totAmt + "," + lblfeecat.Text + "," + balAmt + "," + finYeaid + ",0,'" + deductAmt + "') ";
                                selectQuery = " select * from FT_FeeAllot where LedgerFK in('" + lblldfk.Text + "') and HeaderFK in('" + lblhdfk.Text + "') and FeeCategory in('" + lblfeecat.Text + "')  and App_No in('" + appNo + "') and finyearfk='" + finYeaid + "' and memtype='1'";
                                //  string updateQuery = "  update FT_FeeAllot set AllotDate='" + DateTime.Now.ToString("MM/dd/yyyy") + "', MemType=1,FeeAmount=isnull(FeeAmount,0)+" + feeAmt + ",BalAmount=isnull(BalAmount,0)+" + balAmt + ",TotalAmount=isnull(TotalAmount,0)+" + totAmt + " where LedgerFK in('" + lblldfk.Text + "') and HeaderFK in('" + lblhdfk.Text + "') and FeeCategory in('" + lblfeecat.Text + "')  and App_No in('" + appNo + "') and finyearfk='" + finYeaid + "'";
                                string updateQuery = "  update FT_FeeAllot set AllotDate='" + DateTime.Now.ToString("MM/dd/yyyy") + "',FeeAmount=isnull(FeeAmount,0)+" + feeAmt + ",BalAmount=isnull(BalAmount,0)+" + balAmt + ",TotalAmount=isnull(TotalAmount,0)+" + totAmt + " where LedgerFK in('" + lblldfk.Text + "') and HeaderFK in('" + lblhdfk.Text + "') and FeeCategory in('" + lblfeecat.Text + "')  and App_No in('" + appNo + "') and finyearfk='" + finYeaid + "' and memtype='1'";

                                string finalQuery = " if exists ( " + selectQuery + " ) " + updateQuery + " else " + insertQuery + " ";
                                int insok = d2.update_method_wo_parameter(finalQuery, "Text");
                                boolCheck = true;

                            }
                        }
                    }
                }
                #endregion
            }
            else if (rbl_rollnoNew.SelectedIndex == 1)
            {
                #region Staff
                rollno = txtroll_staff.Text.Trim();
                if (!string.IsNullOrEmpty(rollno) && !string.IsNullOrEmpty(finYeaid))
                {
                    string appNo = d2.GetFunction("select a.appl_id from staffmaster s,staff_appl_master a where s.appl_no=a.appl_no and s.staff_code='" + rollno + "' and s.college_code=" + collegecode1 + " ");
                    if (!string.IsNullOrEmpty(appNo) && appNo != "0")
                    {
                        string feecat = "0";
                        foreach (GridViewRow gdrow in grid_Details.Rows)
                        {
                            CheckBox cbsel = (CheckBox)gdrow.FindControl("cb_selectLedger");
                            if (!cbsel.Checked)
                                continue;
                            Label lblhdfk = (Label)gdrow.FindControl("lbl_hdrid");
                            Label lblldfk = (Label)gdrow.FindControl("lbl_feecode");
                            // Label lblfeecat = (Label)gdrow.FindControl("lbl_textCode");
                            TextBox lblfeeAmt = (TextBox)gdrow.FindControl("txt_fee_amt");
                            TextBox lbldeductAmt = (TextBox)gdrow.FindControl("txt_deduct_amt");
                            TextBox lbltotAmt = (TextBox)gdrow.FindControl("txt_tot_amt");
                            TextBox lblpaidAmt = (TextBox)gdrow.FindControl("txt_paid_amt");
                            TextBox lblbalAmt = (TextBox)gdrow.FindControl("txt_bal_amt");
                            TextBox lbltobeAmt = (TextBox)gdrow.FindControl("txt_tobepaid_amt");
                            Label lblfinFk = (Label)gdrow.FindControl("lblfinfk");
                            double feeAmt = 0;
                            double deductAmt = 0;
                            double totAmt = 0;
                            double paidAmt = 0;
                            double balaAmt = 0;
                            double tobepaid = 0;
                            double.TryParse(Convert.ToString(lblfeeAmt.Text), out feeAmt);
                            double.TryParse(Convert.ToString(lbldeductAmt.Text), out deductAmt);
                            double.TryParse(Convert.ToString(lbltotAmt.Text), out totAmt);
                            double.TryParse(Convert.ToString(lblpaidAmt.Text), out paidAmt);
                            double.TryParse(Convert.ToString(lblbalAmt.Text), out balaAmt);
                            double.TryParse(Convert.ToString(lbltobeAmt.Text), out tobepaid);
                            double balAmt = totAmt - paidAmt;
                            if (feeAmt == 0.0) //Aruna
                                continue;
                            if (totAmt != 0 && tobepaid != 0)
                            {
                                string insertQuery = " INSERT INTO FT_FeeAllot(AllotDate,MemType,PayMode,App_No,LedgerFK,HeaderFK,FeeAmount,TotalAmount,FeeCategory,BalAmount,FinYearFK,FromGovtAmt,deductamout) VALUES('" + DateTime.Now.ToString("MM/dd/yyyy") + "',2,1," + appNo + "," + lblldfk.Text + "," + lblhdfk.Text + "," + feeAmt + "," + totAmt + "," + feecat + "," + balAmt + "," + finYeaid + ",0,'" + deductAmt + "') ";
                                selectQuery = " select * from FT_FeeAllot where LedgerFK in('" + lblldfk.Text + "') and HeaderFK in('" + lblhdfk.Text + "') and FeeCategory in('" + feecat + "')  and App_No in('" + appNo + "') and finyearfk='" + finYeaid + "' and memtype='2'";
                                //  string updateQuery = "  update FT_FeeAllot set AllotDate='" + DateTime.Now.ToString("MM/dd/yyyy") + "', MemType=1,FeeAmount=isnull(FeeAmount,0)+" + feeAmt + ",BalAmount=isnull(BalAmount,0)+" + balAmt + ",TotalAmount=isnull(TotalAmount,0)+" + totAmt + " where LedgerFK in('" + lblldfk.Text + "') and HeaderFK in('" + lblhdfk.Text + "') and FeeCategory in('" + lblfeecat.Text + "')  and App_No in('" + appNo + "') and finyearfk='" + finYeaid + "'";
                                string updateQuery = "  update FT_FeeAllot set AllotDate='" + DateTime.Now.ToString("MM/dd/yyyy") + "',FeeAmount=isnull(FeeAmount,0)+" + feeAmt + ",BalAmount=isnull(BalAmount,0)+" + balAmt + ",TotalAmount=isnull(TotalAmount,0)+" + totAmt + " where LedgerFK in('" + lblldfk.Text + "') and HeaderFK in('" + lblhdfk.Text + "') and FeeCategory in('" + feecat + "')  and App_No in('" + appNo + "') and finyearfk='" + finYeaid + "' and memtype='2'";

                                string finalQuery = " if exists ( " + selectQuery + " ) " + updateQuery + " else " + insertQuery + " "; int insok = d2.update_method_wo_parameter(finalQuery, "Text");
                                boolCheck = true;
                            }
                        }
                    }
                }
                #endregion
            }
            else if (rbl_rollnoNew.SelectedIndex == 2)
            {
                #region Vendor
                rollno = txtname_vendor.Text.Trim();
                try
                { rollno = rollno.Split('-')[2]; }
                catch { rollno = ""; }

                if (!string.IsNullOrEmpty(rollno) && rollno != "0")
                {
                    string appNo = rollno;
                    string feecat = "0";
                    foreach (GridViewRow gdrow in grid_Details.Rows)
                    {
                        CheckBox cbsel = (CheckBox)gdrow.FindControl("cb_selectLedger");
                        if (!cbsel.Checked)
                            continue;
                        Label lblhdfk = (Label)gdrow.FindControl("lbl_hdrid");
                        Label lblldfk = (Label)gdrow.FindControl("lbl_feecode");
                        // Label lblfeecat = (Label)gdrow.FindControl("lbl_textCode");
                        TextBox lblfeeAmt = (TextBox)gdrow.FindControl("txt_fee_amt");
                        TextBox lbldeductAmt = (TextBox)gdrow.FindControl("txt_deduct_amt");
                        TextBox lbltotAmt = (TextBox)gdrow.FindControl("txt_tot_amt");
                        TextBox lblpaidAmt = (TextBox)gdrow.FindControl("txt_paid_amt");
                        TextBox lblbalAmt = (TextBox)gdrow.FindControl("txt_bal_amt");
                        TextBox lbltobeAmt = (TextBox)gdrow.FindControl("txt_tobepaid_amt");
                        Label lblfinFk = (Label)gdrow.FindControl("lblfinfk");
                        double feeAmt = 0;
                        double deductAmt = 0;
                        double totAmt = 0;
                        double paidAmt = 0;
                        double balaAmt = 0;
                        double tobepaid = 0;
                        double.TryParse(Convert.ToString(lblfeeAmt.Text), out feeAmt);
                        double.TryParse(Convert.ToString(lbldeductAmt.Text), out deductAmt);
                        double.TryParse(Convert.ToString(lbltotAmt.Text), out totAmt);
                        double.TryParse(Convert.ToString(lblpaidAmt.Text), out paidAmt);
                        double.TryParse(Convert.ToString(lblbalAmt.Text), out balaAmt);
                        double.TryParse(Convert.ToString(lbltobeAmt.Text), out tobepaid);
                        double balAmt = totAmt - paidAmt;
                        if (feeAmt == 0.0) //Aruna
                            continue;
                        if (totAmt != 0 && tobepaid != 0)
                        {
                            string insertQuery = " INSERT INTO FT_FeeAllot(AllotDate,MemType,PayMode,App_No,LedgerFK,HeaderFK,FeeAmount,TotalAmount,FeeCategory,BalAmount,FinYearFK,FromGovtAmt,deductamout) VALUES('" + DateTime.Now.ToString("MM/dd/yyyy") + "',3,1," + appNo + "," + lblldfk.Text + "," + lblhdfk.Text + "," + feeAmt + "," + totAmt + "," + feecat + "," + balAmt + "," + finYeaid + ",0,'" + deductAmt + "') ";
                            selectQuery = " select * from FT_FeeAllot where LedgerFK in('" + lblldfk.Text + "') and HeaderFK in('" + lblhdfk.Text + "') and FeeCategory in('" + feecat + "')  and App_No in('" + appNo + "') and finyearfk='" + finYeaid + "' and memtype='3'";
                            //  string updateQuery = "  update FT_FeeAllot set AllotDate='" + DateTime.Now.ToString("MM/dd/yyyy") + "', MemType=1,FeeAmount=isnull(FeeAmount,0)+" + feeAmt + ",BalAmount=isnull(BalAmount,0)+" + balAmt + ",TotalAmount=isnull(TotalAmount,0)+" + totAmt + " where LedgerFK in('" + lblldfk.Text + "') and HeaderFK in('" + lblhdfk.Text + "') and FeeCategory in('" + lblfeecat.Text + "')  and App_No in('" + appNo + "') and finyearfk='" + finYeaid + "'";
                            string updateQuery = "  update FT_FeeAllot set AllotDate='" + DateTime.Now.ToString("MM/dd/yyyy") + "',FeeAmount=isnull(FeeAmount,0)+" + feeAmt + ",BalAmount=isnull(BalAmount,0)+" + balAmt + ",TotalAmount=isnull(TotalAmount,0)+" + totAmt + " where LedgerFK in('" + lblldfk.Text + "') and HeaderFK in('" + lblhdfk.Text + "') and FeeCategory in('" + feecat + "')  and App_No in('" + appNo + "') and finyearfk='" + finYeaid + "' and memtype='3'";

                            string finalQuery = " if exists ( " + selectQuery + " ) " + updateQuery + " else " + insertQuery + " "; int insok = d2.update_method_wo_parameter(finalQuery, "Text");
                            boolCheck = true;
                        }
                    }
                }
                #endregion
            }
            else if (rbl_rollnoNew.SelectedIndex == 3)
            {
                #region others
                string newVenCode = generateVendorCode().Trim();
                string staffId = Convert.ToString(txtroll_other.Text.Trim());
                string staffMob = Convert.ToString(txt_otherMobile.Text.Trim());
                try
                {
                    d2.update_method_wo_parameter("if not exists (select VendorCode from co_vendormaster where vendorname='" + staffId + "' and VendorMobileNo='" + staffMob + "'  and VendorType=-5) insert into co_vendormaster  (VendorCode,vendorname,VendorMobileNo,VendorAddress,VendorCity,VendorCompName,VendorType) values ('" + newVenCode + "','" + staffId + "','" + staffMob + "','" + txtAdd1_Other.Text.Trim() + "','" + txtAdd2_Other.Text.Trim() + "','" + txtname_other.Text.Trim() + "',-5) else update co_vendormaster set VendorAddress='" + txtAdd1_Other.Text.Trim() + "',VendorCity='" + txtAdd2_Other.Text.Trim() + "',VendorCompName='" + txtname_other.Text.Trim() + "'  where vendorname='" + staffId + "' and VendorMobileNo='" + staffMob + "'  and VendorType=-5 ", "Text");
                }
                catch (Exception ex) { d2.sendErrorMail(ex, collegecode1, "ChallanReceipt"); }
                newVenCode = d2.GetFunction("select VendorCode from co_vendormaster where vendorname='" + staffId + "' and VendorMobileNo='" + staffMob + "'  and VendorType=-5").Trim();
                if (newVenCode != "" && newVenCode != "0")
                {
                    #region  Others
                    string venPk = d2.GetFunction("select VendorPK from co_vendormaster where VendorCode='" + newVenCode + "'  and VendorType=-5").Trim();
                    if (!string.IsNullOrEmpty(venPk) && venPk != "0")
                    {
                        string appNo = venPk;
                        string feecat = "0";
                        foreach (GridViewRow gdrow in grid_Details.Rows)
                        {
                            CheckBox cbsel = (CheckBox)gdrow.FindControl("cb_selectLedger");
                            if (!cbsel.Checked)
                                continue;
                            Label lblhdfk = (Label)gdrow.FindControl("lbl_hdrid");
                            Label lblldfk = (Label)gdrow.FindControl("lbl_feecode");
                            // Label lblfeecat = (Label)gdrow.FindControl("lbl_textCode");
                            TextBox lblfeeAmt = (TextBox)gdrow.FindControl("txt_fee_amt");
                            TextBox lbldeductAmt = (TextBox)gdrow.FindControl("txt_deduct_amt");
                            TextBox lbltotAmt = (TextBox)gdrow.FindControl("txt_tot_amt");
                            TextBox lblpaidAmt = (TextBox)gdrow.FindControl("txt_paid_amt");
                            TextBox lblbalAmt = (TextBox)gdrow.FindControl("txt_bal_amt");
                            TextBox lbltobeAmt = (TextBox)gdrow.FindControl("txt_tobepaid_amt");
                            Label lblfinFk = (Label)gdrow.FindControl("lblfinfk");
                            double feeAmt = 0;
                            double deductAmt = 0;
                            double totAmt = 0;
                            double paidAmt = 0;
                            double balaAmt = 0;
                            double tobepaid = 0;
                            double.TryParse(Convert.ToString(lblfeeAmt.Text), out feeAmt);
                            double.TryParse(Convert.ToString(lbldeductAmt.Text), out deductAmt);
                            double.TryParse(Convert.ToString(lbltotAmt.Text), out totAmt);
                            double.TryParse(Convert.ToString(lblpaidAmt.Text), out paidAmt);
                            double.TryParse(Convert.ToString(lblbalAmt.Text), out balaAmt);
                            double.TryParse(Convert.ToString(lbltobeAmt.Text), out tobepaid);
                            double balAmt = totAmt - paidAmt;
                            if (feeAmt == 0.0) //Aruna
                                continue;
                            if (totAmt != 0 && tobepaid != 0)
                            {
                                string insertQuery = " INSERT INTO FT_FeeAllot(AllotDate,MemType,PayMode,App_No,LedgerFK,HeaderFK,FeeAmount,TotalAmount,FeeCategory,BalAmount,FinYearFK,FromGovtAmt,deductamout) VALUES('" + DateTime.Now.ToString("MM/dd/yyyy") + "',4,1," + appNo + "," + lblldfk.Text + "," + lblhdfk.Text + "," + feeAmt + "," + totAmt + "," + feecat + "," + balAmt + "," + finYeaid + ",0,'" + deductAmt + "') ";
                                selectQuery = " select * from FT_FeeAllot where LedgerFK in('" + lblldfk.Text + "') and HeaderFK in('" + lblhdfk.Text + "') and FeeCategory in('" + feecat + "')  and App_No in('" + appNo + "') and finyearfk='" + finYeaid + "' and memtype='4'";
                                //  string updateQuery = "  update FT_FeeAllot set AllotDate='" + DateTime.Now.ToString("MM/dd/yyyy") + "', MemType=1,FeeAmount=isnull(FeeAmount,0)+" + feeAmt + ",BalAmount=isnull(BalAmount,0)+" + balAmt + ",TotalAmount=isnull(TotalAmount,0)+" + totAmt + " where LedgerFK in('" + lblldfk.Text + "') and HeaderFK in('" + lblhdfk.Text + "') and FeeCategory in('" + lblfeecat.Text + "')  and App_No in('" + appNo + "') and finyearfk='" + finYeaid + "'";
                                string updateQuery = "  update FT_FeeAllot set AllotDate='" + DateTime.Now.ToString("MM/dd/yyyy") + "',FeeAmount=isnull(FeeAmount,0)+" + feeAmt + ",BalAmount=isnull(BalAmount,0)+" + balAmt + ",TotalAmount=isnull(TotalAmount,0)+" + totAmt + " where LedgerFK in('" + lblldfk.Text + "') and HeaderFK in('" + lblhdfk.Text + "') and FeeCategory in('" + feecat + "')  and App_No in('" + appNo + "') and finyearfk='" + finYeaid + "' and memtype='4'";

                                string finalQuery = " if exists ( " + selectQuery + " ) " + updateQuery + " else " + insertQuery + " ";
                                int insok = d2.update_method_wo_parameter(finalQuery, "Text");
                                boolCheck = true;
                            }
                        }
                    }
                    #endregion
                }
                #endregion
            }
            if (cbAdvance.Checked)
            {
                boolCheck = true;
            }
        }
        catch { }
        return boolCheck;
    }
    protected bool allotAdvanceAmt(string appno, string feecat, string excessval, string finYearid, string transdate, string transcode)
    {
        bool boolCheck = false;
        try
        {
            #region excess amount

            if (excessval != "0")
            {
                string select = "if exists(select * from FT_ExcessDet where App_No='" + appno + "' and ExcessType='1' and FeeCategory='" + feecat + "'  and Ex_JournalEntry='1')update FT_ExcessDet set ExcessAmt=isnull(ExcessAmt,'0')+'" + excessval + "',BalanceAmt=isnull(BalanceAmt,'0')+'" + excessval + "' where App_No='" + appno + "' and ExcessType='1'  and FeeCategory='" + feecat + "'  and Ex_JournalEntry='1' else insert into FT_ExcessDet (ExcessTransDate,dailytranscode,TransTime,MemType,App_No ,ExcessType,ExcessAmt,BalanceAmt,FinYearFK , FeeCategory,Ex_JournalEntry) values('" + transdate + "','" + transcode + "','" + DateTime.Now.ToLongTimeString() + "','1','" + appno + "','1','" + excessval + "','" + excessval + "','" + finYearid + "','" + feecat + "','1')";
                //and ExcessTransDate='" + transdate + "' and dailytranscode='" + transcode + "' and FinYearFK='" + finYearid + "'
                //and ExcessTransDate='" + transdate + "' and dailytranscode='" + transcode + "'
                int exCal = d2.update_method_wo_parameter(select, "Text");
                if (exCal > 0)
                {
                    string getvalue = d2.GetFunction("select ExcessDetPK from FT_ExcessDet where App_No ='" + appno + "' and ExcessType ='1'  and Ex_JournalEntry='1'");//and ExcessTransDate='" + transdate + "' and dailytranscode='" + transcode + "'
                    if (getvalue != "0")
                    {
                        foreach (GridViewRow row in grid_Details.Rows)
                        {
                            CheckBox chkOkPay = (CheckBox)row.FindControl("cb_selectLedger");

                            TextBox txtFeeamt = (TextBox)row.FindControl("txt_fee_amt");
                            double feeAmt = 0;
                            double.TryParse(Convert.ToString(txtFeeamt.Text), out feeAmt);
                            if ((!chkOkPay.Checked && feeAmt == 0) || (chkOkPay.Checked && feeAmt == 0))
                                continue;
                            TextBox txtTotalamt = (TextBox)row.FindControl("txt_tot_amt");
                            TextBox txtPaidamt = (TextBox)row.FindControl("txt_paid_amt");
                            TextBox txtBalamt = (TextBox)row.FindControl("txt_bal_amt");
                            TextBox txtTobePaidamt = (TextBox)row.FindControl("txt_tobepaid_amt");
                            TextBox txtExcessGridAmt = (TextBox)row.FindControl("txt_gridexcess_amt");
                            TextBox txtScholAmt = (TextBox)row.FindControl("txt_scholar_amt");
                            TextBox txtCautAmt = (TextBox)row.FindControl("txt_deposit_amt");
                            Label lblFeeCategory = (Label)row.FindControl("lbl_textCode");
                            Label lblhdFK = (Label)row.FindControl("lbl_hdrid");
                            Label lblLedgFK = (Label)row.FindControl("lbl_feecode");

                            string actualFinYearFk = string.Empty;
                            actualFinYearFk = d2.getCurrentFinanceYear(usercode, collegecode1);

                            //string header = Convert.ToString(ddlMainJrHed.SelectedValue);
                            //string ledger = Convert.ToString(ddlMainJrLed.SelectedValue);
                            double tempExcess = 0;
                            double.TryParse(txtTobePaidamt.Text, out tempExcess);
                            if (tempExcess != 0)
                            {
                                string selqry = "select * from FT_ExcessLedgerDet if  exists(select * from FT_ExcessLedgerDet where  ExcessDetFK='" + getvalue + "' and HeaderFK='" + lblhdFK.Text + "' and LedgerFK='" + lblLedgFK.Text + "'  and FeeCategory in('" + feecat + "') )update FT_ExcessLedgerDet set ExcessAmt=isnull(ExcessAmt,'0')+'" + tempExcess + "',BalanceAmt=isnull(BalanceAmt,'0')+'" + tempExcess + "' where ExcessDetFK='" + getvalue + "' and HeaderFK ='" + lblhdFK.Text + "' and LedgerFK='" + lblLedgFK.Text + "' and FeeCategory in('" + feecat + "') else insert into FT_ExcessLedgerDet (HeaderFK,LedgerFK,ExcessAmt,BalanceAmt,ExcessDetFK,FinYearFK,FeeCategory) values('" + lblhdFK.Text + "','" + lblLedgFK.Text + "','" + tempExcess + "','" + tempExcess + "','" + getvalue + "','" + finYearid + "','" + feecat + "')";
                                int upda = d2.update_method_wo_parameter(selqry, "Text");
                                if (upda > 0)
                                {
                                    string insExcessRcpt = " if exists (select * from ft_excessReceiptdet where app_no='" + appno + "' and receiptno='" + transcode + "' and ledgerfk='" + lblLedgFK.Text + "' and excesstype='1') update ft_excessReceiptdet set amount=isnull(amount,'0')+'" + tempExcess + "' where app_no='" + appno + "' and receiptno='" + transcode + "' and ledgerfk='" + lblLedgFK.Text + "' and excesstype='1' else  insert into ft_excessReceiptdet (app_no , amount , receiptno ,rcptdate,ledgerfk,excesstype ) values ('" + appno + "', '" + tempExcess + "', '" + transcode + "','" + DateTime.Now.Date.ToString() + "','" + lblLedgFK.Text + "','1')";
                                    d2.update_method_wo_parameter(insExcessRcpt, "Text");
                                }
                                excessval = "0";
                                boolCheck = true;
                            }
                        }
                    }
                }
            }
            #endregion
        }
        catch { }
        return boolCheck;
    }

    protected void btn_sureyesRcpt_Click(object sender, EventArgs e)
    {

        Div4.Visible = false;//surediv invisible
        imgAlert.Attributes.Add("Style", " display:none;");
        bool recptNoOk = false;
        #region Check for Common or Headerwise Receipt Number
        string hdrSetPK = string.Empty;
        if (isHeaderwise == 1 || isHeaderwise == 3)
        {
            if (isHeaderReceipNoOk(out hdrSetPK))
            {
                if (hdrSetPK != string.Empty)
                {
                    recptNoOk = true;
                }
                else
                {
                    imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                    lbl_alert.Text = "Please Select Particualar Header";//"Receipt No Not Assigned For Selected Headers";
                }
            }
            else
            {
                imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                lbl_alert.Text = "Please Select Particualar Header"; //"Receipt No Not Assigned For Selected Headers";
            }
        }
        else
        {
            recptNoOk = true;
        }
        #endregion
        if (recptNoOk)
        {
            if (saveMiscellaneous())//allot insert or update 
            {
                #region Admission Number Generation While Receipt Save
                bool isAdmNoGenSettingsOn = false;
                string admNoGenbatch = string.Empty;
                isAdmNoGenSettingsOn = getAdmGenOnRcpt(collegecode1, usercode, ref  admNoGenbatch);
                #endregion

                int rcptType = 1;
                if (!cb_selcthd.Checked)
                {
                    rcptType = 1;
                }
                else
                {
                    rcptType = rbl_headerselect.SelectedIndex + 2;
                }
                if (chl_MulRcpt.Checked)
                {
                    #region Multiple Receipt
                    string queryPrint = "select * from FM_RcptChlPrintSettings where collegecode ='" + collegecode1 + "'  select * from New_InsSettings where (LinkName='ReceiptPrintFormat' or LinkName='ChallanPrintFormat') and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "'";
                    DataSet dsPri = new DataSet();
                    dsPri = d2.select_method_wo_parameter(queryPrint, "Text");
                    if (dsPri.Tables.Count > 0)
                    {
                        if (dsPri.Tables[0].Rows.Count > 0 && dsPri.Tables[1].Rows.Count > 0)
                        {
                            string insqry1 = "select LinkValue from New_InsSettings where LinkName='ReceiptPrintFormat' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "'";
                            int save1 = Convert.ToInt32(d2.GetFunction(insqry1));

                            if (txt_tostudentsrcpt.Text.Trim() != "" && txt_tostudentsrcpt.Text.Trim() != "0")
                            {
                                string receiptno = string.Empty;
                                //modified by sudhagar editable receipt no
                                string tempRcpt = Convert.ToString(txttemprcpt.Text.Trim());
                                if (!string.IsNullOrEmpty(tempRcpt))
                                    receiptno = tempRcpt;
                                else
                                    receiptno = txt_rcptno.Text.Trim();
                                if (receiptno.Trim() != "" || save1 == 5)
                                {

                                    #region Common Fields
                                    string bnkname = string.Empty;
                                    string branch = string.Empty;
                                    string checkDDno = string.Empty;
                                    string checkDDdate = string.Empty;
                                    string newbankname = string.Empty;
                                    string newbankcode = string.Empty;
                                    string ledgercode = string.Empty;
                                    string description = string.Empty;
                                    string mode = string.Empty;
                                    string PayMode = "1";


                                    string[] dtrctptsplit = txt_date.Text.Split('/');
                                    string[] dtchkddsplit = txt_date1.Text.Split('/');
                                    DateTime dtrcpt = Convert.ToDateTime(dtrctptsplit[1] + "/" + dtrctptsplit[0] + "/" + dtrctptsplit[2]);
                                    string dtchkdd = dtchkddsplit[1] + "/" + dtchkddsplit[0] + "/" + dtchkddsplit[2];

                                    description = txt_remark.Text.Trim();


                                    string finYearid = d2.getCurrentFinanceYear(usercode, collegecode1);
                                    string memtype = "1";
                                    switch (rbl_rollnoNew.SelectedIndex)
                                    {
                                        case 0:
                                            memtype = "1";
                                            break;
                                        case 1:
                                            memtype = "2";
                                            break;
                                        case 2:
                                            memtype = "3";
                                            break;
                                        case 3:
                                            memtype = "4"; ;
                                            break;
                                    }

                                    if (ddl_bkname.SelectedItem.Text.ToUpper() == "OTHERS")
                                    {
                                        newbankname = txt_other.Text.Trim();
                                        newbankcode = subjectcode("BName", newbankname);
                                        txt_other.Text = "";
                                    }
                                    else
                                    {
                                        if (ddl_bkname.SelectedIndex != 0)
                                        {
                                            newbankname = ddl_bkname.SelectedItem.Text;
                                            newbankcode = ddl_bkname.SelectedItem.Value;
                                        }
                                        txt_other.Text = "";
                                    }
                                    if (rb_card.Checked)
                                    {
                                        if (ddlCardType.SelectedItem.Text.ToUpper() == "OTHERS")
                                        {
                                            newbankname = txtCardType.Text.Trim();
                                            newbankcode = subjectcode("CardT", newbankname);
                                            txtCardType.Text = "";
                                        }
                                        else
                                        {
                                            if (ddlCardType.SelectedIndex != 0)
                                            {
                                                newbankname = ddlCardType.SelectedItem.Text;
                                                newbankcode = ddlCardType.SelectedItem.Value;
                                            }
                                            txtCardType.Text = "";
                                        }
                                    }

                                    if (rdo_receipt.Checked)
                                    {

                                        if (rb_cash.Checked)
                                        {
                                            mode = "cash";
                                            PayMode = "1";
                                            dtchkdd = "";
                                        }
                                        else if (rb_cheque.Checked)
                                        {

                                            mode = "cheque";
                                            PayMode = "2";
                                            checkDDno = txt_chqno.Text.Trim();
                                            branch = txt_branch.Text.Trim();

                                        }
                                        else if (rb_dd.Checked)
                                        {
                                            mode = "dd";
                                            PayMode = "3";
                                            checkDDno = txt_ddno.Text.Trim();
                                            branch = txt_branch.Text.Trim();
                                        }
                                        else if (rb_card.Checked)
                                        {
                                            mode = "card";
                                            PayMode = "6";
                                            checkDDno = txtLast4No.Text.Trim();
                                            branch = newbankname.Trim();
                                        }

                                    }

                                    bool bankdetailsOK = false;
                                    if (mode == "cheque" || mode == "dd" || mode == "card")
                                    {
                                        if (newbankname != "" && newbankcode != "" && branch != "" && checkDDno != "")
                                        {
                                            bankdetailsOK = true;
                                        }
                                    }
                                    else if (mode == "cash")
                                    {
                                        bankdetailsOK = true;
                                    }
                                    #endregion

                                    if (bankdetailsOK)
                                    {


                                        bool FromJpr = false;
                                        bool createPDFOK = false;
                                        contentDiv.InnerHtml = "";
                                        StringBuilder sbHtml = new StringBuilder();
                                        double overallCashAmt = 0;
                                        int count = 0;
                                        for (int rowStud = 1; rowStud < Fpspread1.Sheets[0].RowCount; rowStud++)
                                        {
                                            sbHtml.Clear();
                                            bool InsertUpdateOK = false;

                                            if (txt_tostudentsrcpt.Text.Trim() == "" || txt_tostudentsrcpt.Text.Trim() == "0")
                                            {
                                                continue;
                                            }
                                            int checkval = Convert.ToInt32(Fpspread1.Sheets[0].Cells[rowStud, 1].Value);
                                            if (checkval == 1)
                                            {
                                                count++;

                                                string roll_admit = string.Empty;
                                                roll_admit = Convert.ToString(Fpspread1.Sheets[0].Cells[rowStud, 2].Text);

                                                #region For Each Student

                                                string rollno = string.Empty;
                                                string studname = string.Empty;
                                                //  string receiptno = string.Empty;
                                                string name = string.Empty;
                                                string Roll_admit = string.Empty;
                                                Roll_admit = roll_admit;
                                                string section = string.Empty;

                                                string app_formno = string.Empty;
                                                string appnoNew = string.Empty;
                                                string Regno = string.Empty;

                                                txt_rcptno.Text = generateReceiptNo();
                                                accidRecpt = lblaccid.Text;
                                                lastRecptNo = lstrcpt.Text;
                                                ////modified by sudhagar editable receipt no
                                                //string tempRcpt = Convert.ToString(txttemprcpt.Text.Trim());
                                                //if (!string.IsNullOrEmpty(tempRcpt))
                                                //    receiptno = tempRcpt;
                                                //else
                                                //    receiptno = txt_rcptno.Text.Trim();

                                                string queryRollApp = "select r.Roll_No,a.app_formno,a.app_no, r.Reg_No,r.Stud_Name,r.sections from Registration r,applyn a where r.App_No=a.app_no  and r.college_code='" + collegecode1 + "'  and r.Roll_Admit='" + roll_admit + "'";
                                                DataSet dsRollApp = new DataSet();
                                                dsRollApp = d2.select_method_wo_parameter(queryRollApp, "Text");
                                                if (dsRollApp.Tables.Count > 0)
                                                {
                                                    if (dsRollApp.Tables[0].Rows.Count > 0)
                                                    {
                                                        rollno = Convert.ToString(dsRollApp.Tables[0].Rows[0]["Roll_No"]);
                                                        app_formno = Convert.ToString(dsRollApp.Tables[0].Rows[0]["app_formno"]);
                                                        appnoNew = Convert.ToString(dsRollApp.Tables[0].Rows[0]["app_no"]);
                                                        Regno = Convert.ToString(dsRollApp.Tables[0].Rows[0]["Reg_No"]);
                                                        studname = Convert.ToString(dsRollApp.Tables[0].Rows[0]["Stud_Name"]);
                                                        section = Convert.ToString(dsRollApp.Tables[0].Rows[0]["sections"]);

                                                    }
                                                }
                                                //rollno = txt_rollno.Text.Trim();
                                                //app_formno = txt_rollno.Text.Trim();
                                                //roll_admit = txt_rollno.Text.Trim();

                                                name = rollno + "-" + studname;

                                                if (rollno != "" && studname != "" && roll_admit != "" && app_formno != "" && ((receiptno != "" && lastRecptNo != "") || save1 == 5) && collegecode1 != "" && usercode != "" && appnoNew != "" && finYearid != "")
                                                {
                                                    #region INSERTION AND UPDATION CODE
                                                    //Print Region
                                                    try
                                                    {
                                                        #region Print Option For Receipt

                                                        //Basic Data
                                                        //string rollno = txt_rollno.Text.Trim();
                                                        string recptNo = txt_rcptno.Text.Trim();
                                                        string recptDt = txt_date.Text.Trim();
                                                        //string studname = txt_name.Text.Trim();
                                                        string course = txt_dept.Text.Trim();
                                                        string batchYrSem = string.Empty;

                                                        try
                                                        {
                                                            course = course.Split('-')[0];
                                                        }
                                                        catch { course = ""; }


                                                        //Fields to print                                           



                                                        if (save1 == 13)
                                                        {
                                                            try
                                                            {
                                                                FormatXIIIVelammalSchoolReceiptChallan rcpt = new FormatXIIIVelammalSchoolReceiptChallan();
                                                                // contentDiv.InnerHtml = rcpt.generateMultiple(dsPri, collegecode1, appnoNew, section, ref  recptDoc, ref  rcptpage, recptNo, studname, recptDt, Regno, rollno, app_formno, rb_cash, rb_dd, rb_cheque, rb_card, checkDDno, newbankname, branch, txt_date1, txt_remark, mode, rbl_rollnoNew, ddl_semrcpt, cbl_grpheader, rbl_headerselect, lbltype, rdo_receipt, rdo_sngle, PayMode, dtrcpt, memtype, receiptno, dtchkdd, newbankcode, usercode, finYearid, rcptType, InsertUpdateOK, ref  createPDFOK, BalanceType, ref  overallCashAmt, course, txt_ddno, ddl_bkname, txt_chqno, Roll_admit);
                                                            }
                                                            catch { imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;"); }
                                                        }
                                                        #endregion

                                                        #region Update Receipt No
                                                        if (save1 != 5)
                                                        {
                                                            if (string.IsNullOrEmpty(tempRcpt))
                                                            {
                                                                string updateRecpt = string.Empty;
                                                                if (isHeaderwise == 0 || isHeaderwise == 2)
                                                                {
                                                                    updateRecpt = " update FM_FinCodeSettings set RcptStNo=" + lastRecptNo + "+1 where collegecode =" + collegecode1 + " and FromDate = (select MAX(FromDate) from FM_FinCodeSettings where IsHeader=0 and FinYearFK=" + finYearid + " and CollegeCode=" + collegecode1 + ")";
                                                                }
                                                                else
                                                                {
                                                                    updateRecpt = "update FM_HeaderFinCodeSettings set RcptStNo=" + lastRecptNo + "+1 where HeaderSettingPK=" + hdrSetPK + " and FinyearFK=" + finYearid + " and CollegeCode=" + collegecode1 + "";
                                                                }
                                                                d2.update_method_wo_parameter(updateRecpt, "Text");
                                                            }
                                                            #region Admission Number Generation
                                                            if (isAdmNoGenSettingsOn)
                                                            {
                                                                string app_formNo = string.Empty;
                                                                if (isAdmNoNotGenerated(appnoNew, admNoGenbatch, ref app_formNo))
                                                                {
                                                                    string degreecode = d2.GetFunction("select degree_code from registration where app_no='" + appnoNew + "'");
                                                                    string generatedAdmNo = string.Empty;
                                                                    if (admissionNoGeneration())
                                                                    {
                                                                        generatedAdmNo = generateAdmissionNo(collegecode1,
       degreecode, admNoGenbatch).Trim();
                                                                    }
                                                                    if (generatedAdmNo == string.Empty)
                                                                    {
                                                                        generatedAdmNo = app_formNo;
                                                                    }

                                                                    d2.select_method_wo_parameter("if exists(select * from Registration where App_No='" + appnoNew + "' and college_code='" + collegecode1 + "') update registration set roll_admit='" + generatedAdmNo + "' where app_no='" + appnoNew + "'  and college_code='" + collegecode1 + "'", "Text");

                                                                    d2.select_method_wo_parameter("update applyn set is_enroll='2' where app_no='" + appnoNew + "'  and college_code='" + collegecode1 + "'", "Text");

                                                                }
                                                            }
                                                            #endregion
                                                        }
                                                        #endregion
                                                    }
                                                    catch (Exception ex) { d2.sendErrorMail(ex, collegecode1, "ChallanReceipt"); }
                                                    finally
                                                    {
                                                    }
                                                    #endregion

                                                }
                                                else
                                                {
                                                    imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                                                    //this.Form.DefaultButton = "btn_alertclose";
                                                    lbl_alert.Text = "Please Enter All Fields";
                                                }
                                                #endregion
                                            }
                                        }

                                        #region update CashTransaction
                                        if (rb_cash.Checked && overallCashAmt > 0)
                                        {
                                            string upCashTrans = "  if exists (select * from FT_FinCashTransaction where TransDate ='" + dtrcpt + "' and FinYearFK ='" + finYearid + "' and EntryUserCode='" + usercode + "') update FT_FinCashTransaction set TransTime ='" + DateTime.Now.ToLongTimeString() + "', Debit =isnull(Debit,0) +" + overallCashAmt + " where FinYearFK ='" + finYearid + "' and TransDate ='" + dtrcpt + "' and EntryUserCode='" + usercode + "' else insert into FT_FinCashTransaction (TransDate,TransTime,Debit,FinYearFK,EntryUserCode) values ('" + dtrcpt + "','" + DateTime.Now.ToLongTimeString() + "'," + overallCashAmt + ",'" + finYearid + "','" + usercode + "')";
                                            d2.update_method_wo_parameter(upCashTrans, "Text");
                                        }
                                        #endregion

                                        #region Create PDF DOC
                                        if (FromJpr && createPDFOK && count > 0)
                                        {
                                            txttemprcpt.Text = "";
                                            Clear();
                                            imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                                            //this.Form.DefaultButton = "btn_alertclose";
                                            lbl_alert.Text = "Saved Successfully";
                                        }
                                        else if (createPDFOK && count > 0)
                                        {
                                            if ((save1 == 3 || save1 == 6 || save1 == 7 || save1 == 8 || save1 == 9 || save1 == 11 || save1 == 12 || save1 == 13) && contentDiv.InnerHtml.Trim() != "")
                                            {
                                                #region New Print
                                                //contentDiv.InnerHtml += sbHtml.ToString();
                                                contentDiv.Visible = true;
                                                ScriptManager.RegisterStartupScript(this, GetType(), "InvokeButton", "PrintDiv();", true);
                                                #endregion
                                            }
                                            else
                                            {
                                                //Response Write
                                                string appPath = HttpContext.Current.Server.MapPath("~");
                                                if (appPath != "")
                                                {
                                                    string szPath = appPath + "/Report/";
                                                    string szFile = "Receipt" + DateTime.Now.ToString("ddMMyyyy") + DateTime.Now.ToString("HHMMss") + ".pdf";

                                                    Response.Buffer = true;
                                                    Response.Clear();
                                                    //recptDoc.SaveToFile(szPath + szFile);
                                                    //Response.ClearHeaders();
                                                    //Response.AddHeader("Content-Disposition", "attachment; filename=" + szFile);
                                                    //Response.ContentType = "application/pdf";
                                                    //Response.WriteFile(szPath + szFile);

                                                    Response.Write("<script>window.open('PrintPage.aspx?name=" + szFile + "', '_blank');</script>");


                                                    imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                                                    //this.Form.DefaultButton = "btn_alertclose";
                                                    lbl_alert.Text = "Receipt Generated";
                                                }
                                                else
                                                {
                                                    imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                                                    //this.Form.DefaultButton = "btn_alertclose";
                                                    lbl_alert.Text = "Server Path Not Found";
                                                }
                                            }


                                        }
                                        else
                                        {
                                            imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                                            //this.Form.DefaultButton = "btn_alertclose";
                                            lbl_alert.Text = "Receipt Not Generated. Inadequate Details";
                                        }
                                        #endregion
                                    }
                                    else
                                    {
                                        imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                                        //this.Form.DefaultButton = "btn_alertclose";
                                        lbl_alert.Text = "Please Enter All Bank Fields";
                                    }
                                }
                                else
                                {
                                    //Invalid ReceiptNo
                                    imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                                    //this.Form.DefaultButton = "btn_alertclose";
                                    lbl_alert.Text = "Invalid Receipt Number";
                                }
                            }
                            else
                            {
                                imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                                //this.Form.DefaultButton = "btn_alertclose";
                                lbl_alert.Text = "Please Select Any Student";
                            }
                        }
                        else
                        {
                            imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                            //this.Form.DefaultButton = "btn_alertclose";
                            lbl_alert.Text = "Please Add Print Settings";
                        }
                    }
                    else
                    {
                        imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                        //this.Form.DefaultButton = "btn_alertclose";
                        lbl_alert.Text = "Please Add Print Settings";
                    }
                    #endregion
                }
                else
                {
                    #region Single receipt
                    //FINE LEDGER MANDATORY CHECK
                    bool fineOk = true;
                    if (grid_Details.Rows.Count > 0)
                    {
                        CheckBox chkOkPayFine = (CheckBox)grid_Details.Rows[0].FindControl("cb_selectLedger");
                        Label lblFineFeeCat = (Label)grid_Details.Rows[0].FindControl("lbl_textCode");
                        if (lblFineFeeCat.Text.Trim().Contains("$"))
                        {
                            if (!chkOkPayFine.Checked)
                            {
                                fineOk = false;
                            }
                        }
                    }

                    //FINE LEDGER CHECK END

                    if (fineOk)
                    {
                        checkFromPopper = true;
                        if (checkFromPopper)
                        {
                            checkFromPopper = false;
                            string queryPrint = "select * from FM_RcptChlPrintSettings where collegecode ='" + collegecode1 + "' select * from New_InsSettings where (LinkName='ReceiptPrintFormat' or LinkName='ChallanPrintFormat') and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "'";
                            DataSet dsPri = new DataSet();
                            dsPri = d2.select_method_wo_parameter(queryPrint, "Text");
                            if (dsPri.Tables.Count > 0)
                            {
                                if (dsPri.Tables[0].Rows.Count > 0 && dsPri.Tables[1].Rows.Count > 0)
                                {
                                    string insqry1 = "select LinkValue from New_InsSettings where LinkName='ReceiptPrintFormat' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "'";
                                    int save1 = Convert.ToInt32(d2.GetFunction(insqry1));

                                    try
                                    {
                                        string receiptno = string.Empty;
                                        //modified by sudhagar editable receipt no
                                        string tempRcpt = Convert.ToString(txttemprcpt.Text.Trim());
                                        if (!string.IsNullOrEmpty(tempRcpt))
                                            receiptno = tempRcpt;
                                        else
                                            receiptno = txt_rcptno.Text.Trim();
                                        if (receiptno.Trim() != "" || save1 == 5)
                                        {
                                            bool InsertUpdateOK = false;
                                            string rollno = string.Empty;
                                            string studname = string.Empty;
                                            // string receiptno = string.Empty;
                                            string ChallanDate = string.Empty;
                                            string name = string.Empty;

                                            string challanno = string.Empty;

                                            string clgbankmane = string.Empty;
                                            string bankPk = string.Empty;
                                            string bnkCity = string.Empty;
                                            string bnkname = string.Empty;
                                            string branch = string.Empty;
                                            string checkDDno = string.Empty;
                                            string checkDDdate = string.Empty;
                                            string newbankname = string.Empty;
                                            string newbankcode = string.Empty;
                                            string ledgercode = string.Empty;
                                            string description = string.Empty;
                                            string mode = string.Empty;
                                            string roll_admit = string.Empty;
                                            string app_formno = string.Empty;
                                            string appnoNew = string.Empty;
                                            string Regno = string.Empty;
                                            string PayMode = "1";
                                            string Roll_admit = string.Empty;
                                            string section = string.Empty;
                                            string StudMode = string.Empty;
                                            string batch_year = string.Empty;

                                            roll_admit = lblstaticrollno.Text.Trim();
                                            if (rbl_rollnoNew.SelectedIndex == 1)
                                            {
                                                roll_admit = txtroll_staff.Text.Trim();
                                            }
                                            Roll_admit = roll_admit;

                                            accidRecpt = lblaccid.Text;
                                            lastRecptNo = lstrcpt.Text;

                                            string[] dtrctptsplit = txt_date.Text.Split('/');
                                            string[] dtchkddsplit = txt_date1.Text.Split('/');
                                            DateTime dtrcpt = Convert.ToDateTime(dtrctptsplit[1] + "/" + dtrctptsplit[0] + "/" + dtrctptsplit[2]);
                                            string dtchkdd = dtchkddsplit[1] + "/" + dtchkddsplit[0] + "/" + dtchkddsplit[2];

                                            description = txt_remark.Text.Trim();
                                            txt_rcptno.Text = generateReceiptNo();
                                            ////modified by sudhagar editable receipt no
                                            //string tempRcpt = Convert.ToString(txttemprcpt.Text.Trim());
                                            //if (!string.IsNullOrEmpty(tempRcpt))
                                            //    receiptno = tempRcpt;
                                            //else
                                            //    receiptno = txt_rcptno.Text.Trim();

                                            string finYearid = d2.getCurrentFinanceYear(usercode, collegecode1);
                                            string memtype = "1";
                                            switch (rbl_rollnoNew.SelectedIndex)
                                            {
                                                case 0:
                                                    memtype = "1";
                                                    break;
                                                case 1:
                                                    memtype = "2";
                                                    break;
                                                case 2:
                                                    memtype = "3";
                                                    break;
                                                case 3:
                                                    memtype = "4"; ;
                                                    break;
                                            }
                                            string excessFeecat = "0";
                                            string curSemEx = "0";
                                            if (rbl_rollnoNew.SelectedIndex == 0)
                                            {
                                                string queryRollApp = "select r.Roll_No,a.app_formno,a.app_no,r.Reg_No, r.Current_Semester,r.sections,r.mode,r.batch_year from Registration r,applyn a where r.App_No=a.app_no  and r.college_code='" + collegecode1 + "'  and r.Roll_Admit='" + roll_admit + "'";
                                                if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 3)
                                                {
                                                    queryRollApp = "select app_formno as Roll_No,app_formno,app_no,app_formno as Reg_No, Current_Semester,'' sections ,mode,batch_year  from applyn  where  app_formno='" + roll_admit + "'  and college_code='" + collegecode1 + "' ";
                                                }
                                                DataSet dsRollApp = new DataSet();
                                                dsRollApp = d2.select_method_wo_parameter(queryRollApp, "Text");
                                                if (dsRollApp.Tables.Count > 0 && dsRollApp.Tables[0].Rows.Count > 0)
                                                {
                                                    rollno = Convert.ToString(dsRollApp.Tables[0].Rows[0]["Roll_No"]);
                                                    app_formno = Convert.ToString(dsRollApp.Tables[0].Rows[0]["app_formno"]);
                                                    appnoNew = Convert.ToString(dsRollApp.Tables[0].Rows[0]["app_no"]);
                                                    Regno = Convert.ToString(dsRollApp.Tables[0].Rows[0]["Reg_No"]);
                                                    curSemEx = Convert.ToString(dsRollApp.Tables[0].Rows[0]["Current_Semester"]);
                                                    section = Convert.ToString(dsRollApp.Tables[0].Rows[0]["sections"]);
                                                    StudMode = Convert.ToString(dsRollApp.Tables[0].Rows[0]["mode"]);
                                                    batch_year = Convert.ToString(dsRollApp.Tables[0].Rows[0]["batch_year"]);

                                                    string clgOrSem = d2.GetFunction("select LinkValue from New_InsSettings where linkname = 'Fee Yearwise' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "'").Trim();

                                                    if (clgOrSem == "0")
                                                    {
                                                        excessFeecat = d2.GetFunction("select TextCode from TextValTable where textval='" + curSemEx + " Semester' and college_code=" + collegecode1 + "").Trim();
                                                    }
                                                    else
                                                    {
                                                        #region Year For Sem
                                                        curSemEx = returnYearforSem(curSemEx);
                                                        excessFeecat = d2.GetFunction("select TextCode from TextValTable where textval='" + curSemEx + " Year' and college_code=" + collegecode1 + "").Trim();
                                                        #endregion
                                                    }
                                                }
                                            }
                                            else if (rbl_rollnoNew.SelectedIndex == 1)
                                            {
                                                appnoNew = d2.GetFunction("select a.appl_id from staffmaster s,staff_appl_master a where s.appl_no=a.appl_no and s.staff_code='" + txtroll_staff.Text.Trim() + "' and s.college_code=" + collegecode1 + " ");
                                                rollno = roll_admit;
                                                app_formno = roll_admit;
                                                Regno = roll_admit;
                                            }
                                            else if (rbl_rollnoNew.SelectedIndex == 2)
                                            {
                                                try
                                                {
                                                    appnoNew = txtname_vendor.Text.Trim().Split('-')[2];
                                                    rollno = appnoNew;
                                                    app_formno = appnoNew;
                                                    Regno = appnoNew;
                                                }
                                                catch
                                                {
                                                    appnoNew = "";
                                                    rollno = appnoNew;
                                                    app_formno = appnoNew;
                                                    Regno = appnoNew;
                                                }
                                            }
                                            else if (rbl_rollnoNew.SelectedIndex == 3)
                                            {
                                                try
                                                {
                                                    string staffId = Convert.ToString(txtroll_other.Text.Trim());
                                                    string staffMob = Convert.ToString(txt_otherMobile.Text.Trim());

                                                    appnoNew = d2.GetFunction("select VendorPK from co_vendormaster where vendorname='" + staffId + "' and VendorMobileNo='" + staffMob + "'  and VendorType=-5").Trim();
                                                    rollno = appnoNew;
                                                    app_formno = appnoNew;
                                                    Regno = appnoNew;
                                                }
                                                catch
                                                {
                                                    appnoNew = "";
                                                    rollno = appnoNew;
                                                    app_formno = appnoNew;
                                                    Regno = appnoNew;
                                                }
                                            }

                                            #region cheque or DD or Card Details
                                            if (ddl_bkname.SelectedItem.Text.ToUpper() == "OTHERS")
                                            {
                                                newbankname = txt_other.Text.Trim();
                                                newbankcode = subjectcode("BName", newbankname);
                                                txt_other.Text = "";
                                            }
                                            else
                                            {
                                                if (ddl_bkname.SelectedIndex != 0)
                                                {
                                                    newbankname = ddl_bkname.SelectedItem.Text;
                                                    newbankcode = ddl_bkname.SelectedItem.Value;
                                                }
                                                txt_other.Text = "";
                                            }
                                            if (rb_card.Checked)
                                            {
                                                if (ddlCardType.SelectedItem.Text.ToUpper() == "OTHERS")
                                                {
                                                    newbankname = txtCardType.Text.Trim();
                                                    newbankcode = subjectcode("CardT", newbankname);
                                                    txtCardType.Text = "";
                                                }
                                                else
                                                {
                                                    if (ddlCardType.SelectedIndex != 0)
                                                    {
                                                        newbankname = ddlCardType.SelectedItem.Text;
                                                        newbankcode = ddlCardType.SelectedItem.Value;
                                                    }
                                                    txtCardType.Text = "";
                                                }
                                            }
                                            #endregion
                                            string ActualfinFk = string.Empty;
                                            bool studfinFk = false;
                                            if (rbl_rollnoNew.SelectedIndex == 0)
                                            {
                                                rollno = txt_rollno.Text.Trim();
                                                app_formno = txt_rollno.Text.Trim();
                                                roll_admit = txt_rollno.Text.Trim();
                                                studname = txt_name.Text.Trim();
                                                name = rollno + "-" + studname;
                                                studfinFk = true;
                                            }
                                            else if (rbl_rollnoNew.SelectedIndex == 1)
                                            {
                                                rollno = txtroll_staff.Text.Trim();
                                                app_formno = txtroll_staff.Text.Trim();
                                                roll_admit = txtroll_staff.Text.Trim();
                                                studname = txtname_staff.Text.Trim();
                                                name = rollno + "-" + studname;
                                            }
                                            else if (rbl_rollnoNew.SelectedIndex == 2)
                                            {
                                                rollno = appnoNew;
                                                app_formno = appnoNew;
                                                roll_admit = appnoNew;
                                                try
                                                {
                                                    studname = txtname_vendor.Text.Trim().Split('-')[0];
                                                }
                                                catch { studname = ""; }
                                                name = rollno + "-" + studname;
                                            }
                                            else if (rbl_rollnoNew.SelectedIndex == 3)
                                            {
                                                rollno = appnoNew;
                                                app_formno = appnoNew;
                                                roll_admit = appnoNew;
                                                string staffId = Convert.ToString(txtroll_other.Text.Trim());
                                                string staffMob = Convert.ToString(txt_otherMobile.Text.Trim());
                                                try
                                                {
                                                    studname = staffId;
                                                }
                                                catch { studname = ""; }
                                                name = studname;// +"-" + staffMob;

                                            }


                                            if (rdo_receipt.Checked)
                                            {
                                                if (rb_cash.Checked)
                                                {
                                                    mode = "cash";
                                                    PayMode = "1";
                                                    dtchkdd = "";
                                                }
                                                else if (rb_cheque.Checked)
                                                {

                                                    mode = "cheque";
                                                    PayMode = "2";
                                                    checkDDno = txt_chqno.Text.Trim();
                                                    branch = txt_branch.Text.Trim();

                                                }
                                                else if (rb_dd.Checked)
                                                {
                                                    mode = "dd";
                                                    PayMode = "3";
                                                    checkDDno = txt_ddno.Text.Trim();
                                                    branch = txt_branch.Text.Trim();
                                                }
                                                else if (rb_card.Checked)
                                                {
                                                    mode = "card";
                                                    PayMode = "6";
                                                    checkDDno = txtLast4No.Text.Trim();
                                                    branch = newbankname.Trim();
                                                }
                                            }

                                            string ScholarTypeQ = "select LinkValue from New_InsSettings where LinkName='ScholarshipType' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "' ";
                                            byte ScholarTypeValue = 0;
                                            byte.TryParse(Convert.ToString(d2.GetFunction(ScholarTypeQ)), out ScholarTypeValue);

                                            string excessTypeQ = "select LinkValue from New_InsSettings where LinkName='ExcessFeesType' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "' ";
                                            byte excessTypeValue = 0;
                                            byte.TryParse(Convert.ToString(d2.GetFunction(excessTypeQ)), out excessTypeValue);

                                            if (rollno != "" && studname != "" && roll_admit != "" && app_formno != "" && ((receiptno != "" && lastRecptNo != "") || save1 == 5) && collegecode1 != "" && usercode != "" && appnoNew != "" && finYearid != "")
                                            {
                                                bool bankdetailsOK = false;
                                                if (mode == "cheque" || mode == "dd" || mode == "card")
                                                {
                                                    if (newbankname != "" && newbankcode != "" && branch != "" && checkDDno != "")
                                                    {
                                                        bankdetailsOK = true;
                                                    }
                                                }
                                                else if (mode == "cash")
                                                {
                                                    bankdetailsOK = true;
                                                }

                                                string modeMulti = string.Empty;

                                                if (bankdetailsOK)
                                                {
                                                    bool modeCash = false;
                                                    bool modeChk = false;
                                                    bool modeDD = false;
                                                    bool modeCard = false;
                                                    double overallCashAmt = 0;
                                                    double overallExcessFees = 0;

                                                    string excessFK = string.Empty;
                                                    double schoolORclg = checkSchoolSetting();
                                                    #region INSERTION AND UPDATION CODE.

                                                    DataTable dtMulBnkDetails = new DataTable();
                                                    dtMulBnkDetails.Columns.Add("BnkName");
                                                    dtMulBnkDetails.Columns.Add("ChkDDNo");
                                                    dtMulBnkDetails.Columns.Add("Branch");
                                                    dtMulBnkDetails.Columns.Add("Date");
                                                    dtMulBnkDetails.Columns.Add("Amount");
                                                    dtMulBnkDetails.Columns.Add("Mode");

                                                    double mulSchlAmount = 0;
                                                    if (chk_rcptMulmode.Checked)
                                                    {
                                                        #region Insert Process Multiple Mode
                                                        //To Store Entered Pay amt Temporarily
                                                        Hashtable htToPay = new Hashtable();
                                                        int indH = 0;
                                                        foreach (GridViewRow row in grid_Details.Rows)
                                                        {
                                                            TextBox txtTobePaidamt = (TextBox)row.FindControl("txt_tobepaid_amt");
                                                            htToPay.Add(indH, txtTobePaidamt.Text);
                                                            indH++;
                                                        }
                                                        bool rcptCheck = false;
                                                        foreach (GridViewRow grow in gridMultimode.Rows)
                                                        {
                                                            string modestr = string.Empty;
                                                            Label lblmdId = (Label)grow.FindControl("lbl_modetypeid");
                                                            Label lblmdType = (Label)grow.FindControl("lbl_modetype");
                                                            Label lblmdBnkId = (Label)grow.FindControl("lbl_mdbankid");
                                                            TextBox txtmdBnk = (TextBox)grow.FindControl("txt_mdBank");
                                                            TextBox txtmdBr = (TextBox)grow.FindControl("txt_mdbranchpop");
                                                            TextBox txtmdChkno = (TextBox)grow.FindControl("txt_mdchkddnopop");
                                                            TextBox txtmdAmt = (TextBox)grow.FindControl("txt_mdAmtpop");
                                                            Label lblmdDate = (Label)grow.FindControl("lbl_mddate");

                                                            if (lblmdType.Text.ToUpper() == "CASH")
                                                            {
                                                                modeCash = true;
                                                                modestr = "CASH";
                                                            }
                                                            else if (lblmdType.Text.ToUpper() == "CHEQUE")
                                                            {
                                                                modeChk = true;
                                                                modestr = "CHEQUE";
                                                            }
                                                            else if (lblmdType.Text.ToUpper() == "DD")
                                                            {
                                                                modeDD = true;
                                                                modestr = "DD";
                                                            }
                                                            else if (lblmdType.Text.ToUpper() == "CARD")
                                                            {
                                                                modeCard = true;
                                                                modestr = "CARD";
                                                            }
                                                            string gridDate = DateTime.Now.Date.ToString();
                                                            try
                                                            {
                                                                gridDate = lblmdDate.Text.Split('/')[1] + "/" + lblmdDate.Text.Split('/')[0] + "/" + lblmdDate.Text.Split('/')[2];
                                                            }
                                                            catch { }

                                                            if (txtmdAmt.Text == "")
                                                            {
                                                                txtmdAmt.Text = "0";
                                                            }
                                                            double currentAmount = 0;
                                                            currentAmount = Convert.ToDouble(txtmdAmt.Text.Trim());

                                                            DataRow dr = dtMulBnkDetails.NewRow();
                                                            dr[0] = txtmdBnk.Text;
                                                            dr[1] = txtmdChkno.Text;
                                                            dr[2] = txtmdBr.Text;
                                                            dr[3] = lblmdDate.Text;
                                                            dr[4] = txtmdAmt.Text;
                                                            dr[5] = modestr;
                                                            if (currentAmount > 0)
                                                            {
                                                                bool boolAdvance = false;
                                                                foreach (GridViewRow row in grid_Details.Rows)
                                                                {
                                                                    CheckBox chkOkPay = (CheckBox)row.FindControl("cb_selectLedger");

                                                                    TextBox txtFeeamt = (TextBox)row.FindControl("txt_fee_amt");
                                                                    double feeAmt = 0;
                                                                    double.TryParse(Convert.ToString(txtFeeamt.Text), out feeAmt);
                                                                    TextBox txtTotalamt = (TextBox)row.FindControl("txt_tot_amt");
                                                                    TextBox txtPaidamt = (TextBox)row.FindControl("txt_paid_amt");
                                                                    TextBox txtBalamt = (TextBox)row.FindControl("txt_bal_amt");
                                                                    TextBox txtTobePaidamt = (TextBox)row.FindControl("txt_tobepaid_amt");
                                                                    TextBox txtExcessGridAmt = (TextBox)row.FindControl("txt_gridexcess_amt");
                                                                    TextBox txtScholAmt = (TextBox)row.FindControl("txt_scholar_amt");
                                                                    TextBox txtCautAmt = (TextBox)row.FindControl("txt_deposit_amt");
                                                                    Label lblFeeCategory = (Label)row.FindControl("lbl_textCode");
                                                                    Label lblFeeCode = (Label)row.FindControl("lbl_feecode");
                                                                    Label lblheaderid = (Label)row.FindControl("lbl_hdrid");
                                                                    if ((!chkOkPay.Checked && feeAmt == 0) || (chkOkPay.Checked && feeAmt == 0))
                                                                        continue;
                                                                    Label lblmonWisemon = (Label)row.FindControl("lbl_monwiseMon");
                                                                    Label lblmonWiseyea = (Label)row.FindControl("lbl_monwiseYea");
                                                                    Label lbl_FeeallotPk = (Label)row.FindControl("lbl_FeeallotPk");
                                                                    string actualFinYearFk = string.Empty;
                                                                    actualFinYearFk = d2.getCurrentFinanceYear(usercode, collegecode1);
                                                                    ActualfinFk = " and finyearfk='" + actualFinYearFk + "'";
                                                                    //if (studfinFk)//actual finyear fk only for student
                                                                    //{
                                                                    //    Label lblfinYearFk = (Label)row.FindControl("lblfinfk");
                                                                    //    actualFinYearFk = Convert.ToString(lblfinYearFk.Text);
                                                                    //    ActualfinFk = " and finyearfk='" + actualFinYearFk + "'";

                                                                    //}
                                                                    Session["feecode"] = lblFeeCategory.Text;
                                                                    double creditamt = 0;
                                                                    double exgridamt = 0;
                                                                    double schlAmt = 0;
                                                                    double curCautAmt = 0;
                                                                    string[] finefeecat = lblFeeCategory.Text.Split(',');
                                                                    foreach (string finefeecatAmt in finefeecat)
                                                                    {
                                                                        string isFine = string.Empty;
                                                                        string[] splfine = finefeecatAmt.Split('$');
                                                                        if (splfine.Length > 1)
                                                                        {
                                                                            lblFeeCategory.Text = splfine[0];
                                                                            txtTobePaidamt.Text = splfine[1];
                                                                            isFine = "-1";
                                                                        }

                                                                        if (txtTobePaidamt.Text != "" || txtExcessGridAmt.Text != "" || txtScholAmt.Text != "" || txtCautAmt.Text != "")
                                                                        {
                                                                            if (txtTobePaidamt.Text == "")
                                                                            {
                                                                                txtTobePaidamt.Text = "0";
                                                                            }
                                                                            creditamt = Convert.ToDouble(txtTobePaidamt.Text);


                                                                            creditamt += schlAmt;
                                                                            mulSchlAmount += schlAmt;


                                                                            creditamt += curCautAmt;
                                                                        }

                                                                        if (exgridamt > 0 || creditamt > 0)
                                                                        {
                                                                            if (currentAmount == creditamt)
                                                                            {
                                                                                currentAmount = 0;
                                                                                txtTobePaidamt.Text = "0";
                                                                            }
                                                                            else if (currentAmount > creditamt)
                                                                            {
                                                                                currentAmount -= creditamt;
                                                                                txtTobePaidamt.Text = "0";
                                                                            }
                                                                            else
                                                                            {
                                                                                txtTobePaidamt.Text = (creditamt - currentAmount).ToString();
                                                                                creditamt = currentAmount;
                                                                                currentAmount = 0;
                                                                            }

                                                                            if (lblmdId.Text == "1")
                                                                            {

                                                                                PayMode = "1";
                                                                                checkDDno = "";
                                                                                dtchkdd = gridDate;
                                                                                newbankcode = "";
                                                                                branch = "";
                                                                                overallCashAmt += creditamt;
                                                                            }
                                                                            else if (lblmdId.Text == "2")
                                                                            {

                                                                                PayMode = "2";
                                                                                checkDDno = txtmdChkno.Text;
                                                                                dtchkdd = gridDate;
                                                                                newbankcode = lblmdBnkId.Text;
                                                                                branch = txtmdBr.Text;
                                                                            }
                                                                            else if (lblmdId.Text == "3")
                                                                            {

                                                                                PayMode = "3";
                                                                                checkDDno = txtmdChkno.Text;
                                                                                dtchkdd = gridDate;
                                                                                newbankcode = lblmdBnkId.Text;
                                                                                branch = txtmdBr.Text;
                                                                            }
                                                                            else if (lblmdId.Text == "6")
                                                                            {

                                                                                PayMode = "6";
                                                                                checkDDno = txtmdChkno.Text;
                                                                                dtchkdd = gridDate;
                                                                                newbankcode = lblmdBnkId.Text;
                                                                                branch = txtmdBr.Text;
                                                                            }

                                                                            if (creditamt > 0)
                                                                            {
                                                                                string iscollected = "0";
                                                                                string collecteddate = "";
                                                                                if (PayMode == "1" || PayMode == "6")
                                                                                {
                                                                                    iscollected = "1";
                                                                                    collecteddate = (dtrcpt).ToString();
                                                                                }
                                                                                double paidAmt = (creditamt + schlAmt + curCautAmt);

                                                                                string credit = "0";
                                                                                string TransType = "1";
                                                                                string IsInstallmentPay = "0";
                                                                                string InstallmentNo = "0";
                                                                                string PayAt = "0";
                                                                                string PayThrough = "0";
                                                                                string IsArrearCollect = "0";
                                                                                string ArearFinYearFK = "0";
                                                                                string time = DateTime.Now.ToLongTimeString();
                                                                                int rcptUpdate = 0;
                                                                                if (!rcptCheck)
                                                                                {
                                                                                    rcptUpdate = 1;
                                                                                    rcptCheck = true;
                                                                                }
                                                                                InsertUpdateOK = getPaidDetails(dtrcpt.ToString("MM/dd/yyyy"), time, receiptno, memtype, appnoNew, Convert.ToString(lblFeeCode.Text), Convert.ToString(lblheaderid.Text), Convert.ToString(lblFeeCategory.Text), credit, paidAmt, PayMode, checkDDno, dtchkdd, newbankcode, branch, TransType, IsInstallmentPay, InstallmentNo, Convert.ToString(txt_remark.Text.Trim()), PayAt, PayThrough, IsArrearCollect, ArearFinYearFK, usercode, finYearid, Convert.ToString(rcptType), iscollected, dtrcpt.ToString("MM/dd/yyyy"), iscollected, dtrcpt.ToString("MM/dd/yyyy"), isFine, actualFinYearFk, schoolORclg, Convert.ToString(isHeaderwise), lastRecptNo, collegecode1, Convert.ToString(rcptUpdate), hdrSetPK, exgridamt, schlAmt, ref boolAdvance);
                                                                                //string insertDebit = "INSERT INTO FT_FinDailyTransaction(TransDate,TransTime,TransCode,MemType,App_No,LedgerFK,HeaderFK,FeeCategory,Credit,Debit,PayMode,DDNo,DDDate,DDBankCode,DDBankBranch,TransType,IsInstallmentPay,InstallmentNo,Narration,PayAt,PayThrough,IsArrearCollect,ArearFinYearFK,EntryUserCode,FinYearFK,Receipttype,IsCollected,CollectedDate,IsDeposited,DepositedDate,FineFeecategory,ActualFinYearFK) VALUES('" + dtrcpt + "','" + DateTime.Now.ToLongTimeString() + "','" + receiptno + "', " + memtype + ", " + appnoNew + ", " + lblFeeCode.Text + ", " + lblheaderid.Text + ", " + lblFeeCategory.Text + ", 0, " + creditamt + ", " + PayMode + ", '" + checkDDno + "', '" + dtchkdd + "', '" + newbankcode + "','" + branch + "', 1, '0', 0, '" + txt_remark.Text.Trim() + "', '0', '0', '0', 0, " + usercode + ", " + finYearid + ",'" + rcptType + "','" + iscollected + "','" + collecteddate + "','" + iscollected + "','" + collecteddate + "','" + isFine + "','" + actualFinYearFk + "')";

                                                                                //d2.update_method_wo_parameter(insertDebit, "Text");

                                                                                #region Monthwise Insert
                                                                                int monwisemon = 0;
                                                                                int monWiseyea = 0;
                                                                                Int64 feeallotpk = 0;

                                                                                int.TryParse(lblmonWisemon.Text, out monwisemon);
                                                                                int.TryParse(lblmonWiseyea.Text, out monWiseyea);
                                                                                Int64.TryParse(lbl_FeeallotPk.Text, out feeallotpk);
                                                                                if (monwisemon > 0 && monWiseyea > 0 && feeallotpk > 0)
                                                                                {
                                                                                    Int64 dailyTransPk = 0;
                                                                                    string dailyTransPkQ = "SELECT dailyTransPk FROM  FT_FinDailyTransaction WHERE TransDate='" + dtrcpt + "' and TransCode='" + receiptno + "'  and  MemType= " + memtype + "  and  App_No=" + appnoNew + "  and  LedgerFK=" + lblFeeCode.Text + "  and  HeaderFK=" + lblheaderid.Text + "  and   FeeCategory=" + lblFeeCategory.Text + "  and  Credit=0  and  Debit=" + (creditamt) + "  and  PayMode =" + PayMode + "  and  TransType=1  and FinYearFK=" + finYearid + "  and  Receipttype='" + rcptType + "'";
                                                                                    Int64.TryParse(d2.GetFunction(dailyTransPkQ), out dailyTransPk);
                                                                                    if (dailyTransPk > 0)
                                                                                    {
                                                                                        string insMonwiseQ = "INSERT INTO FT_FinDailyTransactionDetailMonthWise(DailyTransFK, MonthValue, YearValue, Debit, isCancel) values(" + dailyTransPk + ", " + monwisemon + ", " + monWiseyea + ", " + (creditamt) + ", '0')";
                                                                                        d2.update_method_wo_parameter(insMonwiseQ, "Text");

                                                                                        string upMonwiseQ = "update FT_FeeallotMonthly set PaidAmount=ISNULL(PaidAmount,0)+" + (creditamt) + ",BalAmount=ISNULL(BalAmount,0)-" + (creditamt) + " where FeeAllotPK=" + feeallotpk + "  and  AllotMonth=" + monwisemon + " and  AllotYear=" + monWiseyea + " and Finyearfk= " + finYearid + "";
                                                                                        d2.update_method_wo_parameter(upMonwiseQ, "Text");
                                                                                    }
                                                                                }
                                                                                #endregion


                                                                            }

                                                                            overallCashAmt += exgridamt;



                                                                            //if (splfine.Length == 1)
                                                                            //{
                                                                            //    string selectquery = " select  isnull(TotalAmount,0) as TotalAmount,isnull(PaidAmount,0) as PaidAmount,isnull(BalAmount,0) as BalAmount  from FT_FeeAllot where App_No =" + appnoNew + " and feecategory ='" + lblFeeCategory.Text + "' and ledgerfk ='" + lblFeeCode.Text + "' " + ActualfinFk + "";

                                                                            //    DataSet dsPrevAMount = new DataSet();
                                                                            //    dsPrevAMount = d2.select_method_wo_parameter(selectquery, "Text");
                                                                            //    if (dsPrevAMount.Tables.Count > 0)
                                                                            //    {
                                                                            //        if (dsPrevAMount.Tables[0].Rows.Count > 0)
                                                                            //        {
                                                                            //            double total = 0;
                                                                            //            double paidamt = 0;
                                                                            //            double balamt = 0;

                                                                            //            total = Convert.ToDouble(dsPrevAMount.Tables[0].Rows[0]["TotalAmount"]);

                                                                            //            if (total > 0)
                                                                            //            {
                                                                            //                paidamt = Convert.ToDouble(dsPrevAMount.Tables[0].Rows[0]["PaidAmount"]);
                                                                            //                balamt = Convert.ToDouble(dsPrevAMount.Tables[0].Rows[0]["BalAmount"]);

                                                                            //                balamt = (total - paidamt);

                                                                            //                string updatequery = "update FT_FeeAllot set PaidAmount=isnull(PaidAmount,0) +" + (creditamt + exgridamt) + " ,BalAmount =" + (balamt - (creditamt + exgridamt)) + ",FromGovtAmt=isnull(FromGovtAmt,0)-" + schlAmt + "  where App_No =" + appnoNew + " and feecategory ='" + lblFeeCategory.Text + "' and ledgerfk ='" + lblFeeCode.Text + "' " + ActualfinFk + "";
                                                                            //                d2.update_method_wo_parameter(updatequery, "Text");

                                                                            //                InsertUpdateOK = true;
                                                                            //            }

                                                                            //        }
                                                                            //    }
                                                                            //}
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                            if (txtmdBnk.Text.Trim() != "" || txtmdBr.Text.Trim() != "" && txtmdAmt.Text.Trim() != "" && txtmdAmt.Text.Trim() != "0" && txtmdAmt.Text.Trim() != "0.00")
                                                            {
                                                                dtMulBnkDetails.Rows.Add(dr);
                                                            }
                                                        }

                                                        int indH0 = 0;
                                                        foreach (GridViewRow row in grid_Details.Rows)
                                                        {
                                                            CheckBox chkOkPay = (CheckBox)row.FindControl("cb_selectLedger");
                                                            if (chkOkPay.Checked)
                                                            {
                                                                TextBox txtTobePaidamt = (TextBox)row.FindControl("txt_tobepaid_amt");
                                                                txtTobePaidamt.Text = htToPay[indH0].ToString();
                                                            }
                                                            indH0++;
                                                        }
                                                        #endregion
                                                    }
                                                    else
                                                    {
                                                        #region Insert Process Single Mode
                                                        bool rcptCheck = false;
                                                        bool boolAdvanceAmt = false;
                                                        foreach (GridViewRow row in grid_Details.Rows)
                                                        {
                                                            CheckBox chkOkPay = (CheckBox)row.FindControl("cb_selectLedger");

                                                            TextBox txtFeeamt = (TextBox)row.FindControl("txt_fee_amt");
                                                            double feeAmt = 0;
                                                            double.TryParse(Convert.ToString(txtFeeamt.Text), out feeAmt);
                                                            TextBox txtTotalamt = (TextBox)row.FindControl("txt_tot_amt");
                                                            TextBox txtPaidamt = (TextBox)row.FindControl("txt_paid_amt");
                                                            TextBox txtBalamt = (TextBox)row.FindControl("txt_bal_amt");
                                                            TextBox txtTobePaidamt = (TextBox)row.FindControl("txt_tobepaid_amt");
                                                            TextBox txtExcessGridAmt = (TextBox)row.FindControl("txt_gridexcess_amt");
                                                            TextBox txtScholAmt = (TextBox)row.FindControl("txt_scholar_amt");
                                                            TextBox txtCautAmt = (TextBox)row.FindControl("txt_deposit_amt");

                                                            Label lblFeeCategory = (Label)row.FindControl("lbl_textCode");
                                                            if ((!chkOkPay.Checked && feeAmt == 0) || (chkOkPay.Checked && feeAmt == 0))
                                                                continue;

                                                            Label lblFeeCode = (Label)row.FindControl("lbl_feecode");
                                                            Label lblheaderid = (Label)row.FindControl("lbl_hdrid");

                                                            Label lblmonWisemon = (Label)row.FindControl("lbl_monwiseMon");
                                                            Label lblmonWiseyea = (Label)row.FindControl("lbl_monwiseYea");
                                                            Label lbl_FeeallotPk = (Label)row.FindControl("lbl_FeeallotPk");
                                                            string actualFinYearFk = string.Empty;
                                                            //if (studfinFk)//actual finyear fk only for student
                                                            //{
                                                            // Label lblfinYearFk = (Label)row.FindControl("lblfinfk");
                                                            actualFinYearFk = d2.getCurrentFinanceYear(usercode, collegecode1);
                                                            ActualfinFk = " and finyearfk='" + actualFinYearFk + "'";
                                                            //}
                                                            // string actualFinYearFk = d2.getCurrentFinanceYear(usercode, collegecode1);
                                                            Session["feecode"] = lblFeeCategory.Text;
                                                            double creditamt = 0;
                                                            double exgridamt = 0;
                                                            double schlamt = 0;
                                                            double curCautAmt = 0;

                                                            string[] finefeecat = lblFeeCategory.Text.Split(',');
                                                            foreach (string finefeecatAmt in finefeecat)
                                                            {
                                                                string isFine = string.Empty;
                                                                string[] splfine = finefeecatAmt.Split('$');
                                                                if (splfine.Length > 1)
                                                                {
                                                                    lblFeeCategory.Text = splfine[0];
                                                                    txtTobePaidamt.Text = splfine[1];
                                                                    isFine = "-1";
                                                                }
                                                                if (txtTobePaidamt.Text != "" || txtExcessGridAmt.Text != "" || txtScholAmt.Text != "" || txtCautAmt.Text != "")
                                                                {
                                                                    if (txtTobePaidamt.Text == "")
                                                                    {
                                                                        txtTobePaidamt.Text = "0";
                                                                    }
                                                                    creditamt = Convert.ToDouble(txtTobePaidamt.Text);


                                                                    overallExcessFees += exgridamt;
                                                                    mulSchlAmount += schlamt;
                                                                }

                                                                if (exgridamt > 0 || creditamt > 0 || schlamt > 0 || curCautAmt > 0)
                                                                {

                                                                    if (creditamt > 0 || schlamt > 0 || curCautAmt > 0)
                                                                    {
                                                                        string iscollected = "0";
                                                                        string collecteddate = "";
                                                                        if (PayMode == "1" || PayMode == "6")
                                                                        {
                                                                            iscollected = "1";
                                                                            collecteddate = (dtrcpt).ToString();
                                                                        }
                                                                        double paidAmt = (creditamt + schlamt + curCautAmt);

                                                                        string credit = "0";
                                                                        string TransType = "1";
                                                                        string IsInstallmentPay = "0";
                                                                        string InstallmentNo = "0";
                                                                        string PayAt = "0";
                                                                        string PayThrough = "0";
                                                                        string IsArrearCollect = "0";
                                                                        string ArearFinYearFK = "0";
                                                                        string time = DateTime.Now.ToLongTimeString();
                                                                        int rcptUpdate = 0;
                                                                        if (!rcptCheck)
                                                                        {
                                                                            rcptUpdate = 1;
                                                                            rcptCheck = true;
                                                                        }
                                                                        InsertUpdateOK = getPaidDetails(dtrcpt.ToString("MM/dd/yyyy"), time, receiptno, memtype, appnoNew, Convert.ToString(lblFeeCode.Text), Convert.ToString(lblheaderid.Text), Convert.ToString(lblFeeCategory.Text), credit, paidAmt, PayMode, checkDDno, dtchkdd, newbankcode, branch, TransType, IsInstallmentPay, InstallmentNo, Convert.ToString(txt_remark.Text.Trim()), PayAt, PayThrough, IsArrearCollect, ArearFinYearFK, usercode, finYearid, Convert.ToString(rcptType), iscollected, dtrcpt.ToString("MM/dd/yyyy"), iscollected, dtrcpt.ToString("MM/dd/yyyy"), isFine, actualFinYearFk, schoolORclg, Convert.ToString(isHeaderwise), lastRecptNo, collegecode1, Convert.ToString(rcptUpdate), hdrSetPK, exgridamt, schlamt, ref  boolAdvanceAmt);
                                                                        //string insertDebit = "INSERT INTO FT_FinDailyTransaction(TransDate,TransTime,TransCode,MemType,App_No,LedgerFK,HeaderFK,FeeCategory,Credit,Debit,PayMode,DDNo,DDDate,DDBankCode,DDBankBranch,TransType,IsInstallmentPay,InstallmentNo,Narration,PayAt,PayThrough,IsArrearCollect,ArearFinYearFK,EntryUserCode,FinYearFK,Receipttype,IsCollected,CollectedDate,IsDeposited,DepositedDate,FineFeecategory,ActualFinYearFK) VALUES('" + dtrcpt + "','" + DateTime.Now.ToLongTimeString() + "','" + receiptno + "', " + memtype + ", " + appnoNew + ", " + lblFeeCode.Text + ", " + lblheaderid.Text + ", " + lblFeeCategory.Text + ", 0, " + (creditamt + schlamt + curCautAmt) + ", " + PayMode + ", '" + checkDDno + "', '" + dtchkdd + "', '" + newbankcode + "','" + branch + "', 1, '0', 0, '" + txt_remark.Text.Trim() + "', '0', '0', '0', 0, " + usercode + ", " + finYearid + ",'" + rcptType + "','" + iscollected + "','" + collecteddate + "','" + iscollected + "','" + collecteddate + "','" + isFine + "','" + actualFinYearFk + "')";

                                                                        //d2.update_method_wo_parameter(insertDebit, "Text");

                                                                        #region Monthwise Insert
                                                                        int monwisemon = 0;
                                                                        int monWiseyea = 0;
                                                                        Int64 feeallotpk = 0;

                                                                        int.TryParse(lblmonWisemon.Text, out monwisemon);
                                                                        int.TryParse(lblmonWiseyea.Text, out monWiseyea);
                                                                        Int64.TryParse(lbl_FeeallotPk.Text, out feeallotpk);
                                                                        if (monwisemon > 0 && monWiseyea > 0 && feeallotpk > 0)
                                                                        {
                                                                            Int64 dailyTransPk = 0;
                                                                            string dailyTransPkQ = "SELECT dailyTransPk FROM  FT_FinDailyTransaction WHERE TransDate='" + dtrcpt + "' and TransCode='" + receiptno + "'  and  MemType= " + memtype + "  and  App_No=" + appnoNew + "  and  LedgerFK=" + lblFeeCode.Text + "  and  HeaderFK=" + lblheaderid.Text + "  and   FeeCategory=" + lblFeeCategory.Text + "  and  Credit=0  and  Debit=" + (creditamt + schlamt + curCautAmt) + "  and  PayMode =" + PayMode + "  and  TransType=1  and FinYearFK=" + finYearid + "  and  Receipttype='" + rcptType + "'";
                                                                            Int64.TryParse(d2.GetFunction(dailyTransPkQ), out dailyTransPk);
                                                                            if (dailyTransPk > 0)
                                                                            {
                                                                                string insMonwiseQ = "INSERT INTO FT_FinDailyTransactionDetailMonthWise(DailyTransFK, MonthValue, YearValue, Debit, isCancel) values(" + dailyTransPk + ", " + monwisemon + ", " + monWiseyea + ", " + (creditamt + schlamt + curCautAmt) + ", '0')";
                                                                                d2.update_method_wo_parameter(insMonwiseQ, "Text");

                                                                                string upMonwiseQ = "update FT_FeeallotMonthly set PaidAmount=ISNULL(PaidAmount,0)+" + (creditamt + schlamt + curCautAmt) + ",BalAmount=ISNULL(BalAmount,0)-" + (creditamt + schlamt) + " where FeeAllotPK=" + feeallotpk + " and  AllotMonth=" + monwisemon + " and  AllotYear=" + monWiseyea + " and Finyearfk= " + finYearid + "";
                                                                                d2.update_method_wo_parameter(upMonwiseQ, "Text");
                                                                            }
                                                                        }
                                                                        #endregion


                                                                    }
                                                                    overallCashAmt += creditamt + exgridamt + schlamt + curCautAmt;
                                                                }
                                                            }
                                                        }

                                                        #endregion
                                                    }
                                                    #endregion
                                                    //update receipt

                                                    if (InsertUpdateOK)
                                                    {
                                                        #region update CashTransaction
                                                        if ((rb_cash.Checked && overallCashAmt > 0) || (chk_rcptMulmode.Checked && overallCashAmt > 0))
                                                        {
                                                            string upCashTrans = "  if exists (select * from FT_FinCashTransaction where TransDate ='" + dtrcpt + "' and FinYearFK ='" + finYearid + "' and EntryUserCode='" + usercode + "') update FT_FinCashTransaction set TransTime ='" + DateTime.Now.ToLongTimeString() + "', Debit =isnull(Debit,0) +" + overallCashAmt + " where FinYearFK ='" + finYearid + "' and TransDate ='" + dtrcpt + "' and EntryUserCode='" + usercode + "' else insert into FT_FinCashTransaction (TransDate,TransTime,Debit,FinYearFK,EntryUserCode) values ('" + dtrcpt + "','" + DateTime.Now.ToLongTimeString() + "'," + overallCashAmt + ",'" + finYearid + "','" + usercode + "')";
                                                            d2.update_method_wo_parameter(upCashTrans, "Text");
                                                        }
                                                        #endregion

                                                        #region Update Receipt No
                                                        if (save1 != 5)
                                                        {
                                                            #region Admission Number Generation
                                                            if (isAdmNoGenSettingsOn)
                                                            {
                                                                string app_formNo = string.Empty;
                                                                if (isAdmNoNotGenerated(appnoNew, admNoGenbatch, ref app_formNo))
                                                                {
                                                                    string degreecode = d2.GetFunction("select degree_code from applyn where app_no='" + appnoNew + "'");
                                                                    string generatedAdmNo = string.Empty;
                                                                    if (admissionNoGeneration())
                                                                    {
                                                                        generatedAdmNo = generateAdmissionNo(collegecode1,
       degreecode, admNoGenbatch).Trim();
                                                                    }
                                                                    if (generatedAdmNo == string.Empty)
                                                                    {
                                                                        generatedAdmNo = app_formNo;
                                                                    }
                                                                    Roll_admit = generatedAdmNo;

                                                                    d2.select_method_wo_parameter("if exists(select * from Registration where App_No='" + appnoNew + "' and college_code='" + collegecode1 + "') update registration set roll_admit='" + generatedAdmNo + "' where app_no='" + appnoNew + "'  and college_code='" + collegecode1 + "' else insert into Registration (App_No,Adm_Date,Roll_Admit,Roll_No,RollNo_Flag,Reg_No,Stud_Name,Batch_Year,degree_code,college_code,CC,DelFlag,Exam_Flag,Current_Semester,mode)values('" + appnoNew + "','" + System.DateTime.Now.ToString("yyy/MM/dd") + "','" + generatedAdmNo + "','" + app_formNo + "','1','" + app_formNo + "','" + studname + "','" + admNoGenbatch + "','" + degreecode + "','" + collegecode1 + "','0','0','OK','" + curSemEx + "','" + StudMode + "')  ", "Text");
                                                                    d2.select_method_wo_parameter("update applyn set is_enroll='2' where app_no='" + appnoNew + "'  and college_code='" + collegecode1 + "'", "Text");

                                                                }
                                                            }
                                                            #endregion
                                                        }
                                                        #endregion

                                                        if (modeCash)
                                                        {
                                                            modeMulti += "Cash,";
                                                        }
                                                        if (modeChk)
                                                        {
                                                            modeMulti += "Cheque,";
                                                        }
                                                        if (modeDD)
                                                        {
                                                            modeMulti += "DD,";
                                                        }
                                                        if (modeCard)
                                                        {
                                                            modeMulti += "Card";
                                                        }
                                                        modeMulti = modeMulti.TrimEnd(',');

                                                        //Print Region
                                                        string outRoll = rollno;
                                                        if (rdo_receipt.Checked && InsertUpdateOK)
                                                        {
                                                            try
                                                            {
                                                                CheckBox cb_CautionDep = new CheckBox();
                                                                CheckBox cb_govt = new CheckBox();
                                                                CheckBox cb_exfees = new CheckBox();
                                                                TextBox txt_examt = new TextBox();

                                                                if (save1 == 0 || save1 == 1)
                                                                {
                                                                    //For Mcc &  Others
                                                                    #region Print Option For Receipt
                                                                    if ((rbl_rollnoNew.SelectedIndex == 0 && txt_rollno.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 1 && txtroll_staff.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 2 && txtname_vendor.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 3 && txtroll_other.Text.Trim() != ""))// && txt_otherMobile.Text.Trim() != ""
                                                                    {
                                                                        try
                                                                        {

                                                                            bool imgdivVisible = false;
                                                                            bool contentVisible = false;
                                                                            bool CreateReceiptOK = false;

                                                                            FormatIGeneralChallanReceipt rcpt = new FormatIGeneralChallanReceipt();
                                                                            string szFile = rcpt.generateOriginal(receiptno.Trim(), txt_date.Text.Trim(), txt_dept.Text.Trim(), rb_cash, rb_cheque, rb_dd, rb_card,rb_NEFT,collegecode1, usercode, ref lastRecptNo, ref accidRecpt, rbl_rollnoNew, rbl_rollno, appnoNew, outRoll, txtDept_staff, rollno, app_formno, Regno, studname, grid_Details, BalanceType, dtMulBnkDetails, chk_rcptMulmode, modeMulti, checkDDno, newbankname, branch, txt_date1, txt_remark, ref  contentVisible, ref  CreateReceiptOK, ref  imgdivVisible, ref  lbl_alert, cb_CautionDep, cb_govt, cb_exfees);
                                                                            imgAlert.Visible = imgdivVisible;

                                                                            if (CreateReceiptOK)
                                                                            {
                                                                                Response.Write("<script>window.open('PrintPage.aspx?name=" + szFile + "', '_blank');</script>");
                                                                                //contentDiv.Visible = true;
                                                                                //ScriptManager.RegisterStartupScript(this, GetType(), "InvokeButton", "PrintDiv();", true);
                                                                            }

                                                                        }
                                                                        catch { imgAlert.Visible = true; }
                                                                    }
                                                                    else
                                                                    {
                                                                        imgAlert.Visible = true;
                                                                        //this.Form.DefaultButton = "btn_alertclose";
                                                                        lbl_alert.Text = "Not Enough Details To Print";
                                                                    }
                                                                    #endregion
                                                                }
                                                                else if (save1 == 2)
                                                                {
                                                                    //For UIT
                                                                    #region Print Option For Receipt
                                                                    if ((rbl_rollnoNew.SelectedIndex == 0 && txt_rollno.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 1 && txtroll_staff.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 2 && txtname_vendor.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 3 && txtroll_other.Text.Trim() != ""))// && txt_otherMobile.Text.Trim() != ""
                                                                    {
                                                                        try
                                                                        {

                                                                            bool imgdivVisible = false;
                                                                            bool contentVisible = false;
                                                                            bool CreateReceiptOK = false;

                                                                            FormatIIGeneralChallanReceipt rcpt = new FormatIIGeneralChallanReceipt();
                                                                            string szFile = rcpt.generateOriginal(receiptno.Trim(), txt_date.Text.Trim(), txt_dept.Text.Trim(), rb_cash, rb_cheque, rb_dd, rb_card,rb_NEFT , collegecode1, usercode, ref lastRecptNo, ref accidRecpt, rbl_rollnoNew, rbl_rollno, appnoNew, outRoll, txtDept_staff, rollno, app_formno, Regno, studname, grid_Details, BalanceType, dtMulBnkDetails, chk_rcptMulmode, modeMulti, checkDDno, newbankname, branch, txt_date1, txt_remark, ref  contentVisible, ref  CreateReceiptOK, ref  imgdivVisible, ref  lbl_alert, cb_CautionDep, cb_govt, cb_exfees, mode);
                                                                            imgAlert.Visible = imgdivVisible;

                                                                            if (CreateReceiptOK)
                                                                            {
                                                                                Response.Write("<script>window.open('PrintPage.aspx?name=" + szFile + "', '_blank');</script>");
                                                                                //contentDiv.Visible = true;
                                                                                //ScriptManager.RegisterStartupScript(this, GetType(), "InvokeButton", "PrintDiv();", true);
                                                                            }

                                                                        }
                                                                        catch { imgAlert.Visible = true; }
                                                                    }
                                                                    else
                                                                    {
                                                                        imgAlert.Visible = true;
                                                                        //this.Form.DefaultButton = "btn_alertclose";
                                                                        lbl_alert.Text = "Not Enough Details To Print";
                                                                    }
                                                                    #endregion
                                                                }
                                                                else if (save1 == 3 || save1 == 7 || save1 == 8 || save1 == 9)
                                                                {
                                                                    //For HIET-3,Gnanamani-7,VRS-8,NEC-9
                                                                    #region Print Option For Receipt
                                                                    if ((rbl_rollnoNew.SelectedIndex == 0 && txt_rollno.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 1 && txtroll_staff.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 2 && txtname_vendor.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 3 && txtroll_other.Text.Trim() != ""))// && txt_otherMobile.Text.Trim() != ""
                                                                    {
                                                                        //Basic Data
                                                                        //string rollno = txt_rollno.Text.Trim();
                                                                        //    string recptNo = txt_rcptno.Text.Trim();
                                                                        string recptNo = string.Empty;
                                                                        //modified by sudhagar editable receipt no
                                                                        tempRcpt = Convert.ToString(txttemprcpt.Text.Trim());
                                                                        if (!string.IsNullOrEmpty(tempRcpt))
                                                                            recptNo = tempRcpt;
                                                                        else
                                                                            recptNo = txt_rcptno.Text.Trim();
                                                                        string recptDt = txt_date.Text.Trim();
                                                                        //string studname = txt_name.Text.Trim();
                                                                        string course = txt_dept.Text.Trim();
                                                                        string batchYrSem = string.Empty;
                                                                        string acaYear = d2.GetFunction("select LinkValue from New_InsSettings where LinkName='ChallanAcademicYear' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "'");
                                                                        try
                                                                        {
                                                                            acaYear = acaYear.Split(',')[0] + "-" + acaYear.Split(',')[1];
                                                                        }
                                                                        catch { }
                                                                        try
                                                                        {
                                                                            course = course.Split('-')[0];
                                                                        }
                                                                        catch { course = ""; }
                                                                        // string mode = string.Empty;

                                                                        if (rb_cash.Checked)
                                                                        {
                                                                            mode = "Cash";
                                                                        }
                                                                        else if (rb_cheque.Checked)
                                                                        {
                                                                            mode = "Cheque";
                                                                        }
                                                                        else if (rb_dd.Checked)
                                                                        {
                                                                            mode = "DD";
                                                                        }
                                                                        else if (rb_card.Checked)
                                                                        {
                                                                            mode = "Card";
                                                                        }

                                                                        //Fields to print
                                                                        string queryPrint1 = "select * from FM_RcptChlPrintSettings where collegecode ='" + collegecode1 + "'";
                                                                        ds.Clear();
                                                                        ds = d2.select_method_wo_parameter(queryPrint1, "Text");
                                                                        if (ds.Tables.Count > 0)
                                                                        {
                                                                            if (ds.Tables[0].Rows.Count > 0)
                                                                            {

                                                                                //Footer Div Values

                                                                                byte studCopy = Convert.ToByte(ds.Tables[0].Rows[0]["IsStudCopy"]);
                                                                                byte officopy = Convert.ToByte(ds.Tables[0].Rows[0]["IsOfficeCopy"]);
                                                                                byte transCopy = Convert.ToByte(ds.Tables[0].Rows[0]["IsTransportCopy"]);
                                                                                byte narration = Convert.ToByte(dsPri.Tables[0].Rows[0]["IsNarration"]);

                                                                                //Document Settings
                                                                                contentDiv.InnerHtml = "";
                                                                                StringBuilder sbHtml = new StringBuilder();

                                                                                string colquery = "select collname,university,address1 ,address2,address3+' - '+pincode as address3 from collinfo where college_code=" + collegecode1 + " ";
                                                                                if (rbl_rollnoNew.SelectedIndex == 0)
                                                                                {
                                                                                    if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 3)
                                                                                    {
                                                                                        colquery += " select a.Current_Semester,a.Degree_code,(c.Course_Name +' - '+ dt.Dept_Name) as department, (c.Course_Name +' - '+ dt.dept_acronym) as dept_acronym,a.Batch_Year,(select TextVal  from TextValTable where TextCode = a.seattype) as seattype ,'' Boarding,a.mother,a.parent_name,ISNULL( type,'') as type,'' Sections  from applyn a,Degree d,Department dt,Course c where a.degree_code =d.Degree_Code and d.Dept_Code =dt.Dept_Code and c.Course_Id =d.Course_Id and a.App_No='" + appnoNew + "' and d.college_code=" + collegecode1 + "";
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        colquery += " select r.Current_Semester,r.Degree_code,(c.Course_Name +' - '+ dt.Dept_Name) as department, (c.Course_Name +' - '+ dt.dept_acronym) as dept_acronym,r.Batch_Year,(select TextVal  from TextValTable where TextCode = a.seattype) as seattype ,r.Boarding,a.mother,a.parent_name,isnull(r.Sections,'') as Sections from Registration r, applyn a,Degree d,Department dt,Course c where a.app_no=r.App_No and r.degree_code =d.Degree_Code and d.Dept_Code =dt.Dept_Code and c.Course_Id =d.Course_Id and r.App_No='" + appnoNew + "' and r.college_code=" + collegecode1 + " ";
                                                                                    }
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                {
                                                                                    colquery += "  select appl_id ,h.dept_name,h.dept_acronym,h.dept_code,s.staff_name,s.staff_code,a.father_name,t.stftype as staff_type  from staffmaster s,staff_appl_master a,hrdept_master h,stafftrans t,desig_master d where s.appl_no =a.appl_no and s.staff_code =t.staff_code and t.dept_code =h.dept_code and d.desig_code =t.desig_code and s.college_code =h.college_code and d.collegeCode =s.college_code and latestrec ='1' and appl_id ='" + appnoNew + "' and s.college_Code=" + collegecode1 + "  ";
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 2)
                                                                                {
                                                                                    colquery += " SELECT VendorContactPK, VenContactType, VenContactName, VenContactDesig, VenContactDept, VendorPhoneNo, VendorExtNo, VendorMobileNo, VendorEmail, VendorFK FROM      IM_VendorContactMaster WHERE VendorContactPK = '" + appnoNew + "' ";
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 3)
                                                                                {
                                                                                    colquery += " SELECT VendorCode,vendorname,VendorMobileNo,VendorAddress,VendorCity,VendorCompName,VendorType  from co_vendormaster  WHERE VendorPK = '" + appnoNew + "' ";
                                                                                    outRoll = string.Empty;
                                                                                }
                                                                                string collegename = "";
                                                                                string add1 = "";
                                                                                string add2 = "";
                                                                                string add3 = "";
                                                                                string univ = "";
                                                                                string deg = "";
                                                                                string degAcr = "";
                                                                                string cursem = "";
                                                                                string batyr = "";
                                                                                string seatty = "";
                                                                                string board = "";
                                                                                string mothe = "";
                                                                                string fathe = "";
                                                                                double deductionamt = 0;
                                                                                ds.Clear();
                                                                                ds = d2.select_method_wo_parameter(colquery, "Text");
                                                                                if (ds.Tables.Count > 0)
                                                                                {
                                                                                    if (ds.Tables[0].Rows.Count > 0)
                                                                                    {
                                                                                        collegename = Convert.ToString(ds.Tables[0].Rows[0]["collname"]);
                                                                                        add1 = Convert.ToString(ds.Tables[0].Rows[0]["address1"]);
                                                                                        add2 = Convert.ToString(ds.Tables[0].Rows[0]["address2"]);
                                                                                        add3 = Convert.ToString(ds.Tables[0].Rows[0]["address3"]);

                                                                                        univ = Convert.ToString(ds.Tables[0].Rows[0]["university"]);
                                                                                    }
                                                                                    if (ds.Tables[1].Rows.Count > 0)
                                                                                    {
                                                                                        if (rbl_rollnoNew.SelectedIndex == 0)
                                                                                        {
                                                                                            //if (degACR == 0)
                                                                                            //{
                                                                                            deg = Convert.ToString(ds.Tables[1].Rows[0]["department"]);
                                                                                            //}
                                                                                            //else
                                                                                            //{
                                                                                            degAcr = Convert.ToString(ds.Tables[1].Rows[0]["dept_acronym"]);
                                                                                            //}
                                                                                            cursem = Convert.ToString(ds.Tables[1].Rows[0]["Current_Semester"]);
                                                                                            batyr = Convert.ToString(ds.Tables[1].Rows[0]["Batch_Year"]);
                                                                                            seatty = Convert.ToString(ds.Tables[1].Rows[0]["seattype"]);
                                                                                            board = Convert.ToString(ds.Tables[1].Rows[0]["Boarding"]);
                                                                                            mothe = Convert.ToString(ds.Tables[1].Rows[0]["mother"]);
                                                                                            fathe = Convert.ToString(ds.Tables[1].Rows[0]["parent_name"]);
                                                                                            //sec = " " + Convert.ToString(ds.Tables[1].Rows[0]["Sections"]);
                                                                                        }
                                                                                        else if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                        {
                                                                                            //if (degACR == 0)
                                                                                            //{
                                                                                            deg = Convert.ToString(ds.Tables[1].Rows[0]["dept_name"]);
                                                                                            //}
                                                                                            //else
                                                                                            //{
                                                                                            degAcr = Convert.ToString(ds.Tables[1].Rows[0]["dept_acronym"]);
                                                                                            //}
                                                                                            //cursem = Convert.ToString(ds.Tables[1].Rows[0]["Current_Semester"]);
                                                                                            //batyr = Convert.ToString(ds.Tables[1].Rows[0]["Batch_Year"]);
                                                                                            seatty = Convert.ToString(ds.Tables[1].Rows[0]["staff_type"]);
                                                                                            //board = Convert.ToString(ds.Tables[1].Rows[0]["Boarding"]);
                                                                                            //mothe = Convert.ToString(ds.Tables[1].Rows[0]["mother"]);
                                                                                            fathe = Convert.ToString(ds.Tables[1].Rows[0]["father_name"]);
                                                                                            //sec = " " + Convert.ToString(ds.Tables[1].Rows[0]["Sections"]);
                                                                                        }
                                                                                        else if (rbl_rollnoNew.SelectedIndex == 2)
                                                                                        {
                                                                                            deg = " - ";
                                                                                        }
                                                                                        else if (rbl_rollnoNew.SelectedIndex == 3)
                                                                                        {
                                                                                            deg = " - ";
                                                                                            //regno = 0;
                                                                                            //year = 0;
                                                                                            //degNam = 0;
                                                                                            //degACR = 0;
                                                                                        }
                                                                                    }

                                                                                    if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                    {
                                                                                        course = txtDept_staff.Text.Trim();
                                                                                    }
                                                                                }
                                                                                if (deg.Split('-').Length < 2)
                                                                                {
                                                                                    deg = " - ";
                                                                                }
                                                                                string degString = string.Empty;
                                                                                //Line3
                                                                                if (rbl_rollnoNew.SelectedIndex == 0)
                                                                                {
                                                                                    degString = deg.Split('-')[0].ToUpper();
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                {
                                                                                    degString = deg;
                                                                                }

                                                                                string deptstring = string.Empty;
                                                                                if (rbl_rollnoNew.SelectedIndex == 0)
                                                                                {
                                                                                    deptstring = deg.Split('-')[1].ToUpper();
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                {

                                                                                }
                                                                                #region multimode
                                                                                string ddnar = string.Empty;
                                                                                string ddnew = string.Empty;
                                                                                if (chk_rcptMulmode.Checked)
                                                                                {
                                                                                    mode = modeMulti;
                                                                                    for (int z = 0; z < dtMulBnkDetails.Rows.Count; z++)
                                                                                    {
                                                                                        ddnar += "\nNo : " + dtMulBnkDetails.Rows[z][1] + " Bank : " + dtMulBnkDetails.Rows[z][0] + "\nBranch :" + dtMulBnkDetails.Rows[z][2] + " Date  : " + dtMulBnkDetails.Rows[z][3] + " Amount : " + dtMulBnkDetails.Rows[z][4] + "/-";
                                                                                    }
                                                                                }
                                                                                else
                                                                                {
                                                                                    if (!rb_cash.Checked)
                                                                                    {
                                                                                        if (rb_dd.Checked == true)
                                                                                        {
                                                                                            ddnar = "\nDDNo : " + checkDDno + " Bank : " + newbankname + "\nBranch :" + branch + " Date  : " + txt_date1.Text.ToString();
                                                                                            ddnew = "&nbsp;&nbsp;&nbsp;\nDDNo : " + checkDDno + "&nbsp;&nbsp;&nbsp;Bank : " + newbankname + "&nbsp;&nbsp;&nbsp;\nBranch :" + branch + "&nbsp;&nbsp;&nbsp;Date  : " + txt_date1.Text.ToString();
                                                                                        }
                                                                                        else if (rb_cheque.Checked == true)
                                                                                        {
                                                                                            ddnar = "\nChequeNo : " + checkDDno + " Bank : " + newbankname + "\nBranch :" + branch + " Date  : " + txt_date1.Text.ToString();
                                                                                            ddnew = "&nbsp;&nbsp;&nbsp;\nChequeNo : " + checkDDno + "&nbsp;&nbsp;&nbsp;Bank : " + newbankname + "&nbsp;&nbsp;&nbsp;\nBranch :" + branch + "&nbsp;&nbsp;&nbsp;Date  : " + txt_date1.Text.ToString();
                                                                                        }
                                                                                        else if (rb_card.Checked == true)
                                                                                        {
                                                                                            ddnar = "\nCard : " + newbankname;
                                                                                            ddnew = "\nCard : " + newbankname;
                                                                                            //ddnar = "\nCard : " + checkDDno + " Bank : " + newbankname + "\nBranch :" + branch + " Date  : " + txt_date1.Text.ToString();
                                                                                            //ddnew = "&nbsp;&nbsp;&nbsp;\nChequeNo : " + checkDDno + "&nbsp;&nbsp;&nbsp;Bank : " + newbankname + "&nbsp;&nbsp;&nbsp;\nBranch :" + branch + "&nbsp;&nbsp;&nbsp;Date  : " + txt_date1.Text.ToString();
                                                                                        }
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        ddnar = "\nCash ";
                                                                                    }
                                                                                }
                                                                                ddnar += "\n Remarks:" + txt_remark.Text.Trim();
                                                                                #endregion

                                                                                if (save1 == 3)
                                                                                {
                                                                                    //For Hiet
                                                                                    HietChallanReceipt rcptObj = new HietChallanReceipt(appnoNew, outRoll, collegecode1, usercode, Convert.ToByte(rcptType), studname, recptDt, DateTime.Now.ToLongTimeString(), recptNo, cursem, deg.Split('-')[0].ToUpper(), deg.Split('-')[1].ToUpper(), ddnar);//(modeMulti + ddnar)
                                                                                    contentDiv.InnerHtml += ((StringBuilder)(rcptObj.returnHtmlStringReceipt(grid_Details, cb_exfees, cb_govt, cb_CautionDep))).ToString();
                                                                                }
                                                                                else if (save1 == 7)
                                                                                {
                                                                                    //For Gnanamani
                                                                                    GnanamaniChallanReceipt rcptObj = new GnanamaniChallanReceipt(appnoNew, outRoll, collegecode1, usercode, Convert.ToByte(rcptType), studname, recptDt, DateTime.Now.ToLongTimeString(), recptNo, cursem, deg.Split('-')[0].ToUpper(), deg.Split('-')[1].ToUpper());
                                                                                    contentDiv.InnerHtml += ((StringBuilder)(rcptObj.returnHtmlStringReceipt(grid_Details, cb_exfees, cb_govt, cb_CautionDep))).ToString();
                                                                                }
                                                                                else if (save1 == 8)
                                                                                {
                                                                                    //For VRS
                                                                                    VRSChallanReceipt rcptObj = new VRSChallanReceipt(appnoNew, outRoll, collegecode1, usercode, Convert.ToByte(rcptType), studname, recptDt, DateTime.Now.ToLongTimeString(), recptNo, cursem, deg.Split('-')[0].ToUpper(), deg.Split('-')[1].ToUpper(), degAcr.Split('-')[1].ToUpper(), (modeMulti + ddnar));
                                                                                    contentDiv.InnerHtml += ((StringBuilder)(rcptObj.returnHtmlStringReceipt(grid_Details, cb_exfees, cb_govt, cb_CautionDep))).ToString();
                                                                                }
                                                                                else if (save1 == 9)
                                                                                {
                                                                                    #region Print Format 1 in Html
                                                                                    queryPrint = "select * from FM_RcptChlPrintSettings where collegecode ='" + collegecode1 + "'";
                                                                                    ds.Clear();
                                                                                    ds = d2.select_method_wo_parameter(queryPrint1, "Text");
                                                                                    if (ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
                                                                                    {
                                                                                        //Header Div Values
                                                                                        byte collegeid = Convert.ToByte(ds.Tables[0].Rows[0]["IsCollegeName"]);
                                                                                        byte address1 = Convert.ToByte(ds.Tables[0].Rows[0]["IsCollegeAdd1"]);
                                                                                        byte address2 = Convert.ToByte(ds.Tables[0].Rows[0]["IsCollegeAdd2"]);
                                                                                        byte address3 = Convert.ToByte(ds.Tables[0].Rows[0]["IsCollegeAdd3"]);
                                                                                        byte city = Convert.ToByte(ds.Tables[0].Rows[0]["IsCollegeDist"]);
                                                                                        byte state = Convert.ToByte(ds.Tables[0].Rows[0]["IsCollegeState"]);

                                                                                        byte university = Convert.ToByte(ds.Tables[0].Rows[0]["IsCollegeUniversity"]);
                                                                                        byte rightLogo = Convert.ToByte(ds.Tables[0].Rows[0]["IsRightLogo"]);
                                                                                        byte leftLogo = Convert.ToByte(ds.Tables[0].Rows[0]["IsLeftLogo"]);
                                                                                        byte time;
                                                                                        if (Convert.ToBoolean(Convert.ToString(ds.Tables[0].Rows[0]["IsTime"])))
                                                                                        {
                                                                                            time = 1;
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            time = 0;
                                                                                        }
                                                                                        byte degACR = Convert.ToByte(ds.Tables[0].Rows[0]["IsDegreeAcr"]);
                                                                                        byte degNam = Convert.ToByte(ds.Tables[0].Rows[0]["IsDegreeName"]);
                                                                                        byte studnam = Convert.ToByte(ds.Tables[0].Rows[0]["IsStudName"]);
                                                                                        byte year = Convert.ToByte(ds.Tables[0].Rows[0]["IsYear"]);
                                                                                        byte semester = Convert.ToByte(ds.Tables[0].Rows[0]["IsSemester"]);
                                                                                        byte regno = Convert.ToByte(ds.Tables[0].Rows[0]["IsRegNo"]);
                                                                                        byte rolno = Convert.ToByte(ds.Tables[0].Rows[0]["IsRollNo"]);
                                                                                        byte admno = Convert.ToByte(ds.Tables[0].Rows[0]["IsAdminNo"]);

                                                                                        byte fathername = Convert.ToByte(ds.Tables[0].Rows[0]["IsFatherName"]);
                                                                                        byte seattype = Convert.ToByte(ds.Tables[0].Rows[0]["IsSeatType"]);
                                                                                        //byte setRollAsAdmin = Convert.ToByte(ds.Tables[0].Rows[0]["rollas_adm"]);
                                                                                        byte boarding = Convert.ToByte(ds.Tables[0].Rows[0]["IsBoarding"]);
                                                                                        byte mothername = Convert.ToByte(ds.Tables[0].Rows[0]["IsMontherName"]);
                                                                                        string recptValid = Convert.ToString(ds.Tables[0].Rows[0]["ValidDate"]);


                                                                                        //Body Div Values
                                                                                        //byte showAllFees = Convert.ToByte(ds.Tables[0].Rows[0]["showallfee"]);
                                                                                        byte allotedAmt = Convert.ToByte(ds.Tables[0].Rows[0]["IsAllotedAmt"]);
                                                                                        byte fineAmt = Convert.ToByte(ds.Tables[0].Rows[0]["IsFineAmt"]);
                                                                                        byte balAmt = Convert.ToByte(ds.Tables[0].Rows[0]["IsBalanceAmt"]);
                                                                                        byte semOrYear = Convert.ToByte(ds.Tables[0].Rows[0]["IsSemYear"]);
                                                                                        byte prevPaidAmt = Convert.ToByte(ds.Tables[0].Rows[0]["IsPrevPaid"]);
                                                                                        byte excessAmt = Convert.ToByte(ds.Tables[0].Rows[0]["IsExcessAmt"]);
                                                                                        // byte totDetails = Convert.ToByte(ds.Tables[0].Rows[0]["Total_Details"]);
                                                                                        byte fineInRow = Convert.ToByte(ds.Tables[0].Rows[0]["IsFineinRow"]);
                                                                                        //byte totWTselectCol = Convert.ToByte(ds.Tables[0].Rows[0]["TotalSelCol"]);
                                                                                        byte concession = Convert.ToByte(ds.Tables[0].Rows[0]["IsConcession"]);
                                                                                        string concessionValue = string.Empty;
                                                                                        if (concession != 0)
                                                                                        {
                                                                                            concessionValue = Convert.ToString(ds.Tables[0].Rows[0]["ConcessionName"]);
                                                                                        }


                                                                                        //Footer Div Values

                                                                                        //byte studCopy = Convert.ToByte(ds.Tables[0].Rows[0]["IsStudCopy"]);
                                                                                        //byte officopy = Convert.ToByte(ds.Tables[0].Rows[0]["IsOfficeCopy"]);
                                                                                        //byte transCopy = Convert.ToByte(ds.Tables[0].Rows[0]["IsTransportCopy"]);
                                                                                        // byte narration = Convert.ToByte(ds.Tables[0].Rows[0]["IsNarration"]);
                                                                                        byte deduction = Convert.ToByte(ds.Tables[0].Rows[0]["IsTotConcession"]);
                                                                                        byte forclgName = Convert.ToByte(ds.Tables[0].Rows[0]["IsForCollegeName"]);
                                                                                        byte authSign = Convert.ToByte(ds.Tables[0].Rows[0]["IsAuthSign"]);
                                                                                        byte validDate = Convert.ToByte(ds.Tables[0].Rows[0]["IsValidUpto"]);
                                                                                        string authSignValue = string.Empty;
                                                                                        if (authSign != 0)
                                                                                        {
                                                                                            authSignValue = Convert.ToString(ds.Tables[0].Rows[0]["AuthName"]);

                                                                                        }

                                                                                        byte studOffiCopy = Convert.ToByte(ds.Tables[0].Rows[0]["PageType"]);
                                                                                        // byte dispModeWTcash = Convert.ToByte(ds.Tables[0].Rows[0]["DisModeWithCash"]);
                                                                                        byte signFile = Convert.ToByte(ds.Tables[0].Rows[0]["cashier_sign"]);

                                                                                        //if (signFile != 0)
                                                                                        //{
                                                                                        //if (FileUpload1.HasFile)
                                                                                        //{

                                                                                        //}                                                    
                                                                                        //}


                                                                                        //Document Settings

                                                                                        colquery = "select collname,university,address1 ,address2,address3+' - '+pincode as address3 from collinfo where college_code=" + collegecode1 + " ";
                                                                                        if (rbl_rollnoNew.SelectedIndex == 0)
                                                                                        {
                                                                                            if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 3)
                                                                                            {
                                                                                                colquery += " select a.Current_Semester,a.Degree_code,(c.Course_Name +' - '+ dt.Dept_Name) as department, (c.Course_Name +' - '+ dt.dept_acronym) as dept_acronym,a.Batch_Year,(select TextVal  from TextValTable where TextCode = a.seattype) as seattype ,'' Boarding,a.mother,a.parent_name,ISNULL( type,'') as type,'' Sections  from applyn a,Degree d,Department dt,Course c where a.degree_code =d.Degree_Code and d.Dept_Code =dt.Dept_Code and c.Course_Id =d.Course_Id and a.App_No='" + appnoNew + "' and d.college_code=" + collegecode1 + "";
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                colquery += " select r.Current_Semester,r.Degree_code,(c.Course_Name +' - '+ dt.Dept_Name) as department, (c.Course_Name +' - '+ dt.dept_acronym) as dept_acronym,r.Batch_Year,(select TextVal  from TextValTable where TextCode = a.seattype) as seattype ,r.Boarding,a.mother,a.parent_name,isnull(r.Sections,'') as Sections from Registration r, applyn a,Degree d,Department dt,Course c where a.app_no=r.App_No and r.degree_code =d.Degree_Code and d.Dept_Code =dt.Dept_Code and c.Course_Id =d.Course_Id and r.App_No='" + appnoNew + "' and r.college_code=" + collegecode1 + " ";
                                                                                            }
                                                                                        }
                                                                                        else if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                        {
                                                                                            colquery += "  select appl_id ,h.dept_name,h.dept_acronym,h.dept_code,s.staff_name,s.staff_code,a.father_name,t.stftype as staff_type  from staffmaster s,staff_appl_master a,hrdept_master h,stafftrans t,desig_master d where s.appl_no =a.appl_no and s.staff_code =t.staff_code and t.dept_code =h.dept_code and d.desig_code =t.desig_code and s.college_code =h.college_code and d.collegeCode =s.college_code and latestrec ='1' and appl_id ='" + appnoNew + "' and s.college_Code=" + collegecode1 + "  ";
                                                                                        }
                                                                                        else if (rbl_rollnoNew.SelectedIndex == 2)
                                                                                        {
                                                                                            colquery += " SELECT VendorContactPK, VenContactType, VenContactName, VenContactDesig, VenContactDept, VendorPhoneNo, VendorExtNo, VendorMobileNo, VendorEmail, VendorFK FROM      IM_VendorContactMaster WHERE VendorContactPK = '" + appnoNew + "' ";
                                                                                        }
                                                                                        else if (rbl_rollnoNew.SelectedIndex == 3)
                                                                                        {
                                                                                            colquery += " SELECT VendorCode,vendorname,VendorMobileNo,VendorAddress,VendorCity,VendorCompName,VendorType  from co_vendormaster  WHERE VendorPK = '" + appnoNew + "' ";
                                                                                            outRoll = string.Empty;
                                                                                        }
                                                                                        collegename = "";
                                                                                        add1 = "";
                                                                                        add2 = "";
                                                                                        add3 = "";
                                                                                        univ = "";
                                                                                        deg = "";
                                                                                        cursem = "";
                                                                                        batyr = "";
                                                                                        seatty = "";
                                                                                        board = "";
                                                                                        mothe = "";
                                                                                        fathe = "";
                                                                                        deductionamt = 0;
                                                                                        ds.Clear();
                                                                                        ds = d2.select_method_wo_parameter(colquery, "Text");
                                                                                        if (ds.Tables.Count > 0)
                                                                                        {
                                                                                            if (ds.Tables[0].Rows.Count > 0)
                                                                                            {
                                                                                                collegename = Convert.ToString(ds.Tables[0].Rows[0]["collname"]);
                                                                                                add1 = Convert.ToString(ds.Tables[0].Rows[0]["address1"]);
                                                                                                add2 = Convert.ToString(ds.Tables[0].Rows[0]["address2"]);
                                                                                                add3 = Convert.ToString(ds.Tables[0].Rows[0]["address3"]);

                                                                                                univ = Convert.ToString(ds.Tables[0].Rows[0]["university"]);
                                                                                            }
                                                                                            if (ds.Tables[1].Rows.Count > 0)
                                                                                            {
                                                                                                if (rbl_rollnoNew.SelectedIndex == 0)
                                                                                                {
                                                                                                    if (degACR == 0)
                                                                                                    {
                                                                                                        deg = Convert.ToString(ds.Tables[1].Rows[0]["department"]);
                                                                                                    }
                                                                                                    else
                                                                                                    {
                                                                                                        deg = Convert.ToString(ds.Tables[1].Rows[0]["dept_acronym"]);
                                                                                                    }
                                                                                                    cursem = Convert.ToString(ds.Tables[1].Rows[0]["Current_Semester"]);
                                                                                                    batyr = Convert.ToString(ds.Tables[1].Rows[0]["Batch_Year"]);
                                                                                                    seatty = Convert.ToString(ds.Tables[1].Rows[0]["seattype"]);
                                                                                                    board = Convert.ToString(ds.Tables[1].Rows[0]["Boarding"]);
                                                                                                    mothe = Convert.ToString(ds.Tables[1].Rows[0]["mother"]);
                                                                                                    fathe = Convert.ToString(ds.Tables[1].Rows[0]["parent_name"]);
                                                                                                    //sec = " " + Convert.ToString(ds.Tables[1].Rows[0]["Sections"]);
                                                                                                }
                                                                                                else if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                                {
                                                                                                    if (degACR == 0)
                                                                                                    {
                                                                                                        deg = Convert.ToString(ds.Tables[1].Rows[0]["dept_name"]);
                                                                                                    }
                                                                                                    else
                                                                                                    {
                                                                                                        deg = Convert.ToString(ds.Tables[1].Rows[0]["dept_acronym"]);
                                                                                                    }
                                                                                                    //cursem = Convert.ToString(ds.Tables[1].Rows[0]["Current_Semester"]);
                                                                                                    //batyr = Convert.ToString(ds.Tables[1].Rows[0]["Batch_Year"]);
                                                                                                    seatty = Convert.ToString(ds.Tables[1].Rows[0]["staff_type"]);
                                                                                                    //board = Convert.ToString(ds.Tables[1].Rows[0]["Boarding"]);
                                                                                                    //mothe = Convert.ToString(ds.Tables[1].Rows[0]["mother"]);
                                                                                                    fathe = Convert.ToString(ds.Tables[1].Rows[0]["father_name"]);
                                                                                                    //sec = " " + Convert.ToString(ds.Tables[1].Rows[0]["Sections"]);
                                                                                                    regno = 0;
                                                                                                    year = 0;
                                                                                                    degNam = 0;
                                                                                                    degACR = 0;
                                                                                                }
                                                                                                else if (rbl_rollnoNew.SelectedIndex == 2)
                                                                                                {
                                                                                                    deg = " - ";
                                                                                                    regno = 0;
                                                                                                    year = 0;
                                                                                                    degNam = 0;
                                                                                                    degACR = 0;
                                                                                                }
                                                                                                else if (rbl_rollnoNew.SelectedIndex == 3)
                                                                                                {
                                                                                                    deg = " - ";
                                                                                                    regno = 0;
                                                                                                    year = 0;
                                                                                                    degNam = 0;
                                                                                                    degACR = 0;
                                                                                                }
                                                                                            }

                                                                                            if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                            {
                                                                                                course = txtDept_staff.Text.Trim();
                                                                                            }
                                                                                        }


                                                                                        int rectHeight = 920;
                                                                                        if (studOffiCopy == 1)
                                                                                        {
                                                                                            rectHeight = 475;
                                                                                        }
                                                                                        #region Receipt Header

                                                                                        //Header Images
                                                                                        //Line1
                                                                                        string Hllogo = string.Empty;
                                                                                        if (leftLogo != 0)
                                                                                        {
                                                                                            if (File.Exists(HttpContext.Current.Server.MapPath("~/FinanceLogo/Left_Logo" + collegecode1 + ".jpeg")))
                                                                                            {
                                                                                                Hllogo = "<img src='" + "../FinanceLogo/Left_Logo" + collegecode1 + ".jpeg?" + DateTime.Now.Ticks.ToString() + "" + "' style='height:80px; width:80px;'/>";
                                                                                            }
                                                                                        }
                                                                                        string Hcol = string.Empty;
                                                                                        if (collegeid != 0)
                                                                                        {
                                                                                            Hcol = collegename;
                                                                                        }
                                                                                        string Hrlogo = string.Empty;
                                                                                        //if (rightLogo != 0)
                                                                                        //{
                                                                                        //    if (File.Exists(HttpContext.Current.Server.MapPath("~/FinanceLogo/Right_Logo" + collegecode1 + ".jpeg")))
                                                                                        //    {
                                                                                        //        Hrlogo = "<img src='" + "../FinanceLogo/Right_Logo" + collegecode1 + ".jpeg?" + DateTime.Now.Ticks.ToString() + "" + "' style='height:80px; width:80px;'/>";
                                                                                        //    }
                                                                                        //}
                                                                                        Hrlogo = "<div style='height:80px; width:100px; border:1px solid black;'><div style='margin-top:30px;font-size:20px;'><b>" + Regex.Replace(recptNo, @"[\d-]", string.Empty).ToUpper() + "</b></div></div>";
                                                                                        //Line2
                                                                                        string Huniv = string.Empty;
                                                                                        if (university != 0)
                                                                                        {
                                                                                            Huniv = univ;
                                                                                        }
                                                                                        //Line3
                                                                                        string Hadd1add2 = string.Empty;
                                                                                        if (address1 != 0 || address2 != 0)
                                                                                        {
                                                                                            if (address2 != 0)
                                                                                            {
                                                                                                add1 += " " + add2;
                                                                                            }
                                                                                            Hadd1add2 = add1;
                                                                                        }
                                                                                        //Line4
                                                                                        string Hadd3 = string.Empty;
                                                                                        if (address3 != 0)
                                                                                        {
                                                                                            //Hadd3 = add3;
                                                                                            Hadd1add2 = Hadd1add2.TrimEnd('.', ',') + "," + add3;
                                                                                        }

                                                                                        //sbHtml.Append("<center><table cellpadding='0' cellspacing='0' style='text-align:center; width: 585px; ' class='classBold10'><tr><td rowspan='5'>" + Hllogo + "</td><td style='text-align:center; font-weight:bold; font-size:14px;'>" + Hcol + "</td><td  rowspan='5'>" + Hrlogo + "</td></tr><tr><td  style='text-align:center;'>" + Huniv + "</td></tr><tr><td  style='text-align:center;'>" + Hadd1add2 + "</td></tr><tr><td style='text-align:center;'>" + Hadd3 + "</td></tr><tr><td style='text-align:center; font-weight:bold; font-size:14px;'><u>RECEIPT</u></td></tr></table></center>");
                                                                                        sbHtml.Append("<center><table cellpadding='0' cellspacing='0' style='text-align:center; width: 585px; ' class='classBold10'><tr><td rowspan='5'>" + Hllogo + "</td><td style='text-align:center; font-weight:bold; font-size:14px;'>" + Hcol + "</td><td  rowspan='5' >" + Hrlogo + "</td></tr><tr><td  style='text-align:center;'>" + Huniv + "</td></tr><tr><td  style='text-align:center;'>" + Hadd1add2 + Hadd3 + "</td></tr><tr><td style='text-align:center; font-weight:bold; font-size:14px;'><u>RECEIPT</u></td></tr></table></center>");
                                                                                        #endregion

                                                                                        #region Table 1

                                                                                        //Table1 Data
                                                                                        string Htime1 = string.Empty;
                                                                                        string Htime2 = string.Empty;
                                                                                        //Line 1
                                                                                        if (time != 0)
                                                                                        {
                                                                                            Htime1 = "Time";
                                                                                            Htime2 = ": " + DateTime.Now.ToLongTimeString();
                                                                                        }
                                                                                        //Line2
                                                                                        ArrayList arr = new ArrayList();
                                                                                        string Hsname1 = string.Empty;
                                                                                        if (studnam != 0)
                                                                                        {
                                                                                            //Hsname1 = "<td colspan='2'>Name: " + studname + "</td>";
                                                                                            //arr.Add(Hsname1);
                                                                                            Htime1 = "Name";
                                                                                            Htime2 = ": " + studname;
                                                                                        }
                                                                                        string Hregno1 = string.Empty;
                                                                                        if (regno != 0)
                                                                                        {
                                                                                            Hregno1 = "<td colspan='2'>RegNo: " + Regno + "</td>";
                                                                                            arr.Add(Hregno1);
                                                                                        }

                                                                                        string HrolNo1 = string.Empty;
                                                                                        if (rolno != 0)
                                                                                        {
                                                                                            HrolNo1 = "<td colspan='2'>RollNo: " + outRoll + "</td>";
                                                                                            arr.Add(HrolNo1);
                                                                                        }
                                                                                        string HadmNo1 = string.Empty;
                                                                                        if (admno != 0)
                                                                                        {
                                                                                            HadmNo1 = "<td colspan='2'>AdmissionNo: " + app_formno + "</td>";
                                                                                            arr.Add(HadmNo1);
                                                                                        }

                                                                                        string Hfname1 = string.Empty;
                                                                                        if (fathername != 0)
                                                                                        {
                                                                                            Hfname1 = "<td colspan='2'>Father's Name: " + fathe + "</td>";
                                                                                            arr.Add(Hfname1);
                                                                                        }
                                                                                        string HMother1 = string.Empty;
                                                                                        if (mothername != 0)
                                                                                        {
                                                                                            HMother1 = "<td colspan='2'>Mother's Name: " + mothe + "</td>";
                                                                                            arr.Add(HMother1);
                                                                                        }

                                                                                        //Line 3
                                                                                        string batYrSemHead = string.Empty;
                                                                                        string batYrSemCont = string.Empty;
                                                                                        if (degACR != 0)
                                                                                        {
                                                                                            batYrSemHead = "Degree/";
                                                                                            batYrSemCont = deg + "/";
                                                                                        }
                                                                                        if (year != 0)
                                                                                        {
                                                                                            //batYrSemHead += "Yr/";
                                                                                            //batYrSemCont += " " + romanLetter(returnYearforSem(cursem)) + "/";
                                                                                            int yr = 0;
                                                                                            int.TryParse(reUse.GetFunction("select batch_year from applyn where app_no =" + appnoNew + "").Trim(), out yr);
                                                                                            if (yr != 0)
                                                                                            {
                                                                                                batYrSemHead += "Yr/";
                                                                                                batYrSemCont += " " + yr + "/";
                                                                                            }
                                                                                        }
                                                                                        if (semester != 0)
                                                                                        {
                                                                                            batYrSemHead += "Sem";
                                                                                            batYrSemCont += " " + romanLetter(cursem);
                                                                                        }
                                                                                        batYrSemHead = batYrSemHead.TrimEnd('/');
                                                                                        batYrSemCont = batYrSemCont.TrimEnd('/');

                                                                                        string HbatYrSem1 = string.Empty;
                                                                                        if (batYrSemHead != "")
                                                                                        {
                                                                                            HbatYrSem1 = "<td colspan='2'>" + batYrSemHead + ": " + batYrSemCont + "</td>";
                                                                                            arr.Add(HbatYrSem1);
                                                                                        }
                                                                                        string HseatType1 = string.Empty;
                                                                                        if (seattype != 0)
                                                                                        {
                                                                                            HseatType1 = "<td colspan='2'>Seat Type: " + seatty + "</td>";
                                                                                            arr.Add(HseatType1);
                                                                                        }
                                                                                        string Hboard1 = string.Empty;
                                                                                        if (boarding != 0)
                                                                                        {
                                                                                            Hboard1 = "<td colspan='2'>Boarding: " + board + "</td>";
                                                                                            arr.Add(Hboard1);
                                                                                        }

                                                                                        //sbHtml.Append("<br><center><table cellpadding='0' cellspacing='0' style='text-align:left; width: 585px; padding-left:5px; ' class='classBold10'><tr><td>Receipt No</td><td>" + ": " + recptNo + "</td><td>" + Htime1 + "</td><td>" + Htime2 + "</td><td>Date</td><td>" + ": " + recptDt + "</td></tr>");
                                                                                        sbHtml.Append("<br><center><table cellpadding='0' cellspacing='0' style='text-align:left; width: 585px; padding-left:5px; ' class='classBold10'><tr><td>Receipt No</td><td>" + ": " + recptNo + "</td><td>" + Htime1 + "</td><td>" + Htime2 + "</td><td>Date</td><td>" + ": " + recptDt + "</td></tr>");
                                                                                        int lasti = -1;
                                                                                        for (int ar = 0; ar < arr.Count; ar++)
                                                                                        {
                                                                                            if (ar == 0 || ar == 3 || ar == 6)
                                                                                            {
                                                                                                sbHtml.Append("<tr>");
                                                                                            }
                                                                                            sbHtml.Append(arr[ar]);
                                                                                            if (ar == 2 || ar == 5 || ar == 8)
                                                                                            {
                                                                                                sbHtml.Append("</tr>");
                                                                                            }
                                                                                            lasti = ar;
                                                                                        }
                                                                                        if (lasti != 2 && lasti != 5 && lasti != 8)
                                                                                        {
                                                                                            sbHtml.Append("</tr>");
                                                                                        }
                                                                                        sbHtml.Append("</table></center>");

                                                                                        #endregion

                                                                                        #region Table 2
                                                                                        //Table2 Format

                                                                                        int rows = 1;
                                                                                        foreach (GridViewRow row in grid_Details.Rows)
                                                                                        {
                                                                                            CheckBox chkOkPay = (CheckBox)row.FindControl("cb_selectLedger");
                                                                                            if (!chkOkPay.Checked)
                                                                                                continue;

                                                                                            TextBox txtTobePaidamt = (TextBox)row.FindControl("txt_tobepaid_amt");
                                                                                            TextBox txtScholAmt = (TextBox)row.FindControl("txt_scholar_amt");
                                                                                            double creditamt = 0;

                                                                                            if (txtTobePaidamt.Text != "")
                                                                                            {
                                                                                                creditamt = Convert.ToDouble(txtTobePaidamt.Text);
                                                                                                TextBox txtExcessGridAmt = (TextBox)row.FindControl("txt_gridexcess_amt");
                                                                                                double exgridamt = 0;
                                                                                                if (cb_exfees.Checked)
                                                                                                {
                                                                                                    double.TryParse(txtExcessGridAmt.Text, out exgridamt);
                                                                                                }
                                                                                                creditamt += exgridamt;

                                                                                                double gvtamt = 0;
                                                                                                if (cb_govt.Checked)
                                                                                                {
                                                                                                    double.TryParse(txtScholAmt.Text, out gvtamt);
                                                                                                }
                                                                                                creditamt += gvtamt;
                                                                                                TextBox txtCautAmt = (TextBox)row.FindControl("txt_deposit_amt");

                                                                                                double curCautamt = 0;
                                                                                                if (cb_CautionDep.Checked)
                                                                                                {
                                                                                                    double.TryParse(txtCautAmt.Text, out curCautamt);
                                                                                                }
                                                                                                creditamt += curCautamt;
                                                                                                if (creditamt > 0)
                                                                                                {
                                                                                                    rows++;
                                                                                                }
                                                                                            }
                                                                                        }


                                                                                        Hashtable htIndex = new Hashtable();
                                                                                        int hInsdx = 3;
                                                                                        //Table2 Header


                                                                                        if (semOrYear != 0)
                                                                                        {

                                                                                            htIndex.Add("semOrYear", hInsdx);
                                                                                            hInsdx++;
                                                                                        }


                                                                                        if (allotedAmt != 0)
                                                                                        {

                                                                                            htIndex.Add("allotedAmt", hInsdx);
                                                                                            hInsdx++;
                                                                                        }

                                                                                        if (balAmt != 0)
                                                                                        {

                                                                                            htIndex.Add("balAmt", hInsdx);
                                                                                            hInsdx++;
                                                                                        }
                                                                                        if (prevPaidAmt != 0)
                                                                                        {

                                                                                            htIndex.Add("prevPaidAmt", hInsdx);
                                                                                            hInsdx++;

                                                                                        }

                                                                                        if (concession != 0)
                                                                                        {

                                                                                            htIndex.Add("concession", hInsdx);
                                                                                            hInsdx++;

                                                                                        }

                                                                                        //sbHtml.Append("<br><center><table cellpadding='0' cellspacing='0' style='text-align:left; width: 560px;  border:1px solid; ' border='1' class='classBold10'><tr><td style='text-align:center;'>S.No</td><td style='text-align:center;'>Description</td><td style='text-align:center;'>Paid Rs</td>");
                                                                                        sbHtml.Append("<br><center><table cellpadding='0' cellspacing='0' style='text-align:left; width: 560px;  border:1px solid; ' border='1' class='classBold10'><tr><td style='text-align:center;'>S.No</td><td style='text-align:center;'>Description</td><td style='text-align:center;'>Amount</td>");

                                                                                        //Table2 Data

                                                                                        #region feedata
                                                                                        int sno = 0;
                                                                                        int indx = 0;
                                                                                        double totalamt = 0;
                                                                                        double balanamt = 0;
                                                                                        double curpaid = 0;
                                                                                        foreach (GridViewRow row in grid_Details.Rows)
                                                                                        {

                                                                                            CheckBox chkOkPay = (CheckBox)row.FindControl("cb_selectLedger");
                                                                                            if (!chkOkPay.Checked)
                                                                                                continue;

                                                                                            TextBox txtTotalamt = (TextBox)row.FindControl("txt_tot_amt");
                                                                                            TextBox txtPaidamt = (TextBox)row.FindControl("txt_paid_amt");
                                                                                            TextBox txtBalamt = (TextBox)row.FindControl("txt_bal_amt");
                                                                                            TextBox txtTobePaidamt = (TextBox)row.FindControl("txt_tobepaid_amt");
                                                                                            TextBox txtdeductamt = (TextBox)row.FindControl("txt_deduct_amt");

                                                                                            Label lblFeeCategory = (Label)row.FindControl("lbl_feetype");
                                                                                            Label lblsem = (Label)row.FindControl("lbl_textval");

                                                                                            double creditamt = 0;

                                                                                            if (txtTobePaidamt.Text != "")
                                                                                            {
                                                                                                creditamt = Convert.ToDouble(txtTobePaidamt.Text);
                                                                                                TextBox txtExcessGridAmt = (TextBox)row.FindControl("txt_gridexcess_amt");
                                                                                                double exgridamt = 0;
                                                                                                if (cb_exfees.Checked)
                                                                                                {
                                                                                                    double.TryParse(txtExcessGridAmt.Text, out exgridamt);
                                                                                                }
                                                                                                creditamt += exgridamt;

                                                                                                TextBox txtScholAmt = (TextBox)row.FindControl("txt_scholar_amt");
                                                                                                double gvtamt = 0;
                                                                                                if (cb_govt.Checked)
                                                                                                {
                                                                                                    double.TryParse(txtScholAmt.Text, out gvtamt);
                                                                                                }
                                                                                                creditamt += gvtamt;
                                                                                                TextBox txtCautAmt = (TextBox)row.FindControl("txt_deposit_amt");

                                                                                                double curCautamt = 0;
                                                                                                if (cb_CautionDep.Checked)
                                                                                                {
                                                                                                    double.TryParse(txtCautAmt.Text, out curCautamt);
                                                                                                }
                                                                                                creditamt += curCautamt;
                                                                                            }

                                                                                            if (creditamt > 0)
                                                                                            {
                                                                                                StringBuilder tempHtml = new StringBuilder();
                                                                                                sno++;
                                                                                                indx++;
                                                                                                totalamt += Convert.ToDouble(txtTotalamt.Text);
                                                                                                balanamt += Convert.ToDouble(txtBalamt.Text);
                                                                                                curpaid += creditamt;
                                                                                                //balanamt += Convert.ToDouble(txtTotalamt.Text) + Convert.ToDouble(txtTobePaidamt.Text) - creditamt;
                                                                                                deductionamt += Convert.ToDouble(txtdeductamt.Text);
                                                                                                //tempHtml.Append("<tr><td style='text-align:center;'>" + sno + "</td><td style='text-align:left;'>" + lblFeeCategory.Text + "</td><td style='text-align:right;'>" + creditamt + "</td>");
                                                                                                tempHtml.Append("<tr><td style='text-align:center;'>" + sno + "</td><td style='text-align:left;'>" + lblFeeCategory.Text + "</td><td style='text-align:center;'>" + creditamt + "</td>");
                                                                                                if (semOrYear != 0)
                                                                                                {
                                                                                                    if (htIndex.Contains("semOrYear"))
                                                                                                    {
                                                                                                        tempHtml.Append("<td style='text-align:Center;'>" + lblsem.Text + "</td>");
                                                                                                        if (indx == 1)
                                                                                                        {
                                                                                                            sbHtml.Append("<td style='text-align:center;'>Category</td>");
                                                                                                        }
                                                                                                    }
                                                                                                }

                                                                                                if (allotedAmt != 0)
                                                                                                {
                                                                                                    if (htIndex.Contains("allotedAmt"))
                                                                                                    {
                                                                                                        tempHtml.Append("<td style='text-align:center;'>" + txtTotalamt.Text + "</td>");
                                                                                                        if (indx == 1)
                                                                                                        {
                                                                                                            sbHtml.Append("<td style='text-align:center;'>Fixed Fee Rs</td>");
                                                                                                        }
                                                                                                    }
                                                                                                }

                                                                                                if (balAmt != 0)
                                                                                                {
                                                                                                    if (htIndex.Contains("balAmt"))
                                                                                                    {
                                                                                                        tempHtml.Append("<td style='text-align:center;'>" + txtBalamt.Text + "</td>");
                                                                                                        if (indx == 1)
                                                                                                        {
                                                                                                            sbHtml.Append("<td style='text-align:center;'>Balance Rs</td>");
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                                if (prevPaidAmt != 0)
                                                                                                {
                                                                                                    if (htIndex.Contains("prevPaidAmt"))
                                                                                                    {
                                                                                                        tempHtml.Append("<td style='text-align:center;'>" + txtPaidamt.Text + "</td>");
                                                                                                        if (indx == 1)
                                                                                                        {
                                                                                                            sbHtml.Append("<td style='text-align:center;'>Already Paid Rs</td>");
                                                                                                        }
                                                                                                    }

                                                                                                }

                                                                                                if (concession != 0)
                                                                                                {
                                                                                                    if (htIndex.Contains("concession"))
                                                                                                    {
                                                                                                        tempHtml.Append("<td style='text-align:center;'>" + txtdeductamt.Text + "</td>");
                                                                                                        if (indx == 1)
                                                                                                        {
                                                                                                            sbHtml.Append("<td style='text-align:center;'>Deduction Rs</td>");
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                                sbHtml.Append("</tr>");
                                                                                                tempHtml.Append("</tr>");
                                                                                                sbHtml.Append(tempHtml.ToString());
                                                                                            }
                                                                                        }

                                                                                        #endregion

                                                                                        #endregion

                                                                                        #region Table 3
                                                                                        //Table3 Header   
                                                                                        if (BalanceType == 1)
                                                                                        {
                                                                                            balanamt = retBalance(appnoNew);
                                                                                        }
                                                                                        decimal totalamount = (decimal)curpaid;
                                                                                        //sbHtml.Append("<center><table cellpadding='0' cellspacing='0' style='text-align:left; width: 560px;  border:1px solid;padding-top:0px; ' border='1' class='classBold10'><tr><td style='text-align:center;' colspan='4'>Received " + DecimalToWords(totalamount).ToString() + "Rupees Only</td><td style='text-align:center;'>Total</td><td style='text-align:center;'>Rs. " + curpaid + "/-</td><td style='text-align:center;'>Balance</td><td style='text-align:center;'>Rs. " + balanamt + "/-</td><tr></table></center>");

                                                                                        //sbHtml.Append("<center><table cellpadding='0' cellspacing='0' style='text-align:left; width: 560px;  border:1px solid;padding-top:0px; ' border='1' class='classBold10'><tr><td style='text-align:center;' colspan='4'> " + DecimalToWords(totalamount).ToString() + "Rupees Only</td><td style='text-align:center;'>Total</td><td style='text-align:center;' colspan='3'>Rs. " + curpaid + "/-</td><tr></table></center>");

                                                                                        sbHtml.Append("<center><table cellpadding='0' cellspacing='0' style='text-align:left; width: 560px;  border:0px solid;padding-top:0px; ' class='classBold10'><tr><td style='text-align:center;' colspan='4'> ( " + DecimalToWords(totalamount).ToString() + " Rupees Only )</td><td style='text-align:center;' colspan='3'>Total - Rs. " + curpaid + "/-</td><tr></table></center>");
                                                                                        #endregion

                                                                                        //sbHtml.Append("<center><table cellpadding='0' cellspacing='0' style='text-align:left; width: 560px; padding-top:5px; ' class='classBold10'><tr><td style='text-align:center;'>Mode of Pay : " + modeMulti + ddnar + "</td>");
                                                                                        string remarks = string.Empty;
                                                                                        if (narration == 1)
                                                                                        {
                                                                                            remarks = d2.GetFunction("select narration from ft_findailytransaction where TransCode='" + recptNo.Trim() + "' and app_no='" + appnoNew + "' and isnull(iscanceled,0)=0");
                                                                                            if (remarks.Trim() == "0" || remarks.Trim() == string.Empty)
                                                                                                remarks = string.Empty;
                                                                                            else
                                                                                            {
                                                                                                remarks = "\n Narration : " + remarks;
                                                                                            }
                                                                                        }
                                                                                        sbHtml.Append("<center><table cellpadding='0' cellspacing='0' style='text-align:left; width: 560px; padding-top:5px; ' class='classBold10'><tr><td style='text-align:left;'>Mode of Pay : " + mode + " " + ddnew + "</td></tr><tr><td style='text-align:left;'>" + remarks + " </td>");

                                                                                        if (deduction != 0)
                                                                                        {
                                                                                            sbHtml.Append("<td style='text-align:center;'>Deduction Amount Rs. : " + deductionamt + "</td>");
                                                                                        }
                                                                                        if (excessAmt != 0)
                                                                                        {
                                                                                            sbHtml.Append("<td style='text-align:center;'>Excess Amount Rs. : " + excessRemaining(appnoNew).ToString() + "</td>");
                                                                                        }
                                                                                        if (validDate != 0)
                                                                                        {
                                                                                            sbHtml.Append("<td style='text-align:center;'>Valid upto : " + "(" + recptValid + ")</td>");
                                                                                        }
                                                                                        sbHtml.Append("<tr></table></center>");

                                                                                        sbHtml.Append("<center><table cellpadding='0' cellspacing='0' style='text-align:right; width: 560px;  padding-top:5px; ' class='classBold10'><tr><td style='text-align:right;'>");
                                                                                        //Authorizer
                                                                                        if (forclgName != 0)
                                                                                        {
                                                                                            sbHtml.Append("For " + collegename + "");
                                                                                        }

                                                                                        //if (authSignValue.Trim() != "")
                                                                                        //{
                                                                                        //    sbHtml.Append("<br><br> " + authSignValue + "");
                                                                                        //}
                                                                                        //else
                                                                                        //{
                                                                                        //    sbHtml.Append("<br><br><span style='margin-left:20px; text-align:left;float:left;'>#copy#</span> " + "Authorised Signature" + "");
                                                                                        //}

                                                                                        sbHtml.Append("</td><tr></table></center>");

                                                                                        int marginTop = 220 - (rows * 15);
                                                                                        if (authSignValue.Trim() != "")
                                                                                        {
                                                                                            sbHtml.Append("<br><br><div style='margin-top:" + marginTop + "px;margin-left:20px; text-align:left;float:left;'>#copy#<span style='padding-left:330px;'> " + authSignValue + "</span></div> ");
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            sbHtml.Append("<br><br><div style='margin-top:" + marginTop + "px;margin-left:20px; text-align:left;float:left;'>#copy#<span style='padding-left:330px;'>Authorised Signature</span></div> ");
                                                                                        }

                                                                                        if (studCopy != 0 || studOffiCopy == 1)
                                                                                        {
                                                                                            if (studOffiCopy != 1)
                                                                                            {
                                                                                                StringBuilder sbFinal = new StringBuilder();
                                                                                                sbFinal.Append("<div style='padding-left:5px;height: 920px; width:595px;'>");
                                                                                                sbFinal.Append("<div style='width:585px; height:" + rectHeight + "px;padding-top:5px; border:1px solid;text-align:right;'  class='classBold10'>" + sbHtml.ToString() + "</div>");
                                                                                                sbFinal.Append("</div><br>");
                                                                                                sbFinal.Replace("#copy#", "Original Copy");
                                                                                                contentDiv.InnerHtml += sbFinal.ToString();
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                StringBuilder sbFinal1 = new StringBuilder();
                                                                                                sbFinal1.Append("<div style='width:585px; height:" + rectHeight + "px;padding-top:5px; border:1px solid;text-align:right;'  class='classBold10'>" + sbHtml.ToString() + "</div><br>");
                                                                                                sbFinal1.Replace("#copy#", "Original Copy");
                                                                                                StringBuilder sbFinal = new StringBuilder();
                                                                                                sbFinal.Append("<div style='padding-left:5px;height: 920px; width:595px;'>");
                                                                                                sbFinal.Append(sbFinal1.ToString());
                                                                                                sbFinal.Append("<div style='width:585px; height:" + rectHeight + "px;padding-top:5px; border:1px solid;text-align:right;'  class='classBold10'>" + sbHtml.ToString() + "</div>");
                                                                                                sbFinal.Append("</div><br>");
                                                                                                sbFinal.Replace("#copy#", "Duplicate Copy");
                                                                                                contentDiv.InnerHtml += sbFinal.ToString();
                                                                                            }
                                                                                        }

                                                                                        if (officopy != 0 && studOffiCopy != 1)
                                                                                        {
                                                                                            StringBuilder sbFinal = new StringBuilder();
                                                                                            sbFinal.Append("<div style='padding-left:5px;height: 920px; width:595px;'>");
                                                                                            sbFinal.Append("<div style='width:585px; height:" + rectHeight + "px;padding-top:5px; border:1px solid;text-align:right;'  class='classBold10'>" + sbHtml.ToString() + "</div> ");
                                                                                            sbFinal.Append("</div><br>");
                                                                                            sbFinal.Replace("#copy#", "Office Copy");
                                                                                            contentDiv.InnerHtml += sbFinal.ToString();
                                                                                        }

                                                                                        if (transCopy != 0)
                                                                                        {
                                                                                            StringBuilder sbFinal = new StringBuilder();
                                                                                            sbFinal.Append("<div style='padding-left:5px;height: 920px; width:595px;'>");
                                                                                            sbFinal.Append("<div style='width:585px; height:" + rectHeight + "px;padding-top:5px; border:1px solid;text-align:right;'  class='classBold10'>" + sbHtml.ToString() + "</div>");
                                                                                            sbFinal.Append("</div><br>");
                                                                                            sbFinal.Replace("#copy#", "Transport Copy");
                                                                                            contentDiv.InnerHtml += sbFinal.ToString();
                                                                                        }

                                                                                    }
                                                                                    #endregion
                                                                                }

                                                                                #region New Print
                                                                                //contentDiv.InnerHtml += sbHtml.ToString();
                                                                                contentDiv.Visible = true;
                                                                                ScriptManager.RegisterStartupScript(this, GetType(), "InvokeButton", "PrintDiv();", true);
                                                                                #endregion
                                                                            }
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        imgAlert.Visible = true;
                                                                        //this.Form.DefaultButton = "btn_alertclose";
                                                                        lbl_alert.Text = "Not Enough Details To Print";
                                                                    }
                                                                    #endregion
                                                                }
                                                                else if (save1 == 4)
                                                                {
                                                                    //For Velammal
                                                                    #region Print Option For Receipt
                                                                    if ((rbl_rollnoNew.SelectedIndex == 0 && txt_rollno.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 1 && txtroll_staff.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 2 && txtname_vendor.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 3 && txtroll_other.Text.Trim() != ""))//&& txt_otherMobile.Text.Trim() != ""
                                                                    {
                                                                        //Basic Data
                                                                        //string rollno = txt_rollno.Text.Trim();
                                                                        //  string recptNo = txt_rcptno.Text.Trim();
                                                                        string recptNo = string.Empty;
                                                                        //modified by sudhagar editable receipt no
                                                                        tempRcpt = Convert.ToString(txttemprcpt.Text.Trim());
                                                                        if (!string.IsNullOrEmpty(tempRcpt))
                                                                            recptNo = tempRcpt;
                                                                        else
                                                                            recptNo = txt_rcptno.Text.Trim();
                                                                        string recptDt = txt_date.Text.Trim();
                                                                        //string studname = txt_name.Text.Trim();
                                                                        string course = txt_dept.Text.Trim();
                                                                        if (rbl_rollnoNew.SelectedIndex == 1)
                                                                        {
                                                                            course = txtDept_staff.Text.Trim();
                                                                        }
                                                                        string batchYrSem = string.Empty;
                                                                        string acaYear = d2.GetFunction("select LinkValue from New_InsSettings where LinkName='ChallanAcademicYear' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "'");
                                                                        try
                                                                        {
                                                                            acaYear = acaYear.Split(',')[0] + "-" + acaYear.Split(',')[1];
                                                                        }
                                                                        catch { }
                                                                        try
                                                                        {
                                                                            course = course.Split('-')[0];
                                                                        }
                                                                        catch { course = ""; }

                                                                        // string mode = string.Empty;

                                                                        if (rb_cash.Checked)
                                                                        {
                                                                            mode = "Cash";
                                                                        }
                                                                        else if (rb_cheque.Checked)
                                                                        {
                                                                            mode = "Cheque";
                                                                        }
                                                                        else if (rb_dd.Checked)
                                                                        {
                                                                            mode = "DD";
                                                                        }
                                                                        else if (rb_card.Checked)
                                                                        {
                                                                            mode = "Card";
                                                                        }

                                                                        //Fields to print
                                                                        string queryPrint1 = "select * from FM_RcptChlPrintSettings where collegecode ='" + collegecode1 + "'";
                                                                        ds.Clear();
                                                                        ds = d2.select_method_wo_parameter(queryPrint1, "Text");
                                                                        if (ds.Tables.Count > 0)
                                                                        {
                                                                            if (ds.Tables[0].Rows.Count > 0)
                                                                            {

                                                                                //Footer Div Values

                                                                                byte studCopy = Convert.ToByte(ds.Tables[0].Rows[0]["IsStudCopy"]);
                                                                                byte officopy = Convert.ToByte(ds.Tables[0].Rows[0]["IsOfficeCopy"]);
                                                                                byte transCopy = Convert.ToByte(ds.Tables[0].Rows[0]["IsTransportCopy"]);

                                                                                //Document Settings
                                                                                PdfDocument recptDoc = new PdfDocument(PdfDocumentFormat.InCentimeters(18, 15.2));
                                                                                PdfPage rcptpage = recptDoc.NewPage();
                                                                                Font Fontboldhead = new Font("Arial", 10, FontStyle.Bold);
                                                                                Font FontTableHead = new Font("Arial", 10, FontStyle.Bold);
                                                                                Font FontTable = new Font("Arial", 10, FontStyle.Bold);

                                                                                string colquery = "select collname,university,address1 ,address2,address3+' - '+pincode as address3 from collinfo where college_code=" + collegecode1 + "  ";
                                                                                if (rbl_rollnoNew.SelectedIndex == 0)
                                                                                {
                                                                                    if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 3)
                                                                                    {
                                                                                        colquery += " select a.Current_Semester,a.Degree_code,(c.Course_Name +' - '+ dt.Dept_Name) as department, (c.Course_Name +' - '+ dt.dept_acronym) as dept_acronym,a.Batch_Year,(select TextVal  from TextValTable where TextCode = a.seattype) as seattype ,'' Boarding,a.mother,a.parent_name,ISNULL( type,'') as type,'' Sections  from applyn a,Degree d,Department dt,Course c where a.degree_code =d.Degree_Code and d.Dept_Code =dt.Dept_Code and c.Course_Id =d.Course_Id and a.App_No='" + appnoNew + "' and d.college_code=" + collegecode1 + "";
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        colquery += " select r.Current_Semester,r.Degree_code,(c.Course_Name +' - '+ dt.Dept_Name) as department, (c.Course_Name +' - '+ dt.dept_acronym) as dept_acronym,r.Batch_Year,(select TextVal  from TextValTable where TextCode = a.seattype) as seattype ,r.Boarding,a.mother,a.parent_name,isnull(r.Sections,'') as Sections from Registration r, applyn a,Degree d,Department dt,Course c where a.app_no=r.App_No and r.degree_code =d.Degree_Code and d.Dept_Code =dt.Dept_Code and c.Course_Id =d.Course_Id and r.App_No='" + appnoNew + "' and r.college_code=" + collegecode1 + " ";
                                                                                    }
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                {
                                                                                    colquery += "  select appl_id ,h.dept_name,h.dept_acronym,h.dept_code,s.staff_name,s.staff_code,a.father_name,t.stftype as staff_type  from staffmaster s,staff_appl_master a,hrdept_master h,stafftrans t,desig_master d where s.appl_no =a.appl_no and s.staff_code =t.staff_code and t.dept_code =h.dept_code and d.desig_code =t.desig_code and s.college_code =h.college_code and d.collegeCode =s.college_code and latestrec ='1' and appl_id ='" + appnoNew + "' and s.college_Code=" + collegecode1 + "  ";
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 2)
                                                                                {
                                                                                    colquery += " SELECT VendorContactPK, VenContactType, VenContactName, VenContactDesig, VenContactDept, VendorPhoneNo, VendorExtNo, VendorMobileNo, VendorEmail, VendorFK FROM      IM_VendorContactMaster WHERE VendorContactPK = '" + appnoNew + "' ";
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 3)
                                                                                {
                                                                                    colquery += " SELECT VendorCode,vendorname,VendorMobileNo,VendorAddress,VendorCity,VendorCompName,VendorType  from co_vendormaster  WHERE VendorPK = '" + appnoNew + "' ";
                                                                                    outRoll = string.Empty;
                                                                                }
                                                                                string collegename = "";
                                                                                string add1 = "";
                                                                                string add2 = "";
                                                                                string add3 = "";
                                                                                string univ = "";
                                                                                string deg = "";
                                                                                string cursem = "";
                                                                                string batyr = "";
                                                                                string seatty = "";
                                                                                string board = "";
                                                                                string mothe = "";
                                                                                string fathe = "";
                                                                                double deductionamt = 0;
                                                                                string fgraduate = d2.GetFunction("select isnull(first_graduate,0) as first_graduate  from applyn where app_no='" + appnoNew + "'");
                                                                                if (fgraduate == "0")
                                                                                {
                                                                                    fgraduate = string.Empty;
                                                                                }
                                                                                else
                                                                                {
                                                                                    fgraduate = " FG ";
                                                                                }

                                                                                string sec = string.Empty;
                                                                                ds.Clear();
                                                                                ds = d2.select_method_wo_parameter(colquery, "Text");
                                                                                if (ds.Tables.Count > 0)
                                                                                {
                                                                                    if (ds.Tables[0].Rows.Count > 0)
                                                                                    {
                                                                                        collegename = Convert.ToString(ds.Tables[0].Rows[0]["collname"]);
                                                                                        add1 = Convert.ToString(ds.Tables[0].Rows[0]["address1"]);
                                                                                        add2 = Convert.ToString(ds.Tables[0].Rows[0]["address2"]);
                                                                                        add3 = Convert.ToString(ds.Tables[0].Rows[0]["address3"]);

                                                                                        univ = Convert.ToString(ds.Tables[0].Rows[0]["university"]);
                                                                                    }

                                                                                    if (ds.Tables[1].Rows.Count > 0)
                                                                                    {
                                                                                        if (rbl_rollnoNew.SelectedIndex == 0)
                                                                                        {
                                                                                            //if (degACR == 0)
                                                                                            //{
                                                                                            // deg = Convert.ToString(ds.Tables[1].Rows[0]["department"]);
                                                                                            //}
                                                                                            //else
                                                                                            //{
                                                                                            deg = Convert.ToString(ds.Tables[1].Rows[0]["dept_acronym"]);
                                                                                            //}
                                                                                            cursem = Convert.ToString(ds.Tables[1].Rows[0]["Current_Semester"]);
                                                                                            batyr = Convert.ToString(ds.Tables[1].Rows[0]["Batch_Year"]);
                                                                                            seatty = Convert.ToString(ds.Tables[1].Rows[0]["seattype"]);
                                                                                            board = Convert.ToString(ds.Tables[1].Rows[0]["Boarding"]);
                                                                                            mothe = Convert.ToString(ds.Tables[1].Rows[0]["mother"]);
                                                                                            fathe = Convert.ToString(ds.Tables[1].Rows[0]["parent_name"]);
                                                                                            sec = " " + Convert.ToString(ds.Tables[1].Rows[0]["Sections"]);
                                                                                        }
                                                                                        else if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                        {
                                                                                            //if (degACR == 0)
                                                                                            //{
                                                                                            // deg = Convert.ToString(ds.Tables[1].Rows[0]["dept_name"]);
                                                                                            //}
                                                                                            //else
                                                                                            //{
                                                                                            deg = Convert.ToString(ds.Tables[1].Rows[0]["dept_acronym"]);
                                                                                            //}
                                                                                            //cursem = Convert.ToString(ds.Tables[1].Rows[0]["Current_Semester"]);
                                                                                            //batyr = Convert.ToString(ds.Tables[1].Rows[0]["Batch_Year"]);
                                                                                            seatty = Convert.ToString(ds.Tables[1].Rows[0]["staff_type"]);
                                                                                            //board = Convert.ToString(ds.Tables[1].Rows[0]["Boarding"]);
                                                                                            //mothe = Convert.ToString(ds.Tables[1].Rows[0]["mother"]);
                                                                                            fathe = Convert.ToString(ds.Tables[1].Rows[0]["father_name"]);
                                                                                            //sec = " " + Convert.ToString(ds.Tables[1].Rows[0]["Sections"]);
                                                                                        }
                                                                                        else if (rbl_rollnoNew.SelectedIndex == 2)
                                                                                        {
                                                                                            deg = " - ";
                                                                                        }
                                                                                        else if (rbl_rollnoNew.SelectedIndex == 3)
                                                                                        {
                                                                                            deg = " - ";
                                                                                        }
                                                                                    }

                                                                                    if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                    {
                                                                                        course = txtDept_staff.Text.Trim();
                                                                                        fgraduate = "";
                                                                                    }
                                                                                }

                                                                                #region Table 1
                                                                                //Table1 Format 

                                                                                PdfTable tableparts = recptDoc.NewTable(FontTableHead, 5, 6, 2);
                                                                                tableparts.VisibleHeaders = false;

                                                                                tableparts.Rows[0].SetRowHeight(10);
                                                                                tableparts.Rows[1].SetRowHeight(30);
                                                                                tableparts.Rows[2].SetRowHeight(20);
                                                                                tableparts.Rows[3].SetRowHeight(20);
                                                                                tableparts.Rows[4].SetRowHeight(10);
                                                                                tableparts.Rows[0].SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                tableparts.Rows[1].SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                tableparts.Rows[2].SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                tableparts.Rows[3].SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                tableparts.Rows[4].SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                //Table1 Data
                                                                                //Line 1
                                                                                int rowindextbl1 = 0;

                                                                                tableparts.Cell(rowindextbl1, 0).SetContent("");
                                                                                tableparts.Cell(rowindextbl1, 0).SetFont(FontTable);
                                                                                tableparts.Cell(rowindextbl1, 0).SetContentAlignment(ContentAlignment.MiddleCenter);
                                                                                tableparts.Rows[rowindextbl1].SetRowHeight(10);
                                                                                rowindextbl1++;
                                                                                if (rbl_rollnoNew.SelectedIndex == 0)
                                                                                {
                                                                                    tableparts.Cell(rowindextbl1, 0).SetContent("Roll No");
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                {
                                                                                    tableparts.Cell(rowindextbl1, 0).SetContent("Staff Id");
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 2)
                                                                                {
                                                                                    tableparts.Cell(rowindextbl1, 0).SetContent("Vendor Id");
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 3)
                                                                                {
                                                                                    tableparts.Cell(rowindextbl1, 0).SetContent("");
                                                                                }

                                                                                tableparts.Cell(rowindextbl1, 0).SetFont(FontTableHead);
                                                                                tableparts.Cell(rowindextbl1, 0).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                tableparts.Cell(rowindextbl1, 1).SetContent(": " + outRoll);
                                                                                tableparts.Cell(rowindextbl1, 1).SetFont(FontTableHead);
                                                                                tableparts.Cell(rowindextbl1, 1).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                tableparts.Cell(rowindextbl1, 1).ColSpan = 2;

                                                                                tableparts.Cell(rowindextbl1, 4).SetContent("Receipt No");
                                                                                tableparts.Cell(rowindextbl1, 4).SetFont(FontTableHead);
                                                                                tableparts.Cell(rowindextbl1, 4).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                tableparts.Cell(rowindextbl1, 5).SetContent(": " + recptNo);
                                                                                tableparts.Cell(rowindextbl1, 5).SetFont(FontTableHead);
                                                                                tableparts.Cell(rowindextbl1, 5).SetContentAlignment(ContentAlignment.MiddleLeft);

                                                                                //Line2
                                                                                rowindextbl1++;
                                                                                tableparts.Cell(rowindextbl1, 0).SetContent("Name");
                                                                                tableparts.Cell(rowindextbl1, 0).SetFont(FontTableHead);
                                                                                tableparts.Cell(rowindextbl1, 0).SetContentAlignment(ContentAlignment.MiddleLeft);

                                                                                tableparts.Cell(rowindextbl1, 1).SetContent(": " + studname.ToUpper());
                                                                                tableparts.Cell(rowindextbl1, 1).SetFont(FontTableHead);
                                                                                tableparts.Cell(rowindextbl1, 1).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                tableparts.Cell(rowindextbl1, 1).ColSpan = 3;

                                                                                tableparts.Cell(rowindextbl1, 4).SetContent("Date");
                                                                                tableparts.Cell(rowindextbl1, 4).SetFont(FontTableHead);
                                                                                tableparts.Cell(rowindextbl1, 4).SetContentAlignment(ContentAlignment.MiddleLeft);

                                                                                tableparts.Cell(rowindextbl1, 5).SetContent(": " + recptDt);
                                                                                tableparts.Cell(rowindextbl1, 5).SetFont(FontTableHead);
                                                                                tableparts.Cell(rowindextbl1, 5).SetContentAlignment(ContentAlignment.MiddleLeft);

                                                                                //Line3
                                                                                rowindextbl1++;

                                                                                if (rbl_rollnoNew.SelectedIndex == 0)
                                                                                {
                                                                                    tableparts.Cell(rowindextbl1, 0).SetContent("Year/ Major");
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                {
                                                                                    tableparts.Cell(rowindextbl1, 0).SetContent("Dept");
                                                                                }
                                                                                tableparts.Cell(rowindextbl1, 0).SetFont(FontTableHead);
                                                                                tableparts.Cell(rowindextbl1, 0).SetContentAlignment(ContentAlignment.MiddleLeft);

                                                                                if (rbl_rollnoNew.SelectedIndex == 0)
                                                                                {
                                                                                    tableparts.Cell(rowindextbl1, 1).SetContent(": " + romanLetter(returnYearforSem(cursem)) + " / " + deg.Split('-')[1].ToUpper() + sec.ToUpper() + fgraduate.ToUpper());
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                {
                                                                                    tableparts.Cell(rowindextbl1, 1).SetContent(": " + deg.ToUpper());
                                                                                }

                                                                                tableparts.Cell(rowindextbl1, 1).SetFont(FontTableHead);
                                                                                tableparts.Cell(rowindextbl1, 1).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                tableparts.Cell(rowindextbl1, 1).ColSpan = 3;

                                                                                tableparts.Cell(rowindextbl1, 4).SetContent("Term");
                                                                                tableparts.Cell(rowindextbl1, 4).SetFont(FontTableHead);
                                                                                tableparts.Cell(rowindextbl1, 4).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                tableparts.Cell(rowindextbl1, 5).SetContent(": " + acaYear);
                                                                                tableparts.Cell(rowindextbl1, 5).SetFont(FontTableHead);
                                                                                tableparts.Cell(rowindextbl1, 5).SetContentAlignment(ContentAlignment.MiddleLeft);

                                                                                rowindextbl1++;
                                                                                tableparts.Cell(rowindextbl1, 0).SetContent("-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------");
                                                                                tableparts.Cell(rowindextbl1, 0).SetFont(FontTable);
                                                                                tableparts.Cell(rowindextbl1, 0).SetContentAlignment(ContentAlignment.MiddleCenter);
                                                                                tableparts.Rows[rowindextbl1].SetRowHeight(10);


                                                                                PdfTablePage addtabletopage1 = tableparts.CreateTablePage(new PdfArea(recptDoc, 10, 10, 480, 150));
                                                                                rcptpage.Add(addtabletopage1);

                                                                                #endregion

                                                                                #region Table 2
                                                                                //Table2 Format


                                                                                int rows = 0;
                                                                                foreach (GridViewRow row in grid_Details.Rows)
                                                                                {
                                                                                    CheckBox chkOkPay = (CheckBox)row.FindControl("cb_selectLedger");
                                                                                    if (!chkOkPay.Checked)
                                                                                        continue;
                                                                                    TextBox txtTobePaidamt = (TextBox)row.FindControl("txt_tobepaid_amt");

                                                                                    double creditamt = 0;

                                                                                    if (txtTobePaidamt.Text != "")
                                                                                    {
                                                                                        creditamt = Convert.ToDouble(txtTobePaidamt.Text);
                                                                                        TextBox txtExcessGridAmt = (TextBox)row.FindControl("txt_gridexcess_amt");
                                                                                        double exgridamt = 0;
                                                                                        if (cb_exfees.Checked)
                                                                                        {
                                                                                            double.TryParse(txtExcessGridAmt.Text, out exgridamt);
                                                                                        }
                                                                                        creditamt += exgridamt;
                                                                                        TextBox txtScholAmt = (TextBox)row.FindControl("txt_scholar_amt");
                                                                                        double gvtamt = 0;
                                                                                        if (cb_govt.Checked)
                                                                                        {
                                                                                            double.TryParse(txtScholAmt.Text, out gvtamt);
                                                                                        }
                                                                                        creditamt += gvtamt;
                                                                                        TextBox txtCautAmt = (TextBox)row.FindControl("txt_deposit_amt");

                                                                                        double curCautamt = 0;
                                                                                        if (cb_CautionDep.Checked)
                                                                                        {
                                                                                            double.TryParse(txtCautAmt.Text, out curCautamt);
                                                                                        }
                                                                                        creditamt += curCautamt;
                                                                                        if (creditamt > 0)
                                                                                        {
                                                                                            rows++;
                                                                                        }
                                                                                    }
                                                                                }

                                                                                PdfTable tableparts1 = recptDoc.NewTable(FontTable, rows + 5, 4, 1);
                                                                                //tableparts1.SetBorders(Color.Black, 1, BorderType.Rows);
                                                                                tableparts1.VisibleHeaders = false;
                                                                                tableparts1.Columns[0].SetWidth(57);
                                                                                tableparts1.Columns[1].SetWidth(340);
                                                                                tableparts1.Columns[2].SetWidth(85);
                                                                                tableparts1.Columns[3].SetWidth(28);

                                                                                tableparts1.Cell(0, 0).SetContent("S.No");
                                                                                tableparts1.Cell(0, 0).SetFont(FontTable);
                                                                                tableparts1.Cell(0, 0).SetContentAlignment(ContentAlignment.MiddleCenter);


                                                                                tableparts1.Cell(0, 1).SetContent("Particulars");
                                                                                tableparts1.Cell(0, 1).SetFont(FontTable);
                                                                                tableparts1.Cell(0, 1).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                //tableparts1.Cell(indx, 1).ColSpan = 4;

                                                                                tableparts1.Cell(0, 2).SetContent("Rs.");
                                                                                tableparts1.Cell(0, 2).SetFont(FontTable);
                                                                                tableparts1.Cell(0, 2).SetContentAlignment(ContentAlignment.MiddleRight);
                                                                                tableparts1.Cell(0, 3).SetContent("Ps.");
                                                                                tableparts1.Cell(0, 3).SetFont(FontTable);
                                                                                tableparts1.Cell(0, 3).SetContentAlignment(ContentAlignment.MiddleCenter);
                                                                                tableparts1.Rows[0].SetRowHeight(20);
                                                                                tableparts1.Rows[1].SetRowHeight(10);
                                                                                //Table2 Data

                                                                                #region feedata
                                                                                int sno = 0;
                                                                                int indx = 1;
                                                                                double totalamt = 0;
                                                                                double balanamt = 0;
                                                                                double curpaid = 0;
                                                                                foreach (PdfCell pr in tableparts1.CellRange(indx, 0, indx, 0).Cells)
                                                                                {
                                                                                    pr.ColSpan = 4;
                                                                                }

                                                                                tableparts1.Cell(indx, 0).SetContent("-----------------------------------------------------------------------------------------------------------------------------------------------------");
                                                                                tableparts1.Cell(indx, 0).SetFont(FontTable);
                                                                                tableparts1.Cell(indx, 0).SetContentAlignment(ContentAlignment.MiddleCenter);
                                                                                tableparts1.Rows[indx].SetRowHeight(10);
                                                                                indx++;
                                                                                foreach (GridViewRow row in grid_Details.Rows)
                                                                                {
                                                                                    CheckBox chkOkPay = (CheckBox)row.FindControl("cb_selectLedger");
                                                                                    if (!chkOkPay.Checked)
                                                                                        continue;

                                                                                    TextBox txtTotalamt = (TextBox)row.FindControl("txt_tot_amt");
                                                                                    TextBox txtPaidamt = (TextBox)row.FindControl("txt_paid_amt");
                                                                                    TextBox txtBalamt = (TextBox)row.FindControl("txt_bal_amt");
                                                                                    TextBox txtTobePaidamt = (TextBox)row.FindControl("txt_tobepaid_amt");
                                                                                    TextBox txtdeductamt = (TextBox)row.FindControl("txt_deduct_amt");

                                                                                    Label lblFeeCategory = (Label)row.FindControl("lbl_feetype");
                                                                                    Label lblsem = (Label)row.FindControl("lbl_textval");

                                                                                    double creditamt = 0;

                                                                                    if (txtTobePaidamt.Text != "")
                                                                                    {
                                                                                        creditamt = Convert.ToDouble
            (txtTobePaidamt.Text);
                                                                                        TextBox txtExcessGridAmt = (TextBox)row.FindControl("txt_gridexcess_amt");
                                                                                        double exgridamt = 0;
                                                                                        if (cb_exfees.Checked)
                                                                                        {
                                                                                            double.TryParse(txtExcessGridAmt.Text, out exgridamt);
                                                                                        }
                                                                                        creditamt += exgridamt;

                                                                                        TextBox txtScholAmt = (TextBox)row.FindControl("txt_scholar_amt");
                                                                                        double gvtamt = 0;
                                                                                        if (cb_govt.Checked)
                                                                                        {
                                                                                            double.TryParse(txtScholAmt.Text, out gvtamt);
                                                                                        }
                                                                                        creditamt += gvtamt;
                                                                                        TextBox txtCautAmt = (TextBox)row.FindControl("txt_deposit_amt");

                                                                                        double curCautamt = 0;
                                                                                        if (cb_CautionDep.Checked)
                                                                                        {
                                                                                            double.TryParse(txtCautAmt.Text, out curCautamt);
                                                                                        }
                                                                                        creditamt += curCautamt;
                                                                                    }

                                                                                    if (creditamt > 0)
                                                                                    {
                                                                                        sno++;

                                                                                        totalamt += Convert.ToDouble(txtTotalamt.Text);
                                                                                        balanamt += Convert.ToDouble(txtBalamt.Text);
                                                                                        curpaid += creditamt;
                                                                                        //balanamt += Convert.ToDouble(txtTotalamt.Text) + Convert.ToDouble(txtTobePaidamt.Text) - creditamt;
                                                                                        deductionamt += Convert.ToDouble(txtdeductamt.Text);

                                                                                        tableparts1.Cell(indx, 0).SetContent(sno);
                                                                                        tableparts1.Cell(indx, 0).SetFont(FontTable);
                                                                                        tableparts1.Cell(indx, 0).SetContentAlignment(ContentAlignment.MiddleCenter);


                                                                                        tableparts1.Cell(indx, 1).SetContent(lblFeeCategory.Text);
                                                                                        tableparts1.Cell(indx, 1).SetFont(FontTable);
                                                                                        tableparts1.Cell(indx, 1).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                        //tableparts1.Cell(indx, 1).ColSpan = 4;

                                                                                        tableparts1.Cell(indx, 2).SetContent(returnIntegerPart(creditamt));
                                                                                        tableparts1.Cell(indx, 2).SetFont(FontTable);
                                                                                        tableparts1.Cell(indx, 2).SetContentAlignment(ContentAlignment.MiddleRight);
                                                                                        tableparts1.Cell(indx, 3).SetContent(returnDecimalPart(creditamt));
                                                                                        tableparts1.Cell(indx, 3).SetFont(FontTable);
                                                                                        tableparts1.Cell(indx, 3).SetContentAlignment(ContentAlignment.MiddleCenter);
                                                                                        indx++;
                                                                                    }
                                                                                }



                                                                                foreach (PdfCell pr in tableparts1.CellRange(indx, 0, indx, 0).Cells)
                                                                                {
                                                                                    pr.ColSpan = 4;
                                                                                }

                                                                                tableparts1.Cell(indx, 0).SetContent("-----------------------------------------------------------------------------------------------------------------------------------------------------");
                                                                                tableparts1.Cell(indx, 0).SetFont(FontTable);
                                                                                tableparts1.Cell(indx, 0).SetContentAlignment(ContentAlignment.MiddleCenter);
                                                                                tableparts1.Rows[indx].SetRowHeight(10);
                                                                                indx++;
                                                                                decimal totalamount = (decimal)curpaid;
                                                                                tableparts1.Cell(indx, 1).SetContent("Total");
                                                                                tableparts1.Cell(indx, 1).SetFont(FontTable);
                                                                                tableparts1.Cell(indx, 1).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                tableparts1.Cell(indx, 2).SetContent("" + returnIntegerPart((double)totalamount));
                                                                                tableparts1.Cell(indx, 2).SetFont(FontTable);
                                                                                tableparts1.Cell(indx, 2).SetContentAlignment(ContentAlignment.MiddleRight);
                                                                                tableparts1.Cell(indx, 3).SetContent(returnDecimalPart((double)totalamount));
                                                                                tableparts1.Cell(indx, 3).SetFont(FontTable);
                                                                                tableparts1.Cell(indx, 3).SetContentAlignment(ContentAlignment.MiddleCenter);
                                                                                string endstatement = "\n" + DecimalToWords(totalamount) + " Rupees Only." + "\n\nPaid by " + mode + " Rs." + totalamount.ToString() + "/-.";
                                                                                string finalstrig = "";

                                                                                finalstrig = "\nExcess Amount  : " + excessRemaining(appnoNew).ToString();
                                                                                if (rb_dd.Checked == true)
                                                                                {
                                                                                    finalstrig = finalstrig + "\n" + mode + " : " + txt_ddno.Text.ToString() + "         Date  : " + txt_date1.Text.ToString();
                                                                                    finalstrig = finalstrig + "\nBank Name  : " + ddl_bkname.SelectedItem.Text.ToString();
                                                                                }
                                                                                if (rb_cheque.Checked == true)
                                                                                {
                                                                                    finalstrig = "\n" + mode + " : " + txt_chqno.Text.ToString() + "         Date  : " + txt_date1.Text.ToString();
                                                                                    finalstrig = finalstrig + "\n\nBank Name  : " + ddl_bkname.SelectedItem.Text.ToString();
                                                                                }
                                                                                if (rb_card.Checked)
                                                                                {
                                                                                    finalstrig = "\n" + mode + " : " + newbankname;
                                                                                }
                                                                                endstatement = endstatement + finalstrig;

                                                                                tableparts1.Cell(indx + 1, 0).SetContent(endstatement);
                                                                                tableparts1.Cell(indx + 1, 0).SetFont(FontTable);
                                                                                tableparts1.Cell(indx + 1, 0).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                tableparts1.Cell(indx + 1, 0).ColSpan = 3;

                                                                                #endregion

                                                                                PdfTablePage addtabletopage2 = tableparts1.CreateTablePage(new PdfArea(recptDoc, 10, 80, 480, 500));
                                                                                rcptpage.Add(addtabletopage2);

                                                                                #endregion


                                                                                rcptpage.SaveToDocument();

                                                                                //save changes
                                                                                PdfPage rcptpageOf = rcptpage.CreateCopy();
                                                                                PdfPage rcptpageTran = rcptpage.CreateCopy();
                                                                                if (officopy != 0)
                                                                                {
                                                                                    rcptpageOf.SaveToDocument();
                                                                                }

                                                                                if (transCopy != 0)
                                                                                {
                                                                                    rcptpageTran.SaveToDocument();
                                                                                }

                                                                                //Response Write
                                                                                string appPath = HttpContext.Current.Server.MapPath("~");
                                                                                if (appPath != "")
                                                                                {
                                                                                    string szPath = appPath + "/Report/";
                                                                                    string szFile = "Receipt" + DateTime.Now.ToString("ddMMyyyy") + DateTime.Now.ToString("HHMMss") + ".pdf";

                                                                                    Response.Buffer = true;
                                                                                    Response.Clear();
                                                                                    recptDoc.SaveToFile(szPath + szFile);


                                                                                    Response.Write("<script>window.open('PrintPage.aspx?name=" + szFile + "', '_blank');</script>");

                                                                                }
                                                                                else
                                                                                {
                                                                                    imgAlert.Visible = true;
                                                                                    //this.Form.DefaultButton = "btn_alertclose";
                                                                                    lbl_alert.Text = "Receipt Cannont Be Generated";
                                                                                }
                                                                            }

                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        imgAlert.Visible = true;
                                                                        //this.Form.DefaultButton = "btn_alertclose";
                                                                        lbl_alert.Text = "Not Enough Details To Print";
                                                                    }
                                                                    #endregion
                                                                }
                                                                else if (save1 == 5)
                                                                {
                                                                    //Jeppiar
                                                                }
                                                                else if (save1 == 6)
                                                                {
                                                                    //For PMC
                                                                    #region Print Option For Receipt
                                                                    if ((rbl_rollnoNew.SelectedIndex == 0 && txt_rollno.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 1 && txtroll_staff.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 2 && txtname_vendor.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 3 && txtroll_other.Text.Trim() != ""))// && txt_otherMobile.Text.Trim() != ""
                                                                    {
                                                                        //Basic Data
                                                                        //string rollno = txt_rollno.Text.Trim();
                                                                        // string recptNo = txt_rcptno.Text.Trim();
                                                                        string recptNo = string.Empty;
                                                                        //modified by sudhagar editable receipt no
                                                                        tempRcpt = Convert.ToString(txttemprcpt.Text.Trim());
                                                                        if (!string.IsNullOrEmpty(tempRcpt))
                                                                            receiptno = tempRcpt;
                                                                        else
                                                                            receiptno = txt_rcptno.Text.Trim();
                                                                        string recptDt = txt_date.Text.Trim();
                                                                        //string studname = txt_name.Text.Trim();
                                                                        string course = txt_dept.Text.Trim();
                                                                        string batchYrSem = string.Empty;
                                                                        string acaYear = d2.GetFunction("select LinkValue from New_InsSettings where LinkName='ChallanAcademicYear' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "'");
                                                                        try
                                                                        {
                                                                            acaYear = acaYear.Split(',')[0] + "-" + acaYear.Split(',')[1];
                                                                        }
                                                                        catch { }
                                                                        try
                                                                        {
                                                                            course = course.Split('-')[0];
                                                                        }
                                                                        catch { course = ""; }
                                                                        // string mode = string.Empty;

                                                                        if (rb_cash.Checked)
                                                                        {
                                                                            mode = "Cash";
                                                                        }
                                                                        else if (rb_cheque.Checked)
                                                                        {
                                                                            mode = "Cheque - No:" + checkDDno;
                                                                        }
                                                                        else if (rb_dd.Checked)
                                                                        {
                                                                            mode = "DD - No:" + checkDDno;
                                                                        }
                                                                        else if (rb_card.Checked)
                                                                        {
                                                                            mode = "Card - " + newbankname;
                                                                        }

                                                                        //Fields to print
                                                                        string queryPrint1 = "select * from FM_RcptChlPrintSettings where collegecode ='" + collegecode1 + "'";
                                                                        ds.Clear();
                                                                        ds = d2.select_method_wo_parameter(queryPrint1, "Text");
                                                                        if (ds.Tables.Count > 0)
                                                                        {
                                                                            if (ds.Tables[0].Rows.Count > 0)
                                                                            {

                                                                                //Footer Div Values
                                                                                byte narration = Convert.ToByte(ds.Tables[0].Rows[0]["IsNarration"]);

                                                                                byte studCopy = Convert.ToByte(ds.Tables[0].Rows[0]["IsStudCopy"]);
                                                                                byte officopy = Convert.ToByte(ds.Tables[0].Rows[0]["IsOfficeCopy"]);
                                                                                byte transCopy = Convert.ToByte(ds.Tables[0].Rows[0]["IsTransportCopy"]);

                                                                                //Document Settings
                                                                                contentDiv.InnerHtml = "";
                                                                                StringBuilder sbHtml = new StringBuilder();

                                                                                string colquery = "select collname,university,address1 ,address2,address3+' - '+pincode as address3 from collinfo where college_code=" + collegecode1 + " ";
                                                                                if (rbl_rollnoNew.SelectedIndex == 0)
                                                                                {
                                                                                    if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 3)
                                                                                    {
                                                                                        colquery += " select a.Current_Semester,a.Degree_code,(c.Course_Name +' - '+ dt.Dept_Name) as department, (c.Course_Name +' - '+ dt.dept_acronym) as dept_acronym,a.Batch_Year,(select TextVal  from TextValTable where TextCode = a.seattype) as seattype ,'' Boarding,a.mother,a.parent_name,ISNULL( type,'') as type,'' Sections  from applyn a,Degree d,Department dt,Course c where a.degree_code =d.Degree_Code and d.Dept_Code =dt.Dept_Code and c.Course_Id =d.Course_Id and a.App_No='" + appnoNew + "' and d.college_code=" + collegecode1 + "";
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        colquery += " select r.Current_Semester,r.Degree_code,(c.Course_Name +' - '+ dt.Dept_Name) as department, (c.Course_Name +' - '+ dt.dept_acronym) as dept_acronym,r.Batch_Year,(select TextVal  from TextValTable where TextCode = a.seattype) as seattype ,r.Boarding,a.mother,a.parent_name,isnull(r.Sections,'') as Sections from Registration r, applyn a,Degree d,Department dt,Course c where a.app_no=r.App_No and r.degree_code =d.Degree_Code and d.Dept_Code =dt.Dept_Code and c.Course_Id =d.Course_Id and r.App_No='" + appnoNew + "' and r.college_code=" + collegecode1 + " ";
                                                                                    }
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                {
                                                                                    colquery += "  select appl_id ,h.dept_name,h.dept_acronym,h.dept_code,s.staff_name,s.staff_code,a.father_name,t.stftype as staff_type  from staffmaster s,staff_appl_master a,hrdept_master h,stafftrans t,desig_master d where s.appl_no =a.appl_no and s.staff_code =t.staff_code and t.dept_code =h.dept_code and d.desig_code =t.desig_code and s.college_code =h.college_code and d.collegeCode =s.college_code and latestrec ='1' and appl_id ='" + appnoNew + "' and s.college_Code=" + collegecode1 + "  ";
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 2)
                                                                                {
                                                                                    colquery += " SELECT VendorContactPK, VenContactType, VenContactName, VenContactDesig, VenContactDept, VendorPhoneNo, VendorExtNo, VendorMobileNo, VendorEmail, VendorFK FROM      IM_VendorContactMaster WHERE VendorContactPK = '" + appnoNew + "' ";
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 3)
                                                                                {
                                                                                    colquery += " SELECT VendorCode,vendorname,VendorMobileNo,VendorAddress,VendorCity,VendorCompName,VendorType  from co_vendormaster  WHERE VendorPK = '" + appnoNew + "' ";
                                                                                    outRoll = string.Empty;
                                                                                }
                                                                                string collegename = "";
                                                                                string add1 = "";
                                                                                string add2 = "";
                                                                                string add3 = "";
                                                                                string univ = "";
                                                                                string deg = "";
                                                                                string cursem = "";
                                                                                string batyr = "";
                                                                                string seatty = "";
                                                                                string board = "";
                                                                                string mothe = "";
                                                                                string fathe = "";
                                                                                double deductionamt = 0;
                                                                                ds.Clear();
                                                                                ds = d2.select_method_wo_parameter(colquery, "Text");
                                                                                if (ds.Tables.Count > 0)
                                                                                {
                                                                                    if (ds.Tables[0].Rows.Count > 0)
                                                                                    {
                                                                                        collegename = Convert.ToString(ds.Tables[0].Rows[0]["collname"]);
                                                                                        add1 = Convert.ToString(ds.Tables[0].Rows[0]["address1"]);
                                                                                        add2 = Convert.ToString(ds.Tables[0].Rows[0]["address2"]);
                                                                                        add3 = Convert.ToString(ds.Tables[0].Rows[0]["address3"]);

                                                                                        univ = Convert.ToString(ds.Tables[0].Rows[0]["university"]);
                                                                                    }
                                                                                    if (ds.Tables[1].Rows.Count > 0)
                                                                                    {
                                                                                        if (rbl_rollnoNew.SelectedIndex == 0)
                                                                                        {
                                                                                            //if (degACR == 0)
                                                                                            //{
                                                                                            // deg = Convert.ToString(ds.Tables[1].Rows[0]["department"]);
                                                                                            //}
                                                                                            //else
                                                                                            //{
                                                                                            deg = Convert.ToString(ds.Tables[1].Rows[0]["dept_acronym"]);
                                                                                            //}
                                                                                            cursem = Convert.ToString(ds.Tables[1].Rows[0]["Current_Semester"]);
                                                                                            batyr = Convert.ToString(ds.Tables[1].Rows[0]["Batch_Year"]);
                                                                                            seatty = Convert.ToString(ds.Tables[1].Rows[0]["seattype"]);
                                                                                            board = Convert.ToString(ds.Tables[1].Rows[0]["Boarding"]);
                                                                                            mothe = Convert.ToString(ds.Tables[1].Rows[0]["mother"]);
                                                                                            fathe = Convert.ToString(ds.Tables[1].Rows[0]["parent_name"]);
                                                                                            //sec = " " + Convert.ToString(ds.Tables[1].Rows[0]["Sections"]);
                                                                                        }
                                                                                        else if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                        {
                                                                                            //if (degACR == 0)
                                                                                            //{
                                                                                            // deg = Convert.ToString(ds.Tables[1].Rows[0]["dept_name"]);
                                                                                            //}
                                                                                            //else
                                                                                            //{
                                                                                            deg = Convert.ToString(ds.Tables[1].Rows[0]["dept_acronym"]);
                                                                                            //}
                                                                                            //cursem = Convert.ToString(ds.Tables[1].Rows[0]["Current_Semester"]);
                                                                                            //batyr = Convert.ToString(ds.Tables[1].Rows[0]["Batch_Year"]);
                                                                                            seatty = Convert.ToString(ds.Tables[1].Rows[0]["staff_type"]);
                                                                                            //board = Convert.ToString(ds.Tables[1].Rows[0]["Boarding"]);
                                                                                            //mothe = Convert.ToString(ds.Tables[1].Rows[0]["mother"]);
                                                                                            fathe = Convert.ToString(ds.Tables[1].Rows[0]["father_name"]);
                                                                                            //sec = " " + Convert.ToString(ds.Tables[1].Rows[0]["Sections"]);
                                                                                        }
                                                                                        else if (rbl_rollnoNew.SelectedIndex == 2)
                                                                                        {
                                                                                            deg = " - ";
                                                                                        }
                                                                                        else if (rbl_rollnoNew.SelectedIndex == 3)
                                                                                        {
                                                                                            deg = " - ";
                                                                                        }
                                                                                    }

                                                                                    if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                    {
                                                                                        course = txtDept_staff.Text.Trim();
                                                                                    }
                                                                                }

                                                                                #region Receipt Header

                                                                                string degString = string.Empty;
                                                                                //Line3
                                                                                if (rbl_rollnoNew.SelectedIndex == 0)
                                                                                {
                                                                                    degString = deg;//.Split('-')[0].ToUpper();
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                {
                                                                                    degString = deg;
                                                                                }
                                                                                string deptstring = string.Empty;
                                                                                if (rbl_rollnoNew.SelectedIndex == 0)
                                                                                {
                                                                                    deptstring = deg.Split('-')[1].ToUpper();
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                {

                                                                                }

                                                                                sbHtml.Append("<div style='padding-left: 0px; height: 500px; width: 640px;><table cellpadding='0' cellspacing='0' style='text-align:center; width: 640px; ' class='classBold10'><tr><td>");

                                                                                sbHtml.Append("<div style='text-align: right; padding-left: 0px; width: 640px; height: 47px;'><img src='../FinanceLogo/right_Logo" + collegecode1 + ".jpeg?" + DateTime.Now.Ticks.ToString() + "' style='padding-left: 610px;' height='45px' width='60px'/></div>");

                                                                                //  sbHtml.Append("<table style='width:586px; height:100px; padding-left:20px; ' class='classBold10'><tr><td style='width:200px; text-align:left;'>" + recptNo + "</td><td style='width:200px; text-align:left;'>" + recptDt + "</td><td style='width:180px; text-align:right;'>" + Regno + "</td></tr><tr><td style='width:590px; text-align:left;' colspan='2'>" + studname.ToUpper() + "</td></tr><tr><td style='width:300px; text-align:left;'>" + degString + "</td><td style='width:280px; text-align:left;'>" + romanLetter(returnYearforSem(cursem)) + " Year </td></tr></table>");
                                                                                sbHtml.Append("<table style='width: 560px; height: 110px; padding-top: 54px;' class='classBold10'><tr><td style='width: 180px; text-align: right; padding-bottom:2px;'>&nbsp;&nbsp;" + recptNo + "</td><td style='width: 160px; text-align: right;padding-bottom:2px;'>&nbsp;&nbsp;&nbsp;&nbsp;" + recptDt + "</td><td style='width: 180px; text-align: right;padding-bottom:2px;'>" + Regno + "</td></tr><tr><td style='width: 560px; padding-top: 4px;' colspan='3'><span style='padding-left: 71px;'>" + studname.ToUpper() + "</span></td></tr><tr><td style='width: 150px; text-align: right; padding-top: 10px;' >" + degString + "</td><td style='width: 320px; padding-left: 71px; padding-top: 10px;' colspan='2'>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;" + romanLetter(returnYearforSem(cursem)) + " Year </td></tr></table>");
                                                                                #endregion

                                                                                #region Receipt Body

                                                                                int rows = 0;
                                                                                foreach (GridViewRow row in grid_Details.Rows)
                                                                                {
                                                                                    CheckBox chkOkPay = (CheckBox)row.FindControl("cb_selectLedger");
                                                                                    if (!chkOkPay.Checked)
                                                                                        continue;
                                                                                    TextBox txtTobePaidamt = (TextBox)row.FindControl("txt_tobepaid_amt");

                                                                                    double creditamt = 0;

                                                                                    if (txtTobePaidamt.Text != "")
                                                                                    {
                                                                                        creditamt = Convert.ToDouble(txtTobePaidamt.Text);
                                                                                        TextBox txtExcessGridAmt = (TextBox)row.FindControl("txt_gridexcess_amt");
                                                                                        double exgridamt = 0;
                                                                                        if (cb_exfees.Checked)
                                                                                        {
                                                                                            double.TryParse(txtExcessGridAmt.Text, out exgridamt);
                                                                                        }
                                                                                        creditamt += exgridamt;
                                                                                        TextBox txtScholAmt = (TextBox)row.FindControl("txt_scholar_amt");
                                                                                        double gvtamt = 0;
                                                                                        if (cb_govt.Checked)
                                                                                        {
                                                                                            double.TryParse(txtScholAmt.Text, out gvtamt);
                                                                                        }
                                                                                        creditamt += gvtamt;
                                                                                        TextBox txtCautAmt = (TextBox)row.FindControl("txt_deposit_amt");

                                                                                        double curCautamt = 0;
                                                                                        if (cb_CautionDep.Checked)
                                                                                        {
                                                                                            double.TryParse(txtCautAmt.Text, out curCautamt);
                                                                                        }
                                                                                        creditamt += curCautamt;
                                                                                        if (creditamt > 0)
                                                                                        {
                                                                                            rows++;
                                                                                        }
                                                                                    }
                                                                                }

                                                                                // sbHtml.Append("<div style='width:586px; height:200px; padding-left:2px;padding-top:10px; '><table  class='classBold10'>");
                                                                                sbHtml.Append("<div style='width: 560px; height: 130px; padding-left: 2px; padding-top: 30px;'><table  class='classBold10'><tr><td style='width: 410px;'></td><td style='width:110px;text-align:right;'>&nbsp;</td><td style='text-align:right;'></td></tr>");

                                                                                int sno = 0;
                                                                                int indx = 0;
                                                                                double totalamt = 0;
                                                                                double balanamt = 0;
                                                                                double curpaid = 0;
                                                                                foreach (GridViewRow row in grid_Details.Rows)
                                                                                {
                                                                                    CheckBox chkOkPay = (CheckBox)row.FindControl("cb_selectLedger");
                                                                                    if (!chkOkPay.Checked)
                                                                                        continue;

                                                                                    TextBox txtTotalamt = (TextBox)row.FindControl("txt_tot_amt");
                                                                                    TextBox txtPaidamt = (TextBox)row.FindControl("txt_paid_amt");
                                                                                    TextBox txtBalamt = (TextBox)row.FindControl("txt_bal_amt");
                                                                                    TextBox txtTobePaidamt = (TextBox)row.FindControl("txt_tobepaid_amt");
                                                                                    TextBox txtdeductamt = (TextBox)row.FindControl("txt_deduct_amt");

                                                                                    Label lblFeeCategory = (Label)row.FindControl("lbl_feetype");
                                                                                    Label lblsem = (Label)row.FindControl("lbl_textval");

                                                                                    double creditamt = 0;

                                                                                    if (txtTobePaidamt.Text != "")
                                                                                    {
                                                                                        creditamt = Convert.ToDouble
            (txtTobePaidamt.Text);
                                                                                        TextBox txtExcessGridAmt = (TextBox)row.FindControl("txt_gridexcess_amt");
                                                                                        double exgridamt = 0;
                                                                                        if (cb_exfees.Checked)
                                                                                        {
                                                                                            double.TryParse(txtExcessGridAmt.Text, out exgridamt);
                                                                                        }
                                                                                        creditamt += exgridamt;
                                                                                        TextBox txtScholAmt = (TextBox)row.FindControl("txt_scholar_amt");
                                                                                        double gvtamt = 0;
                                                                                        if (cb_govt.Checked)
                                                                                        {
                                                                                            double.TryParse(txtScholAmt.Text, out gvtamt);
                                                                                        }
                                                                                        creditamt += gvtamt;
                                                                                        TextBox txtCautAmt = (TextBox)row.FindControl("txt_deposit_amt");

                                                                                        double curCautamt = 0;
                                                                                        if (cb_CautionDep.Checked)
                                                                                        {
                                                                                            double.TryParse(txtCautAmt.Text, out curCautamt);
                                                                                        }
                                                                                        creditamt += curCautamt;
                                                                                    }

                                                                                    if (creditamt > 0)
                                                                                    {
                                                                                        sno++;

                                                                                        totalamt += Convert.ToDouble(txtTotalamt.Text);
                                                                                        balanamt += Convert.ToDouble(txtBalamt.Text);
                                                                                        curpaid += creditamt;
                                                                                        //balanamt += Convert.ToDouble(txtTotalamt.Text) + Convert.ToDouble(txtTobePaidamt.Text) - creditamt;
                                                                                        deductionamt += Convert.ToDouble(txtdeductamt.Text);
                                                                                        indx++;

                                                                                        // sbHtml.Append("<tr><td style='width:480px;'>" + lblFeeCategory.Text + "</td><td style='width:60px;text-align:right;'>" + creditamt + "</td><td style='width:40px;'></td></tr>");

                                                                                        sbHtml.Append("<tr><td style='width: 410px; padding-left: 25px;'>" + lblFeeCategory.Text + "</td><td style='width: 110px; text-align: right;'>" + creditamt + "</td><td style='text-align:right;'></td></tr>");
                                                                                    }
                                                                                }
                                                                                if (BalanceType == 1)
                                                                                {
                                                                                    balanamt = retBalance(appnoNew);
                                                                                }

                                                                                sbHtml.Append("</table></div>");
                                                                                #region DDNarration
                                                                                string ddnar = string.Empty;
                                                                                //double modeht = 40;
                                                                                if (narration != 0)
                                                                                {
                                                                                    if (chk_rcptMulmode.Checked)
                                                                                    {
                                                                                        mode = modeMulti;
                                                                                        for (int z = 0; z < dtMulBnkDetails.Rows.Count; z++)
                                                                                        {
                                                                                            ddnar += " " + (z + 1).ToString() + ")No : " + dtMulBnkDetails.Rows[z][1] + " Bank : " + dtMulBnkDetails.Rows[z][0] + " Branch :" + dtMulBnkDetails.Rows[z][2] + " Date  : " + dtMulBnkDetails.Rows[z][3] + " Amount : " + dtMulBnkDetails.Rows[z][4] + "/-";
                                                                                        }
                                                                                        //modeht = dtMulBnkDetails.Rows.Count * 15;
                                                                                        //modeht += 20;
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        if (!rb_cash.Checked)
                                                                                        {
                                                                                            if (rb_dd.Checked == true)
                                                                                            {
                                                                                                ddnar = ddnar + " DDNo : " + checkDDno + " Bank : " + newbankname + " Branch :" + branch + " Date  : " + txt_date1.Text.ToString();
                                                                                                //mode = "DD - No:" + checkDDno;
                                                                                            }
                                                                                            else if (rb_cheque.Checked)
                                                                                            {
                                                                                                ddnar = ddnar + " ChequeNo : " + checkDDno + " Bank : " + newbankname + " Branch :" + branch + " Date  : " + txt_date1.Text.ToString();
                                                                                                // mode = "Cheque - No:" + checkDDno;
                                                                                            }
                                                                                            else if (rb_card.Checked == true)
                                                                                            {
                                                                                                ddnar = ddnar + " Card : " + newbankname;
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                    ddnar += " " + txt_remark.Text.Trim();
                                                                                }
                                                                                #endregion

                                                                                //   sbHtml.Append("<table style='width:350px; height:20px;padding-left:10px;' class='classBold10'><tr><td>" + mode.ToUpper() + ddnar + "</td></tr>");
                                                                                //Mode of Pay
                                                                                sbHtml.Append("<table style='height: 50px;'><tr><td style='width: 300px;' class='classBold10'>" + mode.ToUpper() + ddnar + "</td><td style='width: 220px; padding-left: 52px;' class='classBold10'><br>" + balanamt + "</td></tr></table>");
                                                                                // sbHtml.Append("<table style='width:580px; height:20px;padding-left:330px;' class='classBold10'><tr><td>" + balanamt + "</td></tr></table>");
                                                                                //  sbHtml.Append("<table style='width: 560px; padding-left: 10px; padding-top: 25px;' class='classBold10'><tr><td style='width:410px;'></td><td style='width: 110px; text-align: right;'>" + balanamt + "</td><td style=''></td></tr></table>");

                                                                                double totalamount = curpaid;

                                                                                //  sbHtml.Append("<table style='width:580px; height:28px;padding-left:2px;' class='classBold10'><tr><td style='width:490px;'></td><td style='width:60px;text-align:right;'>" + totalamount + "</td><td style='width:30px;'></td></tr><tr><td>Received Rupees " + DecimalToWords((decimal)totalamount) + " Only.</td><td colspan='2'></td></tr></table>");
                                                                                sbHtml.Append("<table style='width: 560px; padding-left: 10px; padding-top: 25px;' class='classBold10'><tr><td style='width:410px;'></td><td style='width: 110px; text-align: right;'>" + totalamount + "</td><td style=''></td></tr></table>");
                                                                                sbHtml.Append("<br/><table style='width: 520px; padding-left: 2px;' class='classBold10'><tr><td><span style='padding-left: 5px;'> Received Rupees " + DecimalToWords((decimal)totalamount) + " Only.</span></td><td colspan='2'></td></tr></table>");
                                                                                #endregion
                                                                                sbHtml.Append("</td></tr></table></div>");
                                                                                contentDiv.InnerHtml = sbHtml.ToString();

                                                                                #region New Print
                                                                                //contentDiv.InnerHtml += sbHtml.ToString();
                                                                                contentDiv.Visible = true;
                                                                                ScriptManager.RegisterStartupScript(this, GetType(), "InvokeButton", "PrintDiv();", true);
                                                                                #endregion

                                                                            }

                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        imgAlert.Visible = true;
                                                                        //this.Form.DefaultButton = "btn_alertclose";
                                                                        lbl_alert.Text = "Not Enough Details To Print";
                                                                    }
                                                                    #endregion
                                                                }
                                                                else if (save1 == 10)
                                                                {
                                                                    //For Christopher
                                                                    #region Print Option For Receipt
                                                                    if ((rbl_rollnoNew.SelectedIndex == 0 && txt_rollno.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 1 && txtroll_staff.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 2 && txtname_vendor.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 3 && txtroll_other.Text.Trim() != ""))// && txt_otherMobile.Text.Trim() != ""
                                                                    {
                                                                        //Basic Data
                                                                        //string rollno = txt_rollno.Text.Trim();
                                                                        // string recptNo = txt_rcptno.Text.Trim();
                                                                        string recptNo = string.Empty;
                                                                        //modified by sudhagar editable receipt no
                                                                        tempRcpt = Convert.ToString(txttemprcpt.Text.Trim());
                                                                        if (!string.IsNullOrEmpty(tempRcpt))
                                                                            receiptno = tempRcpt;
                                                                        else
                                                                            receiptno = txt_rcptno.Text.Trim();
                                                                        string recptDt = txt_date.Text.Trim();
                                                                        //string studname = txt_name.Text.Trim();
                                                                        string course = txt_dept.Text.Trim();
                                                                        string batchYrSem = string.Empty;

                                                                        try
                                                                        {
                                                                            course = course.Split('-')[0];
                                                                        }
                                                                        catch { course = ""; }
                                                                        // string mode = string.Empty;

                                                                        if (rb_cash.Checked)
                                                                        {
                                                                            mode = "Cash";
                                                                        }
                                                                        else if (rb_cheque.Checked)
                                                                        {
                                                                            mode = "Cheque";
                                                                        }
                                                                        else if (rb_dd.Checked)
                                                                        {
                                                                            mode = "DD";
                                                                        }
                                                                        else if (rb_card.Checked)
                                                                        {
                                                                            mode = "Card";
                                                                        }

                                                                        //Fields to print
                                                                        string queryPrint1 = "select * from FM_RcptChlPrintSettings where collegecode ='" + collegecode1 + "'";
                                                                        ds.Clear();
                                                                        ds = d2.select_method_wo_parameter(queryPrint1, "Text");
                                                                        if (ds.Tables.Count > 0)
                                                                        {
                                                                            if (ds.Tables[0].Rows.Count > 0)
                                                                            {

                                                                                //Header Div Values
                                                                                byte collegeid = Convert.ToByte(ds.Tables[0].Rows[0]["IsCollegeName"]);
                                                                                byte address1 = Convert.ToByte(ds.Tables[0].Rows[0]["IsCollegeAdd1"]);
                                                                                byte address2 = Convert.ToByte(ds.Tables[0].Rows[0]["IsCollegeAdd2"]);
                                                                                byte address3 = Convert.ToByte(ds.Tables[0].Rows[0]["IsCollegeAdd3"]);
                                                                                byte city = Convert.ToByte(ds.Tables[0].Rows[0]["IsCollegeDist"]);
                                                                                byte state = Convert.ToByte(ds.Tables[0].Rows[0]["IsCollegeState"]);

                                                                                byte university = Convert.ToByte(ds.Tables[0].Rows[0]["IsCollegeUniversity"]);
                                                                                byte rightLogo = Convert.ToByte(ds.Tables[0].Rows[0]["IsRightLogo"]);
                                                                                byte leftLogo = Convert.ToByte(ds.Tables[0].Rows[0]["IsLeftLogo"]);
                                                                                byte time;
                                                                                if (Convert.ToBoolean(Convert.ToString(ds.Tables[0].Rows[0]["IsTime"])))
                                                                                {
                                                                                    time = 1;
                                                                                }
                                                                                else
                                                                                {
                                                                                    time = 0;
                                                                                }
                                                                                byte degACR = Convert.ToByte(ds.Tables[0].Rows[0]["IsDegreeAcr"]);
                                                                                byte degNam = Convert.ToByte(ds.Tables[0].Rows[0]["IsDegreeName"]);
                                                                                byte studnam = Convert.ToByte(ds.Tables[0].Rows[0]["IsStudName"]);
                                                                                byte year = Convert.ToByte(ds.Tables[0].Rows[0]["IsYear"]);
                                                                                byte semester = Convert.ToByte(ds.Tables[0].Rows[0]["IsSemester"]);
                                                                                byte regno = Convert.ToByte(ds.Tables[0].Rows[0]["IsRegNo"]);
                                                                                byte rolno = Convert.ToByte(ds.Tables[0].Rows[0]["IsRollNo"]);
                                                                                byte admno = Convert.ToByte(ds.Tables[0].Rows[0]["IsAdminNo"]);

                                                                                byte fathername = Convert.ToByte(ds.Tables[0].Rows[0]["IsFatherName"]);
                                                                                byte seattype = Convert.ToByte(ds.Tables[0].Rows[0]["IsSeatType"]);
                                                                                //byte setRollAsAdmin = Convert.ToByte(ds.Tables[0].Rows[0]["rollas_adm"]);
                                                                                byte boarding = Convert.ToByte(ds.Tables[0].Rows[0]["IsBoarding"]);
                                                                                byte mothername = Convert.ToByte(ds.Tables[0].Rows[0]["IsMontherName"]);
                                                                                string recptValid = Convert.ToString(ds.Tables[0].Rows[0]["ValidDate"]);


                                                                                //Body Div Values
                                                                                //byte showAllFees = Convert.ToByte(ds.Tables[0].Rows[0]["showallfee"]);
                                                                                byte allotedAmt = Convert.ToByte(ds.Tables[0].Rows[0]["IsAllotedAmt"]);
                                                                                byte fineAmt = Convert.ToByte(ds.Tables[0].Rows[0]["IsFineAmt"]);
                                                                                byte balAmt = Convert.ToByte(ds.Tables[0].Rows[0]["IsBalanceAmt"]);
                                                                                byte semOrYear = Convert.ToByte(ds.Tables[0].Rows[0]["IsSemYear"]);
                                                                                byte prevPaidAmt = Convert.ToByte(ds.Tables[0].Rows[0]["IsPrevPaid"]);
                                                                                byte excessAmt = Convert.ToByte(ds.Tables[0].Rows[0]["IsExcessAmt"]);
                                                                                // byte totDetails = Convert.ToByte(ds.Tables[0].Rows[0]["Total_Details"]);
                                                                                byte fineInRow = Convert.ToByte(ds.Tables[0].Rows[0]["IsFineinRow"]);
                                                                                //byte totWTselectCol = Convert.ToByte(ds.Tables[0].Rows[0]["TotalSelCol"]);
                                                                                byte concession = Convert.ToByte(ds.Tables[0].Rows[0]["IsConcession"]);
                                                                                string concessionValue = string.Empty;
                                                                                if (concession != 0)
                                                                                {
                                                                                    concessionValue = Convert.ToString(ds.Tables[0].Rows[0]["ConcessionName"]);
                                                                                }


                                                                                //Footer Div Values

                                                                                byte studCopy = Convert.ToByte(ds.Tables[0].Rows[0]["IsStudCopy"]);
                                                                                byte officopy = Convert.ToByte(ds.Tables[0].Rows[0]["IsOfficeCopy"]);
                                                                                byte transCopy = Convert.ToByte(ds.Tables[0].Rows[0]["IsTransportCopy"]);
                                                                                byte narration = Convert.ToByte(ds.Tables[0].Rows[0]["IsNarration"]);
                                                                                byte deduction = Convert.ToByte(ds.Tables[0].Rows[0]["IsTotConcession"]);
                                                                                byte forclgName = Convert.ToByte(ds.Tables[0].Rows[0]["IsForCollegeName"]);
                                                                                byte authSign = Convert.ToByte(ds.Tables[0].Rows[0]["IsAuthSign"]);
                                                                                byte validDate = Convert.ToByte(ds.Tables[0].Rows[0]["IsValidUpto"]);
                                                                                string authSignValue = string.Empty;
                                                                                if (authSign != 0)
                                                                                {
                                                                                    authSignValue = Convert.ToString(ds.Tables[0].Rows[0]["AuthName"]);

                                                                                }

                                                                                byte studOffiCopy = Convert.ToByte(ds.Tables[0].Rows[0]["PageType"]);
                                                                                // byte dispModeWTcash = Convert.ToByte(ds.Tables[0].Rows[0]["DisModeWithCash"]);
                                                                                byte signFile = Convert.ToByte(ds.Tables[0].Rows[0]["cashier_sign"]);

                                                                                //if (signFile != 0)
                                                                                //{
                                                                                //if (FileUpload1.HasFile)
                                                                                //{

                                                                                //}                                                    
                                                                                //}


                                                                                //Document Settings
                                                                                PdfDocument recptDoc = new PdfDocument(PdfDocumentFormat.A4);
                                                                                PdfPage rcptpage = recptDoc.NewPage();
                                                                                //Font Fontboldhead = new Font("Arial", 10, FontStyle.Bold);
                                                                                //Font FontTableHead = new Font("Arial", 7, FontStyle.Bold);
                                                                                //Font FontTable = new Font("Arial", 7, FontStyle.Regular);
                                                                                //Font tamilFont = new Font("AMUDHAM.TTF", 10, FontStyle.Regular);


                                                                                Font Fontboldhead = new Font("Arial", 10, FontStyle.Bold);
                                                                                Font FontTableHead = new Font("Arial", 9, FontStyle.Bold);
                                                                                Font FontTable = new Font("Arial", 9, FontStyle.Regular);
                                                                                Font tamilFont = new Font("AMUDHAM.TTF", 10, FontStyle.Regular);


                                                                                string colquery = "select collname,university,address1 ,address2,address3+' - '+pincode as address3 from collinfo where college_code=" + collegecode1 + " ";
                                                                                if (rbl_rollnoNew.SelectedIndex == 0)
                                                                                {
                                                                                    if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 3)
                                                                                    {
                                                                                        colquery += " select a.Current_Semester,a.Degree_code,(c.Course_Name +' - '+ dt.Dept_Name) as department, (c.Course_Name +' - '+ dt.dept_acronym) as dept_acronym,a.Batch_Year,(select TextVal  from TextValTable where TextCode = a.seattype) as seattype ,'' Boarding,a.mother,a.parent_name,ISNULL( type,'') as type,'' Sections  from applyn a,Degree d,Department dt,Course c where a.degree_code =d.Degree_Code and d.Dept_Code =dt.Dept_Code and c.Course_Id =d.Course_Id and a.App_No='" + appnoNew + "' and d.college_code=" + collegecode1 + "";
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        colquery += " select r.Current_Semester,r.Degree_code,(c.Course_Name +' - '+ dt.Dept_Name) as department, (c.Course_Name +' - '+ dt.dept_acronym) as dept_acronym,r.Batch_Year,(select TextVal  from TextValTable where TextCode = a.seattype) as seattype ,r.Boarding,a.mother,a.parent_name,isnull(r.Sections,'') as Sections from Registration r, applyn a,Degree d,Department dt,Course c where a.app_no=r.App_No and r.degree_code =d.Degree_Code and d.Dept_Code =dt.Dept_Code and c.Course_Id =d.Course_Id and r.App_No='" + appnoNew + "' and r.college_code=" + collegecode1 + " ";
                                                                                    }
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                {
                                                                                    colquery += "  select appl_id ,h.dept_name,h.dept_acronym,h.dept_code,s.staff_name,s.staff_code,a.father_name,t.stftype as staff_type  from staffmaster s,staff_appl_master a,hrdept_master h,stafftrans t,desig_master d where s.appl_no =a.appl_no and s.staff_code =t.staff_code and t.dept_code =h.dept_code and d.desig_code =t.desig_code and s.college_code =h.college_code and d.collegeCode =s.college_code and latestrec ='1' and appl_id ='" + appnoNew + "' and s.college_Code=" + collegecode1 + "  ";
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 2)
                                                                                {
                                                                                    colquery += " SELECT VendorContactPK, VenContactType, VenContactName, VenContactDesig, VenContactDept, VendorPhoneNo, VendorExtNo, VendorMobileNo, VendorEmail, VendorFK FROM      IM_VendorContactMaster WHERE VendorContactPK = '" + appnoNew + "' ";
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 3)
                                                                                {
                                                                                    colquery += " SELECT VendorCode,vendorname,VendorMobileNo,VendorAddress,VendorCity,VendorCompName,VendorType  from co_vendormaster  WHERE VendorPK = '" + appnoNew + "' ";
                                                                                    outRoll = string.Empty;
                                                                                }
                                                                                string collegename = "";
                                                                                string add1 = "";
                                                                                string add2 = "";
                                                                                string add3 = "";
                                                                                string univ = "";
                                                                                string deg = "";
                                                                                string cursem = "";
                                                                                string batyr = "";
                                                                                string seatty = "";
                                                                                string board = "";
                                                                                string mothe = "";
                                                                                string fathe = "";
                                                                                double deductionamt = 0;
                                                                                ds.Clear();
                                                                                ds = d2.select_method_wo_parameter(colquery, "Text");
                                                                                if (ds.Tables.Count > 0)
                                                                                {
                                                                                    if (ds.Tables[0].Rows.Count > 0)
                                                                                    {
                                                                                        collegename = Convert.ToString(ds.Tables[0].Rows[0]["collname"]);
                                                                                        add1 = Convert.ToString(ds.Tables[0].Rows[0]["address1"]);
                                                                                        add2 = Convert.ToString(ds.Tables[0].Rows[0]["address2"]);
                                                                                        add3 = Convert.ToString(ds.Tables[0].Rows[0]["address3"]);

                                                                                        univ = Convert.ToString(ds.Tables[0].Rows[0]["university"]);
                                                                                    }
                                                                                    if (ds.Tables[1].Rows.Count > 0)
                                                                                    {
                                                                                        if (rbl_rollnoNew.SelectedIndex == 0)
                                                                                        {
                                                                                            if (degACR == 0)
                                                                                            {
                                                                                                deg = Convert.ToString(ds.Tables[1].Rows[0]["department"]);
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                deg = Convert.ToString(ds.Tables[1].Rows[0]["dept_acronym"]);
                                                                                            }
                                                                                            cursem = Convert.ToString(ds.Tables[1].Rows[0]["Current_Semester"]);
                                                                                            batyr = Convert.ToString(ds.Tables[1].Rows[0]["Batch_Year"]);
                                                                                            seatty = Convert.ToString(ds.Tables[1].Rows[0]["seattype"]);
                                                                                            board = Convert.ToString(ds.Tables[1].Rows[0]["Boarding"]);
                                                                                            mothe = Convert.ToString(ds.Tables[1].Rows[0]["mother"]);
                                                                                            fathe = Convert.ToString(ds.Tables[1].Rows[0]["parent_name"]);
                                                                                            //sec = " " + Convert.ToString(ds.Tables[1].Rows[0]["Sections"]);
                                                                                        }
                                                                                        else if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                        {
                                                                                            //if (degACR == 0)
                                                                                            //{
                                                                                            // deg = Convert.ToString(ds.Tables[1].Rows[0]["dept_name"]);
                                                                                            //}
                                                                                            //else
                                                                                            //{
                                                                                            deg = Convert.ToString(ds.Tables[1].Rows[0]["dept_acronym"]);
                                                                                            //}
                                                                                            //cursem = Convert.ToString(ds.Tables[1].Rows[0]["Current_Semester"]);
                                                                                            //batyr = Convert.ToString(ds.Tables[1].Rows[0]["Batch_Year"]);
                                                                                            seatty = Convert.ToString(ds.Tables[1].Rows[0]["staff_type"]);
                                                                                            //board = Convert.ToString(ds.Tables[1].Rows[0]["Boarding"]);
                                                                                            //mothe = Convert.ToString(ds.Tables[1].Rows[0]["mother"]);
                                                                                            fathe = Convert.ToString(ds.Tables[1].Rows[0]["father_name"]);
                                                                                            //sec = " " + Convert.ToString(ds.Tables[1].Rows[0]["Sections"]);
                                                                                        }
                                                                                        else if (rbl_rollnoNew.SelectedIndex == 2)
                                                                                        {
                                                                                            deg = " - ";
                                                                                        }
                                                                                        else if (rbl_rollnoNew.SelectedIndex == 3)
                                                                                        {
                                                                                            deg = " - ";
                                                                                        }
                                                                                    }

                                                                                    if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                    {
                                                                                        course = txtDept_staff.Text.Trim();
                                                                                    }
                                                                                }

                                                                                int rectHeight = 380;

                                                                                int curY = 10;
                                                                                int curX = 30;

                                                                                #region Receipt Header

                                                                                //Rectangle Border
                                                                                PdfArea rectArea = new PdfArea(recptDoc, 10, curY, 570, rectHeight);
                                                                                PdfRectangle rectSpace = new PdfRectangle(recptDoc, rectArea, Color.Black);
                                                                                rcptpage.Add(rectSpace);

                                                                                PdfArea rectAreaOff = new PdfArea(recptDoc, 10, curY + 430, 570, rectHeight);
                                                                                PdfRectangle rectSpaceOff = new PdfRectangle(recptDoc, rectAreaOff, Color.Black);
                                                                                //Header Images
                                                                                //Line1
                                                                                PdfImage LogoImageOff;
                                                                                int lefty = 0;
                                                                                if (leftLogo != 0)
                                                                                {
                                                                                    if (File.Exists(HttpContext.Current.Server.MapPath("~/FinanceLogo/Left_Logo" + collegecode1 + ".jpeg")))
                                                                                    {
                                                                                        PdfImage LogoImage = recptDoc.NewImage(HttpContext.Current.Server.MapPath("~/FinanceLogo/Left_Logo" + collegecode1 + ".jpeg"));
                                                                                        //rcptpage.Add(LogoImage, curX, curY + 5, 450);
                                                                                        rcptpage.Add(LogoImage, curX, curY + 5, 600); // Added by jairam 05-07-2016
                                                                                        lefty = curY + 5 + 430;

                                                                                    }
                                                                                }

                                                                                if (collegeid != 0)
                                                                                {
                                                                                    curX = 120;
                                                                                    PdfTextArea clgText = new PdfTextArea(Fontboldhead, Color.Black, new PdfArea(recptDoc, curX, curY, 350, 20), ContentAlignment.MiddleCenter, collegename);
                                                                                    rcptpage.Add(clgText);

                                                                                }
                                                                                PdfTextArea clgOffText = new PdfTextArea(Fontboldhead, Color.Black, new PdfArea(recptDoc, curX, curY + 430, 350, 20), ContentAlignment.MiddleCenter, collegename);

                                                                                PdfImage LogoImageOff1;
                                                                                int righty = 0;
                                                                                if (rightLogo != 0)
                                                                                {
                                                                                    if (File.Exists(HttpContext.Current.Server.MapPath("~/FinanceLogo/Right_Logo" + collegecode1 + ".jpeg")))
                                                                                    {
                                                                                        curX = 500;
                                                                                        PdfImage LogoImage1 = recptDoc.NewImage(HttpContext.Current.Server.MapPath("~/FinanceLogo/Right_Logo" + collegecode1 + ".jpeg"));
                                                                                        //rcptpage.Add(LogoImage1, curX, curY + 5, 450);
                                                                                        rcptpage.Add(LogoImage1, curX, curY + 5, 600); // Added by jairam 05-07-2016
                                                                                        righty = curY + 5 + 430;
                                                                                    }
                                                                                }

                                                                                //Line2
                                                                                curY += 15;
                                                                                if (address1 != 0 || address2 != 0)
                                                                                {
                                                                                    curX = 120;
                                                                                    if (address2 != 0)
                                                                                    {
                                                                                        add1 += " " + add2;
                                                                                    }
                                                                                    PdfTextArea addText = new PdfTextArea(FontTableHead, Color.Black, new PdfArea(recptDoc, curX, curY, 350, 20), ContentAlignment.MiddleCenter, add1);
                                                                                    rcptpage.Add(addText);

                                                                                }
                                                                                PdfTextArea addOffText = new PdfTextArea(FontTableHead, Color.Black, new PdfArea(recptDoc, curX, curY + 430, 350, 20), ContentAlignment.MiddleCenter, add1);


                                                                                //curY += 20;
                                                                                //if (university != 0)
                                                                                //{

                                                                                //    curX = 120;
                                                                                //    PdfTextArea uniText = new PdfTextArea(FontTableHead, Color.Black, new PdfArea(recptDoc, curX, curY, 350, 20), ContentAlignment.MiddleCenter, univ);
                                                                                //    rcptpage.Add(uniText);

                                                                                //}
                                                                                //PdfTextArea uniOffText = new PdfTextArea(FontTableHead, Color.Black, new PdfArea(recptDoc, curX, curY + 430, 350, 20), ContentAlignment.MiddleCenter, univ);

                                                                                //Line3
                                                                                curY += 8;

                                                                                PdfTextArea headingText = new PdfTextArea(Fontboldhead, Color.Black, new PdfArea(recptDoc, curX - 50, curY, 450, 30), ContentAlignment.MiddleCenter, "FEE RECEIPT");
                                                                                rcptpage.Add(headingText);

                                                                                //curX = 280;
                                                                                curY += 12;
                                                                                //Text Area For Receipt
                                                                                PdfTextArea headingText1 = new PdfTextArea(Fontboldhead, Color.Black, new PdfArea(recptDoc, curX - 50, curY, 450, 30), ContentAlignment.MiddleCenter, recptHeader(recptNo));
                                                                                rcptpage.Add(headingText1);

                                                                                //PdfTextArea headingOffText = new PdfTextArea(Fontboldhead, Color.Black, new PdfArea(recptDoc, curX - 80, curY + 430, 450, 30), ContentAlignment.MiddleCenter, "FEE RECEIPT" + recptHeader(receiptno));

                                                                                PdfTextArea headingOffText = new PdfTextArea(Fontboldhead, Color.Black, new PdfArea(recptDoc, curX - 50, curY + 418, 450, 30), ContentAlignment.MiddleCenter, "FEE RECEIPT");

                                                                                PdfTextArea headingOffText1 = new PdfTextArea(Fontboldhead, Color.Black, new PdfArea(recptDoc, curX - 50, curY + 430, 450, 30), ContentAlignment.MiddleCenter, recptHeader(recptNo));
                                                                                curY += 15;

                                                                                #endregion

                                                                                #region Table 1
                                                                                //Table1 Format 
                                                                                PdfTable tableparts = recptDoc.NewTable(FontTableHead, 2, 3, 5);
                                                                                tableparts.VisibleHeaders = false;
                                                                                tableparts.SetBorders(Color.Black, 1, BorderType.CompleteGrid);

                                                                                if (rbl_rollnoNew.SelectedIndex == 0)
                                                                                {
                                                                                    if (regno != 0)
                                                                                    {
                                                                                        tableparts.Cell(0, 0).SetContent("RegNo : " + Regno);
                                                                                        tableparts.Cell(0, 0).SetFont(FontTableHead);
                                                                                        tableparts.Cell(0, 0).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                    }

                                                                                    if (rolno != 0)
                                                                                    {
                                                                                        tableparts.Cell(0, 0).SetContent("RollNo : " + rollno);
                                                                                        tableparts.Cell(0, 0).SetFont(FontTableHead);
                                                                                        tableparts.Cell(0, 0).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                    }

                                                                                    if (admno != 0)
                                                                                    {
                                                                                        tableparts.Cell(0, 0).SetContent("AdmissionNo : " + app_formno);
                                                                                        tableparts.Cell(0, 0).SetFont(FontTableHead);
                                                                                        tableparts.Cell(0, 0).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                    }
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                {
                                                                                    tableparts.Cell(0, 0).SetContent("Staff Id : " + app_formno);
                                                                                    tableparts.Cell(0, 0).SetFont(FontTableHead);
                                                                                    tableparts.Cell(0, 0).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 2)
                                                                                {
                                                                                    tableparts.Cell(0, 0).SetContent("Vendor Id : " + app_formno);
                                                                                    tableparts.Cell(0, 0).SetFont(FontTableHead);
                                                                                    tableparts.Cell(0, 0).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 3)
                                                                                {
                                                                                    tableparts.Cell(0, 0).SetContent("Name : " + studname);
                                                                                    tableparts.Cell(0, 0).SetFont(FontTableHead);
                                                                                    tableparts.Cell(0, 0).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                }


                                                                                tableparts.Cell(0, 1).SetContent("Programme : " + deg);
                                                                                tableparts.Cell(0, 1).SetFont(FontTableHead);
                                                                                tableparts.Cell(0, 1).SetContentAlignment(ContentAlignment.MiddleLeft);

                                                                                tableparts.Cell(0, 2).SetContent(termDisplay(cursem));
                                                                                tableparts.Cell(0, 2).SetFont(FontTableHead);
                                                                                tableparts.Cell(0, 2).SetContentAlignment(ContentAlignment.MiddleLeft);

                                                                                if (rbl_rollnoNew.SelectedIndex != 3)
                                                                                {
                                                                                    tableparts.Cell(1, 0).SetContent("Name : " + studname.ToUpper());
                                                                                    tableparts.Cell(1, 0).SetFont(FontTableHead);
                                                                                    tableparts.Cell(1, 0).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                }


                                                                                tableparts.Cell(1, 1).SetContent("Receipt No : " + recptNo);
                                                                                tableparts.Cell(1, 1).SetFont(FontTableHead);
                                                                                tableparts.Cell(1, 1).SetContentAlignment(ContentAlignment.MiddleLeft);

                                                                                tableparts.Cell(1, 2).SetContent("Date : " + recptDt);
                                                                                tableparts.Cell(1, 2).SetFont(FontTableHead);
                                                                                tableparts.Cell(1, 2).SetContentAlignment(ContentAlignment.MiddleLeft);

                                                                                //Off
                                                                                PdfTable tablepartsOff = recptDoc.NewTable(FontTableHead, 2, 3, 5);
                                                                                tablepartsOff.VisibleHeaders = false;
                                                                                tablepartsOff.SetBorders(Color.Black, 1, BorderType.CompleteGrid);
                                                                                if (rbl_rollnoNew.SelectedIndex == 0)
                                                                                {
                                                                                    if (regno != 0)
                                                                                    {
                                                                                        tablepartsOff.Cell(0, 0).SetContent("RegNo : " + Regno);
                                                                                        tablepartsOff.Cell(0, 0).SetFont(FontTableHead);
                                                                                        tablepartsOff.Cell(0, 0).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                    }

                                                                                    if (rolno != 0)
                                                                                    {
                                                                                        tablepartsOff.Cell(0, 0).SetContent("RollNo : " + rollno);
                                                                                        tablepartsOff.Cell(0, 0).SetFont(FontTableHead);
                                                                                        tablepartsOff.Cell(0, 0).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                    }

                                                                                    if (admno != 0)
                                                                                    {
                                                                                        tablepartsOff.Cell(0, 0).SetContent("AdmissionNo : " + app_formno);
                                                                                        tablepartsOff.Cell(0, 0).SetFont(FontTableHead);
                                                                                        tablepartsOff.Cell(0, 0).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                    }
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                {
                                                                                    tablepartsOff.Cell(0, 0).SetContent("Staff Id : " + app_formno);
                                                                                    tablepartsOff.Cell(0, 0).SetFont(FontTableHead);
                                                                                    tablepartsOff.Cell(0, 0).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 2)
                                                                                {
                                                                                    tablepartsOff.Cell(0, 0).SetContent("Vendor Id : " + app_formno);
                                                                                    tablepartsOff.Cell(0, 0).SetFont(FontTableHead);
                                                                                    tablepartsOff.Cell(0, 0).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 3)
                                                                                {
                                                                                    tablepartsOff.Cell(0, 0).SetContent("Name : " + studname);
                                                                                    tablepartsOff.Cell(0, 0).SetFont(FontTableHead);
                                                                                    tablepartsOff.Cell(0, 0).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                }

                                                                                tablepartsOff.Cell(0, 1).SetContent("Programme : " + deg);
                                                                                tablepartsOff.Cell(0, 1).SetFont(FontTableHead);
                                                                                tablepartsOff.Cell(0, 1).SetContentAlignment(ContentAlignment.MiddleLeft);

                                                                                tablepartsOff.Cell(0, 2).SetContent(termDisplay(cursem));
                                                                                tablepartsOff.Cell(0, 2).SetFont(FontTableHead);
                                                                                tablepartsOff.Cell(0, 2).SetContentAlignment(ContentAlignment.MiddleLeft);

                                                                                if (rbl_rollnoNew.SelectedIndex != 3)
                                                                                {
                                                                                    tablepartsOff.Cell(1, 0).SetContent("Name : " + studname.ToUpper());
                                                                                    tablepartsOff.Cell(1, 0).SetFont(FontTableHead);
                                                                                    tablepartsOff.Cell(1, 0).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                }


                                                                                tablepartsOff.Cell(1, 1).SetContent("Receipt No : " + recptNo);
                                                                                tablepartsOff.Cell(1, 1).SetFont(FontTableHead);
                                                                                tablepartsOff.Cell(1, 1).SetContentAlignment(ContentAlignment.MiddleLeft);

                                                                                tablepartsOff.Cell(1, 2).SetContent("Date : " + recptDt);
                                                                                tablepartsOff.Cell(1, 2).SetFont(FontTableHead);
                                                                                tablepartsOff.Cell(1, 2).SetContentAlignment(ContentAlignment.MiddleLeft);

                                                                                curX = 10;
                                                                                curY += 10;
                                                                                PdfTablePage addtabletopage1 = tableparts.CreateTablePage(new PdfArea(recptDoc, curX, curY, 570, 200));
                                                                                rcptpage.Add(addtabletopage1);

                                                                                PdfTablePage addtabletopageOff1 = tablepartsOff.CreateTablePage(new PdfArea(recptDoc, curX, curY + 430, 570, 200));

                                                                                #endregion

                                                                                #region Table 2
                                                                                //Table2 Format

                                                                                int rows = 1;
                                                                                foreach (GridViewRow row in grid_Details.Rows)
                                                                                {
                                                                                    CheckBox chkOkPay = (CheckBox)row.FindControl("cb_selectLedger");
                                                                                    if (!chkOkPay.Checked)
                                                                                        continue;

                                                                                    TextBox txtTobePaidamt = (TextBox)row.FindControl("txt_tobepaid_amt");
                                                                                    TextBox txtScholAmt = (TextBox)row.FindControl("txt_scholar_amt");
                                                                                    TextBox txtCautAmt = (TextBox)row.FindControl("txt_deposit_amt");
                                                                                    double creditamt = 0;

                                                                                    if (txtTobePaidamt.Text != "")
                                                                                    {
                                                                                        creditamt = Convert.ToDouble(txtTobePaidamt.Text);
                                                                                        TextBox txtExcessGridAmt = (TextBox)row.FindControl("txt_gridexcess_amt");
                                                                                        double exgridamt = 0;
                                                                                        if (cb_exfees.Checked)
                                                                                        {
                                                                                            double.TryParse(txtExcessGridAmt.Text, out exgridamt);
                                                                                        }
                                                                                        creditamt += exgridamt;

                                                                                        double gvtamt = 0;
                                                                                        if (cb_govt.Checked)
                                                                                        {
                                                                                            double.TryParse(txtScholAmt.Text, out gvtamt);
                                                                                        }
                                                                                        creditamt += gvtamt;
                                                                                        double curCautamt = 0;
                                                                                        if (cb_CautionDep.Checked)
                                                                                        {
                                                                                            double.TryParse(txtCautAmt.Text, out curCautamt);
                                                                                        }
                                                                                        creditamt += curCautamt;
                                                                                        if (creditamt > 0)
                                                                                        {
                                                                                            rows++;
                                                                                        }
                                                                                    }
                                                                                }

                                                                                int ledgeCol = 2;
                                                                                int ledgeWidt = 570;

                                                                                if (rows > 0)
                                                                                {
                                                                                    ledgeCol = 2;
                                                                                    ledgeWidt = 570;
                                                                                    int wdth = ledgeWidt - 50;
                                                                                    ledgeWidt = wdth;
                                                                                }
                                                                                if (rows > 10)
                                                                                {
                                                                                    ledgeCol += 2;
                                                                                    ledgeWidt = 570;
                                                                                    int wdth = ledgeWidt - 100;
                                                                                    ledgeWidt = (int)(wdth / 2);
                                                                                }
                                                                                if (rows > 20)
                                                                                {
                                                                                    ledgeCol += 2;
                                                                                    ledgeWidt = 570;
                                                                                    int wdth = ledgeWidt - 150;
                                                                                    ledgeWidt = (int)(wdth / 3);
                                                                                }
                                                                                if (rows > 30)
                                                                                {
                                                                                    ledgeCol += 2;
                                                                                    ledgeWidt = 570;
                                                                                    int wdth = ledgeWidt - 200;
                                                                                    ledgeWidt = (int)(wdth / 4);
                                                                                }
                                                                                PdfTable tableparts1 = recptDoc.NewTable(FontTable, rows, ledgeCol, 5);
                                                                                tableparts1.VisibleHeaders = false;
                                                                                tableparts1.SetBorders(Color.Black, 1, BorderType.Columns);
                                                                                for (int colval = 0; colval < tableparts1.Columns.Length; colval++)
                                                                                {
                                                                                    if (colval % 2 == 1)
                                                                                    {
                                                                                        tableparts1.Columns[colval].SetWidth(50);
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        tableparts1.Columns[colval].SetWidth(ledgeWidt);
                                                                                    }
                                                                                }


                                                                                PdfTable tablepartsOff1 = recptDoc.NewTable(FontTable, rows, ledgeCol, 5);
                                                                                tablepartsOff1.VisibleHeaders = false;
                                                                                tablepartsOff1.SetBorders(Color.Black, 1, BorderType.Columns);
                                                                                for (int colval = 0; colval < tablepartsOff1.Columns.Length; colval++)
                                                                                {
                                                                                    if (colval % 2 == 1)
                                                                                    {
                                                                                        tablepartsOff1.Columns[colval].SetWidth(50);
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        tablepartsOff1.Columns[colval].SetWidth(ledgeWidt);
                                                                                    }
                                                                                }

                                                                                int initLegCol = 0;
                                                                                int initValCol = 1;
                                                                                int initRow = 0;


                                                                                #region feedata
                                                                                int sno = 0;
                                                                                int indx = 0;
                                                                                double totalamt = 0;
                                                                                double balanamt = 0;
                                                                                double curpaid = 0;
                                                                                foreach (GridViewRow row in grid_Details.Rows)
                                                                                {
                                                                                    CheckBox chkOkPay = (CheckBox)row.FindControl("cb_selectLedger");
                                                                                    if (!chkOkPay.Checked)
                                                                                        continue;

                                                                                    TextBox txtTotalamt = (TextBox)row.FindControl("txt_tot_amt");
                                                                                    TextBox txtPaidamt = (TextBox)row.FindControl("txt_paid_amt");
                                                                                    TextBox txtBalamt = (TextBox)row.FindControl("txt_bal_amt");
                                                                                    TextBox txtTobePaidamt = (TextBox)row.FindControl("txt_tobepaid_amt");
                                                                                    TextBox txtdeductamt = (TextBox)row.FindControl("txt_deduct_amt");

                                                                                    Label lblFeeCategory = (Label)row.FindControl("lbl_feetype");
                                                                                    Label lblsem = (Label)row.FindControl("lbl_textval");

                                                                                    double creditamt = 0;

                                                                                    if (txtTobePaidamt.Text != "")
                                                                                    {
                                                                                        creditamt = Convert.ToDouble(txtTobePaidamt.Text);
                                                                                        TextBox txtExcessGridAmt = (TextBox)row.FindControl("txt_gridexcess_amt");
                                                                                        double exgridamt = 0;
                                                                                        if (cb_exfees.Checked)
                                                                                        {
                                                                                            double.TryParse(txtExcessGridAmt.Text, out exgridamt);
                                                                                        }
                                                                                        creditamt += exgridamt;

                                                                                        TextBox txtScholAmt = (TextBox)row.FindControl("txt_scholar_amt");
                                                                                        double gvtamt = 0;
                                                                                        if (cb_govt.Checked)
                                                                                        {
                                                                                            double.TryParse(txtScholAmt.Text, out gvtamt);
                                                                                        }
                                                                                        creditamt += gvtamt;

                                                                                        TextBox txtCautAmt = (TextBox)row.FindControl("txt_deposit_amt");

                                                                                        double curCautamt = 0;
                                                                                        if (cb_CautionDep.Checked)
                                                                                        {
                                                                                            double.TryParse(txtCautAmt.Text, out curCautamt);
                                                                                        }
                                                                                        creditamt += curCautamt;
                                                                                    }

                                                                                    if (creditamt > 0)
                                                                                    {
                                                                                        sno++;
                                                                                        indx++;
                                                                                        totalamt += Convert.ToDouble(txtTotalamt.Text);
                                                                                        balanamt += Convert.ToDouble(txtBalamt.Text);
                                                                                        curpaid += creditamt;
                                                                                        //balanamt += Convert.ToDouble(txtTotalamt.Text) + Convert.ToDouble(txtTobePaidamt.Text) - creditamt;
                                                                                        deductionamt += Convert.ToDouble(txtdeductamt.Text);
                                                                                        if (initRow == 10)
                                                                                        {
                                                                                            initRow = 0;
                                                                                            initLegCol += 2;
                                                                                            initValCol += 2;
                                                                                        }

                                                                                        tableparts1.Cell(initRow, initLegCol).SetContent(sno + ") " + lblFeeCategory.Text);
                                                                                        tableparts1.Cell(initRow, initLegCol).SetFont(FontTable);
                                                                                        tableparts1.Cell(initRow, initLegCol).SetContentAlignment(ContentAlignment.MiddleLeft);


                                                                                        tableparts1.Cell(initRow, initValCol).SetContent(returnIntegerPart(creditamt) + "." + returnDecimalPart(creditamt));
                                                                                        tableparts1.Cell(initRow, initValCol).SetFont(FontTable);
                                                                                        tableparts1.Cell(initRow, initValCol).SetContentAlignment(ContentAlignment.MiddleRight);

                                                                                        tablepartsOff1.Cell(initRow, initLegCol).SetContent(sno + ") " + lblFeeCategory.Text);
                                                                                        tablepartsOff1.Cell(initRow, initLegCol).SetFont(FontTable);
                                                                                        tablepartsOff1.Cell(initRow, initLegCol).SetContentAlignment(ContentAlignment.MiddleLeft);


                                                                                        tablepartsOff1.Cell(initRow, initValCol).SetContent(returnIntegerPart(creditamt) + "." + returnDecimalPart(creditamt));
                                                                                        tablepartsOff1.Cell(initRow, initValCol).SetFont(FontTable);
                                                                                        tablepartsOff1.Cell(initRow, initValCol).SetContentAlignment(ContentAlignment.MiddleRight);

                                                                                        initRow++;

                                                                                    }
                                                                                }

                                                                                #endregion

                                                                                curY += (int)addtabletopage1.Area.Height;
                                                                                PdfTablePage addtabletopage2 = tableparts1.CreateTablePage(new PdfArea(recptDoc, 10, curY, 570, 220));
                                                                                rcptpage.Add(addtabletopage2);
                                                                                PdfTablePage addtabletopageOff2 = tablepartsOff1.CreateTablePage(new PdfArea(recptDoc, 10, curY + 430, 570, 220));

                                                                                #endregion

                                                                                #region Table 3
                                                                                PdfTable tableparts2 = recptDoc.NewTable(FontTableHead, 1, 6, 5);
                                                                                tableparts2.VisibleHeaders = false;
                                                                                tableparts2.SetBorders(Color.Black, 1, BorderType.CompleteGrid);

                                                                                PdfTable tablepartsOff2 = recptDoc.NewTable(FontTableHead, 1, 6, 5);
                                                                                tablepartsOff2.VisibleHeaders = false;
                                                                                tablepartsOff2.SetBorders(Color.Black, 1, BorderType.CompleteGrid);


                                                                                decimal totalamount = (decimal)curpaid;

                                                                                tableparts2.Cell(0, 0).SetContent("Collected By :");
                                                                                tableparts2.Cell(0, 0).SetFont(FontTableHead);
                                                                                tableparts2.Cell(0, 0).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                tableparts2.Cell(0, 0).ColSpan = 2;

                                                                                tableparts2.Cell(0, 2).SetContent("(" + DecimalToWords((decimal)curpaid) + " Rupees Only)");
                                                                                tableparts2.Cell(0, 2).SetFont(FontTableHead);
                                                                                tableparts2.Cell(0, 2).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                tableparts2.Cell(0, 2).ColSpan = 2;

                                                                                tableparts2.Cell(0, 4).SetContent("Total Fees");
                                                                                tableparts2.Cell(0, 4).SetFont(FontTableHead);
                                                                                tableparts2.Cell(0, 4).SetContentAlignment(ContentAlignment.MiddleRight);

                                                                                tableparts2.Cell(0, 5).SetContent(returnIntegerPart(curpaid) + "." + returnDecimalPart(curpaid));
                                                                                tableparts2.Cell(0, 5).SetFont(FontTableHead);
                                                                                tableparts2.Cell(0, 5).SetContentAlignment(ContentAlignment.MiddleCenter);

                                                                                tablepartsOff2.Cell(0, 0).SetContent("Collected By :");
                                                                                tablepartsOff2.Cell(0, 0).SetFont(FontTableHead);
                                                                                tablepartsOff2.Cell(0, 0).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                tablepartsOff2.Cell(0, 0).ColSpan = 2;

                                                                                tablepartsOff2.Cell(0, 2).SetContent("(" + DecimalToWords((decimal)curpaid) + " Rupees Only)");
                                                                                tablepartsOff2.Cell(0, 2).SetFont(FontTableHead);
                                                                                tablepartsOff2.Cell(0, 2).SetContentAlignment(ContentAlignment.MiddleLeft);
                                                                                tablepartsOff2.Cell(0, 2).ColSpan = 2;

                                                                                tablepartsOff2.Cell(0, 4).SetContent("Total Fees");
                                                                                tablepartsOff2.Cell(0, 4).SetFont(FontTableHead);
                                                                                tablepartsOff2.Cell(0, 4).SetContentAlignment(ContentAlignment.MiddleRight);

                                                                                tablepartsOff2.Cell(0, 5).SetContent(returnIntegerPart(curpaid) + "." + returnDecimalPart(curpaid));
                                                                                tablepartsOff2.Cell(0, 5).SetFont(FontTableHead);
                                                                                tablepartsOff2.Cell(0, 5).SetContentAlignment(ContentAlignment.MiddleCenter);

                                                                                curY += (int)addtabletopage2.Area.Height;
                                                                                PdfTablePage addtabletopage3 = tableparts2.CreateTablePage(new PdfArea(recptDoc, 10, curY, 570, 50));
                                                                                rcptpage.Add(addtabletopage3);

                                                                                PdfTablePage addtabletopageOff3 = tablepartsOff2.CreateTablePage(new PdfArea(recptDoc, 10, curY + 430, 570, 50));
                                                                                #endregion

                                                                                #region Receipt Footer
                                                                                PdfPage rcptpageTran = rcptpage.CreateCopy();

                                                                                curY += 24;

                                                                                if (officopy != 0 && studOffiCopy != 0)
                                                                                {
                                                                                    //visible Office copy
                                                                                    rcptpage.Add(rectSpaceOff);
                                                                                    if (leftLogo != 0)
                                                                                    {
                                                                                        if (File.Exists(HttpContext.Current.Server.MapPath("~/FinanceLogo/Left_Logo" + collegecode1 + ".jpeg")))
                                                                                        {
                                                                                            LogoImageOff = recptDoc.NewImage(HttpContext.Current.Server.MapPath("~/FinanceLogo/Left_Logo" + collegecode1 + ".jpeg"));
                                                                                            // rcptpage.Add(LogoImageOff, 30, lefty, 450);
                                                                                            rcptpage.Add(LogoImageOff, 30, lefty, 600);
                                                                                        }
                                                                                    }

                                                                                    if (rightLogo != 0)
                                                                                    {
                                                                                        if (File.Exists(HttpContext.Current.Server.MapPath("~/FinanceLogo/Right_Logo" + collegecode1 + ".jpeg")))
                                                                                        {
                                                                                            LogoImageOff1 = recptDoc.NewImage(HttpContext.Current.Server.MapPath("~/FinanceLogo/Right_Logo" + collegecode1 + ".jpeg"));
                                                                                            // rcptpage.Add(LogoImageOff1, 500, righty, 450);
                                                                                            rcptpage.Add(LogoImageOff1, 30, lefty, 600);
                                                                                        }
                                                                                    }
                                                                                    if (collegeid != 0)
                                                                                    {
                                                                                        rcptpage.Add(clgOffText);
                                                                                    }
                                                                                    if (university != 0)
                                                                                    {
                                                                                        //rcptpage.Add(uniOffText);
                                                                                    }

                                                                                    if (address1 != 0 || address2 != 0)
                                                                                    {
                                                                                        rcptpage.Add(addOffText);
                                                                                    }

                                                                                    if (address3 != 0)
                                                                                    {
                                                                                        //rcptpage.Add(cityOffText);
                                                                                    }
                                                                                    rcptpage.Add(headingOffText);
                                                                                    rcptpage.Add(headingOffText1);
                                                                                    rcptpage.Add(addtabletopageOff1);
                                                                                    rcptpage.Add(addtabletopageOff2);
                                                                                    rcptpage.Add(addtabletopageOff3);

                                                                                    string copy = "Office Copy ";

                                                                                    PdfTextArea studCopyText = new PdfTextArea(FontTableHead, Color.Black, new PdfArea(recptDoc, 50, curY + 430, 150, 20), ContentAlignment.MiddleCenter, copy);
                                                                                    rcptpage.Add(studCopyText);

                                                                                }

                                                                                if (studCopy != 0 || studOffiCopy == 1)
                                                                                {

                                                                                    string copy = "Student Copy ";
                                                                                    if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                    {
                                                                                        copy = "Staff Copy ";
                                                                                    }
                                                                                    else if (rbl_rollnoNew.SelectedIndex == 2)
                                                                                    {
                                                                                        copy = "Vendor Copy ";
                                                                                    }
                                                                                    else if (rbl_rollnoNew.SelectedIndex == 3)
                                                                                    {
                                                                                        copy = "Others Copy ";
                                                                                    }

                                                                                    PdfTextArea studCopyText = new PdfTextArea(FontTableHead, Color.Black, new PdfArea(recptDoc, 50, curY, 150, 20), ContentAlignment.MiddleCenter, copy);
                                                                                    rcptpage.Add(studCopyText);

                                                                                    rcptpage.SaveToDocument();
                                                                                }

                                                                                if (transCopy != 0)
                                                                                {
                                                                                    string copy = "Transport Copy ";

                                                                                    PdfTextArea studCopyText = new PdfTextArea(FontTableHead, Color.Black, new PdfArea(recptDoc, 50, curY, 150, 20), ContentAlignment.MiddleCenter, copy);
                                                                                    rcptpageTran.Add(studCopyText);
                                                                                    rcptpageTran.SaveToDocument();
                                                                                }

                                                                                #endregion

                                                                                //Response Write
                                                                                string appPath = HttpContext.Current.Server.MapPath("~");
                                                                                if (appPath != "")
                                                                                {
                                                                                    string szPath = appPath + "/Report/";
                                                                                    string szFile = "Receipt" + DateTime.Now.ToString("ddMMyyyy") + DateTime.Now.ToString("HHMMss") + ".pdf";

                                                                                    Response.Buffer = true;
                                                                                    Response.Clear();
                                                                                    recptDoc.SaveToFile(szPath + szFile);

                                                                                    Response.Write("<script>window.open('PrintPage.aspx?name=" + szFile + "', '_blank');</script>");

                                                                                }
                                                                                else
                                                                                {
                                                                                    imgAlert.Visible = true;
                                                                                    //this.Form.DefaultButton = "btn_alertclose";
                                                                                    lbl_alert.Text = "Receipt Cannont Be Generated";
                                                                                }
                                                                            }

                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        imgAlert.Visible = true;
                                                                        //this.Form.DefaultButton = "btn_alertclose";
                                                                        lbl_alert.Text = "Not Enough Details To Print";
                                                                    }
                                                                    #endregion
                                                                }
                                                                else if (save1 == 11)
                                                                {

                                                                    //For San Academy
                                                                    #region Print Option For Receipt
                                                                    if ((rbl_rollnoNew.SelectedIndex == 0 && txt_rollno.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 1 && txtroll_staff.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 2 && txtname_vendor.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 3 && txtroll_other.Text.Trim() != ""))//&& txt_otherMobile.Text.Trim() != ""
                                                                    {
                                                                        try
                                                                        {

                                                                            bool imgdivVisible = false;
                                                                            bool contentVisible = false;
                                                                            bool CreateReceiptOK = false;

                                                                            FormatXISanAcademyChallanReceipt rcpt = new FormatXISanAcademyChallanReceipt();
                                                                            contentDiv.InnerHtml = rcpt.generateOriginal(receiptno.Trim(), txt_date.Text.Trim(), txt_dept.Text.Trim(), rb_cash, rb_cheque, rb_dd, rb_card,rb_NEFT, collegecode1, usercode, ref lastRecptNo, ref accidRecpt, rbl_rollnoNew, rbl_rollno, appnoNew, outRoll, txtDept_staff, rollno, app_formno, Regno, studname, grid_Details, BalanceType, dtMulBnkDetails, chk_rcptMulmode, modeMulti, checkDDno, newbankname, branch, txt_date1, txt_remark, ref  contentVisible, ref  CreateReceiptOK, ref  imgdivVisible, ref  lbl_alert, cb_CautionDep, cb_govt, cb_exfees, mode, txt_ddno, ddl_bkname, txt_chqno, dsPri);
                                                                            imgAlert.Visible = imgdivVisible;

                                                                            if (CreateReceiptOK)
                                                                            {
                                                                                //Response.Write("<script>window.open('PrintPage.aspx?name=" + szFile + "', '_blank');</script>");
                                                                                contentDiv.Visible = true;
                                                                                ScriptManager.RegisterStartupScript(this, GetType(), "InvokeButton", "PrintDiv();", true);
                                                                            }

                                                                        }
                                                                        catch { imgAlert.Visible = true; }
                                                                    }
                                                                    else
                                                                    {
                                                                        imgAlert.Visible = true;
                                                                        //this.Form.DefaultButton = "btn_alertclose";
                                                                        lbl_alert.Text = "Not Enough Details To Print";
                                                                    }
                                                                    #endregion
                                                                }
                                                                else if (save1 == 12)
                                                                {
                                                                    //KCG Print
                                                                    #region Print Option For Receipt
                                                                    if ((rbl_rollnoNew.SelectedIndex == 0 && txt_rollno.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 1 && txtroll_staff.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 2 && txtname_vendor.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 3 && txtroll_other.Text.Trim() != ""))// && txt_otherMobile.Text.Trim() != ""
                                                                    {
                                                                        //Basic Data
                                                                        //string rollno = txt_rollno.Text.Trim();
                                                                        //  string recptNo = txt_rcptno.Text.Trim();
                                                                        string recptNo = string.Empty;
                                                                        //modified by sudhagar editable receipt no
                                                                        tempRcpt = Convert.ToString(txttemprcpt.Text.Trim());
                                                                        if (!string.IsNullOrEmpty(tempRcpt))
                                                                            recptNo = tempRcpt;
                                                                        else
                                                                            recptNo = txt_rcptno.Text.Trim();
                                                                        string recptDt = txt_date.Text.Trim();
                                                                        //string studname = txt_name.Text.Trim();
                                                                        string course = txt_dept.Text.Trim();
                                                                        string batchYrSem = string.Empty;
                                                                        string acaYear = d2.GetFunction("select LinkValue from New_InsSettings where LinkName='ChallanAcademicYear' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "'");
                                                                        try
                                                                        {
                                                                            acaYear = acaYear.Split(',')[0] + "-" + acaYear.Split(',')[1];
                                                                        }
                                                                        catch { }
                                                                        try
                                                                        {
                                                                            course = course.Split('-')[0];
                                                                        }
                                                                        catch { course = ""; }
                                                                        // string mode = string.Empty;

                                                                        if (rb_cash.Checked)
                                                                        {
                                                                            mode = "Cash";
                                                                        }
                                                                        else if (rb_cheque.Checked)
                                                                        {
                                                                            mode = "Cheque";
                                                                        }
                                                                        else if (rb_dd.Checked)
                                                                        {
                                                                            mode = "DD";
                                                                        }
                                                                        else if (rb_card.Checked)
                                                                        {
                                                                            mode = "Card";
                                                                        }

                                                                        //Fields to print
                                                                        string queryPrint1 = "select * from FM_RcptChlPrintSettings where collegecode ='" + collegecode1 + "'";
                                                                        ds.Clear();
                                                                        ds = d2.select_method_wo_parameter(queryPrint1, "Text");
                                                                        if (ds.Tables.Count > 0)
                                                                        {
                                                                            if (ds.Tables[0].Rows.Count > 0)
                                                                            {

                                                                                //Footer Div Values
                                                                                byte degACR = Convert.ToByte(dsPri.Tables[0].Rows[0]["IsDegreeAcr"]);
                                                                                byte studCopy = Convert.ToByte(ds.Tables[0].Rows[0]["IsStudCopy"]);
                                                                                byte officopy = Convert.ToByte(ds.Tables[0].Rows[0]["IsOfficeCopy"]);
                                                                                byte transCopy = Convert.ToByte(ds.Tables[0].Rows[0]["IsTransportCopy"]);

                                                                                //Document Settings
                                                                                contentDiv.InnerHtml = "";
                                                                                StringBuilder sbHtml = new StringBuilder();

                                                                                string colquery = "select collname,university,address1 ,address2,address3+' - '+pincode as address3 from collinfo where college_code=" + collegecode1 + " ";
                                                                                if (rbl_rollnoNew.SelectedIndex == 0)
                                                                                {
                                                                                    if (Convert.ToUInt32(rbl_rollno.SelectedItem.Value) == 3)
                                                                                    {
                                                                                        colquery += " select a.Current_Semester,a.Degree_code,(c.Course_Name +' - '+ dt.Dept_Name) as department, (c.Course_Name +' - '+ dt.dept_acronym) as dept_acronym,a.Batch_Year,(select TextVal  from TextValTable where TextCode = a.seattype) as seattype ,'' Boarding,a.mother,a.parent_name,ISNULL( type,'') as type,'' Sections  from applyn a,Degree d,Department dt,Course c where a.degree_code =d.Degree_Code and d.Dept_Code =dt.Dept_Code and c.Course_Id =d.Course_Id and a.App_No='" + appnoNew + "' and d.college_code=" + collegecode1 + "";
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        colquery += " select r.Current_Semester,r.Degree_code,(c.Course_Name +' - '+ dt.Dept_Name) as department, (c.Course_Name +' - '+ dt.dept_acronym) as dept_acronym,r.Batch_Year,(select TextVal  from TextValTable where TextCode = a.seattype) as seattype ,r.Boarding,a.mother,a.parent_name,isnull(r.Sections,'') as Sections from Registration r, applyn a,Degree d,Department dt,Course c where a.app_no=r.App_No and r.degree_code =d.Degree_Code and d.Dept_Code =dt.Dept_Code and c.Course_Id =d.Course_Id and r.App_No='" + appnoNew + "' and r.college_code=" + collegecode1 + " ";
                                                                                    }
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                {
                                                                                    colquery += "  select appl_id ,h.dept_name,h.dept_acronym,h.dept_code,s.staff_name,s.staff_code,a.father_name,t.stftype as staff_type  from staffmaster s,staff_appl_master a,hrdept_master h,stafftrans t,desig_master d where s.appl_no =a.appl_no and s.staff_code =t.staff_code and t.dept_code =h.dept_code and d.desig_code =t.desig_code and s.college_code =h.college_code and d.collegeCode =s.college_code and latestrec ='1' and appl_id ='" + appnoNew + "' and s.college_Code=" + collegecode1 + "  ";
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 2)
                                                                                {
                                                                                    colquery += " SELECT VendorContactPK, VenContactType, VenContactName, VenContactDesig, VenContactDept, VendorPhoneNo, VendorExtNo, VendorMobileNo, VendorEmail, VendorFK FROM      IM_VendorContactMaster WHERE VendorContactPK = '" + appnoNew + "' ";
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 3)
                                                                                {
                                                                                    colquery += " SELECT VendorCode,vendorname,VendorMobileNo,VendorAddress,VendorCity,VendorCompName,VendorType  from co_vendormaster  WHERE VendorPK = '" + appnoNew + "' ";
                                                                                    outRoll = string.Empty;
                                                                                }
                                                                                string collegename = "";
                                                                                string add1 = "";
                                                                                string add2 = "";
                                                                                string add3 = "";
                                                                                string univ = "";
                                                                                string deg = "";
                                                                                string degAcr = "";
                                                                                string cursem = "";
                                                                                string batyr = "";
                                                                                string seatty = "";
                                                                                string board = "";
                                                                                string mothe = "";
                                                                                string fathe = "";
                                                                                double deductionamt = 0;
                                                                                ds.Clear();
                                                                                ds = d2.select_method_wo_parameter(colquery, "Text");
                                                                                if (ds.Tables.Count > 0)
                                                                                {
                                                                                    if (ds.Tables[0].Rows.Count > 0)
                                                                                    {
                                                                                        collegename = Convert.ToString(ds.Tables[0].Rows[0]["collname"]);
                                                                                        add1 = Convert.ToString(ds.Tables[0].Rows[0]["address1"]);
                                                                                        add2 = Convert.ToString(ds.Tables[0].Rows[0]["address2"]);
                                                                                        add3 = Convert.ToString(ds.Tables[0].Rows[0]["address3"]);

                                                                                        univ = Convert.ToString(ds.Tables[0].Rows[0]["university"]);
                                                                                    }
                                                                                    if (ds.Tables[1].Rows.Count > 0)
                                                                                    {
                                                                                        if (rbl_rollnoNew.SelectedIndex == 0)
                                                                                        {
                                                                                            //if (degACR == 0)
                                                                                            //{
                                                                                            deg = Convert.ToString(ds.Tables[1].Rows[0]["department"]);
                                                                                            //}
                                                                                            //else
                                                                                            //{
                                                                                            degAcr = Convert.ToString(ds.Tables[1].Rows[0]["dept_acronym"]);
                                                                                            //}
                                                                                            cursem = Convert.ToString(ds.Tables[1].Rows[0]["Current_Semester"]);
                                                                                            batyr = Convert.ToString(ds.Tables[1].Rows[0]["Batch_Year"]);
                                                                                            seatty = Convert.ToString(ds.Tables[1].Rows[0]["seattype"]);
                                                                                            board = Convert.ToString(ds.Tables[1].Rows[0]["Boarding"]);
                                                                                            mothe = Convert.ToString(ds.Tables[1].Rows[0]["mother"]);
                                                                                            fathe = Convert.ToString(ds.Tables[1].Rows[0]["parent_name"]);
                                                                                            //sec = " " + Convert.ToString(ds.Tables[1].Rows[0]["Sections"]);
                                                                                        }
                                                                                        else if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                        {
                                                                                            //if (degACR == 0)
                                                                                            //{
                                                                                            deg = Convert.ToString(ds.Tables[1].Rows[0]["dept_name"]);
                                                                                            //}
                                                                                            //else
                                                                                            //{
                                                                                            degAcr = Convert.ToString(ds.Tables[1].Rows[0]["dept_acronym"]);
                                                                                            //}
                                                                                            //cursem = Convert.ToString(ds.Tables[1].Rows[0]["Current_Semester"]);
                                                                                            //batyr = Convert.ToString(ds.Tables[1].Rows[0]["Batch_Year"]);
                                                                                            seatty = Convert.ToString(ds.Tables[1].Rows[0]["staff_type"]);
                                                                                            //board = Convert.ToString(ds.Tables[1].Rows[0]["Boarding"]);
                                                                                            //mothe = Convert.ToString(ds.Tables[1].Rows[0]["mother"]);
                                                                                            fathe = Convert.ToString(ds.Tables[1].Rows[0]["father_name"]);
                                                                                            //sec = " " + Convert.ToString(ds.Tables[1].Rows[0]["Sections"]);
                                                                                        }
                                                                                        else if (rbl_rollnoNew.SelectedIndex == 2)
                                                                                        {
                                                                                            deg = " - ";
                                                                                        }
                                                                                        else if (rbl_rollnoNew.SelectedIndex == 3)
                                                                                        {
                                                                                            deg = " - ";
                                                                                        }
                                                                                    }

                                                                                    if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                    {
                                                                                        course = txtDept_staff.Text.Trim();
                                                                                    }
                                                                                }
                                                                                string degString = string.Empty;
                                                                                //Line3
                                                                                if (rbl_rollnoNew.SelectedIndex == 0)
                                                                                {
                                                                                    degString = deg.Split('-')[0].ToUpper();
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                {
                                                                                    degString = deg;
                                                                                }


                                                                                string deptstring = string.Empty;
                                                                                if (rbl_rollnoNew.SelectedIndex == 0)
                                                                                {
                                                                                    deptstring = deg.Split('-')[1].ToUpper();
                                                                                }
                                                                                else if (rbl_rollnoNew.SelectedIndex == 1)
                                                                                {
                                                                                    try
                                                                                    {
                                                                                        deptstring = deg.Split('-')[1].ToUpper();
                                                                                    }
                                                                                    catch { }
                                                                                }
                                                                                #region multimode
                                                                                string ddnar = string.Empty;
                                                                                if (chk_rcptMulmode.Checked)
                                                                                {
                                                                                    mode = modeMulti;
                                                                                    for (int z = 0; z < dtMulBnkDetails.Rows.Count; z++)
                                                                                    {
                                                                                        ddnar += "\nNo : " + dtMulBnkDetails.Rows[z][1] + " Bank : " + dtMulBnkDetails.Rows[z][0] + "\nBranch :" + dtMulBnkDetails.Rows[z][2] + " Date  : " + dtMulBnkDetails.Rows[z][3] + " Amount : " + dtMulBnkDetails.Rows[z][4] + "/-";
                                                                                    }
                                                                                }
                                                                                else
                                                                                {
                                                                                    if (!rb_cash.Checked)
                                                                                    {
                                                                                        if (rb_dd.Checked == true)
                                                                                        {
                                                                                            ddnar = "\nDDNo : " + checkDDno + " Bank : " + newbankname + "\nBranch :" + branch + " Date  : " + txt_date1.Text.ToString();
                                                                                        }
                                                                                        else if (rb_cheque.Checked)
                                                                                        {
                                                                                            ddnar = "\nChequeNo : " + checkDDno + " Bank : " + newbankname + "\nBranch :" + branch + " Date  : " + txt_date1.Text.ToString();
                                                                                        }
                                                                                        else if (rb_card.Checked)
                                                                                        {
                                                                                            ddnar = "\nCard : " + newbankname;
                                                                                        }
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        ddnar = "\nCash ";
                                                                                    }
                                                                                }
                                                                                string remark= "\n" + txt_remark.Text.Trim();
                                                                                #endregion

                                                                                if (save1 == 12)
                                                                                {
                                                                                    //For kcg 11/07                                                                                                                                                
                                                                                    FormatXIIKcgChallanReceipt rcpt = new FormatXIIKcgChallanReceipt();
                                                                                    contentDiv.InnerHtml = rcpt.kcgprint(appnoNew, outRoll, collegecode1, usercode, Convert.ToByte(rcptType), studname, recptDt, DateTime.Now.ToLongTimeString(), recptNo, cursem, degAcr.Split('-')[0].ToUpper(), deptstring, ddnar,remark, grid_Details, cb_exfees, cb_govt, cb_CautionDep, collegecode, usercode, txt_examt).ToString();

                                                                                }
                                                                                #region New Print
                                                                                //contentDiv.InnerHtml += sbHtml.ToString();
                                                                                contentDiv.Visible = true;
                                                                                ScriptManager.RegisterStartupScript(this, GetType(), "InvokeButton", "PrintDiv();", true);
                                                                                #endregion
                                                                            }
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        imgAlert.Visible = true;
                                                                        //this.Form.DefaultButton = "btn_alertclose";
                                                                        lbl_alert.Text = "Not Enough Details To Print";
                                                                    }
                                                                    #endregion
                                                                }
                                                                else if (save1 == 13)
                                                                {
                                                                    //VELAMMAL VIDYALAYA
                                                                    #region Print Option For Receipt
                                                                    if ((rbl_rollnoNew.SelectedIndex == 0 && txt_rollno.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 1 && txtroll_staff.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 2 && txtname_vendor.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 3 && txtroll_other.Text.Trim() != ""))// && txt_otherMobile.Text.Trim() != ""
                                                                    {
                                                                        contentDiv.InnerHtml = "";
                                                                        try
                                                                        {

                                                                            bool imgdivVisible = false;
                                                                            bool contentVisible = false;
                                                                            bool CreateReceiptOK = false;

                                                                            FormatXIIIVelammalSchoolReceiptChallanMiscellaneous rcpt = new FormatXIIIVelammalSchoolReceiptChallanMiscellaneous();

                                                                            contentDiv.InnerHtml = rcpt.generateOriginal(receiptno.Trim(), txt_date.Text.Trim(), txt_dept.Text.Trim(), rb_cash, rb_cheque, rb_dd, rb_card, collegecode1, usercode, ref lastRecptNo, ref accidRecpt, rbl_rollnoNew, rbl_rollno, appnoNew, outRoll, txtDept_staff, rollno, app_formno, Regno, studname, grid_Details, BalanceType, dtMulBnkDetails, chk_rcptMulmode, modeMulti, checkDDno, newbankname, branch, txt_date1, txt_remark, ref  contentVisible, ref  CreateReceiptOK, ref  imgdivVisible, ref  lbl_alert, new CheckBox(), new CheckBox(), new CheckBox(), mode, txt_ddno, ddl_bkname, txt_chqno, dsPri, Roll_admit, section, batch_year);
                                                                            imgAlert.Visible = imgdivVisible;

                                                                            if (CreateReceiptOK)
                                                                            {
                                                                                //Response.Write("<script>window.open('PrintPage.aspx?name=" + szFile + "', '_blank');</script>");
                                                                                contentDiv.Visible = true;
                                                                                ScriptManager.RegisterStartupScript(this, GetType(), "InvokeButton", "PrintDiv();", true);
                                                                            }

                                                                        }
                                                                        catch { imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;"); }
                                                                    }
                                                                    else
                                                                    {
                                                                        imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                                                                        //this.Form.DefaultButton = "btn_alertclose";
                                                                        lbl_alert.Text = "Not Enough Details To Print";
                                                                    }
                                                                    #endregion
                                                                }
                                                                else if (save1 == 14)
                                                                {
                                                                    //Pavai College and School
                                                                    #region Print Option For Receipt
                                                                    if ((rbl_rollnoNew.SelectedIndex == 0 && txt_rollno.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 1 && txtroll_staff.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 2 && txtname_vendor.Text.Trim() != "") || (rbl_rollnoNew.SelectedIndex == 3 && txtroll_other.Text.Trim() != ""))// && txt_otherMobile.Text.Trim() != ""
                                                                    {
                                                                        contentDiv.InnerHtml = "";
                                                                        try
                                                                        {

                                                                            bool imgdivVisible = false;
                                                                            bool contentVisible = false;
                                                                            bool CreateReceiptOK = false;

                                                                            FormatIVPavaiChallanReceipt rcpt = new FormatIVPavaiChallanReceipt();
                                                                            contentDiv.InnerHtml = rcpt.generateOriginal(receiptno.Trim(), txt_date.Text.Trim(), txt_dept.Text.Trim(), rb_cash, rb_cheque, rb_dd, rb_card, rb_NEFT, rb_Challan, collegecode1, usercode, ref lastRecptNo, ref accidRecpt, rbl_rollnoNew, rbl_rollno, appnoNew, outRoll, txtDept_staff, rollno, app_formno, Regno, studname, grid_Details, BalanceType, dtMulBnkDetails, chk_rcptMulmode, modeMulti, checkDDno, newbankname, branch, txt_date1, txt_remark, ref  contentVisible, ref  CreateReceiptOK, ref  imgdivVisible, ref  lbl_alert, cb_CautionDep, cb_govt, cb_exfees, mode, txt_ddno, ddl_bkname, txt_chqno, dsPri, Roll_admit, section, batch_year);
                                                                            imgAlert.Visible = imgdivVisible;

                                                                            if (CreateReceiptOK)
                                                                            {
                                                                                //Response.Write("<script>window.open('PrintPage.aspx?name=" + szFile + "', '_blank');</script>");
                                                                                contentDiv.Visible = true;
                                                                                ScriptManager.RegisterStartupScript(this, GetType(), "InvokeButton", "PrintDiv();", true);
                                                                            }

                                                                        }
                                                                        catch { imgAlert.Visible = true; }
                                                                    }
                                                                    else
                                                                    {
                                                                        imgAlert.Visible = true;
                                                                        //this.Form.DefaultButton = "btn_alertclose";
                                                                        lbl_alert.Text = "Not Enough Details To Print";
                                                                    }
                                                                    #endregion
                                                                }
                                                            }
                                                            catch (Exception ex) { d2.sendErrorMail(ex, collegecode1, "ChallanReceipt"); }

                                                            finally
                                                            {
                                                                //After save process
                                                                bank();
                                                                cardType();
                                                                txtLast4No.Text = "";
                                                                txtCardType.Text = "";
                                                                accidRecpt = string.Empty;
                                                                lastRecptNo = string.Empty;
                                                                txt_rcptno.Text = generateReceiptNo();
                                                                if (rbl_rollnoNew.SelectedIndex == 0)
                                                                {
                                                                    loadGridStudent();
                                                                }
                                                                else if (rbl_rollnoNew.SelectedIndex == 1)
                                                                {
                                                                    loadGridStaff();
                                                                }
                                                                else if (rbl_rollnoNew.SelectedIndex == 2)
                                                                {
                                                                    loadGridVendor();
                                                                }
                                                                else if (rbl_rollnoNew.SelectedIndex == 3)
                                                                {
                                                                    loadGridOthers();
                                                                }
                                                                txt_return.Text = "";
                                                                txttemprcpt.Text = "";
                                                                // lblstaticrollno.Text = "";
                                                                string feecat = Convert.ToString(Session["feecode"]);
                                                                Clear();
                                                                getCollectionamount();
                                                                imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                                                                //this.Form.DefaultButton = "btn_alertclose";
                                                                lbl_alert.Text = "Saved Successfully";

                                                            }
                                                        }
                                                    }
                                                    else
                                                    {
                                                        imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                                                        //this.Form.DefaultButton = "btn_alertclose";
                                                        lbl_alert.Text = "Not Saved.";
                                                    }

                                                    //After save process
                                                    bank();
                                                    cardType();
                                                    accidRecpt = string.Empty;
                                                    lastRecptNo = string.Empty;
                                                    // txt_examt.Text = "0.00";
                                                    txt_rcptno.Text = generateReceiptNo();

                                                    txt_return.Text = "";
                                                    txt_chqno.Text = "";
                                                    txt_branch.Text = "";
                                                    txt_remark.Text = "";
                                                    txtCardType.Text = "";
                                                    txtLast4No.Text = "";
                                                    // lblstaticrollno.Text = "";
                                                }
                                                else
                                                {
                                                    imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                                                    //this.Form.DefaultButton = "btn_alertclose";
                                                    lbl_alert.Text = "Please Enter All Bank Fields";
                                                    if (rb_card.Checked)
                                                    {
                                                        lbl_alert.Text = "Please Enter Card Details";
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                                                //this.Form.DefaultButton = "btn_alertclose";
                                                lbl_alert.Text = "Please Enter All Fields";
                                            }
                                        }
                                        else
                                        {
                                            //Invalid ReceiptNo
                                            imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                                            //this.Form.DefaultButton = "btn_alertclose";
                                            lbl_alert.Text = "Invalid Receipt Number";
                                        }
                                    }
                                    catch (Exception ex) { d2.sendErrorMail(ex, collegecode1, "ChallanReceipt"); }
                                }
                                else
                                {
                                    imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                                    //this.Form.DefaultButton = "btn_alertclose";
                                    lbl_alert.Text = "Please Add Print Settings";
                                }
                            }
                            else
                            {
                                imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                                //this.Form.DefaultButton = "btn_alertclose";
                                lbl_alert.Text = "Please Add Print Settings";
                            }
                        }
                    }
                    else
                    {
                        imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                        //this.Form.DefaultButton = "btn_alertclose";
                        lbl_alert.Text = "Please Pay Fine Amount";
                    }
                    #endregion
                }
            }
            else
            {
                imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                //this.Form.DefaultButton = "btn_alertclose";
                lbl_alert.Text = "Fees Not Alloted!";
            }
        }
        selectheader();
        ScriptManager.RegisterStartupScript(this, GetType(), "InvokeButton", "HideLoadingDiv();", true);
    }

    protected bool getPaidDetails(string dtrcpt, string time, string receiptno, string memtype, string appnoNew, string ledgerfk, string headerfk, string feecat, string credit, double paidAmt, string PayMode, string checkDDno, string dtchkdd, string newbankcode, string branch, string TransType, string IsInstallmentPay, string InstallmentNo, string remark, string PayAt, string PayThrough, string IsArrearCollect, string ArearFinYearFK, string usercode, string finYearid, string rcptType, string iscollected, string collecteddate, string iscollecteds, string collecteddates, string isFine, string actualFinYearFk, double schoolORclg, string isHeaderwise, string lastRecptNo, string collegecode, string rcptUpdate, string hdrSetPK, double exgridamt, double schlamt, ref bool boolAdvanceAmt)
    {
        bool InsertUpdateOK = false;
        try
        {
            int queryAct = 1;
            int val = Convert.ToInt32(schoolORclg);
            Hashtable htPaidInsert = new Hashtable();
            htPaidInsert.Add("@CollegeOrSchool", Convert.ToString(val));
            htPaidInsert.Add("@Transdate", dtrcpt);
            htPaidInsert.Add("@Transtime", time);
            htPaidInsert.Add("@Transcode", receiptno);
            htPaidInsert.Add("@Memtype", memtype);
            htPaidInsert.Add("@App_no", appnoNew);
            htPaidInsert.Add("@Ledgerfk", ledgerfk);
            htPaidInsert.Add("@Headerfk", headerfk);
            htPaidInsert.Add("@Feecategory", feecat);
            htPaidInsert.Add("@Credit", credit);
            htPaidInsert.Add("@Debit", paidAmt);
            htPaidInsert.Add("@Paymode", PayMode);
            htPaidInsert.Add("@Ddno", checkDDno);
            htPaidInsert.Add("@Dddate", dtchkdd);
            htPaidInsert.Add("@DdBankCode", newbankcode = newbankcode == "" ? "0" : newbankcode);
            htPaidInsert.Add("@DDBankBranch", branch);
            htPaidInsert.Add("@TransType", TransType);
            htPaidInsert.Add("@IsInstallmentPay", IsInstallmentPay);
            htPaidInsert.Add("@InstallmentNo", InstallmentNo);
            htPaidInsert.Add("@Narration", remark);
            htPaidInsert.Add("@PayAt", PayAt);
            htPaidInsert.Add("@PayThrough", PayThrough);
            htPaidInsert.Add("@IsArrearCollect", IsArrearCollect);
            htPaidInsert.Add("@ArearFinYearFK", ArearFinYearFK);
            htPaidInsert.Add("@EntryUserCode", usercode);
            htPaidInsert.Add("@FinYearFK", finYearid);
            htPaidInsert.Add("@Receipttype", rcptType);
            htPaidInsert.Add("@IsCollected", iscollected);
            htPaidInsert.Add("@CollectedDate", collecteddate);
            htPaidInsert.Add("@IsDeposited", iscollecteds);
            htPaidInsert.Add("@DepositedDate", collecteddates);
            htPaidInsert.Add("@FineFeecategory", isFine = isFine == "" || isFine == null ? "0" : isFine);
            htPaidInsert.Add("@ActualFinYearFK", actualFinYearFk);
            //  htPaidInsert.Add("@AlotBalAmt", "0");


            htPaidInsert.Add("@isHeaderwise", isHeaderwise);
            htPaidInsert.Add("@lastRecptNo", lastRecptNo);
            htPaidInsert.Add("@collegecode", collegecode);
            htPaidInsert.Add("@hdrSetPK", hdrSetPK);
            htPaidInsert.Add("@queryAction", queryAct);
            htPaidInsert.Add("@ReceiptUpdateStatus", rcptUpdate);

            int insert = d2.insert_method("USP_RECEIPT_SAVE", htPaidInsert, "sp");
            if (insert > 0)
                InsertUpdateOK = true;
            double tobePaid = 0;
            double.TryParse(Convert.ToString(Txt_amt.Text.Trim()), out tobePaid);
            if (insert > 0 && cbAdvance.Checked && tobePaid != 0 && !boolAdvanceAmt)//advance setting available only
            {
                allotAdvanceAmt(appnoNew, feecat, Txt_amt.Text, finYearid, dtrcpt, receiptno);

                boolAdvanceAmt = true;
            }

            if (insert > 0 && !cbAdvance.Checked)
            {
                htPaidInsert.Remove("@queryAction");
                htPaidInsert.Add("@queryAction", "2");
                DataSet dsPrevAMount = d2.select_method("USP_RECEIPT_SAVE", htPaidInsert, "sp");
                if (dsPrevAMount.Tables.Count > 0 && dsPrevAMount.Tables[0].Rows.Count > 0)
                {
                    double total = 0;
                    double paidamt = 0;
                    double balamt = 0;
                    total = Convert.ToDouble(dsPrevAMount.Tables[0].Rows[0]["TotalAmount"]);
                    if (total > 0)
                    {
                        paidamt = Convert.ToDouble(dsPrevAMount.Tables[0].Rows[0]["PaidAmount"]);
                        balamt = Convert.ToDouble(dsPrevAMount.Tables[0].Rows[0]["BalAmount"]);

                        balamt = (total - paidamt);
                        htPaidInsert.Remove("@queryAction");
                        htPaidInsert.Add("@queryAction", "3");
                        double curPaid = (paidAmt + exgridamt);
                        htPaidInsert.Add("@UpdateAmt", curPaid);
                        double curBal = (balamt - (paidAmt + exgridamt));
                        htPaidInsert.Add("@AlotBalAmt", curBal);
                        htPaidInsert.Add("@ScholarAmt", schlamt);
                        int upda = d2.update_method_with_parameter("USP_RECEIPT_SAVE", htPaidInsert, "sp");
                        InsertUpdateOK = true;
                    }
                }
            }
        }
        catch { }
        return InsertUpdateOK;
    }

    //added by sudhagar 08.02.2017
    private double checkSchoolSetting()
    {
        double getVal = 0;
        double.TryParse(Convert.ToString(d2.GetFunction("select  value from Master_Settings where settings='schoolorcollege' and usercode='" + usercode + "'")), out getVal);
        return getVal;
    }
    protected void selectheader()
    {
        for (int i = 0; i < cbl_grpheader.Items.Count; i++)
        {
            cbl_grpheader.Items[i].Selected = true;
        }
        cb_selectHeadAll.Checked = true;
        if (rbl_headerselect.SelectedIndex == 0)
            txt_grpheader.Text = "Group Header(" + cbl_grpheader.Items.Count + ")";
        else if (rbl_headerselect.SelectedIndex == 1)
            txt_grpheader.Text = "Header(" + cbl_grpheader.Items.Count + ")";
        else if (rbl_headerselect.SelectedIndex == 2)
            txt_grpheader.Text = "Ledger(" + cbl_grpheader.Items.Count + ")";
    }
    private double retBalance(string appNo)
    {
        double ovBalAMt = 0;
        if (BalanceType == 1)
        {
            double.TryParse(d2.GetFunction(" select sum(isnull(totalAmount,0)-isnull(paidAmount,0)) as BalanceAmt from ft_feeallot where app_no =" + appNo + ""), out ovBalAMt);
        }
        return ovBalAMt;
    }
    protected void btn_surenoRcpt_Click(object sender, EventArgs e)
    {
        Div4.Visible = false;
    }
    protected void btn_save_Click(object sender, EventArgs e)
    {
        divSchemeSettings.Attributes.Add("Style", "display:none;");
        imgAlert.Attributes.Add("Style", " display:none;");
        if (chl_MulRcpt.Checked)
        {
            Div4.Visible = true;
            divRecptRpt.Attributes.Add("Style", "display:none;");
        }
        else
        {
            double exvalue = 0;
            double scholamt = 0;
            double cautAmt = 0;
            bool checkedOK = false;
            foreach (GridViewRow row in grid_Details.Rows)
            {
                CheckBox chkOkPay = (CheckBox)row.FindControl("cb_selectLedger");
                if (chkOkPay.Checked)
                    checkedOK = true;
            }
            if (((Txt_amt.Text != "" && Txt_amt.Text != "0" && Txt_amt.Text != "0.00") || exvalue > 0 || scholamt > 0 || cautAmt > 0) && checkedOK)
            {
                if (chk_rcptMulmode.Checked)
                {
                    // divRecptRpt.Visible = true;
                    divRecptRpt.Attributes.Add("Style", " height: 60em; z-index: 1000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top: 15%;left: 0px;display:block;");
                    rblCashChkDd.SelectedIndex = 0;
                    trBankDetailsmd.Attributes.Add("Style", "display:none");
                    trCardDetailsmd.Attributes.Add("Style", "display:none");
                    lbl_mdamt.Text = "Total Amount Rs." + Txt_amt.Text + " /-";
                    string queru = "select TextCode,TextVal  from textvaltable where TextCriteria = 'BName' and college_code='" + collegecode1 + "'; select TextCode,TextVal  from textvaltable where TextCriteria = 'cardT' and college_code='" + collegecode1 + "'";
                    ddlmdBankAdd.Items.Clear();
                    ddlCardTypeMd.Items.Clear();
                    DataSet dsBank = d2.select_method_wo_parameter(queru, "Text");
                    if (dsBank.Tables.Count > 1)
                    {
                        if (dsBank.Tables[0].Rows.Count > 0)
                        {
                            ddlmdBankAdd.DataSource = dsBank;
                            ddlmdBankAdd.DataTextField = "TextVal";
                            ddlmdBankAdd.DataValueField = "TextCode";
                            ddlmdBankAdd.DataBind();
                        }
                        if (dsBank.Tables[1].Rows.Count > 0)
                        {
                            ddlCardTypeMd.DataSource = dsBank.Tables[1];
                            ddlCardTypeMd.DataTextField = "TextVal";
                            ddlCardTypeMd.DataValueField = "TextCode";
                            ddlCardTypeMd.DataBind();
                        }
                    }
                    ddlCardTypeMd.Items.Insert(0, "Select");
                    ddlCardTypeMd.Items.Add("Others");

                    rblCashChkDd.SelectedIndex = 0;
                    txt_mdAddAmtpop.Text = "";
                    txt_mdBranchAdd.Text = "";
                    txt_mdChequeNoAdd.Text = "";
                    if (ddlmdBankAdd.Items.Count > 0)
                    {
                        ddlmdBankAdd.SelectedIndex = 0;
                    }
                    txtCardTypeMd.Text = "";
                    txtLast4NoMd.Text = "";
                    if (ddlCardTypeMd.Items.Count > 0)
                    {
                        ddlCardTypeMd.SelectedIndex = 0;
                    }
                    gridMultimode.DataSource = null;
                    gridMultimode.DataBind();
                    btnyesrcpt.Visible = false;
                    btnCLearrcpt.Visible = false;
                    // rblCashChkDd_OnSelectedIndexChanged(sender, e);
                }
                else
                {
                    Div4.Visible = true;
                    divRecptRpt.Attributes.Add("Style", "display:none;");
                }
            }
            else
            {

                imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                //  imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                lbl_alert.Text = "Please Enter Amount Or Select A Ledger";
            }
        }
    }
    private void challanPrint()
    {

        bool imgdivVisible = false;
        bool contentVisible = false;
        bool CreateReceiptOK = false;

        GeneralAndMCCChallan GMccChallan = new GeneralAndMCCChallan();
        //  string szFile = GMccChallan.printGeneralAndMCCChallan(cb_selcthd, rbl_headerselect, collegecode1, usercode, lastRecptNo, accidRecpt, rdo_multi, ref  txt_rcptno, Fpspread1, txt_totnoofstudents, txt_date, txt_name, ddl_semMultiple, rbl_rollno, ddl_collegebank, ref  lbl_alert, ref imgdivVisible, cbl_grpheader, ref  Txt_amt, grid_Details, ref contentVisible, ref CreateReceiptOK, lblstaticrollno.Text.Trim(), ddl_sem.SelectedValue, lbltype.Text, txt_dept.Text.Trim(), ddl_sem);
        imgAlert.Visible = imgdivVisible;

        if (CreateReceiptOK)
        {
            //Response.Write("<script>window.open('PrintPage.aspx?name=" + szFile + "', '_blank');</script>");
            //contentDiv.Visible = true;
            //ScriptManager.RegisterStartupScript(this, GetType(), "InvokeButton", "PrintDiv();", true);
        }
        try
        {
            Txt_amt.Text = "";
            loadGridStudent();
        }
        catch { }

    }
    private bool showLedgerFees()
    {
        bool showFees = false;
        string Q = "select LinkValue from New_InsSettings where LinkName='ShowLedgerwiseFeesinChallan' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "'";
        if (d2.GetFunction(Q).Trim() == "1")
            showFees = true;
        return showFees;
    }
    private void challanPrintNew()
    {
        bool imgdivVisible = false;
        bool contentVisible = false;
        bool CreateReceiptOK = false;
        contentDiv.InnerHtml = string.Empty;
        GeneralAndNECChallan GncChallan = new GeneralAndNECChallan();
        // contentDiv.InnerHtml = GncChallan.printGeneralAndNECChallan(cb_selcthd, rbl_headerselect, collegecode1, usercode, lastRecptNo, accidRecpt, rdo_multi, ref  txt_rcptno, Fpspread1, txt_totnoofstudents, txt_date, txt_name, ddl_semMultiple, rbl_rollno, ddl_collegebank, ref  lbl_alert, ref imgdivVisible, cbl_grpheader, ref  Txt_amt, grid_Details, ref contentVisible, ref CreateReceiptOK, lblstaticrollno.Text.Trim(), ddl_sem.SelectedValue, lbltype.Text, txt_dept.Text.Trim());
        imgAlert.Visible = imgdivVisible;

        if (CreateReceiptOK)
        {
            contentDiv.Visible = true;
            ScriptManager.RegisterStartupScript(this, GetType(), "InvokeButton", "PrintDiv();", true);
        }
        try
        {
            Txt_amt.Text = "";
            loadGridStudent();
        }
        catch { }
    }
    private void challanPrintNewCollege()
    {
        bool imgdivVisible = false;
        bool contentVisible = false;
        bool CreateReceiptOK = false;
        contentDiv.InnerHtml = string.Empty;
        NewCollegeChallan ncChallan = new NewCollegeChallan();
        //   contentDiv.InnerHtml = ncChallan.printNewCollegeChallan(cb_selcthd, rbl_headerselect, collegecode1, usercode, lastRecptNo, accidRecpt, rdo_multi, ref  txt_rcptno, Fpspread1, txt_totnoofstudents, txt_date, txt_name, ddl_semMultiple, rbl_rollno, ddl_collegebank, ref  lbl_alert, ref imgdivVisible, cbl_grpheader, ref  Txt_amt, grid_Details, ref contentVisible, ref CreateReceiptOK, lblstaticrollno.Text.Trim(), ddl_sem.SelectedValue, lbltype.Text, txt_dept.Text.Trim());
        imgAlert.Visible = imgdivVisible;

        if (CreateReceiptOK)
        {
            contentDiv.Visible = true;
            ScriptManager.RegisterStartupScript(this, GetType(), "InvokeButton", "PrintDiv();", true);
        }
        try
        {
            Txt_amt.Text = "";
            loadGridStudent();
        }
        catch { }
    }
    private void challanPrintUIT()
    {

        bool imgdivVisible = false;
        bool contentVisible = false;
        bool CreateReceiptOK = false;

        UITChallan uitChallan = new UITChallan();
        // string szFile = uitChallan.printUITChallan(cb_selcthd, rbl_headerselect, collegecode1, usercode, lastRecptNo, accidRecpt, rdo_multi, ref  txt_rcptno, Fpspread1, txt_totnoofstudents, txt_date, txt_name, ddl_semMultiple, rbl_rollno, ddl_collegebank, ref  lbl_alert, ref imgdivVisible, cbl_grpheader, ref  Txt_amt, grid_Details, ref contentVisible, ref CreateReceiptOK, lblstaticrollno.Text.Trim(), ddl_sem.SelectedValue, lbltype.Text, txt_dept.Text.Trim(), ddl_sem);
        imgAlert.Visible = imgdivVisible;

        if (CreateReceiptOK)
        {
            // Response.Write("<script>window.open('PrintPage.aspx?name=" + szFile + "', '_blank');</script>");
            //contentDiv.Visible = true;
            //ScriptManager.RegisterStartupScript(this, GetType(), "InvokeButton", "PrintDiv();", true);
        }
        try
        {
            Txt_amt.Text = "";
            loadGridStudent();
        }
        catch { }
    }
    //Staff Division
    protected void txtroll_staff_Changed(object sender, EventArgs e)
    {
        btn_print.Visible = false;
        string staffId = Convert.ToString(txtroll_staff.Text.Trim());
        img_stud.ImageUrl = "";
        img_stud.Visible = false;

        if (staffId != "")
        {
            string name = string.Empty;
            string degree = string.Empty;

            // string query = "select staff_name,appl_no,ISNULL( Stream,'') as type from staffmaster where resign<>1 and college_code="+collegecode1+" and staff_code='" + staffId + "'";

            string query = " select appl_id ,h.dept_name,h.dept_code,s.staff_name,s.staff_code  from staffmaster s,staff_appl_master a,hrdept_master h where s.appl_no =a.appl_no and a.dept_code =h.dept_code and s.staff_code ='" + staffId + "' and s.college_Code=" + collegecode1 + " ";

            ds.Clear();
            ds = d2.select_method_wo_parameter(query, "Text");


            if (ds.Tables.Count > 0)
            {
                if (ds.Tables[0].Rows.Count > 0)
                {
                    for (int i = 0; i < ds.Tables[0].Rows.Count; i++)
                    {
                        name = Convert.ToString(ds.Tables[0].Rows[i]["staff_name"]);
                        degree = Convert.ToString(ds.Tables[0].Rows[i]["dept_name"]);
                        //lbltype.Text = Convert.ToString(ds.Tables[0].Rows[i]["type"]);                            
                    }
                }
            }

            txtname_staff.Text = name;
            txtDept_staff.Text = degree;

            img_stud.ImageUrl = "~/Handler/ghStaffFoto.ashx?QSstaff_id=" + staffId;
            img_stud.Visible = true;

            string featdegCode = string.Empty;
            LoadYearSemester(featdegCode);
            loadGridStaff();
            //  chkGridSelectAll.Checked = true;
            //  ScriptManager.RegisterStartupScript(this, GetType(), "InvokeButton", " SelLedgers();", true);
            divSchemeSettings.Attributes.Add("Style", "display:none;");
            lnkOpenSchemeSettings.Visible = false;
            // gridpaidamount();

        }
        else
        {
            lnkOpenSchemeSettings.Visible = false;
            txt_totamt.Text = "0";
            txt_paidamt.Text = "0";
            txt_balamt.Text = "0";
            Txt_amt.Text = "0";
            img_stud.Visible = false;
            lblstaticrollno.Text = "";

            txtroll_staff.Text = "";
            txtname_staff.Text = "";
            txtDept_staff.Text = "";
            grid_Details.DataSource = null;
            grid_Details.DataBind();
            divgrid.Visible = false;
            cbSem_staff.Checked = false;
            cblSem_staff.Items.Clear();
            txtSem_staff.Text = "";
            img_stud.Visible = false;
        }
    }
    protected void txtname_staff_Changed(object sender, EventArgs e)
    {
        if (txtname_staff.Text.Trim() != "")
        {
            string staffid = Convert.ToString(txtname_staff.Text);

            if (staffid != "")
            {
                try
                {
                    staffid = staffid.Split('-')[1];
                }
                catch { staffid = ""; }
            }
            txtroll_staff.Text = staffid;
            txtroll_staff_Changed(sender, e);
        }
        else
        {
            txt_totamt.Text = "0";
            txt_paidamt.Text = "0";
            txt_balamt.Text = "0";

            img_stud.Visible = false;
            lblstaticrollno.Text = "";

            txtroll_staff.Text = "";
            txtname_staff.Text = "";
            txtDept_staff.Text = "";
            grid_Details.DataSource = null;
            grid_Details.DataBind();
            cbSem_staff.Checked = false;
            cblSem_staff.Items.Clear();
            txtSem_staff.Text = "";
            img_stud.Visible = false;
        }
    }
    protected void cbSem_staff_CheckedChanged(object sender, EventArgs e)
    {
        CallCheckBoxChangedEvent(cblSem_staff, cbSem_staff, txtSem_staff, "Semester/Year");
    }
    protected void cblSem_staff_SelectedIndexChanged(object sender, EventArgs e)
    {
        CallCheckBoxListChangedEvent(cblSem_staff, cbSem_staff, txtSem_staff, "Semester/Year");
    }
    protected void ddlSem_staff_OnSelectedIndexChanged(object sender, EventArgs e)
    {
        loadGridStaff();
    }
    [System.Web.Services.WebMethod]
    [System.Web.Script.Services.ScriptMethod()]
    public static List<string> GetStaffno(string prefixText)
    {
        List<string> name = new List<string>();
        try
        {
            string query = "";
            WebService ws = new WebService();

            //staff query
            query = " select top 100 staff_code from staffmaster where resign<>1 and staff_code like '" + prefixText + "%' and college_code=" + collegecodestat + " order by staff_code asc";


            name = ws.Getname(query);
            return name;
        }
        catch { return name; }
    }
    [System.Web.Services.WebMethod]
    [System.Web.Script.Services.ScriptMethod()]
    public static List<string> GetStaffName(string prefixText)
    {
        WebService ws = new WebService();
        string query = " select top 100 staff_name+'-'+staff_code from staffmaster where resign<>1 and staff_name like '" + prefixText + "%' and college_code=" + collegecodestat + "  order by staff_name asc";
        DataSet dsN = new DataSet();
        List<string> name = new List<string>();
        try
        {
            name = ws.Getname(query);
        }
        catch { }
        return name;
    }
    public void loadGridStaff()
    {
        imgAlert.Attributes.Add("Style", " display:none;");
        loadScholarship("-1");
        fromScript = false;
        try
        {
            txt_rcptno.Text = generateReceiptNo();


            chkGridSelectAll.Checked = false;
            //  }
            lblstaticrollno.Text = "";
            txt_totamt.Text = "0";
            txt_paidamt.Text = "0";
            txt_balamt.Text = "0";
            //    Txt_amt.Text = "0";
            string roll_no = string.Empty;
            string semyear = string.Empty;
            string appnoNew = string.Empty;
            string degcode = string.Empty;
            roll_no = txtroll_staff.Text.Trim();
            string finYearid = d2.getCurrentFinanceYear(usercode, collegecode1);
            DataTable tbl_Student = new DataTable();
            tbl_Student.Columns.Add("Roll_No");
            tbl_Student.Columns.Add("Reg_No");
            tbl_Student.Columns.Add("Stud_Name");
            tbl_Student.Columns.Add("Degree");
            tbl_Student.Columns.Add("TextVal");
            tbl_Student.Columns.Add("TextCode");
            tbl_Student.Columns.Add("Header_ID");
            tbl_Student.Columns.Add("Header_Name");
            tbl_Student.Columns.Add("Fee_Code");
            tbl_Student.Columns.Add("Fee_Type");
            tbl_Student.Columns.Add("Fee_Amount");
            tbl_Student.Columns.Add("Deduct");
            tbl_Student.Columns.Add("Total");
            tbl_Student.Columns.Add("PaidAmt");
            tbl_Student.Columns.Add("BalAmt");
            tbl_Student.Columns.Add("ToBePaid");
            tbl_Student.Columns.Add("Monthly");
            tbl_Student.Columns.Add("ChlTaken");
            tbl_Student.Columns.Add("Scholar");
            tbl_Student.Columns.Add("CautionDep");
            tbl_Student.Columns.Add("MonwiseMon");
            tbl_Student.Columns.Add("MonwiseYear");
            tbl_Student.Columns.Add("FeeallotPk");
            tbl_Student.Columns.Add("finyearfk");
            tbl_Student.Columns.Add("finyear");
            string selectQuery = "";

            string queryRollApp = " select appl_id ,h.dept_name,h.dept_code,s.staff_name,s.staff_code  from staffmaster s,staff_appl_master a,hrdept_master h where s.appl_no =a.appl_no and a.dept_code =h.dept_code and s.staff_code ='" + roll_no + "' and s.college_Code=" + collegecode1 + " ";

            DataSet dsRollApp = new DataSet();
            dsRollApp = d2.select_method_wo_parameter(queryRollApp, "Text");
            if (dsRollApp.Tables.Count > 0)
            {
                if (dsRollApp.Tables[0].Rows.Count > 0)
                {

                    roll_no = Convert.ToString(dsRollApp.Tables[0].Rows[0]["staff_code"]);
                    appnoNew = Convert.ToString(dsRollApp.Tables[0].Rows[0]["appl_id"]);
                    degcode = Convert.ToString(dsRollApp.Tables[0].Rows[0]["dept_code"]);

                    lblstaticrollno.Text = roll_no;

                    img_stud.ImageUrl = "~/Handler/ghStaffFoto.ashx?QSstaff_id=" + roll_no;
                    img_stud.Visible = true;
                }
                else
                {
                    roll_no = "";
                    appnoNew = "";
                    lblstaticrollno.Text = "";
                    img_stud.Visible = false;
                }
            }
            else
            {
                roll_no = "";
                lblstaticrollno.Text = "";
                img_stud.Visible = false;
            }
            string headercode = getCblSelectedValue(cbl_grpheader);
            if (!string.IsNullOrEmpty(appnoNew))
            {
                //selectQuery = " SELECT A.HeaderFK,HeaderName,A.LedgerFK,LedgerName,Priority,isnull(FeeAmount,0) as FeeAmount,isnull(DeductAmout,0)  as DeductAmount,isnull(TotalAmount,0) as TotalAmount,isnull(ChlTaken,0) as ChlTakAmt,isnull(PaidAmount,0) as PaidAmount,isnull(TotalAmount,0)-isnull(PaidAmount,0)  as BalAmount FROM FT_FeeAllot A,FM_HeaderMaster H,FM_LedgerMaster L WHERE A.HeaderFK = H.HeaderPK AND A.LedgerFK = L.LedgerPK AND H.HeaderPK = L.HeaderFK  and l.LedgerMode=0 and MemType=2 AND A.App_No = " + appnoNew + "";// and T.TextCode in('" + semyear + "')
                selectQuery = "  select HeaderpK,HeaderName,LedgerpK,LedgerName,Priority,isnull(FeeAmount,0) as FeeAmount,isnull(DeductAmout,0)  as DeductAmount,isnull(TotalAmount,0) as TotalAmount,isnull(ChlTaken,0) as ChlTakAmt,isnull(PaidAmount,0) as PaidAmount,isnull(TotalAmount,0)-isnull(PaidAmount,0)  as BalAmount from (fm_ledgermaster  inner join (fm_headermaster h inner join FS_HeaderPrivilage hp on h.headerpk=hp.headerfk and hp.usercode='" + usercode + "') on h.headerpk=fm_ledgermaster.headerfk and h.headerpk in('" + headercode + "') ) left join ft_feeallot f   on fm_ledgermaster.ledgerpk=f.ledgerfk  and h.headerpk=f.headerfk and fm_ledgermaster.ledgermode='0'  and fm_ledgermaster.headerfk=hp.headerfk and hp.headerfk=f.headerfk  and f.HeaderFK in ('" + headercode + "') and MemType=2 AND f.App_No = " + appnoNew + " and finyearfk in('" + finYearid + "') and isnull(BalAmount,0)>0";
                string chlnTakenQ = " select Count(distinct(ChallanNo)) from FT_ChallanDet where App_No=" + appnoNew + "";// and FeeCategory in ('" + semyear + "')

                if (cb_selcthd.Checked)
                {


                    if (rbl_headerselect.SelectedIndex == 0)
                    {
                        headercode = GetSelectedItemsValueAsString(cbl_grpheader);

                        //Group Header
                        selectQuery = " SELECT A.HeaderFK,HeaderName,A.LedgerFK,Priority,LedgerName,isnull(FeeAmount,0) as FeeAmount,isnull(DeductAmout,0)   as DeductAmount ,isnull(TotalAmount,0) as TotalAmount,isnull(ChlTaken,0) as ChlTakAmt,isnull(PaidAmount,0) as PaidAmount,isnull(TotalAmount,0)-isnull(PaidAmount,0)  as BalAmount,ChlGroupHeader FROM FT_FeeAllot A,FM_HeaderMaster H,FS_ChlGroupHeaderSettings S, FM_LedgerMaster L WHERE A.HeaderFK = H.HeaderPK and a.headerfk = s.headerfk and l.headerfk = s.headerfk  AND A.LedgerFK = L.LedgerPK AND H.HeaderPK = L.HeaderFK  and h.headerpk = s.headerfk  and l.LedgerMode=0 and MemType=2   and ChlGroupHeader in('" + headercode + "')  ";//and T.TextCode in('" + semyear + "')
                        if (rdo_receipt.Checked)
                        {
                            selectQuery += " AND A.App_No = " + appnoNew + " ";
                        }

                        if (lbltype.Text != "")
                        {
                            selectQuery += "  and Stream ='" + lbltype.Text.Trim() + "' ";
                        }

                    }
                    else if (rbl_headerselect.SelectedIndex == 1)
                    {
                        //Header
                        // selectQuery += "  and A.HeaderFK in (" + headercode + ") ";
                        // chlnTakenQ += " and headerfk in (" + headercode + ") ";
                    }
                    else
                    {
                        //Ledger
                        selectQuery += "  and A.LedgerFK  in (" + headercode + ")  ";
                        chlnTakenQ += "  and LedgerFK in (" + headercode + ")";
                    }

                }
                if (ShowBalOnly())
                {
                    //selectQuery += " and isnull(BalAmount,0)>0 ";
                }
                selectQuery += "  order by case when priority is null then 1 else 0 end, priority,TotalAmount desc";

                DataSet ds_stud = new DataSet();
                ds_stud.Clear();
                ds_stud = d2.select_method_wo_parameter(selectQuery, "Text");
                if (ds_stud.Tables.Count > 0)
                {
                    if (ds_stud.Tables[0].Rows.Count > 0)
                    {
                        string excessamtQ = d2.GetFunction("select sum(isnull(ExcessAmt,0)-isnull(AdjAmt,0)) as BalanceAmt from FT_ExcessDet WHERE  App_No=" + appnoNew + " ");
                        string excessTypeQ = "select LinkValue from New_InsSettings where LinkName='ExcessFeesType' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "' ";
                        int excessTypeValue = 0;
                        try { excessTypeValue = Convert.ToInt32(Convert.ToString(d2.GetFunction(excessTypeQ))); }
                        catch { }


                        double excessamtValue = 0;
                        double.TryParse(excessamtQ, out excessamtValue);
                        double fineAmount = 0;
                        for (i = 0; i < ds_stud.Tables[0].Rows.Count; i++)
                        {
                            DataRow dr_Student = tbl_Student.NewRow();
                            dr_Student["TextVal"] = "0"; // Convert.ToString(ds_stud.Tables[0].Rows[i]["TextVal"]);
                            dr_Student["TextCode"] = "0"; // Convert.ToString(ds_stud.Tables[0].Rows[i]["TextCode"]);
                            dr_Student["Header_ID"] = Convert.ToString(ds_stud.Tables[0].Rows[i]["HeaderpK"]);
                            dr_Student["Header_Name"] = Convert.ToString(ds_stud.Tables[0].Rows[i]["HeaderName"]);
                            dr_Student["Fee_Code"] = Convert.ToString(ds_stud.Tables[0].Rows[i]["LedgerpK"]);
                            dr_Student["Fee_Type"] = Convert.ToString(ds_stud.Tables[0].Rows[i]["LedgerName"]) + retQuantity(appnoNew, Convert.ToString(ds_stud.Tables[0].Rows[i]["LedgerpK"]), "2", "0");
                            dr_Student["ChlTaken"] = Convert.ToString(ds_stud.Tables[0].Rows[i]["ChlTakAmt"]);

                            //appnoNew = Convert.ToString(ds_stud.Tables[0].Rows[i]["App_No"]);

                            double feeamt = Convert.ToDouble(ds_stud.Tables[0].Rows[i]["FeeAmount"]);
                            double deductamt = Convert.ToDouble(ds_stud.Tables[0].Rows[i]["DeductAmount"]);
                            double totamt = Convert.ToDouble(ds_stud.Tables[0].Rows[i]["TotalAmount"]);
                            double paid = Convert.ToDouble(ds_stud.Tables[0].Rows[i]["PaidAmount"]);
                            double balamt = Convert.ToDouble(ds_stud.Tables[0].Rows[i]["BalAmount"]);
                            double curExcess = 0;
                            dr_Student["ToBePaid"] = "0";
                            dr_Student["Fee_Amount"] = feeamt;
                            dr_Student["Deduct"] = deductamt;
                            dr_Student["Total"] = totamt;
                            dr_Student["PaidAmt"] = paid;
                            dr_Student["BalAmt"] = balamt;
                            dr_Student["finyearfk"] = finYearid;
                            dr_Student["finyear"] = finYearid;
                            tbl_Student.Rows.Add(dr_Student);
                        }
                        #region Fine Adjustment
                        double ovrAllBalAmt = 0;
                        try
                        {
                            for (int bal = 0; bal < tbl_Student.Rows.Count; bal++)
                            {
                                string balAmti = Convert.ToString(tbl_Student.Rows[bal]["BalAmt"]).Trim();
                                if (balAmti != "")
                                    ovrAllBalAmt += Convert.ToDouble(balAmti);
                            }
                        }
                        catch { ovrAllBalAmt = 0; }
                        double FineAmount = 0;
                        double.TryParse(Convert.ToString(txtfine.Text), out FineAmount);
                        if (ovrAllBalAmt > 0 && cbfine.Checked && FineAmount != 0)
                        {
                            string fineLegHedQ = d2.GetFunction(" select Linkvalue from New_InsSettings where LinkName='FineLedgerValue' and user_code ='" + usercode + "' and college_code  in (" + collegecode1 + ")");
                            if (fineLegHedQ != "0" && FineAmount > 0)
                            {
                                string fineHdrId = fineLegHedQ.Split(',')[0];
                                string fineLgrId = fineLegHedQ.Split(',')[1];
                                string fineHdrName = d2.GetFunction(" select headername from fm_headermaster where headerpk=" + fineHdrId + " and CollegeCode=" + collegecode1 + "");
                                string fineLgrName = d2.GetFunction("  select ledgername from fm_ledgermaster where ledgerpk=" + fineLgrId + " and HeaderFK=" + fineHdrId + " and CollegeCode=" + collegecode1 + "");
                                string strFine = Convert.ToString(ddlfinefee.SelectedItem.Value) + "$" + Convert.ToString(FineAmount);
                                DataRow drFine = tbl_Student.NewRow();
                                drFine["Header_ID"] = fineHdrId;
                                drFine["Header_Name"] = fineHdrName;
                                drFine["Fee_Code"] = fineLgrId;
                                drFine["Fee_Type"] = fineLgrName;
                                drFine["ChlTaken"] = "0";
                                drFine["TextVal"] = "FINE";
                                drFine["TextCode"] = strFine;
                                drFine["Fee_Amount"] = Convert.ToString(FineAmount);
                                drFine["Deduct"] = "0";
                                drFine["Total"] = Convert.ToString(FineAmount);
                                drFine["PaidAmt"] = "0";
                                drFine["BalAmt"] = Convert.ToString(FineAmount);
                                drFine["ToBePaid"] = "0";
                                drFine["Monthly"] = "0";
                                drFine["Scholar"] = "0";
                                drFine["CautionDep"] = "0";
                                //tbl_Student.Rows.Add(drFine);
                                tbl_Student.Rows.InsertAt(drFine, 0);
                            }
                        }
                        if (cbfine.Checked)
                        {
                            ddlfinefee.Attributes.Add("Style", "display:block;float: left;");
                            txtfine.Attributes.Add("Style", "display:block;float: left;");
                        }
                        #endregion
                    }
                    if (tbl_Student.Rows.Count > 0)
                    {

                        grid_Details.DataSource = tbl_Student;
                        grid_Details.DataBind();
                        grid_Details.Visible = true;
                        divgrid.Visible = true;
                        lnkOpenSchemeSettings.Visible = false;
                        if (rdo_receipt.Checked)
                        {
                            btn_print.Visible = false;
                        }
                        imgAlert.Attributes.Add("Style", " display:none;");
                        ScriptManager.RegisterStartupScript(this, GetType(), "InvokeButton", " checkfeeamount();", true);
                    }
                    else
                    {
                        grid_Details.DataSource = null;
                        grid_Details.DataBind();
                        grid_Details.Visible = false;
                        divgrid.Visible = false;
                        Txt_amt.Text = "0";
                        lnkOpenSchemeSettings.Visible = false;
                        imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                        lbl_alert.Text = "Please Add Fees";
                        btn_print.Visible = false;
                    }
                }
                else
                {
                    grid_Details.DataSource = null;
                    grid_Details.DataBind();
                    grid_Details.Visible = false;
                    divgrid.Visible = false;
                    lnkOpenSchemeSettings.Visible = false;
                    Txt_amt.Text = "0";
                    imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                    lbl_alert.Text = "Please Add Fees";
                    btn_print.Visible = false;
                }
                Session["appNo"] = appnoNew;
            }
            else
            {
                divgrid.Visible = false;
                lnkOpenSchemeSettings.Visible = false;
                imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                lbl_alert.Text = "No Records Found";
            }

        }
        catch (Exception ex)
        {
            // d2.sendErrorMail(ex, collegecode1, "ChallanReceipt");
            grid_Details.DataSource = null;
            grid_Details.DataBind();
            grid_Details.Visible = false;
            // imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
            // lbl_alert.Text = "No Records Found";
            btn_print.Visible = false;
            Session["appNo"] = "";
        }
    }
    protected void btnGO_staff_Click(object sender, EventArgs e)
    {
        try
        {
            if (rdo_receipt.Checked)
            {
                double partamt = 0;
                if (Txt_amt.Text.Trim() != "")
                {
                    partamt = Convert.ToDouble(Txt_amt.Text.Trim());
                    excessAmt = Convert.ToDouble(Txt_amt.Text.Trim());
                }
                loadGridStaff();
            }
        }
        catch (Exception ex) { d2.sendErrorMail(ex, collegecode1, "ChallanReceipt"); }
    }
    //Lookup Staff
    protected void btn_staffLook_Click(object sender, EventArgs e)
    {
        div_staffLook.Visible = true;
        ddlsearch1_OnSelectedIndexChanged(sender, e);
        btn_staffOK.Visible = false;
        btn_exitstaff.Visible = false;
        Fpspread2.Visible = false;
        lbl_errormsgstaff.Visible = false;
    }
    protected void btn_staffOK_Click(object sender, EventArgs e)
    {
        try
        {

            string actrow = "";
            string actcol = "";
            actrow = Fpspread2.ActiveSheetView.ActiveRow.ToString();
            actcol = Fpspread2.ActiveSheetView.ActiveColumn.ToString();
            if (actrow.Trim() != "" && actrow.Trim() != "-1")
            {
                string staff = Convert.ToString(Fpspread2.Sheets[0].Cells[Convert.ToInt32(actrow), 2].Text);
                string appno = Convert.ToString(Fpspread2.Sheets[0].Cells[Convert.ToInt32(actrow), 1].Tag);
                string staffcode = Convert.ToString(Fpspread2.Sheets[0].Cells[Convert.ToInt32(actrow), 1].Text);
                txtroll_staff.Text = staffcode;
                txtroll_staff_Changed(sender, e);

            }
            div_staffLook.Visible = false;
        }
        catch (Exception ex) { d2.sendErrorMail(ex, collegecode1, "ChallanReceipt"); }
    }
    protected void btn_exitstaff_Click(object sender, EventArgs e)
    {
        div_staffLook.Visible = false;
    }
    protected void ddlsearch1_OnSelectedIndexChanged(object sender, EventArgs e)
    {
        txtsearch1.Text = "";
        txtsearch1c.Text = "";
        txtsearch1c.Visible = false;
        txtsearch1.Visible = false;
        if (ddlsearch1.SelectedIndex == 0)
        {
            txtsearch1.Visible = true;
            Label1.Text = "Search By Name";
        }
        else
        {
            txtsearch1c.Visible = true;
            Label1.Text = "Search By Code";
        }
    }
    protected void Fpspread2staff_Command(object sender, FarPoint.Web.Spread.SpreadCommandEventArgs e)
    {
        try
        {
            string actrow = Fpspread1.Sheets[0].ActiveRow.ToString();
            string actcol = Fpspread1.Sheets[0].ActiveColumn.ToString();
            if (actrow.Trim() == "0" && actcol.Trim() == "1")
            {
                if (Fpspread1.Sheets[0].RowCount > 0)
                {
                    int checkval = Convert.ToInt32(Fpspread1.Sheets[0].Cells[0, 1].Value);
                    if (checkval == 0)
                    {
                        for (int i = 1; i < Fpspread1.Sheets[0].RowCount; i++)
                        {
                            Fpspread1.Sheets[0].Cells[i, 1].Value = 1;
                        }
                    }
                    if (checkval == 1)
                    {
                        for (int i = 1; i < Fpspread1.Sheets[0].RowCount; i++)
                        {
                            Fpspread1.Sheets[0].Cells[i, 1].Value = 0;
                        }
                    }
                }
            }
        }
        catch (Exception ex) { d2.sendErrorMail(ex, collegecode1, "ChallanReceipt"); }
    }
    protected void btn_go2Staff_Click(object sender, EventArgs e)
    {
        try
        {
            div_staffLook.Visible = true;
            if (collegecode1 != null)
            {
                string selq = "";
                if (txtsearch1.Text.Trim() != "")
                {
                    string sname = string.Empty;
                    try
                    {
                        sname = txtsearch1.Text.Trim().Split('-')[0];
                    }
                    catch { sname = txtsearch1.Text.Trim(); }
                    selq = "select appl_id ,h.dept_name,s.staff_name,s.staff_code  from staffmaster s,staff_appl_master a,hrdept_master h where s.appl_no =a.appl_no and a.dept_code =h.dept_code  and s.college_code='" + collegecode1 + "' and staff_name like '" + Convert.ToString(sname) + "%'";
                }
                else if (txtsearch1c.Text.Trim() != "")
                {
                    selq = "select appl_id ,h.dept_name,s.staff_name,s.staff_code  from staffmaster s,staff_appl_master a,hrdept_master h where s.appl_no =a.appl_no and a.dept_code =h.dept_code  and s.college_code='" + collegecode1 + "' and staff_code='" + Convert.ToString(txtsearch1c.Text) + "'";
                }
                else
                {
                    selq = "select appl_id ,h.dept_name,s.staff_name,s.staff_code  from staffmaster s,staff_appl_master a,hrdept_master h where s.appl_no =a.appl_no and a.dept_code =h.dept_code  and s.college_code='" + collegecode1 + "' order by PrintPriority";
                }
                ds.Clear();
                ds = d2.select_method_wo_parameter(selq, "Text");
                if (ds.Tables[0].Rows.Count > 0)
                {
                    Fpspread2.Sheets[0].RowCount = 0;
                    Fpspread2.Sheets[0].ColumnCount = 0;
                    Fpspread2.CommandBar.Visible = false;
                    Fpspread2.Sheets[0].AutoPostBack = false;
                    Fpspread2.Sheets[0].ColumnHeader.RowCount = 1;
                    Fpspread2.Sheets[0].RowHeader.Visible = false;
                    Fpspread2.Sheets[0].ColumnCount = 3;
                    Fpspread2.Sheets[0].Columns[0].Width = 60;
                    Fpspread2.Sheets[0].Columns[1].Width = 170;
                    Fpspread2.Sheets[0].Columns[2].Width = 360;

                    FarPoint.Web.Spread.StyleInfo darkstyle = new FarPoint.Web.Spread.StyleInfo();
                    darkstyle.BackColor = ColorTranslator.FromHtml("#0CA6CA");
                    darkstyle.ForeColor = Color.White;
                    Fpspread2.ActiveSheetView.ColumnHeader.DefaultStyle = darkstyle;

                    Fpspread2.Sheets[0].ColumnHeader.Cells[0, 0].Text = "S.No";
                    Fpspread2.Sheets[0].ColumnHeader.Cells[0, 0].Font.Bold = true;
                    Fpspread2.Sheets[0].ColumnHeader.Cells[0, 0].Font.Name = "Book Antiqua";
                    Fpspread2.Sheets[0].ColumnHeader.Cells[0, 0].Font.Size = FontUnit.Medium;
                    Fpspread2.Sheets[0].ColumnHeader.Cells[0, 0].HorizontalAlign = HorizontalAlign.Center;

                    Fpspread2.Sheets[0].ColumnHeader.Cells[0, 1].Text = "Staff Code";
                    Fpspread2.Sheets[0].ColumnHeader.Cells[0, 1].Font.Bold = true;
                    Fpspread2.Sheets[0].ColumnHeader.Cells[0, 1].Font.Name = "Book Antiqua";
                    Fpspread2.Sheets[0].ColumnHeader.Cells[0, 1].Font.Size = FontUnit.Medium;
                    Fpspread2.Sheets[0].ColumnHeader.Cells[0, 1].HorizontalAlign = HorizontalAlign.Center;

                    Fpspread2.Sheets[0].ColumnHeader.Cells[0, 2].Text = "Staff Name";
                    Fpspread2.Sheets[0].ColumnHeader.Cells[0, 2].Font.Bold = true;
                    Fpspread2.Sheets[0].ColumnHeader.Cells[0, 2].Font.Name = "Book Antiqua";
                    Fpspread2.Sheets[0].ColumnHeader.Cells[0, 2].Font.Size = FontUnit.Medium;
                    Fpspread2.Sheets[0].ColumnHeader.Cells[0, 2].HorizontalAlign = HorizontalAlign.Center;

                    FarPoint.Web.Spread.TextCellType chkall = new FarPoint.Web.Spread.TextCellType();


                    for (int row = 0; row < ds.Tables[0].Rows.Count; row++)
                    {
                        Fpspread2.Sheets[0].RowCount++;
                        Fpspread2.Sheets[0].Cells[Fpspread2.Sheets[0].RowCount - 1, 0].Text = Convert.ToString(row + 1);
                        Fpspread2.Sheets[0].Cells[Fpspread2.Sheets[0].RowCount - 1, 0].HorizontalAlign = HorizontalAlign.Center;
                        Fpspread2.Sheets[0].Cells[Fpspread2.Sheets[0].RowCount - 1, 0].Font.Size = FontUnit.Medium;
                        Fpspread2.Sheets[0].Cells[Fpspread2.Sheets[0].RowCount - 1, 0].Font.Name = "Book Antiqua";

                        Fpspread2.Sheets[0].Cells[Fpspread2.Sheets[0].RowCount - 1, 1].CellType = chkall;
                        Fpspread2.Sheets[0].Cells[Fpspread2.Sheets[0].RowCount - 1, 1].Text = Convert.ToString(ds.Tables[0].Rows[row]["staff_code"]);

                        Fpspread2.Sheets[0].Cells[Fpspread2.Sheets[0].RowCount - 1, 1].Tag = Convert.ToString(ds.Tables[0].Rows[row]["appl_id"]);
                        Fpspread2.Sheets[0].Cells[Fpspread2.Sheets[0].RowCount - 1, 1].HorizontalAlign = HorizontalAlign.Left;
                        Fpspread2.Sheets[0].Cells[Fpspread2.Sheets[0].RowCount - 1, 1].Font.Size = FontUnit.Medium;
                        Fpspread2.Sheets[0].Cells[Fpspread2.Sheets[0].RowCount - 1, 1].Font.Name = "Book Antiqua";

                        Fpspread2.Sheets[0].Cells[Fpspread2.Sheets[0].RowCount - 1, 2].Text = Convert.ToString(ds.Tables[0].Rows[row]["staff_name"]);
                        Fpspread2.Sheets[0].Cells[Fpspread2.Sheets[0].RowCount - 1, 2].HorizontalAlign = HorizontalAlign.Left;
                        Fpspread2.Sheets[0].Cells[Fpspread2.Sheets[0].RowCount - 1, 2].Font.Size = FontUnit.Medium;
                        Fpspread2.Sheets[0].Cells[Fpspread2.Sheets[0].RowCount - 1, 2].Font.Name = "Book Antiqua";

                    }
                    Fpspread2.Visible = true;
                    // div2.Visible = true;
                    lbl_errormsgstaff.Visible = false;
                    Fpspread2.Sheets[0].PageSize = Fpspread2.Sheets[0].RowCount;
                    Fpspread2.Width = 620;
                    Fpspread2.Height = 210;
                    if (Fpspread2.Sheets[0].RowCount > 0)
                    {
                        btn_staffOK.Visible = true;
                        btn_exitstaff.Visible = true;
                    }
                    else
                    {
                        btn_staffOK.Visible = false;
                        btn_exitstaff.Visible = false;
                    }
                }
            }
        }
        catch (Exception ex) { d2.sendErrorMail(ex, collegecode1, "ChallanReceipt"); }
    }
    //Vendor Division
    protected void txtname_vendor_Changed(object sender, EventArgs e)
    {
        btn_print.Visible = false;
        if (txtroll_vendor.Text.Trim() == "")
        {
            txtname_vendor.Text = "";
        }
        string staffId = Convert.ToString(txtname_vendor.Text.Trim());
        try
        {
            staffId = staffId.Split('-')[2];
        }
        catch { staffId = ""; }
        img_stud.ImageUrl = "";
        img_stud.Visible = false;

        if (staffId != "")
        {
            string name = string.Empty;
            string degree = string.Empty;

            string query = " SELECT VendorContactPK, VenContactType, VenContactName, VenContactDesig, VenContactDept, VendorPhoneNo, VendorExtNo, VendorMobileNo, VendorEmail,VendorFK FROM IM_VendorContactMaster WHERE    VendorContactPK = '" + staffId + "' ";

            ds.Clear();
            ds = d2.select_method_wo_parameter(query, "Text");


            if (ds.Tables.Count > 0)
            {
                if (ds.Tables[0].Rows.Count > 0)
                {
                    for (int i = 0; i < ds.Tables[0].Rows.Count; i++)
                    {
                        name = Convert.ToString(ds.Tables[0].Rows[i]["VenContactName"]);
                        degree = Convert.ToString(ds.Tables[0].Rows[i]["VenContactDesig"]);
                        //lbltype.Text = Convert.ToString(ds.Tables[0].Rows[i]["type"]);                            
                    }
                }
            }

            // txtname_staff.Text = name;
            txtDept_vendor.Text = degree;

            //img_stud.ImageUrl = "~/Handler/ghStaffFoto.ashx?QSstaff_id=" + staffId;
            //img_stud.Visible = true;

            string featdegCode = string.Empty;
            // LoadYearSemester(featdegCode);
            loadGridVendor();

        }
        else
        {
            txt_totamt.Text = "0";
            txt_paidamt.Text = "0";
            txt_balamt.Text = "0";
            img_stud.Visible = false;
            lblstaticrollno.Text = "";

            //txtroll_vendor.Text = "";
            txtname_vendor.Text = "";
            txtDept_vendor.Text = "";
            grid_Details.DataSource = null;
            grid_Details.DataBind();
            cbSem_vendor.Checked = false;
            cblSem_vendor.Items.Clear();
            //ddl_sem.Items.Clear();
            //ddl_semMultiple.Items.Clear();
            txtSem_vendor.Text = "";
            img_stud.Visible = false;
            //img_stud.Visible = true;
            //lbl_alert.Text = "Please Enter Staff Id";
        }
        imgAlert.Attributes.Add("Style", "display:none;");

    }
    protected void txtroll_vendor_Changed(object sender, EventArgs e)
    {
        if (txtroll_vendor.Text.Trim() != "")
        {
            txtname_vendor_Changed(sender, e);
            imgAlert.Attributes.Add("Style", "display:none;");
        }
        else
        {
            txt_totamt.Text = "0";
            txt_paidamt.Text = "0";
            txt_balamt.Text = "0";
            img_stud.Visible = false;
            lblstaticrollno.Text = "";

            // txtroll_vendor.Text = "";
            txtname_vendor.Text = "";
            txtDept_vendor.Text = "";
            grid_Details.DataSource = null;
            grid_Details.DataBind();
            cbSem_vendor.Checked = false;
            cblSem_vendor.Items.Clear();
            //ddl_sem.Items.Clear();
            //ddl_semMultiple.Items.Clear();
            txtSem_vendor.Text = "";

            //img_stud.Visible = true;
            //lbl_alert.Text = "Please Enter Staff Id";
        }
    }
    protected void cbSem_vendor_CheckedChanged(object sender, EventArgs e)
    {
        CallCheckBoxChangedEvent(cblSem_vendor, cbSem_vendor, txtSem_vendor, "Semester/Year");
    }
    protected void cblSem_vendor_SelectedIndexChanged(object sender, EventArgs e)
    {
        CallCheckBoxListChangedEvent(cblSem_vendor, cbSem_vendor, txtSem_vendor, "Semester/Year");
    }
    protected void ddlSem_vendor_OnSelectedIndexChanged(object sender, EventArgs e)
    {
        loadGridVendor();
    }
    [System.Web.Services.WebMethod]
    [System.Web.Script.Services.ScriptMethod()]
    public static List<string> GetVendorno(string prefixText)
    {
        List<string> name = new List<string>();
        try
        {
            string query = "";
            WebService ws = new WebService();

            //staff query
            query = " select VendorCompName+'-'+VendorCode+'-'+Convert(varchar(10),vendorpk)  from CO_VendorMaster where VendorType =1";

            name = ws.Getname(query);
            return name;
        }
        catch { return name; }
    }
    [System.Web.Services.WebMethod]
    [System.Web.Script.Services.ScriptMethod()]
    public static List<string> GetVendorName(string prefixText)
    {
        WebService ws = new WebService();
        string query = " select (VenContactName+'-'+VenContactDesig+'-'+ CONVERT(varchar(10), VendorContactPK)) as contactname from IM_VendorContactMaster where VendorFK ='" + vencontcode + "' ";
        DataSet dsN = new DataSet();
        List<string> name = new List<string>();
        try
        {
            name = ws.Getname(query);
        }
        catch { }
        return name;
    }
    [System.Web.Services.WebMethod]
    [System.Web.Script.Services.ScriptMethod()]
    public static List<string> GetVendorno1(string prefixText)
    {
        List<string> name = new List<string>();
        try
        {
            string query = "";
            WebService ws = new WebService();

            //staff query
            query = " select VendorCode  from CO_VendorMaster where VendorType =1  order by VendorCode asc";

            name = ws.Getname(query);
            return name;
        }
        catch { return name; }
    }
    [System.Web.Services.WebMethod]
    [System.Web.Script.Services.ScriptMethod()]
    public static List<string> GetVendorName1(string prefixText)
    {
        WebService ws = new WebService();
        string query = " select VendorCompName  from CO_VendorMaster where VendorType =1 order by VendorCompName asc";
        DataSet dsN = new DataSet();
        List<string> name = new List<string>();
        try
        {
            name = ws.Getname(query);
        }
        catch { }
        return name;
    }
    public void loadGridVendor()
    {
        imgAlert.Attributes.Add("Style", " display:none;");
        loadScholarship("-1");
        fromScript = false;
        try
        {
            txt_rcptno.Text = generateReceiptNo();
            chkGridSelectAll.Checked = false;
            lblstaticrollno.Text = "";
            txt_totamt.Text = "0";
            txt_paidamt.Text = "0";
            txt_balamt.Text = "0";


            string roll_no = string.Empty;
            string semyear = string.Empty;
            string appnoNew = string.Empty;
            string degcode = string.Empty;
            roll_no = txtname_vendor.Text.Trim();

            try
            {
                roll_no = roll_no.Split('-')[2];
            }
            catch { roll_no = "-1"; }
            string finYearid = d2.getCurrentFinanceYear(usercode, collegecode1);
            DataTable tbl_Student = new DataTable();
            tbl_Student.Columns.Add("Roll_No");
            tbl_Student.Columns.Add("Reg_No");
            tbl_Student.Columns.Add("Stud_Name");
            tbl_Student.Columns.Add("Degree");
            tbl_Student.Columns.Add("TextVal");
            tbl_Student.Columns.Add("TextCode");
            tbl_Student.Columns.Add("Header_ID");
            tbl_Student.Columns.Add("Header_Name");
            tbl_Student.Columns.Add("Fee_Code");
            tbl_Student.Columns.Add("Fee_Type");
            tbl_Student.Columns.Add("Fee_Amount");
            tbl_Student.Columns.Add("Deduct");
            tbl_Student.Columns.Add("Total");
            tbl_Student.Columns.Add("PaidAmt");
            tbl_Student.Columns.Add("BalAmt");
            tbl_Student.Columns.Add("ToBePaid");
            tbl_Student.Columns.Add("Monthly");
            tbl_Student.Columns.Add("ChlTaken");
            tbl_Student.Columns.Add("Scholar");
            tbl_Student.Columns.Add("CautionDep");
            tbl_Student.Columns.Add("MonwiseMon");
            tbl_Student.Columns.Add("MonwiseYear");
            tbl_Student.Columns.Add("FeeallotPk");
            tbl_Student.Columns.Add("finyearfk");
            tbl_Student.Columns.Add("finyear");
            string selectQuery = "";

            string queryRollApp = " SELECT VendorContactPK, VenContactType, VenContactName, VenContactDesig, VenContactDept, VendorPhoneNo, VendorExtNo, VendorMobileNo, VendorEmail,VendorFK FROM IM_VendorContactMaster WHERE    VendorContactPK = '" + roll_no + "' ";

            DataSet dsRollApp = new DataSet();
            dsRollApp = d2.select_method_wo_parameter(queryRollApp, "Text");
            if (dsRollApp.Tables.Count > 0)
            {
                if (dsRollApp.Tables[0].Rows.Count > 0)
                {

                    roll_no = Convert.ToString(dsRollApp.Tables[0].Rows[0]["VendorContactPK"]);
                    appnoNew = Convert.ToString(dsRollApp.Tables[0].Rows[0]["VendorContactPK"]);
                    degcode = Convert.ToString(dsRollApp.Tables[0].Rows[0]["VenContactDept"]);

                    lblstaticrollno.Text = roll_no;

                    //img_stud.ImageUrl = "~/Handler/ghStaffFoto.ashx?QSstaff_id=" + roll_no;
                    // img_stud.Visible = true;
                }
                else
                {
                    roll_no = "";
                    appnoNew = "";
                    lblstaticrollno.Text = "";
                    img_stud.Visible = false;
                }
            }
            else
            {
                roll_no = "";
                lblstaticrollno.Text = "";
                img_stud.Visible = false;
            }


            string headercode = getCblSelectedValue(cbl_grpheader);
            //  selectQuery = " SELECT A.HeaderFK,HeaderName,A.LedgerFK,LedgerName,Priority,isnull(FeeAmount,0) as FeeAmount,isnull(DeductAmout,0)  as DeductAmount,isnull(TotalAmount,0) as TotalAmount,isnull(ChlTaken,0) as ChlTakAmt,isnull(PaidAmount,0) as PaidAmount,isnull(TotalAmount,0)-isnull(PaidAmount,0)  as BalAmount FROM FT_FeeAllot A,FM_HeaderMaster H,FM_LedgerMaster L WHERE A.HeaderFK = H.HeaderPK AND A.LedgerFK = L.LedgerPK AND H.HeaderPK = L.HeaderFK  and l.LedgerMode=0 and MemType=3  AND A.App_No = " + appnoNew + "";// and T.TextCode in('" + semyear + "')
            selectQuery = "        select HeaderpK,HeaderName,LedgerpK,LedgerName,Priority,isnull(FeeAmount,0) as FeeAmount,isnull(DeductAmout,0)  as DeductAmount,isnull(TotalAmount,0) as TotalAmount,isnull(ChlTaken,0) as ChlTakAmt,isnull(PaidAmount,0) as PaidAmount,isnull(TotalAmount,0)-isnull(PaidAmount,0)  as BalAmount from (fm_ledgermaster  inner join (fm_headermaster h inner join FS_HeaderPrivilage hp on h.headerpk=hp.headerfk and hp.usercode='" + usercode + "') on h.headerpk=fm_ledgermaster.headerfk and h.headerpk in('" + headercode + "') ) left join ft_feeallot f   on fm_ledgermaster.ledgerpk=f.ledgerfk  and h.headerpk=f.headerfk and fm_ledgermaster.ledgermode='0'  and fm_ledgermaster.headerfk=hp.headerfk and hp.headerfk=f.headerfk  and f.HeaderFK in ('" + headercode + "') and MemType=3 AND f.App_No = " + appnoNew + "  and finyearfk in('" + finYearid + "') and isnull(BalAmount,0)>0 ";

            string chlnTakenQ = " select Count(distinct(ChallanNo)) from FT_ChallanDet where App_No=" + appnoNew + "";// and FeeCategory in ('" + semyear + "')

            if (cb_selcthd.Checked)
            {
                if (rbl_headerselect.SelectedIndex == 0)
                {
                    headercode = headercode = GetSelectedItemsValueAsString(cbl_grpheader);

                    //Group Header
                    selectQuery = " SELECT A.HeaderFK,HeaderName,A.LedgerFK,Priority,LedgerName,isnull(FeeAmount,0) as FeeAmount,isnull(DeductAmout,0)   as DeductAmount ,isnull(TotalAmount,0) as TotalAmount,isnull(ChlTaken,0) as ChlTakAmt,isnull(PaidAmount,0) as PaidAmount,isnull(TotalAmount,0)-isnull(PaidAmount,0)  as BalAmount,ChlGroupHeader FROM FT_FeeAllot A,FM_HeaderMaster H,FS_ChlGroupHeaderSettings S, FM_LedgerMaster L WHERE A.HeaderFK = H.HeaderPK and a.headerfk = s.headerfk and l.headerfk = s.headerfk  AND A.LedgerFK = L.LedgerPK AND H.HeaderPK = L.HeaderFK  and h.headerpk = s.headerfk  and l.LedgerMode=0 and MemType=3   and ChlGroupHeader in('" + headercode + "') ";// and T.TextCode in('" + semyear + "')
                    if (rdo_receipt.Checked)
                    {
                        selectQuery += " AND A.App_No = " + appnoNew + " ";
                    }

                    if (lbltype.Text != "")
                    {
                        selectQuery += "  and Stream ='" + lbltype.Text.Trim() + "' ";
                    }

                }
                else if (rbl_headerselect.SelectedIndex == 1)
                {
                    //Header
                    //selectQuery += "  and A.HeaderFK in (" + headercode + ") ";
                    // chlnTakenQ += " and headerfk in (" + headercode + ") ";
                }
                else
                {
                    //Ledger
                    selectQuery += "  and A.LedgerFK  in (" + headercode + ")  ";
                    chlnTakenQ += "  and LedgerFK in (" + headercode + ")";
                }

            }
            if (ShowBalOnly())
            {
                //selectQuery += " and isnull(BalAmount,0)>0 ";
            }
            selectQuery += "  order by case when priority is null then 1 else 0 end, priority,totalamount desc";

            DataSet ds_stud = new DataSet();
            ds_stud.Clear();
            ds_stud = d2.select_method_wo_parameter(selectQuery, "Text");
            if (ds_stud.Tables.Count > 0)
            {
                if (ds_stud.Tables[0].Rows.Count > 0)
                {
                    string excessamtQ = d2.GetFunction("select sum(isnull(ExcessAmt,0)-isnull(AdjAmt,0)) as BalanceAmt from FT_ExcessDet WHERE  App_No=" + appnoNew + " ");
                    string excessTypeQ = "select LinkValue from New_InsSettings where LinkName='ExcessFeesType' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "' ";
                    int excessTypeValue = 0;
                    try { excessTypeValue = Convert.ToInt32(Convert.ToString(d2.GetFunction(excessTypeQ))); }
                    catch { }


                    double excessamtValue = 0;
                    double.TryParse(excessamtQ, out excessamtValue);
                    double fineAmount = 0;
                    for (i = 0; i < ds_stud.Tables[0].Rows.Count; i++)
                    {
                        DataRow dr_Student = tbl_Student.NewRow();
                        dr_Student["TextVal"] = "0";// Convert.ToString(ds_stud.Tables[0].Rows[i]["TextVal"]);
                        dr_Student["TextCode"] = "0";// Convert.ToString(ds_stud.Tables[0].Rows[i]["TextCode"]);
                        dr_Student["Header_ID"] = Convert.ToString(ds_stud.Tables[0].Rows[i]["HeaderpK"]);
                        dr_Student["Header_Name"] = Convert.ToString(ds_stud.Tables[0].Rows[i]["HeaderName"]);
                        dr_Student["Fee_Code"] = Convert.ToString(ds_stud.Tables[0].Rows[i]["LedgerpK"]);
                        dr_Student["Fee_Type"] = Convert.ToString(ds_stud.Tables[0].Rows[i]["LedgerName"]) + retQuantity(appnoNew, Convert.ToString(ds_stud.Tables[0].Rows[i]["LedgerpK"]), "3", "0");
                        dr_Student["ChlTaken"] = Convert.ToString(ds_stud.Tables[0].Rows[i]["ChlTakAmt"]);

                        double feeamt = Convert.ToDouble(ds_stud.Tables[0].Rows[i]["FeeAmount"]);
                        double deductamt = Convert.ToDouble(ds_stud.Tables[0].Rows[i]["DeductAmount"]);
                        double totamt = Convert.ToDouble(ds_stud.Tables[0].Rows[i]["TotalAmount"]);
                        double paid = Convert.ToDouble(ds_stud.Tables[0].Rows[i]["PaidAmount"]);
                        double balamt = Convert.ToDouble(ds_stud.Tables[0].Rows[i]["BalAmount"]);
                        double curExcess = 0;
                        dr_Student["ToBePaid"] = "0";
                        dr_Student["Fee_Amount"] = feeamt;
                        dr_Student["Deduct"] = deductamt;
                        dr_Student["Total"] = totamt;
                        dr_Student["PaidAmt"] = paid;
                        dr_Student["BalAmt"] = balamt;
                        dr_Student["finyearfk"] = finYearid;
                        dr_Student["finyear"] = finYearid;
                        tbl_Student.Rows.Add(dr_Student);

                    }
                    #region Fine Adjustment
                    double ovrAllBalAmt = 0;
                    try
                    {
                        for (int bal = 0; bal < tbl_Student.Rows.Count; bal++)
                        {
                            string balAmti = Convert.ToString(tbl_Student.Rows[bal]["BalAmt"]).Trim();
                            if (balAmti != "")
                                ovrAllBalAmt += Convert.ToDouble(balAmti);
                        }
                    }
                    catch { ovrAllBalAmt = 0; }
                    double FineAmount = 0;
                    double.TryParse(Convert.ToString(txtfine.Text), out FineAmount);
                    if (ovrAllBalAmt > 0 && cbfine.Checked && FineAmount != 0)
                    {
                        string fineLegHedQ = d2.GetFunction(" select Linkvalue from New_InsSettings where LinkName='FineLedgerValue' and user_code ='" + usercode + "' and college_code  in (" + collegecode1 + ")");
                        if (fineLegHedQ != "0" && FineAmount > 0)
                        {
                            string fineHdrId = fineLegHedQ.Split(',')[0];
                            string fineLgrId = fineLegHedQ.Split(',')[1];
                            string fineHdrName = d2.GetFunction(" select headername from fm_headermaster where headerpk=" + fineHdrId + " and CollegeCode=" + collegecode1 + "");
                            string fineLgrName = d2.GetFunction("  select ledgername from fm_ledgermaster where ledgerpk=" + fineLgrId + " and HeaderFK=" + fineHdrId + " and CollegeCode=" + collegecode1 + "");
                            string strFine = Convert.ToString(ddlfinefee.SelectedItem.Value) + "$" + Convert.ToString(FineAmount);
                            DataRow drFine = tbl_Student.NewRow();
                            drFine["Header_ID"] = fineHdrId;
                            drFine["Header_Name"] = fineHdrName;
                            drFine["Fee_Code"] = fineLgrId;
                            drFine["Fee_Type"] = fineLgrName;
                            drFine["ChlTaken"] = "0";
                            drFine["TextVal"] = "FINE";
                            drFine["TextCode"] = strFine;
                            drFine["Fee_Amount"] = Convert.ToString(FineAmount);
                            drFine["Deduct"] = "0";
                            drFine["Total"] = Convert.ToString(FineAmount);
                            drFine["PaidAmt"] = "0";
                            drFine["BalAmt"] = Convert.ToString(FineAmount);
                            drFine["ToBePaid"] = "0";
                            drFine["Monthly"] = "0";
                            drFine["Scholar"] = "0";
                            drFine["CautionDep"] = "0";
                            //tbl_Student.Rows.Add(drFine);
                            tbl_Student.Rows.InsertAt(drFine, 0);
                        }
                    }
                    if (cbfine.Checked)
                    {
                        ddlfinefee.Attributes.Add("Style", "display:block;float: left;");
                        txtfine.Attributes.Add("Style", "display:block;float: left;");
                    }
                    #endregion
                }
                if (tbl_Student.Rows.Count > 0)
                {
                    grid_Details.DataSource = tbl_Student;
                    grid_Details.DataBind();
                    grid_Details.Visible = true;
                    divgrid.Visible = true;
                    lnkOpenSchemeSettings.Visible = false;
                    imgAlert.Attributes.Add("Style", " display:none;");
                    ScriptManager.RegisterStartupScript(this, GetType(), "InvokeButton", " checkfeeamount();", true);
                    if (rdo_receipt.Checked)
                    {
                        btn_print.Visible = false;
                    }
                }
                else
                {
                    grid_Details.DataSource = null;
                    grid_Details.DataBind();
                    grid_Details.Visible = false;
                    imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                    lbl_alert.Text = "Please Add Fees";
                    btn_print.Visible = false;
                }
            }
            else
            {
                grid_Details.DataSource = null;
                grid_Details.DataBind();
                grid_Details.Visible = false;
                imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                //this.Form.DefaultButton = "btn_alertclose";
                lbl_alert.Text = "Please Add Fees";
                //img_stud.ImageUrl = "";
                //img_stud.Visible = false;
                btn_print.Visible = false;
            }
            Session["appNo"] = appnoNew;

        }
        catch (Exception ex)
        {
            //  d2.sendErrorMail(ex, collegecode1, "ChallanReceipt");
            grid_Details.DataSource = null;
            grid_Details.DataBind();
            grid_Details.Visible = false;
            imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
            lbl_alert.Text = "No Records Found";
            btn_print.Visible = false;
            Session["appNo"] = "";
        }

    }
    protected void btnGO_vendor_Click(object sender, EventArgs e)
    {
        try
        {
            if (rdo_receipt.Checked)
            {
                double partamt = 0;
                if (Txt_amt.Text.Trim() != "")
                {
                    partamt = Convert.ToDouble(Txt_amt.Text.Trim());
                    excessAmt = Convert.ToDouble(Txt_amt.Text.Trim());
                }
                loadGridVendor();
            }
        }
        catch (Exception ex) { d2.sendErrorMail(ex, collegecode1, "ChallanReceipt"); }
    }
    //Lookup Vendor
    protected void btn_vendorLook_Click(object sender, EventArgs e)
    {
        div_vendorLook.Visible = true;
        ddlsearch2_OnSelectedIndexChanged(sender, e);
        btnvendor_ok.Visible = false;
        btnExit_vendor.Visible = false;
        Fpspread3.Visible = false;
        lbl_errormsgvendor.Visible = false;
    }
    protected void btnvendor_ok_Click(object sender, EventArgs e)
    {
        try
        {

            string actrow = "";
            string actcol = "";
            actrow = Fpspread3.ActiveSheetView.ActiveRow.ToString();
            actcol = Fpspread3.ActiveSheetView.ActiveColumn.ToString();
            if (actrow.Trim() != "" && actrow.Trim() != "-1")
            {
                string vendor = Convert.ToString(Fpspread3.Sheets[0].Cells[Convert.ToInt32(actrow), 2].Text);
                string appno = Convert.ToString(Fpspread3.Sheets[0].Cells[Convert.ToInt32(actrow), 1].Tag);
                string vendorcode = Convert.ToString(Fpspread3.Sheets[0].Cells[Convert.ToInt32(actrow), 1].Text);
                txtroll_vendor.Text = vendor + "-" + vendorcode + "-" + appno;
                txtroll_vendor_Changed(sender, e);

            }
            div_vendorLook.Visible = false;
        }
        catch (Exception ex) { d2.sendErrorMail(ex, collegecode1, "ChallanReceipt"); }
    }
    protected void btn_exitvendor_Click(object sender, EventArgs e)
    {
        div_vendorLook.Visible = false;
    }
    protected void ddlsearch2_OnSelectedIndexChanged(object sender, EventArgs e)
    {
        txtsearch2.Text = "";
        txtsearch2c.Text = "";
        txtsearch2c.Visible = false;
        txtsearch2.Visible = false;
        if (ddlsearch2.SelectedIndex == 0)
        {
            txtsearch2.Visible = true;
            Label2.Text = "Search By Name";
        }
        else
        {
            txtsearch2c.Visible = true;
            Label2.Text = "Search By Code";
        }
    }
    protected void Fpspread3vendor_Command(object sender, FarPoint.Web.Spread.SpreadCommandEventArgs e)
    {
        try
        {
            string actrow = Fpspread1.Sheets[0].ActiveRow.ToString();
            string actcol = Fpspread1.Sheets[0].ActiveColumn.ToString();
            if (actrow.Trim() == "0" && actcol.Trim() == "1")
            {
                if (Fpspread1.Sheets[0].RowCount > 0)
                {
                    int checkval = Convert.ToInt32(Fpspread1.Sheets[0].Cells[0, 1].Value);
                    if (checkval == 0)
                    {
                        for (int i = 1; i < Fpspread1.Sheets[0].RowCount; i++)
                        {
                            Fpspread1.Sheets[0].Cells[i, 1].Value = 1;
                        }
                    }
                    if (checkval == 1)
                    {
                        for (int i = 1; i < Fpspread1.Sheets[0].RowCount; i++)
                        {
                            Fpspread1.Sheets[0].Cells[i, 1].Value = 0;
                        }
                    }
                }
            }
        }
        catch (Exception ex) { d2.sendErrorMail(ex, collegecode1, "ChallanReceipt"); }
    }
    protected void btn_goVendor_Click(object sender, EventArgs e)
    {
        try
        {
            imgAlert.Attributes.Add("Style", " display:none;");
            btnvendor_ok.Visible = false;
            btnExit_vendor.Visible = false;
            div_vendorLook.Visible = true;
            Fpspread3.Visible = false;
            if (collegecode1 != null)
            {
                string selq = "";
                if (txtsearch2.Text.Trim() != "")
                {
                    string sname = string.Empty;
                    try
                    {
                        sname = txtsearch2.Text.Trim().Split('-')[0];
                    }
                    catch { sname = txtsearch2.Text.Trim(); }
                    selq = "select VendorCompName,VendorCode ,VendorPK  from CO_VendorMaster where VendorType =1 and VendorCompName like '" + Convert.ToString(sname) + "%'";
                }
                else if (txtsearch2c.Text.Trim() != "")
                {
                    selq = "select VendorCompName,VendorCode ,VendorPK  from CO_VendorMaster where VendorType =1 and Vendorcode= '" + Convert.ToString(txtsearch2c.Text) + "'";
                }
                else
                {
                    selq = "select VendorCompName,VendorCode ,VendorPK  from CO_VendorMaster where VendorType =1 ";
                }
                ds.Clear();
                ds = d2.select_method_wo_parameter(selq, "Text");
                if (ds.Tables.Count > 0)
                {
                    if (ds.Tables[0].Rows.Count > 0)
                    {
                        Fpspread3.Sheets[0].RowCount = 0;
                        Fpspread3.Sheets[0].ColumnCount = 0;
                        Fpspread3.CommandBar.Visible = false;
                        Fpspread3.Sheets[0].AutoPostBack = false;
                        Fpspread3.Sheets[0].ColumnHeader.RowCount = 1;
                        Fpspread3.Sheets[0].RowHeader.Visible = false;
                        Fpspread3.Sheets[0].ColumnCount = 3;
                        Fpspread3.Sheets[0].Columns[0].Width = 60;
                        Fpspread3.Sheets[0].Columns[1].Width = 170;
                        Fpspread3.Sheets[0].Columns[2].Width = 360;

                        FarPoint.Web.Spread.StyleInfo darkstyle = new FarPoint.Web.Spread.StyleInfo();
                        darkstyle.BackColor = ColorTranslator.FromHtml("#0CA6CA");
                        darkstyle.ForeColor = Color.White;
                        Fpspread3.ActiveSheetView.ColumnHeader.DefaultStyle = darkstyle;

                        Fpspread3.Sheets[0].ColumnHeader.Cells[0, 0].Text = "S.No";
                        Fpspread3.Sheets[0].ColumnHeader.Cells[0, 0].Font.Bold = true;
                        Fpspread3.Sheets[0].ColumnHeader.Cells[0, 0].Font.Name = "Book Antiqua";
                        Fpspread3.Sheets[0].ColumnHeader.Cells[0, 0].Font.Size = FontUnit.Medium;
                        Fpspread3.Sheets[0].ColumnHeader.Cells[0, 0].HorizontalAlign = HorizontalAlign.Center;

                        Fpspread3.Sheets[0].ColumnHeader.Cells[0, 1].Text = "Vendor Code";
                        Fpspread3.Sheets[0].ColumnHeader.Cells[0, 1].Font.Bold = true;
                        Fpspread3.Sheets[0].ColumnHeader.Cells[0, 1].Font.Name = "Book Antiqua";
                        Fpspread3.Sheets[0].ColumnHeader.Cells[0, 1].Font.Size = FontUnit.Medium;
                        Fpspread3.Sheets[0].ColumnHeader.Cells[0, 1].HorizontalAlign = HorizontalAlign.Center;

                        Fpspread3.Sheets[0].ColumnHeader.Cells[0, 2].Text = "Vendor Name";
                        Fpspread3.Sheets[0].ColumnHeader.Cells[0, 2].Font.Bold = true;
                        Fpspread3.Sheets[0].ColumnHeader.Cells[0, 2].Font.Name = "Book Antiqua";
                        Fpspread3.Sheets[0].ColumnHeader.Cells[0, 2].Font.Size = FontUnit.Medium;
                        Fpspread3.Sheets[0].ColumnHeader.Cells[0, 2].HorizontalAlign = HorizontalAlign.Center;

                        FarPoint.Web.Spread.TextCellType chkall = new FarPoint.Web.Spread.TextCellType();


                        for (int row = 0; row < ds.Tables[0].Rows.Count; row++)
                        {
                            Fpspread3.Sheets[0].RowCount++;
                            Fpspread3.Sheets[0].Cells[Fpspread3.Sheets[0].RowCount - 1, 0].Text = Convert.ToString(row + 1);
                            Fpspread3.Sheets[0].Cells[Fpspread3.Sheets[0].RowCount - 1, 0].HorizontalAlign = HorizontalAlign.Center;
                            Fpspread3.Sheets[0].Cells[Fpspread3.Sheets[0].RowCount - 1, 0].Font.Size = FontUnit.Medium;
                            Fpspread3.Sheets[0].Cells[Fpspread3.Sheets[0].RowCount - 1, 0].Font.Name = "Book Antiqua";

                            Fpspread3.Sheets[0].Cells[Fpspread3.Sheets[0].RowCount - 1, 1].CellType = chkall;
                            Fpspread3.Sheets[0].Cells[Fpspread3.Sheets[0].RowCount - 1, 1].Text = Convert.ToString(ds.Tables[0].Rows[row]["Vendorcode"]);

                            Fpspread3.Sheets[0].Cells[Fpspread3.Sheets[0].RowCount - 1, 1].Tag = Convert.ToString(ds.Tables[0].Rows[row]["VendorPK"]);
                            Fpspread3.Sheets[0].Cells[Fpspread3.Sheets[0].RowCount - 1, 1].HorizontalAlign = HorizontalAlign.Left;
                            Fpspread3.Sheets[0].Cells[Fpspread3.Sheets[0].RowCount - 1, 1].Font.Size = FontUnit.Medium;
                            Fpspread3.Sheets[0].Cells[Fpspread3.Sheets[0].RowCount - 1, 1].Font.Name = "Book Antiqua";

                            Fpspread3.Sheets[0].Cells[Fpspread3.Sheets[0].RowCount - 1, 2].Text = Convert.ToString(ds.Tables[0].Rows[row]["VendorCompName"]);
                            Fpspread3.Sheets[0].Cells[Fpspread3.Sheets[0].RowCount - 1, 2].HorizontalAlign = HorizontalAlign.Left;
                            Fpspread3.Sheets[0].Cells[Fpspread3.Sheets[0].RowCount - 1, 2].Font.Size = FontUnit.Medium;
                            Fpspread3.Sheets[0].Cells[Fpspread3.Sheets[0].RowCount - 1, 2].Font.Name = "Book Antiqua";

                        }
                        Fpspread3.Visible = true;
                        // div2.Visible = true;
                        lbl_errormsgvendor.Visible = false;
                        Fpspread3.Sheets[0].PageSize = Fpspread3.Sheets[0].RowCount;
                        Fpspread3.Width = 620;
                        Fpspread3.Height = 210;
                        if (Fpspread3.Sheets[0].RowCount > 0)
                        {
                            btnvendor_ok.Visible = true;
                            btnExit_vendor.Visible = true;
                        }

                    }
                    else
                    {
                        imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                        lbl_alert.Text = "No Records Found";
                    }
                }
                else
                {
                    imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                    lbl_alert.Text = "No Records Found";
                }
            }
        }
        catch (Exception ex) { d2.sendErrorMail(ex, collegecode1, "ChallanReceipt"); }
    }
    //Others Division
    [System.Web.Services.WebMethod]
    [System.Web.Script.Services.ScriptMethod()]
    public static List<string> GetOthername(string prefixText)
    {
        WebService ws = new WebService();
        //string query = " select vendorname+'-'+VendorMobileNo from co_vendormaster where vendorname like '" + prefixText + "%' and VendorType=-5";
        string query = " select vendorname from co_vendormaster where vendorname like '" + prefixText + "%' and VendorType=-5";
        DataSet dsN = new DataSet();
        List<string> name = new List<string>();
        try
        {
            name = ws.Getname(query);
        }
        catch { }
        return name;
    }
    protected void txtroll_other_Changed(object sender, EventArgs e)
    {
        btn_print.Visible = false;
        //try
        //{
        txt_otherMobile.Text = "";//    txt_otherMobile.Text = txtroll_other.Text.Split('-')[1].Trim();
        //    txtroll_other.Text = txtroll_other.Text.Split('-')[0].Trim();
        //}
        //catch { }

        string staffId = Convert.ToString(txtroll_other.Text.Trim());
        string staffMob = Convert.ToString(txt_otherMobile.Text.Trim());
        img_stud.ImageUrl = "";
        img_stud.Visible = false;

        if (staffId != "")//&& staffMob != ""
        {
            string ifAlready = "select VendorCode from co_vendormaster where vendorname='" + staffId + "' and VendorType=-5";
            if (!string.IsNullOrEmpty(staffMob))
                ifAlready += " and VendorMobileNo='" + staffMob + "'";

            string ifAlreadyExist = d2.GetFunction(ifAlready).Trim();
            string name = string.Empty;
            string compname = string.Empty;
            string Add1 = string.Empty;
            string Add2 = string.Empty;
            string mobiNo = string.Empty;
            if (ifAlreadyExist != "0")
            {
                string query = " select VendorName,VendorMobileNo,VendorCode,VendorAddress+'-'+VendorStreet as Add1,VendorCity,VendorCompName from co_vendormaster where vendorname='" + staffId + "'  and VendorType=-5";
                if (!string.IsNullOrEmpty(staffMob))
                    query += " and VendorMobileNo='" + staffMob + "'";
                ds.Clear();
                ds = d2.select_method_wo_parameter(query, "Text");

                if (ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
                {
                    name = Convert.ToString(ds.Tables[0].Rows[0]["VendorName"]);
                    compname = Convert.ToString(ds.Tables[0].Rows[0]["VendorCompName"]);
                    Add1 = Convert.ToString(ds.Tables[0].Rows[0]["Add1"]);
                    Add2 = Convert.ToString(ds.Tables[0].Rows[0]["VendorCity"]);
                    mobiNo = Convert.ToString(ds.Tables[0].Rows[0]["VendorMobileNo"]);
                }

                txtname_other.Text = compname;
                txtAdd1_Other.Text = Add1;
                txtAdd2_Other.Text = Add2;
                txt_otherMobile.Text = mobiNo;

            }

            img_stud.ImageUrl = "~/Handler/ghStaffFoto.ashx?QSstaff_id=" + staffId;
            img_stud.Visible = true;

            string featdegCode = string.Empty;
            // LoadYearSemester(featdegCode);
            loadGridOthers();
            btn_ledgersave.Visible = false;
            btn_ledgerExit.Visible = false;
            // chkGridSelectAll.Checked = true;
            // ScriptManager.RegisterStartupScript(this, GetType(), "InvokeButton", " SelLedgers();", true);
            divSchemeSettings.Attributes.Add("Style", "display:none;");
            lnkOpenSchemeSettings.Visible = false;
            tdstudsem.Visible = false;
            // gridpaidamount();
        }
        else
        {
            txt_totamt.Text = "0";
            txt_paidamt.Text = "0";
            txt_balamt.Text = "0";
            img_stud.Visible = false;
            lblstaticrollno.Text = "";

            txtroll_other.Text = "";
            txtname_other.Text = "";
            txtAdd1_Other.Text = "";
            txtAdd2_Other.Text = "";
            txt_otherMobile.Text = "";
            grid_Details.DataSource = null;
            grid_Details.DataBind();
            cbSem_other.Checked = false;
            cblSem_other.Items.Clear();

            txtSem_other.Text = "";
            img_stud.Visible = false;

        }
    }
    protected void txtname_other_Changed(object sender, EventArgs e)
    {

    }
    protected void cbSem_other_CheckedChanged(object sender, EventArgs e)
    {
        CallCheckBoxChangedEvent(cblSem_other, cbSem_other, txtSem_other, "Semester/Year");
    }
    protected void cblSem_other_SelectedIndexChanged(object sender, EventArgs e)
    {
        CallCheckBoxListChangedEvent(cblSem_other, cbSem_other, txtSem_other, "Semester/Year");
    }
    protected void ddlSem_other_OnSelectedIndexChanged(object sender, EventArgs e)
    {
        loadGridOthers();
    }
    public void loadGridOthers()
    {
        imgAlert.Attributes.Add("Style", " display:none;");
        loadScholarship("-1");
        if (generateVendorCode().Trim() != "")
        {

            txt_rcptno.Text = generateReceiptNo();

            chkGridSelectAll.Checked = false;
            fromScript = false;
            try
            {
                lblstaticrollno.Text = "";
                txt_totamt.Text = "0";
                txt_paidamt.Text = "0";
                txt_balamt.Text = "0";
                //  txt_chltaken.Text = "0.00";
                generateReceiptNo();
                string roll_no = string.Empty;
                string semyear = string.Empty;
                string appnoNew = string.Empty;
                string degcode = string.Empty;
                roll_no = txtroll_other.Text.Trim();
                string finYearid = d2.getCurrentFinanceYear(usercode, collegecode1);
                DataTable tbl_Student = new DataTable();
                tbl_Student.Columns.Add("Roll_No");
                tbl_Student.Columns.Add("Reg_No");
                tbl_Student.Columns.Add("Stud_Name");
                tbl_Student.Columns.Add("Degree");
                tbl_Student.Columns.Add("TextVal");
                tbl_Student.Columns.Add("TextCode");
                tbl_Student.Columns.Add("Header_ID");
                tbl_Student.Columns.Add("Header_Name");
                tbl_Student.Columns.Add("Fee_Code");
                tbl_Student.Columns.Add("Fee_Type");
                tbl_Student.Columns.Add("Fee_Amount");
                tbl_Student.Columns.Add("Deduct");
                tbl_Student.Columns.Add("Total");
                tbl_Student.Columns.Add("PaidAmt");
                tbl_Student.Columns.Add("BalAmt");
                tbl_Student.Columns.Add("ToBePaid");
                tbl_Student.Columns.Add("Monthly");
                tbl_Student.Columns.Add("ChlTaken");
                tbl_Student.Columns.Add("Scholar");
                tbl_Student.Columns.Add("CautionDep");
                tbl_Student.Columns.Add("MonwiseMon");
                tbl_Student.Columns.Add("MonwiseYear");
                tbl_Student.Columns.Add("FeeallotPk");
                tbl_Student.Columns.Add("finyearfk");
                tbl_Student.Columns.Add("finyear");
                string selectQuery = "";

                string name = string.Empty;
                string compname = string.Empty;
                string Add1 = string.Empty;
                string Add2 = string.Empty;
                string mobiNo = string.Empty;

                string staffId = Convert.ToString(txtroll_other.Text.Trim());
                string staffMob = Convert.ToString(txt_otherMobile.Text.Trim());
                string queryRollApp = "  select VendorName, VendorMobileNo, VendorCode,VendorAddress ,VendorCity,VendorCompName,VendorPK from co_vendormaster where vendorname='" + staffId + "'  and VendorType=-5 ";
                if (!string.IsNullOrEmpty(staffMob))
                    queryRollApp += " and VendorMobileNo='" + staffMob + "'";

                DataSet dsRollApp = new DataSet();
                dsRollApp = d2.select_method_wo_parameter(queryRollApp, "Text");
                if (dsRollApp.Tables.Count > 0)
                {
                    if (dsRollApp.Tables[0].Rows.Count > 0)
                    {

                        roll_no = Convert.ToString(dsRollApp.Tables[0].Rows[0]["VendorName"]);
                        appnoNew = Convert.ToString(dsRollApp.Tables[0].Rows[0]["VendorPK"]);
                        // degcode = Convert.ToString(dsRollApp.Tables[0].Rows[0]["dept_code"]);

                        name = Convert.ToString(dsRollApp.Tables[0].Rows[0]["VendorName"]);
                        compname = Convert.ToString(dsRollApp.Tables[0].Rows[0]["VendorCompName"]);
                        Add1 = Convert.ToString(dsRollApp.Tables[0].Rows[0]["VendorAddress"]);
                        Add2 = Convert.ToString(dsRollApp.Tables[0].Rows[0]["VendorCity"]);
                        mobiNo = Convert.ToString(dsRollApp.Tables[0].Rows[0]["VendorMobileNo"]);

                        lblstaticrollno.Text = roll_no;

                        img_stud.ImageUrl = "~/Handler/ghStaffFoto.ashx?QSstaff_id=" + roll_no;
                        img_stud.Visible = true;
                    }
                    else
                    {
                        roll_no = "";
                        appnoNew = "";
                        lblstaticrollno.Text = "";
                        img_stud.Visible = false;
                    }
                }
                else
                {
                    roll_no = "";
                    appnoNew = "";
                    lblstaticrollno.Text = "";
                    img_stud.Visible = false;
                }
                txtname_other.Text = compname;
                txtAdd1_Other.Text = Add1;
                txtAdd2_Other.Text = Add2;
                //txt_otherMobile.Text = mobiNo;
                string headercode = getCblSelectedValue(cbl_grpheader);
                if (!string.IsNullOrEmpty(appnoNew))
                {
                    //selectQuery = " SELECT A.HeaderFK,HeaderName,A.LedgerFK,LedgerName,Priority,isnull(FeeAmount,0) as FeeAmount,isnull(DeductAmout,0)  as DeductAmount,isnull(TotalAmount,0) as TotalAmount,isnull(ChlTaken,0) as ChlTakAmt,isnull(PaidAmount,0) as PaidAmount,isnull(TotalAmount,0)-isnull(PaidAmount,0)  as BalAmount FROM FT_FeeAllot A,FM_HeaderMaster H,FM_LedgerMaster L WHERE A.HeaderFK = H.HeaderPK AND A.LedgerFK = L.LedgerPK AND H.HeaderPK = L.HeaderFK and l.LedgerMode=0 and MemType=4  AND A.App_No = " + appnoNew + "";//and T.TextCode in('" + semyear + "')
                    selectQuery = "        select HeaderpK,HeaderName,LedgerpK,LedgerName,Priority,isnull(FeeAmount,0) as FeeAmount,isnull(DeductAmout,0)  as DeductAmount,isnull(TotalAmount,0) as TotalAmount,isnull(ChlTaken,0) as ChlTakAmt,isnull(PaidAmount,0) as PaidAmount,isnull(TotalAmount,0)-isnull(PaidAmount,0)  as BalAmount from (fm_ledgermaster  inner join (fm_headermaster h inner join FS_HeaderPrivilage hp on h.headerpk=hp.headerfk and hp.usercode='" + usercode + "') on h.headerpk=fm_ledgermaster.headerfk and h.headerpk in('" + headercode + "') ) left join ft_feeallot f   on fm_ledgermaster.ledgerpk=f.ledgerfk  and h.headerpk=f.headerfk and fm_ledgermaster.ledgermode='0'  and fm_ledgermaster.headerfk=hp.headerfk and hp.headerfk=f.headerfk  and f.HeaderFK in ('" + headercode + "') and MemType=4 AND f.App_No = " + appnoNew + "   and finyearfk in('" + finYearid + "')  and isnull(BalAmount,0)>0";
                    string chlnTakenQ = " select Count(distinct(ChallanNo)) from FT_ChallanDet where App_No=" + appnoNew + " ";//and FeeCategory in ('" + semyear + "')

                    if (cb_selcthd.Checked)
                    {


                        if (rbl_headerselect.SelectedIndex == 0)
                        {
                            headercode = "";

                            headercode = GetSelectedItemsValueAsString(cbl_grpheader);

                            //Group Header
                            selectQuery = " SELECT A.HeaderFK,HeaderName,A.LedgerFK,Priority,LedgerName,isnull(FeeAmount,0) as FeeAmount,isnull(DeductAmout,0)   as DeductAmount ,isnull(TotalAmount,0) as TotalAmount,isnull(ChlTaken,0) as ChlTakAmt,isnull(PaidAmount,0) as PaidAmount,isnull(TotalAmount,0)-isnull(PaidAmount,0)  as BalAmount,ChlGroupHeader FROM FT_FeeAllot A,FM_HeaderMaster H,FS_ChlGroupHeaderSettings S, FM_LedgerMaster L WHERE A.HeaderFK = H.HeaderPK and a.headerfk = s.headerfk and l.headerfk = s.headerfk  AND A.LedgerFK = L.LedgerPK AND H.HeaderPK = L.HeaderFK and h.headerpk = s.headerfk  and l.LedgerMode=0 and MemType=4   and ChlGroupHeader in('" + headercode + "') ";// and T.TextCode in('" + semyear + "')
                            if (rdo_receipt.Checked)
                            {
                                selectQuery += " AND A.App_No = " + appnoNew + " ";
                            }

                            if (lbltype.Text != "")
                            {
                                selectQuery += "  and Stream ='" + lbltype.Text.Trim() + "' ";
                            }

                        }
                        else if (rbl_headerselect.SelectedIndex == 1)
                        {
                            //Header
                            // selectQuery += "  and A.HeaderFK in (" + headercode + ") ";
                            // chlnTakenQ += " and headerfk in (" + headercode + ") ";
                        }
                        else
                        {
                            //Ledger
                            selectQuery += "  and A.LedgerFK  in (" + headercode + ")  ";
                            chlnTakenQ += "  and LedgerFK in (" + headercode + ")";
                        }

                    }
                    if (ShowBalOnly())
                    {
                        //selectQuery += " and isnull(BalAmount,0)>0 ";
                    }
                    selectQuery += "  order by case when priority is null then 1 else 0 end, priority,totalamount desc";

                    DataSet ds_stud = new DataSet();
                    ds_stud.Clear();
                    ds_stud = d2.select_method_wo_parameter(selectQuery, "Text");
                    if (ds_stud.Tables.Count > 0)
                    {
                        if (ds_stud.Tables[0].Rows.Count > 0)
                        {
                            string excessamtQ = d2.GetFunction("select sum(isnull(ExcessAmt,0)-isnull(AdjAmt,0)) as BalanceAmt from FT_ExcessDet WHERE  App_No=" + appnoNew + " ");
                            string excessTypeQ = "select LinkValue from New_InsSettings where LinkName='ExcessFeesType' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "' ";
                            int excessTypeValue = 0;
                            try { excessTypeValue = Convert.ToInt32(Convert.ToString(d2.GetFunction(excessTypeQ))); }
                            catch { }


                            double excessamtValue = 0;
                            double.TryParse(excessamtQ, out excessamtValue);
                            double fineAmount = 0;
                            for (i = 0; i < ds_stud.Tables[0].Rows.Count; i++)
                            {
                                DataRow dr_Student = tbl_Student.NewRow();
                                dr_Student["TextVal"] = "0";// Convert.ToString(ds_stud.Tables[0].Rows[i]["TextVal"]);
                                dr_Student["TextCode"] = "0";//Convert.ToString(ds_stud.Tables[0].Rows[i]["TextCode"]);
                                dr_Student["Header_ID"] = Convert.ToString(ds_stud.Tables[0].Rows[i]["HeaderPK"]);
                                dr_Student["Header_Name"] = Convert.ToString(ds_stud.Tables[0].Rows[i]["HeaderName"]);
                                dr_Student["Fee_Code"] = Convert.ToString(ds_stud.Tables[0].Rows[i]["LedgerpK"]);
                                dr_Student["Fee_Type"] = Convert.ToString(ds_stud.Tables[0].Rows[i]["LedgerName"]) + retQuantity(appnoNew, Convert.ToString(ds_stud.Tables[0].Rows[i]["LedgerpK"]), "4", "0");
                                dr_Student["ChlTaken"] = Convert.ToString(ds_stud.Tables[0].Rows[i]["ChlTakAmt"]);

                                //appnoNew = Convert.ToString(ds_stud.Tables[0].Rows[i]["App_No"]);

                                double feeamt = Convert.ToDouble(ds_stud.Tables[0].Rows[i]["FeeAmount"]);
                                double deductamt = Convert.ToDouble(ds_stud.Tables[0].Rows[i]["DeductAmount"]);
                                double totamt = Convert.ToDouble(ds_stud.Tables[0].Rows[i]["TotalAmount"]);
                                double paid = Convert.ToDouble(ds_stud.Tables[0].Rows[i]["PaidAmount"]);
                                double balamt = Convert.ToDouble(ds_stud.Tables[0].Rows[i]["BalAmount"]);
                                double curExcess = 0;
                                dr_Student["ToBePaid"] = "0";
                                dr_Student["Fee_Amount"] = feeamt;
                                dr_Student["Deduct"] = deductamt;
                                dr_Student["Total"] = totamt;
                                dr_Student["PaidAmt"] = paid;
                                dr_Student["BalAmt"] = balamt;
                                dr_Student["finyearfk"] = finYearid;
                                dr_Student["finyear"] = finYearid;
                                tbl_Student.Rows.Add(dr_Student);
                            }
                            #region Fine Adjustment
                            double ovrAllBalAmt = 0;
                            try
                            {
                                for (int bal = 0; bal < tbl_Student.Rows.Count; bal++)
                                {
                                    string balAmti = Convert.ToString(tbl_Student.Rows[bal]["BalAmt"]).Trim();
                                    if (balAmti != "")
                                        ovrAllBalAmt += Convert.ToDouble(balAmti);
                                }
                            }
                            catch { ovrAllBalAmt = 0; }
                            double FineAmount = 0;
                            double.TryParse(Convert.ToString(txtfine.Text), out FineAmount);
                            if (ovrAllBalAmt > 0 && cbfine.Checked && FineAmount != 0)
                            {
                                string fineLegHedQ = d2.GetFunction(" select Linkvalue from New_InsSettings where LinkName='FineLedgerValue' and user_code ='" + usercode + "' and college_code  in (" + collegecode1 + ")");
                                if (fineLegHedQ != "0" && FineAmount > 0)
                                {
                                    string fineHdrId = fineLegHedQ.Split(',')[0];
                                    string fineLgrId = fineLegHedQ.Split(',')[1];
                                    string fineHdrName = d2.GetFunction(" select headername from fm_headermaster where headerpk=" + fineHdrId + " and CollegeCode=" + collegecode1 + "");
                                    string fineLgrName = d2.GetFunction("  select ledgername from fm_ledgermaster where ledgerpk=" + fineLgrId + " and HeaderFK=" + fineHdrId + " and CollegeCode=" + collegecode1 + "");
                                    string strFine = Convert.ToString(ddlfinefee.SelectedItem.Value) + "$" + Convert.ToString(FineAmount);
                                    DataRow drFine = tbl_Student.NewRow();
                                    drFine["Header_ID"] = fineHdrId;
                                    drFine["Header_Name"] = fineHdrName;
                                    drFine["Fee_Code"] = fineLgrId;
                                    drFine["Fee_Type"] = fineLgrName;
                                    drFine["ChlTaken"] = "0";
                                    drFine["TextVal"] = "FINE";
                                    drFine["TextCode"] = strFine;
                                    drFine["Fee_Amount"] = Convert.ToString(FineAmount);
                                    drFine["Deduct"] = "0";
                                    drFine["Total"] = Convert.ToString(FineAmount);
                                    drFine["PaidAmt"] = "0";
                                    drFine["BalAmt"] = Convert.ToString(FineAmount);
                                    drFine["ToBePaid"] = "0";
                                    drFine["Monthly"] = "0";
                                    drFine["Scholar"] = "0";
                                    drFine["CautionDep"] = "0";
                                    //tbl_Student.Rows.Add(drFine);
                                    tbl_Student.Rows.InsertAt(drFine, 0);
                                }
                            }
                            if (cbfine.Checked)
                            {
                                ddlfinefee.Attributes.Add("Style", "display:block;float: left;");
                                txtfine.Attributes.Add("Style", "display:block;float: left;");
                            }
                            #endregion
                        }


                        if (tbl_Student.Rows.Count > 0)
                        {
                            grid_Details.DataSource = tbl_Student;
                            grid_Details.DataBind();
                            grid_Details.Visible = true;
                            divgrid.Visible = true;
                            lnkOpenSchemeSettings.Visible = false;
                            headerandsemload();
                            if (rdo_receipt.Checked)
                            {
                                btn_print.Visible = false;
                            }
                            ScriptManager.RegisterStartupScript(this, GetType(), "InvokeButton", " checkfeeamount();", true);
                        }
                        else
                        {
                            grid_Details.DataSource = null;
                            grid_Details.DataBind();
                            grid_Details.Visible = false;
                            Txt_amt.Text = "0";
                            imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                            lbl_alert.Text = "Please Add Fees";
                            btn_print.Visible = false;
                        }
                    }
                    else
                    {
                        grid_Details.DataSource = null;
                        grid_Details.DataBind();
                        grid_Details.Visible = false;
                        Txt_amt.Text = "0";
                        imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                        lbl_alert.Text = "Please Add Fees";
                        btn_print.Visible = false;
                    }
                    Session["appNo"] = appnoNew;
                }
                else
                {
                    grid_Details.DataSource = null;
                    grid_Details.DataBind();
                    grid_Details.Visible = false;
                    //imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                    //lbl_alert.Text = "No Records Found";
                    btn_print.Visible = false;
                }

            }
            catch (Exception ex)
            {
                // d2.sendErrorMail(ex, collegecode1, "ChallanReceipt");
                grid_Details.DataSource = null;
                grid_Details.DataBind();
                grid_Details.Visible = false;
                imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
                lbl_alert.Text = "No Records Found";
                btn_print.Visible = false;
                Session["appNo"] = "";
            }
        }
        else
        {
            imgAlert.Attributes.Add("Style", "height: 100em; z-index: 100000; width: 100%; background-color: rgba(54, 25, 25, .2); position: absolute; top:0;left: 0px; display:block;");
            lbl_alert.Text = "Please Set Inventory Code Settings";
        }
    }
    protected void btnGO_other_Click(object sender, EventArgs e)
    {
        try
        {
            if (rdo_receipt.Checked)
            {
                divSchemeSettings.Attributes.Add("Style", "display:none;");
                double partamt = 0;
                if (Txt_amt.Text.Trim() != "")
                {
                    partamt = Convert.ToDouble(Txt_amt.Text.Trim());
                    excessAmt = Convert.ToDouble(Txt_amt.Text.Trim());
                }
                string staffId = Convert.ToString(txtroll_other.Text.Trim());
                string staffMob = Convert.ToString(txt_otherMobile.Text.Trim());
                if (!string.IsNullOrEmpty(staffId) && !string.IsNullOrEmpty(staffMob))
                {
                    string getId = d2.GetFunction("select VendorCode from co_vendormaster where vendorname='" + staffId + "' and VendorMobileNo='" + staffMob + "'  and VendorType=-5");
                    if (getId == "0")
                    {
                        string newVenCode = generateVendorCode().Trim();
                        if (newVenCode != "0")
                            otherCreation(staffId, staffMob, newVenCode);
                    }
                }
                loadGridOthers();
            }

        }
        catch (Exception ex) { d2.sendErrorMail(ex, collegecode1, "ChallanReceipt"); }
    }
    protected void otherCreation(string staffId, string staffMob, string newVenCode)
    {
        try
        {
            d2.update_method_wo_parameter("if not exists (select VendorCode from co_vendormaster where vendorname='" + staffId + "' and VendorMobileNo='" + staffMob + "'  and VendorType=-5) insert into co_vendormaster  (VendorCode,vendorname,VendorMobileNo,VendorAddress,VendorCity,VendorCompName,VendorType) values ('" + newVenCode + "','" + staffId + "','" + staffMob + "','" + txtAdd1_Other.Text.Trim() + "','" + txtAdd2_Other.Text.Trim() + "','" + txtname_other.Text.Trim() + "',-5) else update co_vendormaster set VendorAddress='" + txtAdd1_Other.Text.Trim() + "',VendorCity='" + txtAdd2_Other.Text.Trim() + "',VendorCompName='" + txtname_other.Text.Trim() + "'  where vendorname='" + staffId + "' and VendorMobileNo='" + staffMob + "'  and VendorType=-5 ", "Text");
        }
        catch { }
    }
    //Reusable Methods
    public void isContainsDecimal(double myValue)
    {
        bool hasFractionalPart = (myValue - Math.Round(myValue) != 0);
    }
    public string returnIntegerPart(double value)
    {
        string strVal = value.ToString();
        string[] strvalArr = strVal.Split('.');
        if (strvalArr.Length > 0)
        {
            strVal = strvalArr[0];
        }
        return strVal;
    }
    public string returnDecimalPart(double value)
    {
        string strVal = value.ToString();
        string[] strvalArr = strVal.Split('.');
        if (strvalArr.Length > 1)
        {
            strVal = strvalArr[1];
            if (strVal.Length >= 2)
            {
                strVal = strVal.Substring(0, 2);
            }
            else
            {
                while (2 != strVal.Length)
                {
                    strVal = strVal + "0";
                }
            }
        }
        else
        {
            strVal = "00";
        }
        return strVal;
    }
    public string romanLetter(string numeral)
    {
        string romanLettervalue = String.Empty;
        if (numeral.Trim() != String.Empty)
        {
            switch (numeral)
            {
                case "1":
                    romanLettervalue = "I";
                    break;
                case "2":
                    romanLettervalue = "II";
                    break;
                case "3":
                    romanLettervalue = "III";
                    break;
                case "4":
                    romanLettervalue = "IV";
                    break;
                case "5":
                    romanLettervalue = "V";
                    break;
                case "6":
                    romanLettervalue = "VI";
                    break;
                case "7":
                    romanLettervalue = "VII";
                    break;
                case "8":
                    romanLettervalue = "VIII";
                    break;
                case "9":
                    romanLettervalue = "IX";
                    break;
                case "10":
                    romanLettervalue = "X";
                    break;
            }
        }
        return romanLettervalue;
    }
    public static string ConvertNumbertoWords(int number)
    {
        if (number == 0)
            return "Zero";
        if (number < 0)
            return "minus " + ConvertNumbertoWords(Math.Abs(number));
        string words = "";
        if ((number / 100000) > 0)
        {
            words += ConvertNumbertoWords(number / 100000) + " Lakhs";
            number %= 100000;
        }
        if ((number / 1000) > 0)
        {
            words += ConvertNumbertoWords(number / 1000) + " Thousand ";
            number %= 1000;
        }
        if ((number / 100) > 0)
        {
            words += ConvertNumbertoWords(number / 100) + "  Hundred ";
            number %= 100;
        }
        if (number > 0)
        {
            if (words != "")
                words += "And ";
            var unitsMap = new[] { "Zero", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine", "Ten", "Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen", "Sixteen", "Seventeen", "Eighteen", "Nineteen" };
            var tensMap = new[] { "Zero", "Ten", "Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety" };

            if (number < 20)
                words += unitsMap[number];
            else
            {
                words += tensMap[number / 10];
                if ((number % 10) > 0)
                    words += " " + unitsMap[number % 10];
            }
        }
        return words;
    }
    public string DecimalToWords(decimal number)
    {
        if (number == 0)
            return "Zero";

        if (number < 0)
            return "Minus " + DecimalToWords(Math.Abs(number));

        string words = "";

        int intPortion = (int)number;
        decimal fraction = (number - intPortion) * 100;
        int decPortion = (int)fraction;

        words = ConvertNumbertoWords(intPortion);//NumberToWords(intPortion)
        if (decPortion > 0)
        {
            words += " and ";
            words += ConvertNumbertoWords(intPortion);//NumberToWords(intPortion)
            words += " Paise ";
        }
        return words;
    }
    public string NumberToWords(int number)
    {
        if (number == 0)
            return "Zero";

        if (number < 0)
            return "Minus " + NumberToWords(Math.Abs(number));

        string words = "";

        if ((number / 1000000) > 0)
        {
            words += NumberToWords(number / 1000000) + " Million ";
            number %= 1000000;
        }

        if ((number / 1000) > 0)
        {
            words += NumberToWords(number / 1000) + " Thousand ";
            number %= 1000;
        }

        if ((number / 100) > 0)
        {
            words += NumberToWords(number / 100) + " Hundred ";
            number %= 100;
        }

        if (number > 0)
        {
            if (words != "")
                words += "and ";

            var unitsMap = new[] { "Zero", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine", "Ten", "Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen", "Sixteen", "Seventeen", "Eighteen", "Nineteen" };
            var tensMap = new[] { "Zero", "Ten", "Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety" };

            if (number < 20)
                words += unitsMap[number];
            else
            {
                words += tensMap[number / 10];
                if ((number % 10) > 0)
                    words += " " + unitsMap[number % 10];
            }
        }

        return words;
    }
    public string returnYearforSem(string cursem)
    {
        switch (cursem)
        {
            case "1":
            case "2":
                cursem = "1";
                break;
            case "3":
            case "4":
                cursem = "2";
                break;
            case "5":
            case "6":
                cursem = "3";
                break;
            case "7":
            case "8":
                cursem = "4";
                break;
            case "9":
            case "10":
                cursem = "5";
                break;
        }
        return cursem;
    }
    public string generateBarcode(string barCode)
    {
        string urlImg = Server.MapPath("~/BarCode/" + "barcodeimg" + DateTime.Now.ToString("ddMMyyyy") + DateTime.Now.ToString("HHMMss") + ".Jpeg");
        System.Web.UI.WebControls.Image imgBarCode = new System.Web.UI.WebControls.Image();
        using (Bitmap bitMap = new Bitmap(barCode.Length * 10, 20))
        {
            using (Graphics graphics = Graphics.FromImage(bitMap))
            {
                Font oFont = new Font("IDAutomationHC39M", 16);
                PointF point = new PointF(2f, 2f);
                SolidBrush blackBrush = new SolidBrush(Color.Black);
                SolidBrush whiteBrush = new SolidBrush(Color.White);
                graphics.FillRectangle(whiteBrush, 0, 0, bitMap.Width, bitMap.Height);
                graphics.DrawString("*" + barCode + "*", oFont, blackBrush, point);
            }
            using (MemoryStream ms = new MemoryStream())
            {
                //bitMap.Save(ms, System.Drawing.Imaging.ImageFormat.Png);
                //byte[] byteImage = ms.ToArray();

                //Convert.ToBase64String(byteImage);
                //imgBarCode.ImageUrl = "data:image/png;base64," + Convert.ToBase64String(byteImage);


                bitMap.Save(ms, System.Drawing.Imaging.ImageFormat.Jpeg);
                bitMap.Save(urlImg, System.Drawing.Imaging.ImageFormat.Jpeg);
            }
            return urlImg;
        }

    }
    public string generateReceiptNo()
    {
        try
        {
            string HeaderwiseQ = "select LinkValue from New_InsSettings where LinkName='HeaderWiseChallanorReceipt' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "' ";
            isHeaderwise = Convert.ToInt32(d2.GetFunction(HeaderwiseQ).Trim());
        }
        catch { isHeaderwise = 0; }
        try
        {
            string insqry1 = "select LinkValue from New_InsSettings where LinkName='ReceiptPrintFormat' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "'";
            int save1 = Convert.ToInt32(d2.GetFunction(insqry1));
            if (save1 == 5)
                return string.Empty;
        }
        catch { return string.Empty; }
        if (isHeaderwise == 0 || isHeaderwise == 2)
        {
            return getCommonReceiptNo();
        }
        else
        {
            return getHeaderwiseReceiptNo();
        }
    }
    private string getCommonReceiptNo()
    {
        string recno = string.Empty;
        lblaccid.Text = "";
        lstrcpt.Text = "";
        try
        {
            int receno = 0;
            string recacr = string.Empty;
            string recnoprev = string.Empty;

            string finYearid = d2.getCurrentFinanceYear(usercode, collegecode1);
            string accountid = "";// d2.GetFunction(" select acct_id from acctinfo where college_code ='" + collegecode1 + "'");
            lblaccid.Text = accountid;
            string secondreciptqurey = "SELECT RcptStNo from FM_FinCodeSettings where IsHeader=0 and FinYearFK=" + finYearid + " and CollegeCode=" + collegecode1 + " and FromDate = (select MAX(FromDate) from FM_FinCodeSettings where IsHeader=0 and FinYearFK=" + finYearid + " and CollegeCode=" + collegecode1 + ")";
            DataSet dsrecYr = new DataSet();
            dsrecYr = d2.select_method_wo_parameter(secondreciptqurey, "Text");
            if (dsrecYr.Tables.Count > 0 && dsrecYr.Tables[0].Rows.Count > 0)
            {
                recnoprev = Convert.ToString(dsrecYr.Tables[0].Rows[0][0]);
                if (recnoprev != "")
                {
                    int recno_cur = Convert.ToInt32(recnoprev);
                    receno = recno_cur;
                }

                string acronymquery = d2.GetFunction("SELECT RcptAcr from FM_FinCodeSettings where IsHeader=0 and FinYearFK=" + finYearid + " and CollegeCode=" + collegecode1 + " and FromDate = (select MAX(FromDate) from FM_FinCodeSettings where IsHeader=0 and FinYearFK=" + finYearid + " and CollegeCode=" + collegecode1 + ")");
                recacr = acronymquery;


                int size = Convert.ToInt32(d2.GetFunction("SELECT  RcptSize from FM_FinCodeSettings where IsHeader=0 and FinYearFK=" + finYearid + " and CollegeCode=" + collegecode1 + " and FromDate = (select MAX(FromDate) from FM_FinCodeSettings where IsHeader=0 and FinYearFK=" + finYearid + " and CollegeCode=" + collegecode1 + ")"));

                string recenoString = receno.ToString();

                if (size != recenoString.Length && size > recenoString.Length)
                {
                    while (size != recenoString.Length)
                    {
                        recenoString = "0" + recenoString;
                    }
                }
                recno = recacr + recenoString;

                lstrcpt.Text = Convert.ToString(receno);
            }

            return recno;
        }
        catch (Exception ex) { return recno; }
    }
    private string getHeaderwiseReceiptNo()
    {
        string recno = string.Empty;
        lblaccid.Text = "";
        lstrcpt.Text = "";
        string accountid = "";
        lblaccid.Text = accountid;
        try
        {
            int receno = 0;
            string recacr = string.Empty;
            string recnoprev = string.Empty;
            string isheaderFk = GetSelectedItemsValue(cbl_grpheader);

            string finYearid = d2.getCurrentFinanceYear(usercode, collegecode1);

            DataSet dsFinHedDet = d2.select_method_wo_parameter("select distinct HeaderSettingFk from FM_HeaderFinCodeSettingsDet hs,FM_HeaderFinCodeSettings s where s.HeaderSettingPK=hs.HeaderSettingFK and HeaderFK in (" + isheaderFk + ") and CollegeCode=" + collegecode1 + " and FinyearFK=" + finYearid + "", "Text");

            if (dsFinHedDet.Tables.Count > 0 && dsFinHedDet.Tables[0].Rows.Count == 1 && rbl_headerselect.SelectedIndex == 1)
            {
                string secondreciptqurey = "select * from FM_HeaderFinCodeSettings where HeaderSettingPK =" + Convert.ToString(dsFinHedDet.Tables[0].Rows[0][0]) + " and FinyearFK=" + finYearid + " and CollegeCode=" + collegecode1 + " ";
                DataSet dsrecYr = new DataSet();
                dsrecYr = d2.select_method_wo_parameter(secondreciptqurey, "Text");
                if (dsrecYr.Tables.Count > 0 && dsrecYr.Tables[0].Rows.Count > 0)
                {
                    recnoprev = Convert.ToString(dsrecYr.Tables[0].Rows[0]["RcptStNo"]);
                    if (recnoprev != "")
                    {
                        int recno_cur = Convert.ToInt32(recnoprev);
                        receno = recno_cur;
                    }
                    recacr = Convert.ToString(dsrecYr.Tables[0].Rows[0]["RcptAcr"]);

                    int size = Convert.ToInt32(dsrecYr.Tables[0].Rows[0]["Rcptsize"]);

                    string recenoString = receno.ToString();

                    if (size != recenoString.Length && size > recenoString.Length)
                    {
                        while (size != recenoString.Length)
                        {
                            recenoString = "0" + recenoString;
                        }
                    }
                    recno = recacr + recenoString;

                    lstrcpt.Text = Convert.ToString(receno);
                }
            }

            return recno;
        }
        catch (Exception ex) { return recno; }
    }
    public string generateChallanNo()
    {
        string recno = string.Empty;

        try
        {
            int receno = 0;
            string recacr = string.Empty;
            string recnoprev = string.Empty;

            string finYearid = d2.getCurrentFinanceYear(usercode, collegecode1);
            string accountid = "";// d2.GetFunction(" select acct_id from acctinfo where college_code ='" + collegecode1 + "'");

            string secondreciptqurey = "SELECT ChallanStNo from FM_FinCodeSettings where IsHeader=0 and FinYearFK=" + finYearid + " and CollegeCode=" + collegecode1 + " and FromDate = (select MAX(FromDate) from FM_FinCodeSettings where IsHeader=0 and FinYearFK=" + finYearid + " and CollegeCode=" + collegecode1 + ")";
            DataSet dsrecYr = new DataSet();
            dsrecYr = d2.select_method_wo_parameter(secondreciptqurey, "Text");
            if (dsrecYr.Tables[0].Rows.Count > 0)
            {
                recnoprev = Convert.ToString(dsrecYr.Tables[0].Rows[0][0]);
                if (recnoprev != "")
                {
                    int recno_cur = Convert.ToInt32(recnoprev);
                    receno = recno_cur;
                }

                string acronymquery = d2.GetFunction("SELECT ChallanAcr from FM_FinCodeSettings where IsHeader=0 and FinYearFK=" + finYearid + " and CollegeCode=" + collegecode1 + " and FromDate = (select MAX(FromDate) from FM_FinCodeSettings where IsHeader=0 and FinYearFK=" + finYearid + " and CollegeCode=" + collegecode1 + ")");
                recacr = acronymquery;

                int size = Convert.ToInt32(d2.GetFunction("SELECT  ChallanSize from FM_FinCodeSettings where IsHeader=0 and FinYearFK=" + finYearid + " and CollegeCode=" + collegecode1 + " and FromDate = (select MAX(FromDate) from FM_FinCodeSettings where IsHeader=0 and FinYearFK=" + finYearid + " and CollegeCode=" + collegecode1 + ")"));

                string recenoString = receno.ToString();

                if (size != recenoString.Length && size > recenoString.Length)
                {
                    while (size != recenoString.Length)
                    {
                        recenoString = "0" + recenoString;
                    }
                }
                recno = recacr + recenoString;

                Session["lastAccId"] = accountid;
                Session["lastCHlNO"] = receno;

            }

            return recno;
        }
        catch (Exception ex) { return recno; }
    }
    public string generateVendorCode()
    {
        string newitemcode = string.Empty;
        try
        {
            string selectquery = "select VenAcr,VenStNo,VenSize  from IM_CodeSettings  order by startdate desc";
            ds = d2.select_method_wo_parameter(selectquery, "Text");
            if (ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
            {
                string itemacronym = Convert.ToString(ds.Tables[0].Rows[0]["VenAcr"]);
                string itemstarno = Convert.ToString(ds.Tables[0].Rows[0]["VenStNo"]);
                string itemsize = Convert.ToString(ds.Tables[0].Rows[0]["VenSize"]);
                if (itemacronym.Trim() != "" && itemstarno.Trim() != "")
                {
                    selectquery = " select distinct top (1) VendorCode  from CO_VendorMaster where VendorCode like '" + Convert.ToString(itemacronym) + "%' order by VendorCode desc";
                    ds.Clear();
                    ds = d2.select_method_wo_parameter(selectquery, "Text");
                    if (ds.Tables[0].Rows.Count > 0)
                    {
                        string itemcode = Convert.ToString(ds.Tables[0].Rows[0]["VendorCode"]);
                        string itemacr = Convert.ToString(itemacronym);
                        int len = itemacr.Length;
                        itemcode = itemcode.Remove(0, len);
                        int len1 = Convert.ToString(itemcode).Length;
                        string newnumber = Convert.ToString((Convert.ToInt32(itemcode) + 1));
                        len = Convert.ToString(newnumber).Length;
                        len1 = len1 - len;
                        if (len1 == 2)
                        {
                            newitemcode = "00" + newnumber;
                        }
                        else if (len1 == 1)
                        {
                            newitemcode = "0" + newnumber;
                        }
                        else if (len1 == 3)
                        {
                            newitemcode = "000" + newnumber;
                        }
                        else if (len1 == 4)
                        {
                            newitemcode = "0000" + newnumber;
                        }
                        else if (len1 == 5)
                        {
                            newitemcode = "00000" + newnumber;
                        }
                        else if (len1 == 6)
                        {
                            newitemcode = "000000" + newnumber;
                        }
                        else
                        {
                            newitemcode = Convert.ToString(newnumber);
                        }
                        if (newitemcode.Trim() != "")
                        {
                            newitemcode = itemacr + "" + newitemcode;
                        }
                    }
                    else
                    {
                        string itemacr = Convert.ToString(itemstarno);
                        int len = itemacr.Length;
                        string items = Convert.ToString(itemsize);
                        int len1 = Convert.ToInt32(items);
                        int size = len1 - len;
                        if (size == 2)
                        {
                            newitemcode = "00" + itemstarno;
                        }
                        else if (size == 1)
                        {
                            newitemcode = "0" + itemstarno;
                        }
                        else if (size == 3)
                        {
                            newitemcode = "000" + itemstarno;
                        }
                        else if (size == 4)
                        {
                            newitemcode = "0000" + itemstarno;
                        }
                        else if (size == 5)
                        {
                            newitemcode = "00000" + itemstarno;
                        }
                        else if (size == 6)
                        {
                            newitemcode = "000000" + itemstarno;
                        }
                        else
                        {
                            newitemcode = Convert.ToString(itemstarno);
                        }
                        newitemcode = Convert.ToString(itemacronym) + "" + Convert.ToString(newitemcode);
                    }
                }
            }
        }
        catch (Exception ex) { newitemcode = string.Empty; }
        return newitemcode;
    }
    private string GetSelectedItemsValue(CheckBoxList cblSelected)
    {
        System.Text.StringBuilder sbSelected = new System.Text.StringBuilder();
        try
        {
            for (int sel = 0; sel < cblSelected.Items.Count; sel++)
            {
                if (cblSelected.Items[sel].Selected == true)
                {
                    if (sbSelected.Length == 0)
                    {
                        sbSelected.Append(Convert.ToString(cblSelected.Items[sel].Value));
                    }
                    else
                    {
                        sbSelected.Append("," + Convert.ToString(cblSelected.Items[sel].Value));
                    }
                }
            }
        }
        catch (Exception ex) { sbSelected.Clear(); }
        return sbSelected.ToString();
    }
    private string GetSelectedItemsValueAsString(CheckBoxList cblSelected)
    {
        System.Text.StringBuilder sbSelected = new System.Text.StringBuilder();
        try
        {
            for (int sel = 0; sel < cblSelected.Items.Count; sel++)
            {
                if (cblSelected.Items[sel].Selected == true)
                {
                    if (sbSelected.Length == 0)
                    {
                        sbSelected.Append(Convert.ToString(cblSelected.Items[sel].Value));
                    }
                    else
                    {
                        sbSelected.Append("','" + Convert.ToString(cblSelected.Items[sel].Value));
                    }
                }
            }
        }
        catch { sbSelected.Clear(); }
        return sbSelected.ToString();
    }
    private string GetSelectedItemsText(CheckBoxList cblSelected)
    {
        System.Text.StringBuilder sbSelected = new System.Text.StringBuilder();
        try
        {
            for (int sel = 0; sel < cblSelected.Items.Count; sel++)
            {
                if (cblSelected.Items[sel].Selected == true)
                {
                    if (sbSelected.Length == 0)
                    {
                        sbSelected.Append(Convert.ToString(cblSelected.Items[sel].Text));
                    }
                    else
                    {
                        sbSelected.Append("','" + Convert.ToString(cblSelected.Items[sel].Text));
                    }
                }
            }
        }
        catch { sbSelected.Clear(); }
        return sbSelected.ToString();
    }
    private List<string> GetSelectedItemsValueList(CheckBoxList cblSelected)
    {
        System.Collections.Generic.List<string> lsSelected = new System.Collections.Generic.List<string>();
        try
        {
            for (int list = 0; list < cblSelected.Items.Count; list++)
            {
                if (cblSelected.Items[list].Selected)
                {
                    lsSelected.Add(cblSelected.Items[list].Value);
                }
            }
        }
        catch { lsSelected.Clear(); }
        return lsSelected;
    }
    private List<string> GetSelectedItemsTextList(CheckBoxList cblSelected)
    {
        System.Collections.Generic.List<string> lsSelected = new System.Collections.Generic.List<string>();
        try
        {
            for (int list = 0; list < cblSelected.Items.Count; list++)
            {
                if (cblSelected.Items[list].Selected)
                {
                    lsSelected.Add(cblSelected.Items[list].Text);
                }
            }
        }
        catch { lsSelected.Clear(); }
        return lsSelected;
    }
    private List<string> GetItemsValueList(CheckBoxList cblItems)
    {
        System.Collections.Generic.List<string> lsItems = new System.Collections.Generic.List<string>();
        try
        {
            for (int list = 0; list < cblItems.Items.Count; list++)
            {
                lsItems.Add(cblItems.Items[list].Value);
            }
        }
        catch { lsItems.Clear(); }
        return lsItems;
    }
    private void CallCheckBoxChangedEvent(CheckBoxList cbl, CheckBox cb, TextBox tb, string dispString)
    {
        try
        {
            tb.Text = dispString;
            if (cb.Checked)
            {
                for (int i = 0; i < cbl.Items.Count; i++)
                {
                    cbl.Items[i].Selected = true;
                }
                tb.Text = dispString + "(" + cbl.Items.Count + ")";
            }
            else
            {
                for (int i = 0; i < cbl.Items.Count; i++)
                {
                    cbl.Items[i].Selected = false;
                }
            }
        }
        catch { }
    }
    private void CallCheckBoxListChangedEvent(CheckBoxList cbl, CheckBox cb, TextBox tb, string dispString)
    {
        try
        {
            cb.Checked = false;
            tb.Text = dispString;
            int count = 0;
            for (int i = 0; i < cbl.Items.Count; i++)
            {
                if (cbl.Items[i].Selected == true)
                {
                    count++;
                }
            }
            tb.Text = dispString + "(" + count + ")";
            if (count == cbl.Items.Count)
            {
                cb.Checked = true;
            }
        }
        catch { }
    }
    private void createLogo(string collCode)
    {
        try
        {
            string logoQ = "select logo1,logo2 from collinfo where college_code=" + collCode + "";
            DataSet dsLogo = d2.select_method_wo_parameter(logoQ, "Text");
            if (dsLogo.Tables.Count > 0 && dsLogo.Tables[0].Rows.Count > 0)
            {
                string logoname = Server.MapPath("~/FinanceLogo/Left_Logo" + collCode + ".jpeg");
                if (File.Exists(logoname))
                {
                    File.Delete(logoname);
                }
                if (!File.Exists(logoname))
                {
                    MemoryStream memoryStream = new MemoryStream();
                    byte[] file = (byte[])dsLogo.Tables[0].Rows[0]["logo1"];
                    memoryStream.Write(file, 0, file.Length);
                    if (file.Length > 0)
                    {
                        System.Drawing.Image imgx = System.Drawing.Image.FromStream(memoryStream, true, true);
                        System.Drawing.Image thumb = imgx.GetThumbnailImage(400, 400, null, IntPtr.Zero);
                        thumb.Save(logoname, System.Drawing.Imaging.ImageFormat.Jpeg);

                    }
                    memoryStream.Dispose();
                    memoryStream.Close();
                }
                logoname = Server.MapPath("~/FinanceLogo/Right_Logo" + collCode + ".jpeg");
                if (File.Exists(logoname))
                {
                    File.Delete(logoname);
                }
                if (!File.Exists(logoname))
                {
                    MemoryStream memoryStream = new MemoryStream();
                    byte[] file = (byte[])dsLogo.Tables[0].Rows[0]["logo2"];
                    memoryStream.Write(file, 0, file.Length);
                    if (file.Length > 0)
                    {
                        System.Drawing.Image imgx = System.Drawing.Image.FromStream(memoryStream, true, true);
                        System.Drawing.Image thumb = imgx.GetThumbnailImage(400, 400, null, IntPtr.Zero);
                        thumb.Save(logoname, System.Drawing.Imaging.ImageFormat.Jpeg);

                    }
                    memoryStream.Dispose();
                    memoryStream.Close();
                }
            }
        }
        catch (Exception ex) { }
    }
    private string getAppNoFromApplyn(string app_formno)
    {
        string appno = "0";
        appno = d2.GetFunction("select app_no from applyn where app_formno='" + app_formno + "'  and college_code='" + collegecode1 + "' ").Trim();
        return appno;
    }
    private byte StudentAppliedShorlistAdmit()
    {

        string Q = "select LinkValue from New_InsSettings where LinkName='StudentAppliedShorlistAdmit' and user_code ='" + usercode + "' --and college_code ='" + collegecode1 + "'";
        byte moveVal = 0;
        byte.TryParse(d2.GetFunction(Q.Trim()), out moveVal);
        return moveVal;
    }
    private static byte statStudentAppliedShorlistAdmit()
    {

        string Q = "select LinkValue from New_InsSettings where LinkName='StudentAppliedShorlistAdmit' and user_code ='" + usercodestat + "' --and college_code ='" + collegecodestat + "'";
        byte moveVal = 0;
        byte.TryParse(d22.GetFunction(Q.Trim()), out moveVal);
        return moveVal;
    }
    private string termDisplay(string cursem)
    {
        string Termdisp = d2.GetFunction("select LinkValue from New_InsSettings where LinkName='DisplayTermForChallan' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "' ").Trim();

        string linkvalue = d2.GetFunction("select LinkValue from New_InsSettings where linkname = 'Fee Yearwise' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "'");
        if (linkvalue.Trim() == "1")
        {
            if (Termdisp == "1")
            {
                try
                {
                    double cursemester = Convert.ToDouble(cursem);

                    if (cursemester % 2 == 1)
                    {
                        cursem = romanLetter(cursemester.ToString()) + " & " + romanLetter((cursemester + 1).ToString());
                    }
                    else
                    {
                        cursem = romanLetter((cursemester - 1).ToString()) + " & " + romanLetter(cursemester.ToString());
                    }
                }
                catch { }
                cursem = "Term : " + cursem;
            }
            else
            {
                cursem = "Year : " + romanLetter(returnYearforSem(cursem));
            }
        }
        else
        {
            if (Termdisp == "1")
            {
                cursem = "Term : " + romanLetter(cursem);
            }
            else
            {
                cursem = "Semester : " + romanLetter(cursem);
            }
        }
        return cursem;
    }
    private string recptHeader(string transcode)
    {
        string recptHeaders = string.Empty;
        try
        {
            DataSet dsHeaders = new DataSet();
            dsHeaders = d2.select_method_wo_parameter("select distinct HeaderName from fm_headermaster h,ft_findailytransaction d where h.headerpk=d.headerfk and d.TransCode='" + transcode + "'", "Text");
            if (dsHeaders.Tables.Count > 0 && dsHeaders.Tables[0].Rows.Count > 0)
            {
                StringBuilder sbHead = new StringBuilder();
                for (int head = 0; head < dsHeaders.Tables[0].Rows.Count; head++)
                {
                    if (sbHead.Length == 0)
                    {
                        sbHead.Append(Convert.ToString(dsHeaders.Tables[0].Rows[head][0]));
                    }
                    else
                    {
                        sbHead.Append("," + Convert.ToString(dsHeaders.Tables[0].Rows[head][0]));
                    }
                }
                recptHeaders = sbHead.ToString();
            }
        }
        catch { recptHeaders = string.Empty; }
        return recptHeaders;
    }
    private string recptHeaderAl(ArrayList alHeaders)
    {
        string recptHeaders = string.Empty;
        try
        {

            if (alHeaders.Count > 0)
            {
                StringBuilder sbHead = new StringBuilder();
                for (int head = 0; head < alHeaders.Count; head++)
                {
                    if (sbHead.Length == 0)
                    {
                        sbHead.Append(Convert.ToString(alHeaders[head]));
                    }
                    else
                    {
                        sbHead.Append("," + Convert.ToString(alHeaders[head]));
                    }
                }
                recptHeaders = sbHead.ToString();
            }
        }
        catch { recptHeaders = string.Empty; }
        return recptHeaders;
    }
    private string studentCollType(string appNo, bool reg)
    {
        string type = string.Empty;
        string value;
        if (reg)
        {
            value = d2.GetFunction("select c.type from registration a,Degree d,course c where a.degree_code=d.degree_code and c.course_id=d.course_id and a.app_no='" + appNo + "'").Trim();
        }
        else
        {
            value = d2.GetFunction("select c.type from applyn a,Degree d,course c where a.degree_code=d.degree_code and c.course_id=d.course_id and a.app_no='" + appNo + "'").Trim();
        }
        if (value != "0")
            type = value;
        return type;
    }


    //Admission Number Generation while saving receipt
    private bool getAdmGenOnRcpt(string collegeCode, string userCode, ref string batch)
    {
        bool isAdmGenOnRcpt = false;
        try
        {
            string[] prevVal = d2.GetFunction("select LinkValue from New_InsSettings where LinkName='AdmissionNoGenerateOnReceipt' and college_code ='" + collegeCode + "' and user_code='" + userCode + "' ").Trim().Split(',');
            if (prevVal.Length == 2)
            {
                if (prevVal[0] == "1")
                {
                    isAdmGenOnRcpt = true;
                    batch = prevVal[1];
                }
            }
        }
        catch { }

        return isAdmGenOnRcpt;
    }
    private bool isAdmNoNotGenerated(string appNo, string batch, ref string app_formNo)
    {
        bool isNotGenerated = false;
        try
        {
            app_formNo = d2.GetFunction("select a.app_formno,a.app_no,a.batch_year from applyn a where isnull(a.is_enroll,0) <> '2' and a.app_no = '" + appNo + "'  and a.batch_year='" + batch + "'  and a.college_code='" + collegecode1 + "'").Trim();
            if (app_formNo != string.Empty && app_formNo != "0")
            {
                isNotGenerated = true;
            }
        }
        catch { }
        return isNotGenerated;
    }
    protected double collegewiseapplicationRights()
    {
        double RightsCode = 0;
        double.TryParse(Convert.ToString(d2.GetFunction("select linkvalue from New_InsSettings where LinkName='CollegewiseAdmissionNoRights' and user_code ='" + usercode + "' and college_code ='" + collegecode1 + "'")), out RightsCode);
        return RightsCode;
    }
    private string generateAdmissionNo(string collegecode, string degreecode, string ddl_batch)
    {
        string orginalapplication_number = "";
        try
        {
            Hashtable hat = new Hashtable();
            hat.Add(1, "0");
            hat.Add(2, "00");
            hat.Add(3, "000");
            hat.Add(4, "0000");
            hat.Add(5, "00000");
            hat.Add(6, "000000");
            hat.Add(7, "0000000");
            hat.Add(8, "00000000");
            hat.Add(9, "000000000");
            hat.Add(10, "0000000000");
            bool check = false;
            int application_No = 0;
            string appCodetemp = string.Empty;
            string selectquery = string.Empty;
            if (collegewiseapplicationRights() == 1)
            {
                appCodetemp = d2.GetFunction("select appcode from code_generation where  batch_year='" + ddl_batch + "' and college_code='" + collegecode + "' and app_code_flag ='1' and isnull(iscollege,'0')='1'");
                if (appCodetemp.Trim() == "0" || string.IsNullOrEmpty(appCodetemp)) //start Addd by aruna 29apr2017
                {
                    string startwith = d2.GetFunction("select app_startwith from code_generation where  batch_year='" + ddl_batch + "' and college_code='" + collegecode + "' and app_code_flag ='1' and isnull(iscollege,'0')='1'");
                    selectquery = "select top 1 r.roll_admit  from Registration r,applyn a where  a.app_no=r.App_No and isnull(a.is_enroll,0) = '2' and  r.roll_admit <>''  and r.batch_year='" + ddl_batch + "'  and r.college_code='" + collegecode + "' and ISNUMERIC(r.roll_admit) = 1 and  CAST(r.roll_admit AS NVARCHAR(50))>=" + startwith + "  order by r.roll_admit desc";
                } //end Addd by aruna 29apr2017
                else
                {
                    selectquery = "select top 1 r.roll_admit  from Registration r,applyn a where  a.app_no=r.App_No and isnull(a.is_enroll,0) = '2' and  r.roll_admit <>''  and r.batch_year='" + ddl_batch + "'  and r.college_code='" + collegecode + "' order by r.roll_admit desc";
                }
                selectquery = selectquery + " select appcode,app_startwith,app_serial from code_generation where  batch_year='" + ddl_batch + "' and college_code='" + collegecode + "'  and app_code_flag ='1' and isnull(iscollege,'0')='1'";
            }
            else
            {
                appCodetemp = d2.GetFunction("select appcode from code_generation where  batch_year='" + ddl_batch + "' and degree_code='" + degreecode + "' and college_code='" + collegecode + "' and app_code_flag ='1'");
                selectquery = "select top 1 r.roll_admit  from Registration r,applyn a where  a.app_no=r.App_No and isnull(a.is_enroll,0) = '2' and  r.roll_admit <>'' and r.roll_admit like '%" + appCodetemp + "%' and r.batch_year='" + ddl_batch + "' and r.degree_code='" + degreecode + "' and r.college_code='" + collegecode + "' order by r.roll_admit desc";
                selectquery = selectquery + " select appcode,app_startwith,app_serial from code_generation where  batch_year='" + ddl_batch + "' and degree_code='" + degreecode + "' and college_code='" + collegecode + "'  and app_code_flag ='1'";
            }
            ds.Clear();
            ds = d2.select_method_wo_parameter(selectquery, "Text");
            if (ds.Tables[0].Rows.Count > 0)
            {
                // application_No = Convert.ToInt32(ds.Tables[0].Rows[0][0]);
                string applno = Convert.ToString(ds.Tables[0].Rows[0][0]);
                if (ds.Tables[1].Rows.Count > 0)
                {
                    string appcode = Convert.ToString(ds.Tables[1].Rows[0]["appcode"]);
                    string appsiz2 = Convert.ToString(ds.Tables[1].Rows[0]["app_serial"]);
                    int len = appcode.Length;
                    applno = applno.Remove(0, len);
                    string newnumber = Convert.ToString((Convert.ToInt32(applno) + 1));
                    int val = newnumber.Length;
                    if (val == Convert.ToInt32(appsiz2))
                        orginalapplication_number = appcode + "" + newnumber;
                    else
                    {
                        int remain = Convert.ToInt32(appsiz2) - val;
                        string addnumber = Convert.ToString(hat[remain]);
                        addnumber = addnumber + "" + newnumber;
                        orginalapplication_number = appcode + "" + addnumber;
                    }
                }
                else
                    check = true;
            }
            else
                check = true;

            if (check && ds.Tables.Count > 1 && ds.Tables[1].Rows.Count > 0)
            {
                string appcode = Convert.ToString(ds.Tables[1].Rows[0]["appcode"]);
                string appsiz2 = Convert.ToString(ds.Tables[1].Rows[0]["app_startwith"]);
                int len = appsiz2.Length;
                if (len == Convert.ToInt32(ds.Tables[1].Rows[0]["app_serial"]))
                {
                    orginalapplication_number = appcode + "" + appsiz2;
                }
                else
                {
                    int remain = Convert.ToInt32(ds.Tables[1].Rows[0]["app_serial"]) - len;
                    string addnumber = Convert.ToString(hat[remain]);
                    addnumber = addnumber + "" + appsiz2;
                    orginalapplication_number = appcode + "" + addnumber;
                }
            }
        }
        catch { }
        return orginalapplication_number;
    }
    //************************************************************//
    //     Code Ended by Idhris - Last modified  10/12/2016       //
    //************************************************************//  
    private double retBalanceOld(string appNo)
    {
        double ovBalAMt = 0;
        if (BalanceType == 1)
        {
            double.TryParse(d2.GetFunction(" select sum(isnull(totalAmount,0)-isnull(paidAmount,0)) as BalanceAmt from ft_feeallot where app_no =" + appNo + ""), out ovBalAMt);
        }
        return ovBalAMt;
    }


    //****************************************** 23-08-2016
    #region for For Focus Go Button
    protected void ddl_ledgeSearch_Change(object sender, EventArgs e)
    {
        setSearchHeaders();
        //this.Form.DefaultButton = "btn_ledgesearch";
    }
    #endregion
    protected string getMonth(string monthcode)
    {
        string Month = string.Empty;
        try
        {
            switch (monthcode)
            {
                case "1":
                    Month = "JAN";
                    break;
                case "2":
                    Month = "FEB";
                    break;
                case "3":
                    Month = "MAR";
                    break;
                case "4":
                    Month = "APR";
                    break;
                case "5":
                    Month = "MAY";
                    break;
                case "6":
                    Month = "JUN";
                    break;
                case "7":
                    Month = "JUL";
                    break;
                case "8":
                    Month = "AUG";
                    break;
                case "9":
                    Month = "SEP";
                    break;
                case "10":
                    Month = "OCT";
                    break;
                case "11":
                    Month = "NOV";
                    break;
                case "12":
                    Month = "DEC";
                    break;
                default:
                    Month = "-";
                    break;

            }
        }
        catch { }
        return Month;
    }
    public bool admissionNoGeneration()
    {
        bool SetFlag = false;
        try
        {
            string value = d2.GetFunction("select value from Master_Settings where settings ='Admission No Rights' and usercode ='" + usercode + "'");
            if (value.Trim() == "1")
            {
                SetFlag = true;
            }
        }
        catch { }
        return SetFlag;
    }
    //added by sudhagar 08-12-2016

    //Scheme Admission
    #region Scheme Admission Settings added by Idhris 28-12-2016
    private void showSchemeSettings(string collegecode, string usercode)
    {
        if (d2.GetFunction("select LinkValue from New_InsSettings where LinkName='ShowSchemeSettings' and user_code ='" + usercode + "' -- and college_code ='" + collegecode + "'").Trim() == "1")
        {
            lnkOpenSchemeSettings.Visible = false;
        }
        else
        {
            lnkOpenSchemeSettings.Visible = false;
        }
    }
    string collegecode1Scheme = string.Empty;
    static string clgcodeScheme = string.Empty;
    static string btyrScheme = string.Empty;

    ReuasableMethods reuse = new ReuasableMethods();

    protected void lnkOpenSchemeSettings_OnClick(object sender, EventArgs e)
    {
        //  divSchemeSettings.Visible = true;
        divSchemeSettings.Attributes.Add("Style", "width: 100%; margin-top: 2%; height: 60em;display:block;");

        //setLabelText();
        //bindcollegeScheme();
        //if (ddlcollegeScheme.Items.Count > 0)
        //{
        //    collegecode1Scheme = Convert.ToString(ddlcollegeScheme.SelectedItem.Value);
        //    clgcodeScheme = Convert.ToString(ddlcollegeScheme.SelectedItem.Value);
        //}       
    }
    protected void imgSchemeSettingsClose_Click(object sender, EventArgs e)
    {
        // divSchemeSettings.Visible = false;
        divSchemeSettings.Attributes.Add("Style", "display:none;");
    }
    protected void bindcollegeScheme()
    {
        ddlcollegeScheme.Items.Clear();
        reuse.bindCollegeToDropDown(usercode, ddlcollegeScheme);
    }
    #region ddl reason
    protected void ddl_type_SelectedIndexChanged(object sender, EventArgs e)
    {

    }
    protected void btnplus_Click(object sender, EventArgs e)
    {
        plusdivScheme.Visible = true;
        panel_addgroupScheme.Visible = true;
        lbl_addgroupScheme.Text = "Scheme";
        lblerrSchemeor.Visible = false;
    }
    protected void btnminus_Click(object sender, EventArgs e)
    {
        if (ddl_reasonScheme.SelectedIndex == -1)
        {
            imgdiv2Scheme.Visible = true;
            lbl_alertScheme.Text = "No records found";
        }
        else if (ddl_reasonScheme.SelectedIndex == 0)
        {
            imgdiv2Scheme.Visible = true;
            lbl_alertScheme.Text = "Select any record";
        }
        else if (ddl_reasonScheme.SelectedIndex != 0)
        {
            btn_delScheme.Visible = true;
            btn_okScheme.Visible = true;
            lbl_delScheme.Text = "Do You Want Delete The Record";
            alertdelScheme.Visible = true;
            lbl_delScheme.Visible = true;
            btn_okScheme.Text = "Cancel";
        }
        else
        {
            imgdiv2Scheme.Visible = true;
            lbl_alertScheme.Text = "No records found";
        }
    }
    public void btn_delScheme_Click(object sender, EventArgs e)
    {
        if (ddl_reasonScheme.SelectedIndex != 0)
        {
            string sql = "delete from textvaltable where TextCode='" + ddl_reasonScheme.SelectedItem.Value.ToString() + "' and TextCriteria='Schm' and college_code='" + collegecode1Scheme + "' ";
            int delete = d2.update_method_wo_parameter(sql, "TEXT");
            if (delete != 0)
            {

                alertdelScheme.Visible = true;
                btn_delScheme.Visible = false;
                btn_okScheme.Visible = true;
                lbl_delScheme.Text = "Deleted Sucessfully";
                lbl_delScheme.Visible = true;
                btn_okScheme.Text = "OK";
            }
            else
            {
                alertdelScheme.Visible = false;
                imgdiv2Scheme.Visible = true;
                lbl_alertScheme.Text = "No records found";
            }

            loaddescScheme();
        }

    }
    public void btn_okScheme_Click(object sender, EventArgs e)
    {
        alertdelScheme.Visible = false;
        lbl_delScheme.Visible = false;
        btn_okScheme.Visible = false;

    }
    public void loaddescScheme()
    {
        ddl_reasonScheme.Items.Clear();
        ds.Tables.Clear();
        string sql = "select TextCode,TextVal from TextValTable where TextCriteria ='Schm' and college_code ='" + collegecode1Scheme + "'";
        ds = d2.select_method_wo_parameter(sql, "TEXT");
        if (ds.Tables[0].Rows.Count > 0)
        {
            ddl_reasonScheme.DataSource = ds;
            ddl_reasonScheme.DataTextField = "TextVal";
            ddl_reasonScheme.DataValueField = "TextCode";
            ddl_reasonScheme.DataBind();
            ddl_reasonScheme.Items.Insert(0, new ListItem("--Select--", "0"));
        }
        else
        {
            ddl_reasonScheme.Items.Insert(0, new ListItem("--Select--", "0"));
        }

    }
    protected void btn_addgroup_Click(object sender, EventArgs e)
    {
        try
        {
            if (txt_addgroupScheme.Text != "")
            {
                string sql = "if exists ( select * from TextValTable where TextVal ='" + txt_addgroupScheme.Text + "' and TextCriteria ='Schm' and college_code ='" + collegecode1Scheme + "') update TextValTable set TextVal ='" + txt_addgroupScheme.Text + "' where TextVal ='" + txt_addgroupScheme.Text + "' and TextCriteria ='Schm' and college_code ='" + collegecode1Scheme + "' else insert into TextValTable (TextVal,TextCriteria,college_code) values ('" + txt_addgroupScheme.Text + "','Schm','" + collegecode1Scheme + "')";
                int insert = d2.update_method_wo_parameter(sql, "TEXT");
                if (insert != 0)
                {
                    imgdiv2Scheme.Visible = true;
                    lbl_alertScheme.Text = "Saved sucessfully";
                    txt_addgroupScheme.Text = "";
                    plusdivScheme.Visible = false;
                    panel_addgroupScheme.Visible = false;
                }
                loaddescScheme();
            }
            else
            {
                imgdiv2Scheme.Visible = true;
                lbl_alertScheme.Text = "Enter the description";
            }
        }

        catch
        {
        }
    }
    protected void btn_exitaddgroup_Click(object sender, EventArgs e)
    {
        plusdivScheme.Visible = false;
        panel_addgroupScheme.Visible = false;
        txt_addgroupScheme.Text = "";
    }
    #endregion

    protected void btnadmitScheme_Click(object sender, EventArgs e)
    {
        if (radApplNo.Checked == true)
        {
            admitDetailsScheme();
            // ClearScheme();
        }
        else if (radAdmNo.Checked == true)
        {
            RollAdmitDetails();
            // ClearScheme();
        }
    }

    protected void admitDetailsScheme()
    {
        bool save = false;
        string applno = Convert.ToString(txtapplScheme.Text);
        string appNo = Convert.ToString(lbappnoScheme.Text);
        string degCode = Convert.ToString(lbldegreeScheme.Text);
        string Year = Convert.ToString(lbyearScheme.Text);
        string collegecode = Convert.ToString(lblclgSchemecode.Text);
        string Scheme = string.Empty;
        if (ddl_reasonScheme.Items.Count > 0 && ddl_reasonScheme.SelectedItem.Text != "--Select--")
            Scheme = Convert.ToString(ddl_reasonScheme.SelectedItem.Value);
        double Amount = 0;
        double.TryParse(Convert.ToString(txtamountScheme.Text), out Amount);
        string admissionNo = string.Empty;
        if (cbincadmisScheme.Checked)
            admissionNo = Convert.ToString(txtadmnoScheme.Text);

        DateTime schemeDt = Convert.ToDateTime(txt_schmdate.Text.Split('/')[1] + "/" + txt_schmdate.Text.Split('/')[0] + "/" + txt_schmdate.Text.Split('/')[2]);
        if (validation(applno, degCode, Year, Scheme, Amount, admissionNo))
        {
            save = admitToRegistration(appNo, collegecode, degCode, Scheme, Amount, ref admissionNo, schemeDt);
            if (save == true)
            {
                // ClearScheme();
                txt_schmdate.Text = DateTime.Now.ToString("dd/MM/yyyy");
                txtapplScheme.Text = string.Empty;
                tddet.Attributes.Add("Style", "display:none;");
                imgdiv2Scheme.Visible = true;
                lbl_alertScheme.Text = "Admitted Successfully. Your Admission No: " + admissionNo + "";
                divSchemeSettings.Attributes.Add("Style", "display:block;");
            }
        }
        else
        {
            imgdiv2Scheme.Visible = true;
            lbl_alertScheme.Text = "Please Fill The All Field";
        }

    }

    private bool admitToRegistration(string appNo, string collegecode, string degCode, string Scheme, double Amount, ref string rolladmit, DateTime schemeDt)
    {
        bool blAppNo = false;
        try
        {
            #region registration
            //Admit               
            string stud_name = string.Empty;
            string app_fromno = string.Empty;
            string batchYr = string.Empty;
            string Mode = string.Empty;
            string seattype = string.Empty;
            string cursem = string.Empty;
            string selQ = "select seattype,stud_name,app_formno,batch_year,mode,current_semester from applyn where app_no ='" + appNo + "'";
            DataSet dsval = d2.select_method_wo_parameter(selQ, "Text");
            if (dsval.Tables.Count > 0 && dsval.Tables[0].Rows.Count > 0)
            {
                seattype = Convert.ToString(dsval.Tables[0].Rows[0]["seattype"]);
                stud_name = Convert.ToString(dsval.Tables[0].Rows[0]["stud_name"]);
                app_fromno = Convert.ToString(dsval.Tables[0].Rows[0]["app_formno"]);
                batchYr = Convert.ToString(dsval.Tables[0].Rows[0]["batch_year"]);
                Mode = Convert.ToString(dsval.Tables[0].Rows[0]["mode"]);
                cursem = Convert.ToString(dsval.Tables[0].Rows[0]["current_semester"]);
            }
            if (string.IsNullOrEmpty(Mode))
                Mode = "1";

            string approve = " update applyn set Admission_Status='1',selection_status='1',is_enroll='2',seattype='" + seattype + "',AdmitedDate='" + DateTime.Now.ToString("MM/dd/yyyy") + "' where app_no ='" + Convert.ToString(appNo) + "'";
            int a = d2.update_method_wo_parameter(approve, "text");

            if (!cbincadmisScheme.Checked)
            {
                if (admissionNoGenerationScheme() == 1)
                    rolladmit = generateAdmissionNo(collegecode, degCode, batchYr);
                else
                    rolladmit = app_fromno;
            }
            if (rolladmit.Trim() == "0" || string.IsNullOrEmpty(rolladmit))
                rolladmit = app_fromno;

            string regEntry = "  if exists(select * from Registration where App_No='" + appNo + "' and isnull(IsSchemeAdmission,'0')='1')  delete from Registration where App_No='" + appNo + "' and isnull(IsSchemeAdmission,'0')='1' insert into Registration (App_No,Adm_Date,Roll_Admit,Roll_No,RollNo_Flag,Reg_No,Stud_Name,Batch_Year,degree_code,college_code,CC,DelFlag,Exam_Flag,Current_Semester,mode,IsSchemeAdmission,IsSchemeCode,IsSchemeAmount,SchemeDate)values('" + appNo + "','" + System.DateTime.Now.ToString("yyy/MM/dd") + "','" + rolladmit + "','" + app_fromno + "','1','" + app_fromno + "','" + stud_name + "','" + batchYr + "','" + degCode + "','" + collegecode + "','0','0','OK','" + cursem + "','" + Mode + "','1','" + Scheme + "','" + Amount + "','" + schemeDt + "')";
            int s = d2.update_method_wo_parameter(regEntry, "Text");

            deleteFeeData(appNo);
            blAppNo = true;
            #endregion
        }
        catch { }
        return blAppNo;
    }
    //Added by Idhris 30-12-2016
    private void deleteFeeData(string appNo)
    {
        try
        {
            string delQ = "if exists (select top 1 App_No from FT_FeeAllot where App_No='" + appNo + "') delete  from FT_FeeAllot where App_No='" + appNo + "'; if exists (select top 1 App_No from FT_FinDailyTransaction where App_No = '" + appNo + "') delete  from FT_FinDailyTransaction where App_No='" + appNo + "'; if exists (select top 1 App_No from FT_ChallanDet where App_No = '" + appNo + "') delete  from FT_ChallanDet where App_No='" + appNo + "';";
            d2.update_method_wo_parameter(delQ, "Text");
        }
        catch { }
    }

    protected int admissionNoGenerationScheme()
    {
        int admitValue = 0;
        int.TryParse(Convert.ToString(d2.GetFunction("select value from Master_Settings where settings ='Admission No Rights' and usercode ='" + usercode + "'")), out admitValue);
        return admitValue;
    }

    private bool validation(string applno, string degCode, string Year, string Scheme, double Amount, string admissionNo)
    {
        bool check = false;
        if (!string.IsNullOrEmpty(applno) && !string.IsNullOrEmpty(degCode) && !string.IsNullOrEmpty(Year) && !string.IsNullOrEmpty(Scheme) && Amount != 0)
        {
            if (cbincadmisScheme.Checked)
            {
                if (!string.IsNullOrEmpty(admissionNo))
                    check = true;
                else
                    check = false;
            }
            else
                check = true;
        }
        return check;

    }

    #region admission no generation
    protected double collegewiseapplicationRights(string collegecode)
    {
        double RightsCode = 0;
        double.TryParse(Convert.ToString(d2.GetFunction("select linkvalue from New_InsSettings where LinkName='CollegewiseAdmissionNoRights' and user_code ='" + usercode + "' and college_code ='" + collegecode + "'")), out RightsCode);
        return RightsCode;
    }

    //private string generateAdmissionNo(string collegecode, string degreecode, string ddl_batch)
    //{
    //    string orginalapplication_number = "";
    //    try
    //    {
    //        Hashtable hat = new Hashtable();
    //        hat.Add(1, "0");
    //        hat.Add(2, "00");
    //        hat.Add(3, "000");
    //        hat.Add(4, "0000");
    //        hat.Add(5, "00000");
    //        hat.Add(6, "000000");
    //        hat.Add(7, "0000000");
    //        hat.Add(8, "00000000");
    //        hat.Add(9, "000000000");
    //        hat.Add(10, "0000000000");
    //        bool check = false;
    //        int application_No = 0;
    //        string appCodetemp = string.Empty;
    //        string selectquery = string.Empty;
    //        if (collegewiseapplicationRights(collegecode) == 1)
    //        {
    //            appCodetemp = d2.GetFunction("select appcode from code_generation where  batch_year='" + ddl_batch + "' and college_code='" + collegecode + "' and app_code_flag ='1' and isnull(iscollege,'0')='1'");
    //            selectquery = "select top 1 r.roll_admit  from Registration r,applyn a where  a.app_no=r.App_No and isnull(a.is_enroll,0) = '2' and  r.roll_admit <>'' and r.roll_admit like '%" + appCodetemp + "%' and r.batch_year='" + ddl_batch + "'  and r.college_code='" + collegecode + "' order by r.roll_admit desc";

    //            selectquery = selectquery + " select appcode,app_startwith,app_serial from code_generation where  batch_year='" + ddl_batch + "' and college_code='" + collegecode + "'  and app_code_flag ='1' and isnull(iscollege,'0')='1'";
    //        }
    //        else
    //        {
    //            appCodetemp = d2.GetFunction("select appcode from code_generation where  batch_year='" + ddl_batch + "' and degree_code='" + degreecode + "' and college_code='" + collegecode + "' and app_code_flag ='1'");
    //            selectquery = "select top 1 r.roll_admit  from Registration r,applyn a where  a.app_no=r.App_No and isnull(a.is_enroll,0) = '2' and  r.roll_admit <>'' and r.roll_admit like '%" + appCodetemp + "%' and r.batch_year='" + ddl_batch + "' and r.degree_code='" + degreecode + "' and r.college_code='" + collegecode + "' order by r.roll_admit desc";
    //            selectquery = selectquery + " select appcode,app_startwith,app_serial from code_generation where  batch_year='" + ddl_batch + "' and degree_code='" + degreecode + "' and college_code='" + collegecode + "'  and app_code_flag ='1'";
    //        }
    //        ds.Clear();
    //        ds = d2.select_method_wo_parameter(selectquery, "Text");
    //        if (ds.Tables[0].Rows.Count > 0)
    //        {
    //            // application_No = Convert.ToInt32(ds.Tables[0].Rows[0][0]);
    //            string applno = Convert.ToString(ds.Tables[0].Rows[0][0]);
    //            if (ds.Tables[1].Rows.Count > 0)
    //            {
    //                string appcode = Convert.ToString(ds.Tables[1].Rows[0]["appcode"]);
    //                string appsiz2 = Convert.ToString(ds.Tables[1].Rows[0]["app_serial"]);
    //                int len = appcode.Length;
    //                applno = applno.Remove(0, len);
    //                string newnumber = Convert.ToString((Convert.ToInt32(applno) + 1));
    //                int val = newnumber.Length;
    //                if (val == Convert.ToInt32(appsiz2))
    //                    orginalapplication_number = appcode + "" + newnumber;
    //                else
    //                {
    //                    int remain = Convert.ToInt32(appsiz2) - val;
    //                    string addnumber = Convert.ToString(hat[remain]);
    //                    addnumber = addnumber + "" + newnumber;
    //                    orginalapplication_number = appcode + "" + addnumber;
    //                }
    //            }
    //            else
    //                check = true;
    //        }
    //        else
    //            check = true;

    //        if (check && ds.Tables.Count > 1 && ds.Tables[1].Rows.Count > 0)
    //        {
    //            string appcode = Convert.ToString(ds.Tables[1].Rows[0]["appcode"]);
    //            string appsiz2 = Convert.ToString(ds.Tables[1].Rows[0]["app_startwith"]);
    //            int len = appsiz2.Length;
    //            if (len == Convert.ToInt32(ds.Tables[1].Rows[0]["app_serial"]))
    //            {
    //                orginalapplication_number = appcode + "" + appsiz2;
    //            }
    //            else
    //            {
    //                int remain = Convert.ToInt32(ds.Tables[1].Rows[0]["app_serial"]) - len;
    //                string addnumber = Convert.ToString(hat[remain]);
    //                addnumber = addnumber + "" + appsiz2;
    //                orginalapplication_number = appcode + "" + addnumber;
    //            }
    //        }
    //    }
    //    catch { }
    //    return orginalapplication_number;
    //}
    #endregion

    protected void btnclearScheme_Click(object sender, EventArgs e)
    {
        ClearScheme();
    }
    private void ClearScheme()
    {
        txtapplScheme.Text = string.Empty;
        lbstudnameScheme.Text = string.Empty;
        lbappnoScheme.Text = string.Empty;
        lbscltypeScheme.Text = string.Empty;
        lbstandScheme.Text = string.Empty;
        lbldegreeScheme.Text = string.Empty;
        lbyearScheme.Text = string.Empty;
        lblclgSchemecode.Text = string.Empty;
        ddl_reasonScheme.SelectedIndex = 0;
        txtamountScheme.Text = string.Empty;
        txtadmnoScheme.Text = string.Empty;
        btyrScheme = string.Empty;
        //tddet.Visible = false;
        tddet.Attributes.Add("Style", "display:none;");
    }
    protected void btn_errorcloseScheme_Click(object sender, EventArgs e)
    {
        imgdiv2Scheme.Visible = false;
        divSchemeSettings.Attributes.Add("Style", "display:block;");
    }
    //added by sudhagar 27.12.2016
    protected void cbincamdis_Changed(object sender, EventArgs e)
    {
        if (cbincadmisScheme.Checked)
        {
            txtadmnoScheme.Enabled = true;
            txtadmnoScheme.Text = string.Empty;
            divSchemeSettings.Attributes.Add("Style", "display:block;");
        }
        else
        {
            txtadmnoScheme.Enabled = false;
            txtadmnoScheme.Text = string.Empty;
            divSchemeSettings.Attributes.Add("Style", "display:block;");
        }
    }

    private void setLabelText()
    {
        string grouporusercode = string.Empty;
        if (Session["group_code"] != null && (Convert.ToString(Session["group_code"]).Trim() != "") && (Convert.ToString(Session["group_code"]).Trim() != "0") && (Convert.ToString(Session["group_code"]).Trim() != "-1"))
        {
            grouporusercode = " group_code=" + Convert.ToString(Session["group_code"]).Trim() + "";
        }
        else if (Session["usercode"] != null)
        {
            grouporusercode = " usercode=" + Convert.ToString(Session["usercode"]).Trim() + "";
        }
        List<Label> lbl = new List<Label>();
        List<byte> fields = new List<byte>();
        lbl.Add(lblclgScheme);
        fields.Add(0);
        lbl.Add(lbl_college);
        fields.Add(0);
        lbl.Add(lbsem);
        fields.Add(4);
        new HeaderLabelText().setLabels(grouporusercode, ref lbl, fields);
    }

    [WebMethod]
    public static string applicationNo(string applno)
    {
        string Value = "1";
        try
        {
            if (!string.IsNullOrEmpty(applno) && !string.IsNullOrEmpty(btyrScheme))
            {
                DAccess2 da = new DAccess2();
                string applValue = da.GetFunction(" select top 1 r.roll_admit  from Registration r,applyn a where  a.app_no=r.App_No and isnull(a.is_enroll,0) = '2' and  r.roll_admit <>'' and r.roll_admit like '%" + applno + "%' and r.batch_year='" + btyrScheme + "'  and r.college_code='" + clgcodeScheme + "' order by r.roll_admit desc");
                if (string.IsNullOrEmpty(applValue) || applValue == "0" || applValue == "-1")
                    Value = "0";
            }
            else
                Value = "2";
        }
        catch (SqlException ex) { Value = "error" + ex.ToString(); }
        return Value;
    }
    #endregion

    //added bu sudhagar 
    protected void loadFineFeecategory()
    {
        ddlfinefee.Items.Clear();
        if (cb_sem.Checked)
        {
            for (int i = 0; i < cbl_sem.Items.Count; i++)
            {
                ddlfinefee.Items.Add(new ListItem(cbl_sem.Items[i].Text, cbl_sem.Items[i].Value));
            }
        }
        else
        {
            for (int i = 0; i < cbl_sem.Items.Count; i++)
            {
                if (cbl_sem.Items[i].Selected)
                {
                    ddlfinefee.Items.Add(new ListItem(cbl_sem.Items[i].Text, cbl_sem.Items[i].Value));
                }
            }
        }
    }

    protected void Clear()
    {
        if (rbl_rollnoNew.SelectedIndex == 0)
        {
            txt_rollno.Text = string.Empty;
            txt_mblno.Text = string.Empty;
            txt_name.Text = string.Empty;
            txt_dept.Text = string.Empty;
            txtsec.Text = "";
            txt_SeatType.Text = string.Empty;
            txt_FatherName.Text = string.Empty;
        }
        else if (rbl_rollnoNew.SelectedIndex == 1)
        {
            txtroll_staff.Text = string.Empty;
            txtname_staff.Text = string.Empty;
            txtDept_staff.Text = string.Empty;
        }
        else if (rbl_rollnoNew.SelectedIndex == 2)
        {
        }
        else if (rbl_rollnoNew.SelectedIndex == 3)
        {
            txtroll_other.Text = string.Empty;
            txtname_other.Text = string.Empty;
            txt_otherMobile.Text = string.Empty;
            txtAdd1_Other.Text = string.Empty;
            txtAdd2_Other.Text = string.Empty;

        }
        txt_totamt.Text = "0";
        txt_paidamt.Text = "0";
        txt_balamt.Text = "0";
        Txt_amt.Text = string.Empty;
        txt_remark.Text = string.Empty;
        txtfine.Text = string.Empty;
        if (ddlfinefee.Items.Count > 0)
            ddlfinefee.SelectedIndex = 0;
        rb_cash.Checked = true;
        divgrid.Visible = false;
        cbfine.Checked = false;
        txtfine.Attributes.Add("Style", "display:none;");
        ddlfinefee.Attributes.Add("Style", "display:none;");
        divSchemeSettings.Attributes.Add("Style", "display:none;");
        //  cbfine.Attributes.Add("onchange", "return fineInclude();");
        txt_branch.Text = string.Empty;
        txt_chqno.Text = string.Empty;
        txt_ddnar.Text = string.Empty;
        txtLast4No.Text = string.Empty;
        if (ddlCardType.Items.Count > 0)
            ddlCardType.SelectedIndex = 0;
        if (ddl_bkname.Items.Count > 0)
            ddl_bkname.SelectedIndex = 0;
        rb_cash.Checked = true;
        rb_cheque.Checked = false;
        rb_dd.Checked = false;
        rb_card.Checked = false;
        div_cheque.Attributes.Add("Style", "display:none");
        div_card.Attributes.Add("Style", "display:none");
    }

    private void RollAdmitDetails()
    {
        try
        {
            string admissionNo = Convert.ToString(txtapplScheme.Text);
            string appNo = Convert.ToString(lbappnoScheme.Text);
            string degCode = Convert.ToString(lbldegreeScheme.Text);
            string Year = Convert.ToString(lbyearScheme.Text);
            string collegecode = Convert.ToString(lblclgSchemecode.Text);
            string Scheme = string.Empty;
            if (ddl_reasonScheme.Items.Count > 0 && ddl_reasonScheme.SelectedItem.Text != "--Select--")
                Scheme = Convert.ToString(ddl_reasonScheme.SelectedItem.Value);
            double Amount = 0;
            double.TryParse(Convert.ToString(txtamountScheme.Text), out Amount);
            DateTime schemeDt = Convert.ToDateTime(txt_schmdate.Text.Split('/')[1] + "/" + txt_schmdate.Text.Split('/')[0] + "/" + txt_schmdate.Text.Split('/')[2]);
            if (!string.IsNullOrEmpty(admissionNo) && !string.IsNullOrEmpty(degCode) && !string.IsNullOrEmpty(Year) && !string.IsNullOrEmpty(Scheme) && Amount != 0)
            {
                string InsQ = "update Registration set IsSchemeAdmission='1',IsSchemeCode='" + Scheme + "',IsSchemeAmount='" + Amount + "',SchemeDate='" + schemeDt + "' where App_No='" + appNo + "' and Roll_Admit='" + admissionNo + "' and college_code='" + collegecode + "'";
                int s = d2.update_method_wo_parameter(InsQ, "Text");
                if (s > 0)
                {
                    if (!cbduepaid.Checked)
                        movetoExcess(appNo);
                    else
                        deleteDuePaidDetails(appNo);
                    //  Clear();
                    txt_schmdate.Text = DateTime.Now.ToString("dd/MM/yyyy");
                    txtapplScheme.Text = string.Empty;
                    tddet.Attributes.Add("Style", "display:none;");
                    imgdiv2Scheme.Visible = true;
                    lbl_alertScheme.Text = "Scheme Details Updated Successfully";
                    divSchemeSettings.Attributes.Add("Style", "display:block;");
                }
            }
            else
            {
                imgdiv2Scheme.Visible = true;
                lbl_alertScheme.Text = "Please Fill The All Field";
            }
        }
        catch { }
    }
    protected void movetoExcess(string appNo)
    {
        string selQ = "  select * from ft_feeallot where app_no='" + appNo + "'";
        selQ += "  select sum(debit) as debit,transdate,transcode,feecategory,finyearfk from ft_findailytransaction where app_no='" + appNo + "' and isnull(iscanceled,'0')<>'1' and debit>0 and transcode<>'' group by transdate,transcode,feecategory,finyearfk";
        selQ += " select sum(debit) as debit,headerfk,ledgerfk,feecategory,finyearfk from ft_findailytransaction where app_no='" + appNo + "' and isnull(iscanceled,'0')<>'1' and debit>0 group by feecategory,finyearfk,headerfk,ledgerfk";
        DataSet dsal = d2.select_method_wo_parameter(selQ, "Text");
        if (dsal.Tables.Count > 0 && dsal.Tables[0].Rows.Count > 0)
        {
            string delQ = " delete from ft_feeallot where app_no='" + appNo + "'";
            int del = d2.update_method_wo_parameter(delQ, "Text");
            if (dsal.Tables[1].Rows.Count > 0)
            {
                for (int i = 0; i < dsal.Tables[1].Rows.Count; i++)
                {
                    string insExcess = "  if exists(select * from ft_excessdet where excesstransdate='" + dsal.Tables[1].Rows[i]["transdate"] + "' and dailytranscode='" + dsal.Tables[1].Rows[i]["transcode"] + "' and feecategory='" + dsal.Tables[1].Rows[i]["feecategory"] + "' and finyearfk='" + dsal.Tables[1].Rows[i]["finyearfk"] + "' and excesstype='2')update ft_excessdet set excessamt=isnull(excessamt,'0')+'" + dsal.Tables[1].Rows[i]["debit"] + "',adjamt=isnull(adjamt,'0')+'0',balanceamt=isnull(balanceamt,'0')+'" + dsal.Tables[1].Rows[i]["debit"] + "' where excesstransdate='" + dsal.Tables[1].Rows[i]["transdate"] + "' and dailytranscode='" + dsal.Tables[1].Rows[i]["transcode"] + "' and feecategory='" + dsal.Tables[1].Rows[i]["feecategory"] + "' and finyearfk='" + dsal.Tables[1].Rows[i]["finyearfk"] + "' and excesstype='2' else insert into ft_excessdet(excesstransdate,dailytranscode,app_no,memtype,excesstype,excessamt,adjamt,balanceamt,finyearfk,feecategory) values('" + dsal.Tables[1].Rows[i]["transdate"] + "','" + dsal.Tables[1].Rows[i]["transcode"] + "','" + appNo + "','1','2','" + dsal.Tables[1].Rows[i]["debit"] + "','0','" + dsal.Tables[1].Rows[i]["debit"] + "','" + dsal.Tables[1].Rows[i]["finyearfk"] + "','" + dsal.Tables[1].Rows[i]["feecategory"] + "')";
                    int insex = d2.update_method_wo_parameter(insExcess, "Text");
                    if (insex == 1)
                    {
                        string excesspk = d2.GetFunction(" select excessdetPk from ft_excessdet where excesstransdate='" + dsal.Tables[1].Rows[i]["transdate"] + "' and dailytranscode='" + dsal.Tables[1].Rows[i]["transcode"] + "' and feecategory='" + dsal.Tables[1].Rows[i]["feecategory"] + "' and finyearfk='" + dsal.Tables[1].Rows[i]["finyearfk"] + "' and excesstype='2'");
                        if (excesspk != "0")
                        {
                            dsal.Tables[2].DefaultView.RowFilter = " feecategory='" + dsal.Tables[1].Rows[i]["feecategory"] + "' and finyearfk='" + dsal.Tables[1].Rows[i]["finyearfk"] + "'";
                            DataView dvl = dsal.Tables[2].DefaultView;
                            if (dvl.Count > 0)
                            {
                                for (int dr = 0; dr < dvl.Count; dr++)
                                {
                                    string insledexces = "  if exists(select * from FT_ExcessLedgerDet where headerfk='" + dvl[dr]["headerfk"] + "' and ledgerfk='" + dvl[dr]["ledgerfk"] + "' and excessdetfk='" + excesspk + "' and feecategory='" + dvl[dr]["feecategory"] + "' and finyearfk='" + dvl[dr]["finyearfk"] + "' ) update FT_ExcessLedgerDet set excessamt=isnull(excessamt,'0')+'" + dvl[dr]["debit"] + "',adjamt=isnull(adjamt,'0')+'0',balanceamt=isnull(balanceamt,'0')+'" + dvl[dr]["debit"] + "'  where headerfk='" + dvl[dr]["headerfk"] + "' and ledgerfk='" + dvl[dr]["ledgerfk"] + "' and excessdetfk='" + excesspk + "' and feecategory='" + dvl[dr]["feecategory"] + "' and finyearfk='" + dvl[dr]["finyearfk"] + "' else insert into FT_ExcessLedgerDet(headerfk,ledgerfk,excessamt,adjamt,balanceamt,excessdetfk,feecategory,finyearfk) values('" + dvl[dr]["headerfk"] + "','" + dvl[dr]["ledgerfk"] + "','" + dvl[dr]["debit"] + "','0','" + dvl[dr]["debit"] + "','" + excesspk + "','" + dvl[dr]["feecategory"] + "','" + dvl[dr]["finyearfk"] + "')";
                                    int insexs = d2.update_method_wo_parameter(insledexces, "Text");
                                }
                            }
                        }
                    }
                }
            }
        }
    }

    protected void deleteDuePaidDetails(string appNo)
    {
        try
        {
            string delQ = " delete from ft_feeallot where app_no='" + appNo + "'";
            delQ += " delete from ft_findailytransaction where app_no='" + appNo + "'";
            int duePaid = d2.update_method_wo_parameter(delQ, "Text");
            if (duePaid > 0)
            {
                string selQ = "select excessdetpk from ft_excessdet where app_no='" + appNo + "'";
                DataSet dsval = d2.select_method_wo_parameter(selQ, "Text");
                if (dsval.Tables.Count > 0 && dsval.Tables[0].Rows.Count > 0)
                {
                    bool boolCheck = false;
                    for (int row = 0; row < dsval.Tables[0].Rows.Count; row++)
                    {
                        string delex = "delete from FT_ExcessLedgerDet where excessdetfk='" + dsval.Tables[0].Rows[row]["excessdetpk"] + "'";
                        int delexq = d2.update_method_wo_parameter(delex, "Text");
                        boolCheck = true;
                    }
                    if (boolCheck)
                    {
                        string delMainex = " delete from ft_excessdet where app_no='" + appNo + "'";
                        int delexq = d2.update_method_wo_parameter(delMainex, "Text");
                    }
                }
            }
        }
        catch { }
    }

    protected void txtapplScheme_Changed(object sender, EventArgs e)
    {
        try
        {
            txt_schmdate.Text = DateTime.Now.ToString("dd/MM/yyyy");
            imgAlert.Attributes.Add("Style", " display:none;");
            tddet.Attributes.Add("Style", "display:none;");
            string applno = string.Empty;
            string SelQ = string.Empty;
            if (radApplNo.Checked == true)
                applno = Convert.ToString(txtapplScheme.Text);
            else if (radAdmNo.Checked == true)
                applno = Convert.ToString(txtapplScheme.Text);
            if (!string.IsNullOrEmpty(applno))
            {
                if (radApplNo.Checked == true)
                {
                    SelQ = " select app_no,app_formno,stud_name,a.degree_code,batch_year,a.college_code,c.Course_Name,dt.Dept_Name from applyn a,Degree d,Department dt,Course c where a.degree_code=d.degree_code and d.Dept_Code =dt.Dept_Code and c.Course_Id =d.Course_Id and app_formno='" + applno + "' and isnull(is_enroll,'0')<>'2' and a.college_code='" + collegecode1 + "' ";
                }
                else if (radAdmNo.Checked == true)
                {
                    SelQ = " select r.app_no,app_formno,r.stud_name,a.degree_code,r.batch_year,a.college_code,c.Course_Name,dt.Dept_Name from applyn a,Degree d,Department dt,Course c,Registration r where a.degree_code=d.degree_code and d.Dept_Code =dt.Dept_Code and c.Course_Id =d.Course_Id and r.App_No=a.app_no and CC=0 and DelFlag=0 and r.Exam_Flag<>'Debar' and r.Roll_Admit='" + applno + "' and a.college_code='" + collegecode1 + "'";
                }
                //and isnull(Admission_Status,'0')<>'1' and isnull(selection_status,'0')<>'1'
                ds.Clear();
                ds = d2.select_method_wo_parameter(SelQ, "Text");
                if (ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
                {
                    lbstudnameScheme.Text = Convert.ToString(ds.Tables[0].Rows[0]["stud_name"]);
                    lbappnoScheme.Text = Convert.ToString(ds.Tables[0].Rows[0]["app_no"]);
                    lbscltypeScheme.Text = Convert.ToString(ds.Tables[0].Rows[0]["Course_Name"]);
                    lblstandScheme.Text = Convert.ToString(ds.Tables[0].Rows[0]["Dept_Name"]);
                    lbldegreeScheme.Text = Convert.ToString(ds.Tables[0].Rows[0]["degree_code"]);
                    lbyearScheme.Text = Convert.ToString(ds.Tables[0].Rows[0]["batch_year"]);
                    string btyr = Convert.ToString(ds.Tables[0].Rows[0]["batch_year"]);
                    lblclgSchemecode.Text = Convert.ToString(ds.Tables[0].Rows[0]["college_code"]);
                    collegecode1 = Convert.ToString(ds.Tables[0].Rows[0]["college_code"]);
                    // Session["collegecode"] = collegecode1;
                    txtamountScheme.Text = string.Empty;
                    if (radAdmNo.Checked == true)
                        trAdm.Visible = false;
                    else if (radApplNo.Checked == true)
                        trAdm.Visible = true;
                    tddet.Attributes.Add("Style", "display:block;");
                    loaddescScheme();
                    divSchemeSettings.Attributes.Add("Style", "display:block;");
                }
                else
                {
                    // tddet.Visible = false;
                    tddet.Attributes.Add("Style", "display:none;");
                    divSchemeSettings.Attributes.Add("Style", "display:block;");
                    txtapplScheme.Text = string.Empty;
                    imgdiv2Scheme.Visible = true;
                    if (radApplNo.Checked == true)
                        lbl_alertScheme.Text = "Please Enter Valid Application No";
                    else if (radAdmNo.Checked == true)
                        lbl_alertScheme.Text = "Please Enter Valid Admission No";
                }
            }
            else
            {
                // tddet.Visible = false;
                tddet.Attributes.Add("Style", "display:none;");
                divSchemeSettings.Attributes.Add("Style", "display:block;");
                txtapplScheme.Text = string.Empty;
                imgdiv2Scheme.Visible = true;
                if (radApplNo.Checked == true)
                    lbl_alertScheme.Text = "Please Enter Valid Application No";
                else if (radAdmNo.Checked == true)
                    lbl_alertScheme.Text = "Please Enter Valid Admission No";
            }
        }
        catch { }
    }

    protected void radApplNo_Change(object sender, EventArgs e)
    {
        bindcollegeScheme();
        lblappnoScheme.Text = "Application No";
        txtapplScheme.Text = "";
        tddet.Attributes.Add("Style", "display:none;");
        loaddescScheme();
        divSchemeSettings.Attributes.Add("Style", "display:block;");
        imgAlert.Attributes.Add("Style", " display:none;");
        txt_schmdate.Text = DateTime.Now.ToString("dd/MM/yyyy");
        cbduepaid.Enabled = false;
    }

    protected void radAdmNo_Change(object sender, EventArgs e)
    {
        bindcollegeScheme();
        lblappnoScheme.Text = "Admission No";
        txtapplScheme.Text = "";
        tddet.Attributes.Add("Style", "display:none;");
        loaddescScheme();
        divSchemeSettings.Attributes.Add("Style", "display:block;");
        imgAlert.Attributes.Add("Style", " display:none;");
        txt_schmdate.Text = DateTime.Now.ToString("dd/MM/yyyy");
        cbduepaid.Enabled = true;
    }
    protected bool UserbasedRights()
    {
        bool usBasedRights = false;
        string userrht = d2.GetFunction("select value from Master_Settings where settings='Finance Include User Based Report Settings'  and usercode='" + usercode + "'");
        if (userrht == "1")
            usBasedRights = true;
        return usBasedRights;
    }

    protected void getCollectionamount()
    {
        lblcollect.Text = string.Empty;
        double RegAmount = 0;
        double appAmount = 0;
        string memType = string.Empty;
        if (rbl_rollnoNew.SelectedIndex == 0)
            memType = "1";
        else if (rbl_rollnoNew.SelectedIndex == 1)
            memType = "2";
        else if (rbl_rollnoNew.SelectedIndex == 2)
            memType = "3";
        else if (rbl_rollnoNew.SelectedIndex == 3)
            memType = "4";
        string date = Convert.ToString(txt_date.Text);
        string finYearid = d2.getCurrentFinanceYear(usercode, collegecode1);
        DateTime dt = Convert.ToDateTime(date.Split('/')[1] + "/" + date.Split('/')[0] + "/" + date.Split('/')[2]);
        string selQ = "select sum(debit) as debit from FT_FinDailyTransaction f,fm_headermaster h where f.headerfk=h.headerpk and hd_miscellaneous='1' and Transdate='" + dt + "' and isnull(iscanceled,'0')<>'1'  and f.finyearfk='" + finYearid + "'  ";
        if (UserbasedRights())
            selQ += " and entryusercode='" + usercode + "'";
        double.TryParse(Convert.ToString(d2.GetFunction(selQ)), out RegAmount);
        //and memtype='" + memType + "'
        //double.TryParse(Convert.ToString(d2.GetFunction(" select sum(debit) as debit from FT_FinDailyTransaction f,registration r where r.app_no=f.app_no and r.cc=0  and r.Exam_Flag<>'debar' and r.DelFlag=0 and Transdate='" + dt + "' and isnull(iscanceled,'0')<>'1' and memtype='" + memType + "' and f.finyearfk='" + finYearid + "' and college_code='" + collegecode1 + "' ")), out RegAmount);
        // double.TryParse(Convert.ToString(d2.GetFunction(" select sum(debit) as debit from FT_FinDailyTransaction f,applyn a where a.app_no=f.app_no and Transdate='" + dt + "' and isnull(iscanceled,'0')<>'1' and memtype='" + memType + "' and f.finyearfk='" + finYearid + "' and college_code='" + collegecode1 + "' and a.app_no not in(select app_no from registration where college_code='" + collegecode1 + "') ")), out appAmount);
        RegAmount += appAmount;
        lblcollect.Text = Convert.ToString(RegAmount);
    }
    protected void txt_date_Changed(object sender, EventArgs e)
    {
        getCollectionamount();
    }

    //Last Modified sudhagar 25-01-2017
    protected void chkGridSelectAll_Changed(object sender, EventArgs e)
    {
        if (chkGridSelectAll.Checked)
        {
            //txt_balamt
            Txt_amt.Text = Convert.ToString(txt_balamt.Text);
            txt_balamt.Text = "0";
        }
        else
        {
            txt_balamt.Text = Convert.ToString(Txt_amt.Text);
            Txt_amt.Text = "0";
        }
        loadGridStudent();
    }

    //added by sudhagar 18.03.2017
    protected void getEditableReceipt()
    {
        try
        {
            txttemprcpt.Text = string.Empty;
            double val = 0;
            double.TryParse(Convert.ToString(d2.GetFunction("select LinkValue from New_InsSettings where LinkName='EditReceiptNo' and user_code ='" + usercode + "' and college_code ='" + ddl_college.SelectedValue + "' ")), out val);
            if (val == 1)
                txttemprcpt.Visible = true;
            else
                txttemprcpt.Visible = false;
        }
        catch { }
    }
    [WebMethod]
    public static string CheckReceiptNo(string tempRcptNo)
    {
        string Value = "1";
        try
        {
            if (!string.IsNullOrEmpty(tempRcptNo))
            {
                DAccess2 da = new DAccess2();
                string applValue = da.GetFunction(" select distinct top(1) Transcode from ft_findailytransaction where transcode = '" + tempRcptNo + "'");
                if (string.IsNullOrEmpty(applValue) || applValue == "0" || applValue == "-1")
                    Value = "0";
            }
            else
                Value = "2";
        }
        catch (SqlException ex) { Value = "error" + ex.ToString(); }
        return Value;
    }

    //added by added 19.04.2017
    #region financial year
    public void loadfinanceyear()
    {
        try
        {
            string fnalyr = "";
            string getfinanceyear = "select distinct convert(nvarchar(15),FinYearStart,103) sdate,convert(nvarchar(15),FinYearEnd,103) edate,FinYearPK from FM_FinYearMaster where CollegeCode='" + ddl_college.SelectedValue + "'  order by FinYearPK desc";
            ds.Dispose();
            ds.Reset();
            chkfyear.Checked = false;
            chklsfyear.Items.Clear();
            ds = d2.select_method_wo_parameter(getfinanceyear, "text");
            if (ds.Tables[0].Rows.Count > 0)
            {
                for (int i = 0; i < ds.Tables[0].Rows.Count; i++)
                {
                    string fdatye = ds.Tables[0].Rows[i]["sdate"].ToString() + '-' + ds.Tables[0].Rows[i]["edate"].ToString();
                    string actid = ds.Tables[0].Rows[i]["FinYearPK"].ToString();
                    chklsfyear.Items.Insert(0, new System.Web.UI.WebControls.ListItem(fdatye, actid));
                }

                for (int i = 0; i < chklsfyear.Items.Count; i++)
                {
                    chklsfyear.Items[i].Selected = true;
                    fnalyr = Convert.ToString(chklsfyear.Items[i].Text);
                }
                if (chklsfyear.Items.Count == 1)
                {
                    txtfyear.Text = "" + fnalyr + "";
                }
                else
                {
                    txtfyear.Text = "Finance Year(" + (chklsfyear.Items.Count) + ")";
                }
                // txtfyear.Text = "Finance Year (" + chklsfyear.Items.Count + ")";
                chkfyear.Checked = true;
            }
        }
        catch (Exception ex)
        {

        }
    }
    protected void chklsfyear_selected(object sender, EventArgs e)
    {
        CallCheckboxListChange(chkfyear, chklsfyear, txtfyear, "Finance Year", "--Select--");

    }
    protected void chkfyear_changed(object sender, EventArgs e)
    {
        CallCheckboxChange(chkfyear, chklsfyear, txtfyear, "Finance Year", "--Select--");
    }
    #endregion

    #region Common Checkbox and Checkboxlist Event

    private string getCblSelectedValue(CheckBoxList cblSelected)
    {
        System.Text.StringBuilder selectedvalue = new System.Text.StringBuilder();
        try
        {
            for (int sel = 0; sel < cblSelected.Items.Count; sel++)
            {
                if (cblSelected.Items[sel].Selected == true)
                {
                    if (selectedvalue.Length == 0)
                    {
                        selectedvalue.Append(Convert.ToString(cblSelected.Items[sel].Value));
                    }
                    else
                    {
                        selectedvalue.Append("','" + Convert.ToString(cblSelected.Items[sel].Value));
                    }
                }
            }
        }
        catch { cblSelected.Items.Clear(); }
        return selectedvalue.ToString();
    }
    private string getCblSelectedText(CheckBoxList cblSelected)
    {
        System.Text.StringBuilder selectedText = new System.Text.StringBuilder();
        try
        {
            for (int sel = 0; sel < cblSelected.Items.Count; sel++)
            {
                if (cblSelected.Items[sel].Selected == true)
                {
                    if (selectedText.Length == 0)
                    {
                        selectedText.Append(Convert.ToString(cblSelected.Items[sel].Text));
                    }
                    else
                    {
                        selectedText.Append("','" + Convert.ToString(cblSelected.Items[sel].Text));
                    }
                }
            }
        }
        catch { cblSelected.Items.Clear(); }
        return selectedText.ToString();
    }
    private void CallCheckboxChange(CheckBox cb, CheckBoxList cbl, TextBox txt, string dispst, string deft)
    {
        try
        {
            int sel = 0;
            string name = "";
            txt.Text = deft;
            if (cb.Checked == true)
            {
                for (sel = 0; sel < cbl.Items.Count; sel++)
                {
                    cbl.Items[sel].Selected = true;
                    name = Convert.ToString(cbl.Items[sel].Text);
                }
                if (cbl.Items.Count == 1)
                {
                    txt.Text = "" + name + "";
                }
                else
                {
                    txt.Text = dispst + "(" + cbl.Items.Count + ")";
                }
            }
            else
            {
                for (sel = 0; sel < cbl.Items.Count; sel++)
                {
                    cbl.Items[sel].Selected = false;
                }
                txt.Text = deft;
            }
        }
        catch { }
    }
    private void CallCheckboxListChange(CheckBox cb, CheckBoxList cbl, TextBox txt, string dipst, string deft)
    {
        try
        {
            int sel = 0;
            int count = 0;
            string name = "";
            cb.Checked = false;
            for (sel = 0; sel < cbl.Items.Count; sel++)
            {
                if (cbl.Items[sel].Selected == true)
                {
                    count++;
                    name = Convert.ToString(cbl.Items[sel].Text);
                }
            }
            if (count > 0)
            {
                if (count == 1)
                {
                    txt.Text = "" + name + "";
                }
                else
                {
                    txt.Text = dipst + "(" + count + ")";
                }
                if (cbl.Items.Count == count)
                {
                    cb.Checked = true;
                }
            }
        }
        catch { }
    }

    #endregion

    //added by sudhagar 01.05.2017
    protected void grid_Details_OnRowDataBound(object sender, GridViewRowEventArgs e)
    {
        if (rbl_rollnoNew.SelectedIndex != 0)
        {
            if (e.Row.RowType == DataControlRowType.Header)
            {
                string strTerm = Convert.ToString(e.Row.Cells[6].Text);
                string strfinyear = Convert.ToString(e.Row.Cells[15].Text);
                if (strTerm.Trim() == "Term")
                    e.Row.Cells[6].Visible = false;
                if (strfinyear.Trim() == "Financial Year")
                    e.Row.Cells[15].Visible = false;
            }
            if (e.Row.RowType == DataControlRowType.DataRow)
            {
                e.Row.Cells[6].Visible = false;
                e.Row.Cells[15].Visible = false;
            }
        }
        if (e.Row.RowType == DataControlRowType.DataRow)
        {
            TextBox txttotamt = (TextBox)e.Row.Cells[1].FindControl("txt_tot_amt");
            TextBox txtpaiamt = (TextBox)e.Row.Cells[1].FindControl("txt_paid_amt");
            TextBox txttobepaid = (TextBox)e.Row.Cells[1].FindControl("txt_tobepaid_amt");
            TextBox txtbal = (TextBox)e.Row.Cells[1].FindControl("txt_bal_amt");
            txttotamt.Attributes.Add("readonly", "readonly");
            txtpaiamt.Attributes.Add("readonly", "readonly");
            txttobepaid.Attributes.Add("readonly", "readonly");
            txtbal.Attributes.Add("readonly", "readonly");
        }
    }
}
